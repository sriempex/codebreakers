<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operation Dead Drop — Console</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Chakra+Petch:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&family=Saira:wght@400;500;600;700&family=Oxanium:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&family=Russo+One&family=Exo+2:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Teko:wght@400;500;600;700&family=Play:wght@400;700&family=Audiowide&family=Press+Start+2P&family=VT323&family=Silkscreen&family=Major+Mono+Display&family=Nova+Mono&family=Aldrich&family=Electrolize&family=Michroma&family=Quantico:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<style>
  :root{--green:#00ff88;--green-dim:rgba(0,255,136,.4);--green-glow:rgba(0,255,136,.12);--red:#ff3333;--amber:#ffaa33;--cyan:#00d4ff;--steel-light:#4a4e54;--steel-dark:#22252a;--bg-deep:#08090b;--bg-panel:#10121a;--bg-surface:#171a24;--border:#252830}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg-deep);overflow:hidden;width:100vw;height:100vh;font-family:'Chakra Petch',sans-serif;font-weight:500;color:#ccc;user-select:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#2a2d35;border-radius:2px}

  .screen{position:fixed;inset:0;transition:opacity .3s;opacity:0;pointer-events:none;z-index:1;will-change:opacity;transform:translateZ(0)}
  .screen.active{opacity:1;pointer-events:all;z-index:10}
  #grainCanvas{position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:.03;image-rendering:pixelated;image-rendering:crisp-edges}

  /* ══════ REGISTRATION ══════ */
  #regScreen{display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 30%,rgba(0,255,136,.02) 0%,transparent 60%),linear-gradient(180deg,#0c0d10,#070809)}
  #regScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:2}
  .reg-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;max-width:580px;padding:20px}
  .reg-title{font-family:'Staatliches',cursive;font-size:18px;letter-spacing:2px;color:#e0f0e8;text-transform:uppercase}
  .reg-subtitle{font-family:'Chakra Petch',sans-serif;font-size:12px;letter-spacing:4px;color:#999;font-weight:600;text-transform:uppercase;margin-top:-8px}
  .reg-panel{position:relative;width:100%;background:linear-gradient(175deg,#262930,#1c1e24 40%,#141620);border:1px solid #3a3d44;border-radius:10px;padding:28px 28px 24px;box-shadow:0 0 0 1px rgba(255,255,255,.015),0 2px 0 #0a0a0a,0 4px 0 #1a1a1a,0 25px 60px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.03);max-height:80vh;overflow-y:auto}
  .reg-section{margin-bottom:20px}
  .reg-section-title{font-family:'Saira',sans-serif;font-size:12px;font-weight:700;letter-spacing:4px;color:#d0e8d8;text-transform:uppercase;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid rgba(0,255,136,.12)}
  .reg-row{display:flex;gap:12px;margin-bottom:10px}
  .reg-field{flex:1;display:flex;flex-direction:column;gap:4px}
  .reg-field.full{flex:none;width:100%}
  .reg-field label{font-family:'Saira',sans-serif;font-size:11px;color:#ccc;font-weight:700;letter-spacing:2px;text-transform:uppercase}
  .reg-field input{background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#e0e0e0;font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:1px;outline:none;transition:border-color .2s}
  .reg-field input:focus{border-color:var(--green-dim);box-shadow:0 0 8px rgba(0,255,136,.06)}
  .reg-field select{background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#e0e0e0;font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:1px;outline:none;transition:border-color .2s;width:100%}
  .reg-field select:focus{border-color:var(--green-dim)}
  .reg-field input::placeholder{color:#444}
  .reg-member-block{background:rgba(0,255,136,.02);border:1px solid rgba(0,255,136,.08);border-radius:6px;padding:16px;margin-bottom:12px}
  .reg-member-label{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:#b0d8c0;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px}
  .reg-member-num{width:20px;height:20px;border-radius:50%;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.15);display:flex;align-items:center;justify-content:center;font-family:'Oxanium',sans-serif;font-weight:700;font-size:9px;color:var(--green)}
  .reg-submit{width:100%;background:linear-gradient(180deg,#1a3a2a,#0f2a1a);border:1px solid rgba(0,255,136,.3);color:#d0f0d8;font-family:'Saira',sans-serif;font-size:14px;letter-spacing:5px;padding:14px;cursor:pointer;border-radius:5px;transition:all .2s;text-transform:uppercase;font-weight:700;margin-top:8px}
  .reg-submit:hover{background:rgba(0,255,136,.1);box-shadow:0 0 25px rgba(0,255,136,.12)}
  .reg-err{font-family:'Chakra Petch',sans-serif;font-size:11px;color:var(--red);min-height:14px;margin-top:4px;text-align:center;font-weight:600}

  /* Team ID reveal */
  #regSuccess{display:none;text-align:center}
  #regSuccess.active{display:block}
  #regForm.hidden{display:none}
  .reg-id-display{background:#080a10;border:2px solid rgba(0,255,136,.2);border-radius:6px;padding:20px;margin:20px 0;position:relative}
  .reg-id-label{font-family:'Oxanium',sans-serif;font-weight:700;font-size:10px;letter-spacing:3px;color:#999;text-transform:uppercase;margin-bottom:8px}
  .reg-id-value{font-family:'Oxanium',sans-serif;font-weight:700;font-size:26px;letter-spacing:8px;color:#d0f0d8}
  .reg-id-note{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#aaa;line-height:1.8;margin:16px 0;font-weight:500}
  .reg-id-warn{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#f0c878;letter-spacing:1px;margin-bottom:16px;font-weight:600}
  .reg-proceed{width:100%;background:linear-gradient(180deg,#1a3a2a,#0f2a1a);border:1px solid rgba(0,255,136,.3);color:#d0f0d8;font-family:'Saira',sans-serif;font-size:13px;letter-spacing:4px;padding:14px;cursor:pointer;border-radius:5px;transition:all .2s;text-transform:uppercase;font-weight:700}
  .reg-proceed:hover{background:rgba(0,255,136,.1);box-shadow:0 0 25px rgba(0,255,136,.12)}

  /* Screen back button — consistent top-left placement */
  .screen-back{position:absolute;top:20px;left:20px;z-index:20;cursor:pointer;display:flex;align-items:center;gap:6px;padding:10px 20px;
    border-radius:5px;transition:all .25s;
    background:linear-gradient(180deg,rgba(0,212,255,.1),rgba(0,212,255,.05));border:1px solid rgba(0,212,255,.35);
    box-shadow:0 0 10px rgba(0,212,255,.06)}
  .screen-back:hover{background:linear-gradient(180deg,rgba(0,212,255,.18),rgba(0,212,255,.1));border-color:rgba(0,212,255,.5);box-shadow:0 0 18px rgba(0,212,255,.12)}
  .screen-back span{font-family:'Saira',sans-serif;font-size:12px;color:var(--cyan);letter-spacing:3px;font-weight:700;text-transform:uppercase}
  .screen-back svg{width:16px;height:16px;fill:none;stroke:var(--cyan);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}


  /* ══════ LANDING PAGE ══════ */
  #landingScreen{display:flex;align-items:center;justify-content:center;
    background:
      radial-gradient(ellipse at 50% 20%,rgba(0,255,136,.015) 0%,transparent 50%),
      radial-gradient(ellipse at 20% 80%,rgba(0,212,255,.01) 0%,transparent 40%),
      radial-gradient(ellipse at 80% 60%,rgba(255,51,136,.008) 0%,transparent 40%),
      linear-gradient(180deg,#050607,#080a0c,#050607);
    overflow:hidden}
  #landingScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.03) 3px,rgba(0,0,0,.03) 6px);pointer-events:none;z-index:2}
  #landingScreen::after{content:'';position:absolute;top:-2px;left:0;right:0;height:2px;background:rgba(0,255,136,.06);z-index:3;animation:scanDown 8s linear infinite;box-shadow:0 0 15px rgba(0,255,136,.04)}
  @keyframes scanDown{0%{top:-2px}100%{top:100%}}
  /* Circuit board SVG background */
  .landing-circuits{position:absolute;inset:0;z-index:1;overflow:hidden;opacity:.35}
  .landing-circuits svg{position:absolute;width:100%;height:100%}

  .landing-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;max-width:520px;width:90%;padding:40px 0}

  .landing-banner{width:180px;height:180px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#1a2a1a,#0a150a);
    border:2px solid rgba(0,255,136,.12);
    display:flex;align-items:center;justify-content:center;margin-bottom:24px;
    box-shadow:0 0 40px rgba(0,255,136,.04),0 0 80px rgba(0,255,136,.015),inset 0 0 30px rgba(0,0,0,.5);
    position:relative;overflow:hidden;animation:fadeUp .8s ease both}
  .landing-banner::before{content:'';position:absolute;inset:0;border-radius:50%;
    background:conic-gradient(from 0deg,transparent 0%,rgba(0,255,136,.02) 25%,transparent 50%,rgba(0,255,136,.02) 75%,transparent 100%);
    animation:rotateSlow 20s linear infinite}
  @keyframes rotateSlow{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  .landing-banner-icon{font-size:64px;filter:drop-shadow(0 0 20px rgba(0,255,136,.15));z-index:1;position:relative}
  .landing-banner-img{width:100%;height:100%;object-fit:cover;border-radius:50%;z-index:1;position:relative;display:none}

  .landing-title{font-family:'Staatliches',cursive;font-size:26px;letter-spacing:3px;color:#b0e8cc;text-transform:uppercase;text-align:center;
    animation:breatheLanding 4s ease infinite,fadeUp .8s ease .15s both;margin-bottom:4px}
  @keyframes breatheLanding{0%,100%{text-shadow:0 0 15px rgba(0,255,136,.1),0 0 30px rgba(0,255,136,.03)}50%{text-shadow:0 0 25px rgba(0,255,136,.18),0 0 50px rgba(0,255,136,.06)}}
  .landing-subtitle{font-family:'Chakra Petch',sans-serif;font-size:12px;letter-spacing:4px;color:#8a8a8a;font-weight:600;text-transform:uppercase;text-align:center;animation:fadeUp .8s ease .3s both;margin-bottom:40px}

  .landing-actions{display:flex;flex-direction:column;gap:14px;width:100%;align-items:center;animation:fadeUp .8s ease .45s both}
  .landing-login-btn{padding:16px 60px;border-radius:6px;cursor:pointer;transition:all .3s;
    font-family:'Saira',sans-serif;font-size:15px;letter-spacing:6px;color:#d0f0e0;text-transform:uppercase;font-weight:700;text-align:center;
    background:linear-gradient(180deg,#1a3a2a,#0f2a1a);
    border:1px solid rgba(0,255,136,.25);
    box-shadow:0 0 20px rgba(0,255,136,.04),0 4px 15px rgba(0,0,0,.4)}
  .landing-login-btn:hover{background:linear-gradient(180deg,#1f4a32,#143520);border-color:rgba(0,255,136,.4);
    box-shadow:0 0 30px rgba(0,255,136,.08),0 6px 20px rgba(0,0,0,.5);transform:translateY(-2px)}
  .landing-login-btn:active{transform:translateY(0);box-shadow:0 0 15px rgba(0,255,136,.03),0 2px 8px rgba(0,0,0,.4)}

  /* Landing footer */
  .landing-footer{position:absolute;bottom:16px;left:0;right:0;text-align:center;z-index:5;animation:fadeUp .8s ease .6s both}
  .landing-footer span{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#444;letter-spacing:1.5px;font-weight:500}

  /* Banner upload button (admin) */
  .landing-banner-upload{position:absolute;bottom:-8px;right:-8px;width:28px;height:28px;border-radius:50%;background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.3);display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .2s;font-size:12px;color:var(--cyan)}
  .landing-banner-upload:hover{background:rgba(0,212,255,.25);border-color:rgba(0,212,255,.5)}
  body.edit-mode .landing-banner-upload{display:flex}
  #landingBannerFile{display:none}

  /* Admin Choice Modal */
  #adminChoiceModal{position:fixed;inset:0;z-index:8500;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #adminChoiceModal.active{opacity:1;pointer-events:all}
  .admin-choice-box{width:380px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .admin-choice-box h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--cyan);text-transform:uppercase;margin-bottom:8px}
  .admin-choice-box p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#888;margin-bottom:24px;font-weight:500}
  .admin-choice-btns{display:flex;gap:12px;justify-content:center}

  /* Admin View-as-Team toggle — now in dropdown */
  /* Team View mode — hides all admin edit affordances */
  .reg-type-choice{display:flex;gap:12px;width:100%;margin-bottom:16px}
  .reg-type-btn{flex:1;padding:16px;background:rgba(255,255,255,.01);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .2s;text-align:center}
  .reg-type-btn:hover{border-color:rgba(0,255,136,.15)}
  .reg-type-btn.selected{border-color:rgba(0,255,136,.25);background:rgba(0,255,136,.03)}
  .reg-type-btn .rtype-icon{font-size:24px;margin-bottom:6px}
  .reg-type-btn .rtype-label{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:#888;text-transform:uppercase;font-weight:600}
  .reg-type-btn.selected .rtype-label{color:var(--green)}

  /* Vault rate limit overlay */
  .v-rate-limit{position:absolute;inset:0;background:rgba(0,0,0,.85);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;z-index:10;opacity:0;pointer-events:none;transition:opacity .3s}
  .v-rate-limit.active{opacity:1;pointer-events:all}
  .v-rate-limit-text{font-family:'Saira',sans-serif;font-size:11px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;font-weight:600}
  .v-rate-limit-timer{font-family:'IBM Plex Mono',monospace;font-size:28px;color:var(--red);letter-spacing:4px;font-weight:700}

  /* ══════ LOGIN ══════ */
  #loginScreen{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#050607,#080a0c,#050607)}
  #loginScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.04) 2px,rgba(0,0,0,.04) 4px);pointer-events:none;z-index:2}
  .login-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;gap:20px}
  .login-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:2px;color:#b0e8cc;text-transform:uppercase}
  .login-subtitle{font-family:'Chakra Petch',sans-serif;font-size:11px;letter-spacing:4px;color:#8a8a8a;font-weight:600;text-transform:uppercase;margin-top:-12px}
  .login-panel{position:relative;width:420px;border-radius:8px;padding:28px 24px 20px;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.007) 1px,rgba(255,255,255,.007) 2px,transparent 2px,transparent 4px),
      repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(255,255,255,.004) 60px,rgba(255,255,255,.004) 61px),
      linear-gradient(175deg,#22252c 0%,#1a1c22 20%,#141620 50%,#111318 80%,#0e1014 100%);
    border:1px solid #3a3d44;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.04),inset 0 -1px 0 rgba(0,0,0,.3),0 2px 0 #0a0a0c,0 4px 0 #151518,0 8px 0 #0a0a0c,0 30px 70px rgba(0,0,0,.9)}
  .login-field{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
  .login-field label{font-family:'Saira',sans-serif;font-size:10px;color:#999;font-weight:700;letter-spacing:3px;text-transform:uppercase}
  .login-field input{background:#060810;border:1px solid #2a2d35;border-radius:4px;padding:14px 16px;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:14px;letter-spacing:3px;outline:none;transition:border-color .2s;text-transform:uppercase}
  .login-field input:focus{border-color:rgba(0,255,136,.25);box-shadow:0 0 12px rgba(0,255,136,.06)}
  .login-field input::placeholder{color:#333;text-transform:none;letter-spacing:1px;font-size:12px}
  .login-pw-field input{text-transform:none;color:#ccc;letter-spacing:1px}
  .login-err{font-family:'Chakra Petch',sans-serif;font-size:11px;color:var(--red);min-height:14px;text-align:center;font-weight:600;margin-bottom:4px}
  .login-submit{width:100%;background:linear-gradient(180deg,#1a3a2a,#0f2a1a);border:1px solid rgba(0,255,136,.3);color:#d0f0d8;font-family:'Saira',sans-serif;font-size:14px;letter-spacing:5px;padding:14px;cursor:pointer;border-radius:5px;transition:all .2s;text-transform:uppercase;font-weight:700}
  .login-submit:hover{background:rgba(0,255,136,.1);box-shadow:0 0 25px rgba(0,255,136,.12)}
  .login-status{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.03)}
  .login-register-link{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#888;cursor:pointer;transition:color .2s;padding:12px 0 0;letter-spacing:.5px;text-align:center}
  .login-register-link:hover{color:var(--cyan)}
  .login-register-link span.lrl-action{color:var(--cyan);text-decoration:underline;text-underline-offset:3px}

  /* ══════ VAULT PUZZLE (in-console) ══════ */
  .vault-puzzle-layout{display:flex;flex-direction:column;align-items:center;gap:24px;max-width:500px;margin:0 auto}
  .vault-keypad-section{width:420px;max-width:100%}
  .vault-unlock-section{width:420px;max-width:100%;padding:0}
  .vault-unlock-header{display:flex;align-items:center;justify-content:space-between;padding:0 0 10px;border-bottom:1px solid rgba(0,255,136,.08);margin-bottom:0}
  .vault-unlock-title{font-family:'Saira',sans-serif;font-size:12px;color:#d0e8d8;letter-spacing:3px;font-weight:700;text-transform:uppercase}
  .vault-unlock-count{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#888;letter-spacing:1px}
  .vault-unlock-list{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .vault-unlock-empty{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#555;line-height:1.8;font-weight:500;text-align:center;padding:20px 16px}
  .vault-unlock-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid rgba(0,255,136,.1);border-radius:4px;background:rgba(0,255,136,.02)}
  .vault-unlock-item.locked{border-color:var(--border);background:rgba(255,255,255,.01);opacity:.5}
  .vault-unlock-item .vui-icon{font-size:16px;flex-shrink:0}
  .vault-unlock-item .vui-info{flex:1;min-width:0}
  .vault-unlock-item .vui-label{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#ccc;font-weight:600;letter-spacing:.5px}
  .vault-unlock-item .vui-desc{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#888;letter-spacing:.5px;margin-top:2px}
  .vault-unlock-item .vui-status{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;font-weight:600;flex-shrink:0}
  .vault-unlock-item .vui-status.unlocked{color:var(--green)}
  .vault-unlock-item .vui-status.locked{color:#555}
  @media(max-width:768px){
    .vault-keypad-section{width:100%;max-width:420px}
    .vault-unlock-section{width:100%;max-width:420px}
  }

  /* Panel — cold zinc/steel with brushed texture */
  .vault-panel{position:relative;width:420px;border-radius:8px;padding:28px 24px 20px;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.007) 1px,rgba(255,255,255,.007) 2px,transparent 2px,transparent 4px),
      repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(255,255,255,.004) 60px,rgba(255,255,255,.004) 61px),
      linear-gradient(175deg,#22252c 0%,#1a1c22 20%,#141620 50%,#111318 80%,#0e1014 100%);
    border:1px solid #3a3d44;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.04),
      inset 0 -1px 0 rgba(0,0,0,.3),
      0 2px 0 #0a0a0c,
      0 4px 0 #151518,
      0 8px 0 #0a0a0c,
      0 30px 70px rgba(0,0,0,.9);
  }

  /* Mounting screws — hex bolt style */
  .rv{position:absolute;width:14px;height:14px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#5a5a5a 0%,#3a3a3a 40%,#252525 100%);
    border:1px solid #1a1a1a;
    box-shadow:inset 0 1px 2px rgba(255,255,255,.08),inset 0 -1px 1px rgba(0,0,0,.5),0 2px 4px rgba(0,0,0,.6)}
  .rv::before{content:'';position:absolute;top:3px;left:3px;right:3px;bottom:3px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#4a4a4a,#2a2a2a);border:1px solid #333}
  .rv::after{content:'⬡';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:6px;color:#1e1e1e;line-height:1}
  .rv-1{top:7px;left:7px}.rv-2{top:7px;right:7px}.rv-3{bottom:7px;left:7px}.rv-4{bottom:7px;right:7px}

  /* Display — CRT glass with scanlines and phosphor glow */
  .v-display{width:100%;height:68px;border-radius:4px;display:flex;align-items:center;justify-content:center;margin-bottom:18px;position:relative;overflow:hidden;
    background:linear-gradient(180deg,#020604,#040a06,#030805);
    border:1px solid #1a2a1e;
    box-shadow:
      inset 0 0 20px rgba(0,0,0,.8),
      inset 0 0 40px rgba(0,20,8,.3),
      0 1px 0 rgba(255,255,255,.03),
      0 0 1px rgba(0,255,136,.15);
  }
  /* CRT scanlines */
  .v-display::before{content:'';position:absolute;inset:0;
    background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,0,0,.2) 1px,rgba(0,0,0,.2) 2px);
    pointer-events:none;z-index:2}
  /* Screen curvature highlight */
  .v-display::after{content:'';position:absolute;inset:0;
    background:radial-gradient(ellipse at 50% 0%,rgba(0,255,136,.03) 0%,transparent 60%);
    pointer-events:none;z-index:1}
  /* Glitch flash */
  .v-display.glitch{animation:dispGlitch .15s ease}
  @keyframes dispGlitch{
    0%{filter:brightness(1)}
    25%{filter:brightness(1.8) hue-rotate(10deg)}
    50%{filter:brightness(.6)}
    75%{filter:brightness(1.4)}
    100%{filter:brightness(1)}
  }

  #vDisp{font-family:'IBM Plex Mono',monospace;font-weight:600;color:var(--green);font-size:22px;letter-spacing:6px;z-index:3;
    text-shadow:0 0 8px rgba(0,255,136,.4),0 0 20px rgba(0,255,136,.15);animation:flick 5s infinite}
  #vCursor{display:inline-block;width:2px;height:20px;background:var(--green);margin-left:4px;vertical-align:middle;animation:blink .8s step-end infinite;box-shadow:0 0 6px rgba(0,255,136,.4);z-index:3}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  @keyframes flick{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.75}94%{opacity:1}96%{opacity:.85}97%{opacity:1}}

  /* Keys — glass + bevel physicality */
  .kb-row{display:flex;justify-content:center;gap:4px;margin-bottom:4px;max-width:380px;margin-left:auto;margin-right:auto}
  .kb-key{flex:1;height:42px;padding:0;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;
    background:linear-gradient(180deg,rgba(60,63,70,.6) 0%,rgba(40,42,48,.7) 50%,rgba(28,30,35,.8) 100%);
    border:1px solid rgba(255,255,255,.06);
    border-bottom:3px solid #0a0a0e;
    border-right:2px solid #101014;
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06);
    transition:all .05s ease}
  /* Glass edge highlight */
  .kb-key::before{content:'';position:absolute;inset:1px;border-radius:3px;border:1px solid rgba(0,255,136,.04);pointer-events:none}
  /* Top shine */
  .kb-key::after{content:'';position:absolute;top:1px;left:15%;right:15%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);border-radius:50%;pointer-events:none}
  /* Pressed state — sinks */
  .kb-key:active{transform:translateY(2px);border-bottom-width:1px;border-right-width:1px;
    box-shadow:0 0 2px rgba(0,0,0,.4);
    background:linear-gradient(180deg,rgba(35,37,42,.8) 0%,rgba(25,27,32,.9) 100%)}
  .kb-key:active::before{border-color:rgba(0,255,136,.08)}
  .kb-key span{color:#c8c8c8;font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:500;pointer-events:none;text-shadow:0 1px 1px rgba(0,0,0,.6)}
  /* Hover */
  .kb-key:hover{background:linear-gradient(180deg,rgba(70,73,80,.6) 0%,rgba(50,52,58,.7) 50%,rgba(35,37,42,.8) 100%);border-color:rgba(255,255,255,.1)}
  .kb-key:hover::before{border-color:rgba(0,255,136,.08)}
  /* Function keys */
  .kb-key.fn{background:linear-gradient(180deg,rgba(40,42,50,.6) 0%,rgba(26,28,34,.7) 50%,rgba(18,20,26,.8) 100%);border-color:rgba(255,255,255,.04);flex:1.4}
  .kb-key.fn span{font-size:10px;letter-spacing:1px;color:#999}
  /* Enter key — green tint glass */
  .kb-key.enter-key{
    background:linear-gradient(180deg,rgba(20,60,35,.5) 0%,rgba(12,40,24,.6) 50%,rgba(8,30,18,.7) 100%);
    border-color:rgba(0,255,136,.12);border-bottom-color:#0a1a10}
  .kb-key.enter-key::before{border-color:rgba(0,255,136,.12)}
  .kb-key.enter-key span{color:var(--green);font-size:11px;letter-spacing:1px;font-weight:700;text-shadow:0 0 6px rgba(0,255,136,.2)}
  .kb-key.del-key span{color:var(--red)}
  .kb-key.sym-key{flex:1.2}
  .kb-key.sym-key span{color:var(--amber);font-size:9px;letter-spacing:1px}
  .kb-key.clr-key span{color:var(--amber)}

  /* Status — LED + label */
  .v-status{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.03)}
  .v-dot{width:8px;height:8px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#ff6644,#cc2211);
    box-shadow:0 0 6px rgba(255,50,50,.5),0 0 12px rgba(255,50,50,.2);
    animation:ledPulse 2s ease-in-out infinite}
  @keyframes ledPulse{0%,100%{opacity:1;box-shadow:0 0 6px rgba(255,50,50,.5),0 0 12px rgba(255,50,50,.2)}50%{opacity:.5;box-shadow:0 0 3px rgba(255,50,50,.3)}}
  .v-dot.ok{background:radial-gradient(circle at 40% 35%,#44ff88,#00cc44);box-shadow:0 0 6px rgba(0,255,136,.5),0 0 12px rgba(0,255,136,.2);animation:none}
  .v-lbl{color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;font-weight:600}
  .v-lbl.ok{color:var(--green)}
  .v-tries{text-align:center;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:3px;color:#888;margin-top:8px;text-transform:uppercase;transition:color .3s;font-weight:500}
  .v-tries.warn{color:var(--amber)}
  .v-tries.crit{color:var(--red)}
  .v-lockout{text-align:center;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--red);margin-top:6px;min-height:18px;font-weight:600}

  /* ══════ VAULT OPEN ══════ */
  #vaultOpenOverlay{position:fixed;inset:0;z-index:9000;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s}
  #vaultOpenOverlay.active{opacity:1;pointer-events:all}
  .vo-text{font-family:'Staatliches',cursive;font-size:30px;color:var(--green);letter-spacing:12px;opacity:0;transform:scale(.9);transition:all .8s;text-align:center;padding-left:12px}
  .vo-text.show{opacity:1;transform:scale(1)}
  .vo-sub{font-size:14px;font-family:'Saira',sans-serif;letter-spacing:4px;color:#ccc;margin-top:15px;font-weight:600;opacity:0;transition:opacity .6s ease .5s;text-align:center;text-shadow:0 0 10px rgba(255,255,255,.1)}
  .vo-sub.show{opacity:1}
  .vo-bar{width:300px;height:4px;background:#151515;border-radius:2px;margin-top:30px;overflow:hidden;opacity:0;transition:opacity .4s ease .8s;position:relative}
  .vo-bar.show{opacity:1}
  .vo-fill{width:0;height:100%;background:var(--green);box-shadow:0 0 8px var(--green);transition:width 2s ease}
  .vo-fill.go{width:100%}
  .vo-pct{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--green);letter-spacing:3px;margin-top:12px;opacity:0;transition:opacity .4s ease .8s}
  .vo-pct.show{opacity:1}

  /* ══════ CONSOLE ══════ */
  #consoleScreen{display:flex;flex-direction:column;position:relative;height:100vh;
    background:linear-gradient(180deg, #050607 0%, #070809 15%, #08090c 50%, #060708 85%, #040506 100%);
  }
  /* Brushed zinc streaks */
  #consoleScreen::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
    background:
      repeating-linear-gradient(0deg,
        transparent, transparent 1px,
        rgba(255,255,255,.005) 1px, rgba(255,255,255,.005) 2px,
        transparent 2px, transparent 4px
      ),
      repeating-linear-gradient(90deg,
        transparent, transparent 60px,
        rgba(255,255,255,.003) 60px, rgba(255,255,255,.003) 61px
      ),
      linear-gradient(135deg,
        rgba(255,255,255,.004) 0%, transparent 30%,
        rgba(255,255,255,.003) 50%, transparent 70%,
        rgba(255,255,255,.002) 100%
      );
  }
  /* Vignette — tight, dark edges */
  #consoleScreen::after{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
    background:radial-gradient(ellipse at 50% 50%, transparent 25%, rgba(0,0,0,.7) 100%);
  }
  /* Subtle world map background */
  .console-worldmap{position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.08;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 500'%3E%3Cellipse cx='500' cy='250' rx='480' ry='240' fill='none' stroke='%23ffffff' stroke-width='.5'/%3E%3Cellipse cx='500' cy='250' rx='320' ry='240' fill='none' stroke='%23ffffff' stroke-width='.3'/%3E%3Cellipse cx='500' cy='250' rx='160' ry='240' fill='none' stroke='%23ffffff' stroke-width='.3'/%3E%3Cline x1='20' y1='250' x2='980' y2='250' stroke='%23ffffff' stroke-width='.3'/%3E%3Cline x1='500' y1='10' x2='500' y2='490' stroke='%23ffffff' stroke-width='.3'/%3E%3Cellipse cx='500' cy='250' rx='480' ry='80' fill='none' stroke='%23ffffff' stroke-width='.2'/%3E%3Cellipse cx='500' cy='250' rx='480' ry='160' fill='none' stroke='%23ffffff' stroke-width='.2'/%3E%3Ccircle cx='200' cy='180' r='35' fill='%23ffffff' opacity='.15'/%3E%3Ccircle cx='190' cy='140' r='20' fill='%23ffffff' opacity='.12'/%3E%3Ccircle cx='160' cy='160' r='15' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='520' cy='160' rx='80' ry='55' fill='%23ffffff' opacity='.12'/%3E%3Cellipse cx='600' cy='140' rx='50' ry='30' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='680' cy='180' rx='40' ry='50' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='560' cy='220' rx='35' ry='25' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='530' cy='280' rx='20' ry='40' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='260' cy='270' rx='30' ry='55' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='750' cy='340' rx='25' ry='20' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='780' cy='300' rx='40' ry='25' fill='%23ffffff' opacity='.06'/%3E%3Cellipse cx='350' cy='170' rx='15' ry='12' fill='%23ffffff' opacity='.08'/%3E%3C/svg%3E") no-repeat center center;
    background-size:90% auto;
  }

  /* Topbar — steel header strip */
  .console-topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0;position:relative;z-index:1;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 3px),
      linear-gradient(180deg,#0c0e12,#060810);
    border-bottom:1px solid rgba(255,255,255,.04);
    box-shadow:0 2px 10px rgba(0,0,0,.5),0 1px 0 rgba(255,255,255,.015)}
  .console-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:2px;color:#b0e8cc;text-transform:uppercase}
  .timer-block{text-align:center;position:absolute;left:50%;transform:translateX(-50%)}
  .timer-digits{font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:22px;color:#ff6655;letter-spacing:4px}
  .timer-digits.paused{color:var(--amber);animation:ledPulse 1s infinite}
  .timer-label{font-family:'Saira',sans-serif;font-size:9px;color:#888;letter-spacing:3px;font-weight:600;text-transform:uppercase;margin-top:3px}
  .console-team{font-family:'Saira',sans-serif;font-size:11px;color:#888;letter-spacing:2px;font-weight:600;cursor:pointer;transition:color .2s;position:relative}
  .console-team:hover{color:#b0e8cc}
  body.admin-mode .console-team{cursor:default;color:#b0a880}
  body.admin-mode .console-team:hover{color:#b0a880}

  /* Team splash card — glass panel */
  .team-card{position:absolute;top:100%;right:0;margin-top:10px;width:280px;border-radius:6px;padding:0;z-index:100;opacity:0;pointer-events:none;transform:translateY(-6px);transition:all .25s ease;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(175deg,#141620,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 12px 40px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.02)}
  .team-card.open{opacity:1;pointer-events:all;transform:translateY(0)}
  .team-card-header{padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,.04)}
  .team-card-name{font-family:'Staatliches',cursive;font-size:15px;color:#b0e8cc;letter-spacing:2px;text-transform:uppercase}
  .team-card-id{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#666;font-weight:500;letter-spacing:2px;margin-top:4px}
  .team-card-body{padding:12px 16px}
  .team-card-section{margin-bottom:12px}
  .team-card-section:last-child{margin-bottom:0}
  .team-card-label{font-family:'Saira',sans-serif;font-size:9px;color:#888;font-weight:600;letter-spacing:3px;text-transform:uppercase;margin-bottom:6px}
  .team-card-member{display:flex;align-items:center;gap:8px;margin-bottom:5px}
  .team-card-avatar{width:22px;height:22px;border-radius:50%;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--green);font-family:'Oxanium',sans-serif;font-weight:700}
  .team-card-mname{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#ddd;font-weight:600;letter-spacing:1px}
  .team-card-stats{display:flex;gap:12px}
  .team-card-stat{flex:1;background:rgba(255,255,255,.015);border:1px solid rgba(255,255,255,.04);border-radius:4px;padding:8px;text-align:center}
  .team-card-stat-val{font-family:'IBM Plex Mono',monospace;font-size:14px;color:var(--green);font-weight:700}
  .team-card-stat-lbl{font-family:'Saira',sans-serif;font-size:8px;color:#999;font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-top:3px}

  /* Console grid */
  .console-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:28px;padding:28px;min-height:0;align-content:center;position:relative;z-index:1}

  /* ── CRT Monitor Bezel ── */
  .crt-monitor{position:relative;border-radius:18px;cursor:pointer;transition:all .35s cubic-bezier(.25,.46,.45,.94);
    /* Thick metallic bezel */
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.006) 1px,rgba(255,255,255,.006) 2px,transparent 2px,transparent 4px),
      linear-gradient(170deg,#1e2028 0%,#16181e 30%,#111318 60%,#0c0e14 100%);
    padding:14px;
    border:1px solid rgba(255,255,255,.04);
    box-shadow:
      0 4px 20px rgba(0,0,0,.5),
      0 10px 50px rgba(0,0,0,.3),
      inset 0 1px 0 rgba(255,255,255,.04),
      inset 0 -1px 0 rgba(0,0,0,.4);
  }
  .crt-monitor:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.6),0 14px 60px rgba(0,0,0,.3),0 0 40px rgba(0,255,136,.015),inset 0 1px 0 rgba(255,255,255,.05)}

  /* Bezel screws */
  .crt-screw{position:absolute;width:10px;height:10px;border-radius:50%;
    background:radial-gradient(circle at 38% 32%,#4a4a4a 0%,#2a2a2a 60%,#1a1a1a 100%);
    border:1px solid #111;
    box-shadow:inset 0 1px 1px rgba(255,255,255,.06),0 1px 3px rgba(0,0,0,.5)}
  .crt-screw::after{content:'+';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:6px;color:#1a1a1a;line-height:1}
  .crt-screw.s1{top:5px;left:5px}.crt-screw.s2{top:5px;right:5px}.crt-screw.s3{bottom:5px;left:5px}.crt-screw.s4{bottom:5px;right:5px}

  /* Power LED */
  .crt-led{position:absolute;bottom:7px;right:22px;width:5px;height:5px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#44ff88,#00aa44);
    box-shadow:0 0 4px rgba(0,255,136,.4),0 0 8px rgba(0,255,136,.15);z-index:5}

  /* ── CRT Screen (inner content area) ── */
  .crt-screen{position:relative;border-radius:8px;overflow:hidden;
    background:linear-gradient(170deg,rgba(10,12,18,.95) 0%,rgba(6,8,12,.98) 60%,rgba(4,5,8,1));
    border:1px solid rgba(0,255,136,.06);
    box-shadow:
      inset 0 2px 8px rgba(0,0,0,.6),
      inset 0 0 20px rgba(0,0,0,.3),
      0 0 1px rgba(0,255,136,.1);
    /* Subtle CRT curvature via perspective */
    transform:perspective(800px) rotateX(.5deg);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:40px 24px 32px}
  /* Screen curvature highlight — glass bulge */
  .crt-screen::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:3;
    background:
      radial-gradient(ellipse at 50% 30%,rgba(255,255,255,.02) 0%,transparent 50%),
      radial-gradient(ellipse at 50% 50%,rgba(0,255,136,.01) 0%,transparent 60%)}
  /* Scanlines */
  .crt-screen::after{content:'';position:absolute;inset:0;pointer-events:none;z-index:4;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px)}

  /* Green border glow on hover */
  .crt-monitor:hover .crt-screen{border-color:rgba(0,255,136,.15);
    box-shadow:inset 0 2px 8px rgba(0,0,0,.6),inset 0 0 20px rgba(0,0,0,.3),0 0 8px rgba(0,255,136,.06),0 0 20px rgba(0,255,136,.02)}

  /* ── Tile content inside screen ── */
  .tile-glow{position:absolute;top:25%;left:50%;transform:translate(-50%,-50%);width:100px;height:100px;background:radial-gradient(circle,rgba(0,255,136,.02) 0%,transparent 70%);pointer-events:none;transition:all .4s}
  .crt-monitor:hover .tile-glow{width:160px;height:160px;background:radial-gradient(circle,rgba(0,255,136,.05) 0%,transparent 70%)}
  .tile-icon{font-size:48px;margin-bottom:20px;position:relative;z-index:2;filter:grayscale(.3) brightness(.85);transition:filter .3s,transform .3s}
  .crt-monitor:hover .tile-icon{filter:grayscale(0) brightness(1);transform:scale(1.06)}
  .tile-label{font-family:'Saira',sans-serif;font-weight:700;font-size:16px;letter-spacing:4px;color:#c8c8c8;text-transform:uppercase;text-align:center;margin-bottom:10px;z-index:2;text-shadow:0 2px 3px rgba(0,0,0,.7)}
  .tile-sub{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#777;letter-spacing:1px;font-weight:500;text-align:center;margin-bottom:22px;z-index:2}
  .tile-badge{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;font-weight:700;color:#e0e0e0;border:1px solid rgba(255,255,255,.1);padding:6px 18px;border-radius:3px;margin-bottom:16px;z-index:2;background:rgba(255,255,255,.04)}
  .tile-badge.amber{color:#f0c878;border-color:rgba(255,170,51,.2);background:rgba(255,170,51,.05)}
  .tile-status{display:flex;align-items:center;gap:7px;z-index:2}
  .tile-status span{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:3px;color:#777;font-weight:500;text-transform:uppercase}
  /* LED dots */
  .tile-dot{width:6px;height:6px;border-radius:50%;animation:ledPulse 2s ease-in-out infinite}
  .tile-dot.live{background:radial-gradient(circle at 40% 35%,#44ff88,#00cc44);box-shadow:0 0 4px rgba(0,255,136,.4)}
  .tile-dot.pending{background:radial-gradient(circle at 40% 35%,#ffcc44,#cc8811);box-shadow:0 0 4px rgba(255,170,51,.4)}
  /* Admin edit btn repositioned for monitor */
  .crt-monitor .admin-edit-btn{top:4px;right:4px;z-index:10}

  /* ══════ EXPANDED OVERLAY ══════ */
  #panelOverlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #panelOverlay.active{opacity:1;pointer-events:all}
  .expanded-panel{width:92vw;height:88vh;border-radius:6px;display:none;flex-direction:column;overflow:hidden;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#0e1018,#0a0c12,#080a0e);
    border:1px solid rgba(255,255,255,.05);
    box-shadow:0 25px 100px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.02)}
  .expanded-panel.visible{display:flex}
  .exp-header{height:56px;display:flex;align-items:center;padding:0 24px;gap:14px;flex-shrink:0;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 3px),
      linear-gradient(180deg,#141620,#0c0e14);
    border-bottom:1px solid rgba(255,255,255,.04);
    box-shadow:0 2px 10px rgba(0,0,0,.4)}
  .exp-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:3px;color:#d0f0e0;text-transform:uppercase}
  .panel-icon{font-size:16px}
  .exp-close{margin-left:auto;border-radius:4px;cursor:pointer;transition:all .2s;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));
    border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #0a0a0e;
    color:#888;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;padding:7px 18px;font-weight:600}
  .exp-close:hover{border-color:rgba(255,50,50,.2);color:var(--red);background:rgba(255,50,50,.06)}
  .exp-body{flex:1;overflow-y:auto;padding:20px}

  /* Feed — view modes */
  .feed-view-toggle{display:flex;gap:4px;margin-bottom:14px;max-width:900px;margin-left:auto;margin-right:auto}
  .feed-view-btn{flex:1;border-radius:4px;padding:8px;text-align:center;cursor:pointer;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;color:#666;font-weight:700;transition:all .15s;text-transform:uppercase;
    background:linear-gradient(180deg,rgba(30,32,38,.5),rgba(20,22,28,.6));
    border:1px solid rgba(255,255,255,.04);border-bottom:2px solid #08080c}
  .feed-view-btn.active{color:#b0e8cc;border-color:rgba(0,255,136,.1);background:linear-gradient(180deg,rgba(15,40,25,.4),rgba(10,30,18,.5))}
  .feed-view-btn:hover{border-color:rgba(255,255,255,.08);color:#aaa}

  .feed-expanded{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;max-width:900px;margin:0 auto}
  .feed-card-img{aspect-ratio:1;overflow:hidden}
  .feed-card-img img{width:100%;height:100%;object-fit:cover}
  .feed-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;overflow:hidden;cursor:pointer;transition:all .2s;position:relative}
  .feed-card:hover{border-color:var(--green-dim);box-shadow:0 6px 20px rgba(0,0,0,.3)}
  .feed-card-img{width:100%;display:flex;align-items:center;justify-content:center;font-size:40px;background-size:cover;background-position:center;position:relative;min-height:120px}
  .feed-card-img img{width:100%;display:block;pointer-events:none;-webkit-user-drag:none;user-select:none}
  .feed-card-img{aspect-ratio:1;overflow:hidden}
  .feed-card-img img{width:100%;height:100%;object-fit:cover}
  /* Anti-download: prevent right-click save, drag, long-press */
  .feed-card-img,.feed-single-img,.mv-image-viewer{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;pointer-events:auto}
  .feed-card-img img,.feed-single-img img{pointer-events:none;-webkit-user-drag:none;user-select:none}
  .no-download-shield{position:absolute;inset:0;z-index:2;-webkit-user-select:none;user-select:none}
  /* Feed video in grid */
  .feed-card-video{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
  /* Feed video in single view */
  .feed-single-video{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;border-radius:5px}
  /* Mute toggle button (IG-style) */
  .feed-mute-btn{position:absolute;bottom:12px;right:12px;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:5;font-size:12px;
    background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);color:#fff;transition:all .2s;backdrop-filter:blur(4px)}
  .feed-mute-btn:hover{background:rgba(0,0,0,.8);border-color:rgba(255,255,255,.3)}
  /* Video indicator on grid thumbnails */
  .feed-video-badge{position:absolute;top:8px;left:8px;font-size:8px;letter-spacing:1px;color:#fff;background:rgba(0,0,0,.6);padding:2px 6px;border-radius:2px;font-family:'IBM Plex Mono',monospace;z-index:3}
  .feed-card-cap{padding:10px 12px;border-top:1px solid var(--border);display:none}
  .feed-card{border-radius:0;border:none;border-right:1px solid rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.03)}
  .feed-card-cap p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#bbb;font-weight:500;line-height:1.6}

  .feed-single{display:none;flex-direction:column;align-items:center;gap:16px;max-width:600px;margin:0 auto;width:100%}
  .feed-single.visible{display:flex}
  .feed-single-img{width:100%;aspect-ratio:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:72px;background-size:cover;background-position:center;touch-action:pan-y;position:relative;overflow:hidden;cursor:zoom-in}
  .feed-single-img.zoomed{cursor:zoom-out;overflow:auto}
  .feed-single-img.zoomed img{width:200%;max-width:none;cursor:grab;object-fit:initial}
  .feed-single-img.zoomed img.dragging{cursor:grabbing}
  .feed-single-edit{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.7);border:1px solid rgba(0,212,255,.3);color:var(--cyan);font-size:16px;cursor:pointer;z-index:5;transition:all .2s;backdrop-filter:blur(4px)}
  .feed-single-edit:hover{background:rgba(0,212,255,.15);border-color:rgba(0,212,255,.5);box-shadow:0 0 12px rgba(0,212,255,.15)}
  .feed-single-controls{width:100%;position:sticky;top:0;z-index:5;padding:8px 0}
  .feed-single-nav-row{display:flex;align-items:center;justify-content:center;gap:20px}
  .feed-single-counter{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#999;font-weight:600;letter-spacing:2px;min-width:60px;text-align:center}
  .feed-single-caption{font-family:'Chakra Petch',sans-serif;font-size:14px;color:#ddd;line-height:1.8;font-weight:500;text-align:center;max-width:500px}
  .feed-single-nav{display:flex;gap:15px}
  .feed-nav-btn,.feed-back-grid{cursor:pointer;border-radius:4px;letter-spacing:2px;transition:all .08s;font-weight:600;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));
    border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #0a0a0e;
    color:#888;font-family:'IBM Plex Mono',monospace;font-size:10px;padding:8px 22px}
  .feed-nav-btn:hover,.feed-back-grid:hover{border-color:rgba(0,255,136,.1);color:#b0e8cc}
  .feed-nav-btn:active,.feed-back-grid:active{transform:translateY(1px);border-bottom-width:1px}
  .feed-back-grid{align-self:flex-start}
  .swipe-hint{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#777;font-weight:500;letter-spacing:2px;text-transform:uppercase;display:none}
  @media(max-width:768px){.swipe-hint{display:block}}

  /* Media */
  .media-expanded{display:flex;flex-direction:column;gap:8px;max-width:800px;margin:0 auto}
  .media-exp-item{display:flex;align-items:center;gap:15px;background:var(--bg-surface);border:1px solid var(--border);border-radius:5px;padding:14px 18px;cursor:pointer;transition:border-color .2s;position:relative}
  .media-exp-item:hover{border-color:var(--green-dim)}
  .media-exp-icon{font-size:22px;flex-shrink:0}
  .media-exp-info{display:flex;flex-direction:column;gap:3px}
  .media-exp-name{font-family:'Chakra Petch',sans-serif;font-size:13px;color:#ddd;font-weight:600;letter-spacing:1px}
  .media-exp-desc{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#aaa;font-weight:500;letter-spacing:1px}
  .media-exp-badge{font-family:'Saira',sans-serif;margin-left:auto;font-size:9px;letter-spacing:2px;font-weight:600;padding:3px 10px;border-radius:2px;text-transform:uppercase}
  .media-exp-badge.audio{color:var(--cyan);border:1px solid rgba(0,212,255,.3)}
  .media-exp-badge.doc{color:var(--amber);border:1px solid rgba(255,170,51,.3)}
  .media-exp-badge.map{color:var(--green);border:1px solid rgba(0,255,136,.3)}
  .media-exp-badge.video{color:#ff66aa;border:1px solid rgba(255,102,170,.3)}
  .media-exp-badge.locked{color:#777;border:1px solid #444}

  /* Intel */
  .intel-expanded{display:flex;flex-direction:column;gap:10px;max-width:700px;margin:0 auto}
  .intel-exp-row{display:flex;align-items:center;gap:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:12px 16px}
  .intel-exp-num{font-family:'Saira',sans-serif;font-size:12px;color:#aab;font-weight:700;min-width:28px}
  .intel-exp-label{font-family:'Staatliches',cursive;font-size:14px;color:#d0d0d0;letter-spacing:2px;min-width:200px;font-weight:400}
  .intel-exp-input{flex:1;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:8px 12px;color:var(--green);font-family:'Chakra Petch',sans-serif;font-size:13px;font-weight:600;letter-spacing:2px;outline:none;transition:border-color .2s}
  .intel-exp-input:focus{border-color:var(--green-dim);box-shadow:0 0 8px rgba(0,255,136,.06)}
  .intel-exp-input::placeholder{color:#3a3a3a}
  .intel-exp-input:disabled{opacity:.4;cursor:not-allowed}
  .intel-exp-check{width:20px;height:20px;border-radius:50%;border:1px solid #2a2a2a;display:flex;align-items:center;justify-content:center;font-size:10px;color:#2a2a2a;flex-shrink:0}
  .intel-exp-check.submitted{color:var(--green);border-color:var(--green);background:rgba(0,255,136,.06)}
  .intel-prefix-wrap{flex:1;display:flex;align-items:center;background:#080a10;border:1px solid var(--border);border-radius:3px;overflow:hidden;transition:border-color .2s}
  .intel-prefix-wrap:focus-within{border-color:var(--green-dim);box-shadow:0 0 8px rgba(0,255,136,.06)}
  .intel-prefix{color:var(--green);font-family:'Chakra Petch',sans-serif;font-size:13px;font-weight:700;padding:8px 2px 8px 12px;letter-spacing:2px;flex-shrink:0;opacity:.8}
  .intel-prefix-wrap input{flex:1;background:transparent;border:none;padding:8px 12px 8px 0;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none}
  .intel-prefix-wrap input::placeholder{color:#222}
  .intel-dual-wrap{flex:1;display:flex;gap:8px;align-items:center}
  .intel-dual-wrap input{flex:1}
  .intel-dual-sep{color:#777;font-size:10px;letter-spacing:1px;flex-shrink:0}
  .intel-submit-btn{margin-top:15px;align-self:center;width:100%;font-family:'Saira',sans-serif;font-size:14px;letter-spacing:5px;padding:14px;cursor:pointer;border-radius:5px;transition:all .2s;text-transform:uppercase;font-weight:700;
    background:linear-gradient(180deg,#1a3a2a,#0f2a1a);
    border:1px solid rgba(0,255,136,.3);color:#d0f0d8}
  .intel-submit-btn:hover{background:rgba(0,255,136,.1);box-shadow:0 0 25px rgba(0,255,136,.12)}
  .intel-submit-btn:active{transform:translateY(1px)}
  .intel-submit-btn:disabled{opacity:.25;cursor:not-allowed}

  /* ══════ CONFIRM MODAL ══════ */
  #confirmModal{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #confirmModal.active{opacity:1;pointer-events:all}
  .confirm-box{width:600px;max-height:80vh;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 80px rgba(0,0,0,.6)}
  .confirm-header{padding:18px 22px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--bg-surface),var(--bg-panel))}
  .confirm-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--amber);text-transform:uppercase;margin-bottom:4px}
  .confirm-header p{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#aaa;font-weight:500;letter-spacing:1px}
  .confirm-body{flex:1;overflow-y:auto;padding:16px 22px}
  .confirm-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03)}
  .confirm-row:last-child{border-bottom:none}
  .confirm-label{font-family:'Saira',sans-serif;font-size:12px;color:#bbb;font-weight:600;letter-spacing:1px}
  .confirm-value{font-family:'Chakra Petch',sans-serif;font-size:13px;color:var(--green);letter-spacing:2px;text-align:right;max-width:300px;word-break:break-all;font-weight:600}
  .confirm-value.empty{color:#555;font-style:italic}
  .confirm-footer{padding:16px 22px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
  .btn-standard{font-family:'Saira',sans-serif;font-size:11px;letter-spacing:2px;padding:10px 26px;cursor:pointer;border-radius:4px;transition:all .08s;font-weight:700}
  .btn-standard:active{transform:translateY(1px);border-bottom-width:1px}
  .btn-ghost{background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #0a0a0e;color:#aaa}
  .btn-ghost:hover{border-color:rgba(255,255,255,.12);color:#ccc}
  .btn-green{background:linear-gradient(180deg,rgba(20,60,35,.6),rgba(12,40,24,.7));border:1px solid rgba(0,255,136,.1);border-bottom:2px solid #0a1a10;color:var(--green)}
  .btn-green:hover{background:linear-gradient(180deg,rgba(25,70,40,.6),rgba(15,50,30,.7))}
  .btn-cyan{background:linear-gradient(180deg,rgba(20,35,60,.6),rgba(12,24,40,.7));border:1px solid rgba(0,212,255,.1);border-bottom:2px solid #0a101a;color:var(--cyan)}
  .btn-cyan:hover{background:linear-gradient(180deg,rgba(25,40,70,.6),rgba(15,30,50,.7))}
  .btn-red{background:linear-gradient(180deg,rgba(60,20,20,.5),rgba(40,12,12,.6));border:1px solid rgba(255,50,50,.1);border-bottom:2px solid #1a0a0a;color:var(--red)}
  .btn-red:hover{background:linear-gradient(180deg,rgba(70,25,25,.5),rgba(50,15,15,.6))}

  /* ══════ ADMIN ══════ */
  .admin-trigger{position:fixed;bottom:10px;right:10px;z-index:800;width:32px;height:32px;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;
    background:linear-gradient(180deg,rgba(255,170,51,.15),rgba(255,140,20,.08));border:1px solid rgba(255,170,51,.4);box-shadow:0 0 10px rgba(255,170,51,.12),0 0 20px rgba(255,170,51,.04)}
  .admin-trigger svg{width:15px;height:15px;fill:none;stroke:var(--amber);stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;transition:stroke .3s}
  .admin-trigger:hover{border-color:rgba(255,170,51,.6);box-shadow:0 0 14px rgba(255,170,51,.2)}
  .admin-trigger::after{content:'';position:absolute;top:-2px;right:-2px;width:8px;height:8px;border-radius:50%;background:var(--amber);box-shadow:0 0 6px rgba(255,170,51,.6);animation:ledPulse 2s ease-in-out infinite}
  body.admin-mode .admin-trigger{display:flex}

  /* Admin dropdown menu */
  .admin-dropdown{position:fixed;bottom:52px;right:10px;z-index:810;width:220px;border-radius:6px;
    background:linear-gradient(180deg,#1e2028,#14161c 40%,#10121a);
    border:1px solid rgba(255,170,51,.15);
    box-shadow:0 8px 40px rgba(0,0,0,.7),0 0 1px rgba(255,170,51,.2),inset 0 1px 0 rgba(255,255,255,.03);
    opacity:0;pointer-events:none;transform:translateY(8px) scale(.96);transition:all .2s cubic-bezier(.25,.46,.45,.94);overflow:hidden}
  .admin-dropdown.open{opacity:1;pointer-events:all;transform:translateY(0) scale(1)}
  .admin-dropdown-header{padding:12px 16px;border-bottom:1px solid rgba(255,170,51,.1);display:flex;align-items:center;gap:8px}
  .admin-dropdown-dot{width:6px;height:6px;border-radius:50%;background:var(--amber);box-shadow:0 0 4px rgba(255,170,51,.5);animation:ledPulse 2s ease-in-out infinite;flex-shrink:0}
  .admin-dropdown-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--amber);font-weight:600;text-transform:uppercase}
  .admin-dropdown-body{padding:6px 0}
  .admin-dropdown-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
  .admin-dropdown-item:hover{background:rgba(255,255,255,.04)}
  .admin-dropdown-item .adm-icon{font-size:13px;width:20px;text-align:center;flex-shrink:0}
  .admin-dropdown-item .adm-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;letter-spacing:.5px;font-weight:500}
  .admin-dropdown-item:hover .adm-label{color:#fff}
  .admin-dropdown-item.adm-danger .adm-label{color:#ff6655}
  .admin-dropdown-item.adm-danger:hover{background:rgba(255,50,50,.06)}
  .admin-dropdown-item.adm-danger:hover .adm-label{color:#ff4433}
  .admin-dropdown-sep{height:1px;background:rgba(255,255,255,.04);margin:4px 12px}
  .admin-dropdown-toggle{display:flex;align-items:center;justify-content:space-between;padding:9px 16px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
  .admin-dropdown-toggle:hover{background:rgba(255,255,255,.04)}
  .admin-dropdown-toggle .adm-icon{font-size:13px;width:20px;text-align:center;flex-shrink:0}
  .admin-dropdown-toggle .adm-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;letter-spacing:.5px;font-weight:500;flex:1}
  .admin-dropdown-toggle .adm-toggle{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:2px 8px;border-radius:2px;font-weight:600}
  .admin-dropdown-toggle .adm-toggle.on{color:var(--green);background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.15)}
  .admin-dropdown-toggle .adm-toggle.off{color:#666;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}

  .logout-btn{position:fixed;bottom:20px;left:20px;z-index:400;display:none;align-items:center;gap:6px;border-radius:5px;padding:10px 20px;cursor:pointer;transition:all .25s;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));border:1px solid rgba(255,50,50,.25);
    box-shadow:0 2px 6px rgba(0,0,0,.3);border-bottom:2px solid #0a0a0e}
  .logout-btn.visible{display:flex}
  .logout-btn:hover{border-color:rgba(255,50,50,.45);color:var(--red);background:rgba(255,50,50,.08);box-shadow:0 0 18px rgba(255,50,50,.1);transform:translateY(-1px)}
  .logout-btn:active{transform:translateY(0)}
  .logout-btn svg{width:16px;height:16px;fill:none;stroke:var(--red);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
  .logout-btn span{font-family:'Saira',sans-serif;font-size:12px;letter-spacing:3px;color:var(--red);font-weight:700;text-transform:uppercase}

  /* Notification bell */
  .notif-bell{position:relative;cursor:pointer;display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:4px;transition:all .2s;margin-left:8px}
  .notif-bell:hover{background:rgba(255,255,255,.04)}
  .notif-bell svg{width:18px;height:18px;fill:none;stroke:#888;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:stroke .2s}
  .notif-bell:hover svg{stroke:#ccc}
  body.admin-mode .notif-bell{display:none}
  .admin-topbar-label{display:none;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--amber);font-weight:600;text-transform:uppercase;padding:4px 10px;border:1px solid rgba(255,170,51,.2);border-radius:3px;background:rgba(255,170,51,.06)}
  body.admin-mode .admin-topbar-label{display:inline-flex}
  .notif-badge{position:absolute;top:2px;right:2px;min-width:14px;height:14px;border-radius:7px;background:var(--red);font-family:'IBM Plex Mono',monospace;font-size:8px;color:#fff;font-weight:700;display:none;align-items:center;justify-content:center;padding:0 3px;box-shadow:0 0 6px rgba(255,50,50,.4);animation:badgePulse 2s ease infinite}
  .notif-badge.has-notifs{display:flex}
  @keyframes badgePulse{0%,100%{box-shadow:0 0 6px rgba(255,50,50,.4)}50%{box-shadow:0 0 12px rgba(255,50,50,.6)}}

  .notif-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:320px;max-height:360px;overflow-y:auto;border-radius:6px;z-index:600;opacity:0;pointer-events:none;transform:translateY(-6px);transition:all .2s;
    background:linear-gradient(180deg,#1a1d24,#12141a);border:1px solid rgba(255,255,255,.06);box-shadow:0 10px 40px rgba(0,0,0,.6)}
  .notif-dropdown.open{opacity:1;pointer-events:all;transform:translateY(0)}
  .notif-dropdown-header{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;align-items:center;justify-content:space-between}
  .notif-dropdown-title{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;color:#aaa;text-transform:uppercase;font-weight:700}
  .notif-dropdown-clear{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#666;cursor:pointer;letter-spacing:1px;transition:color .2s}
  .notif-dropdown-clear:hover{color:var(--cyan)}
  .notif-item{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.02);transition:background .15s}
  .notif-item:hover{background:rgba(255,255,255,.02)}
  .notif-item:last-child{border-bottom:none}
  .notif-item-time{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;letter-spacing:1px;margin-bottom:4px}
  .notif-item-msg{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#ccc;line-height:1.5;font-weight:500}
  .notif-item-voice{font-family:'Chakra Petch',sans-serif;font-size:11px;color:var(--amber);font-weight:600}
  .notif-empty{padding:24px 14px;text-align:center;font-family:'Chakra Petch',sans-serif;font-size:11px;color:#555}

  /* Logout confirm modal */
  #logoutModal{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #logoutModal.active{opacity:1;pointer-events:all}
  .logout-box{width:380px;background:var(--bg-panel);border:1px solid rgba(255,50,50,.2);border-radius:8px;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .logout-box h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--red);text-transform:uppercase;margin-bottom:10px}
  .logout-box p{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#bbb;line-height:1.7;font-weight:500;margin-bottom:20px}

  #adminLogin{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #adminLogin.active{opacity:1;pointer-events:all}
  .admin-login-box{width:340px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .admin-login-box h3{font-family:'Staatliches',cursive;font-size:12px;letter-spacing:4px;color:var(--cyan);text-transform:uppercase;margin-bottom:4px}
  .admin-login-box p{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#888;letter-spacing:1px;margin-bottom:20px;font-weight:500}
  .admin-disclaimer{font-family:'Chakra Petch',sans-serif;font-size:10px;color:var(--amber);letter-spacing:.5px;line-height:1.6;margin-bottom:18px;padding:10px 12px;border:1px solid rgba(255,170,51,.15);border-radius:4px;background:rgba(255,170,51,.04);font-weight:500}
  .admin-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
  .admin-field label{font-family:'Saira',sans-serif;font-size:10px;color:#888;letter-spacing:2px;text-transform:uppercase;font-weight:600}
  .admin-field input{background:#080a10;border:1px solid var(--border);border-radius:3px;padding:10px 12px;color:var(--cyan);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;transition:border-color .2s}
  .admin-field input:focus{border-color:rgba(0,212,255,.3)}
  .admin-err{font-family:'Chakra Petch',sans-serif;font-size:10px;color:var(--red);margin-bottom:10px;min-height:14px;font-weight:500}

  /* Admin bar — REMOVED, replaced by dropdown menu */

  /* Admin Profile Panel */
  #adminPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #adminPanel.active{opacity:1;pointer-events:all}
  #teamMonitorPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #teamMonitorPanel.active{opacity:1;pointer-events:all}
  .ap-container{width:560px;max-width:92vw;max-height:85vh;overflow-y:auto;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .ap-header{padding:18px 24px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .ap-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#ffd699;text-transform:uppercase;margin:0}
  .ap-section{padding:20px 24px;border-bottom:1px solid var(--border)}
  .ap-section:last-child{border-bottom:none}
  .ap-section h4{font-family:'Saira',sans-serif;font-size:13px;letter-spacing:3px;color:#d0e8f0;text-transform:uppercase;margin:0 0 14px;font-weight:700}
  .ap-section p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#aaa;letter-spacing:.3px;margin:0 0 12px;line-height:1.6;font-weight:500}
  .ap-field{margin-bottom:10px}
  .ap-field label{display:block;font-family:'Chakra Petch',sans-serif;font-size:10px;letter-spacing:2px;color:#bbb;text-transform:uppercase;margin-bottom:4px;font-weight:600}
  .ap-field input{width:100%;background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:9px 12px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;box-sizing:border-box}
  .ap-field input:focus{border-color:rgba(0,212,255,.2)}
  .ap-row{display:flex;gap:10px;align-items:flex-end}
  .ap-row .ap-field{flex:1}
  .ap-btn{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;cursor:pointer;padding:8px 18px;border-radius:3px;transition:all .2s}
  .ap-btn-cyan{color:#c0e8f8;background:linear-gradient(180deg,rgba(15,30,40,.5),rgba(10,20,30,.6));border:1px solid rgba(0,212,255,.25);border-bottom:2px solid rgba(0,212,255,.12)}
  .ap-btn-cyan:hover{border-color:rgba(0,212,255,.4)}
  .ap-btn-green{color:#b8f0d0;background:linear-gradient(180deg,rgba(15,40,25,.5),rgba(10,25,15,.6));border:1px solid rgba(0,255,136,.25);border-bottom:2px solid rgba(0,255,136,.12)}
  .ap-btn-green:hover{border-color:rgba(0,255,136,.4)}
  .ap-btn-amber{color:#f0d8a0;background:linear-gradient(180deg,rgba(40,30,15,.5),rgba(25,18,10,.6));border:1px solid rgba(255,170,51,.25);border-bottom:2px solid rgba(255,170,51,.12)}
  .ap-btn-amber:hover{border-color:rgba(255,170,51,.4)}
  .ap-msg{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:1px;margin-top:6px;height:14px;font-weight:600}
  .ap-msg.ok{color:#b8f0d0}.ap-msg.err{color:#ff9988}
  .ap-team-list{max-height:150px;overflow-y:auto;margin-top:10px}
  .ap-team-row{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:#ccc}
  .ap-team-id{color:#c0e8f8;font-weight:600;min-width:90px}
  .ap-team-name{flex:1;color:#aaa}
  .ap-team-del{color:#666;cursor:pointer;font-size:12px;transition:color .2s}
  .ap-team-del:hover{color:#ff8877}

  /* Team Monitor */
  .ap-status-pill{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;padding:5px 12px;border-radius:3px;display:flex;align-items:center;gap:6px;color:#999}
  .ap-status-pill.active{border:1px solid rgba(0,255,136,.12);background:rgba(0,255,136,.03);color:var(--green)}
  .ap-status-pill.inactive{border:1px solid rgba(255,170,51,.12);background:rgba(255,170,51,.03);color:var(--amber)}
  .ap-status-pill.total{border:1px solid var(--border);background:rgba(255,255,255,.02);color:#888}
  .ap-status-dot{width:6px;height:6px;border-radius:50%}
  .ap-status-dot.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}
  .ap-status-dot.off{background:var(--amber);opacity:.6}
  .ap-monitor-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;transition:border-color .3s}
  .ap-monitor-row.active{border-color:rgba(0,255,136,.1)}
  .ap-monitor-row.inactive{border-color:rgba(255,170,51,.08);opacity:.65}
  .ap-monitor-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
  .ap-monitor-dot.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}
  .ap-monitor-dot.off{background:var(--amber);opacity:.5}
  .ap-monitor-id{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--cyan);font-weight:600;min-width:90px}
  .ap-monitor-name{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#999;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .ap-monitor-time{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;letter-spacing:1px;flex-shrink:0}
  .ap-monitor-fields{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--green);letter-spacing:1px;flex-shrink:0;min-width:50px;text-align:right}

  /* Leaderboard */
  .ap-lb-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;transition:all .3s}
  .ap-lb-rank{font-family:'Staatliches',cursive;font-size:16px;min-width:28px;text-align:center}
  .ap-lb-rank.gold{color:#ffd700}.ap-lb-rank.silver{color:#c0c0c0}.ap-lb-rank.bronze{color:#cd7f32}.ap-lb-rank.std{color:#555}
  .ap-lb-info{flex:1;min-width:0}
  .ap-lb-name{font-family:'Saira',sans-serif;font-size:11px;color:#ccc;font-weight:600;letter-spacing:1px}
  .ap-lb-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#666;letter-spacing:1px;margin-top:2px}
  .ap-lb-score{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;min-width:60px;text-align:right}
  .ap-lb-score.gold{color:#ffd700}.ap-lb-score.silver{color:#c0c0c0}.ap-lb-score.bronze{color:#cd7f32}.ap-lb-score.std{color:#666}
  .ap-lb-bar{height:3px;border-radius:2px;margin-top:4px;transition:width .5s}
  .ap-lb-empty{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#555;padding:20px 0;text-align:center}

  /* ══════ FULL LEADERBOARD MODULE ══════ */
  #leaderboardModule{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.95);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #leaderboardModule.active{opacity:1;pointer-events:all}
  .lb-container{width:680px;max-width:96vw;height:85vh;display:flex;flex-direction:column;border-radius:8px;overflow:hidden;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,215,0,.06);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .lb-header{padding:16px 24px;border-bottom:1px solid rgba(255,215,0,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .lb-title{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#ffd700;text-transform:uppercase;margin:0}
  .lb-header-right{display:flex;align-items:center;gap:14px}
  .lb-team-count{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#777;letter-spacing:1px}
  .lb-toolbar{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:rgba(255,255,255,.01)}
  .lb-search{background:#080a10;border:1px solid rgba(255,255,255,.06);border-radius:3px;padding:7px 12px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:10px;outline:none;width:160px;letter-spacing:1px}
  .lb-search:focus{border-color:rgba(255,215,0,.15)}
  .lb-search::placeholder{color:#444}
  .lb-filters{display:flex;gap:4px}
  .lb-filter{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:5px 10px;border-radius:3px;cursor:pointer;color:#666;border:1px solid var(--border);background:transparent;transition:all .2s}
  .lb-filter.active{color:#ffd700;border-color:rgba(255,215,0,.2);background:rgba(255,215,0,.04)}
  .lb-filter:hover{border-color:rgba(255,215,0,.12)}
  .lb-sort{display:flex;align-items:center;gap:6px;margin-left:auto}
  .lb-body{flex:1;overflow-y:auto;padding:12px 20px}

  /* Leaderboard rows */
  .lb-row{border:1px solid var(--border);border-radius:5px;margin-bottom:6px;transition:all .2s;overflow:hidden;cursor:pointer}
  .lb-row:hover{border-color:rgba(255,215,0,.1)}
  .lb-row.expanded{border-color:rgba(255,215,0,.15)}
  .lb-row-main{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .lb-rank{font-family:'Staatliches',cursive;font-size:18px;min-width:32px;text-align:center}
  .lb-rank.r1{color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,.3)}.lb-rank.r2{color:#c0c0c0;text-shadow:0 0 8px rgba(192,192,192,.2)}.lb-rank.r3{color:#cd7f32}.lb-rank.rn{color:#444}
  .lb-team-info{flex:1;min-width:0}
  .lb-team-name{font-family:'Saira',sans-serif;font-size:12px;color:#ddd;font-weight:600;letter-spacing:1px}
  .lb-team-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#666;letter-spacing:1px;margin-top:2px;display:flex;gap:10px;flex-wrap:wrap}
  .lb-team-status{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:2px}
  .lb-team-status.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}.lb-team-status.off{background:var(--amber);opacity:.5}
  .lb-score-block{text-align:right;min-width:70px}
  .lb-score-pct{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px}
  .lb-score-pct.r1{color:#ffd700}.lb-score-pct.r2{color:#c0c0c0}.lb-score-pct.r3{color:#cd7f32}.lb-score-pct.rn{color:#555}
  .lb-score-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:1px;margin-top:2px}
  .lb-progress{height:3px;border-radius:2px;margin:6px 16px 0;background:rgba(255,255,255,.03)}
  .lb-progress-fill{height:100%;border-radius:2px;transition:width .5s}

  /* Expanded team detail */
  .lb-detail{display:none;padding:0 16px 14px;border-top:1px solid var(--border);margin-top:0}
  .lb-row.expanded .lb-detail{display:block}
  .lb-detail-section{margin-top:12px}
  .lb-detail-title{font-family:'Saira',sans-serif;font-size:9px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:8px;font-weight:700}
  .lb-member-row{display:flex;align-items:center;gap:10px;padding:6px 10px;background:rgba(0,212,255,.02);border:1px solid rgba(0,212,255,.06);border-radius:3px;margin-bottom:3px}
  ;color:var(--cyan);font-weight:700;flex-shrink:0}
  .lb-member-name{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#bbb;font-weight:600;flex:1}
  .lb-member-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555}
  .lb-field-row{display:flex;align-items:center;gap:8px;padding:4px 10px;border-bottom:1px solid rgba(255,255,255,.02)}
  .lb-field-label{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#888;flex:1}
  .lb-field-status{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:600;min-width:60px;text-align:right}
  .lb-field-status.correct{color:var(--green)}.lb-field-status.wrong{color:var(--red)}.lb-field-status.empty{color:#444}.lb-field-status.pending{color:var(--amber)}

  /* ══════ KEYS & CODES PANEL ══════ */
  #keysCodesPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #keysCodesPanel.active{opacity:1;pointer-events:all}
  .kc-container{width:520px;max-width:96vw;max-height:85vh;overflow-y:auto;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .kc-header{padding:18px 24px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .kc-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#d0f0e0;text-transform:uppercase;margin:0}
  .kc-body{padding:16px 24px}
  .kc-section{margin-bottom:20px}
  .kc-section-title{font-family:'Saira',sans-serif;font-size:12px;letter-spacing:3px;color:#d0e8f0;text-transform:uppercase;margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:8px}
  .kc-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;transition:border-color .2s}
  .kc-row:hover{border-color:rgba(0,255,136,.15)}
  .kc-icon{font-size:16px;flex-shrink:0}
  .kc-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;flex:1;min-width:0;letter-spacing:.3px;font-weight:500}
  .kc-value{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#d0f0d8;font-weight:700;letter-spacing:2px;padding:4px 10px;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);border-radius:3px;min-width:80px;text-align:center}
  .kc-edit{font-size:12px;cursor:pointer;color:#999;transition:color .2s;flex-shrink:0}
  .kc-edit:hover{color:#c0e8f8}
  .kc-empty{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#666;letter-spacing:1px;font-style:italic}

  /* Broadcast Panel */
  #broadcastPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #broadcastPanel.active{opacity:1;pointer-events:all}
  .bc-container{width:500px;max-width:96vw;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .bc-header{padding:18px 24px;border-bottom:1px solid rgba(255,170,51,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .bc-header h3{font-family:'Staatliches',cursive;font-size:13px;letter-spacing:4px;color:var(--amber);text-transform:uppercase;margin:0}
  .bc-body{padding:20px 24px}
  .bc-tabs{display:flex;gap:6px;margin-bottom:16px}
  .bc-tab{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;padding:6px 14px;border-radius:3px;cursor:pointer;color:#777;border:1px solid var(--border);transition:all .2s}
  .bc-tab.active{color:var(--amber);border-color:rgba(255,170,51,.2);background:rgba(255,170,51,.04)}
  .bc-textarea{width:100%;background:#080a10;border:1px solid rgba(255,255,255,.06);border-radius:3px;padding:12px;color:#ccc;font-family:'Chakra Petch',sans-serif;font-size:12px;line-height:1.6;outline:none;resize:none;height:80px;box-sizing:border-box}
  .bc-textarea:focus{border-color:rgba(255,170,51,.2)}
  .bc-voice{display:flex;flex-direction:column;align-items:center;gap:14px;padding:10px 0}
  .bc-rec-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;transition:all .2s;
    background:linear-gradient(180deg,rgba(60,20,20,.5),rgba(40,12,12,.6));border:2px solid rgba(255,50,50,.2)}
  .bc-rec-btn:hover{border-color:rgba(255,50,50,.4)}
  .bc-rec-btn.recording{border-color:rgba(255,50,50,.6);box-shadow:0 0 20px rgba(255,50,50,.2);animation:ledPulse 1s ease-in-out infinite}
  .bc-rec-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#777;letter-spacing:1px}
  .bc-preview{width:100%;margin-top:10px}
  .bc-preview audio{width:100%;height:36px}
  .bc-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}

  /* Player broadcast banner */
  #playerBanner{position:fixed;top:-80px;left:0;right:0;z-index:900;transition:top .5s cubic-bezier(.25,.46,.45,.94);pointer-events:none;visibility:hidden;opacity:0}
  #playerBanner.show{top:0;pointer-events:all;visibility:visible;opacity:1}
  .pb-inner{display:flex;align-items:center;justify-content:center;gap:14px;padding:16px 24px;position:relative;
    background:linear-gradient(180deg,rgba(255,170,51,.15),rgba(255,140,20,.08));
    border-bottom:1px solid rgba(255,170,51,.25);box-shadow:0 4px 20px rgba(0,0,0,.4);backdrop-filter:blur(8px)}
  .pb-icon{font-size:20px;flex-shrink:0}
  .pb-text{font-family:'Saira',sans-serif;font-size:15px;color:#fff;font-weight:600;line-height:1.5;text-align:center;letter-spacing:.5px;text-shadow:0 1px 3px rgba(0,0,0,.3)}
  .pb-audio{display:flex;align-items:center;gap:10px;justify-content:center}
  .pb-audio-play{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;
    background:rgba(255,170,51,.1);border:1px solid rgba(255,170,51,.2);color:var(--amber);flex-shrink:0;transition:all .2s}
  .pb-audio-play:hover{background:rgba(255,170,51,.2)}
  .pb-audio-label{font-family:'Saira',sans-serif;font-size:12px;color:var(--amber);letter-spacing:1px;font-weight:600}
  .pb-close{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:16px;cursor:pointer;color:#999;flex-shrink:0;padding:4px 8px;transition:color .2s;border-radius:3px}
  .pb-close:hover{color:#fff;background:rgba(255,255,255,.05)}
  .pb-progress{position:absolute;bottom:0;left:0;height:2px;background:var(--amber);transition:width .1s linear;box-shadow:0 0 6px rgba(255,170,51,.3)}
  /* Admin mode — no content offset (dropdown-based) */

  /* Admin timer controls — now in admin panel */
  .admin-timer-btn{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:3px 10px;cursor:pointer;border-radius:2px;transition:all .2s;background:none;border:1px solid rgba(0,212,255,.2);color:var(--cyan)}
  .admin-timer-btn:hover{background:rgba(0,212,255,.08);border-color:rgba(0,212,255,.4)}
  .admin-timer-input{width:70px;background:#080a10;border:1px solid var(--border);border-radius:2px;padding:3px 6px;color:var(--cyan);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;outline:none;text-align:center}

  .admin-edit-btn{display:none;position:absolute;top:6px;right:6px;width:24px;height:24px;background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.3);border-radius:3px;color:var(--cyan);font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:10;transition:all .2s}
  .admin-edit-btn:hover{background:rgba(0,212,255,.25)}
  body.edit-mode .admin-edit-btn{display:flex}
  .admin-edit-inline{display:none;width:18px;height:18px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.25);border-radius:3px;color:var(--cyan);font-size:9px;cursor:pointer;align-items:center;justify-content:center;margin-left:8px;vertical-align:middle;transition:all .2s;flex-shrink:0}
  .admin-edit-inline:hover{background:rgba(0,212,255,.25)}
  body.edit-mode .admin-edit-inline{display:inline-flex}
  .admin-add-btn{display:none;background:var(--bg-surface);border:2px dashed rgba(0,212,255,.15);border-radius:5px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;color:#777;font-size:10px;letter-spacing:2px}
  .admin-add-btn:hover{border-color:var(--cyan);color:var(--cyan)}
  body.edit-mode .admin-add-btn{display:block}
  .admin-row-edit{display:none;width:18px;height:18px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:3px;color:var(--cyan);font-size:8px;cursor:pointer;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
  .admin-row-edit:hover{background:rgba(0,212,255,.2)}
  body.edit-mode .admin-row-edit{display:flex}

  /* Team View mode — removed, replaced by edit-mode approach */
  .edit-field-row{display:flex;gap:10px}.edit-field-row .edit-field{flex:1}
  .edit-box .edit-field input[type="file"]{padding:8px}
  .edit-font-row{display:flex;gap:10px;align-items:flex-end}
  .edit-font-row .edit-field:first-child{flex:1}
  .edit-font-row .edit-field:last-child{flex:0 0 160px}
  .edit-field select option{padding:4px 8px}

  #adminEditModal{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #adminEditModal.active{opacity:1;pointer-events:all}
  .edit-box{width:500px;max-width:92vw;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.5);box-sizing:border-box}
  .edit-box h3{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:16px}
  .edit-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
  .edit-field label{font-size:9px;color:#888;letter-spacing:2px;text-transform:uppercase}
  .edit-field input,.edit-field textarea,.edit-field select{background:#080a10;border:1px solid var(--border);border-radius:3px;padding:10px 12px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;transition:border-color .2s;resize:vertical;box-sizing:border-box;width:100%;max-width:100%}
  .edit-field input:focus,.edit-field textarea:focus{border-color:rgba(0,212,255,.3)}
  .edit-field textarea{min-height:80px}
  .edit-field select{color:#ccc}
  .edit-tabs{display:flex;gap:4px;margin-bottom:8px}
  .edit-tab{padding:6px 14px;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;border:1px solid #444;border-radius:3px;background:none;color:#888;transition:all .2s}
  .edit-tab.active{color:var(--cyan);border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.05)}
  .edit-tab-content{display:none}
  .edit-tab-content.active{display:block}
  .upload-zone{border:2px dashed #444;border-radius:4px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;color:#888;font-size:9px;letter-spacing:1px}
  .upload-zone:hover{border-color:var(--cyan);color:var(--cyan)}
  .upload-zone.has-file{border-color:var(--green);color:var(--green);border-style:solid}
  .upload-preview{max-width:100%;max-height:120px;border-radius:3px;margin-top:8px}

  /* ══════ NOTEPAD ══════ */
  .notepad-trigger{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:600;display:none;align-items:center;gap:7px;background:linear-gradient(180deg,#1e2028,#161820);border:1px solid #3a3d44;border-radius:5px;padding:8px 18px 8px 14px;cursor:pointer;transition:all .3s;box-shadow:0 2px 10px rgba(0,0,0,.3)}
  .notepad-trigger.visible{display:flex}
  body.admin-mode .notepad-trigger{display:none!important}
  .notepad-trigger:hover{border-color:var(--green-dim);box-shadow:0 4px 16px rgba(0,0,0,.4),0 0 15px rgba(0,255,136,.05)}
  .notepad-trigger svg{width:15px;height:15px;fill:none;stroke:var(--green);stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  .notepad-trigger span{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:#bbb;font-weight:700;text-transform:uppercase}
  .notepad-dot{width:6px;height:6px;border-radius:50%;background:#444;margin-left:4px;transition:background .3s}
  .notepad-dot.has-notes{background:var(--green);box-shadow:0 0 4px var(--green)}

  #notepadPanel{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);z-index:650;width:480px;max-height:60vh;border:1px solid rgba(255,255,255,.06);border-bottom:none;border-radius:8px 8px 0 0;display:flex;flex-direction:column;overflow:hidden;transition:transform .35s cubic-bezier(.25,.46,.45,.94);
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(175deg,#141620,#0e1018 40%,#0a0c12);
    box-shadow:0 -8px 40px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.02)}
  #notepadPanel.open{transform:translateX(-50%) translateY(0)}
  .notepad-header{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);flex-shrink:0}
  .notepad-header-title{font-family:'Staatliches',cursive;font-size:15px;letter-spacing:3px;color:#d0f0e0;text-transform:uppercase}
  .notepad-header-icon{font-size:14px;margin-right:10px}
  .notepad-header-actions{margin-left:auto;display:flex;gap:8px}
  .notepad-hint{font-family:'Chakra Petch',sans-serif;padding:0 18px;font-size:11px;color:#777;letter-spacing:.5px;line-height:1.6;padding-top:12px;padding-bottom:4px;flex-shrink:0;font-style:italic;font-weight:500}
  .notepad-body{flex:1;padding:8px 18px 18px;overflow:hidden;display:flex;min-height:200px}
  .notepad-textarea{width:100%;background:transparent;border:none;outline:none;color:#ccc;font-family:'Chakra Petch',sans-serif;font-size:13px;font-weight:500;line-height:1.8;letter-spacing:.5px;resize:none;flex:1}
  .notepad-textarea::placeholder{color:#333}
  .notepad-footer{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;border-top:1px solid var(--border);flex-shrink:0}
  .notepad-charcount{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#666;letter-spacing:1px;font-weight:500}
  .notepad-clear{font-family:'Saira',sans-serif;font-size:9px;font-weight:600;letter-spacing:2px;color:#777;background:none;border:1px solid #333;padding:4px 12px;border-radius:3px;cursor:pointer;transition:all .2s;font-weight:bold}
  .notepad-clear:hover{color:var(--red);border-color:rgba(255,50,50,.3)}

  /* Allow text selection in inputs and textarea */
  input,textarea{-webkit-user-select:text;user-select:text}

  /* Overscroll rubber band */
  .overscroll-wrap{overscroll-behavior-y:none;position:relative}
  .overscroll-pull{position:absolute;top:-50px;left:0;right:0;height:50px;display:flex;align-items:flex-end;justify-content:center;pointer-events:none;opacity:0;transition:opacity .2s}
  .overscroll-pull span{font-size:8px;color:#555;letter-spacing:2px;padding-bottom:8px}

  /* ══════ MEDIA VIEWER ══════ */
  #mediaViewer{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.95);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #mediaViewer.active{opacity:1;pointer-events:all}
  .mv-container{width:92vw;height:90vh;display:flex;flex-direction:column;border-radius:6px;overflow:hidden;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#0e1018,#0a0c12,#080a0e);
    border:1px solid rgba(255,255,255,.05);
    box-shadow:0 25px 100px rgba(0,0,0,.8)}
  .mv-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid rgba(0,255,136,.08);
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#1a1d28,#14161e);flex-shrink:0}
  .mv-header-info{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
  .mv-icon{font-size:20px;flex-shrink:0}
  .mv-header-text{display:flex;flex-direction:column;gap:2px;min-width:0}
  .mv-filename{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#ccc;font-weight:600;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mv-filedesc{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#666;letter-spacing:.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mv-badge{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:2px;font-weight:600;padding:4px 12px;border-radius:3px;text-transform:uppercase;flex-shrink:0;margin-left:auto}
  .mv-badge.audio{color:var(--cyan);border:1px solid rgba(0,212,255,.15);background:rgba(0,212,255,.04)}
  .mv-badge.video{color:#c084fc;border:1px solid rgba(192,132,252,.15);background:rgba(192,132,252,.04)}
  .mv-badge.doc{color:var(--green);border:1px solid rgba(0,255,136,.1);background:rgba(0,255,136,.03)}
  .mv-badge.map{color:var(--amber);border:1px solid rgba(255,170,51,.15);background:rgba(255,170,51,.04)}
  .mv-badge.locked{color:#777;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02)}
  .mv-close{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:#999;cursor:pointer;padding:8px 18px;border-radius:4px;transition:all .2s;flex-shrink:0;margin-left:16px;
    background:linear-gradient(180deg,rgba(40,42,48,.5),rgba(22,24,30,.6));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #08080c}
  .mv-close:hover{color:#fff;border-color:rgba(255,255,255,.12)}
  .mv-close:active{transform:translateY(1px);border-bottom-width:1px}
  .mv-download{font-family:'Saira',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--green);cursor:pointer;padding:8px 16px;border-radius:4px;transition:all .2s;flex-shrink:0;
    background:linear-gradient(180deg,rgba(15,40,25,.4),rgba(10,25,15,.5));border:1px solid rgba(0,255,136,.12);border-bottom:2px solid rgba(0,255,136,.08)}
  .mv-download:hover{border-color:rgba(0,255,136,.25);background:rgba(0,255,136,.06)}

  .mv-body{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;position:relative}

  /* PDF / Doc viewer */
  .mv-pdf-frame{width:100%;height:100%;border:none;border-radius:4px;background:#111}
  .mv-image-viewer{max-width:100%;max-height:100%;object-fit:contain;border-radius:4px;cursor:zoom-in;transition:transform .3s;-webkit-user-drag:none;-webkit-user-select:none;user-select:none}
  .mv-image-viewer.zoomed{cursor:zoom-out;transform:scale(1.8)}
  .mv-body video,.mv-body img{-webkit-user-select:none;user-select:none}

  /* Audio player */
  .mv-audio-player{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;gap:20px;padding:40px}
  .mv-audio-icon{font-size:80px;opacity:.4;filter:grayscale(.5)}
  .mv-audio-title{font-family:'IBM Plex Mono',monospace;font-size:13px;color:#aaa;letter-spacing:2px;text-align:center}
  .mv-audio-controls{width:100%;display:flex;flex-direction:column;gap:12px}
  .mv-audio-bar-wrap{width:100%;height:6px;background:rgba(255,255,255,.06);border-radius:3px;cursor:pointer;position:relative;overflow:hidden}
  .mv-audio-bar{height:100%;background:linear-gradient(90deg,var(--cyan),var(--green));border-radius:3px;width:0%;transition:width .1s linear}
  .mv-audio-btns{display:flex;align-items:center;justify-content:center;gap:16px}
  .mv-audio-btn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:16px;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(22,24,30,.7));border:1px solid rgba(255,255,255,.08);color:#ccc}
  .mv-audio-btn:hover{border-color:rgba(0,255,136,.2);color:var(--green)}
  .mv-audio-btn.playing{border-color:rgba(0,255,136,.3);color:var(--green);box-shadow:0 0 12px rgba(0,255,136,.1)}
  .mv-audio-time{display:flex;justify-content:space-between;font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:1px}
  .mv-audio-vol{display:flex;align-items:center;gap:8px}
  .mv-audio-vol-bar{width:80px;height:4px;background:rgba(255,255,255,.06);border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
  .mv-audio-vol-fill{height:100%;background:var(--cyan);border-radius:2px;width:80%}
  .mv-audio-vol-icon{font-size:12px;color:#666;cursor:pointer}

  /* Video player */
  .mv-video-wrap{width:100%;max-width:900px;position:relative;border-radius:4px;overflow:hidden;background:#000}
  .mv-video{width:100%;display:block;border-radius:4px}
  .mv-video-controls{position:absolute;bottom:0;left:0;right:0;padding:12px 16px;background:linear-gradient(transparent,rgba(0,0,0,.8));display:flex;align-items:center;gap:12px;opacity:0;transition:opacity .3s}
  .mv-video-wrap:hover .mv-video-controls{opacity:1}
  .mv-video-play{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:12px;flex-shrink:0}
  .mv-video-bar{flex:1;height:4px;background:rgba(255,255,255,.15);border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
  .mv-video-progress{height:100%;background:var(--green);border-radius:2px;width:0%}
  .mv-video-time{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#aaa;letter-spacing:1px;flex-shrink:0}
  .mv-video-full{cursor:pointer;color:#aaa;font-size:14px;flex-shrink:0}

  /* Locked file */
  .mv-locked{display:flex;flex-direction:column;align-items:center;gap:16px;padding:40px}
  .mv-locked-icon{font-size:80px;opacity:.3}
  .mv-locked-title{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#555;text-transform:uppercase}
  .mv-locked-desc{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#444;letter-spacing:1px;text-align:center;max-width:400px;line-height:1.6}
  .mv-locked-input-wrap{display:flex;gap:8px;align-items:center}
  .mv-locked-input{background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:10px 14px;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;width:200px;text-align:center}
  .mv-locked-input:focus{border-color:rgba(0,255,136,.2)}
  .mv-locked-submit{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--green);cursor:pointer;padding:10px 20px;border-radius:3px;
    background:linear-gradient(180deg,rgba(15,40,25,.5),rgba(10,25,15,.6));border:1px solid rgba(0,255,136,.15);border-bottom:2px solid rgba(0,255,136,.1);transition:all .2s}
  .mv-locked-submit:hover{border-color:rgba(0,255,136,.3)}

  /* No file placeholder */
  .mv-no-file{display:flex;flex-direction:column;align-items:center;gap:12px;color:#444}
  .mv-no-file-icon{font-size:60px;opacity:.3}
  .mv-no-file-text{font-family:'Chakra Petch',sans-serif;font-size:11px;letter-spacing:1px}

  /* Navigation */
  .mv-nav{display:flex;align-items:center;justify-content:center;gap:20px;padding:12px 20px;border-top:1px solid rgba(255,255,255,.04);flex-shrink:0;
    background:linear-gradient(180deg,#0c0e14,#0a0c10)}
  .mv-nav-btn{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:#888;cursor:pointer;padding:8px 20px;border-radius:3px;transition:all .2s;
    background:linear-gradient(180deg,rgba(40,42,48,.4),rgba(22,24,30,.5));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #08080c}
  .mv-nav-btn:hover{color:#ccc;border-color:rgba(255,255,255,.12)}
  .mv-nav-btn:active{transform:translateY(1px);border-bottom-width:1px}
  .mv-nav-counter{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:2px}

  /* ══════ RESPONSIVE ══════ */

  /* Allow scrolling on mobile */
  @media(max-width:768px){
    body{overflow-y:auto;overflow-x:hidden}
  }

  /* Tablet */
  @media(max-width:1024px){
    .console-grid{gap:16px;padding:16px}
    .crt-monitor{padding:10px} .crt-screen{padding:30px 18px 24px}
    .tile-icon{font-size:40px;margin-bottom:14px}
    .tile-label{font-size:12px;letter-spacing:3px}
    .expanded-panel{width:96vw;height:92vh}
    .feed-expanded{max-width:100%}
    .intel-expanded{max-width:100%}
    .media-expanded{max-width:100%}
    .confirm-box{width:90vw;max-width:600px}
    .edit-box{width:90vw;max-width:500px}
    .logout-box{width:90vw;max-width:380px}
    #notepadPanel{width:90vw;max-width:480px}
  }

  /* Half-screen desktop / narrow window */
  @media(max-width:1100px){

    /* Topbar — keep horizontal, just tighter */
    .console-topbar{height:auto;min-height:48px;padding:8px 14px}
    .console-title{font-size:12px;letter-spacing:2px}
    .timer-block{position:relative;left:auto;transform:none}
    .timer-digits{font-size:18px;letter-spacing:3px}
    .timer-label{font-size:7px;letter-spacing:2px}
    .console-team{font-size:9px;letter-spacing:2px}

    /* Grid — 2 columns, centered */
    .console-grid{gap:16px;padding:16px;align-content:start;padding-top:20px}
    .crt-monitor{padding:10px}
    .crt-screen{padding:28px 16px 22px}
    .tile-icon{font-size:38px;margin-bottom:12px}
    .tile-label{font-size:12px;letter-spacing:3px}
    .tile-sub{font-size:9px}

    /* Back/Forward nav buttons — tighter to edges */
    .screen-back{top:12px;left:12px;padding:8px 14px}
    .screen-back span{font-size:10px;letter-spacing:2px}

    /* Login */
    .login-container{gap:14px}
    .login-title{font-size:14px}
    .login-panel{width:380px;padding:22px 18px 16px}

    /* Registration */
    .reg-container{max-width:480px}
    .reg-panel{padding:22px 20px 18px}

    /* Landing */
    .landing-container{max-width:440px}

    /* Panels */
    .expanded-panel{width:96vw;height:92vh}
    .confirm-box{width:90vw;max-width:500px}
    .edit-box{width:90vw;max-width:460px}
  }

  /* Mobile */
  @media(max-width:768px){
    /* Login */
    .login-panel{width:92vw;max-width:420px;padding:20px 16px 14px}
    .login-title{font-size:11px;letter-spacing:2px}
    .vault-subtitle{font-size:8px;letter-spacing:3px}
    .v-display{height:56px}
    #vDisp{font-size:18px;letter-spacing:6px}
    .kb-row{max-width:100%;gap:3px;margin-bottom:3px}
    .kb-key{height:38px}
    .kb-key span{font-size:12px}

    /* Console */
    #consoleScreen{height:auto;min-height:100vh}
    .console-topbar{height:50px;padding:0 14px}
    .console-title{font-size:9px;letter-spacing:3px}
    .timer-digits{font-size:16px;letter-spacing:2px}
    .timer-label{font-size:7px}
    .console-team{font-size:8px}

    /* Grid — stack vertical on mobile */
    .console-grid{grid-template-columns:1fr;gap:14px;padding:16px;align-content:start;padding-top:24px}

    /* Allow console to scroll on mobile */
    #consoleScreen{position:fixed;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .crt-monitor{padding:10px} .crt-screen{padding:24px 16px 20px}
    .tile-icon{font-size:36px;margin-bottom:12px}
    .tile-label{font-size:11px;letter-spacing:2px}
    .tile-sub{font-size:9px}
    .tile-badge{font-size:7px;letter-spacing:2px;padding:4px 12px}
    .tile-status span{font-size:7px}

    /* Expanded panels */
    .expanded-panel{width:100vw;height:100vh;border-radius:0;border:none}
    .exp-header{height:48px;padding:0 14px}
    .exp-title{font-size:11px;letter-spacing:2px}
    .exp-body{padding:12px}
    .exp-close{padding:6px 14px;font-size:9px}

    /* Feed — keep 3 column grid on mobile, tight gaps like IG */
    .feed-expanded{grid-template-columns:repeat(3,1fr);gap:2px;max-width:100%}
    .feed-card-img{font-size:24px}
    .feed-card-cap p{font-size:9px}
    .feed-view-toggle{margin-bottom:10px}
    .feed-view-btn{padding:7px;font-size:7px}
    .feed-single{max-width:100%;gap:12px}
    .feed-single-img{border-radius:0}
    .feed-single-caption{font-size:12px;max-width:100%;padding:0 8px}
    .feed-nav-btn,.feed-back-grid{padding:8px 16px;font-size:9px}

    /* Media */
    .media-expanded{max-width:100%}
    .media-exp-item{padding:12px 14px;gap:10px}
    .media-exp-name{font-size:11px}
    .media-exp-desc{font-size:8px}

    /* Intel */
    .intel-expanded{max-width:100%;gap:8px}
    .intel-exp-row{flex-wrap:wrap;padding:12px;gap:8px}
    .intel-exp-num{min-width:24px;font-size:10px}
    .intel-exp-label{min-width:100%;font-size:10px;margin-bottom:2px}
    .intel-exp-input{font-size:11px;padding:8px 10px}
    .intel-dual-wrap{flex-direction:column;gap:6px}
    .intel-dual-sep{display:none}
    .intel-submit-btn{font-size:10px;letter-spacing:3px;padding:12px 30px}
    .intel-exp-check{width:18px;height:18px;font-size:9px;position:absolute;right:12px;top:12px}
    .intel-exp-row{position:relative}

    /* Confirm modal */
    .confirm-box{width:94vw;max-height:85vh}
    .confirm-header{padding:14px 16px}
    .confirm-header h3{font-size:10px;letter-spacing:3px}
    .confirm-body{padding:12px 16px}
    .confirm-row{flex-direction:column;gap:4px;align-items:flex-start}
    .confirm-value{text-align:left;max-width:100%}
    .confirm-footer{padding:12px 16px;gap:8px}
    .btn-standard{padding:8px 18px;font-size:9px}

    /* Media Viewer */
    .mv-container{width:100vw;height:100vh;border-radius:0}
    .mv-header{padding:10px 14px}
    .mv-filename{font-size:10px}
    .mv-filedesc{font-size:8px}
    .mv-close{padding:6px 14px;font-size:9px}
    .mv-body{padding:12px}
    .mv-audio-player{padding:20px}
    .mv-nav-btn{padding:6px 14px;font-size:9px}
    .mv-video-controls{padding:8px 12px}

    /* Notepad */
    #notepadPanel{width:100vw;max-height:85vh;border-radius:12px 12px 0 0;left:0;transform:translateX(0) translateY(100%)}
    #notepadPanel.open{transform:translateX(0) translateY(0)}
    .notepad-header{padding:12px 16px}
    .notepad-header-title{font-size:10px;letter-spacing:2px}
    .notepad-hint{padding:8px 16px;font-size:9px}
    .notepad-body{min-height:40vh;padding:8px 16px 16px}
    .notepad-textarea{font-size:14px;line-height:1.9;-webkit-user-select:text;user-select:text}
    .notepad-footer{padding:10px 16px}
    .notepad-charcount{font-size:8px}
    .notepad-clear{padding:6px 14px;font-size:9px}
    .notepad-trigger{bottom:10px;padding:8px 16px 8px 12px}
    .notepad-trigger span{font-size:8px;letter-spacing:2px}

    /* Logout */
    .logout-btn{bottom:10px;left:10px;padding:8px 14px}
    .logout-btn span{font-size:10px;letter-spacing:2px}
    .logout-btn svg{width:14px;height:14px}

    /* Admin */
    .admin-login-box{width:90vw;max-width:340px;padding:22px 18px}
    .edit-box{width:94vw;max-width:500px;padding:18px}
    .ap-container{width:96vw;max-height:90vh}
    .ap-section{padding:14px 16px}
    .ap-row{flex-direction:column}
    .bc-container{width:96vw}
    .pb-inner{padding:10px 14px}
    .pb-text{font-size:11px}
    .admin-dropdown{width:200px;bottom:48px;right:8px}
    .lb-container{width:100vw;height:100vh;border-radius:0}
    .lb-toolbar{flex-direction:column;align-items:stretch}
    .lb-search{width:100%}
    .lb-sort{margin-left:0}
    .lb-rank{font-size:14px;min-width:26px}
    .lb-score-pct{font-size:13px}
    .kc-container{width:96vw}
  }

  /* Small phones */
  @media(max-width:380px){
    .login-panel{padding:16px 12px 12px}
    .kb-key{height:34px}
    .kb-key span{font-size:11px}
    .login-title{font-size:10px;letter-spacing:4px}
    .tile-label{font-size:10px}
    .tile-icon{font-size:30px}
    .crt-monitor{padding:8px} .crt-screen{padding:18px 14px 16px}
    .intel-exp-label{font-size:9px}
  }

  @keyframes shake{0%,100%{transform:translateX(0)}10%{transform:translateX(-5px)}20%{transform:translateX(5px)}30%{transform:translateX(-4px)}40%{transform:translateX(4px)}50%{transform:translateX(-2px)}60%{transform:translateX(2px)}}
  .flash-green{position:fixed;inset:0;background:rgba(0,255,136,.06);z-index:8500;opacity:0;pointer-events:none;transition:opacity .3s}
  .flash-green.on{opacity:1}
  .flash-red{position:fixed;inset:0;background:rgba(255,30,30,.05);z-index:8500;opacity:0;pointer-events:none;transition:opacity .2s}
  .flash-red.on{opacity:1}
  .dust{position:fixed;width:1px;height:1px;background:rgba(255,255,255,.08);border-radius:50%;pointer-events:none;z-index:9998;animation:dustF linear infinite}
  @keyframes dustF{0%{transform:translateY(100vh) translateX(0);opacity:0}10%{opacity:.15}90%{opacity:.15}100%{transform:translateY(-20px) translateX(20px);opacity:0}}
</style>
</head>
<body>
<canvas id="grainCanvas"></canvas>
<div class="flash-green" id="flashG"></div>
<div class="flash-red" id="flashR"></div>

<div class="admin-trigger" id="adminTrigger" onclick="handleAdminTrigger()" title="System"><svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53a7.76 7.76 0 0 0 0-1.94l2.11-1.65a.5.5 0 0 0 .12-.64l-2-3.46a.5.5 0 0 0-.61-.22l-2.49 1a7.2 7.2 0 0 0-1.69-.98l-.38-2.65A.49.49 0 0 0 14 2h-4a.49.49 0 0 0-.49.42l-.38 2.65a7.2 7.2 0 0 0-1.69.98l-2.49-1a.5.5 0 0 0-.61.22l-2 3.46a.49.49 0 0 0 .12.64l2.11 1.65a7.9 7.9 0 0 0 0 1.94l-2.11 1.65a.5.5 0 0 0-.12.64l2 3.46a.5.5 0 0 0 .61.22l2.49-1c.52.4 1.08.72 1.69.98l.38 2.65c.05.24.26.42.49.42h4c.24 0 .44-.18.49-.42l.38-2.65a7.2 7.2 0 0 0 1.69-.98l2.49 1a.5.5 0 0 0 .61-.22l2-3.46a.49.49 0 0 0-.12-.64z"/></svg></div>

<!-- Admin Dropdown Menu -->
<div class="admin-dropdown" id="adminDropdown">
  <div class="admin-dropdown-header">
    <div class="admin-dropdown-dot"></div>
    <span class="admin-dropdown-label">Admin</span>
  </div>
  <div class="admin-dropdown-body">
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openAdminPanel()"><span class="adm-icon">⚙</span><span class="adm-label">Admin Panel</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openBroadcast()"><span class="adm-icon">📢</span><span class="adm-label">Broadcast</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openLeaderboard()"><span class="adm-icon">🏆</span><span class="adm-label">Leaderboard</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openKeysCodes()"><span class="adm-icon">🔐</span><span class="adm-label">Keys & Codes</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openTeamMonitor()"><span class="adm-icon">📡</span><span class="adm-label">Team Monitor</span></div>
    <div class="admin-dropdown-sep"></div>
    <div class="admin-dropdown-toggle" onclick="toggleAllowDownloads()"><span class="adm-icon">⬇</span><span class="adm-label">Allow Downloads</span><span class="adm-toggle off" id="admDlToggle">OFF</span></div>
    <div class="admin-dropdown-toggle" onclick="toggleEditMode()"><span class="adm-icon">✎</span><span class="adm-label">Edit Mode</span><span class="adm-toggle off" id="admEditToggle">OFF</span></div>
  </div>
</div>

<div class="notepad-trigger" id="notepadTrigger" onclick="toggleNotepad()"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Field Notes</span><div class="notepad-dot" id="notepadDot"></div></div>

<div id="logoutModal"><div class="logout-box"><h3>⚠ Confirm Logout</h3><p>You'll need your Team ID to re-enter via the Vault. Are you sure?</p><div style="display:flex;gap:12px;justify-content:center"><button class="btn-standard btn-ghost" onclick="hideLogout()">Cancel</button><button class="btn-standard btn-red" onclick="doLogout()">Logout</button></div></div></div>

<div id="adminEditModal"><div class="edit-box" id="editBox"></div></div>

<div id="confirmModal"><div class="confirm-box"><div class="confirm-header"><h3>⚠ Confirm Transmission</h3><p>Review your intel before final submission. This action cannot be undone.</p></div><div class="confirm-body" id="confirmBody"></div><div class="confirm-footer"><button class="btn-standard btn-ghost" onclick="hideConfirm()">◂ Go Back</button><button class="btn-standard btn-green" onclick="finalSubmit()">Confirm & Transmit ◈</button></div></div></div>

<!-- ADMIN CHOICE MODAL (after auth from landing) -->
<div id="adminChoiceModal"><div class="admin-choice-box"><h3>◈ Navigation</h3><p>Where would you like to go?</p><div class="admin-choice-btns"><button class="btn-standard btn-cyan" onclick="adminGoVault()">Go to Vault</button><button class="btn-standard btn-green" onclick="adminGoConsole()">Go to Console</button></div></div></div>

<!-- LANDING PAGE -->
<div class="screen active" id="landingScreen">
  <div class="landing-circuits">
    <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="cGlow" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="rgba(0,255,136,.06)"/><stop offset="100%" stop-color="transparent"/></radialGradient>
      </defs>
      <rect fill="url(#cGlow)" width="1200" height="800"/>
      <!-- Horizontal traces -->
      <line x1="0" y1="120" x2="320" y2="120" stroke="rgba(0,255,136,.12)" stroke-width=".8"/>
      <line x1="380" y1="120" x2="600" y2="120" stroke="rgba(0,255,136,.08)" stroke-width=".5"/>
      <line x1="0" y1="280" x2="180" y2="280" stroke="rgba(0,212,255,.1)" stroke-width=".8"/>
      <line x1="240" y1="280" x2="440" y2="280" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="700" y1="200" x2="1200" y2="200" stroke="rgba(0,255,136,.1)" stroke-width=".8"/>
      <line x1="800" y1="350" x2="1200" y2="350" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="0" y1="500" x2="250" y2="500" stroke="rgba(0,255,136,.07)" stroke-width=".5"/>
      <line x1="900" y1="520" x2="1200" y2="520" stroke="rgba(0,255,136,.09)" stroke-width=".8"/>
      <line x1="0" y1="650" x2="350" y2="650" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="750" y1="680" x2="1200" y2="680" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <!-- Vertical traces -->
      <line x1="320" y1="0" x2="320" y2="180" stroke="rgba(0,255,136,.1)" stroke-width=".8"/>
      <line x1="320" y1="120" x2="320" y2="280" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <line x1="180" y1="280" x2="180" y2="500" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="900" y1="0" x2="900" y2="200" stroke="rgba(0,255,136,.08)" stroke-width=".5"/>
      <line x1="900" y1="200" x2="900" y2="520" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <line x1="440" y1="280" x2="440" y2="800" stroke="rgba(0,212,255,.05)" stroke-width=".5"/>
      <line x1="750" y1="350" x2="750" y2="680" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="1050" y1="0" x2="1050" y2="350" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <line x1="120" y1="500" x2="120" y2="800" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <!-- Angled traces -->
      <line x1="600" y1="120" x2="700" y2="200" stroke="rgba(0,255,136,.07)" stroke-width=".5"/>
      <line x1="250" y1="500" x2="350" y2="650" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="800" y1="350" x2="750" y2="520" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <!-- Junction nodes -->
      <circle cx="320" cy="120" r="3" fill="rgba(0,255,136,.2)"/><circle cx="320" cy="120" r="1.2" fill="rgba(0,255,136,.5)"/>
      <circle cx="180" cy="280" r="3" fill="rgba(0,212,255,.2)"/><circle cx="180" cy="280" r="1.2" fill="rgba(0,212,255,.5)"/>
      <circle cx="440" cy="280" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="440" cy="280" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="900" cy="200" r="3" fill="rgba(0,255,136,.2)"/><circle cx="900" cy="200" r="1.2" fill="rgba(0,255,136,.5)"/>
      <circle cx="900" cy="520" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="900" cy="520" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="700" cy="200" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="700" cy="200" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="600" cy="120" r="2" fill="rgba(0,255,136,.12)"/><circle cx="600" cy="120" r=".8" fill="rgba(0,255,136,.3)"/>
      <circle cx="250" cy="500" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="250" cy="500" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="800" cy="350" r="3" fill="rgba(0,212,255,.18)"/><circle cx="800" cy="350" r="1.2" fill="rgba(0,212,255,.45)"/>
      <circle cx="750" cy="680" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="750" cy="680" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="350" cy="650" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="350" cy="650" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="120" cy="500" r="2" fill="rgba(0,255,136,.12)"/><circle cx="120" cy="500" r=".8" fill="rgba(0,255,136,.3)"/>
      <circle cx="1050" cy="350" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="1050" cy="350" r="1" fill="rgba(0,255,136,.4)"/>
      <!-- IC chip shapes -->
      <rect x="295" y="95" width="50" height="50" rx="3" fill="none" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <rect x="875" y="175" width="50" height="50" rx="3" fill="none" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <rect x="775" y="325" width="50" height="50" rx="3" fill="none" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <!-- Pulsing nodes -->
      <circle cx="320" cy="120" r="6" fill="none" stroke="rgba(0,255,136,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="3s" repeatCount="indefinite"/></circle>
      <circle cx="900" cy="200" r="6" fill="none" stroke="rgba(0,255,136,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="4s" repeatCount="indefinite"/></circle>
      <circle cx="800" cy="350" r="6" fill="none" stroke="rgba(0,212,255,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="3.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="3.5s" repeatCount="indefinite"/></circle>
    </svg>
  </div>
  <div class="landing-container">
    <div class="landing-banner" id="landingBannerWrap">
      <span class="landing-banner-icon">🔐</span>
      <img class="landing-banner-img" id="landingBannerImg" alt="Code Breakers">
      <div class="landing-banner-upload" onclick="document.getElementById('landingBannerFile').click()" title="Upload banner">📷</div>
      <input type="file" id="landingBannerFile" accept="image/*" onchange="handleBannerUpload(this)">
    </div>
    <div class="landing-title" id="landingTitleEl">Code Breakers</div>
    <div class="landing-subtitle" id="landingSubEl">Team Challenge Experience</div>
    <div class="landing-actions">
      <div class="landing-login-btn" onclick="goToLogin()">LOGIN</div>
    </div>
  </div>
  <div class="landing-footer"><span>© 2026 Sandals Employee Experience. All rights reserved.</span></div>
</div>

<!-- REGISTRATION -->
<div class="screen" id="regScreen">
  <div class="screen-back" onclick="showScreen('landingScreen')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg><span>Back</span></div>
  <div class="reg-container">
    <div class="reg-title" id="regScreenTitle">Operation Dead Drop</div>
    <div class="reg-subtitle" id="regScreenSubtitle">Team Registration Portal</div>
    <div class="reg-panel">
      <div id="regForm">
        <!-- Hybrid mode type choice (hidden unless hybrid) -->
        <div class="reg-type-choice" id="regTypeChoice" style="display:none">
          <div class="reg-type-btn selected" data-type="team" onclick="selectRegType(this)">
            <div class="rtype-icon">👥</div>
            <div class="rtype-label">Team</div>
          </div>
          <div class="reg-type-btn" data-type="individual" onclick="selectRegType(this)">
            <div class="rtype-icon">👤</div>
            <div class="rtype-label">Individual</div>
          </div>
        </div>

        <div class="reg-section">
          <div class="reg-section-title">◈ Team Identity</div>
          <div class="reg-field full">
            <label>Team Name</label>
            <input type="text" id="regTeamName" placeholder="Enter your team name" maxlength="30">
          </div>
        </div>

        <div class="reg-section">
          <div class="reg-section-title">◈ Operatives</div>
          <div id="regOperatives"></div>
        </div>

        <div class="reg-err" id="regErr"></div>
        <button class="reg-submit" onclick="submitRegistration()">◈ Register Team ◈</button>
      </div>

      <div id="regSuccess">
        <div class="reg-section-title" style="text-align:center;border-bottom:none;margin-bottom:8px">◈ Registration Complete</div>
        <div class="reg-id-display">
          <div class="reg-id-label">Your Team ID</div>
          <div class="reg-id-value" id="regTeamId">—</div>
        </div>
        <div class="reg-id-warn">⚠ Save this ID — you'll need it to resume your session</div>
        <div class="reg-id-note">Share this ID with your team members. Any member can access and continue the mission using this code on any device.</div>
        <button class="reg-proceed" onclick="proceedToLogin()">Proceed to Mission ▸</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div class="screen" id="loginScreen">
  <div class="screen-back" onclick="showScreen('landingScreen')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg><span>Back</span></div>
  <div class="login-container">
    <div style="display:flex;align-items:center;justify-content:center"><div class="login-title" id="loginTitle">Operation Dead Drop</div><button class="admin-edit-inline" onclick="event.stopPropagation();editOperationName()">✎</button></div>
    <div class="login-subtitle">Enter Your Credentials</div>
    <div class="login-panel">
      <div class="rv rv-1"></div><div class="rv rv-2"></div><div class="rv rv-3"></div><div class="rv rv-4"></div>
      <div class="login-field">
        <label>Team ID or Username</label>
        <input type="text" id="loginId" placeholder="e.g. ALPHA-1234" autocomplete="off" spellcheck="false">
      </div>
      <div class="login-field login-pw-field" id="loginPwField" style="display:none">
        <label>Password</label>
        <input type="password" id="loginPw" placeholder="Enter password">
      </div>
      <div class="login-err" id="loginErr"></div>
      <button class="login-submit" id="loginSubmitBtn" onclick="submitLogin()">ENTER</button>
      <div class="login-status">
        <div class="v-dot" id="loginDot"></div>
        <span class="v-lbl" id="loginLbl">AWAITING INPUT</span>
      </div>
    </div>
    <div class="login-register-link" id="loginRegLink" onclick="goToRegistration()"><span id="loginRegText">Don't have an ID?</span> <span class="lrl-action" id="loginRegAction">Register here</span></div>
  </div>
</div>

<div id="vaultOpenOverlay"><div class="vo-text" id="voText">ACCESS GRANTED</div><div class="vo-sub" id="voSub">Initializing operations console...</div><div class="vo-bar" id="voBar"><div class="vo-fill" id="voFill"></div></div><div class="vo-pct" id="voPct">0%</div></div>

<!-- ADMIN BAR (fixed, body-level) -->
<!-- CONSOLE -->
<div class="screen" id="consoleScreen">

<!-- ADMIN PROFILE PANEL -->
<div id="adminPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>⚙ Admin Panel</h3><button class="mv-close" onclick="closeAdminPanel()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>🔐 Change Password</h4>
      <div class="ap-field"><label>Current Password</label><input type="password" id="apCurPw"></div>
      <div class="ap-field"><label>New Password</label><input type="password" id="apNewPw"></div>
      <div class="ap-field"><label>Confirm New Password</label><input type="password" id="apConfPw"></div>
      <button class="ap-btn ap-btn-cyan" onclick="changeAdminPw()">Update Password</button>
      <div class="ap-msg" id="apPwMsg"></div>
    </div>
    <div class="ap-section"><h4>👥 Portal Administrators</h4>
      <p>Add additional administrators who can access the admin panel.</p>
      <div class="ap-row">
        <div class="ap-field"><label>Username</label><input id="apAddUser"></div>
        <div class="ap-field"><label>Password</label><input id="apAddPw"></div>
        <button class="ap-btn ap-btn-green" onclick="addAdmin()" style="flex-shrink:0;margin-bottom:10px">+ Add</button>
      </div>
      <div class="ap-msg" id="apAdminMsg"></div>
      <div id="apAdminList"></div>
    </div>
    <div class="ap-section"><h4>🏷️ Manual Entry Creation</h4>
      <p id="apManualDesc">Manually create teams with custom or auto-generated IDs.</p>
      <div class="ap-row" id="apManualTypeRow" style="display:none;margin-bottom:10px">
        <div class="ap-field"><label>Entry Type</label><select id="apManualType" onchange="onManualTypeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none"><option value="team">Team</option><option value="individual">Individual</option></select></div>
      </div>
      <div class="ap-row">
        <div class="ap-field"><label id="apManualNameLabel">Team Name</label><input id="apTeamName" placeholder="e.g. Alpha Squad"></div>
        <div class="ap-field"><label id="apManualIdLabel">Team ID (leave blank to auto-generate)</label><input id="apTeamId" placeholder="Auto-generated"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="ap-btn ap-btn-green" id="apManualCreateBtn" onclick="createManualTeam()">Create Team</button>
        <button class="ap-btn ap-btn-cyan" onclick="autoGenTeamId()" style="font-size:8px">🎲 Generate ID</button>
      </div>
      <div class="ap-msg" id="apTeamMsg"></div>
      <div class="ap-team-list" id="apTeamList"></div>
    </div>
    <div class="ap-section"><h4>🎮 Event Settings</h4>
      <p>Configure participant mode, countdown timer, and leaderboard display.</p>
      <div style="margin-bottom:16px">
        <label style="font-family:Saira,sans-serif;font-size:10px;color:#d0e8f0;letter-spacing:2px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">⏱ Countdown Timer</label>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="admin-timer-btn" id="pauseBtn" onclick="togglePause()">⏸ PAUSE</button>
          <input class="admin-timer-input" id="timerInput" placeholder="HH:MM:SS" maxlength="8">
          <button class="admin-timer-btn" onclick="setNewTime()">SET</button>
          <button class="admin-timer-btn" onclick="resetTimer()">RESET</button>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--red);letter-spacing:3px;margin-left:8px;font-weight:700;text-shadow:0 0 8px rgba(255,50,50,.3)" id="apTimerDisplay">—</span>
        </div>
      </div>
      <div class="edit-field-row" style="gap:12px;margin-bottom:12px">
        <div class="ap-field"><label>Participant Mode</label><select id="apParticipantMode" onchange="onParticipantModeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none"><option value="team">Team Only</option><option value="individual">Individual Only</option><option value="hybrid">Open (Hybrid)</option></select></div>
        <div class="ap-field"><label>Leaderboard Style</label><select id="apLeaderboardStyle" onchange="onLeaderboardStyleChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none"><option value="mixed">Single Mixed</option><option value="split">Split by Type</option><option value="labeled">Single with Labels</option></select></div>
      </div>
    </div>
    <div class="ap-section"><h4>🏠 Landing Page</h4>
      <p>Customize the landing page banner and text.</p>
      <div class="ap-field" style="margin-bottom:10px"><label>Banner Image</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="apBannerUrl" placeholder="Paste image URL or upload below" onchange="updateLandingBanner()" style="flex:1">
          <label style="cursor:pointer;font-size:9px;color:var(--cyan);letter-spacing:1px;padding:8px 12px;border:1px solid rgba(0,212,255,.2);border-radius:3px;background:rgba(0,212,255,.05);white-space:nowrap;font-family:'IBM Plex Mono',monospace">
            📁 Upload
            <input type="file" accept="image/*" onchange="handleAdminBannerUpload(this)" style="display:none">
          </label>
        </div>
      </div>
      <div class="edit-field-row" style="gap:12px;margin-bottom:12px">
        <div class="ap-field"><label>Title</label><input id="apLandingTitle" value="Code Breakers" onchange="updateLandingTitle()"></div>
        <div class="ap-field"><label>Subtitle</label><input id="apLandingSubtitle" value="Team Challenge Experience" onchange="updateLandingSubtitle()"></div>
      </div>
    </div>
    <div class="ap-section"><h4>📝 Registration Settings</h4>
      <p>Configure team registration parameters. Changes apply immediately.</p>
      <div class="edit-field-row" style="gap:12px;margin-bottom:12px">
        <div class="ap-field"><label>Min Team Size</label><select id="apMinSize" onchange="updateRegSettings()"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
        <div class="ap-field"><label>Max Team Size</label><select id="apMaxSize" onchange="updateRegSettings()"><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option></select></div>
        <div class="ap-field"><label>Max Teams</label><input type="number" id="apMaxTeams" value="20" min="2" max="100" onchange="updateRegSettings()"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqEmail" checked onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Email Address</span></label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqPhone" onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Phone Number</span></label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqDept" onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Department</span></label>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apRegOpen" checked onchange="updateRegSettings()"><span style="font-family:Saira,sans-serif;font-size:10px;color:var(--green);letter-spacing:1px;font-weight:600">Registration Open</span></label>
        <span id="apRegStatus" style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--green);letter-spacing:1px">● OPEN</span>
      </div>
    </div>
  </div>
</div>

<!-- TEAM MONITOR PANEL -->
<div id="teamMonitorPanel">
  <div class="ap-container" style="width:640px">
    <div class="ap-header"><h3>📡 Team Monitor</h3><button class="mv-close" onclick="closeTeamMonitor()">✕ CLOSE</button></div>
    <div class="ap-section">
      <p>Real-time view of all registered teams and their activity status. Teams inactive for 5+ minutes are flagged.</p>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div class="ap-status-pill active"><span class="ap-status-dot on"></span> Active: <strong id="apActiveCount">0</strong></div>
        <div class="ap-status-pill inactive"><span class="ap-status-dot off"></span> Inactive: <strong id="apInactiveCount">0</strong></div>
        <div class="ap-status-pill total">Total: <strong id="apTotalCount">0</strong></div>
      </div>
      <div class="ap-team-list" id="apTeamMonitor" style="max-height:60vh"></div>
    </div>
  </div>
</div>

<!-- BROADCAST PANEL -->
<div id="broadcastPanel">
  <div class="bc-container">
    <div class="bc-header"><h3>📢 Broadcast</h3><button class="mv-close" onclick="closeBroadcast()">✕ CLOSE</button></div>
    <div class="bc-body">
      <div class="bc-tabs">
        <div class="bc-tab active" onclick="switchBcTab(this,'text')">💬 Text Message</div>
        <div class="bc-tab" onclick="switchBcTab(this,'voice')">🎙️ Voice Note</div>
      </div>
      <div id="bcTextTab">
        <textarea class="bc-textarea" id="bcMessage" placeholder="Type a message to broadcast to all players..."></textarea>
      </div>
      <div id="bcVoiceTab" style="display:none">
        <div class="bc-voice">
          <div class="bc-rec-btn" id="bcRecBtn" onclick="toggleRecording()">🎙️</div>
          <div class="bc-rec-label" id="bcRecLabel">Tap to record</div>
          <div class="bc-preview" id="bcPreview" style="display:none">
            <audio id="bcAudioPreview" controls style="width:100%"></audio>
          </div>
        </div>
      </div>
      <div class="bc-footer">
        <button class="ap-btn ap-btn-cyan" onclick="closeBroadcast()">Cancel</button>
        <button class="ap-btn ap-btn-amber" onclick="sendBroadcast()">📡 Broadcast Now</button>
      </div>
    </div>
  </div>
</div>

<!-- PLAYER BROADCAST BANNER -->
<div id="playerBanner">
  <div class="pb-inner">
    <span class="pb-icon" id="pbIcon">📢</span>
    <div id="pbContent"></div>
    <span class="pb-close" onclick="dismissBanner()">✕</span>
    <div class="pb-progress" id="pbProgress"></div>
  </div>
</div>

<!-- FULL LEADERBOARD MODULE -->
<div id="leaderboardModule">
  <div class="lb-container">
    <div class="lb-header">
      <h3 class="lb-title">🏆 Live Leaderboard</h3>
      <div class="lb-header-right">
        <span class="lb-team-count" id="lbTeamCount">0 teams</span>
        <button class="mv-close" onclick="closeLeaderboard()">✕ CLOSE</button>
      </div>
    </div>
    <div class="lb-toolbar">
      <input class="lb-search" id="lbSearch" placeholder="Search teams..." oninput="renderFullLeaderboard()">
      <div class="lb-filters">
        <button class="lb-filter active" data-f="all" onclick="setLbFilter(this,'all')">All</button>
        <button class="lb-filter" data-f="active" onclick="setLbFilter(this,'active')">Active</button>
        <button class="lb-filter" data-f="inactive" onclick="setLbFilter(this,'inactive')">Inactive</button>
        <button class="lb-filter" data-f="submitted" onclick="setLbFilter(this,'submitted')">Submitted</button>
      </div>
      <div class="lb-sort">
        <span style="font-family:Chakra Petch,sans-serif;font-size:8px;color:#666;letter-spacing:1px">Sort:</span>
        <select id="lbSort" onchange="renderFullLeaderboard()" style="background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 8px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:9px;outline:none">
          <option value="score">Score (High→Low)</option>
          <option value="fields">Fields Completed</option>
          <option value="recent">Most Recent</option>
          <option value="name">Team Name (A→Z)</option>
          <option value="registered">Registration Order</option>
        </select>
      </div>
    </div>
    <div class="lb-body" id="lbBody"></div>
  </div>
</div>

<!-- KEYS & CODES PANEL -->
<div id="keysCodesPanel">
  <div class="kc-container">
    <div class="kc-header"><h3>🔐 Keys & Codes</h3><button class="mv-close" onclick="closeKeysCodes()">✕ CLOSE</button></div>
    <div class="kc-body" id="kcBody"></div>
  </div>
</div>
  <div class="console-topbar">
    <span class="console-title" id="consoleTitle">◈ Operation Dead Drop</span><button class="admin-edit-inline" onclick="event.stopPropagation();editOperationName()">✎</button>
    <div style="display:flex;align-items:center">
      <div class="timer-block"><div class="timer-digits" id="cTimer">01:28:45</div><div class="timer-label">Time Remaining</div></div>
    </div>
    <span class="console-team" onclick="toggleTeamCard(event)">—
      <div class="team-card" id="teamCard">
        <div class="team-card-header">
          <div class="team-card-name">—</div>
          <div class="team-card-id">ID: —</div>
        </div>
        <div class="team-card-body">
          <div class="team-card-section">
            <div class="team-card-label">Operatives</div>
          </div>
          <div class="team-card-section">
            <div class="team-card-label">Mission Status</div>
            <div class="team-card-stats">
              <div class="team-card-stat"><div class="team-card-stat-val" id="tcElapsed">00:00</div><div class="team-card-stat-lbl">Elapsed</div></div>
              <div class="team-card-stat"><div class="team-card-stat-val" id="tcIntel">0 / 10</div><div class="team-card-stat-lbl">Intel Marked</div></div>
            </div>
          </div>
        </div>
      </div>
    </span>
    <div class="notif-bell" id="notifBell" onclick="toggleNotifDropdown(event)">
      <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <div class="notif-badge" id="notifBadge">0</div>
      <div class="notif-dropdown" id="notifDropdown">
        <div class="notif-dropdown-header">
          <span class="notif-dropdown-title">Notifications</span>
          <span class="notif-dropdown-clear" onclick="event.stopPropagation();clearNotifications()">Clear all</span>
        </div>
        <div id="notifList"><div class="notif-empty">No notifications yet</div></div>
      </div>
    </div>
    <span class="admin-topbar-label">Administrator</span>
  </div>
  <div class="console-grid" id="consoleGrid"></div>
  <div class="console-worldmap"></div>
</div>

<!-- Logout button — body level for z-index independence -->
<div class="logout-btn" id="logoutBtn" onclick="showLogout()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Logout</span></div>

<div id="notepadPanel">
  <div class="notepad-header">
    <span class="notepad-header-icon">📝</span>
    <span class="notepad-header-title">Field Notes</span>
    <div class="notepad-header-actions">
      <button class="btn-standard btn-ghost" style="padding:5px 14px;font-size:9px" onclick="toggleNotepad()">✕ CLOSE</button>
    </div>
  </div>
  <div class="notepad-hint">Use this space to jot down observations, track theories, and coordinate with your team.</div>
  <div class="notepad-body">
    <textarea class="notepad-textarea" id="notepadText" placeholder="Start typing your notes..." oninput="onNoteInput()"></textarea>
  </div>
  <div class="notepad-footer">
    <span class="notepad-charcount" id="notepadCount">0 characters</span>
    <button class="notepad-clear" onclick="clearNotes()">Clear All Notes</button>
  </div>
</div>

<!-- EXPANDED -->
<div id="panelOverlay">
  <div class="expanded-panel" id="expFeed"><div class="exp-header"><span class="panel-icon">📡</span><span class="exp-title">Intelligence Feed</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div><div class="exp-body"><div id="feedViewToggle" class="feed-view-toggle"><div class="feed-view-btn active" onclick="setFeedView('grid')" id="fvGrid">◫ Grid</div><div class="feed-view-btn" onclick="setFeedView('single')" id="fvSingle">◻ Focus</div></div><div id="feedGridView" class="feed-expanded"></div><div id="feedSingleView" class="feed-single"><div class="feed-single-img" id="singleImg"></div><div class="feed-single-controls"><div class="feed-single-nav-row"><button class="feed-nav-btn" onclick="navPost(-1)">◂ PREV</button><span class="feed-single-counter" id="singleCounter">1 / 12</span><button class="feed-nav-btn" onclick="navPost(1)">NEXT ▸</button></div></div><div class="feed-single-caption" id="singleCap"></div><div class="swipe-hint">← Swipe or use arrow keys →</div></div></div></div>
  <div class="expanded-panel" id="expMedia"><div class="exp-header"><span class="panel-icon">🔊</span><span class="exp-title">Media Lab</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div><div class="exp-body"><div id="mediaList" class="media-expanded"></div></div></div>
  <div class="expanded-panel" id="expIntel"><div class="exp-header"><span class="panel-icon">🎯</span><span class="exp-title">Intel Submissions</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div><div class="exp-body"><div class="intel-expanded" id="intelForm"></div></div></div>
  <div class="expanded-panel" id="expVault">
    <div class="exp-header"><span class="panel-icon">🔐</span><span class="exp-title">The Vault</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div>
    <div class="exp-body">
      <div class="vault-puzzle-layout">
        <div class="vault-keypad-section">
          <div class="vault-panel" id="vaultPanel">
            <div class="v-rate-limit" id="vRateLimit"><span class="v-rate-limit-text">Slow Down</span><span class="v-rate-limit-timer" id="vRateLimitTimer">15</span></div>
            <div class="rv rv-1"></div><div class="rv rv-2"></div><div class="rv rv-3"></div><div class="rv rv-4"></div>
            <div class="v-display"><span id="vDisp">ENTER CODE</span><span id="vCursor"></span></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('1')"><span>1</span></div><div class="kb-key" onclick="vkType('2')"><span>2</span></div><div class="kb-key" onclick="vkType('3')"><span>3</span></div><div class="kb-key" onclick="vkType('4')"><span>4</span></div><div class="kb-key" onclick="vkType('5')"><span>5</span></div><div class="kb-key" onclick="vkType('6')"><span>6</span></div><div class="kb-key" onclick="vkType('7')"><span>7</span></div><div class="kb-key" onclick="vkType('8')"><span>8</span></div><div class="kb-key" onclick="vkType('9')"><span>9</span></div><div class="kb-key" onclick="vkType('0')"><span>0</span></div></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('Q')"><span>Q</span></div><div class="kb-key" onclick="vkType('W')"><span>W</span></div><div class="kb-key" onclick="vkType('E')"><span>E</span></div><div class="kb-key" onclick="vkType('R')"><span>R</span></div><div class="kb-key" onclick="vkType('T')"><span>T</span></div><div class="kb-key" onclick="vkType('Y')"><span>Y</span></div><div class="kb-key" onclick="vkType('U')"><span>U</span></div><div class="kb-key" onclick="vkType('I')"><span>I</span></div><div class="kb-key" onclick="vkType('O')"><span>O</span></div><div class="kb-key" onclick="vkType('P')"><span>P</span></div></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('A')"><span>A</span></div><div class="kb-key" onclick="vkType('S')"><span>S</span></div><div class="kb-key" onclick="vkType('D')"><span>D</span></div><div class="kb-key" onclick="vkType('F')"><span>F</span></div><div class="kb-key" onclick="vkType('G')"><span>G</span></div><div class="kb-key" onclick="vkType('H')"><span>H</span></div><div class="kb-key" onclick="vkType('J')"><span>J</span></div><div class="kb-key" onclick="vkType('K')"><span>K</span></div><div class="kb-key" onclick="vkType('L')"><span>L</span></div></div>
            <div class="kb-row"><div class="kb-key fn clr-key" onclick="vkClear()"><span>CLR</span></div><div class="kb-key" onclick="vkType('Z')"><span>Z</span></div><div class="kb-key" onclick="vkType('X')"><span>X</span></div><div class="kb-key" onclick="vkType('C')"><span>C</span></div><div class="kb-key" onclick="vkType('V')"><span>V</span></div><div class="kb-key" onclick="vkType('B')"><span>B</span></div><div class="kb-key" onclick="vkType('N')"><span>N</span></div><div class="kb-key" onclick="vkType('M')"><span>M</span></div><div class="kb-key fn del-key" onclick="vkDel()"><span>⌫</span></div></div>
            <div class="kb-row"><div class="kb-key fn sym-key" onclick="vkToggleSymbols()"><span id="vkSymLabel">SYM</span></div><div class="kb-key enter-key" style="flex:3" onclick="vkSubmit()"><span>ENTER</span></div></div>
            <div class="v-status"><div class="v-dot" id="vkDot"></div><span class="v-lbl" id="vkLbl">LOCKED</span></div>
            <div class="v-tries" id="vkTries"></div>
          </div>
        </div>
        <div class="vault-unlock-section">
          <div class="vault-unlock-header">
            <span class="vault-unlock-title">🔓 Unlock Log</span>
            <span class="vault-unlock-count" id="vaultUnlockCount">0 / 0 codes cracked</span>
          </div>
          <div class="vault-unlock-list" id="vaultUnlockList">
            <div class="vault-unlock-empty">No codes entered yet. Solve puzzles across the Intelligence Feed and Media Lab to discover vault codes.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MEDIA VIEWER -->
<div id="mediaViewer">
  <div class="mv-container">
    <div class="mv-header">
      <div class="mv-header-info">
        <span class="mv-icon" id="mvIcon"></span>
        <div class="mv-header-text">
          <span class="mv-filename" id="mvName"></span>
          <span class="mv-filedesc" id="mvDesc"></span>
        </div>
        <span class="mv-badge" id="mvBadge"></span>
      </div>
      <button class="mv-download" id="mvDownload" onclick="downloadCurrentMedia()" style="display:none">⬇ DOWNLOAD</button>
      <button class="mv-close" onclick="closeMediaViewer()">✕ CLOSE</button>
    </div>
    <div class="mv-body" id="mvBody">
      <!-- Dynamic content injected here -->
    </div>
    <div class="mv-nav">
      <button class="mv-nav-btn" onclick="navMedia(-1)">◂ PREV FILE</button>
      <span class="mv-nav-counter" id="mvCounter"></span>
      <button class="mv-nav-btn" onclick="navMedia(1)">NEXT FILE ▸</button>
    </div>
  </div>
</div>

<script>
// ══════ REGISTRATION ══════
function formatRegPhone(el){
  let v=el.value.replace(/\D/g,'').slice(0,10);
  if(v.length>6)v='('+v.slice(0,3)+') '+v.slice(3,6)+'-'+v.slice(6);
  else if(v.length>3)v='('+v.slice(0,3)+') '+v.slice(3);
  else if(v.length>0)v='('+v;
  el.value=v;
}
function generateTeamId(name){
  // First 4 uppercase letters of name, pad with X if needed
  const clean=(name||'TEAM').replace(/[^a-zA-Z]/g,'').toUpperCase();
  const prefix=(clean+'XXXX').substring(0,4);
  let id,attempts=0;
  do{
    const num=String(Math.floor(1000+Math.random()*9000));
    id=prefix+'-'+num;
    attempts++;
  }while(registeredTeams.some(t=>t.id===id)&&attempts<100);
  return id;
}
function submitRegistration(){
  const err=document.getElementById('regErr');
  const mode=regSettings.participantMode||'team';
  let effectiveType=mode==='individual'?'individual':(mode==='team'?'team':currentRegType);

  if(!regSettings.registrationOpen){err.textContent='Registration is currently closed';return}
  if(registeredTeams.length>=regSettings.maxTeams){err.textContent='Maximum number of registrations reached';return}

  let entityName='', members=[];

  if(effectiveType==='team'){
    entityName=document.getElementById('regTeamName')?.value.trim()||'';
    if(!entityName){err.textContent='Please enter a team name';return}
    const memberCount=parseInt(document.getElementById('regMemberCount')?.value||regSettings.teamSizeMax);
    for(let m=1;m<=memberCount;m++){
      const name=document.getElementById('reg'+m+'Name')?.value.trim();
      const dept=document.getElementById('reg'+m+'Dept')?.value.trim()||'';
      const email=document.getElementById('reg'+m+'Email')?.value.trim()||'';
      const phone=document.getElementById('reg'+m+'Phone')?.value.trim()||'';
      if(!name){err.textContent='Please enter name for Team Member '+m;return}
      if(regSettings.requireEmail&&!email){err.textContent='Please enter email for Team Member '+m;return}
      if(regSettings.requirePhone&&!phone){err.textContent='Please enter phone for Team Member '+m;return}
      if(regSettings.requireDept&&!dept){err.textContent='Please enter department for Team Member '+m;return}
      members.push({name,dept,email,phone});
    }
  }else{
    // Individual mode
    entityName=document.getElementById('regIndividualName')?.value.trim()||'';
    if(!entityName){err.textContent='Please enter your name';return}
    const dept=document.getElementById('regIndDept')?.value.trim()||'';
    const email=document.getElementById('regIndEmail')?.value.trim()||'';
    const phone=document.getElementById('regIndPhone')?.value.trim()||'';
    if(regSettings.requireEmail&&!email){err.textContent='Please enter your email';return}
    if(regSettings.requirePhone&&!phone){err.textContent='Please enter your phone number';return}
    if(regSettings.requireDept&&!dept){err.textContent='Please enter your department';return}
    members=[{name:entityName,dept,email,phone}];
  }

  err.textContent='';
  const teamId=generateTeamId(entityName);
  document.getElementById('regTeamId').textContent=teamId;

  registeredTeams.push({
    id:teamId,name:entityName,type:effectiveType,members:members.map(m=>m.name),memberDetails:members,
    lastActive:Date.now(),fieldsCompleted:0,submitTime:null,registeredAt:new Date().toISOString(),submissionResults:null
  });

  document.getElementById('regForm').classList.add('hidden');
  document.getElementById('regSuccess').classList.add('active');
  playSuccess();
  document.getElementById('flashG').classList.add('on');
  setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
}

function updateRegSettings(){
  regSettings.teamSizeMin=parseInt(document.getElementById('apMinSize')?.value||2);
  regSettings.teamSizeMax=parseInt(document.getElementById('apMaxSize')?.value||4);
  regSettings.maxTeams=parseInt(document.getElementById('apMaxTeams')?.value||20);
  regSettings.requireEmail=document.getElementById('apReqEmail')?.checked||false;
  regSettings.requirePhone=document.getElementById('apReqPhone')?.checked||false;
  regSettings.requireDept=document.getElementById('apReqDept')?.checked||false;
  regSettings.registrationOpen=document.getElementById('apRegOpen')?.checked||false;
  // Ensure min <= max
  if(regSettings.teamSizeMin>regSettings.teamSizeMax)regSettings.teamSizeMin=regSettings.teamSizeMax;
  // Update status indicator
  const status=document.getElementById('apRegStatus');
  if(status){
    status.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';
    status.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)';
  }
  // Rebuild registration form with new member count
  buildRegForm();
}

function buildRegForm(){
  const container=document.getElementById('regOperatives');
  if(!container)return;
  const mode=regSettings.participantMode||'team';
  let effectiveType=mode==='individual'?'individual':(mode==='team'?'team':currentRegType);

  // Update section title
  const sectionTitle=container.closest('.reg-panel')?.querySelector('.reg-section-title');
  const teamNameField=document.getElementById('regTeamName');
  const teamNameLabel=teamNameField?.previousElementSibling;

  if(effectiveType==='individual'){
    if(sectionTitle)sectionTitle.textContent='◈ Your Identity';
    // Hide team name, show individual name
    const nameSection=teamNameField?.closest('.reg-section');
    if(nameSection){
      nameSection.innerHTML=`<div class="reg-section-title">◈ Your Identity</div><div class="reg-field full"><label>Full Name</label><input type="text" id="regIndividualName" placeholder="Enter your full name" maxlength="40"></div>`;
    }
    // Show individual-specific optional fields instead of member slots
    let html='';
    if(regSettings.requireDept||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Department${regSettings.requireDept?'':' (optional)'}</label><input type="text" id="regIndDept" placeholder="Department"></div>`}
    if(regSettings.requireEmail||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Email${regSettings.requireEmail?'':' (optional)'}</label><input type="email" id="regIndEmail" placeholder="email@company.com"></div>`}
    if(regSettings.requirePhone||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Cell #${regSettings.requirePhone?'':' (optional)'}</label><input type="tel" id="regIndPhone" placeholder="(XXX) XXX-XXXX" oninput="formatRegPhone(this)"></div>`}
    container.innerHTML=html;
  }else{
    // Team mode — restore standard team form
    const nameSection=document.getElementById('regTeamName')?.closest('.reg-section')||document.getElementById('regIndividualName')?.closest('.reg-section');
    if(nameSection&&!document.getElementById('regTeamName')){
      nameSection.innerHTML=`<div class="reg-section-title">◈ Team Identity</div><div class="reg-field full"><label>Team Name</label><input type="text" id="regTeamName" placeholder="Enter your team name" maxlength="30"></div>`;
    }
    // Standard team member slots
    const max=regSettings.teamSizeMax;
    const min=regSettings.teamSizeMin;
    let html='';
    if(min<max){
      html+=`<div class="reg-field full" style="margin-bottom:12px"><label>Number of Team Members</label><select id="regMemberCount" onchange="rebuildMemberSlots()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none">`;
      for(let n=min;n<=max;n++)html+=`<option value="${n}"${n===max?' selected':''}>${n} Members</option>`;
      html+=`</select></div>`;
    }else{
      html+=`<input type="hidden" id="regMemberCount" value="${max}">`;
    }
    html+=`<div id="regMemberSlots"></div>`;
    container.innerHTML=html;
    rebuildMemberSlots();
  }
}

function rebuildMemberSlots(){
  const count=parseInt(document.getElementById('regMemberCount')?.value||regSettings.teamSizeMax);
  const slots=document.getElementById('regMemberSlots');
  if(!slots)return;
  let html='';
  for(let m=1;m<=count;m++){
    html+=`<div class="reg-member-block">
      <div class="reg-member-label"><span class="reg-member-num">${m}</span> Team Member ${m}</div>
      <div class="reg-row">
        <div class="reg-field"><label>Full Name</label><input type="text" id="reg${m}Name" placeholder="First & Last Name"></div>
        ${regSettings.requireDept||true?`<div class="reg-field"><label>Department${regSettings.requireDept?'':' (optional)'}</label><input type="text" id="reg${m}Dept" placeholder="Department"></div>`:''}
      </div>
      <div class="reg-row">
        ${regSettings.requireEmail||true?`<div class="reg-field"><label>Email${regSettings.requireEmail?'':' (optional)'}</label><input type="email" id="reg${m}Email" placeholder="email@company.com"></div>`:''}
        ${regSettings.requirePhone||true?`<div class="reg-field"><label>Cell #${regSettings.requirePhone?'':' (optional)'}</label><input type="tel" id="reg${m}Phone" placeholder="(XXX) XXX-XXXX" oninput="formatRegPhone(this)"></div>`:''}
      </div>
    </div>`;
  }
  slots.innerHTML=html;
}
function proceedToLogin(){
  goToLogin();
  // Pre-fill the Team ID from registration
  const teamId=document.getElementById('regTeamId')?.textContent;
  if(teamId&&teamId!=='—'){
    document.getElementById('loginId').value=teamId;
  }
}

// ══════ AUDIO ══════
// ══════ TEAM CARD ══════
let teamCardOpen=false,elapsedSec=0,elapsedInterval=null;
function toggleTeamCard(e){
  e.stopPropagation();
  // Don't show team card for admin — just a label
  if(isAdmin)return;
  teamCardOpen=!teamCardOpen;
  document.getElementById('teamCard').classList.toggle('open',teamCardOpen);
  if(teamCardOpen)updateTeamCardStats();
}
function updateTeamCardStats(){
  // Elapsed
  const m=String(Math.floor(elapsedSec/60)).padStart(2,'0');
  const s=String(elapsedSec%60).padStart(2,'0');
  document.getElementById('tcElapsed').textContent=m+':'+s;
  // Intel marked
  const inputs=document.querySelectorAll('.intel-exp-input');
  let n=0;inputs.forEach(inp=>{if(inp.value.trim())n++});
  document.getElementById('tcIntel').textContent=n+' / '+inputs.length+(isSubmitted?' ✓':'');
}
// Start elapsed timer when console opens
function startElapsedTimer(){
  if(elapsedInterval)return;
  elapsedInterval=setInterval(()=>{elapsedSec++;if(teamCardOpen)updateTeamCardStats()},1000);
}
// Close card when clicking outside
document.addEventListener('click',()=>{if(teamCardOpen){teamCardOpen=false;document.getElementById('teamCard').classList.remove('open')}});

// ══════ LOGOUT ══════
// ══════ NOTEPAD ══════
let notepadOpen=false;
function toggleNotepad(){
  notepadOpen=!notepadOpen;
  document.getElementById('notepadPanel').classList.toggle('open',notepadOpen);
  if(notepadOpen){
    playTileClick();
    // Load saved notes
    const saved=localStorage.getItem('dd_notes')||'';
    document.getElementById('notepadText').value=saved;
    updateNoteCount();
    updateNoteDot();
    setTimeout(()=>document.getElementById('notepadText').focus(),350);
  }
}
function onNoteInput(){
  const text=document.getElementById('notepadText').value;
  localStorage.setItem('dd_notes',text);
  updateNoteCount();
  updateNoteDot();
}
function updateNoteCount(){
  const len=document.getElementById('notepadText').value.length;
  document.getElementById('notepadCount').textContent=len+' character'+(len!==1?'s':'');
}
function updateNoteDot(){
  const has=document.getElementById('notepadText').value.trim().length>0;
  document.getElementById('notepadDot').classList.toggle('has-notes',has);
}
function clearNotes(){
  if(!confirm('Clear all notes? This cannot be undone.'))return;
  document.getElementById('notepadText').value='';
  localStorage.removeItem('dd_notes');
  updateNoteCount();
  updateNoteDot();
}
// Load dot state on init
document.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem('dd_notes'))document.getElementById('notepadDot').classList.add('has-notes');
});

function showLogout(){playConfirmPrompt();document.getElementById('logoutModal').classList.add('active')}
function hideLogout(){document.getElementById('logoutModal').classList.remove('active')}
function doLogout(){
  hideLogout();
  notepadOpen=false;document.getElementById('notepadPanel').classList.remove('open');
  document.getElementById('notepadTrigger').classList.remove('visible');
  if(elapsedInterval){clearInterval(elapsedInterval);elapsedInterval=null}
  elapsedSec=0;currentVaultTeam=null;
  // Clear admin state on logout
  if(isAdmin){isAdmin=false;document.body.classList.remove('admin-mode');document.body.classList.remove('edit-mode');closeAdminDropdown()}
  showScreen('landingScreen');
}

let audioCtx;
function getAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
// #7 Soft Beep Tap — vault keypad presses
function playClick(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=1400;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.06,t+.008);
  g.gain.exponentialRampToValueAtTime(.001,t+.08);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.08);
}
// #8 Snap Click — grid tile clicks
function playTileClick(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.value=3000;
  o.frequency.exponentialRampToValueAtTime(500,t+.02);
  g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.03);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.04);
}
// #36 Radar Blip — incoming updates / notifications
function playAlert(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=2600;
  o.frequency.exponentialRampToValueAtTime(2200,t+.08);
  g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.25);
}
// #20 Hydraulic Slide — confirm prompts (submit intel, logout)
function playConfirmPrompt(){
  const c=getAudio(),t=c.currentTime;
  const buf=c.createBuffer(1,c.sampleRate*.25,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
  const s=c.createBufferSource(),hp=c.createBiquadFilter(),ng=c.createGain();
  s.buffer=buf;hp.type='highpass';hp.frequency.value=3000;
  ng.gain.setValueAtTime(.12,t);ng.gain.exponentialRampToValueAtTime(.001,t+.25);
  s.connect(hp);hp.connect(ng);ng.connect(c.destination);s.start(t);
  setTimeout(()=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=80;
  g.gain.setValueAtTime(.15,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.2);
  o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+.2)},150);
}
function playSuccess(){
  const c=getAudio(),now=c.currentTime;
  // Sub thud - felt more than heard
  const sub=c.createOscillator(),sg=c.createGain();
  sub.connect(sg);sg.connect(c.destination);sub.type='sine';
  sub.frequency.setValueAtTime(60,now);
  sg.gain.setValueAtTime(.15,now);sg.gain.exponentialRampToValueAtTime(.001,now+.3);
  sub.start(now);sub.stop(now+.3);
  // 3-tone ascending chord: C5 E5 G5
  [523,659,784].forEach((f,i)=>{
    const o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);o.type='sine';
    const t=now+i*.09;
    o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.07,t+.015);
    g.gain.setValueAtTime(.07,t+.15);g.gain.exponentialRampToValueAtTime(.001,t+.5);
    o.start(t);o.stop(t+.5);
  });
  // High shimmer - breathy top end
  const buf=c.createBuffer(1,c.sampleRate*.4,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*.02*Math.pow(1-t,2)}
  const sh=c.createBufferSource();sh.buffer=buf;
  const hp=c.createBiquadFilter();hp.type='highpass';hp.frequency.value=6000;
  const shg=c.createGain();shg.gain.setValueAtTime(.3,now);shg.gain.exponentialRampToValueAtTime(.001,now+.4);
  sh.connect(hp);hp.connect(shg);shg.connect(c.destination);sh.start(now+.05);
  // Final confirmation ping
  const ping=c.createOscillator(),pg=c.createGain();
  ping.connect(pg);pg.connect(c.destination);ping.type='sine';
  ping.frequency.setValueAtTime(1047,now+.3);
  pg.gain.setValueAtTime(0,now+.3);pg.gain.linearRampToValueAtTime(.06,now+.31);
  pg.gain.exponentialRampToValueAtTime(.001,now+.8);
  ping.start(now+.3);ping.stop(now+.8);
}
function playDenied(){const c=getAudio();[0,.15].forEach(off=>{const t=c.currentTime+off,buf=c.createBuffer(1,c.sampleRate*.1,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++){const s=i/c.sampleRate;d[i]=((Math.sin(s*100*Math.PI*2)>0?1:-1)*.12+(Math.random()*2-1)*.04)*(1-i/d.length)}const src=c.createBufferSource();src.buffer=buf;const lp=c.createBiquadFilter();lp.type='lowpass';lp.frequency.value=400;const g=c.createGain();g.gain.setValueAtTime(.5,t);src.connect(lp);lp.connect(g);g.connect(c.destination);src.start(t)})}
function playPanelOpen(){
  // Soft tactile thud + subtle hi freq air
  const c=getAudio();
  const buf=c.createBuffer(1,c.sampleRate*.04,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*.15*Math.pow(1-t,3)}
  const s=c.createBufferSource();s.buffer=buf;
  const lp=c.createBiquadFilter();lp.type='lowpass';lp.frequency.value=800;
  const g=c.createGain();g.gain.setValueAtTime(.5,c.currentTime);
  s.connect(lp);lp.connect(g);g.connect(c.destination);s.start(c.currentTime);
  // Tiny high click
  const o=c.createOscillator(),g2=c.createGain();
  o.connect(g2);g2.connect(c.destination);o.type='sine';
  o.frequency.setValueAtTime(2400,c.currentTime);
  g2.gain.setValueAtTime(.03,c.currentTime);g2.gain.exponentialRampToValueAtTime(.001,c.currentTime+.03);
  o.start(c.currentTime);o.stop(c.currentTime+.03);
}

// ══════ GRAIN + DUST ══════
const gc=document.getElementById('grainCanvas'),gx=gc.getContext('2d');
const GRAIN_SCALE=4; // render at 1/4 resolution
function rg(){gc.width=Math.ceil(innerWidth/GRAIN_SCALE);gc.height=Math.ceil(innerHeight/GRAIN_SCALE);gc.style.width=innerWidth+'px';gc.style.height=innerHeight+'px';gx.imageSmoothingEnabled=false}
let lastGrain=0;
function dg(t){requestAnimationFrame(dg);if(t-lastGrain<125)return;lastGrain=t;const w=gc.width,h=gc.height,id=gx.createImageData(w,h),d=id.data;for(let i=0;i<d.length;i+=4){const v=Math.random()*255;d[i]=d[i+1]=d[i+2]=v;d[i+3]=8}gx.putImageData(id,0,0)}
rg();let resizeTimer;addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(rg,200)});requestAnimationFrame(dg);
for(let i=0;i<5;i++){const p=document.createElement('div');p.className='dust';p.style.left=Math.random()*100+'vw';p.style.animationDuration=(12+Math.random()*16)+'s';p.style.animationDelay=(Math.random()*12)+'s';const s=1+Math.random()*1.5;p.style.width=s+'px';p.style.height=s+'px';document.body.appendChild(p)}

// ══════ LOGIN SCREEN ══════
let manualVaultKeys=[];
let currentVaultTeam=null;

function submitLogin(){
  const err=document.getElementById('loginErr');
  const idVal=document.getElementById('loginId').value.trim().toUpperCase();
  if(!idVal){err.textContent='Please enter your Team ID or username';return}

  // Check if it's an admin username
  const adminMatch=adminUsers.find(a=>a.user.toUpperCase()===idVal);
  const pwField=document.getElementById('loginPwField');

  if(adminMatch){
    // Admin login — show/check password
    if(pwField.style.display==='none'){
      pwField.style.display='block';
      document.getElementById('loginPw').focus();
      document.getElementById('loginSubmitBtn').textContent='AUTHENTICATE';
      err.textContent='';
      return;
    }
    const pw=document.getElementById('loginPw').value;
    if(pw===adminMatch.pass){
      // Admin authenticated
      err.textContent='';
      isAdmin=true;document.body.classList.add('admin-mode');
      currentVaultTeam={id:'ADMIN',name:'Administrator',type:'admin',members:['Admin'],memberDetails:[]};
      updateConsoleForTeam(currentVaultTeam);
      syncAdminDropdownToggles();
      loginSuccess();
    }else{
      err.textContent='Authentication failed';
      playDenied();
      document.getElementById('flashR').classList.add('on');
      setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
    }
    return;
  }

  // Reset password field if visible
  pwField.style.display='none';
  document.getElementById('loginSubmitBtn').textContent='ENTER';

  // Check against registered teams
  const team=registeredTeams.find(t=>t.id===idVal);
  const manualMatch=manualVaultKeys.find(k=>k.key.toUpperCase()===idVal);

  if(team||manualMatch){
    err.textContent='';
    if(team){
      currentVaultTeam=team;
      team.lastActive=Date.now();
      updateConsoleForTeam(team);
    }else{
      currentVaultTeam={id:idVal,name:manualMatch.label||'Manual Key',type:'team',members:['Admin'],memberDetails:[]};
      updateConsoleForTeam(currentVaultTeam);
    }
    loginSuccess();
  }else{
    err.textContent='Invalid Team ID';
    playDenied();
    document.getElementById('flashR').classList.add('on');
    setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
  }
}
function loginSuccess(){
  playSuccess();
  const dot=document.getElementById('loginDot');
  const lbl=document.getElementById('loginLbl');
  dot.classList.add('ok');lbl.classList.add('ok');lbl.textContent='ACCESS GRANTED';
  document.getElementById('flashG').classList.add('on');
  setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
  setTimeout(()=>openVault(),800);
}
// Enter key support on login fields
document.getElementById('loginId')?.addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin()});
document.getElementById('loginPw')?.addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin()});
// Detect admin username as user types to show password hint
document.getElementById('loginId')?.addEventListener('input',function(){
  const val=this.value.trim().toUpperCase();
  const isAdminUser=adminUsers.some(a=>a.user.toUpperCase()===val);
  const pwField=document.getElementById('loginPwField');
  if(!isAdminUser&&pwField.style.display!=='none'){
    pwField.style.display='none';
    document.getElementById('loginSubmitBtn').textContent='ENTER';
  }
});

function updateConsoleForTeam(team){
  const teamEl=document.querySelector('.console-team');
  if(teamEl){
    const typeIcon=team.type==='individual'?'👤 ':'';
    teamEl.childNodes[0].textContent=typeIcon+team.name.toUpperCase()+' ';
  }
  const cardName=document.querySelector('.team-card-name');
  const cardId=document.querySelector('.team-card-id');
  if(cardName)cardName.textContent=team.name;
  if(cardId)cardId.textContent='ID: '+team.id;
  const membersHtml=team.members.map((m,i)=>`<div class="team-card-member"><div class="team-card-avatar">${i+1}</div><span class="team-card-mname">${m}</span></div>`).join('');
  const memberSection=document.querySelector('.team-card-section');
  if(memberSection){
    const label=memberSection.querySelector('.team-card-label');
    memberSection.innerHTML='';
    if(label)memberSection.appendChild(label);
    memberSection.insertAdjacentHTML('beforeend',membersHtml);
  }
}
function openVault(){const ov=document.getElementById('vaultOpenOverlay');ov.classList.add('active');setTimeout(()=>document.getElementById('voText').classList.add('show'),300);setTimeout(()=>document.getElementById('voSub').classList.add('show'),300);setTimeout(()=>{document.getElementById('voBar').classList.add('show');document.getElementById('voPct').classList.add('show')},300);setTimeout(()=>{document.getElementById('voFill').classList.add('go');let pct=0;const pctEl=document.getElementById('voPct');const pctInt=setInterval(()=>{pct=Math.min(100,pct+Math.ceil(Math.random()*4+1));pctEl.textContent=pct+'%';if(pct>=100)clearInterval(pctInt)},50)},1200);setTimeout(()=>{showScreen('consoleScreen');document.getElementById('notepadTrigger').classList.add('visible');startElapsedTimer();ov.classList.remove('active');document.getElementById('voText').classList.remove('show');document.getElementById('voSub').classList.remove('show');document.getElementById('voBar').classList.remove('show');document.getElementById('voFill').classList.remove('go');document.getElementById('voPct').classList.remove('show');document.getElementById('voPct').textContent='0%'},3800)}

// ══════ VAULT PUZZLE (in-console keypad) ══════
let vaultCodes=[
  {code:'SAMPLE1',label:'Encrypted Dossier',desc:'Unlocks a classified personnel file',unlocked:false,unlockedAt:null},
  {code:'SAMPLE2',label:'Audio Intercept',desc:'Unlocks a recorded phone conversation',unlocked:false,unlockedAt:null},
  {code:'SAMPLE3',label:'Location Data',desc:'Unlocks GPS coordinates of the hideout',unlocked:false,unlockedAt:null}
];
let vkCode='';let vkFailCount=0;let vkRateLimited=false;
const vkDisp=document.getElementById('vDisp');
function vkUpdDisp(){if(vkDisp){vkDisp.textContent=vkCode.length?vkCode:'ENTER CODE';vkDisp.style.color='';vkDisp.style.fontSize='';vkDisp.style.letterSpacing=''}}
function vkType(ch){playClick();if(vkRateLimited)return;if(vkCode.length<20){vkCode+=ch;vkUpdDisp();vkGlitch()}}
function vkDel(){playClick();if(vkRateLimited)return;vkCode=vkCode.slice(0,-1);vkUpdDisp();vkGlitch()}
function vkClear(){playClick();if(vkRateLimited)return;vkCode='';vkUpdDisp();vkGlitch()}
function vkGlitch(){const d=document.querySelector('#expVault .v-display');if(!d)return;d.classList.remove('glitch');void d.offsetWidth;d.classList.add('glitch');setTimeout(()=>d.classList.remove('glitch'),150)}
function vkSubmit(){
  if(vkRateLimited||!vkCode.length)return;
  const entered=vkCode.trim().toUpperCase();
  const match=vaultCodes.find(c=>c.code.toUpperCase()===entered&&!c.unlocked);
  if(match){
    match.unlocked=true;match.unlockedAt=new Date().toISOString();
    playSuccess();
    vkDisp.textContent='✓ '+match.label.toUpperCase();vkDisp.style.color='#00ff88';vkDisp.style.fontSize='13px';vkDisp.style.letterSpacing='2px';
    document.getElementById('flashG').classList.add('on');
    setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
    vkFailCount=0;
    setTimeout(()=>{vkCode='';vkUpdDisp();renderVaultPanel()},2000);
    // Update grid badge
    renderGrid();
  }else if(vaultCodes.find(c=>c.code.toUpperCase()===entered&&c.unlocked)){
    // Already unlocked
    vkDisp.textContent='⚡ ALREADY CRACKED';vkDisp.style.color='var(--amber)';vkDisp.style.fontSize='13px';
    playClick();
    setTimeout(()=>{vkCode='';vkUpdDisp()},1500);
  }else{
    // Invalid code
    vkFailCount++;
    playDenied();vkDisp.textContent='✗ INVALID CODE';vkDisp.style.color='#ff3333';
    document.getElementById('flashR').classList.add('on');setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
    setTimeout(()=>{vkCode='';vkUpdDisp()},1200);
    if(vkFailCount>=3){
      vkRateLimited=true;
      const limiter=document.getElementById('vRateLimit');
      limiter.classList.add('active');
      let countdown=15;document.getElementById('vRateLimitTimer').textContent=countdown;
      const interval=setInterval(()=>{
        countdown--;document.getElementById('vRateLimitTimer').textContent=countdown;
        if(countdown<=0){clearInterval(interval);limiter.classList.remove('active');vkRateLimited=false;vkFailCount=0}
      },1000);
    }
  }
}
function renderVaultPanel(){
  const list=document.getElementById('vaultUnlockList');
  const count=document.getElementById('vaultUnlockCount');
  if(!list)return;
  const unlocked=vaultCodes.filter(c=>c.unlocked).length;
  if(count)count.textContent=unlocked+' / '+vaultCodes.length+' codes cracked';
  // Update dot status
  const dot=document.getElementById('vkDot');
  const lbl=document.getElementById('vkLbl');
  if(dot&&lbl){
    if(unlocked===vaultCodes.length){dot.classList.add('ok');lbl.classList.add('ok');lbl.textContent='ALL CRACKED'}
    else if(unlocked>0){dot.className='v-dot';dot.style.background='radial-gradient(circle at 40% 35%,#ffcc44,#cc8811)';dot.style.boxShadow='0 0 6px rgba(255,170,51,.5)';lbl.textContent=unlocked+' UNLOCKED'}
    else{dot.className='v-dot';dot.style.background='';dot.style.boxShadow='';lbl.textContent='LOCKED'}
  }
  if(vaultCodes.length===0){
    list.innerHTML='<div class="vault-unlock-empty">No vault codes configured yet. The admin can add codes in the Keys & Codes panel.</div>';
    return;
  }
  list.innerHTML=vaultCodes.map((c,i)=>`<div class="vault-unlock-item${c.unlocked?'':' locked'}">
    <span class="vui-icon">${c.unlocked?'🔓':'🔒'}</span>
    <div class="vui-info"><div class="vui-label">${c.unlocked?c.label:'???'}</div><div class="vui-desc">${c.unlocked?c.desc:'Enter the correct code to unlock'}</div></div>
    <span class="vui-status ${c.unlocked?'unlocked':'locked'}">${c.unlocked?'CRACKED':'LOCKED'}</span>
  </div>`).join('');
}
let vkSymMode=false;
function vkToggleSymbols(){
  vkSymMode=!vkSymMode;
  document.getElementById('vkSymLabel').textContent=vkSymMode?'ABC':'SYM';
  const rows=vkSymMode?symRows:alphaRows;
  document.querySelectorAll('#expVault .kb-row').forEach((row,ri)=>{
    if(ri===0)return;
    if(ri>=1&&ri<=3){
      const chars=rows[ri-1];if(!chars)return;
      const keys=row.querySelectorAll('.kb-key:not(.fn)');
      keys.forEach((key,ki)=>{
        if(ki<chars.length){key.style.display='';key.querySelector('span').textContent=chars[ki];key.onclick=()=>vkType(chars[ki])}
        else key.style.display='none';
      });
    }
  });
  playClick();
}

// ══════ FONTS ══════
const availableFonts=[
  // Military / Industrial
  {name:'Russo One',family:"'Russo One',sans-serif"},
  {name:'Black Ops One',family:"'Black Ops One',sans-serif"},
  {name:'Quantico',family:"'Quantico',sans-serif"},
  {name:'Aldrich',family:"'Aldrich',sans-serif"},
  {name:'Staatliches',family:"'Staatliches',cursive"},
  // Sci-Fi / Tech
  {name:'Orbitron',family:"'Orbitron',sans-serif"},
  {name:'Oxanium',family:"'Oxanium',sans-serif"},
  {name:'Audiowide',family:"'Audiowide',sans-serif"},
  {name:'Electrolize',family:"'Electrolize',sans-serif"},
  {name:'Michroma',family:"'Michroma',sans-serif"},
  {name:'Chakra Petch',family:"'Chakra Petch',sans-serif"},
  // Clean / UI
  {name:'Saira',family:"'Saira',sans-serif"},
  {name:'Exo 2',family:"'Exo 2',sans-serif"},
  {name:'Play',family:"'Play',sans-serif"},
  {name:'Rajdhani',family:"'Rajdhani',sans-serif"},
  {name:'Teko',family:"'Teko',sans-serif"},
  // Monospace / Terminal
  {name:'IBM Plex Mono',family:"'IBM Plex Mono',monospace"},
  {name:'JetBrains Mono',family:"'JetBrains Mono',monospace"},
  {name:'Share Tech Mono',family:"'Share Tech Mono',monospace"},
  {name:'Nova Mono',family:"'Nova Mono',monospace"},
  {name:'Major Mono Display',family:"'Major Mono Display',monospace"},
  // Retro / Pixel
  {name:'Press Start 2P',family:"'Press Start 2P',monospace"},
  {name:'VT323',family:"'VT323',monospace"},
  {name:'Silkscreen',family:"'Silkscreen',sans-serif"},
];
function fontSelect(id,current){
  const groups=[
    {label:'— Military / Industrial —',fonts:['Russo One','Black Ops One','Quantico','Aldrich','Staatliches']},
    {label:'— Sci-Fi / Tech —',fonts:['Orbitron','Oxanium','Audiowide','Electrolize','Michroma','Chakra Petch']},
    {label:'— Clean / UI —',fonts:['Saira','Exo 2','Play','Rajdhani','Teko']},
    {label:'— Monospace / Terminal —',fonts:['IBM Plex Mono','JetBrains Mono','Share Tech Mono','Nova Mono','Major Mono Display']},
    {label:'— Retro / Pixel —',fonts:['Press Start 2P','VT323','Silkscreen']},
  ];
  let html=`<select id="${id}" style="font-size:11px"><option value=""${!current?' selected':''}>Default</option>`;
  groups.forEach(g=>{
    html+=`<optgroup label="${g.label}">`;
    g.fonts.forEach(fn=>{
      const f=availableFonts.find(x=>x.name===fn);
      if(f)html+=`<option value="${f.name}"${f.name===current?' selected':''} style="font-family:${f.family}">${f.name}</option>`;
    });
    html+=`</optgroup>`;
  });
  html+=`</select>`;
  return html;
}
function getFontFamily(name){const f=availableFonts.find(x=>x.name===name);return f?f.family:''}
function fontStyle(name){return name?`font-family:${getFontFamily(name)}`:''}

// ══════ DATA ══════
let operationName='Operation Dead Drop';
let operationFont='Staatliches';
let vaultSubtitle='Enter Your Team ID';
let vaultSubFont='';
let gridTiles=[
  {id:'feed',icon:'📡',label:'Intelligence Feed',labelFont:'',sub:'Surveillance imagery & intercepted visuals',subFont:'',badgeId:'feedBadge',dotClass:'live',status:'LIVE'},
  {id:'media',icon:'🔊',label:'Media Lab',labelFont:'',sub:'Audio, maps, documents & video',subFont:'',badgeId:'mediaBadge',dotClass:'live',status:'LIVE'},
  {id:'vault',icon:'🔐',label:'The Vault',labelFont:'',sub:'Enter solved codes to unlock items',subFont:'',badgeId:'vaultBadge',dotClass:'pending',status:'LOCKED'},
  {id:'intel',icon:'🎯',label:'Intel Submissions',labelFont:'',sub:'Submit decoded intelligence',subFont:'',badgeId:'intelBadge',dotClass:'pending',status:'AWAITING INPUT'}
];
let intelFields=[
  {label:'Seller Codename',emoji:'🕵️',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Buyer Identity',emoji:'👤',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Staging Country',emoji:'🌍',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Comms Platform',emoji:'📱',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Smuggled Items',emoji:'📦',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Hideout Location',emoji:'📍',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Payment Amount',emoji:'💰',type:'money',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Burner Phone #',emoji:'📞',type:'phone',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Target Islands',emoji:'🏝️',type:'dual',font:'',answer:{expected:['',''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}}
];
const intelLabels=['Seller Codename','Buyer Identity','Staging Country','Comms Platform','Smuggled Items','Hideout Location','Payment Amount','Burner Phone #','Target Island 1','Target Island 2'];
let allowDownloads=false;
let feedMuted=true;
let regSettings={
  teamSizeMin:2,
  teamSizeMax:4,
  maxTeams:20,
  requireEmail:true,
  requirePhone:false,
  requireDept:false,
  registrationOpen:true,
  participantMode:'team',
  leaderboardStyle:'mixed',
  landingBannerUrl:'',
  landingTitle:'Code Breakers',
  landingSubtitle:'Team Challenge Experience'
};
let currentRegType='team'; // for hybrid mode tracking
let posts=[
  {emoji:'🦁',bg:'#1a2a1a',cap:'The symbol of the empire. Power recognized worldwide. This beast answers to one flag.',mediaUrl:'',mediaType:'image'},
  {emoji:'🦅',bg:'#2a2018',cap:"Wings spread wide. Freedom's guardian watches from above. One nation under its shadow.",mediaUrl:'',mediaType:'image'},
  {emoji:'🏍️',bg:'#2a1a1a',cap:'Fresh off the lot. The Sizzle Mot 1. Receipt says paid in full.',mediaUrl:'',mediaType:'image'},
  {emoji:'💼',bg:'#1a1a2a',cap:"48.7 lbs exactly. Not an ounce more, not an ounce less.",mediaUrl:'',mediaType:'image'},
  {emoji:'📱',bg:'#2a2a1a',cap:"New billboard on 5th. That mascot is everywhere these days.",mediaUrl:'',mediaType:'image'},
  {emoji:'🐅',bg:'#1a2a2a',cap:'Stripes earned, not given. National pride runs deep.',mediaUrl:'',mediaType:'image'},
  {emoji:'🧪',bg:'#201a20',cap:'SiLiCoN Valley — where dreams are engineered.',mediaUrl:'',mediaType:'image'},
  {emoji:'🏝️',bg:'#2a1a2a',cap:"Paradise from above. So many islands, so little time.",mediaUrl:'',mediaType:'image'},
  {emoji:'🐻',bg:'#1a2020',cap:"The bear endures. Through every winter, still standing.",mediaUrl:'',mediaType:'image'},
  {emoji:'🎰',bg:'#1e1e1e',cap:"The car wash on 9th. Business is booming. Suspiciously so.",mediaUrl:'',mediaType:'image'},
  {emoji:'👔',bg:'#1a1a1a',cap:'"Have no FeAr" — printed right there on his shirt.',mediaUrl:'',mediaType:'image'},
  {emoji:'🐘',bg:'#202520',cap:'Gentle giant. Sacred. Unmistakable.',mediaUrl:'',mediaType:'image'},
];
let mediaItems=[
  {icon:'🎵',name:'INTCPT_AUDIO_001.wav',desc:'Intercepted transmission — background anomalies',type:'audio',fileUrl:''},
  {icon:'🎵',name:'CLUB_TRACK_FRAGMENT.mp3',desc:'Recovered audio — directional lyrics',type:'audio',fileUrl:''},
  {icon:'🗺️',name:'REGION_MAP_CARIBBEAN.pdf',desc:'Island cluster map with coordinate grid',type:'map',fileUrl:''},
  {icon:'🗺️',name:'HIGHWAY_NETWORK_MAP.pdf',desc:'Regional highway system',type:'map',fileUrl:''},
  {icon:'📄',name:'CARWASH_LEDGER_30D.xlsx',desc:'30-day transaction records',type:'doc',fileUrl:''},
  {icon:'📄',name:'HARDWARE_INVENTORY.pdf',desc:'Component list with weights',type:'doc',fileUrl:''},
  {icon:'📄',name:'POLICE_REPORT_0847.pdf',desc:'Highway pursuit timeline',type:'doc',fileUrl:''},
  {icon:'🎬',name:'SURVEIL_CLIP_07.mp4',desc:'Surveillance footage — billboard visible',type:'video',fileUrl:''},
  {icon:'🔒',name:'LOCKED_ARCHIVE.enc',desc:'Encrypted — requires box key',type:'locked',fileUrl:''},
];

// ══════ RENDER ══════

function renderFeed(){
  const grid=document.getElementById('feedGridView'),isA=document.body.classList.contains('edit-mode');
  grid.innerHTML=posts.map((p,i)=>{
    const isVid=p.mediaType==='video'&&p.mediaUrl;
    const isImg=p.mediaType!=='video'&&p.mediaUrl;
    let media='';
    if(isImg){
      media=`<div class="no-download-shield" oncontextmenu="return false"></div><img src="${p.mediaUrl}" style="width:100%;height:100%;object-fit:cover;pointer-events:none;-webkit-user-drag:none" draggable="false">`;
    } else if(isVid){
      media=`<video class="feed-card-video" src="${p.mediaUrl}" muted loop playsinline preload="auto"></video><div class="feed-video-badge">▶ VIDEO</div>`;
    } else {
      media=`<span style="opacity:.5">${p.emoji}</span>`;
    }
    const bgStyle=!p.mediaUrl?`background:${p.bg};`:'';
    return `<div class="feed-card" onclick="openPost(${i})">${isA?`<div class="admin-edit-btn" onclick="event.stopPropagation();editFeedPost(${i})">✎</div>`:''}<div class="feed-card-img" style="${bgStyle}" oncontextmenu="return false">${media}</div><div class="feed-card-cap"><p style="${fontStyle(p.capFont||'')}">${p.cap}</p></div></div>`;
  }).join('')+(isA?'<div class="admin-add-btn" onclick="addFeedPost()">+ Add Post</div>':'');
  document.getElementById('feedBadge').textContent=posts.length+' FILES';
  // Force-play all grid videos after DOM insertion
  setTimeout(()=>{grid.querySelectorAll('video.feed-card-video').forEach(v=>{v.muted=true;v.play().catch(()=>{})})},50);
}
function renderMedia(){
  const list=document.getElementById('mediaList'),isA=document.body.classList.contains('edit-mode');
  list.innerHTML=mediaItems.map((m,i)=>`<div class="media-exp-item" style="${m.type==='locked'&&!m.unlocked?'opacity:.4;':''}" onclick="openMediaViewer(${i})">${isA?`<div class="admin-edit-btn" onclick="event.stopPropagation();editMediaItem(${i})" style="position:absolute;top:8px;right:8px">✎</div>`:''}<span class="media-exp-icon">${m.icon}</span><div class="media-exp-info"><span class="media-exp-name" style="${fontStyle(m.nameFont||'')}">${m.name}</span><span class="media-exp-desc" style="${fontStyle(m.descFont||'')}">${m.desc}</span></div><span class="media-exp-badge ${m.type}">${m.type}${m.type==='locked'&&m.unlocked?' ✓':''}</span></div>`).join('')+(isA?'<div class="admin-add-btn" onclick="addMediaItem()">+ Add Media</div>':'');
  const badge=document.getElementById('mediaBadge');if(badge)badge.textContent=mediaItems.length+' FILES';
}

// ══════ PANELS ══════
const overlay=document.getElementById('panelOverlay');
let currentFeedView='grid';
function openPanel(t){playTileClick();['adminPanel','broadcastPanel','leaderboardModule','keysCodesPanel','teamMonitorPanel'].forEach(id=>{const el=document.getElementById(id);if(el){el.classList.remove('active');el.style.cssText=''}});document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));document.getElementById({feed:'expFeed',media:'expMedia',intel:'expIntel',vault:'expVault'}[t]).classList.add('visible');_instantShow(overlay);
  if(t==='feed'){renderFeed();setFeedView('grid')}if(t==='media')renderMedia();if(t==='intel')renderIntelForm();if(t==='vault')renderVaultPanel()}
function closePanel(){overlay.style.cssText='';overlay.classList.remove('active');setTimeout(()=>document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible')),300)}

// Feed view modes
function setFeedView(mode){
  currentFeedView=mode;
  document.querySelectorAll('.feed-view-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById({grid:'fvGrid',single:'fvSingle'}[mode])?.classList.add('active');
  const gridEl=document.getElementById('feedGridView');
  const singleEl=document.getElementById('feedSingleView');
  const toggleEl=document.getElementById('feedViewToggle');
  if(mode==='grid'){
    gridEl.style.display='';
    singleEl.classList.remove('visible');toggleEl.style.display='';
  } else {
    gridEl.style.display='none';singleEl.classList.add('visible');
    toggleEl.style.display='';renderSinglePost();
  }
}

let currentPost=0;
function openPost(i){currentPost=i;setFeedView('single')}
function renderSinglePost(){
  const p=posts[currentPost],img=document.getElementById('singleImg');
  const isVid=p.mediaType==='video'&&p.mediaUrl;
  const editBtn=document.body.classList.contains('edit-mode')?`<div class="feed-single-edit" onclick="event.stopPropagation();editFeedPost(${currentPost})" title="Edit this post">✎</div>`:'';

  if(isVid){
    img.style.background='#000';img.style.backgroundSize='';img.textContent='';
    img.innerHTML=`<video class="feed-single-video" id="feedSingleVid" src="${p.mediaUrl}" loop playsinline preload="auto" ${feedMuted?'muted':''} controls></video><div class="feed-mute-btn" onclick="event.stopPropagation();toggleFeedMute()">${feedMuted?'🔇':'🔊'}</div>${editBtn}`;
    setTimeout(()=>{const v=document.getElementById('feedSingleVid');if(v){v.muted=feedMuted;v.play().catch(()=>{})}},50);
  } else if(p.mediaUrl){
    img.style.background='';img.style.backgroundSize='';
    img.innerHTML=`<div class="no-download-shield" oncontextmenu="return false"></div><img src="${p.mediaUrl}" style="width:100%;height:100%;object-fit:contain;pointer-events:none;-webkit-user-drag:none" draggable="false">${editBtn}`;
  } else {
    img.style.background=p.bg;img.style.backgroundSize='';img.textContent=p.emoji;img.innerHTML=p.emoji+editBtn;
  }
  const capEl=document.getElementById('singleCap');
  capEl.textContent=p.cap;
  capEl.style.fontFamily=p.capFont?getFontFamily(p.capFont):'';
  document.getElementById('singleCounter').textContent=(currentPost+1)+' / '+posts.length;
}
function toggleFeedMute(){
  feedMuted=!feedMuted;
  const vid=document.getElementById('feedSingleVid');
  if(vid)vid.muted=feedMuted;
  const btn=document.querySelector('.feed-mute-btn');
  if(btn)btn.textContent=feedMuted?'🔇':'🔊';
}
function navPost(d){currentPost=(currentPost+d+posts.length)%posts.length;resetFeedZoom();renderSinglePost()}

// ══════ FEED ZOOM ══════
function toggleFeedZoom(){
  const container=document.getElementById('singleImg');
  if(!container)return;
  const isZoomed=container.classList.contains('zoomed');
  if(isZoomed){
    resetFeedZoom();
  }else{
    container.classList.add('zoomed');
    // Center scroll
    const img=container.querySelector('img');
    if(img){
      setTimeout(()=>{
        container.scrollLeft=(container.scrollWidth-container.clientWidth)/2;
        container.scrollTop=(container.scrollHeight-container.clientHeight)/2;
      },50);
    }
  }
}
function resetFeedZoom(){
  const container=document.getElementById('singleImg');
  if(container)container.classList.remove('zoomed');
}
// Click-to-zoom on focus image
document.getElementById('singleImg')?.addEventListener('click',function(e){
  // Don't zoom on video, mute btn, or shield clicks
  if(e.target.closest('.feed-mute-btn')||e.target.closest('.no-download-shield')||e.target.tagName==='VIDEO')return;
  toggleFeedZoom();
});
// Drag to pan when zoomed
(function(){
  const container=document.getElementById('singleImg');
  if(!container)return;
  let dragging=false,startX,startY,scrollL,scrollT;
  container.addEventListener('mousedown',function(e){
    if(!container.classList.contains('zoomed'))return;
    dragging=true;startX=e.pageX;startY=e.pageY;
    scrollL=container.scrollLeft;scrollT=container.scrollTop;
    const img=container.querySelector('img');
    if(img)img.classList.add('dragging');
    e.preventDefault();
  });
  window.addEventListener('mousemove',function(e){
    if(!dragging)return;
    container.scrollLeft=scrollL-(e.pageX-startX);
    container.scrollTop=scrollT-(e.pageY-startY);
  });
  window.addEventListener('mouseup',function(){
    if(!dragging)return;dragging=false;
    const img=container.querySelector('img');
    if(img)img.classList.remove('dragging');
  });
})();

// ══════ SWIPE ══════
(function(){
  const img=document.getElementById('singleImg');
  let sx=0,sy=0,dx=0,swiping=false;
  img.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;dx=0;swiping=true},{passive:true});
  img.addEventListener('touchmove',e=>{
    if(!swiping)return;
    dx=e.touches[0].clientX-sx;
    const dy=Math.abs(e.touches[0].clientY-sy);
    if(dy>Math.abs(dx)){swiping=false;return}
    img.style.transform=`translateX(${dx*.4}px)`;
    img.style.opacity=1-Math.abs(dx)/600;
  },{passive:true});
  img.addEventListener('touchend',()=>{
    if(!swiping){img.style.transform='';img.style.opacity='';return}
    swiping=false;
    if(Math.abs(dx)>50){
      const dir=dx>0?-1:1;
      img.style.transition='transform .2s,opacity .2s';
      img.style.transform=`translateX(${dx>0?'100px':'-100px'})`;img.style.opacity='0';
      setTimeout(()=>{
        navPost(dir);
        img.style.transition='none';img.style.transform=`translateX(${dir>0?'60px':'-60px'})`;img.style.opacity='0';
        requestAnimationFrame(()=>{
          img.style.transition='transform .25s ease-out,opacity .25s ease-out';
          img.style.transform='translateX(0)';img.style.opacity='1';
        });
      },200);
    } else {
      img.style.transition='transform .2s,opacity .2s';
      img.style.transform='';img.style.opacity='';
    }
    setTimeout(()=>{img.style.transition=''},450);
  });
  // Mouse drag for desktop
  let mx=0,mdx=0,mdrag=false;
  img.addEventListener('mousedown',e=>{mx=e.clientX;mdx=0;mdrag=true;e.preventDefault()});
  window.addEventListener('mousemove',e=>{
    if(!mdrag)return;mdx=e.clientX-mx;
    img.style.transform=`translateX(${mdx*.4}px)`;
    img.style.opacity=1-Math.abs(mdx)/600;
  });
  window.addEventListener('mouseup',()=>{
    if(!mdrag)return;mdrag=false;
    if(Math.abs(mdx)>50){
      const dir=mdx>0?-1:1;
      img.style.transition='transform .2s,opacity .2s';
      img.style.transform=`translateX(${mdx>0?'100px':'-100px'})`;img.style.opacity='0';
      setTimeout(()=>{
        navPost(dir);
        img.style.transition='none';img.style.transform=`translateX(${dir>0?'60px':'-60px'})`;img.style.opacity='0';
        requestAnimationFrame(()=>{
          img.style.transition='transform .25s ease-out,opacity .25s ease-out';
          img.style.transform='translateX(0)';img.style.opacity='1';
        });
      },200);
    } else {
      img.style.transition='transform .2s,opacity .2s';
      img.style.transform='';img.style.opacity='';
    }
    setTimeout(()=>{img.style.transition=''},450);
  });
})();

// ══════ OVERSCROLL RUBBER BAND ══════
(function(){
  document.querySelectorAll('.exp-body, #consoleScreen').forEach(el=>{
    let startY=0,pulling=false;
    el.addEventListener('touchstart',e=>{startY=e.touches[0].clientY},{passive:true});
    el.addEventListener('touchmove',e=>{
      const dy=e.touches[0].clientY-startY;
      const atTop=el.scrollTop<=0;
      const atBottom=el.scrollTop+el.clientHeight>=el.scrollHeight-1;
      if((atTop&&dy>0)||(atBottom&&dy<0)){
        const pull=Math.min(Math.abs(dy)*.3,60);
        const dir=dy>0?1:-1;
        el.style.transform=`translateY(${pull*dir}px)`;
        el.style.transition='none';
        pulling=true;
      }
    },{passive:true});
    el.addEventListener('touchend',()=>{
      if(pulling){
        el.style.transition='transform .4s cubic-bezier(.25,.46,.45,.94)';
        el.style.transform='translateY(0)';
        pulling=false;
      }
    });
  });
})();

// ══════ INTEL ══════
let isSubmitted=false;
let submissionResults=null; // Stores grading results after submit

function formatPhone(el){
  let v=el.value.replace(/\D/g,'').slice(0,10);
  if(v.length>6)v='('+v.slice(0,3)+') '+v.slice(3,6)+'-'+v.slice(6);
  else if(v.length>3)v='('+v.slice(0,3)+') '+v.slice(3);
  else if(v.length>0)v='('+v;
  el.value=v;
}

// ── Levenshtein Distance (fuzzy matching) ──
function levenshtein(a,b){
  const m=a.length,n=b.length;
  const d=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++)d[i][0]=i;
  for(let j=0;j<=n;j++)d[0][j]=j;
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){
    const cost=a[i-1]===b[j-1]?0:1;
    d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+cost);
  }
  return d[m][n];
}
function similarity(a,b){
  if(!a&&!b)return 1;if(!a||!b)return 0;
  const maxLen=Math.max(a.length,b.length);
  if(maxLen===0)return 1;
  return((maxLen-levenshtein(a,b))/maxLen)*100;
}

// ── Answer Checking ──
function normalizeAnswer(str,caseSensitive){
  let s=str.trim();
  // Strip common noise: extra spaces, trailing periods
  s=s.replace(/\s+/g,' ').replace(/\.$/,'');
  if(!caseSensitive)s=s.toLowerCase();
  return s;
}

function checkSingleAnswer(submitted,answerConfig){
  if(!submitted.trim())return{correct:false,score:0,match:'empty'};
  const cfg=answerConfig||{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85};
  const cs=cfg.caseSensitive;
  const sub=normalizeAnswer(submitted,cs);

  // Build list of all acceptable answers
  const acceptables=[...cfg.expected.filter(e=>e.trim()),...(cfg.alts||[]).filter(a=>a.trim())];
  if(!acceptables.length)return{correct:false,score:0,match:'no-answer-key'};

  for(const ans of acceptables){
    const norm=normalizeAnswer(ans,cs);
    // Exact match
    if(sub===norm)return{correct:true,score:cfg.points||10,match:'exact'};
  }

  // Contains match
  if(cfg.matchMode==='contains'){
    for(const ans of acceptables){
      const norm=normalizeAnswer(ans,cs);
      if(sub.includes(norm)||norm.includes(sub))return{correct:true,score:cfg.points||10,match:'contains'};
    }
  }

  // Fuzzy match — only when explicitly set to fuzzy mode
  if(cfg.matchMode==='fuzzy'){
    for(const ans of acceptables){
      const norm=normalizeAnswer(ans,cs);
      const sim=similarity(sub,norm);
      if(sim>=cfg.fuzzyThreshold)return{correct:true,score:cfg.points||10,match:'fuzzy',similarity:Math.round(sim)};
    }
  }

  // Find closest match for feedback
  let bestSim=0;
  for(const ans of acceptables){
    const norm=normalizeAnswer(ans,cs);
    const sim=similarity(sub,norm);
    if(sim>bestSim)bestSim=sim;
  }
  return{correct:false,score:0,match:'wrong',closestSimilarity:Math.round(bestSim)};
}

function gradeAllSubmissions(){
  const results=[];
  let totalScore=0,totalPossible=0,correctCount=0;

  intelFields.forEach((f,i)=>{
    const pts=f.answer?.points||10;
    totalPossible+=pts;

    if(f.type==='dual'){
      // Dual fields: check both values
      const inp1=document.querySelector(`.intel-exp-input[data-idx="${i}"]`);
      const inp2=document.querySelector(`.intel-exp-input[data-idx="${i}b"]`);
      const v1=inp1?inp1.value:'';
      const v2=inp2?inp2.value:'';
      const exp=f.answer?.expected||['',''];

      // Try both orderings (teams might swap the two values)
      const r1a=checkSingleAnswer(v1,{...f.answer,expected:[exp[0]||'']});
      const r1b=checkSingleAnswer(v2,{...f.answer,expected:[exp[1]||'']});
      const r2a=checkSingleAnswer(v1,{...f.answer,expected:[exp[1]||'']});
      const r2b=checkSingleAnswer(v2,{...f.answer,expected:[exp[0]||'']});

      const score1=(r1a.correct?1:0)+(r1b.correct?1:0);
      const score2=(r2a.correct?1:0)+(r2b.correct?1:0);

      if(score1>=score2){
        const bothCorrect=r1a.correct&&r1b.correct;
        results.push({field:f.label,type:'dual',correct:bothCorrect,partialCorrect:score1===1,submitted:[v1,v2],results:[r1a,r1b],score:bothCorrect?pts:(score1===1?Math.round(pts/2):0)});
        if(bothCorrect)correctCount++;
        totalScore+=bothCorrect?pts:(score1===1?Math.round(pts/2):0);
      }else{
        const bothCorrect=r2a.correct&&r2b.correct;
        results.push({field:f.label,type:'dual',correct:bothCorrect,partialCorrect:score2===1,submitted:[v1,v2],results:[r2a,r2b],score:bothCorrect?pts:(score2===1?Math.round(pts/2):0)});
        if(bothCorrect)correctCount++;
        totalScore+=bothCorrect?pts:(score2===1?Math.round(pts/2):0);
      }
    }else{
      const inp=document.querySelector(`.intel-exp-input[data-idx="${i}"]`);
      const v=inp?inp.value:'';
      const r=checkSingleAnswer(v,f.answer);
      results.push({field:f.label,type:'single',correct:r.correct,submitted:v,result:r,score:r.score});
      if(r.correct)correctCount++;
      totalScore+=r.score;
    }
  });

  return{results,totalScore,totalPossible,correctCount,totalFields:intelFields.length,percentage:totalPossible?Math.round((totalScore/totalPossible)*100):0};
}
function updateIntelBadge(){const filled=document.querySelectorAll('.intel-exp-input');let n=0;filled.forEach(inp=>{if(inp.value.trim())n++});const badge=document.getElementById('intelBadge');if(badge)badge.textContent=n+' / '+filled.length+' MARKED'}
document.addEventListener('input',e=>{if(e.target.classList.contains('intel-exp-input'))updateIntelBadge()});
function showConfirm(){if(isSubmitted)return;playConfirmPrompt();const inputs=document.querySelectorAll('.intel-exp-input'),body=document.getElementById('confirmBody');body.innerHTML='';
  syncIntelLabels();let li=0;
  inputs.forEach((inp)=>{let v=inp.value.trim();const idx=inp.dataset.idx;
    // Find matching field for money prefix
    const fi=parseInt(idx);if(!isNaN(fi)&&intelFields[fi]&&intelFields[fi].type==='money'&&v)v='$'+v;
    const label=intelLabels[li]||'Field '+(li+1);li++;
    body.innerHTML+=`<div class="confirm-row"><span class="confirm-label">${label}</span><span class="confirm-value ${v?'':'empty'}">${v||'— empty —'}</span></div>`});
  document.getElementById('confirmModal').classList.add('active')}
function hideConfirm(){document.getElementById('confirmModal').classList.remove('active')}
function finalSubmit(){
  isSubmitted=true;
  // Grade all answers silently — results stored for admin/leaderboard only
  submissionResults=gradeAllSubmissions();
  submissionResults.submittedAt=new Date().toISOString();
  console.log('Submission graded:',submissionResults); // For debugging, remove in prod

  document.getElementById('confirmModal').classList.remove('active');
  document.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=true});
  // Show neutral checkmarks — NO indication of right/wrong
  document.querySelectorAll('.intel-exp-check').forEach(chk=>{chk.classList.add('submitted');chk.textContent='✓'});
  document.getElementById('intelSubmitBtn').disabled=true;
  document.getElementById('intelSubmitBtn').textContent='◈ TRANSMITTED ◈';
  document.getElementById('intelBadge').textContent='SUBMITTED';
  document.getElementById('intelBadge').classList.remove('amber');
  playSuccess();
  document.getElementById('flashG').classList.add('on');
  setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
  // TODO: Post results to Google Sheets backend
}

// ══════ MEDIA VIEWER ══════
let currentMediaIdx=0;
let mvAudio=null;
let mvAudioInterval=null;

function openMediaViewer(i){
  const m=mediaItems[i];
  if(m.type==='locked'&&!m.unlocked){renderLockedView(i);showViewer(i);return}
  currentMediaIdx=i;
  showViewer(i);
  renderMediaContent(m);
}

function showViewer(i){
  currentMediaIdx=i;
  const m=mediaItems[i];
  document.getElementById('mvIcon').textContent=m.icon;
  document.getElementById('mvName').textContent=m.name;
  document.getElementById('mvDesc').textContent=m.desc;
  const badge=document.getElementById('mvBadge');
  badge.textContent=m.type;badge.className='mv-badge '+m.type;
  document.getElementById('mvCounter').textContent=(i+1)+' / '+mediaItems.length;
  // Download button: only show if admin enabled downloads and file exists
  const dlBtn=document.getElementById('mvDownload');
  dlBtn.style.display=(allowDownloads&&m.fileUrl)?'':'none';
  document.getElementById('mediaViewer').classList.add('active');
}

function downloadCurrentMedia(){
  const m=mediaItems[currentMediaIdx];
  if(!m.fileUrl||!allowDownloads)return;
  const eu=convertDriveUrl(m.fileUrl);
  const a=document.createElement('a');
  a.href=eu.direct;a.download=m.name;a.target='_blank';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function closeMediaViewer(){
  document.getElementById('mediaViewer').classList.remove('active');
  stopMvAudio();
  // Stop any video
  const vid=document.querySelector('.mv-video');
  if(vid)vid.pause();
}

function navMedia(d){
  stopMvAudio();
  const vid=document.querySelector('.mv-video');if(vid)vid.pause();
  currentMediaIdx=(currentMediaIdx+d+mediaItems.length)%mediaItems.length;
  const m=mediaItems[currentMediaIdx];
  showViewer(currentMediaIdx);
  if(m.type==='locked'&&!m.unlocked)renderLockedView(currentMediaIdx);
  else renderMediaContent(m);
}

function renderMediaContent(m){
  const body=document.getElementById('mvBody');
  const url=m.fileUrl||'';

  if(!url){
    body.innerHTML=`<div class="mv-no-file"><div class="mv-no-file-icon">${m.icon}</div><div class="mv-no-file-text">No file attached — add a URL via admin edit</div></div>`;
    return;
  }

  // Google Drive URL conversion for embedding
  const embedUrl=convertDriveUrl(url);

  switch(m.type){
    case 'audio':
      renderAudioPlayer(body,m,url);break;
    case 'video':
      renderVideoPlayer(body,m,embedUrl);break;
    case 'doc':
    case 'map':
      renderDocViewer(body,m,url,embedUrl);break;
    case 'locked':
      if(m.unlocked)renderDocViewer(body,m,url,embedUrl);
      else renderLockedView(currentMediaIdx);break;
    default:
      renderDocViewer(body,m,url,embedUrl);
  }
}

// Resolve file URL — all media hosted on Netlify, pass through directly
function convertDriveUrl(url){
  // Simple pass-through — no external service conversion needed
  return{preview:url,direct:url,id:null};
}

function isImageUrl(url){return/\.(jpg|jpeg|png|gif|webp|svg|bmp)(\?|$)/i.test(url)}
function isPdfUrl(url){return/\.pdf(\?|$)/i.test(url)||url.includes('/preview')}

// ── Audio Player ──
function renderAudioPlayer(body,m,url){
  body.innerHTML=`
    <div class="mv-audio-player">
      <div class="mv-audio-icon">🎧</div>
      <div class="mv-audio-title">${m.name}</div>
      <div class="mv-audio-controls">
        <div class="mv-audio-bar-wrap" id="mvAudioBarWrap" onclick="seekAudio(event)">
          <div class="mv-audio-bar" id="mvAudioBar"></div>
        </div>
        <div class="mv-audio-time"><span id="mvAudioCur">0:00</span><span id="mvAudioDur">0:00</span></div>
        <div class="mv-audio-btns">
          <div class="mv-audio-btn" onclick="skipAudio(-10)" title="Back 10s">⏪</div>
          <div class="mv-audio-btn" id="mvPlayBtn" onclick="toggleMvAudio()" title="Play/Pause">▶</div>
          <div class="mv-audio-btn" onclick="skipAudio(10)" title="Forward 10s">⏩</div>
        </div>
        <div class="mv-audio-vol">
          <span class="mv-audio-vol-icon" onclick="toggleMvMute()">🔊</span>
          <div class="mv-audio-vol-bar" onclick="setMvVolume(event)"><div class="mv-audio-vol-fill" id="mvVolFill"></div></div>
        </div>
      </div>
    </div>`;
  mvAudio=new Audio(url);
  mvAudio.addEventListener('loadedmetadata',()=>{document.getElementById('mvAudioDur').textContent=fmtTime(mvAudio.duration)});
  mvAudio.addEventListener('ended',()=>{
    document.getElementById('mvPlayBtn').textContent='▶';
    document.getElementById('mvPlayBtn').classList.remove('playing');
    clearInterval(mvAudioInterval);
  });
}

function toggleMvAudio(){
  if(!mvAudio)return;
  const btn=document.getElementById('mvPlayBtn');
  if(mvAudio.paused){
    mvAudio.play();btn.textContent='⏸';btn.classList.add('playing');
    mvAudioInterval=setInterval(updateAudioProgress,100);
  }else{
    mvAudio.pause();btn.textContent='▶';btn.classList.remove('playing');
    clearInterval(mvAudioInterval);
  }
}

function updateAudioProgress(){
  if(!mvAudio)return;
  const pct=(mvAudio.currentTime/mvAudio.duration)*100;
  const bar=document.getElementById('mvAudioBar');if(bar)bar.style.width=pct+'%';
  const cur=document.getElementById('mvAudioCur');if(cur)cur.textContent=fmtTime(mvAudio.currentTime);
}

function seekAudio(e){
  if(!mvAudio||!mvAudio.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  mvAudio.currentTime=pct*mvAudio.duration;
  updateAudioProgress();
}

function skipAudio(s){if(mvAudio)mvAudio.currentTime=Math.max(0,Math.min(mvAudio.duration,mvAudio.currentTime+s));updateAudioProgress()}

function setMvVolume(e){
  if(!mvAudio)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  mvAudio.volume=pct;
  document.getElementById('mvVolFill').style.width=(pct*100)+'%';
}

function toggleMvMute(){
  if(!mvAudio)return;
  mvAudio.muted=!mvAudio.muted;
  document.querySelector('.mv-audio-vol-icon').textContent=mvAudio.muted?'🔇':'🔊';
}

function stopMvAudio(){
  if(mvAudio){mvAudio.pause();mvAudio.currentTime=0;mvAudio=null}
  if(mvAudioInterval){clearInterval(mvAudioInterval);mvAudioInterval=null}
}

function fmtTime(s){if(!s||isNaN(s))return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+String(sec).padStart(2,'0')}

// ── Video Player ──
function renderVideoPlayer(body,m,eu){
  const src=eu.direct||eu.preview;
  body.innerHTML=`
    <div class="mv-video-wrap">
      <video class="mv-video" id="mvVideo" src="${src}" preload="metadata"></video>
      <div class="mv-video-controls">
        <div class="mv-video-play" id="mvVidPlay" onclick="toggleMvVideo()">▶</div>
        <div class="mv-video-bar" onclick="seekVideo(event)"><div class="mv-video-progress" id="mvVidProgress"></div></div>
        <span class="mv-video-time" id="mvVidTime">0:00</span>
        <span class="mv-video-full" onclick="fullscreenVideo()" title="Fullscreen">⛶</span>
      </div>
    </div>`;
  const vid=document.getElementById('mvVideo');
  vid.addEventListener('timeupdate',()=>{
    const pct=(vid.currentTime/vid.duration)*100;
    document.getElementById('mvVidProgress').style.width=pct+'%';
    document.getElementById('mvVidTime').textContent=fmtTime(vid.currentTime)+' / '+fmtTime(vid.duration);
  });
  vid.addEventListener('ended',()=>{document.getElementById('mvVidPlay').textContent='▶'});
  vid.addEventListener('click',toggleMvVideo);
}

function toggleMvVideo(){
  const vid=document.getElementById('mvVideo');if(!vid)return;
  const btn=document.getElementById('mvVidPlay');
  if(vid.paused){vid.play();btn.textContent='⏸'}else{vid.pause();btn.textContent='▶'}
}

function seekVideo(e){
  const vid=document.getElementById('mvVideo');if(!vid||!vid.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  vid.currentTime=(e.clientX-rect.left)/rect.width*vid.duration;
}

function fullscreenVideo(){
  const vid=document.getElementById('mvVideo');if(!vid)return;
  if(vid.requestFullscreen)vid.requestFullscreen();
  else if(vid.webkitRequestFullscreen)vid.webkitRequestFullscreen();
}

// ── Document / Map / PDF Viewer ──
function isOfficeDoc(url){return/\.(docx?|xlsx?|pptx?|csv)(\?|$)/i.test(url)}
function renderDocViewer(body,m,url,eu){
  // Images
  if(isImageUrl(url)||m.type==='map'&&isImageUrl(url)){
    body.innerHTML=`<img class="mv-image-viewer" src="${eu.direct}" alt="${m.name}" onclick="this.classList.toggle('zoomed')">`;
    return;
  }
  // Office docs — use Microsoft Office Online viewer
  if(isOfficeDoc(url)){
    const officeUrl='https://view.officeapps.live.com/op/embed.aspx?src='+encodeURIComponent(url);
    body.innerHTML=`<iframe class="mv-pdf-frame" src="${officeUrl}" allowfullscreen></iframe>`;
    return;
  }
  // PDFs and everything else — use iframe embed
  // For Google Drive, use the /preview URL which embeds natively
  const frameUrl=eu.id?eu.preview:
    // For non-Drive URLs, try Google Docs viewer
    'https://docs.google.com/gview?url='+encodeURIComponent(url)+'&embedded=true';
  body.innerHTML=`<iframe class="mv-pdf-frame" src="${frameUrl}" allowfullscreen></iframe>`;
}

// ── Locked File ──
function renderLockedView(i){
  const m=mediaItems[i];
  const body=document.getElementById('mvBody');
  body.innerHTML=`
    <div class="mv-locked">
      <div class="mv-locked-icon">🔒</div>
      <div class="mv-locked-title">Encrypted File</div>
      <div class="mv-locked-desc">${m.desc}<br><br>Enter the decryption key to access this file.</div>
      <div class="mv-locked-input-wrap">
        <input class="mv-locked-input" id="mvLockKey" placeholder="ENTER KEY" autocomplete="off" spellcheck="false" onkeydown="if(event.key==='Enter')tryUnlock(${i})">
        <button class="mv-locked-submit" onclick="tryUnlock(${i})">DECRYPT</button>
      </div>
      <div id="mvLockErr" style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--red);letter-spacing:1px;height:16px"></div>
    </div>`;
}

function tryUnlock(i){
  const m=mediaItems[i];
  const key=document.getElementById('mvLockKey').value.trim();
  // Admin can set an unlock key on each locked item (default: any non-empty input unlocks for demo)
  if(!key){document.getElementById('mvLockErr').textContent='Enter a decryption key';return}
  if(m.unlockKey&&key.toUpperCase()!==m.unlockKey.toUpperCase()){
    document.getElementById('mvLockErr').textContent='✗ INVALID KEY — ACCESS DENIED';
    playDenied();return;
  }
  m.unlocked=true;
  playSuccess();
  if(m.fileUrl)renderMediaContent(m);
  else document.getElementById('mvBody').innerHTML=`<div class="mv-no-file"><div class="mv-no-file-icon">🔓</div><div class="mv-no-file-text">File decrypted — no file attached yet</div></div>`;
  renderMedia();
}

// ══════ ADMIN ══════
let isAdmin=false;
let adminUsers=[{user:'admin',pass:'Engage@3050'}];
let manualTeams=[];

// Admin auth now handled via login screen (submitLogin)
function adminGoVault(){document.getElementById('adminChoiceModal').classList.remove('active');goToLogin()}
function adminGoConsole(){document.getElementById('adminChoiceModal').classList.remove('active');goToConsole()}

// ── Admin dropdown ──
function handleAdminTrigger(){
  const dd=document.getElementById('adminDropdown');
  if(dd.classList.contains('open')){closeAdminDropdown()}else{openAdminDropdown()}
}
function openAdminDropdown(){
  syncAdminDropdownToggles();
  document.getElementById('adminDropdown').classList.add('open');
}
function closeAdminDropdown(){document.getElementById('adminDropdown').classList.remove('open')}
function syncAdminDropdownToggles(){
  const dlEl=document.getElementById('admDlToggle');
  if(dlEl){dlEl.textContent=allowDownloads?'ON':'OFF';dlEl.className='adm-toggle '+(allowDownloads?'on':'off')}
  const edEl=document.getElementById('admEditToggle');
  const isEdit=document.body.classList.contains('edit-mode');
  if(edEl){edEl.textContent=isEdit?'ON':'OFF';edEl.className='adm-toggle '+(isEdit?'on':'off')}
}
function toggleAllowDownloads(){
  allowDownloads=!allowDownloads;
  syncAdminDropdownToggles();
}
// Close dropdown when clicking outside
document.addEventListener('click',e=>{
  const dd=document.getElementById('adminDropdown');
  const trigger=document.getElementById('adminTrigger');
  if(dd.classList.contains('open')&&!dd.contains(e.target)&&!trigger.contains(e.target)){closeAdminDropdown()}
});

function toggleEditMode(){
  const isEdit=document.body.classList.contains('edit-mode');
  if(!isEdit){
    document.body.classList.add('edit-mode');
  }else{
    document.body.classList.remove('edit-mode');
  }
  renderGrid();renderFeed();renderMedia();renderIntelForm();
  syncAdminDropdownToggles();
  closeAdminDropdown();
}
// Global keyboard shortcuts
document.addEventListener('keydown',e=>{
  // Media viewer
  if(document.getElementById('mediaViewer').classList.contains('active')){
    if(e.key==='Escape')closeMediaViewer();
    if(e.key==='ArrowLeft')navMedia(-1);
    if(e.key==='ArrowRight')navMedia(1);
    if(e.key===' '&&mvAudio){e.preventDefault();toggleMvAudio()}
    if(e.key===' '&&document.getElementById('mvVideo')){e.preventDefault();toggleMvVideo()}
    return;
  }
  // Feed focus mode — arrow keys navigate posts
  const feedOpen=document.getElementById('expFeed')?.classList.contains('visible');
  if(feedOpen&&currentFeedView==='single'){
    if(e.key==='ArrowLeft'){e.preventDefault();navPost(-1)}
    if(e.key==='ArrowRight'){e.preventDefault();navPost(1)}
    if(e.key==='Escape'){e.preventDefault();setFeedView('grid')}
    return;
  }
  // Escape closes expanded panel
  if(overlay.classList.contains('active')&&e.key==='Escape'){
    e.preventDefault();closePanel();
  }
});
document.addEventListener('contextmenu',e=>{
  if(e.target.closest('.feed-card-img')||e.target.closest('.feed-single-img')||e.target.closest('.mv-body')||e.target.closest('.no-download-shield'))e.preventDefault();
});
function exitAdmin(){isAdmin=false;document.body.classList.remove('admin-mode');document.body.classList.remove('edit-mode');closeAdminDropdown();closeAdminPanel();closeBroadcast();closeLeaderboard();closeKeysCodes();renderGrid();renderIntelForm()}

// ══════ SCREEN NAVIGATION ══════
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');const lb=document.getElementById('logoutBtn');if(lb)lb.classList.toggle('visible',id==='consoleScreen')}
function goToRegistration(){
  const mode=regSettings.participantMode||'team';
  // Update registration screen text based on mode
  const title=document.getElementById('regScreenTitle');
  const sub=document.getElementById('regScreenSubtitle');
  const typeChoice=document.getElementById('regTypeChoice');
  if(mode==='individual'){
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Individual Registration';
    if(typeChoice)typeChoice.style.display='none';
  }else if(mode==='hybrid'){
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Registration Portal';
    if(typeChoice)typeChoice.style.display='flex';
  }else{
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Team Registration Portal';
    if(typeChoice)typeChoice.style.display='none';
  }
  buildRegForm();
  showScreen('regScreen');
}
function goToLogin(){
  document.getElementById('loginId').value='';
  document.getElementById('loginPw').value='';
  document.getElementById('loginPwField').style.display='none';
  document.getElementById('loginErr').textContent='';
  document.getElementById('loginSubmitBtn').textContent='ENTER';
  document.getElementById('loginDot').classList.remove('ok');
  document.getElementById('loginLbl').classList.remove('ok');
  document.getElementById('loginLbl').textContent='AWAITING INPUT';
  showScreen('loginScreen');
  setTimeout(()=>document.getElementById('loginId').focus(),300);
}
function goToConsole(){
  showScreen('consoleScreen');document.getElementById('notepadTrigger').classList.add('visible');startElapsedTimer();
  // If no team loaded (admin direct entry), show admin identity
  if(!currentVaultTeam&&isAdmin){
    currentVaultTeam={id:'ADMIN',name:'Administrator',type:'admin',members:['Admin'],memberDetails:[]};
    updateConsoleForTeam(currentVaultTeam);
  }
}
function selectRegType(el){
  document.querySelectorAll('.reg-type-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  currentRegType=el.dataset.type;
  buildRegForm();
}

// ══════ LANDING PAGE ══════
function updateLandingForMode(){
  const mode=regSettings.participantMode||'team';
  const regText=document.getElementById('loginRegText');
  const regAction=document.getElementById('loginRegAction');
  const regLink=document.getElementById('loginRegLink');
  if(!regText)return;
  // Hide register link if registration is closed
  if(regLink)regLink.style.display=regSettings.registrationOpen===false?'none':'';
  if(mode==='team'){
    regText.textContent="Don't have a Team ID?";
    regAction.textContent='Register your team';
  }else if(mode==='individual'){
    regText.textContent="Don't have an ID?";
    regAction.textContent='Register here';
  }else{
    regText.textContent="Don't have an ID?";
    regAction.textContent='Register your team or yourself';
  }
}
function updateLandingBanner(){
  const url=(document.getElementById('apBannerUrl')?.value||'').trim();
  regSettings.landingBannerUrl=url;
  applyBannerImage(url);
}
function applyBannerImage(url){
  const img=document.getElementById('landingBannerImg');
  const icon=document.querySelector('.landing-banner-icon');
  if(url&&img&&icon){img.src=url;img.style.display='block';icon.style.display='none'}
  else if(img&&icon){img.style.display='none';icon.style.display='block'}
}
function handleBannerUpload(input){
  if(!input.files||!input.files[0])return;
  const reader=new FileReader();
  reader.onload=function(e){
    const url=e.target.result;
    regSettings.landingBannerUrl=url;
    applyBannerImage(url);
    const urlInput=document.getElementById('apBannerUrl');
    if(urlInput)urlInput.value='[uploaded file]';
  };
  reader.readAsDataURL(input.files[0]);
}
function handleAdminBannerUpload(input){
  handleBannerUpload(input);
}
function updateLandingTitle(){
  regSettings.landingTitle=document.getElementById('apLandingTitle')?.value||'Code Breakers';
  document.getElementById('landingTitleEl').textContent=regSettings.landingTitle;
}
function updateLandingSubtitle(){
  regSettings.landingSubtitle=document.getElementById('apLandingSubtitle')?.value||'Operations Console';
  document.getElementById('landingSubEl').textContent=regSettings.landingSubtitle;
}
function onParticipantModeChange(){
  regSettings.participantMode=document.getElementById('apParticipantMode')?.value||'team';
  updateLandingForMode();
  buildRegForm();
}
function onLeaderboardStyleChange(){
  regSettings.leaderboardStyle=document.getElementById('apLeaderboardStyle')?.value||'mixed';
}

// ── Admin Panel ──
const adminPanelIds=['adminPanel','broadcastPanel','leaderboardModule','keysCodesPanel','teamMonitorPanel'];
function closeAllAdminPanels(){
  adminPanelIds.forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.remove('active');el.style.cssText=''}
  });
  // Also instant-close content panels
  const ov=document.getElementById('panelOverlay');
  ov.classList.remove('active');
  ov.style.cssText='';
  document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));
  if(teamMonitorInterval){clearInterval(teamMonitorInterval);teamMonitorInterval=null}
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording')bcMediaRecorder.stop();
  lbExpandedTeam=null;
  hideAdminTabs();
}
function showAdminTabs(activeId){}
function hideAdminTabs(){}
function switchAdminTab(panelId){
  // Close current, open new — without closing tab bar
  adminPanelIds.forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.remove('active');el.style.cssText=''}
  });
  if(teamMonitorInterval){clearInterval(teamMonitorInterval);teamMonitorInterval=null}
  _instantShow(document.getElementById(panelId));
  showAdminTabs(panelId);
  // Trigger panel-specific init
  if(panelId==='adminPanel'){renderAdminList();renderTeamList();syncAdminPanelSettings()}
  if(panelId==='leaderboardModule'){renderFullLeaderboard()}
  if(panelId==='teamMonitorPanel'){renderTeamMonitor();startTeamMonitor()}
  if(panelId==='keysCodesPanel'){renderKeysCodes()}
}
function syncAdminPanelSettings(){
  const minEl=document.getElementById('apMinSize');
  const maxEl=document.getElementById('apMaxSize');
  const maxTEl=document.getElementById('apMaxTeams');
  if(minEl)minEl.value=regSettings.teamSizeMin;
  if(maxEl)maxEl.value=regSettings.teamSizeMax;
  if(maxTEl)maxTEl.value=regSettings.maxTeams;
  const reqE=document.getElementById('apReqEmail');if(reqE)reqE.checked=regSettings.requireEmail;
  const reqP=document.getElementById('apReqPhone');if(reqP)reqP.checked=regSettings.requirePhone;
  const reqD=document.getElementById('apReqDept');if(reqD)reqD.checked=regSettings.requireDept;
  const regO=document.getElementById('apRegOpen');if(regO)regO.checked=regSettings.registrationOpen;
  const status=document.getElementById('apRegStatus');
  if(status){status.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';status.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)'}
  const apTimer=document.getElementById('apTimerDisplay');
  if(apTimer)apTimer.textContent=document.getElementById('cTimer').textContent;
  syncManualCreationUI();
}
function _instantShow(el){
  el.style.cssText='opacity:1;pointer-events:all;transition:none';
  el.classList.add('active');
}
let apTimerInterval=null;
function openAdminPanel(){
  closeAllAdminPanels();
  _instantShow(document.getElementById('adminPanel'));
  showAdminTabs('adminPanel');
  renderAdminList();renderTeamList();
  syncAdminPanelSettings();
  // Start live timer sync
  if(apTimerInterval)clearInterval(apTimerInterval);
  apTimerInterval=setInterval(()=>{const el=document.getElementById('apTimerDisplay');if(el)el.textContent=document.getElementById('cTimer').textContent},250);
}
function closeAdminPanel(){
  const el=document.getElementById('adminPanel');
  el.style.cssText='';el.classList.remove('active');hideAdminTabs();
  if(apTimerInterval){clearInterval(apTimerInterval);apTimerInterval=null}
}
function openTeamMonitor(){
  closeAllAdminPanels();
  _instantShow(document.getElementById('teamMonitorPanel'));
  showAdminTabs('teamMonitorPanel');
  renderTeamMonitor();startTeamMonitor();
}
function closeTeamMonitor(){
  const el=document.getElementById('teamMonitorPanel');
  el.style.cssText='';el.classList.remove('active');hideAdminTabs();
  if(teamMonitorInterval){clearInterval(teamMonitorInterval);teamMonitorInterval=null}
}

function changeAdminPw(){
  const cur=document.getElementById('apCurPw').value;
  const nw=document.getElementById('apNewPw').value;
  const conf=document.getElementById('apConfPw').value;
  const msg=document.getElementById('apPwMsg');
  // Find current admin by matching current password
  const match=adminUsers.find(a=>a.pass===cur);
  if(!match){msg.className='ap-msg err';msg.textContent='✗ Current password incorrect';return}
  if(nw.length<6){msg.className='ap-msg err';msg.textContent='✗ New password must be at least 6 characters';return}
  if(nw!==conf){msg.className='ap-msg err';msg.textContent='✗ Passwords do not match';return}
  match.pass=nw;
  msg.className='ap-msg ok';msg.textContent='✓ Password updated successfully';
  document.getElementById('apCurPw').value='';document.getElementById('apNewPw').value='';document.getElementById('apConfPw').value='';
}

function addAdmin(){
  const u=document.getElementById('apAddUser').value.trim();
  const p=document.getElementById('apAddPw').value.trim();
  const msg=document.getElementById('apAdminMsg');
  if(!u||!p){msg.className='ap-msg err';msg.textContent='✗ Username and password required';return}
  if(adminUsers.find(a=>a.user===u)){msg.className='ap-msg err';msg.textContent='✗ Username already exists';return}
  adminUsers.push({user:u,pass:p});
  msg.className='ap-msg ok';msg.textContent='✓ Admin "'+u+'" added';
  document.getElementById('apAddUser').value='';document.getElementById('apAddPw').value='';
  renderAdminList();
}
function removeAdmin(i){
  if(adminUsers.length<=1)return;
  adminUsers.splice(i,1);renderAdminList();
}
function renderAdminList(){
  const el=document.getElementById('apAdminList');
  el.innerHTML=adminUsers.map((a,i)=>`<div class="ap-team-row"><span class="ap-team-id">${a.user}</span><span class="ap-team-name">••••••••</span>${adminUsers.length>1?`<span class="ap-team-del" onclick="removeAdmin(${i})">✕</span>`:''}</div>`).join('');
}

function createManualTeam(){
  const mode=regSettings.participantMode||'team';
  const effectiveType=mode==='hybrid'?(document.getElementById('apManualType')?.value||'team'):mode;
  const name=document.getElementById('apTeamName').value.trim();
  const id=document.getElementById('apTeamId').value.trim()||generateTeamId(effectiveType==='individual'?(name||'SOLO'):(name||'TEAM'));
  const msg=document.getElementById('apTeamMsg');
  const label=effectiveType==='individual'?'participant':'team';
  if(!name){msg.className='ap-msg err';msg.textContent='✗ Name required';return}
  if(manualTeams.find(t=>t.id===id)){msg.className='ap-msg err';msg.textContent='✗ ID already exists';return}
  manualTeams.push({name:name,id:id,type:effectiveType});
  msg.className='ap-msg ok';msg.textContent=`✓ ${effectiveType==='individual'?'Participant':'Team'} "${name}" created with ID: ${id}`;
  document.getElementById('apTeamName').value='';document.getElementById('apTeamId').value='';
  renderTeamList();
}
function onManualTypeChange(){
  const t=document.getElementById('apManualType')?.value||'team';
  const isInd=t==='individual';
  document.getElementById('apManualNameLabel').textContent=isInd?'Participant Name':'Team Name';
  document.getElementById('apManualIdLabel').textContent=isInd?'Participant ID (leave blank to auto-generate)':'Team ID (leave blank to auto-generate)';
  document.getElementById('apTeamName').placeholder=isInd?'e.g. Jane Doe':'e.g. Alpha Squad';
  document.getElementById('apManualCreateBtn').textContent=isInd?'Create Participant':'Create Team';
}
function syncManualCreationUI(){
  const mode=regSettings.participantMode||'team';
  const typeRow=document.getElementById('apManualTypeRow');
  const desc=document.getElementById('apManualDesc');
  if(mode==='hybrid'){
    if(typeRow)typeRow.style.display='';
    if(desc)desc.textContent='Manually create teams or individual participants.';
  }else{
    if(typeRow)typeRow.style.display='none';
    const isInd=mode==='individual';
    if(desc)desc.textContent=isInd?'Manually create individual participants.':'Manually create teams with custom or auto-generated IDs.';
    document.getElementById('apManualNameLabel').textContent=isInd?'Participant Name':'Team Name';
    document.getElementById('apManualIdLabel').textContent=isInd?'Participant ID (leave blank to auto-generate)':'Team ID (leave blank to auto-generate)';
    document.getElementById('apTeamName').placeholder=isInd?'e.g. Jane Doe':'e.g. Alpha Squad';
    document.getElementById('apManualCreateBtn').textContent=isInd?'Create Participant':'Create Team';
  }
}
function autoGenTeamId(){const name=document.getElementById('apTeamName').value.trim()||'TEAM';document.getElementById('apTeamId').value=generateTeamId(name)}
function removeTeam(i){manualTeams.splice(i,1);renderTeamList()}
function renderTeamList(){
  const el=document.getElementById('apTeamList');
  el.innerHTML=manualTeams.length?manualTeams.map((t,i)=>`<div class="ap-team-row"><span class="ap-team-id">${t.id}</span><span class="ap-team-name">${t.name}</span><span class="ap-team-del" onclick="removeTeam(${i})">✕</span></div>`).join(''):'<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:8px 0">No teams created yet</div>';
}

// ── Team Monitor (Activity Tracking) ──
const INACTIVE_THRESHOLD=5*60*1000; // 5 minutes
let registeredTeams=[]; // Will be populated from backend; for now demo data
let teamMonitorInterval=null;

function initDemoTeams(){
  const now=Date.now();
  registeredTeams=[
    {id:'SHAD-7924',name:'Shadow Ops',type:'team',members:['Alex Turner','Jordan Blake','Sam Chen'],memberDetails:[{name:'Alex Turner',dept:'IT',email:'alex.t@sri.com',phone:''},{name:'Jordan Blake',dept:'Marketing',email:'jordan.b@sri.com',phone:''},{name:'Sam Chen',dept:'IT',email:'sam.c@sri.com',phone:''}],lastActive:now-30000,fieldsCompleted:7,submitTime:null,registeredAt:new Date(now-3600000).toISOString(),submissionResults:null},
    {id:'CIPH-3815',name:'Cipher Squad',type:'team',members:['Taylor Morgan','Morgan Hayes','Casey Diaz'],memberDetails:[{name:'Taylor Morgan',dept:'Finance',email:'taylor.m@sri.com',phone:''},{name:'Morgan Hayes',dept:'Finance',email:'morgan.h@sri.com',phone:''},{name:'Casey Diaz',dept:'Operations',email:'casey.d@sri.com',phone:''}],lastActive:now-120000,fieldsCompleted:5,submitTime:null,registeredAt:new Date(now-3200000).toISOString(),submissionResults:null},
    {id:'GHOS-6241',name:'Ghost Protocol',type:'team',members:['Riley Shaw','Quinn West','Blake Ford'],memberDetails:[{name:'Riley Shaw',dept:'HR',email:'riley.s@sri.com',phone:''},{name:'Quinn West',dept:'HR',email:'quinn.w@sri.com',phone:''},{name:'Blake Ford',dept:'Legal',email:'blake.f@sri.com',phone:''}],lastActive:now-400000,fieldsCompleted:9,submitTime:'00:42:18',registeredAt:new Date(now-3500000).toISOString(),submissionResults:null},
    {id:'REDC-8103',name:'Red Cell',type:'team',members:['Drew Patel','Avery Kim','Reese Grant'],memberDetails:[{name:'Drew Patel',dept:'Sales',email:'drew.p@sri.com',phone:''},{name:'Avery Kim',dept:'Sales',email:'avery.k@sri.com',phone:''},{name:'Reese Grant',dept:'Marketing',email:'reese.g@sri.com',phone:''}],lastActive:now-180000,fieldsCompleted:3,submitTime:null,registeredAt:new Date(now-2800000).toISOString(),submissionResults:null},
    {id:'BLAC-5497',name:'Black Site',type:'team',members:['Jamie Cruz','Chris Okafor','Pat Nguyen'],memberDetails:[{name:'Jamie Cruz',dept:'Operations',email:'jamie.c@sri.com',phone:''},{name:'Chris Okafor',dept:'IT',email:'chris.o@sri.com',phone:''},{name:'Pat Nguyen',dept:'Operations',email:'pat.n@sri.com',phone:''}],lastActive:now-600000,fieldsCompleted:1,submitTime:null,registeredAt:new Date(now-2400000).toISOString(),submissionResults:null},
  ];
}
initDemoTeams();

function isTeamActive(t){return(Date.now()-t.lastActive)<INACTIVE_THRESHOLD}
function timeSince(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60)return s+'s ago';
  if(s<3600)return Math.floor(s/60)+'m ago';
  return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m ago';
}

function renderTeamMonitor(){
  const el=document.getElementById('apTeamMonitor');
  if(!el)return;
  const active=registeredTeams.filter(isTeamActive);
  const inactive=registeredTeams.filter(t=>!isTeamActive(t));
  document.getElementById('apActiveCount').textContent=active.length;
  document.getElementById('apInactiveCount').textContent=inactive.length;
  document.getElementById('apTotalCount').textContent=registeredTeams.length;

  // Sort: active first (most recent), then inactive (most recent)
  const sorted=[...active.sort((a,b)=>b.lastActive-a.lastActive),...inactive.sort((a,b)=>b.lastActive-a.lastActive)];

  el.innerHTML=sorted.length?sorted.map(t=>{
    const on=isTeamActive(t);
    return `<div class="ap-monitor-row ${on?'active':'inactive'}">
      <div class="ap-monitor-dot ${on?'on':'off'}"></div>
      <span class="ap-monitor-id">${t.id}</span>
      <span class="ap-monitor-name">${t.name} (${t.members.length})</span>
      <span class="ap-monitor-fields">${t.fieldsCompleted}/${intelFields.length}</span>
      <span class="ap-monitor-time">${timeSince(t.lastActive)}</span>
    </div>`;
  }).join(''):'<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:12px 0;text-align:center">No teams registered yet</div>';
}

function renderLeaderboard(){
  const el=document.getElementById('apLeaderboard');
  if(!el)return;
  if(!registeredTeams.length){el.innerHTML='<div class="ap-lb-empty">No teams registered yet</div>';return}

  // Scoring: fields completed (primary), submit time (secondary — earlier = better)
  const maxFields=intelFields.length||11;
  const sorted=[...registeredTeams].sort((a,b)=>{
    if(b.fieldsCompleted!==a.fieldsCompleted)return b.fieldsCompleted-a.fieldsCompleted;
    // If both submitted, earlier wins
    if(a.submitTime&&b.submitTime)return a.submitTime.localeCompare(b.submitTime);
    if(a.submitTime)return -1;if(b.submitTime)return 1;
    return b.lastActive-a.lastActive; // More recent = higher
  });

  const topScore=sorted[0]?sorted[0].fieldsCompleted:1;

  el.innerHTML=sorted.slice(0,5).map((t,i)=>{
    const rank=i+1;
    const rc=rank===1?'gold':rank===2?'silver':rank===3?'bronze':'std';
    const pct=Math.round((t.fieldsCompleted/maxFields)*100);
    const barColor=rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#444';
    return `<div class="ap-lb-row">
      <div class="ap-lb-rank ${rc}">#${rank}</div>
      <div class="ap-lb-info">
        <div class="ap-lb-name">${t.name}</div>
        <div class="ap-lb-meta">${t.id} · ${t.fieldsCompleted}/${maxFields} fields${t.submitTime?' · Submitted '+t.submitTime:''}</div>
        <div class="ap-lb-bar" style="width:${pct}%;background:${barColor}"></div>
      </div>
      <div class="ap-lb-score ${rc}">${pct}%</div>
    </div>`;
  }).join('');
}

// Simulate activity changes for demo (remove in production)
function simulateActivity(){
  registeredTeams.forEach(t=>{
    if(Math.random()<0.3)t.lastActive=Date.now()-Math.floor(Math.random()*120000);
    if(Math.random()<0.1&&t.fieldsCompleted<(intelFields.length||11))t.fieldsCompleted++;
  });
}

function startTeamMonitor(){
  if(teamMonitorInterval)clearInterval(teamMonitorInterval);
  teamMonitorInterval=setInterval(()=>{
    if(document.getElementById('teamMonitorPanel').classList.contains('active')){
      simulateActivity();
      renderTeamMonitor();
    }
    if(document.getElementById('leaderboardModule').classList.contains('active')){
      simulateActivity();
      renderFullLeaderboard();
    }
  },3000);
}

// ── Full Leaderboard Module ──
let lbFilter='all';
let lbExpandedTeam=null;

function openLeaderboard(){
  closeAllAdminPanels();
  _instantShow(document.getElementById('leaderboardModule'));
  showAdminTabs('leaderboardModule');
  renderFullLeaderboard();
}
function closeLeaderboard(){
  const el=document.getElementById('leaderboardModule');
  el.style.cssText='';el.classList.remove('active');
  lbExpandedTeam=null;hideAdminTabs();
}
function setLbFilter(btn,f){
  document.querySelectorAll('.lb-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');lbFilter=f;
  renderFullLeaderboard();
}

function getSortedTeams(){
  const sort=document.getElementById('lbSort')?.value||'score';
  const search=(document.getElementById('lbSearch')?.value||'').toLowerCase();
  const maxFields=intelFields.length||1;

  let teams=[...registeredTeams];

  // Filter
  if(lbFilter==='active')teams=teams.filter(isTeamActive);
  else if(lbFilter==='inactive')teams=teams.filter(t=>!isTeamActive(t));
  else if(lbFilter==='submitted')teams=teams.filter(t=>t.submitTime);

  // Search
  if(search)teams=teams.filter(t=>t.name.toLowerCase().includes(search)||t.id.toLowerCase().includes(search));

  // Sort
  teams.sort((a,b)=>{
    switch(sort){
      case 'score':
        if(b.fieldsCompleted!==a.fieldsCompleted)return b.fieldsCompleted-a.fieldsCompleted;
        if(a.submitTime&&b.submitTime)return a.submitTime.localeCompare(b.submitTime);
        return b.lastActive-a.lastActive;
      case 'fields':return b.fieldsCompleted-a.fieldsCompleted;
      case 'recent':return b.lastActive-a.lastActive;
      case 'name':return a.name.localeCompare(b.name);
      case 'registered':return(a.registeredAt||'').localeCompare(b.registeredAt||'');
      default:return 0;
    }
  });
  return teams;
}

function renderFullLeaderboard(){
  const body=document.getElementById('lbBody');
  if(!body)return;
  const teams=getSortedTeams();
  const maxFields=intelFields.length||1;

  document.getElementById('lbTeamCount').textContent=teams.length+' team'+(teams.length!==1?'s':'');

  if(!teams.length){
    body.innerHTML='<div style="text-align:center;padding:40px 0"><div style="font-size:40px;opacity:.3;margin-bottom:12px">🏆</div><div style="font-family:Chakra Petch,sans-serif;font-size:11px;color:#555">No teams match your filters</div></div>';
    return;
  }

  body.innerHTML=teams.map((t,idx)=>{
    const rank=idx+1;
    const rc=rank===1?'r1':rank===2?'r2':rank===3?'r3':'rn';
    const pct=Math.round((t.fieldsCompleted/maxFields)*100);
    const barColor=rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#333';
    const on=isTeamActive(t);
    const expanded=lbExpandedTeam===t.id;

    let detailHtml='';
    if(expanded){
      // Members
      const members=t.memberDetails||t.members?.map(n=>({name:n}))||[];
      let membersHtml=members.map((m,mi)=>{
        const name=typeof m==='string'?m:m.name;
        const dept=m.dept||'';
        const email=m.email||'';
        return `<div class="lb-member-row"><div class="lb-member-num">${mi+1}</div><span class="lb-member-name">${name}</span><span class="lb-member-meta">${dept}${dept&&email?' · ':''}${email}</span></div>`;
      }).join('');

      // Field-by-field status (if submitted)
      let fieldsHtml='';
      if(t.submissionResults){
        fieldsHtml=t.submissionResults.results.map(r=>{
          const st=r.correct?'correct':(r.submitted||r.submitted===''&&r.type==='dual'?'wrong':'empty');
          const stText=r.correct?'✓ Correct':(st==='empty'?'— Empty':'✗ Wrong');
          return `<div class="lb-field-row"><span class="lb-field-label">${r.field}</span><span class="lb-field-status ${st}">${stText}</span></div>`;
        }).join('');
      }else{
        fieldsHtml=`<div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:#555;padding:8px 0">Awaiting submission</div>`;
      }

      detailHtml=`<div class="lb-detail">
        <div class="lb-detail-section"><div class="lb-detail-title">👥 Team Members</div>${membersHtml}</div>
        <div class="lb-detail-section"><div class="lb-detail-title">📋 Field Status</div>${fieldsHtml}</div>
        <div class="lb-detail-section"><div style="display:flex;gap:16px;flex-wrap:wrap;font-family:IBM Plex Mono,monospace;font-size:8px;color:#666;letter-spacing:1px">
          <span>ID: ${t.id}</span>
          <span>Registered: ${t.registeredAt?new Date(t.registeredAt).toLocaleTimeString():'-'}</span>
          <span>Last Active: ${timeSince(t.lastActive)}</span>
          ${t.submitTime?`<span>Submitted: ${t.submitTime}</span>`:''}
        </div></div>
      </div>`;
    }

    return `<div class="lb-row${expanded?' expanded':''}" onclick="toggleLbTeam('${t.id}')">
      <div class="lb-row-main">
        <div class="lb-rank ${rc}">#${rank}</div>
        <div class="lb-team-status ${on?'on':'off'}"></div>
        <div class="lb-team-info">
          <div class="lb-team-name">${t.name}</div>
          <div class="lb-team-meta">
            <span>${t.id}</span>
            <span>${t.fieldsCompleted}/${maxFields} fields</span>
            <span>${on?'Active':'Inactive '+timeSince(t.lastActive)}</span>
            ${t.submitTime?`<span style="color:var(--green)">✓ Submitted</span>`:''}
          </div>
        </div>
        <div class="lb-score-block">
          <div class="lb-score-pct ${rc}">${pct}%</div>
          <div class="lb-score-label">${t.fieldsCompleted*10} PTS</div>
        </div>
      </div>
      <div class="lb-progress"><div class="lb-progress-fill" style="width:${pct}%;background:${barColor}"></div></div>
      ${detailHtml}
    </div>`;
  }).join('');
}

function toggleLbTeam(id){
  lbExpandedTeam=lbExpandedTeam===id?null:id;
  renderFullLeaderboard();
}

// ── Keys & Codes Panel ──
function openKeysCodes(){
  closeAllAdminPanels();
  _instantShow(document.getElementById('keysCodesPanel'));
  showAdminTabs('keysCodesPanel');
  renderKeysCodes();
}
function closeKeysCodes(){const el=document.getElementById('keysCodesPanel');el.style.cssText='';el.classList.remove('active');hideAdminTabs()}

function renderKeysCodes(){
  const body=document.getElementById('kcBody');
  let html='';

  // Manual Vault Keys
  html+=`<div class="kc-section">
    <div class="kc-section-title">🔐 Vault Puzzle Codes (${manualVaultKeys.length})</div>
    <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#666;margin-bottom:8px">Codes that players discover by solving clues in the Intelligence Feed and Media Lab. Entering a correct code on The Vault keypad unlocks the corresponding entry in the Unlock Log.</div>`;
  if(manualVaultKeys.length){
    manualVaultKeys.forEach((k,i)=>{
      html+=`<div class="kc-row">
        <span class="kc-icon">🗝️</span>
        <span class="kc-label">${k.label||'Unnamed Key'}</span>
        <span class="kc-value">${k.key}</span>
        <span class="kc-edit" onclick="editManualKey(${i})">✎</span>
      </div>`;
    });
  }else{
    html+=`<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:4px 0">No vault codes created yet</div>`;
  }
  html+=`<div style="margin-top:8px"><button class="ap-btn ap-btn-green" onclick="addManualKey()" style="font-size:9px;padding:5px 12px">+ Add Vault Code</button></div>`;
  html+=`</div>`;

  // Locked Media Keys
  const lockedItems=mediaItems.filter(m=>m.type==='locked');
  html+=`<div class="kc-section">
    <div class="kc-section-title">🔒 Locked File Decryption Keys (${lockedItems.length})</div>`;
  if(lockedItems.length){
    lockedItems.forEach((m,li)=>{
      const idx=mediaItems.indexOf(m);
      html+=`<div class="kc-row">
        <span class="kc-icon">${m.icon}</span>
        <span class="kc-label">${m.name}<br><span style="font-size:8px;color:#555">${m.desc}</span></span>
        <span class="kc-value">${m.unlockKey||'<span class="kc-empty">any key</span>'}</span>
        <span class="kc-edit" onclick="editMediaItem(${idx})">✎</span>
      </div>`;
    });
  }else{
    html+=`<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:8px 0">No locked files configured</div>`;
  }
  html+=`</div>`;

  // Answer Keys Summary
  html+=`<div class="kc-section">
    <div class="kc-section-title">🎯 Intel Answer Keys (${intelFields.length})</div>`;
  intelFields.forEach((f,i)=>{
    const a=f.answer||{};
    const exp=a.expected?.filter(e=>e.trim())||[];
    const alts=a.alts||[];
    const allAnswers=[...exp,...alts].filter(Boolean);
    html+=`<div class="kc-row">
      <span class="kc-icon">${f.emoji}</span>
      <span class="kc-label">${f.label}<br><span style="font-size:8px;color:#555">${a.matchMode||'exact'} · ${a.caseSensitive?'Case Sensitive':'Case Insensitive'} · Fuzzy: ${a.fuzzyThreshold||85}% · ${a.points||10}pts</span></span>
      <span class="kc-value" style="min-width:auto;font-size:10px">${allAnswers.length?allAnswers.join(', '):'<span class="kc-empty">not set</span>'}</span>
      <span class="kc-edit" onclick="editIntelField(${i})">✎</span>
    </div>`;
  });
  html+=`</div>`;

  body.innerHTML=html;
}

function addManualKey(){
  showEditModal(`<h3>Add Vault Puzzle Code</h3>
    <div class="edit-field"><label>Label (what this code unlocks)</label><input id="ek_mk_label" placeholder="e.g. Suspect's Date of Birth, Country of Origin"></div>
    <div class="edit-field"><label>Code (what players must enter)</label><input id="ek_mk_key" placeholder="e.g. 03/15/1988" style="font-size:14px;letter-spacing:3px;text-transform:uppercase"></div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-green" onclick="saveNewManualKey()">Add Code</button></div>`);
}
function saveNewManualKey(){
  const label=document.getElementById('ek_mk_label').value.trim();
  const key=document.getElementById('ek_mk_key').value.trim().toUpperCase();
  if(!key)return;
  manualVaultKeys.push({label:label||'Unnamed Key',key});
  hideEditModal();
  renderKeysCodes();
}
function editManualKey(i){
  const k=manualVaultKeys[i];
  showEditModal(`<h3>Edit Vault Puzzle Code</h3>
    <div class="edit-field"><label>Label (what this code unlocks)</label><input id="ek_mk_label" value="${k.label}"></div>
    <div class="edit-field"><label>Code (what players must enter)</label><input id="ek_mk_key" value="${k.key}" style="font-size:14px;letter-spacing:3px;text-transform:uppercase"></div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-red" onclick="deleteManualKey(${i})">Delete</button><button class="btn-standard btn-cyan" onclick="saveManualKey(${i})">Save</button></div>`);
}
function saveManualKey(i){
  const key=document.getElementById('ek_mk_key').value.trim().toUpperCase();
  if(!key)return;
  manualVaultKeys[i].label=document.getElementById('ek_mk_label').value.trim()||'Unnamed Key';
  manualVaultKeys[i].key=key;
  hideEditModal();
  renderKeysCodes();
}
function deleteManualKey(i){
  manualVaultKeys.splice(i,1);
  hideEditModal();
  renderKeysCodes();
}

// ── Broadcast System ──
let bcMode='text';
let bcMediaRecorder=null;
let bcAudioChunks=[];
let bcRecordedBlob=null;
let bcBannerAudio=null;

function openBroadcast(){
  closeAllAdminPanels();
  _instantShow(document.getElementById('broadcastPanel'));
  showAdminTabs('broadcastPanel');
  setTimeout(()=>{
    if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
      navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{s.getTracks().forEach(t=>t.stop())}).catch(e=>{
        console.log('Mic permission prompt:',e.name);
      });
    }
  },100);
}
function closeBroadcast(){
  const el=document.getElementById('broadcastPanel');
  el.style.cssText='';el.classList.remove('active');hideAdminTabs();
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording')bcMediaRecorder.stop();
}
function switchBcTab(btn,tab){
  document.querySelectorAll('.bc-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');
  document.getElementById('bcTextTab').style.display=tab==='text'?'':'none';
  document.getElementById('bcVoiceTab').style.display=tab==='voice'?'':'none';
  bcMode=tab;
}

function toggleRecording(){
  const btn=document.getElementById('bcRecBtn');
  const label=document.getElementById('bcRecLabel');
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording'){
    bcMediaRecorder.stop();btn.classList.remove('recording');label.textContent='Processing...';
    return;
  }
  bcAudioChunks=[];bcRecordedBlob=null;
  document.getElementById('bcPreview').style.display='none';
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    bcMediaRecorder=new MediaRecorder(stream);
    bcMediaRecorder.ondataavailable=e=>{if(e.data.size>0)bcAudioChunks.push(e.data)};
    bcMediaRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      bcRecordedBlob=new Blob(bcAudioChunks,{type:'audio/webm'});
      const url=URL.createObjectURL(bcRecordedBlob);
      document.getElementById('bcAudioPreview').src=url;
      document.getElementById('bcPreview').style.display='block';
      label.textContent='Recording ready — preview above';
    };
    bcMediaRecorder.start();btn.classList.add('recording');label.textContent='🔴 Recording... tap to stop';
  }).catch(()=>{label.innerHTML='<span style="color:var(--amber)">⚠ Microphone access denied — check browser permissions</span>'});
}

function sendBroadcast(){
  if(bcMode==='text'){
    const msg=document.getElementById('bcMessage').value.trim();
    if(!msg)return;
    showPlayerBanner('text',msg);
    document.getElementById('bcMessage').value='';
    closeBroadcast();
  } else {
    if(!bcRecordedBlob){return}
    const url=URL.createObjectURL(bcRecordedBlob);
    showPlayerBanner('voice',url);
    bcRecordedBlob=null;
    document.getElementById('bcPreview').style.display='none';
    document.getElementById('bcRecLabel').textContent='Tap to record';
    closeBroadcast();
  }
}

let bannerDismissTimer=null;
let bannerProgressInterval=null;
let notifications=[];

function showPlayerBanner(type,content){
  const banner=document.getElementById('playerBanner');
  const icon=document.getElementById('pbIcon');
  const body=document.getElementById('pbContent');
  const progress=document.getElementById('pbProgress');
  playNotification();

  // Store notification
  notifications.unshift({type,content,time:new Date().toLocaleTimeString(),read:false});
  updateNotificationBadge();

  if(type==='text'){
    icon.textContent='📢';
    body.innerHTML=`<span class="pb-text">${content}</span>`;
  } else {
    icon.textContent='🎙️';
    body.innerHTML=`<div class="pb-audio"><span class="pb-audio-label">Incoming audio from Administrator</span><div class="pb-audio-play" id="pbAudioPlay" onclick="event.stopPropagation();toggleBannerAudio()">▶</div></div>`;
    bcBannerAudio=new Audio(content);
    bcBannerAudio.addEventListener('ended',()=>{document.getElementById('pbAudioPlay').textContent='▶'});
  }

  // Auto-dismiss after 10 seconds with progress bar
  if(bannerDismissTimer)clearTimeout(bannerDismissTimer);
  if(bannerProgressInterval)clearInterval(bannerProgressInterval);
  if(progress)progress.style.width='100%';
  const duration=10000;
  const start=Date.now();
  bannerProgressInterval=setInterval(()=>{
    const elapsed=Date.now()-start;
    const remaining=Math.max(0,1-elapsed/duration);
    if(progress)progress.style.width=(remaining*100)+'%';
    if(remaining<=0)clearInterval(bannerProgressInterval);
  },50);
  bannerDismissTimer=setTimeout(()=>dismissBanner(),duration);

  banner.classList.add('show');
}
function toggleBannerAudio(){
  if(!bcBannerAudio)return;
  const btn=document.getElementById('pbAudioPlay');
  if(bcBannerAudio.paused){bcBannerAudio.play();btn.textContent='⏸'}
  else{bcBannerAudio.pause();btn.textContent='▶'}
}
function dismissBanner(){
  document.getElementById('playerBanner').classList.remove('show');
  if(bcBannerAudio){bcBannerAudio.pause();bcBannerAudio=null}
  if(bannerDismissTimer){clearTimeout(bannerDismissTimer);bannerDismissTimer=null}
  if(bannerProgressInterval){clearInterval(bannerProgressInterval);bannerProgressInterval=null}
  const progress=document.getElementById('pbProgress');if(progress)progress.style.width='0';
}
function playNotification(){
  const c=getAudio();if(!c)return;
  const t=c.currentTime;
  [0,.12,.24].forEach((off,i)=>{
    const freq=[800,1000,1200][i];
    const o=c.createOscillator();o.type='sine';o.frequency.value=freq;
    const g=c.createGain();g.gain.setValueAtTime(.06,t+off);g.gain.exponentialRampToValueAtTime(.001,t+off+.15);
    o.connect(g);g.connect(c.destination);o.start(t+off);o.stop(t+off+.15);
  });
}

function updateNotificationBadge(){
  const badge=document.getElementById('notifBadge');
  const unread=notifications.filter(n=>!n.read).length;
  if(badge){
    badge.textContent=unread;
    badge.classList.toggle('has-notifs',unread>0);
  }
}
function toggleNotifDropdown(e){
  e.stopPropagation();
  const dd=document.getElementById('notifDropdown');
  const isOpen=dd.classList.contains('open');
  dd.classList.toggle('open');
  if(!isOpen){
    // Mark all as read
    notifications.forEach(n=>n.read=true);
    updateNotificationBadge();
    renderNotifications();
  }
}
function renderNotifications(){
  const list=document.getElementById('notifList');
  if(!notifications.length){list.innerHTML='<div class="notif-empty">No notifications yet</div>';return}
  list.innerHTML=notifications.map(n=>`<div class="notif-item"><div class="notif-item-time">${n.time}</div>${n.type==='text'?`<div class="notif-item-msg">${n.content}</div>`:`<div class="notif-item-voice">🎙️ Voice message from Administrator</div>`}</div>`).join('');
}
function clearNotifications(){
  notifications=[];
  updateNotificationBadge();
  renderNotifications();
}
// Close dropdown on outside click
document.addEventListener('click',e=>{
  const dd=document.getElementById('notifDropdown');
  if(dd&&dd.classList.contains('open')&&!e.target.closest('.notif-bell'))dd.classList.remove('open');
});

// ── Vault Keypad Symbol Toggle ──
let symMode=false;
const symRows=[
  ['!','@','#','$','%','^','&','*','(',')'],
  ['-','_','=','+','[',']','{','}','|'],
  [';',':','"','<','>','/','.']
];
const alphaRows=[
  ['Q','W','E','R','T','Y','U','I','O','P'],
  ['A','S','D','F','G','H','J','K','L'],
  ['Z','X','C','V','B','N','M']
];
// Symbol toggle (legacy) — vault puzzle uses vkToggleSymbols

// ══════ ADMIN EDIT MODALS ══════
function showEditModal(html){document.getElementById('editBox').innerHTML=html;document.getElementById('adminEditModal').classList.add('active')}
function hideEditModal(){document.getElementById('adminEditModal').classList.remove('active')}

// ── File type auto-detection ──
const typeMap={wav:'audio',mp3:'audio',ogg:'audio',flac:'audio',aac:'audio',m4a:'audio',pdf:'doc',doc:'doc',docx:'doc',txt:'doc',csv:'doc',xlsx:'doc',xls:'doc',png:'doc',jpg:'doc',jpeg:'doc',mp4:'video',mov:'video',avi:'video',mkv:'video',webm:'video',enc:'locked',zip:'locked',rar:'locked'};
const iconMap={audio:'🎵',doc:'📄',map:'🗺️',video:'🎬',locked:'🔒'};
function detectType(name){const ext=(name.split('.').pop()||'').toLowerCase();return typeMap[ext]||'doc'}
function detectIcon(type){return iconMap[type]||'📄'}

// ── Upload storage ──
let pendingUpload='';
function handleUpload(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{pendingUpload=e.target.result;const zone=document.getElementById('uploadZone');zone.classList.add('has-file');zone.innerHTML=`<img src="${pendingUpload}" class="upload-preview"><br>✓ ${file.name}`};
  reader.readAsDataURL(file);
}
let pendingMediaFileUrl='';
function handleMediaUpload(input){
  const file=input.files[0];if(!file)return;
  const nameEl=document.getElementById('em_name');
  const typeEl=document.getElementById('em_type');
  const iconEl=document.getElementById('em_ico');
  const urlEl=document.getElementById('em_url');
  if(!nameEl.value.trim())nameEl.value=file.name;
  const t=detectType(file.name);
  typeEl.value=t;
  iconEl.value=detectIcon(t);
  // Read file as data URL for immediate use
  const reader=new FileReader();
  reader.onload=e=>{
    pendingMediaFileUrl=e.target.result;
    if(urlEl)urlEl.value='[uploaded file]';
  };
  reader.readAsDataURL(file);
}
function switchTab(btn,tab){btn.parentElement.querySelectorAll('.edit-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');btn.parentElement.parentElement.querySelectorAll('.edit-tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active')}

// ── Operation Name ──
function editOperationName(){
  showEditModal(`<h3>Edit Operation Details</h3>
    <div class="edit-font-row"><div class="edit-field"><label>Operation Name</label><input id="eo_name" value="${operationName}"></div><div class="edit-field"><label>Font</label>${fontSelect('eo_name_font',operationFont)}</div></div>
    <div class="edit-font-row"><div class="edit-field"><label>Vault Description</label><input id="eo_sub" value="${vaultSubtitle}"></div><div class="edit-field"><label>Font</label>${fontSelect('eo_sub_font',vaultSubFont)}</div></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveOperationName()">Save</button></div>`);
}
function saveOperationName(){
  operationName=document.getElementById('eo_name').value.trim()||'Operation Dead Drop';
  operationFont=document.getElementById('eo_name_font').value;
  vaultSubtitle=document.getElementById('eo_sub').value.trim()||'Secure Terminal Access';
  vaultSubFont=document.getElementById('eo_sub_font').value;
  const vt=document.getElementById('vaultTitle');
  vt.textContent=operationName;
  if(operationFont)vt.style.fontFamily=getFontFamily(operationFont);else vt.style.fontFamily='';
  const ct=document.getElementById('consoleTitle');
  ct.textContent='◈ '+operationName;
  if(operationFont)ct.style.fontFamily=getFontFamily(operationFont);else ct.style.fontFamily='';
  const vs=document.getElementById('vaultSubtitle');
  vs.textContent=vaultSubtitle;
  if(vaultSubFont)vs.style.fontFamily=getFontFamily(vaultSubFont);else vs.style.fontFamily='';
  hideEditModal();
}

// ── Grid Tiles ──
function renderGrid(){
  const isA=document.body.classList.contains('edit-mode');
  const g=document.getElementById('consoleGrid');
  g.innerHTML=gridTiles.map((t,i)=>{
    const isIntel=t.id==='intel';
    const isVault=t.id==='vault';
    const badgeCls=(isIntel||isVault)?' amber':'';
    return `<div class="crt-monitor" onclick="openPanel('${t.id}')">
      ${isA?`<div class="admin-edit-btn" onclick="event.stopPropagation();editGridTile(${i})">✎</div>`:''}
      <div class="crt-screw s1"></div><div class="crt-screw s2"></div><div class="crt-screw s3"></div><div class="crt-screw s4"></div>
      <div class="crt-led"></div>
      <div class="crt-screen">
        <div class="tile-glow"></div>
        <div class="tile-icon">${t.icon.startsWith('http')||t.icon.startsWith('data:')?`<img src="${t.icon}" style="width:48px;height:48px;object-fit:contain">`:t.icon}</div>
        <div class="tile-label" style="${fontStyle(t.labelFont)}">${t.label}</div>
        <div class="tile-sub" style="${fontStyle(t.subFont)}">${t.sub}</div>
        <div class="tile-badge${badgeCls}" id="${t.badgeId}">${t.id==='feed'?posts.length+' FILES':t.id==='media'?mediaItems.length+' FILES':t.id==='vault'?vaultCodes.filter(c=>c.unlocked).length+' / '+vaultCodes.length+' CRACKED':'0 / '+intelFields.length+' MARKED'}</div>
        <div class="tile-status"><div class="tile-dot ${t.dotClass}"></div><span>${t.status}</span></div>
      </div>
    </div>`;
  }).join('');
}
function editGridTile(i){
  const t=gridTiles[i];
  const isImgIcon=t.icon.startsWith('http')||t.icon.startsWith('data:');
  showEditModal(`<h3>Edit Grid Tile: ${t.label}</h3>
    <div class="edit-field"><label>Icon (emoji or image URL)</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="eg_icon" value="${isImgIcon?'':t.icon}" placeholder="Paste emoji or image URL" style="flex:1">
        <label style="cursor:pointer;font-size:9px;color:var(--cyan);letter-spacing:1px;padding:8px 12px;border:1px solid rgba(0,212,255,.2);border-radius:3px;background:rgba(0,212,255,.05);white-space:nowrap">
          📁 Upload
          <input type="file" accept="image/*" onchange="handleIconUpload(this)" style="display:none">
        </label>
      </div>
      ${isImgIcon?`<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><img src="${t.icon}" style="width:36px;height:36px;object-fit:contain;border-radius:4px;border:1px solid var(--border)"><span style="font-size:8px;color:#666">Current image icon</span><button onclick="document.getElementById('eg_icon').value='';document.getElementById('eg_icon_preview').innerHTML=''" style="font-size:8px;color:var(--red);background:none;border:1px solid rgba(255,50,50,.2);border-radius:3px;padding:2px 8px;cursor:pointer">Remove</button></div>`:''}
      <div id="eg_icon_preview"></div>
    </div>
    <div class="edit-field-row">
      <div class="edit-field"><label>Label</label><input id="eg_label" value="${t.label}"></div>
      <div class="edit-field" style="flex:0 0 140px"><label>Label Font</label>${fontSelect('eg_label_font',t.labelFont)}</div>
    </div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="eg_label_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply label font to all grid tiles</span></label>
    <div class="edit-font-row"><div class="edit-field"><label>Description</label><input id="eg_sub" value="${t.sub}"></div><div class="edit-field"><label>Desc Font</label>${fontSelect('eg_sub_font',t.subFont)}</div></div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="eg_sub_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply description font to all grid tiles</span></label>
    <div class="edit-field-row">
      <div class="edit-field"><label>Status Text</label><input id="eg_status" value="${t.status}"></div>
      <div class="edit-field"><label>Status Dot</label><select id="eg_dot"><option${t.dotClass==='live'?' selected':''}>live</option><option${t.dotClass==='pending'?' selected':''}>pending</option></select></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveGridTile(${i})">Save</button></div>`);
  // If image icon, store URL in hidden state
  if(isImgIcon)document.getElementById('eg_icon').value=t.icon;
}
function handleIconUpload(input){
  if(!input.files||!input.files[0])return;
  const reader=new FileReader();
  reader.onload=function(e){
    document.getElementById('eg_icon').value=e.target.result;
    document.getElementById('eg_icon_preview').innerHTML=`<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><img src="${e.target.result}" style="width:36px;height:36px;object-fit:contain;border-radius:4px;border:1px solid var(--border)"><span style="font-size:8px;color:var(--green)">✓ Image loaded</span></div>`;
  };
  reader.readAsDataURL(input.files[0]);
}
function saveGridTile(i){
  gridTiles[i].icon=document.getElementById('eg_icon').value.trim();
  gridTiles[i].label=document.getElementById('eg_label').value.trim();
  gridTiles[i].sub=document.getElementById('eg_sub').value.trim();
  gridTiles[i].status=document.getElementById('eg_status').value.trim();
  gridTiles[i].dotClass=document.getElementById('eg_dot').value;
  const lf=document.getElementById('eg_label_font').value;
  const sf=document.getElementById('eg_sub_font').value;
  gridTiles[i].labelFont=lf;
  gridTiles[i].subFont=sf;
  if(document.getElementById('eg_label_all').checked)gridTiles.forEach(t=>t.labelFont=lf);
  if(document.getElementById('eg_sub_all').checked)gridTiles.forEach(t=>t.subFont=sf);
  hideEditModal();renderGrid();
}

// ── Intel Fields ──
function renderIntelForm(){
  const isA=document.body.classList.contains('edit-mode');
  const form=document.getElementById('intelForm');
  // Preserve existing input values
  const prevVals={};
  form.querySelectorAll('.intel-exp-input').forEach(inp=>{prevVals[inp.dataset.idx]=inp.value});
  let html='';
  intelFields.forEach((f,i)=>{
    const num=String(i+1).padStart(2,'0');
    const editBtn=isA?`<div class="admin-row-edit" onclick="event.stopPropagation();editIntelField(${i})">✎</div>`:'';
    const lStyle=f.font?` style="${fontStyle(f.font)}"`:'';
    if(f.type==='money'){
      html+=`<div class="intel-exp-row">${editBtn}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><div class="intel-prefix-wrap"><span class="intel-prefix">$</span><input class="intel-exp-input" style="border:none;background:transparent;box-shadow:none" placeholder="···" data-idx="${i}"></div><div class="intel-exp-check">—</div></div>`;
    }else if(f.type==='phone'){
      html+=`<div class="intel-exp-row">${editBtn}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input" placeholder="(XXX) XXX-XXXX" data-idx="${i}" oninput="formatPhone(this)"><div class="intel-exp-check">—</div></div>`;
    }else if(f.type==='dual'){
      html+=`<div class="intel-exp-row">${editBtn}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><div class="intel-dual-wrap"><input class="intel-exp-input" placeholder="Value 1" data-idx="${i}"><span class="intel-dual-sep">&</span><input class="intel-exp-input" placeholder="Value 2" data-idx="${i}b"></div><div class="intel-exp-check">—</div></div>`;
    }else{
      html+=`<div class="intel-exp-row">${editBtn}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input" placeholder="···" data-idx="${i}"><div class="intel-exp-check">—</div></div>`;
    }
  });
  if(isA)html+=`<div class="admin-add-btn" style="margin-top:10px;padding:14px" onclick="addIntelField()">+ Add Intel Field</div>`;
  html+=`<button class="intel-submit-btn" id="intelSubmitBtn" onclick="showConfirm()">◈ Transmit Intel ◈</button>`;
  form.innerHTML=html;
  // Restore values
  form.querySelectorAll('.intel-exp-input').forEach(inp=>{if(prevVals[inp.dataset.idx])inp.value=prevVals[inp.dataset.idx]});
  if(isSubmitted){form.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=true});form.querySelectorAll('.intel-exp-check').forEach(chk=>{chk.classList.add('submitted');chk.textContent='✓'});document.getElementById('intelSubmitBtn').disabled=true;document.getElementById('intelSubmitBtn').textContent='◈ TRANSMITTED ◈'}
  // Sync intelLabels array
  syncIntelLabels();
}
function syncIntelLabels(){
  const labels=[];
  intelFields.forEach(f=>{
    if(f.type==='dual'){labels.push(f.label+' 1');labels.push(f.label+' 2')}
    else labels.push(f.label);
  });
  while(intelLabels.length)intelLabels.pop();
  labels.forEach(l=>intelLabels.push(l));
}
function editIntelField(i){
  const f=intelFields[i];
  const a=f.answer||{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10};
  const isDual=f.type==='dual';
  const expInputs=isDual?
    `<div class="edit-font-row"><div class="edit-field"><label>Expected Answer 1</label><input id="ei_exp1" value="${(a.expected[0]||'')}" placeholder="Primary answer"></div><div class="edit-field"><label>Expected Answer 2</label><input id="ei_exp2" value="${(a.expected[1]||'')}" placeholder="Second value"></div></div>`:
    `<div class="edit-field"><label>Expected Answer</label><input id="ei_exp1" value="${(a.expected[0]||'')}" placeholder="The correct answer"></div>`;

  showEditModal(`<h3>Edit Intel Field #${i+1}</h3>
    <div class="edit-tabs" style="margin-bottom:14px"><button class="edit-tab active" onclick="switchTab(this,'field')">Field Settings</button><button class="edit-tab" onclick="switchTab(this,'answer')">🔑 Answer Key</button></div>
    <div class="edit-tab-content active" id="tab-field">
      <div class="edit-field-row">
        <div class="edit-field"><label>Label</label><input id="ei_label" value="${f.label}"></div>
        <div class="edit-field" style="flex:.3"><label>Emoji</label><input id="ei_emoji" value="${f.emoji}"></div>
      </div>
      <div class="edit-font-row"><div class="edit-field"><label>Input Type</label><select id="ei_type"><option${f.type==='text'?' selected':''}>text</option><option${f.type==='money'?' selected':''}>money</option><option${f.type==='phone'?' selected':''}>phone</option><option${f.type==='dual'?' selected':''}>dual</option></select></div><div class="edit-field"><label>Label Font</label>${fontSelect('ei_font',f.font)}</div></div>
      <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="ei_font_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply font to all intel field labels</span></label>
    </div>
    <div class="edit-tab-content" id="tab-answer">
      ${expInputs}
      <div class="edit-field"><label>Accepted Alternatives (comma-separated)</label><input id="ei_alts" value="${(a.alts||[]).join(', ')}" placeholder="e.g. NY, New York City, NYC"></div>
      <div class="edit-field-row">
        <div class="edit-field"><label>Match Mode</label><select id="ei_match"><option value="exact"${a.matchMode==='exact'?' selected':''}>Exact Match</option><option value="contains"${a.matchMode==='contains'?' selected':''}>Contains</option><option value="fuzzy"${a.matchMode==='fuzzy'?' selected':''}>Fuzzy Match</option></select></div>
        <div class="edit-field"><label>Fuzzy Tolerance (%)</label><input type="number" id="ei_fuzzy" value="${a.fuzzyThreshold||85}" min="50" max="100" step="5"></div>
      </div>
      <div class="edit-field-row">
        <div class="edit-field"><label>Points</label><input type="number" id="ei_pts" value="${a.points||10}" min="1" max="100"></div>
        <div class="edit-field"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="ei_case" ${a.caseSensitive?'checked':''}> Case Sensitive</label></div>
      </div>
      <div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:4px;background:rgba(0,255,136,.02)">
        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:var(--green);margin-bottom:8px;font-weight:600">TEST ANSWER</div>
        <div class="edit-font-row"><div class="edit-field"><input id="ei_test" placeholder="Type a test submission..."></div><button class="ap-btn ap-btn-green" onclick="testIntelAnswer(${i})" style="flex-shrink:0;margin-bottom:10px">Test</button></div>
        <div id="ei_testResult" style="font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;min-height:16px"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteIntelField(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveIntelField(${i})">Save</button></div>`);
}
function testIntelAnswer(i){
  const testVal=document.getElementById('ei_test').value;
  const cfg={
    expected:[document.getElementById('ei_exp1').value.trim()],
    alts:(document.getElementById('ei_alts').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    caseSensitive:document.getElementById('ei_case').checked,
    matchMode:document.getElementById('ei_match').value,
    fuzzyThreshold:parseInt(document.getElementById('ei_fuzzy').value)||85,
    points:parseInt(document.getElementById('ei_pts').value)||10
  };
  const exp2=document.getElementById('ei_exp2');
  if(exp2)cfg.expected.push(exp2.value.trim());

  const r=checkSingleAnswer(testVal,cfg);
  const el=document.getElementById('ei_testResult');
  if(r.correct){
    el.style.color='var(--green)';
    el.textContent='✓ ACCEPTED — '+r.match+(r.similarity?' ('+r.similarity+'% match)':'');
  }else if(r.match==='empty'){
    el.style.color='var(--amber)';el.textContent='— No input to test';
  }else if(r.match==='no-answer-key'){
    el.style.color='var(--amber)';el.textContent='— No expected answer configured';
  }else{
    el.style.color='var(--red)';
    el.textContent='✗ REJECTED — closest match: '+r.closestSimilarity+'%';
  }
}
function saveIntelField(i){
  intelFields[i].label=document.getElementById('ei_label').value.trim();
  intelFields[i].emoji=document.getElementById('ei_emoji').value.trim();
  intelFields[i].type=document.getElementById('ei_type').value;
  const font=document.getElementById('ei_font').value;
  intelFields[i].font=font;
  if(document.getElementById('ei_font_all').checked)intelFields.forEach(f=>f.font=font);
  // Save answer config
  const exp1=document.getElementById('ei_exp1')?.value.trim()||'';
  const exp2=document.getElementById('ei_exp2')?.value.trim()||'';
  intelFields[i].answer={
    expected:exp2?[exp1,exp2]:[exp1],
    alts:(document.getElementById('ei_alts')?.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    caseSensitive:document.getElementById('ei_case')?.checked||false,
    matchMode:document.getElementById('ei_match')?.value||'exact',
    fuzzyThreshold:parseInt(document.getElementById('ei_fuzzy')?.value)||85,
    points:parseInt(document.getElementById('ei_pts')?.value)||10
  };
  hideEditModal();renderIntelForm();renderGrid();
}
// Two-step delete: first click shows confirm, second click executes
function confirmDelete(btn,fn){
  if(btn.dataset.armed){fn();return}
  btn.dataset.armed='1';btn.textContent='⚠ Confirm?';btn.style.background='rgba(255,50,50,.25)';
  setTimeout(()=>{if(btn){btn.dataset.armed='';btn.textContent='Delete';btn.style.background=''}},3000);
}
function deleteIntelField(i){intelFields.splice(i,1);hideEditModal();renderIntelForm();renderGrid()}
function addIntelField(){
  showEditModal(`<h3>Add Intel Field</h3>
    <div class="edit-field-row">
      <div class="edit-field"><label>Label</label><input id="ei_label" value=""></div>
      <div class="edit-field" style="flex:.3"><label>Emoji</label><input id="ei_emoji" value="📋"></div>
    </div>
    <div class="edit-font-row"><div class="edit-field"><label>Input Type</label><select id="ei_type"><option selected>text</option><option>money</option><option>phone</option><option>dual</option></select></div><div class="edit-field"><label>Label Font</label>${fontSelect('ei_font','')}</div></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewIntelField()">Add Field</button></div>`);
}
function saveNewIntelField(){
  intelFields.push({
    label:document.getElementById('ei_label').value.trim()||'New Field',
    emoji:document.getElementById('ei_emoji').value.trim()||'📋',
    type:document.getElementById('ei_type').value,
    font:document.getElementById('ei_font').value,
    answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}
  });
  hideEditModal();renderIntelForm();renderGrid();
}

// ── Feed Posts ──
let pendingFeedUpload='';
let pendingFeedUploadType='';
function handleFeedUpload(input){
  const file=input.files[0];if(!file)return;
  const zone=document.getElementById('feedUploadZone');
  const sel=document.getElementById('ef_mtype');
  if(file.type.startsWith('video/')){
    const blobUrl=URL.createObjectURL(file);
    pendingFeedUpload=blobUrl;
    pendingFeedUploadType='video';
    zone.innerHTML=`<video src="${blobUrl}" style="max-width:100%;max-height:120px;border-radius:4px" muted autoplay loop playsinline></video><br>✓ ${file.name}`;
    if(sel)sel.value='video';
    zone.classList.add('has-file');
  } else {
    const reader=new FileReader();
    reader.onload=e=>{
      pendingFeedUpload=e.target.result;
      pendingFeedUploadType='image';
      zone.innerHTML=`<img src="${pendingFeedUpload}" class="upload-preview"><br>✓ ${file.name}`;
      if(sel)sel.value='image';
      zone.classList.add('has-file');
    };
    reader.readAsDataURL(file);
  }
}
function editFeedPost(i){
  const p=posts[i];pendingFeedUpload='';pendingFeedUploadType='';
  const hasMedia=!!p.mediaUrl;
  const previewHtml=hasMedia?(p.mediaType==='video'?`<video src="${p.mediaUrl}" style="max-width:100%;max-height:120px;border-radius:4px" muted autoplay loop playsinline></video><br>✓ Current video`:`<img src="${p.mediaUrl}" class="upload-preview"><br>✓ Current image`):'Click to upload image or video';
  showEditModal(`<h3>Edit Feed Post #${i+1}</h3>
    <div class="edit-field"><label>Media Type</label><select id="ef_mtype"><option value="image"${p.mediaType!=='video'?' selected':''}>Image</option><option value="video"${p.mediaType==='video'?' selected':''}>Video</option></select></div>
    <div class="edit-field"><label>Media URL</label>
      <div class="edit-tabs"><button class="edit-tab active" onclick="switchTab(this,'url')">URL</button><button class="edit-tab" onclick="switchTab(this,'upload')">Upload</button></div>
      <div class="edit-tab-content active" id="tab-url"><input id="ef_media" value="${p.mediaUrl||''}" placeholder="File URL (image or video)..."></div>
      <div class="edit-tab-content" id="tab-upload"><div class="upload-zone ${hasMedia?'has-file':''}" id="feedUploadZone" onclick="document.getElementById('feedFileInput').click()">${previewHtml}</div><input type="file" id="feedFileInput" accept="image/*,video/*" style="display:none" onchange="handleFeedUpload(this)"></div>
    </div>
    <div class="edit-field"><label>Emoji (fallback)</label><input id="ef_emo" value="${p.emoji}"></div>
    <div class="edit-field"><label>Background Color</label><input id="ef_bg" value="${p.bg}"></div>
    <div class="edit-font-row"><div class="edit-field"><label>Caption</label><textarea id="ef_cap">${p.cap}</textarea></div><div class="edit-field"><label>Caption Font</label>${fontSelect('ef_font',p.capFont||'')}</div></div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="ef_font_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply font to all post captions</span></label>
    <div style="display:flex;gap:10px;margin-top:6px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteFeedPost(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveFeedPost(${i})">Save</button></div>`);
}
function saveFeedPost(i){
  posts[i].mediaType=document.getElementById('ef_mtype').value;
  if(pendingFeedUpload){
    posts[i].mediaUrl=pendingFeedUpload;
    if(pendingFeedUploadType)posts[i].mediaType=pendingFeedUploadType;
  } else {
    posts[i].mediaUrl=document.getElementById('ef_media').value.trim();
  }
  posts[i].emoji=document.getElementById('ef_emo').value.trim();
  posts[i].bg=document.getElementById('ef_bg').value.trim();
  posts[i].cap=document.getElementById('ef_cap').value.trim();
  const cf=document.getElementById('ef_font').value;posts[i].capFont=cf;
  if(document.getElementById('ef_font_all').checked)posts.forEach(p=>p.capFont=cf);
  pendingFeedUpload='';pendingFeedUploadType='';hideEditModal();renderFeed();renderGrid();
}
function deleteFeedPost(i){posts.splice(i,1);hideEditModal();renderFeed();renderGrid()}
function addFeedPost(){pendingFeedUpload='';pendingFeedUploadType='';showEditModal(`<h3>Add New Feed Post</h3>
    <div class="edit-field"><label>Media Type</label><select id="ef_mtype"><option value="image" selected>Image</option><option value="video">Video</option></select></div>
    <div class="edit-field"><label>Media URL</label>
      <div class="edit-tabs"><button class="edit-tab active" onclick="switchTab(this,'url')">URL</button><button class="edit-tab" onclick="switchTab(this,'upload')">Upload</button></div>
      <div class="edit-tab-content active" id="tab-url"><input id="ef_media" value="" placeholder="File URL (image or video)..."></div>
      <div class="edit-tab-content" id="tab-upload"><div class="upload-zone" id="feedUploadZone" onclick="document.getElementById('feedFileInput').click()">Click to upload image or video</div><input type="file" id="feedFileInput" accept="image/*,video/*" style="display:none" onchange="handleFeedUpload(this)"></div>
    </div>
    <div class="edit-field"><label>Emoji (fallback)</label><input id="ef_emo" value="📷"></div>
    <div class="edit-field"><label>Background Color</label><input id="ef_bg" value="#1a1a2a"></div>
    <div class="edit-font-row"><div class="edit-field"><label>Caption</label><textarea id="ef_cap"></textarea></div><div class="edit-field"><label>Caption Font</label>${fontSelect('ef_font','')}</div></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewFeedPost()">Add Post</button></div>`)}
function saveNewFeedPost(){
  const mtype=document.getElementById('ef_mtype').value;
  const p={emoji:document.getElementById('ef_emo').value.trim()||'📷',bg:document.getElementById('ef_bg').value.trim()||'#1a1a2a',cap:document.getElementById('ef_cap').value.trim(),capFont:document.getElementById('ef_font').value,mediaType:mtype,mediaUrl:''};
  if(pendingFeedUpload){
    p.mediaUrl=pendingFeedUpload;
    if(pendingFeedUploadType)p.mediaType=pendingFeedUploadType;
  } else {
    p.mediaUrl=document.getElementById('ef_media').value.trim();
  }
  posts.push(p);pendingFeedUpload='';hideEditModal();renderFeed();renderGrid();
}

// ── Media Items (enhanced with file upload + auto-detect) ──
function editMediaItem(i){
  pendingMediaFileUrl='';
  const m=mediaItems[i];
  const typeOpts=['audio','doc','map','video','locked'].map(t=>`<option${m.type===t?' selected':''}>${t}</option>`).join('');
  showEditModal(`<h3>Edit Media Item #${i+1}</h3>
    <div class="edit-field"><label>Upload File (optional — auto-sets type)</label><input type="file" id="em_file" onchange="handleMediaUpload(this)"></div>
    <div class="edit-field"><label>File URL</label><input id="em_url" value="${m.fileUrl||''}" placeholder="/media/lab/filename.pdf"></div>
    <div class="edit-field-row">
      <div class="edit-field" style="flex:.25"><label>Icon</label><input id="em_ico" value="${m.icon}"></div>
      <div class="edit-field"><label>File Name</label><input id="em_name" value="${m.name}"></div>
    </div>
    <div class="edit-font-row"><div class="edit-field"><label>Name Font</label>${fontSelect('em_font',m.nameFont||'')}</div><div class="edit-field"><label>Desc Font</label>${fontSelect('em_dfont',m.descFont||'')}</div></div>
    <div class="edit-field"><label>Description</label><textarea id="em_desc">${m.desc}</textarea></div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="em_font_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply fonts to all media items</span></label>
    <div class="edit-field-row">
      <div class="edit-field"><label>Category</label><select id="em_type">${typeOpts}</select></div>
      <div class="edit-field"><label>Unlock Key (locked files only)</label><input id="em_key" value="${m.unlockKey||''}" placeholder="Leave blank = any key works"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteMediaItem(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveMediaItem(${i})">Save</button></div>`);
}
function saveMediaItem(i){mediaItems[i].icon=document.getElementById('em_ico').value.trim();mediaItems[i].name=document.getElementById('em_name').value.trim();mediaItems[i].desc=document.getElementById('em_desc').value.trim();mediaItems[i].type=document.getElementById('em_type').value;const urlVal=document.getElementById('em_url').value.trim();mediaItems[i].fileUrl=pendingMediaFileUrl||(urlVal==='[uploaded file]'?mediaItems[i].fileUrl:urlVal);mediaItems[i].unlockKey=document.getElementById('em_key').value.trim();const nf=document.getElementById('em_font').value;const df=document.getElementById('em_dfont').value;mediaItems[i].nameFont=nf;mediaItems[i].descFont=df;if(document.getElementById('em_font_all').checked)mediaItems.forEach(m=>{m.nameFont=nf;m.descFont=df});pendingMediaFileUrl='';hideEditModal();renderMedia();renderGrid()}
function deleteMediaItem(i){mediaItems.splice(i,1);hideEditModal();renderMedia();renderGrid()}
function addMediaItem(){
  pendingMediaFileUrl='';
  showEditModal(`<h3>Add New Media Item</h3>
    <div class="edit-field"><label>Upload File (optional — auto-sets type)</label><input type="file" id="em_file" onchange="handleMediaUpload(this)"></div>
    <div class="edit-field"><label>File URL</label><input id="em_url" value="" placeholder="/media/lab/filename.pdf"></div>
    <div class="edit-field-row">
      <div class="edit-field" style="flex:.25"><label>Icon</label><input id="em_ico" value="📄"></div>
      <div class="edit-field"><label>File Name</label><input id="em_name" value=""></div>
    </div>
    <div class="edit-font-row"><div class="edit-field"><label>Name Font</label>${fontSelect('em_font','')}</div><div class="edit-field"><label>Desc Font</label>${fontSelect('em_dfont','')}</div></div>
    <div class="edit-field"><label>Description</label><textarea id="em_desc"></textarea></div>
    <div class="edit-field-row">
      <div class="edit-field"><label>Category</label><select id="em_type"><option>audio</option><option selected>doc</option><option>map</option><option>video</option><option>locked</option></select></div>
      <div class="edit-field"><label>Unlock Key (locked files only)</label><input id="em_key" value="" placeholder="Leave blank = any key works"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewMediaItem()">Add Item</button></div>`);
}
function saveNewMediaItem(){const urlVal=document.getElementById('em_url').value.trim();mediaItems.push({icon:document.getElementById('em_ico').value.trim()||'📄',name:document.getElementById('em_name').value.trim(),desc:document.getElementById('em_desc').value.trim(),type:document.getElementById('em_type').value,fileUrl:pendingMediaFileUrl||(urlVal==='[uploaded file]'?'':urlVal),unlockKey:document.getElementById('em_key').value.trim(),nameFont:document.getElementById('em_font').value,descFont:document.getElementById('em_dfont').value});pendingMediaFileUrl='';hideEditModal();renderMedia();renderGrid()}

// ══════ TIMER ══════
let timerSec=5325,timerPaused=false,timerOriginal=5325;
function togglePause(){timerPaused=!timerPaused;document.getElementById('pauseBtn').textContent=timerPaused?'▶ RESUME':'⏸ PAUSE';document.getElementById('cTimer').classList.toggle('paused',timerPaused)}
function setNewTime(){const v=document.getElementById('timerInput').value.trim();const parts=v.split(':');if(parts.length===3){timerSec=parseInt(parts[0])*3600+parseInt(parts[1])*60+parseInt(parts[2]);timerOriginal=timerSec;renderTimer()}else if(parts.length===2){timerSec=parseInt(parts[0])*60+parseInt(parts[1]);timerOriginal=timerSec;renderTimer()}}
function resetTimer(){timerSec=timerOriginal;timerPaused=false;document.getElementById('pauseBtn').textContent='⏸ PAUSE';document.getElementById('cTimer').classList.remove('paused');renderTimer()}
function renderTimer(){const h=Math.floor(timerSec/3600),m=Math.floor((timerSec%3600)/60),s=timerSec%60;document.getElementById('cTimer').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
function tickTimer(){if(timerPaused||timerSec<=0)return;timerSec--;renderTimer()}
setInterval(tickTimer,1000);
// Initial dynamic renders
renderGrid();
renderIntelForm();
buildRegForm();
updateLandingForMode();
// Apply stored fonts
if(operationFont){document.getElementById('vaultTitle').style.fontFamily=getFontFamily(operationFont);document.getElementById('consoleTitle').style.fontFamily=getFontFamily(operationFont)}
if(vaultSubFont)document.getElementById('vaultSubtitle').style.fontFamily=getFontFamily(vaultSubFont);
</script>
</body>
</html>
