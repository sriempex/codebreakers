<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>Operation Dead Drop — Console</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Chakra+Petch:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&family=Saira:wght@400;500;600;700&family=Oxanium:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&family=Russo+One&family=Exo+2:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Teko:wght@400;500;600;700&family=Play:wght@400;700&family=Audiowide&family=Press+Start+2P&family=VT323&family=Silkscreen&family=Major+Mono+Display&family=Nova+Mono&family=Aldrich&family=Electrolize&family=Michroma&family=Quantico:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<style>
  :root{--green:#00ff88;--green-dim:rgba(0,255,136,.4);--green-glow:rgba(0,255,136,.12);--red:#ff3333;--amber:#ffaa33;--cyan:#00d4ff;--steel-light:#4a4e54;--steel-dark:#22252a;--bg-deep:#08090b;--bg-panel:#10121a;--bg-surface:#171a24;--border:#252830;--op-font:inherit;--fc-vault:inherit;--fc-feed-cap:inherit;--fc-media-name:inherit;--fc-media-desc:inherit}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg-deep);overflow:visible;width:100vw;height:100vh;font-family:'Chakra Petch',sans-serif;font-weight:500;color:#ccc;user-select:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation;overscroll-behavior:none}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#2a2d35;border-radius:2px}

  .screen{position:fixed;inset:0;transition:opacity .3s;opacity:0;pointer-events:none;z-index:1;will-change:opacity;transform:translateZ(0)}
  .screen.active{opacity:1;pointer-events:all;z-index:10}
  #grainCanvas{position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:.03;image-rendering:pixelated;image-rendering:crisp-edges}

  /* ══════ REGISTRATION ══════ */
  #regScreen{display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 30%,rgba(0,255,136,.02) 0%,transparent 60%),linear-gradient(180deg,#0c0d10,#070809)}
  #regScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:2}
  .reg-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;max-width:580px;padding:20px}
  .reg-title{font-family:'Staatliches',cursive;font-size:18px;letter-spacing:2px;color:#e0f0e8;text-transform:uppercase}
  .reg-subtitle{font-family:'Chakra Petch',sans-serif;font-size:12px;letter-spacing:4px;color:#999;font-weight:600;text-transform:uppercase;margin-top:-8px}
  .reg-panel{position:relative;width:100%;background:linear-gradient(175deg,#262930,#1c1e24 40%,#141620);border:1px solid #3a3d44;border-radius:10px;padding:28px 28px 24px;box-shadow:0 0 0 1px rgba(255,255,255,.015),0 2px 0 #0a0a0a,0 4px 0 #1a1a1a,0 25px 60px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.03)}
  .reg-crt{border-radius:5px;padding:20px 18px;position:relative;overflow:visible;margin-bottom:12px;max-height:60vh;overflow-y:auto;
    background:linear-gradient(180deg,#020604,#040a06,#030805);
    border:1px solid #1a2a1e;
    box-shadow:inset 0 0 30px rgba(0,0,0,.8),inset 0 0 60px rgba(0,20,8,.3),0 1px 0 rgba(255,255,255,.03);
  }
  .reg-crt-inner{position:relative;z-index:1}
  .reg-crt .reg-section-title{color:var(--green);border-bottom-color:rgba(0,255,136,.12);text-shadow:0 0 10px rgba(0,255,136,.2)}
  .reg-crt .reg-field label{color:rgba(0,255,136,.5);font-size:10px;letter-spacing:2.5px}
  .reg-crt .reg-field label.reg-main-label{color:var(--cyan);font-size:11px;letter-spacing:3px;font-weight:700}
  .reg-crt .reg-field input{background:rgba(0,255,136,.03);border-color:rgba(0,255,136,.1);color:var(--green);text-shadow:0 0 6px rgba(0,255,136,.2)}
  .reg-crt .reg-field input:focus{border-color:rgba(0,255,136,.25);box-shadow:0 0 8px rgba(0,255,136,.08)}
  .reg-crt .reg-field input::placeholder{color:rgba(0,255,136,.12)}
  .reg-crt .reg-field select{background:rgba(0,255,136,.03);border-color:rgba(0,255,136,.1);color:var(--green)}
  .reg-crt .reg-member-block{background:rgba(0,255,136,.015);border-color:rgba(0,255,136,.06)}
  .reg-crt .reg-member-label{color:var(--cyan);border-bottom-color:rgba(0,212,255,.06)}
  .reg-crt .reg-err{color:var(--red);text-shadow:0 0 6px rgba(255,51,51,.2)}
  .reg-section{margin-bottom:22px}
  .reg-section-title{font-family:'Saira',sans-serif;font-size:11px;font-weight:700;letter-spacing:4px;color:var(--green);text-transform:uppercase;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid rgba(0,255,136,.15);text-shadow:0 0 12px rgba(0,255,136,.15)}
  .reg-row{display:flex;gap:12px;margin-bottom:10px}
  .reg-field{flex:1;display:flex;flex-direction:column;gap:4px}
  .reg-field.full{flex:none;width:100%}
  .reg-field label{font-family:'Saira',sans-serif;font-size:11px;color:#ccc;font-weight:700;letter-spacing:2px;text-transform:uppercase}
  .reg-field input{background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#e0e0e0;font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:1px;outline:none;transition:border-color .2s}
  .reg-field input:focus{border-color:var(--green-dim);box-shadow:0 0 8px rgba(0,255,136,.06)}
  .reg-field select{background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#e0e0e0;font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:1px;outline:none;transition:border-color .2s;width:100%}
  .reg-field select:focus{border-color:var(--green-dim)}
  .reg-field input::placeholder{color:#444}
  .reg-member-block{background:rgba(0,255,136,.02);border:1px solid rgba(0,255,136,.08);border-radius:6px;padding:16px;margin-bottom:12px}
  .reg-member-label{font-family:'Saira',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,212,255,.08)}
  .reg-member-num{width:24px;height:24px;border-radius:50%;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.2);display:flex;align-items:center;justify-content:center;font-family:'Oxanium',sans-serif;font-weight:700;font-size:10px;color:var(--cyan)}

  /* Back / Cancel links — integrated into panels */
  .login-back-link{text-align:center;margin-top:16px;cursor:pointer;transition:opacity .2s}
  .login-back-link span{font-family:'Saira',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;color:#666;text-transform:uppercase;transition:color .2s}
  .login-back-link:hover span{color:#aaa}
  .reg-err{font-family:'Chakra Petch',sans-serif;font-size:12px;color:var(--red);min-height:16px;text-align:center;font-weight:600;margin:4px 0}

  /* Team ID reveal */
  #regSuccess{display:none;text-align:center}
  #regSuccess.active{display:block}
  #regForm.hidden{display:none}
  .reg-id-display{background:#080a10;border:2px solid rgba(0,255,136,.2);border-radius:6px;padding:20px;margin:20px 0;position:relative}
  .reg-id-label{font-family:'Oxanium',sans-serif;font-weight:700;font-size:10px;letter-spacing:3px;color:#999;text-transform:uppercase;margin-bottom:8px}
  .reg-id-value{font-family:'Oxanium',sans-serif;font-weight:700;font-size:26px;letter-spacing:8px;color:#d0f0d8;-webkit-user-select:text;user-select:text}
  .reg-id-note{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#aaa;line-height:1.8;margin:16px 0;font-weight:500}
  .reg-id-warn{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#f0c878;letter-spacing:1px;margin-bottom:16px;font-weight:600}
  .reg-proceed{width:100%;background:linear-gradient(180deg,#1a3a2a,#0f2a1a);border:1px solid rgba(0,255,136,.3);color:#d0f0d8;font-family:'Saira',sans-serif;font-size:13px;letter-spacing:4px;padding:14px;cursor:pointer;border-radius:5px;transition:all .2s;text-transform:uppercase;font-weight:700}
  .reg-proceed:hover{background:rgba(0,255,136,.1);box-shadow:0 0 25px rgba(0,255,136,.12)}

  /* Registration & login close buttons use .mv-close */


  /* ══════ LANDING PAGE ══════ */
  #landingScreen{display:flex;align-items:center;justify-content:center;
    background:
      radial-gradient(ellipse at 50% 20%,rgba(0,255,136,.015) 0%,transparent 50%),
      radial-gradient(ellipse at 20% 80%,rgba(0,212,255,.01) 0%,transparent 40%),
      radial-gradient(ellipse at 80% 60%,rgba(255,51,136,.008) 0%,transparent 40%),
      linear-gradient(180deg,#050607,#080a0c,#050607);
    overflow:hidden}
  #landingScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.03) 3px,rgba(0,0,0,.03) 6px);pointer-events:none;z-index:2}
  #landingScreen::after{content:'';position:absolute;top:-2px;left:0;right:0;height:2px;background:rgba(0,255,136,.06);z-index:3;animation:scanDown 8s linear infinite;box-shadow:0 0 15px rgba(0,255,136,.04)}
  @keyframes scanDown{0%{top:-2px}100%{top:100%}}
  /* Circuit board SVG background */
  .landing-circuits{position:absolute;inset:0;z-index:1;overflow:visible;opacity:.35}
  .landing-circuits svg{position:absolute;width:100%;height:100%}

  .landing-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;max-width:520px;width:90%;padding:40px 0}

  .landing-banner{width:180px;height:180px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#1a2a1a,#0a150a);
    border:2px solid rgba(0,255,136,.12);
    display:flex;align-items:center;justify-content:center;margin-bottom:24px;
    box-shadow:0 0 40px rgba(0,255,136,.04),0 0 80px rgba(0,255,136,.015),inset 0 0 30px rgba(0,0,0,.5);
    position:relative;overflow:visible;animation:fadeUp .8s ease both}
  .landing-banner::before{content:'';position:absolute;inset:0;border-radius:50%;
    background:conic-gradient(from 0deg,transparent 0%,rgba(0,255,136,.02) 25%,transparent 50%,rgba(0,255,136,.02) 75%,transparent 100%);
    animation:rotateSlow 20s linear infinite}
  @keyframes rotateSlow{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  .landing-banner-icon{font-size:64px;filter:drop-shadow(0 0 20px rgba(0,255,136,.15));z-index:1;position:relative}
  .landing-banner-img{width:100%;height:100%;object-fit:cover;border-radius:50%;z-index:1;position:relative;display:none}

  .landing-title{font-family:'Staatliches',cursive;font-size:26px;letter-spacing:3px;color:#b0e8cc;text-transform:uppercase;text-align:center;
    animation:breatheLanding 4s ease infinite,fadeUp .8s ease .15s both;margin-bottom:4px}
  @keyframes breatheLanding{0%,100%{text-shadow:0 0 15px rgba(0,255,136,.1),0 0 30px rgba(0,255,136,.03)}50%{text-shadow:0 0 25px rgba(0,255,136,.18),0 0 50px rgba(0,255,136,.06)}}
  .landing-subtitle{font-family:'Chakra Petch',sans-serif;font-size:12px;letter-spacing:4px;color:#8a8a8a;font-weight:600;text-transform:uppercase;text-align:center;animation:fadeUp .8s ease .3s both;margin-bottom:40px}

  .landing-actions{display:flex;flex-direction:column;gap:14px;width:100%;align-items:center;animation:fadeUp .8s ease .45s both}
  .landing-login-btn{padding:16px 60px;border-radius:6px;cursor:pointer;transition:all .3s;
    font-family:'Saira',sans-serif;font-size:15px;letter-spacing:6px;color:#d0f0e0;text-transform:uppercase;font-weight:700;text-align:center;
    background:linear-gradient(180deg,#1a3a2a,#0f2a1a);
    border:1px solid rgba(0,255,136,.25);
    box-shadow:0 0 20px rgba(0,255,136,.04),0 4px 15px rgba(0,0,0,.4)}
  .landing-login-btn:hover{background:linear-gradient(180deg,#1f4a32,#143520);border-color:rgba(0,255,136,.4);
    box-shadow:0 0 30px rgba(0,255,136,.08),0 6px 20px rgba(0,0,0,.5);transform:translateY(-2px)}
  .landing-login-btn:active{transform:translateY(0);box-shadow:0 0 15px rgba(0,255,136,.03),0 2px 8px rgba(0,0,0,.4)}

  /* Landing footer */
  .landing-footer{position:absolute;bottom:16px;left:0;right:0;text-align:center;z-index:5;animation:fadeUp .8s ease .6s both}
  .landing-footer span{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#666;letter-spacing:1.5px;font-weight:500}

  /* Banner upload button (admin) */
  .landing-banner-upload{position:absolute;bottom:-8px;right:-8px;width:28px;height:28px;border-radius:50%;background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.3);display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .2s;font-size:12px;color:var(--cyan)}
  .landing-banner-upload:hover{background:rgba(0,212,255,.25);border-color:rgba(0,212,255,.5)}
  body.admin-mode .landing-banner-upload{display:flex}
  .save-blip{display:inline-block;font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--green);opacity:0;transition:opacity .2s;margin-left:8px;font-weight:600;vertical-align:middle;pointer-events:none}
  .save-blip.show{opacity:1}
  .banner-preview{width:72px;height:72px;flex-shrink:0;border-radius:50%;overflow:visible;border:1px solid var(--border);background:#080a10;display:flex;align-items:center;justify-content:center;margin:4px 0}
  .banner-preview img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .banner-preview .bp-emoji{font-size:26px}
  .focal-point-container{position:relative;width:100%;max-width:280px;aspect-ratio:1;overflow:visible;border:1px solid var(--border);border-radius:4px;background:#080a10;cursor:crosshair;margin:8px 0}
  .focal-point-container img{width:100%;height:100%;object-fit:cover}
  .focal-point-marker{position:absolute;width:24px;height:24px;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;box-shadow:0 0 0 1px rgba(0,0,0,.5),0 0 8px rgba(0,0,0,.5),inset 0 0 0 1px rgba(0,0,0,.3)}
  .focal-point-marker::before{content:'';position:absolute;inset:9px;background:#fff;border-radius:50%;box-shadow:0 0 4px rgba(255,255,255,.8)}
  .focal-point-crosshair{position:absolute;inset:0;pointer-events:none}
  .focal-point-crosshair::before,.focal-point-crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.2)}
  .focal-point-crosshair::before{width:1px;height:100%;left:50%;top:0}
  .focal-point-crosshair::after{height:1px;width:100%;top:50%;left:0}
  #landingBannerFile{display:none}

  /* Admin Choice Modal */
  #adminChoiceModal{position:fixed;inset:0;z-index:8500;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #adminChoiceModal.active{opacity:1;pointer-events:all}
  .admin-choice-box{width:380px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .admin-choice-box h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--cyan);text-transform:uppercase;margin-bottom:8px}
  .admin-choice-box p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#888;margin-bottom:24px;font-weight:500}
  .admin-choice-btns{display:flex;gap:12px;justify-content:center}

  /* Admin View-as-Team toggle — now in dropdown */
  /* Team View mode — hides all admin edit affordances */
  .reg-type-choice{display:flex;gap:12px;width:100%;margin-bottom:16px}
  .reg-type-btn{flex:1;padding:16px;background:rgba(255,255,255,.01);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .2s;text-align:center}
  .reg-type-btn:hover{border-color:rgba(0,255,136,.15)}
  .reg-type-btn.selected{border-color:rgba(0,255,136,.25);background:rgba(0,255,136,.03)}
  .reg-type-btn .rtype-icon{font-size:24px;margin-bottom:6px}
  .reg-type-btn .rtype-label{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:#888;text-transform:uppercase;font-weight:600}
  .reg-type-btn.selected .rtype-label{color:var(--green)}

  /* Vault rate limit overlay */
  .v-rate-limit{position:absolute;inset:0;background:rgba(0,0,0,.92);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;z-index:10;opacity:0;pointer-events:none;transition:opacity .3s}
  .v-rate-limit.active{opacity:1;pointer-events:all}
  .v-rate-limit-text{font-family:'Saira',sans-serif;font-size:11px;letter-spacing:3px;color:var(--red);text-transform:uppercase;font-weight:700}
  .v-rate-limit-timer{font-family:'IBM Plex Mono',monospace;font-size:36px;color:var(--red);letter-spacing:4px;font-weight:700;text-shadow:0 0 20px rgba(255,50,50,.4)}
  .v-rate-limit-sub{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;color:#555;margin-top:4px}
  .v-rate-limit-bar{width:200px;height:2px;background:#1a1a1a;border-radius:1px;overflow:visible;margin-top:8px}
  .v-rate-limit-fill{height:100%;background:var(--red);box-shadow:0 0 6px rgba(255,50,50,.3);transition:width .15s linear}

  /* ══════ LOGIN ══════ */
  #loginScreen{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#050607,#080a0c,#050607)}
  #loginScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.04) 2px,rgba(0,0,0,.04) 4px);pointer-events:none;z-index:2}
  .login-container{position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;gap:20px}
  .login-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:2px;color:#b0e8cc;text-transform:uppercase}
  .login-subtitle{font-family:'Chakra Petch',sans-serif;font-size:11px;letter-spacing:4px;color:#8a8a8a;font-weight:600;text-transform:uppercase;margin-top:-12px}
  .login-panel{position:relative;width:420px;border-radius:8px;padding:28px 24px 20px;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.007) 1px,rgba(255,255,255,.007) 2px,transparent 2px,transparent 4px),
      repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(255,255,255,.004) 60px,rgba(255,255,255,.004) 61px),
      linear-gradient(175deg,#22252c 0%,#1a1c22 20%,#141620 50%,#111318 80%,#0e1014 100%);
    border:1px solid #3a3d44;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.04),inset 0 -1px 0 rgba(0,0,0,.3),0 2px 0 #0a0a0c,0 4px 0 #151518,0 8px 0 #0a0a0c,0 30px 70px rgba(0,0,0,.9)}
  /* ══════ UNIFIED LOGIN CRT ══════ */
  .login-led{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;background:#2a2a2a;box-shadow:inset 0 1px 2px rgba(0,0,0,.6);z-index:10;transition:all .3s}
  .login-led.active{background:#ffaa33;box-shadow:0 0 6px rgba(255,170,51,.5),inset 0 1px 2px rgba(0,0,0,.2);animation:ledFlash .8s ease-in-out infinite}
  .login-led.granted{background:#00ff88;box-shadow:0 0 8px rgba(0,255,136,.6),inset 0 1px 2px rgba(0,0,0,.2);animation:none}
  .login-led.denied{background:#ff3333;box-shadow:0 0 8px rgba(255,51,51,.6);animation:ledFlash .3s ease-in-out 3}
  @keyframes ledFlash{0%,100%{opacity:1}50%{opacity:.3}}
  .login-crt-unified{border-radius:5px;padding:20px 18px;position:relative;overflow:visible;margin-bottom:12px;
    background:linear-gradient(180deg,#020604,#040a06,#030805);
    border:1px solid #1a2a1e;
    box-shadow:inset 0 0 30px rgba(0,0,0,.8),inset 0 0 60px rgba(0,20,8,.3),0 1px 0 rgba(255,255,255,.03);
  }
  .login-crt-scanlines{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,0,0,.15) 1px,rgba(0,0,0,.15) 2px);pointer-events:none;z-index:2}
  .login-crt-inner{position:relative;z-index:1}
  .login-crt-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(0,255,136,.3);text-transform:uppercase;display:block;margin-bottom:6px}
  .login-crt-field{width:100%;background:transparent;border:none;outline:none;padding:8px 0;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:18px;letter-spacing:5px;text-transform:uppercase;text-align:center;text-shadow:0 0 8px rgba(0,255,136,.4),0 0 20px rgba(0,255,136,.15);caret-color:var(--green)}
  .login-crt-field::placeholder{color:rgba(0,255,136,.12);text-transform:none;letter-spacing:2px;font-size:12px;text-shadow:none}
  .login-crt-field[type="password"]{text-transform:none;letter-spacing:3px}
  .login-crt-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,136,.12),transparent);margin:10px 0}
  .login-crt-status{min-height:18px;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--green);text-align:center;text-shadow:0 0 6px rgba(0,255,136,.3);margin-top:4px}
  .login-crt-status.authenticating{animation:crtPulse 1.2s ease-in-out infinite}
  .login-crt-status.granted{color:#0f6;text-shadow:0 0 12px rgba(0,255,136,.5);font-weight:700}
  .login-crt-status.denied{color:var(--red);text-shadow:0 0 12px rgba(255,51,51,.4)}
  .login-crt-spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(0,255,136,.2);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
  @keyframes crtPulse{0%,100%{opacity:1}50%{opacity:.6}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  .login-err{font-family:'Chakra Petch',sans-serif;font-size:11px;color:var(--red);min-height:14px;text-align:center;font-weight:600;margin-bottom:4px}
  .login-btn-row{display:flex;gap:8px;margin-top:4px}
  .login-hw-btn{flex:1;height:46px;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;
    border-bottom:3px solid #0a0a0e;border-right:2px solid #101014;
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06);
    transition:all .05s ease;border-top:none;border-left:none;outline:none}
  .login-hw-btn::before{content:'';position:absolute;inset:1px;border-radius:3px;border:1px solid rgba(0,255,136,.04);pointer-events:none}
  .login-hw-btn::after{content:'';position:absolute;top:1px;left:15%;right:15%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);border-radius:50%;pointer-events:none}
  .login-hw-btn:active{transform:translateY(2px);border-bottom-width:1px;border-right-width:1px;box-shadow:0 0 2px rgba(0,0,0,.4)}
  .login-hw-btn span{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;letter-spacing:2px;pointer-events:none;text-shadow:0 1px 1px rgba(0,0,0,.6)}
  .login-hw-btn.enter-key{flex:2;
    background:linear-gradient(180deg,rgba(20,60,35,.5) 0%,rgba(12,40,24,.6) 50%,rgba(8,30,18,.7) 100%);
    border-color:rgba(0,255,136,.12);border-bottom-color:#0a1a10}
  .login-hw-btn.enter-key::before{border-color:rgba(0,255,136,.12)}
  .login-hw-btn.enter-key span{color:var(--green);text-shadow:0 0 6px rgba(0,255,136,.2)}
  .login-hw-btn.enter-key:hover{background:linear-gradient(180deg,rgba(25,70,40,.5) 0%,rgba(15,50,28,.6) 50%,rgba(10,35,22,.7) 100%)}
  .login-hw-btn.esc-key{flex:1;
    background:linear-gradient(180deg,rgba(60,40,15,.5) 0%,rgba(40,26,10,.6) 50%,rgba(28,18,8,.7) 100%);
    border-color:rgba(255,170,51,.12);border-bottom-color:#1a1208}
  .login-hw-btn.esc-key::before{border-color:rgba(255,170,51,.1)}
  .login-hw-btn.esc-key span{color:var(--amber);font-size:10px;text-shadow:0 0 6px rgba(255,170,51,.2)}
  .login-hw-btn.esc-key:hover{background:linear-gradient(180deg,rgba(70,48,18,.5) 0%,rgba(50,32,12,.6) 50%,rgba(35,22,10,.7) 100%)}
  .upload-spinner{width:24px;height:24px;border:2px solid rgba(255,170,51,.2);border-top-color:var(--amber);border-radius:50%;animation:btnSpin .6s linear infinite;margin:0 auto}
  @keyframes btnSpin{to{transform:rotate(360deg)}}
  .login-register-link{font-family:'Chakra Petch',sans-serif;font-size:13px;color:#aaa;cursor:pointer;transition:color .2s;padding:16px 0 0;letter-spacing:.5px;text-align:center}
  .login-register-link:hover{color:var(--cyan)}
  .login-register-link span.lrl-action{color:var(--cyan);text-decoration:underline;text-underline-offset:3px;font-weight:600}
  /* Panel blip buttons — hardware-style close/back/cancel on panel edge */
  .panel-blip{position:absolute;top:-1px;right:20px;z-index:10;padding:5px 14px;border-radius:0 0 4px 4px;cursor:pointer;transition:all .25s;
    background:linear-gradient(180deg,#1a1c22,#12141a);
    border:1px solid #3a3d44;border-top:none;
    box-shadow:0 2px 6px rgba(0,0,0,.4),inset 0 -1px 0 rgba(255,255,255,.02);
  }
  .panel-blip span{font-family:'Saira',sans-serif;font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#555;transition:color .25s,text-shadow .25s}
  .panel-blip:hover{background:linear-gradient(180deg,#22242c,#1a1c24);border-color:#4a4d55}
  .panel-blip:hover span{color:#aaa;text-shadow:0 0 6px rgba(255,255,255,.1)}
  .panel-blip::before{content:'';position:absolute;top:4px;left:6px;width:4px;height:4px;border-radius:50%;background:#f44;box-shadow:0 0 6px rgba(255,60,60,.4);animation:blipPulse 1.5s ease-in-out infinite;transition:all .25s}
  .panel-blip:hover::before{background:#f44;box-shadow:0 0 8px rgba(255,60,60,.6);animation:none}
  .screen-back-link{position:absolute;top:12px;left:14px;z-index:10;font-family:'Saira',sans-serif;font-size:11px;font-weight:600;letter-spacing:1.5px;color:#666;cursor:pointer;transition:color .2s;padding:4px 0}
  .screen-back-link:hover{color:#aaa}
  @keyframes blipPulse{0%,100%{opacity:.4;box-shadow:0 0 3px rgba(255,60,60,.2)}50%{opacity:1;box-shadow:0 0 8px rgba(255,60,60,.6)}}

  /* ══════ VAULT PUZZLE (in-console) ══════ */
  .vault-puzzle-layout{display:flex;flex-direction:column;align-items:center;gap:24px;max-width:500px;margin:0 auto}
  .vault-keypad-section{width:420px;max-width:100%}
  .vault-unlock-section{width:420px;max-width:100%;padding:0}
  .vault-unlock-header{display:flex;align-items:center;justify-content:space-between;padding:0 0 10px;border-bottom:1px solid rgba(0,255,136,.08);margin-bottom:0}
  .vault-unlock-title{font-family:'Saira',sans-serif;font-size:12px;color:#d0e8d8;letter-spacing:3px;font-weight:700;text-transform:uppercase}
  .vault-unlock-count{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#888;letter-spacing:1px;text-transform:uppercase}
  .vault-unlock-list{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .vault-unlock-empty{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#555;line-height:1.8;font-weight:500;text-align:center;padding:20px 16px}
  .vault-unlock-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid rgba(0,255,136,.1);border-radius:4px;background:rgba(0,255,136,.02)}
  .vault-unlock-item.locked{border-color:var(--border);background:rgba(255,255,255,.01);opacity:.85}
  .vault-unlock-item .vui-icon{font-size:16px;flex-shrink:0}
  .vault-unlock-item .vui-info{flex:1;min-width:0}
  .vault-unlock-item .vui-label{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#ddd;font-weight:600;letter-spacing:.5px}
  .vault-unlock-item .vui-desc{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#999;letter-spacing:.5px;margin-top:2px}
  .vault-unlock-item .vui-status{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;font-weight:600;flex-shrink:0}
  .vault-unlock-item .vui-status.unlocked{color:var(--green)}
  .vault-unlock-item .vui-status.locked{color:#999}
  .vui-media-link{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--cyan);letter-spacing:1px;cursor:pointer;margin-top:4px;transition:color .2s}
  .vui-media-link:hover{color:#fff;text-decoration:underline}
  .vui-classified{font-family:'IBM Plex Mono',monospace!important;letter-spacing:2px!important;color:#bbb!important;font-size:11px!important}
  .vui-classified-sub{font-family:'IBM Plex Mono',monospace!important;letter-spacing:1px!important;color:#888!important;font-size:9px!important}
  .vui-admin-hint{font-family:'IBM Plex Mono',monospace;font-size:8px;color:rgba(255,170,51,.5);letter-spacing:1px;margin-top:3px}
  @media(max-width:768px){
    .vault-keypad-section{width:100%;max-width:420px}
    .vault-unlock-section{width:100%;max-width:420px}
  }

  /* Panel — cold zinc/steel with brushed texture */
  .vault-panel{position:relative;width:420px;max-width:100%;border-radius:8px;padding:28px 24px 20px;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.007) 1px,rgba(255,255,255,.007) 2px,transparent 2px,transparent 4px),
      repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(255,255,255,.004) 60px,rgba(255,255,255,.004) 61px),
      linear-gradient(175deg,#22252c 0%,#1a1c22 20%,#141620 50%,#111318 80%,#0e1014 100%);
    border:1px solid #3a3d44;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.04),
      inset 0 -1px 0 rgba(0,0,0,.3),
      0 2px 0 #0a0a0c,
      0 4px 0 #151518,
      0 8px 0 #0a0a0c,
      0 30px 70px rgba(0,0,0,.9);
  }

  /* Mounting screws — hex bolt style */
  .rv{position:absolute;width:14px;height:14px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#5a5a5a 0%,#3a3a3a 40%,#252525 100%);
    border:1px solid #1a1a1a;
    box-shadow:inset 0 1px 2px rgba(255,255,255,.08),inset 0 -1px 1px rgba(0,0,0,.5),0 2px 4px rgba(0,0,0,.6)}
  .rv::before{content:'';position:absolute;top:3px;left:3px;right:3px;bottom:3px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#4a4a4a,#2a2a2a);border:1px solid #333}
  .rv::after{content:'⬡';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:6px;color:#1e1e1e;line-height:1}
  .rv-1{top:7px;left:7px}.rv-2{top:7px;right:7px}.rv-3{bottom:7px;left:7px}.rv-4{bottom:7px;right:7px}

  /* Display — CRT glass with scanlines and phosphor glow */
  .v-display{width:100%;min-height:82px;border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:18px;position:relative;overflow:visible;padding:12px 16px;
    background:linear-gradient(180deg,#020604,#040a06,#030805);
    border:1px solid #1a2a1e;
    box-shadow:
      inset 0 0 20px rgba(0,0,0,.8),
      inset 0 0 40px rgba(0,20,8,.3),
      0 1px 0 rgba(255,255,255,.03),
      0 0 1px rgba(0,255,136,.15);
  }
  /* CRT scanlines */
  .v-display::before{content:'';position:absolute;inset:0;
    background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,0,0,.2) 1px,rgba(0,0,0,.2) 2px);
    pointer-events:none;z-index:2}
  /* Screen curvature highlight */
  .v-display::after{content:'';position:absolute;inset:0;
    background:radial-gradient(ellipse at 50% 0%,rgba(0,255,136,.03) 0%,transparent 60%);
    pointer-events:none;z-index:1}
  /* Glitch flash */
  .v-display.glitch{animation:dispGlitch .15s ease}
  @keyframes dispGlitch{
    0%{filter:brightness(1)}
    25%{filter:brightness(1.8) hue-rotate(10deg)}
    50%{filter:brightness(.6)}
    75%{filter:brightness(1.4)}
    100%{filter:brightness(1)}
  }

  #vDisp{font-family:var(--fc-vault,'IBM Plex Mono',monospace);font-weight:600;color:var(--green);font-size:22px;letter-spacing:6px;z-index:3;flex-shrink:0;
    text-shadow:0 0 8px rgba(0,255,136,.4),0 0 20px rgba(0,255,136,.15);animation:flick 5s infinite}
  #vCursor{display:inline-block;width:2px;height:20px;background:var(--green);margin-left:4px;vertical-align:middle;animation:blink .8s step-end infinite;box-shadow:0 0 6px rgba(0,255,136,.4);z-index:3}
  .v-disp-row{display:flex;align-items:center;justify-content:center;z-index:3;flex-shrink:0}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  @keyframes flick{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.75}94%{opacity:1}96%{opacity:.85}97%{opacity:1}}

  /* Keys — glass + bevel physicality */
  .kb-row{display:flex;justify-content:center;gap:4px;margin-bottom:4px;max-width:380px;margin-left:auto;margin-right:auto}
  .kb-key{flex:1;height:42px;padding:0;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;
    background:linear-gradient(180deg,rgba(60,63,70,.6) 0%,rgba(40,42,48,.7) 50%,rgba(28,30,35,.8) 100%);
    border:1px solid rgba(255,255,255,.06);
    border-bottom:3px solid #0a0a0e;
    border-right:2px solid #101014;
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06);
    transition:all .05s ease}
  /* Glass edge highlight */
  .kb-key::before{content:'';position:absolute;inset:1px;border-radius:3px;border:1px solid rgba(0,255,136,.04);pointer-events:none}
  /* Top shine */
  .kb-key::after{content:'';position:absolute;top:1px;left:15%;right:15%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);border-radius:50%;pointer-events:none}
  /* Pressed state — sinks */
  .kb-key:active{transform:translateY(2px);border-bottom-width:1px;border-right-width:1px;
    box-shadow:0 0 2px rgba(0,0,0,.4);
    background:linear-gradient(180deg,rgba(35,37,42,.8) 0%,rgba(25,27,32,.9) 100%)}
  .kb-key:active::before{border-color:rgba(0,255,136,.08)}
  .kb-key span{color:#c8c8c8;font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:500;pointer-events:none;text-shadow:0 1px 1px rgba(0,0,0,.6)}
  /* Hover */
  .kb-key:hover{background:linear-gradient(180deg,rgba(70,73,80,.6) 0%,rgba(50,52,58,.7) 50%,rgba(35,37,42,.8) 100%);border-color:rgba(255,255,255,.1)}
  .kb-key:hover::before{border-color:rgba(0,255,136,.08)}
  /* Function keys */
  .kb-key.fn{background:linear-gradient(180deg,rgba(40,42,50,.6) 0%,rgba(26,28,34,.7) 50%,rgba(18,20,26,.8) 100%);border-color:rgba(255,255,255,.04);flex:1.4}
  .kb-key.fn span{font-size:10px;letter-spacing:1px;color:#999}
  /* Enter key — green tint glass */
  .kb-key.enter-key{
    background:linear-gradient(180deg,rgba(20,60,35,.5) 0%,rgba(12,40,24,.6) 50%,rgba(8,30,18,.7) 100%);
    border-color:rgba(0,255,136,.12);border-bottom-color:#0a1a10}
  .kb-key.enter-key::before{border-color:rgba(0,255,136,.12)}
  .kb-key.enter-key span{color:var(--green);font-size:11px;letter-spacing:1px;font-weight:700;text-shadow:0 0 6px rgba(0,255,136,.2)}
  .kb-key.del-key span{color:var(--red)}
  .kb-key.sym-key{flex:1.2}
  .kb-key.sym-key span{color:var(--amber);font-size:9px;letter-spacing:1px}
  .kb-key.clr-key span{color:var(--amber)}

  /* Status — LED + label */
  .v-status{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.03)}
  .v-dot{width:8px;height:8px;border-radius:50%;
    background:radial-gradient(circle at 40% 35%,#ff6644,#cc2211);
    box-shadow:0 0 6px rgba(255,50,50,.5),0 0 12px rgba(255,50,50,.2);
    animation:ledPulse 2s ease-in-out infinite}
  @keyframes ledPulse{0%,100%{opacity:1;box-shadow:0 0 6px rgba(255,50,50,.5),0 0 12px rgba(255,50,50,.2)}50%{opacity:.5;box-shadow:0 0 3px rgba(255,50,50,.3)}}
  .v-dot.ok{background:radial-gradient(circle at 40% 35%,#44ff88,#00cc44);box-shadow:0 0 6px rgba(0,255,136,.5),0 0 12px rgba(0,255,136,.2);animation:none}
  .v-lbl{color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;font-weight:600}
  .v-lbl.ok{color:var(--green)}
  .v-tries{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;text-align:center;min-height:14px;font-weight:700;transition:color .3s;text-transform:uppercase;z-index:3;margin-top:4px}
  .v-tries.plenty{color:#44aa88}
  .v-tries.warning{color:var(--amber)}
  .v-tries.critical{color:var(--red)}
  
  .v-tries.warn{color:var(--amber)}
  .v-tries.crit{color:var(--red)}
  .v-lockout{text-align:center;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--red);margin-top:6px;min-height:18px;font-weight:600}

  /* ══════ VAULT OPEN ══════ */
  #vaultOpenOverlay{position:fixed;inset:0;z-index:9000;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s}
  #vaultOpenOverlay.active{opacity:1;pointer-events:all}
  .vo-text{font-family:'Staatliches',cursive;font-size:30px;color:var(--green);letter-spacing:12px;opacity:0;transform:scale(.9);transition:all .8s;text-align:center;padding-left:12px}
  .vo-text.show{opacity:1;transform:scale(1)}
  .vo-sub{font-size:14px;font-family:'Saira',sans-serif;letter-spacing:4px;color:#ccc;margin-top:15px;font-weight:600;opacity:0;transition:opacity .6s ease .5s;text-align:center;text-shadow:0 0 10px rgba(255,255,255,.1)}
  .vo-sub.show{opacity:1}
  .vo-bar{width:300px;height:4px;background:#151515;border-radius:2px;margin-top:30px;overflow:visible;opacity:0;transition:opacity .4s ease .8s;position:relative}
  .vo-bar.show{opacity:1}
  .vo-fill{width:0;height:100%;background:var(--green);box-shadow:0 0 8px var(--green);transition:width 2s ease}
  .vo-fill.go{width:100%}
  .vo-pct{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--green);letter-spacing:3px;margin-top:12px;opacity:0;transition:opacity .4s ease .8s}
  .vo-pct.show{opacity:1}

  /* ══════ CONSOLE ══════ */
  #consoleScreen{display:flex;flex-direction:column;position:relative;height:100vh;
    /* Brighter slate-blue base for office lighting */
    background:linear-gradient(180deg, #182634 0%, #1c2b3a 15%, #16222f 50%, #121c27 85%, #0f1822 100%);
  }
  /* Brushed zinc streaks */
  #consoleScreen::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
    background:
      repeating-linear-gradient(0deg,
        transparent, transparent 1px,
        rgba(255,255,255,.005) 1px, rgba(255,255,255,.005) 2px,
        transparent 2px, transparent 4px
      ),
      repeating-linear-gradient(90deg,
        transparent, transparent 60px,
        rgba(255,255,255,.003) 60px, rgba(255,255,255,.003) 61px
      ),
      linear-gradient(135deg,
        rgba(255,255,255,.004) 0%, transparent 30%,
        rgba(255,255,255,.003) 50%, transparent 70%,
        rgba(255,255,255,.002) 100%
      );
  }
  /* Vignette — tight, dark edges */
  #consoleScreen::after{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
    /* Softer vignette so panels stay readable in daylight */
    background:radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(0,0,0,.38) 100%);
  }
  /* Subtle world map background */
  .console-worldmap{position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.12;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 500'%3E%3Cellipse cx='500' cy='250' rx='480' ry='240' fill='none' stroke='%23ffffff' stroke-width='.5'/%3E%3Cellipse cx='500' cy='250' rx='320' ry='240' fill='none' stroke='%23ffffff' stroke-width='.3'/%3E%3Cellipse cx='500' cy='250' rx='160' ry='240' fill='none' stroke='%23ffffff' stroke-width='.3'/%3E%3Cline x1='20' y1='250' x2='980' y2='250' stroke='%23ffffff' stroke-width='.3'/%3E%3Cline x1='500' y1='10' x2='500' y2='490' stroke='%23ffffff' stroke-width='.3'/%3E%3Cellipse cx='500' cy='250' rx='480' ry='80' fill='none' stroke='%23ffffff' stroke-width='.2'/%3E%3Cellipse cx='500' cy='250' rx='480' ry='160' fill='none' stroke='%23ffffff' stroke-width='.2'/%3E%3Ccircle cx='200' cy='180' r='35' fill='%23ffffff' opacity='.15'/%3E%3Ccircle cx='190' cy='140' r='20' fill='%23ffffff' opacity='.12'/%3E%3Ccircle cx='160' cy='160' r='15' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='520' cy='160' rx='80' ry='55' fill='%23ffffff' opacity='.12'/%3E%3Cellipse cx='600' cy='140' rx='50' ry='30' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='680' cy='180' rx='40' ry='50' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='560' cy='220' rx='35' ry='25' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='530' cy='280' rx='20' ry='40' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='260' cy='270' rx='30' ry='55' fill='%23ffffff' opacity='.1'/%3E%3Cellipse cx='750' cy='340' rx='25' ry='20' fill='%23ffffff' opacity='.08'/%3E%3Cellipse cx='780' cy='300' rx='40' ry='25' fill='%23ffffff' opacity='.06'/%3E%3Cellipse cx='350' cy='170' rx='15' ry='12' fill='%23ffffff' opacity='.08'/%3E%3C/svg%3E") no-repeat center center;
    background-size:90% auto;
  }

  /* Topbar — steel header strip */
  .console-topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0;position:relative;z-index:50;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 3px),
      linear-gradient(180deg,#0c0e12,#060810);
    border-bottom:1px solid rgba(255,255,255,.04);
    box-shadow:0 2px 10px rgba(0,0,0,.5),0 1px 0 rgba(255,255,255,.015)}
  .console-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:2px;color:#b0e8cc;text-transform:uppercase}
  .timer-block{text-align:center;position:absolute;left:50%;transform:translateX(-50%);padding-bottom:4px}
  .timer-digits{font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:22px;color:#ff6655;letter-spacing:4px}
  .timer-digits.is-infinity{font-size:38px;letter-spacing:2px}
  .timer-digits.paused{color:var(--amber);animation:ledPulse 1s infinite}
  .timer-label{font-family:'Saira',sans-serif;font-size:9px;color:#888;letter-spacing:3px;font-weight:600;text-transform:uppercase;margin-top:3px;position:relative;top:-3px}
  body.config-hydrating .timer-digits,body.config-hydrating .timer-label{opacity:0}
  .topbar-identity{position:relative;cursor:pointer;display:flex;align-items:center}
  body.admin-mode .team-card-section{display:none}
  body.admin-mode .team-card-notifs{display:none}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .team-card-section{display:block!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .team-card-notifs{display:block!important}
  .console-team{font-family:'Saira',sans-serif;font-size:13px;color:var(--cyan);letter-spacing:2.5px;font-weight:600;transition:color .2s;padding:6px 14px;border:1px solid rgba(0,212,255,.25);border-radius:3px;background:rgba(0,212,255,.04);display:inline-flex;align-items:center;line-height:1;box-sizing:border-box;height:28px}
  .console-team:hover{color:#b0e8cc;border-color:rgba(0,212,255,.3)}
  .team-chevron{font-size:18px;color:#555;margin-left:6px;transition:color .2s;line-height:1}
  .topbar-identity:hover .team-chevron{color:#999}
  body.admin-mode .console-team{display:none}
  .team-notif-badge{position:absolute;top:-6px;right:-8px;min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-family:'IBM Plex Mono',monospace;font-size:8px;font-weight:700;display:none;align-items:center;justify-content:center;padding:0 4px;box-shadow:0 0 8px rgba(255,50,50,.4);animation:ledPulse 2s ease-in-out infinite;z-index:5}
  .team-notif-badge.has-notifs{display:flex}
  .team-card-notifs{border-top:1px solid rgba(255,255,255,.06);padding-top:8px}
  .team-card-notif-list{max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
  .team-card-notif-item{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#aaa;padding:5px 8px;background:rgba(255,255,255,.02);border-radius:3px;border-left:2px solid var(--amber)}
  .team-card-logout{display:flex;align-items:center;gap:6px;padding:10px 12px;margin-top:8px;border-top:1px solid rgba(255,255,255,.06);cursor:pointer;transition:all .2s}
  .team-card-logout span{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;color:var(--red);font-weight:600;text-transform:uppercase}
  .team-card-logout:hover{background:rgba(255,50,50,.05)}
  .team-card-notif-item .notif-time{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;margin-right:6px}
  .notif-voice-row{display:inline-flex;align-items:center;gap:8px}
  .notif-play-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.2);color:var(--cyan);font-size:9px;cursor:pointer;transition:all .2s}
  .notif-play-btn:hover{background:rgba(0,212,255,.2);border-color:rgba(0,212,255,.4)}
  .notif-clear-link{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;cursor:pointer;letter-spacing:.5px;transition:color .2s}
  .notif-clear-link:hover{color:var(--red)}

  /* Team splash card — glass panel */
  .team-card{position:absolute;top:100%;right:0;margin-top:10px;width:280px;border-radius:6px;padding:0;z-index:100;opacity:0;pointer-events:none;transform:translateY(-6px);transition:all .25s ease;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(175deg,#141620,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 12px 40px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.02)}
  .team-card.open{opacity:1;pointer-events:all;transform:translateY(0)}
  .team-card-header{padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,.04)}
  .team-card-name{font-family:'Staatliches',cursive;font-size:15px;color:#b0e8cc;letter-spacing:2px;text-transform:uppercase}
  .team-card-id{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#666;font-weight:500;letter-spacing:2px;margin-top:4px}
  .team-card-body{padding:12px 16px}
  .team-card-section{margin-bottom:12px}
  .team-card-section:last-child{margin-bottom:0}
  .team-card-label{font-family:'Saira',sans-serif;font-size:9px;color:#888;font-weight:600;letter-spacing:3px;text-transform:uppercase;margin-bottom:6px}
  .team-card-member{display:flex;align-items:center;gap:8px;margin-bottom:5px}
  .team-card-avatar{width:22px;height:22px;border-radius:50%;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--green);font-family:'Oxanium',sans-serif;font-weight:700}
  .team-card-mname{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#ddd;font-weight:600;letter-spacing:1px}
  .team-card-stats{display:flex;gap:12px}
  .team-card-stat{flex:1;background:rgba(255,255,255,.015);border:1px solid rgba(255,255,255,.04);border-radius:4px;padding:8px;text-align:center}
  .team-card-stat-val{font-family:'IBM Plex Mono',monospace;font-size:14px;color:var(--green);font-weight:700}
  .team-card-stat-lbl{font-family:'Saira',sans-serif;font-size:8px;color:#999;font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-top:3px}

  /* Console grid */
  .console-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:clamp(14px,2.5vh,28px);padding:clamp(14px,2.5vh,28px);min-height:0;align-content:center;position:relative;z-index:1}

  /* ── CRT Monitor Bezel ── */
  .crt-monitor{position:relative;border-radius:18px;cursor:pointer;transition:all .35s cubic-bezier(.25,.46,.45,.94);
    /* Thick metallic bezel */
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.006) 1px,rgba(255,255,255,.006) 2px,transparent 2px,transparent 4px),
      linear-gradient(170deg,#1e2028 0%,#16181e 30%,#111318 60%,#0c0e14 100%);
    padding:clamp(8px,1.2vh,14px);
    border:1px solid rgba(255,255,255,.04);
    box-shadow:
      0 4px 20px rgba(0,0,0,.5),
      0 10px 50px rgba(0,0,0,.3),
      inset 0 1px 0 rgba(255,255,255,.04),
      inset 0 -1px 0 rgba(0,0,0,.4);
  }
  .crt-monitor:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.6),0 14px 60px rgba(0,0,0,.3),0 0 40px rgba(0,255,136,.015),inset 0 1px 0 rgba(255,255,255,.05)}

  /* Bezel screws */
  .crt-screw{position:absolute;width:10px;height:10px;border-radius:50%;
    background:radial-gradient(circle at 38% 32%,#4a4a4a 0%,#2a2a2a 60%,#1a1a1a 100%);
    border:1px solid #111;
    box-shadow:inset 0 1px 1px rgba(255,255,255,.06),0 1px 3px rgba(0,0,0,.5)}
  .crt-screw::after{content:'+';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:6px;color:#1a1a1a;line-height:1}
  .crt-screw.s1{top:5px;left:5px}.crt-screw.s2{top:5px;right:5px}.crt-screw.s3{bottom:5px;left:5px}.crt-screw.s4{bottom:5px;right:5px}

  /* Power LED */
  .crt-led{display:none}

  /* ── CRT Screen (inner content area) ── */
  .crt-screen{position:relative;border-radius:8px;overflow:visible;
    background:linear-gradient(170deg,rgba(10,12,18,.95) 0%,rgba(6,8,12,.98) 60%,rgba(4,5,8,1));
    border:1px solid rgba(0,255,136,.06);
    box-shadow:
      inset 0 2px 8px rgba(0,0,0,.6),
      inset 0 0 20px rgba(0,0,0,.3),
      0 0 1px rgba(0,255,136,.1);
    /* Subtle CRT curvature via perspective */
    transform:perspective(800px) rotateX(.5deg);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:clamp(20px,3.5vh,40px) clamp(14px,2vw,24px) clamp(16px,2.8vh,32px)}
  /* Screen curvature highlight — glass bulge */
  .crt-screen::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:3;
    background:
      radial-gradient(ellipse at 50% 30%,rgba(255,255,255,.02) 0%,transparent 50%),
      radial-gradient(ellipse at 50% 50%,rgba(0,255,136,.01) 0%,transparent 60%)}
  /* Scanlines */
  .crt-screen::after{content:'';position:absolute;inset:0;pointer-events:none;z-index:4;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px)}

  /* Green border glow on hover */
  .crt-monitor:hover .crt-screen{border-color:rgba(0,255,136,.15);
    box-shadow:inset 0 2px 8px rgba(0,0,0,.6),inset 0 0 20px rgba(0,0,0,.3),0 0 8px rgba(0,255,136,.06),0 0 20px rgba(0,255,136,.02)}

  /* ── Tile content inside screen ── */
  .tile-glow{position:absolute;top:25%;left:50%;transform:translate(-50%,-50%);width:100px;height:100px;background:radial-gradient(circle,rgba(0,255,136,.02) 0%,transparent 70%);pointer-events:none;transition:all .4s}
  .crt-monitor:hover .tile-glow{width:160px;height:160px;background:radial-gradient(circle,rgba(0,255,136,.05) 0%,transparent 70%)}
  .tile-icon{font-size:clamp(42px,5.5vh,48px);margin-bottom:clamp(14px,2vh,20px);position:relative;z-index:2;filter:grayscale(.3) brightness(.85);transition:filter .3s,transform .3s}
  .crt-monitor:hover .tile-icon{filter:grayscale(0) brightness(1);transform:scale(1.06)}
  .tile-label{font-family:'Saira',sans-serif;font-weight:700;font-size:clamp(16px,2vh,18px);letter-spacing:clamp(3px,.4vw,4px);color:#c8c8c8;text-transform:uppercase;text-align:center;margin-bottom:clamp(7px,1vh,10px);z-index:2;text-shadow:0 2px 3px rgba(0,0,0,.7)}
  .tile-sub{font-family:'Chakra Petch',sans-serif;font-size:clamp(11px,1.3vh,12px);color:#777;letter-spacing:1px;font-weight:500;text-align:center;margin-bottom:clamp(16px,2vh,22px);z-index:2}
  .tile-badge{font-family:'Saira',sans-serif;font-size:clamp(10px,1.2vh,11px);letter-spacing:3px;font-weight:700;color:#e0e0e0;border:1px solid rgba(255,255,255,.1);padding:clamp(5px,.7vh,6px) clamp(14px,1.4vw,18px);border-radius:3px;margin-bottom:clamp(12px,1.6vh,16px);z-index:2;background:rgba(255,255,255,.04)}
  .tile-badge.amber{color:#f0c878;border-color:rgba(255,170,51,.2);background:rgba(255,170,51,.05)}
  .tile-badge.crimson{color:#e8667a;border-color:rgba(204,68,85,.25);background:rgba(204,68,85,.06)}
  .tile-badge.violet{color:#b088ee;border-color:rgba(153,119,221,.25);background:rgba(153,119,221,.06)}
  .tile-status{display:flex;align-items:center;gap:7px;z-index:2}
  .tile-status span{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:3px;font-weight:500;text-transform:uppercase}
  /* LED dots */
  .tile-dot{width:6px;height:6px;border-radius:50%}
  .tile-dot.active{background:radial-gradient(circle at 40% 35%,#44ff88,#00cc44);box-shadow:0 0 6px rgba(0,255,136,.5);animation:ledPulse 1s ease-in-out infinite}
  .tile-dot.idle{background:radial-gradient(circle at 40% 35%,#ffaa33,#cc8800);box-shadow:0 0 4px rgba(204,136,0,.4);animation:ledPulse 2.5s ease-in-out infinite}
  .tile-dot.silent{background:#3a3d44;box-shadow:none;animation:ledPulse 6s ease-in-out infinite}
  .tile-status-label.active{color:#00ff88}
  .tile-status-label.idle{color:#cc8800}
  .tile-status-label.silent{color:#3a3d44}
  /* Admin edit btn repositioned for monitor */
  .crt-monitor .admin-edit-btn{top:4px;right:4px;z-index:10}
  /* Force edit buttons visible above ALL theme effects in admin mode */
  body.admin-mode:not(.player-preview) .crt-monitor{clip-path:none!important;overflow:hidden!important}
  body.admin-mode:not(.player-preview) .crt-monitor .admin-edit-btn{z-index:20}

  /* ══════ CONSOLE GRID THEMES ══════ */
  /* Theme 1 (crt) = default styles above — no override needed */

  /* Theme 2: Glass Morphism */
  .grid-theme-glass .crt-monitor{border-radius:16px;padding:0;background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.06)}
  .grid-theme-glass .crt-monitor:hover{transform:translateY(-3px);border-color:rgba(0,255,136,.15);box-shadow:0 12px 40px rgba(0,0,0,.4),0 0 30px rgba(0,255,136,.03)}
  .grid-theme-glass .crt-screw,.grid-theme-glass .crt-led{display:none}
  .grid-theme-glass .crt-screen{border-radius:16px;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-glass .crt-screen::before,.grid-theme-glass .crt-screen::after{display:none}
  .grid-theme-glass .tile-glow{display:none}
  .grid-theme-glass .tile-label{color:#e0e0e0;text-shadow:none}

  /* Theme 3: Neon Cyberpunk */
  .grid-theme-cyberpunk .crt-monitor{border-radius:0;padding:0;background:linear-gradient(180deg,#0a0a12,#060610);border:1px solid rgba(0,255,136,.15);clip-path:polygon(0 8px,8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%);box-shadow:0 0 12px rgba(0,255,136,.04)}
  .grid-theme-cyberpunk .crt-monitor::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);opacity:.4;z-index:5}
  .grid-theme-cyberpunk .crt-monitor::after{content:'';position:absolute;bottom:0;right:0;width:2px;height:40%;background:linear-gradient(180deg,transparent,var(--cyan));opacity:.3;z-index:5}
  .grid-theme-cyberpunk .crt-monitor:hover{border-color:rgba(0,255,136,.35);box-shadow:0 0 25px rgba(0,255,136,.1),inset 0 0 30px rgba(0,255,136,.02)}
  .grid-theme-cyberpunk .crt-screw,.grid-theme-cyberpunk .crt-led{display:none}
  .grid-theme-cyberpunk .crt-screen{border-radius:0;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-cyberpunk .crt-screen::before,.grid-theme-cyberpunk .crt-screen::after{display:none}
  .grid-theme-cyberpunk .tile-glow{display:none}
  .grid-theme-cyberpunk .tile-label{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:3px;color:var(--green);text-shadow:0 0 12px rgba(0,255,136,.3)}
  .grid-theme-cyberpunk .tile-sub{color:var(--cyan);opacity:.6}
  .grid-theme-cyberpunk .tile-badge{border-color:rgba(0,255,136,.3);color:var(--green);background:rgba(0,255,136,.06)}
  .grid-theme-cyberpunk .tile-badge.crimson{border-color:rgba(255,51,51,.3);color:var(--red);background:rgba(255,51,51,.06)}
  .grid-theme-cyberpunk .tile-badge.violet{border-color:rgba(0,212,255,.3);color:var(--cyan);background:rgba(0,212,255,.06)}

  /* Theme 4: Military Ops */
  .grid-theme-military .crt-monitor{border-radius:4px;padding:0;background:repeating-linear-gradient(90deg,transparent,transparent 3px,rgba(80,90,60,.03) 3px,rgba(80,90,60,.03) 4px),linear-gradient(180deg,#14160e,#0e100a,#0a0c08);border:2px solid #2a2e1e;box-shadow:inset 0 1px 0 rgba(255,255,255,.03),0 4px 12px rgba(0,0,0,.5)}
  .grid-theme-military .crt-monitor:hover{border-color:#3a4228;box-shadow:inset 0 1px 0 rgba(255,255,255,.04),0 6px 20px rgba(0,0,0,.5),0 0 15px rgba(140,160,80,.04)}
  .grid-theme-military .crt-screw,.grid-theme-military .crt-led{display:none}
  .grid-theme-military .crt-screen{border-radius:2px;background:transparent;border:none;border-top:1px solid rgba(140,160,80,.1);box-shadow:none;transform:none}
  .grid-theme-military .crt-screen::before,.grid-theme-military .crt-screen::after{display:none}
  .grid-theme-military .tile-glow{display:none}
  .grid-theme-military .tile-label{font-family:'Teko',sans-serif;font-size:20px;letter-spacing:6px;color:#a0aa80;font-weight:500}
  .grid-theme-military .tile-sub{color:#6a7050;font-weight:600;letter-spacing:2px}
  .grid-theme-military .tile-badge{border-color:rgba(140,160,80,.25);color:#b0bb88;background:rgba(140,160,80,.06);border-radius:0;font-family:'IBM Plex Mono',monospace}
  .grid-theme-military .tile-badge.crimson{border-color:rgba(180,80,60,.25);color:#cc8866;background:rgba(180,80,60,.06)}
  .grid-theme-military .tile-badge.violet{border-color:rgba(140,160,80,.25);color:#a0aa80;background:rgba(140,160,80,.06)}
  .grid-theme-military .tile-dot.active{background:radial-gradient(circle,#a0cc44,#7a9920)!important;box-shadow:0 0 4px rgba(140,180,40,.4)!important}
  .grid-theme-military .tile-status-label.active{color:#8a9960!important}

  /* Theme 5: Holographic */
  .grid-theme-holo .crt-monitor{border-radius:12px;padding:0;background:linear-gradient(135deg,rgba(0,212,255,.03),rgba(136,0,255,.02),rgba(0,255,136,.02));border:1px solid rgba(255,255,255,.06);box-shadow:0 4px 20px rgba(0,0,0,.3);overflow:hidden}
  .grid-theme-holo .crt-monitor::before{content:'';position:absolute;inset:-50%;background:conic-gradient(from 0deg,transparent,rgba(0,255,136,.03),transparent,rgba(0,212,255,.03),transparent,rgba(180,100,255,.03),transparent);animation:holoSpin 8s linear infinite;z-index:0}
  @keyframes holoSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .grid-theme-holo .crt-monitor:hover{border-color:rgba(0,212,255,.15);transform:translateY(-2px)}
  .grid-theme-holo .crt-screw,.grid-theme-holo .crt-led{display:none}
  .grid-theme-holo .crt-screen{border-radius:12px;background:transparent;border:none;box-shadow:none;transform:none;position:relative;z-index:1}
  .grid-theme-holo .crt-screen::before,.grid-theme-holo .crt-screen::after{display:none}
  .grid-theme-holo .tile-glow{display:none}
  .grid-theme-holo .tile-label{color:#d0e8f0;text-shadow:0 0 20px rgba(0,212,255,.15)}
  .grid-theme-holo .tile-badge{border-color:rgba(0,212,255,.2);border-radius:20px}

  /* Theme 6: Brutalist Tech */
  .grid-theme-brutalist .crt-monitor{border-radius:0;padding:0;background:#0a0a0a;border:2px solid #333;box-shadow:4px 4px 0 #111}
  .grid-theme-brutalist .crt-monitor:hover{border-color:var(--green);box-shadow:6px 6px 0 rgba(0,255,136,.1);transform:translate(-2px,-2px)}
  .grid-theme-brutalist .crt-screw,.grid-theme-brutalist .crt-led{display:none}
  .grid-theme-brutalist .crt-screen{border-radius:0;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-brutalist .crt-screen::before,.grid-theme-brutalist .crt-screen::after{display:none}
  .grid-theme-brutalist .tile-glow{display:none}
  .grid-theme-brutalist .tile-icon{filter:grayscale(1) brightness(.7)}
  .grid-theme-brutalist .crt-monitor:hover .tile-icon{filter:grayscale(0) brightness(1)}
  .grid-theme-brutalist .tile-label{font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:2px;color:#aaa;font-weight:700}
  .grid-theme-brutalist .tile-sub{font-family:'IBM Plex Mono',monospace;color:#555}
  .grid-theme-brutalist .tile-badge{border-radius:0;border:1px solid #555;font-family:'IBM Plex Mono',monospace}

  /* Theme 7: Sleek Minimal */
  .grid-theme-minimal .crt-monitor{border-radius:10px;padding:0;background:rgba(255,255,255,.015);border:1px solid rgba(255,255,255,.04);box-shadow:none}
  .grid-theme-minimal .crt-monitor:hover{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08);transform:translateY(-2px)}
  .grid-theme-minimal .crt-screw,.grid-theme-minimal .crt-led{display:none}
  .grid-theme-minimal .crt-screen{border-radius:10px;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-minimal .crt-screen::before,.grid-theme-minimal .crt-screen::after{display:none}
  .grid-theme-minimal .tile-glow{display:none}
  .grid-theme-minimal .tile-icon{font-size:36px}
  .grid-theme-minimal .tile-label{font-family:'Exo 2',sans-serif;font-weight:600;font-size:14px;letter-spacing:3px;color:#ddd}
  .grid-theme-minimal .tile-sub{color:#555}
  .grid-theme-minimal .tile-badge{border-color:rgba(255,255,255,.06);background:transparent}

  /* Theme 8: HUD Overlay */
  .grid-theme-hud .crt-monitor{border-radius:2px;padding:0;background:linear-gradient(180deg,rgba(0,255,136,.015),transparent 20%,transparent 80%,rgba(0,255,136,.01)),linear-gradient(180deg,#060810,#040608);border:1px solid rgba(0,255,136,.1);overflow:hidden}
  .grid-theme-hud .crt-monitor::before{content:'';position:absolute;top:4px;left:4px;width:14px;height:14px;border-top:1px solid rgba(0,255,136,.3);border-left:1px solid rgba(0,255,136,.3);z-index:5;pointer-events:none}
  .grid-theme-hud .crt-monitor::after{content:'';position:absolute;bottom:4px;right:4px;width:14px;height:14px;border-bottom:1px solid rgba(0,255,136,.3);border-right:1px solid rgba(0,255,136,.3);z-index:5;pointer-events:none}
  .grid-theme-hud .crt-monitor:hover{border-color:rgba(0,255,136,.25);box-shadow:0 0 20px rgba(0,255,136,.06)}
  .grid-theme-hud .crt-screw,.grid-theme-hud .crt-led{display:none}
  .grid-theme-hud .crt-screen{border-radius:0;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-hud .crt-screen::before{display:none}
  .grid-theme-hud .crt-screen::after{content:'';position:absolute;top:-2px;left:0;right:0;height:1px;background:rgba(0,255,136,.06);animation:scanDown 5s linear infinite;box-shadow:0 0 8px rgba(0,255,136,.03)}
  .grid-theme-hud .tile-glow{display:none}
  .grid-theme-hud .tile-label{font-family:'Electrolize',sans-serif;font-size:13px;letter-spacing:3px;color:rgba(0,255,136,.7)}
  .grid-theme-hud .tile-sub{color:rgba(0,255,136,.3)}
  .grid-theme-hud .tile-badge{border-color:rgba(0,255,136,.15);color:rgba(0,255,136,.6);background:rgba(0,255,136,.03)}
  .grid-theme-hud .tile-badge.crimson{border-color:rgba(255,51,51,.2);color:rgba(255,80,80,.6);background:rgba(255,51,51,.03)}
  .grid-theme-hud .tile-badge.violet{border-color:rgba(0,212,255,.2);color:rgba(0,212,255,.6);background:rgba(0,212,255,.03)}

  /* Theme 9: Card Stack */
  .grid-theme-cards .crt-monitor{border-radius:14px;padding:0;background:linear-gradient(170deg,#161820,#101218 50%,#0c0e14);border:1px solid rgba(255,255,255,.05);box-shadow:0 2px 4px rgba(0,0,0,.3),0 8px 24px rgba(0,0,0,.2)}
  .grid-theme-cards .crt-monitor::before{content:'';position:absolute;left:6px;right:6px;bottom:-4px;height:8px;border-radius:0 0 12px 12px;background:linear-gradient(180deg,rgba(16,18,24,.8),rgba(10,12,16,.5));border:1px solid rgba(255,255,255,.03);border-top:none;z-index:-1}
  .grid-theme-cards .crt-monitor::after{content:'';position:absolute;left:12px;right:12px;bottom:-7px;height:6px;border-radius:0 0 10px 10px;background:rgba(10,12,16,.4);border:1px solid rgba(255,255,255,.02);border-top:none;z-index:-2}
  .grid-theme-cards .crt-monitor:hover{transform:translateY(-4px);box-shadow:0 4px 8px rgba(0,0,0,.3),0 16px 40px rgba(0,0,0,.25)}
  .grid-theme-cards .crt-screw,.grid-theme-cards .crt-led{display:none}
  .grid-theme-cards .crt-screen{border-radius:14px;background:transparent;border:none;box-shadow:none;transform:none}
  .grid-theme-cards .crt-screen::before,.grid-theme-cards .crt-screen::after{display:none}
  .grid-theme-cards .tile-glow{display:none}
  .grid-theme-cards .tile-label{font-family:'Rajdhani',sans-serif;font-size:18px;letter-spacing:3px;font-weight:600;color:#ddd}
  .grid-theme-cards .tile-badge{border-radius:20px;padding:4px 14px}

  /* Theme 10: Terminal */
  .grid-theme-terminal .crt-monitor{border-radius:0;padding:0;background:#020604;border:1px solid rgba(0,255,136,.12);box-shadow:inset 0 0 30px rgba(0,0,0,.5);overflow:hidden}
  .grid-theme-terminal .crt-monitor::after{content:'';position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,255,136,.015) 1px,rgba(0,255,136,.015) 2px);z-index:0}
  .grid-theme-terminal .crt-monitor:hover{border-color:rgba(0,255,136,.3);box-shadow:inset 0 0 30px rgba(0,0,0,.5),0 0 15px rgba(0,255,136,.06)}
  .grid-theme-terminal .crt-screw,.grid-theme-terminal .crt-led{display:none}
  .grid-theme-terminal .crt-screen{border-radius:0;background:transparent;border:none;box-shadow:none;transform:none;position:relative;z-index:1}
  .grid-theme-terminal .crt-screen::before,.grid-theme-terminal .crt-screen::after{display:none}
  .grid-theme-terminal .tile-glow{display:none}
  .grid-theme-terminal .tile-icon{font-size:32px;filter:brightness(1.1) saturate(.6)}
  .grid-theme-terminal .tile-label{font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;color:var(--green);text-shadow:0 0 8px rgba(0,255,136,.2);font-weight:600}
  .grid-theme-terminal .tile-sub{color:rgba(0,255,136,.3);font-family:'IBM Plex Mono',monospace}
  .grid-theme-terminal .tile-badge{border-color:rgba(0,255,136,.15);color:rgba(0,255,136,.5);background:transparent;border-radius:0;font-family:'IBM Plex Mono',monospace}
  .grid-theme-terminal .tile-badge.crimson{border-color:rgba(0,255,136,.15);color:rgba(0,255,136,.4);background:transparent}
  .grid-theme-terminal .tile-badge.violet{border-color:rgba(0,255,136,.15);color:rgba(0,255,136,.4);background:transparent}
  .grid-theme-terminal .tile-dot.active{background:var(--green)!important}
  .grid-theme-terminal .tile-status-label.active{color:rgba(0,255,136,.5)!important}

  /* ══════ EXPANDED OVERLAY ══════ */
  #panelOverlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #panelOverlay.active{opacity:1;pointer-events:all}
  .expanded-panel{width:92vw;height:88vh;border-radius:6px;display:none;flex-direction:column;overflow:visible;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#0e1018,#0a0c12,#080a0e);
    border:1px solid rgba(255,255,255,.05);
    box-shadow:0 25px 100px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.02)}
  .expanded-panel.visible{display:flex}
  .exp-header{height:56px;display:flex;align-items:center;padding:0 24px;gap:14px;flex-shrink:0;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 3px),
      linear-gradient(180deg,#141620,#0c0e14);
    border-bottom:1px solid rgba(255,255,255,.04);
    box-shadow:0 2px 10px rgba(0,0,0,.4)}
  .exp-title{font-family:'Staatliches',cursive;font-size:17px;letter-spacing:3px;color:#d0f0e0;text-transform:uppercase}
  .panel-icon{font-size:16px}
  .exp-close{margin-left:auto;border-radius:4px;cursor:pointer;transition:all .2s;
    background:rgba(255,50,50,.06);
    border:1px solid rgba(255,50,50,.2);border-bottom:2px solid rgba(255,50,50,.1);
    color:var(--red);font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;padding:7px 18px;font-weight:600;
    text-shadow:0 0 6px rgba(255,50,50,.2)}
  .exp-close:hover{border-color:rgba(255,50,50,.45);background:rgba(255,50,50,.12);text-shadow:0 0 12px rgba(255,50,50,.4);box-shadow:0 0 14px rgba(255,50,50,.1)}
  .exp-body{flex:1;overflow-y:auto;padding:20px}

  /* Feed — view modes */
  .feed-count-badge{font-family:'Saira',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--green);text-transform:uppercase;padding:4px 10px;border:1px solid rgba(0,255,136,.15);border-radius:3px;background:rgba(0,255,136,.06);white-space:nowrap;margin-left:10px}
  .feed-count-badge:empty{display:none}
  .feed-view-toggle{display:flex;gap:4px;flex-shrink:0;margin-right:10px}
  .feed-view-btn{border-radius:4px;padding:5px 12px;text-align:center;cursor:pointer;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;color:#666;font-weight:700;transition:background .15s,color .15s,border-color .15s;text-transform:uppercase;white-space:nowrap;line-height:1;
    background:linear-gradient(180deg,rgba(30,32,38,.5),rgba(20,22,28,.6));
    border:1px solid rgba(255,255,255,.04);border-bottom:2px solid #08080c}
  .feed-view-btn.active{color:#b0e8cc;border-color:rgba(0,255,136,.1);border-bottom-color:rgba(0,255,136,.2);background:linear-gradient(180deg,rgba(15,40,25,.4),rgba(10,30,18,.5))}
  .feed-view-btn:hover{border-color:rgba(255,255,255,.08);color:#aaa}

  /* Feed header centering + no layout shift */
  #expFeed .exp-header{position:relative}
  #expFeed #feedViewToggle{position:absolute;left:50%;transform:translateX(-50%);margin-right:0}
  #expFeed #feedCloseBtn{min-width:110px;text-align:center}
  /* Keep grid comfortably within viewport (show 2 rows / 6 posts without scroll on typical screens) */
  #expFeed .exp-body{padding:14px;display:flex;flex-direction:column;overflow:hidden}
  #expFeed .feed-expanded{max-width:min(900px, calc((88vh - 140px) * 1.5));margin:0 auto;flex:1}

  .feed-expanded{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,minmax(0,1fr));gap:3px;max-width:900px;margin:0 auto;height:100%;align-content:stretch}
  /* Feed cards: keep width the same, let image area stretch vertically to fill available height */
  .feed-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;overflow:visible;cursor:pointer;transition:all .2s;position:relative;touch-action:pan-y;display:flex;flex-direction:column}
  .feed-card-img{flex:1;min-height:0;overflow:visible;aspect-ratio:auto}
  .feed-card-img img{width:100%;height:100%;object-fit:cover}

  .feed-card:hover{border-color:var(--green-dim);box-shadow:0 6px 20px rgba(0,0,0,.3)}
  .feed-card-img{width:100%;display:flex;align-items:center;justify-content:center;font-size:40px;background-size:cover;background-position:center;position:relative;min-height:120px}
  .feed-card-img img{width:100%;display:block;pointer-events:none;-webkit-user-drag:none;user-select:none}
  .feed-card-img{aspect-ratio:1;overflow:hidden}
  .feed-card-img img{width:100%;height:100%;object-fit:cover}
  /* Anti-download: prevent right-click save, drag, long-press */
  .feed-card-img,.feed-single-img,.mv-image-viewer{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;pointer-events:auto}
  .feed-card-img img{pointer-events:none;-webkit-user-drag:none;user-select:none}
  .feed-single-img .no-download-shield{pointer-events:none}
  .no-download-shield{position:absolute;inset:0;z-index:2;-webkit-user-select:none;user-select:none;pointer-events:none}
  /* Feed video in grid */
  .feed-card-video{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
  /* Feed video in single view */
  .feed-single-video{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;border-radius:5px}
  /* Mute toggle button (IG-style) */
  .feed-mute-btn{position:absolute;bottom:12px;right:12px;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:5;font-size:12px;
    background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);color:#fff;transition:all .2s;backdrop-filter:blur(4px)}
  .feed-mute-btn:hover{background:rgba(0,0,0,.8);border-color:rgba(255,255,255,.3)}
  /* Video indicator on grid thumbnails */
  .feed-video-badge{position:absolute;top:8px;left:8px;font-size:8px;letter-spacing:1px;color:#fff;background:rgba(0,0,0,.6);padding:2px 6px;border-radius:2px;font-family:'IBM Plex Mono',monospace;z-index:3}
  .feed-video-play-icon{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:16px;color:rgba(255,255,255,.7);padding-left:3px;transition:all .2s}
  .feed-card:hover .feed-video-play-icon{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.4);color:#fff}
  .feed-card-cap{padding:10px 12px;border-top:1px solid var(--border);display:none}
  .feed-card{border-radius:0;border:none;border-right:1px solid rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.03)}
  .feed-card-cap p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#bbb;font-weight:500;line-height:1.6}

  .feed-single{display:none;flex-direction:column;height:100%;max-width:600px;margin:0 auto;width:100%;overflow:hidden}
  .feed-single.visible{display:flex}
  #feedExpBody.focus-active{display:flex;flex-direction:column;height:100%;overflow:hidden}
  #feedExpBody.focus-active #feedGridView{display:none}
  .feed-single-img{flex:1;min-height:0;background:var(--bg-surface);border:1px solid var(--border);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:72px;background-size:cover;background-position:center;touch-action:none;position:relative;overflow:visible;cursor:pointer}
  .feed-single-img.zoomed{cursor:pointer}
  .feed-single-img.zoomed.dragging{cursor:pointer}
  .feed-single-img .feed-zoom-wrapper{width:100%;height:100%;transform-origin:0 0;will-change:transform;display:flex;align-items:center;justify-content:center}
  .feed-single-img .feed-zoom-wrapper img{width:100%;height:100%;object-fit:contain;-webkit-user-drag:none;user-select:none;pointer-events:none}
  .feed-single-edit{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.7);border:1px solid rgba(0,212,255,.3);color:var(--cyan);font-size:16px;cursor:pointer;z-index:5;transition:all .2s;backdrop-filter:blur(4px)}
  .feed-single-edit:hover{background:rgba(0,212,255,.15);border-color:rgba(0,212,255,.5);box-shadow:0 0 12px rgba(0,212,255,.15)}
  .feed-single-controls{flex-shrink:0;padding:8px 0;z-index:5}
  .feed-single-nav-row{display:flex;align-items:center;justify-content:center;gap:20px}
  .feed-single-counter{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#999;font-weight:600;letter-spacing:2px;min-width:60px;text-align:center}
  .feed-single-cap-zone{flex-shrink:0;height:3.4em;position:relative;overflow:visible}
  .feed-single-caption{height:100%;overflow:visible;position:relative}
  .feed-single-caption{font-family:'Chakra Petch',sans-serif;font-size:14px;color:#ddd;line-height:1.7;font-weight:500;text-align:center;max-width:500px;margin:0 auto}
  .feed-single-caption-more{display:none;position:absolute;bottom:-2px;left:0;right:0;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--cyan);cursor:pointer;opacity:.6;z-index:6;background:linear-gradient(transparent,var(--bg-deep) 40%);padding:6px 0 0}
  .feed-single-caption-more:hover{opacity:1}
  .feed-single-caption-more.visible{display:block}
  .feed-single-cap-overlay{display:none;position:absolute;bottom:0;left:0;right:0;z-index:20;max-height:200px;overflow-y:auto;padding:12px 16px;border-radius:5px 5px 0 0;
    background:rgba(6,8,12,.95);border:1px solid var(--border);border-bottom:none;
    backdrop-filter:blur(8px);box-shadow:0 -4px 20px rgba(0,0,0,.5)}
  .feed-single-cap-overlay.visible{display:block}
  .feed-single-cap-overlay-text{font-family:'Chakra Petch',sans-serif;font-size:14px;color:#ddd;line-height:1.7;font-weight:500;text-align:center}
  .feed-single-cap-overlay-close{text-align:center;margin-top:8px;font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--cyan);cursor:pointer;opacity:.6}
  .feed-single-cap-overlay-close:hover{opacity:1}
  .feed-single-nav{display:flex;gap:15px}
  .feed-nav-btn,.feed-back-grid{cursor:pointer;border-radius:4px;letter-spacing:2px;transition:all .08s;font-weight:600;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));
    border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #0a0a0e;
    color:#888;font-family:'IBM Plex Mono',monospace;font-size:10px;padding:8px 22px}
  .feed-nav-btn:hover,.feed-back-grid:hover{border-color:rgba(0,255,136,.1);color:#b0e8cc}
  .feed-nav-btn:active,.feed-back-grid:active{transform:translateY(1px);border-bottom-width:1px}
  .feed-back-grid{align-self:flex-start}
  .swipe-hint{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#777;font-weight:500;letter-spacing:2px;text-transform:uppercase;display:none}
  @media(max-width:768px){.swipe-hint{display:block}}

  /* Media */
  .media-expanded{display:flex;flex-direction:column;gap:8px;max-width:800px;margin:0 auto}
  .media-exp-item{display:flex;align-items:center;gap:15px;background:var(--bg-surface);border:1px solid var(--border);border-radius:5px;padding:14px 18px;cursor:pointer;transition:border-color .2s;position:relative}

  /* ── Player mode: prevent “admin-like” hand cursor on feed/media lists ── */
  body:not(.admin-mode) .feed-card{cursor:default}
  body:not(.admin-mode) .media-exp-item{cursor:default}
  /* Keep pointer for actual controls inside cards (buttons/links) */
  body:not(.admin-mode) .feed-card button,
  body:not(.admin-mode) .feed-card a,
  body:not(.admin-mode) .media-exp-item button,
  body:not(.admin-mode) .media-exp-item a{cursor:pointer}
  .media-exp-item:hover{border-color:var(--green-dim)}
  /* Evidence Locker — stronger hover highlight + ensure empty list space doesn't show pointer/grab */
  #expMedia .exp-body, #mediaList{cursor:default}
  .media-exp-item:hover{border-color:rgba(0,212,255,.35);background:rgba(0,212,255,.05)}
  .media-exp-item:active{transform:translateY(1px)}

  .media-exp-icon{font-size:22px;flex-shrink:0}
  .media-exp-info{display:flex;flex-direction:column;gap:3px}
  .media-exp-name{font-family:'Chakra Petch',sans-serif;font-size:13px;color:#ddd;font-weight:600;letter-spacing:1px}
  .media-exp-desc{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#aaa;font-weight:500;letter-spacing:1px}
  .media-exp-badge{font-family:'Saira',sans-serif;margin-left:auto;font-size:9px;letter-spacing:2px;font-weight:600;padding:3px 10px;border-radius:2px;text-transform:uppercase}
  .media-exp-badge.audio{color:var(--cyan);border:1px solid rgba(0,212,255,.3)}
  .media-exp-badge.video{color:#ff66aa;border:1px solid rgba(255,102,170,.3)}
  .media-exp-badge.image{color:#b8a1ff;border:1px solid rgba(184,161,255,.35)}
  .media-exp-badge.document{color:#66aaff;border:1px solid rgba(102,170,255,.35)}
  .media-exp-badge.dossier{color:#a78bfa;border:1px solid rgba(167,139,250,.35)}
  .media-exp-badge.doc{color:#66aaff;border:1px solid rgba(102,170,255,.35)}
  .media-exp-badge.map{color:#b8a1ff;border:1px solid rgba(184,161,255,.35)}
  .media-exp-badge.locked{color:#777;border:1px solid #444}
  .media-vault-hatch{position:absolute;inset:0;border-radius:inherit;pointer-events:none;z-index:1;
    background:repeating-linear-gradient(135deg,transparent,transparent 4px,rgba(255,170,51,.04) 4px,rgba(255,170,51,.04) 5px);
    border:1px solid rgba(255,170,51,.15);border-radius:4px}

  /* Intel — Neon Grid */
  .intel-exp-body{display:flex;flex-direction:column;overflow:visible;padding:0!important}
  .intel-scroll-area{flex:1;overflow-y:auto;padding:20px 20px 0;display:flex;flex-direction:column;gap:8px;align-items:center;max-width:100%}
  .intel-expanded,.intel-scroll-area>*{max-width:900px;width:100%}
  #intelForm{display:flex;flex-direction:column;align-items:center;gap:8px}
  .intel-transmit-dock{flex-shrink:0;padding:14px 20px;background:linear-gradient(0deg,rgba(0,0,0,.6) 60%,transparent);border-top:1px solid rgba(0,255,136,.08);display:flex;justify-content:center;align-items:center}
  .intel-transmit-dock::before{content:'';position:absolute;left:0;right:0;top:-20px;height:20px;background:linear-gradient(0deg,rgba(8,9,11,.3),transparent);pointer-events:none}
  .intel-exp-row{display:flex;align-items:center;gap:10px;padding:10px 18px;overflow:visible;position:relative;border-radius:2px;
    border:1px solid rgba(0,255,136,.15);
    background:linear-gradient(180deg,rgba(0,255,136,.01),transparent);
    width:100%;max-width:600px;
    transition:border-color .2s,background .2s,box-shadow .2s;
    cursor:default;
   padding-right:28px;}
  .intel-exp-row:hover{
    border-color:rgba(0,255,136,.38);
    background:linear-gradient(180deg,rgba(0,255,136,.04),rgba(0,255,136,.01));
    box-shadow:0 0 0 1px rgba(0,255,136,.08) inset,0 2px 16px rgba(0,255,136,.04);
  }
  .intel-exp-row:hover .intel-exp-num{color:rgba(0,255,136,.65);}
  .intel-exp-row:hover::before{background:linear-gradient(90deg,rgba(0,255,136,.07),transparent 40%);}
  .intel-exp-row::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,255,136,.03),transparent 30%);pointer-events:none}
  .intel-exp-num{font-family:'Orbitron','Oxanium',sans-serif;font-size:10px;font-weight:700;color:rgba(0,255,136,.35);width:28px;flex-shrink:0}
  .intel-exp-label{font-family:'Chakra Petch',sans-serif;font-size:12px;font-weight:700;color:#8cf0b0;letter-spacing:2px;text-transform:uppercase;width:210px;flex-shrink:0}
  /* Admin tools — positioned in the left padding area of the row */
  .intel-admin-tools{position:absolute;left:0;top:50%;transform:translateY(-50%);display:flex;gap:1px;align-items:center;padding-left:2px;opacity:0;transition:opacity .15s;z-index:2}
  .intel-exp-row:hover .intel-admin-tools{opacity:1}
  .intel-admin-tools .drag-handle{display:flex;align-items:center;justify-content:center;cursor:grab;padding:4px 8px;color:rgba(255,255,255,.7);font-size:14px;letter-spacing:0;user-select:none;-webkit-user-select:none;touch-action:none;border:1px solid rgba(255,255,255,.12);border-radius:6px;background:rgba(255,255,255,.03);box-shadow:0 0 10px rgba(0,212,255,.06)}
  .intel-admin-tools .drag-handle:hover{color:#888}
  .intel-admin-tools .admin-row-edit{display:flex;width:14px;height:14px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.25);border-radius:2px;color:var(--cyan);font-size:7px;cursor:pointer;align-items:center;justify-content:center}
  .intel-admin-tools .admin-row-edit:hover{background:rgba(0,212,255,.25)}
  /* When admin tools show, fade the row number so they don't visually clash */
  .intel-exp-row:hover .intel-exp-num{opacity:.2}
  /* Admin test submit button */
  
  .intel-exp-input{width:240px;flex:none;border-radius:2px;padding:9px 14px;color:#0f8;font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;transition:all .2s;
    background:#040810;
    border:1px solid rgba(0,255,136,.2);
    text-shadow:0 0 6px rgba(0,255,136,.3);
  }
  .intel-exp-input:focus{border-color:rgba(0,255,136,.5);box-shadow:0 0 10px rgba(0,255,136,.08),inset 0 0 15px rgba(0,255,136,.03)}
  .intel-exp-input::placeholder{color:rgba(0,255,136,.1);text-shadow:none}
  .intel-exp-input:disabled{opacity:.35;cursor:not-allowed}
  input,textarea,select,.intel-exp-input{user-select:text;-webkit-user-select:text}
  .intel-select{appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%230f8'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:30px;cursor:pointer}
  .intel-select option{background:#0a0e18;color:#0f8}
  .intel-exp-clear{margin-left:10px;margin-right:6px;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,255,255,.35);font-size:12px;border-radius:6px;transition:all .15s;flex-shrink:0;font-family:'IBM Plex Mono',monospace;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);padding:2px;margin-left:10px;margin-right:0px position:absolute; right:12px;}
  .intel-exp-clear:hover{color:#fff;background:rgba(0,212,255,.08);border-color:rgba(0,212,255,.25)}
  .intel-exp-check{width:20px;height:20px;border-radius:50%;border:1px solid #2a2a2a;display:flex;align-items:center;justify-content:center;font-size:10px;color:#2a2a2a;flex-shrink:0}
  .intel-exp-check.submitted{color:var(--green);border-color:var(--green);background:rgba(0,255,136,.06)}
  .intel-prefix-wrap{width:240px;flex:none;display:flex;align-items:center;border-radius:2px;overflow:visible;transition:all .2s;
    background:#040810;
    border:1px solid rgba(0,255,136,.2)}
  .intel-prefix-wrap:focus-within{border-color:rgba(0,255,136,.5);box-shadow:0 0 10px rgba(0,255,136,.08),inset 0 0 15px rgba(0,255,136,.03)}
  .intel-prefix{color:#0f8;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:700;padding:9px 2px 9px 12px;letter-spacing:2px;flex-shrink:0;opacity:.5;text-shadow:0 0 6px rgba(0,255,136,.3)}
  .intel-prefix-wrap input{flex:1;min-width:0;background:transparent;border:none;padding:9px 14px 9px 4px;color:#0f8;font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;text-shadow:0 0 6px rgba(0,255,136,.3)}
  .intel-prefix-wrap input::placeholder{color:rgba(0,255,136,.1);text-shadow:none}
  .intel-dual-wrap{width:240px;flex:none;display:flex;gap:8px;align-items:center}
  .intel-dual-wrap input{flex:1;min-width:0;width:auto}
  .intel-dual-sep{color:rgba(0,255,136,.25);font-size:10px;letter-spacing:1px;flex-shrink:0}

  /* ══════ INTEL THEME: SLEEK MINIMAL ══════ */
  .intel-theme-minimal .intel-scroll-area{background:#111215!important;border-radius:16px!important;border:1px solid rgba(255,255,255,.04)!important;box-shadow:none!important;padding:4px 28px 0!important}
  .intel-theme-minimal .intel-scroll-area::before,.intel-theme-minimal .intel-scroll-area::after{display:none!important}
  .intel-theme-minimal .intel-exp-row{flex-direction:column!important;align-items:stretch!important;border:none!important;border-radius:0!important;background:transparent!important;padding:0!important;margin-bottom:20px!important;gap:0!important;overflow:visible!important;max-width:100%!important padding-right:28px;}
  .intel-theme-minimal .intel-exp-row::before{display:none!important}
  .intel-theme-minimal .intel-exp-row:hover{background:transparent!important;border-color:transparent!important;box-shadow:none!important}
  .intel-theme-minimal .intel-exp-row:hover .intel-exp-num{opacity:1!important}
  .intel-theme-minimal .intel-exp-num{display:none!important}
  .intel-theme-minimal .intel-exp-label{font-family:'Saira',sans-serif!important;font-size:12px!important;color:#c0c0c0!important;letter-spacing:1.5px!important;font-weight:600!important;text-transform:uppercase!important;width:auto!important;flex-shrink:initial!important;margin-bottom:8px!important}
  .intel-theme-minimal .intel-exp-input{width:100%!important;flex:none!important;background:rgba(255,255,255,.03)!important;border:1px solid rgba(255,255,255,.06)!important;border-radius:8px!important;padding:13px 16px!important;font-family:'Chakra Petch',sans-serif!important;font-size:14px!important;color:#fff!important;text-shadow:none!important;letter-spacing:.5px!important}
  .intel-theme-minimal .intel-exp-input:focus{border-color:rgba(0,255,136,.2)!important;background:rgba(0,255,136,.02)!important;box-shadow:none!important}
  .intel-theme-minimal .intel-exp-input::placeholder{color:rgba(255,255,255,.12)!important;text-shadow:none!important}
  .intel-theme-minimal .intel-prefix-wrap{width:100%!important;flex:none!important;background:rgba(255,255,255,.03)!important;border:1px solid rgba(255,255,255,.06)!important;border-radius:8px!important}
  .intel-theme-minimal .intel-prefix-wrap:focus-within{border-color:rgba(0,255,136,.2)!important;background:rgba(0,255,136,.02)!important;box-shadow:none!important}
  .intel-theme-minimal .intel-prefix{color:#999!important;text-shadow:none!important;font-size:13px!important;font-family:'Chakra Petch',sans-serif!important;opacity:1!important}
  .intel-theme-minimal .intel-prefix-wrap input{color:#fff!important;text-shadow:none!important;font-family:'Chakra Petch',sans-serif!important;font-size:14px!important;letter-spacing:.5px!important}
  .intel-theme-minimal .intel-prefix-wrap input::placeholder{color:rgba(255,255,255,.12)!important;text-shadow:none!important}
  .intel-theme-minimal .intel-select{width:100%!important;flex:none!important;background-color:rgba(255,255,255,.03)!important;border:1px solid rgba(255,255,255,.06)!important;border-radius:8px!important;color:#fff!important;text-shadow:none!important;font-family:'Chakra Petch',sans-serif!important;font-size:14px!important;padding:13px 30px 13px 16px!important}
  .intel-theme-minimal .intel-dual-wrap{width:100%!important;flex:none!important}
  .intel-theme-minimal .intel-dual-wrap input{width:auto!important;flex:1!important;background:rgba(255,255,255,.03)!important;border:1px solid rgba(255,255,255,.06)!important;border-radius:8px!important;color:#fff!important;text-shadow:none!important;font-family:'Chakra Petch',sans-serif!important;font-size:14px!important;letter-spacing:.5px!important;padding:13px 16px!important}
  .intel-theme-minimal .intel-dual-sep{color:#555!important}
  .intel-theme-minimal .intel-exp-clear{margin-left:10px;margin-right:6px;color:rgba(255,255,255,.15)!important position:absolute; right:12px;}
  .intel-theme-minimal .intel-submit-btn{background:#00ff88!important;border:none!important;border-radius:8px!important;color:#000!important;font-family:'Chakra Petch',sans-serif!important;font-size:12px!important;letter-spacing:2px!important;font-weight:700!important;text-shadow:none!important;padding:14px 44px!important}
  .intel-theme-minimal .intel-submit-btn:hover{background:#33ffaa!important;box-shadow:0 0 20px rgba(0,255,136,.2)!important;text-shadow:none!important}
  .intel-theme-minimal .intel-transmit-dock{background:linear-gradient(0deg,#111215 60%,transparent)!important;border-top:1px solid rgba(255,255,255,.04)!important}
  .intel-theme-minimal .intel-crt-header{display:none!important}

  /* ══════ INTEL THEME: HOLO HUD GREEN ══════ */
  .intel-theme-holo .intel-scroll-area{background:linear-gradient(170deg,rgba(0,20,10,.95),rgba(0,12,6,.98))!important;border-radius:8px!important;border:1px solid rgba(0,255,136,.12)!important;box-shadow:0 0 30px rgba(0,255,136,.04),0 0 80px rgba(0,255,136,.015)!important;position:relative!important;padding:18px 24px 0!important}
  .intel-theme-holo .intel-scroll-area::before{content:''!important;display:block!important;position:absolute!important;top:0!important;left:0!important;right:0!important;height:1px!important;background:linear-gradient(90deg,transparent,rgba(0,255,136,.4),transparent)!important;pointer-events:none!important;z-index:5!important;inset:auto!important;border:none!important;border-radius:0!important}
  .intel-theme-holo .intel-scroll-area::after{display:none!important}
  .intel-theme-holo .intel-exp-row{flex-direction:column!important;align-items:stretch!important;border:none!important;background:transparent!important;padding:0!important;margin-bottom:18px!important;gap:0!important;overflow:visible!important;max-width:100%!important padding-right:28px;}
  .intel-theme-holo .intel-exp-row::before{display:none!important}
  .intel-theme-holo .intel-exp-row:hover{background:transparent!important;border-color:transparent!important;box-shadow:none!important}
  .intel-theme-holo .intel-exp-row:hover .intel-exp-num{opacity:1!important}
  .intel-theme-holo .intel-exp-num{display:none!important}
  .intel-theme-holo .intel-exp-label{font-family:'Rajdhani',sans-serif!important;font-size:13px!important;color:rgba(0,255,136,.7)!important;letter-spacing:3px!important;font-weight:700!important;text-transform:uppercase!important;width:auto!important;flex-shrink:initial!important;margin-bottom:6px!important}
  .intel-theme-holo .intel-exp-input{width:100%!important;flex:none!important;background:rgba(0,255,136,.03)!important;border:1px solid rgba(0,255,136,.1)!important;border-radius:4px!important;font-family:'Rajdhani',sans-serif!important;font-size:14px!important;color:#b0ffd8!important;letter-spacing:1px!important;text-shadow:none!important;padding:12px 14px!important}
  .intel-theme-holo .intel-exp-input:focus{border-color:rgba(0,255,136,.25)!important;box-shadow:0 0 12px rgba(0,255,136,.06)!important}
  .intel-theme-holo .intel-exp-input::placeholder{color:rgba(0,255,136,.15)!important;text-shadow:none!important}
  .intel-theme-holo .intel-prefix-wrap{width:100%!important;flex:none!important;background:rgba(0,255,136,.03)!important;border:1px solid rgba(0,255,136,.1)!important;border-radius:4px!important}
  .intel-theme-holo .intel-prefix-wrap:focus-within{border-color:rgba(0,255,136,.25)!important;box-shadow:0 0 12px rgba(0,255,136,.06)!important}
  .intel-theme-holo .intel-prefix{color:rgba(0,255,136,.5)!important;text-shadow:none!important;font-family:'Rajdhani',sans-serif!important;opacity:1!important}
  .intel-theme-holo .intel-prefix-wrap input{color:#b0ffd8!important;text-shadow:none!important;font-family:'Rajdhani',sans-serif!important;font-size:14px!important;letter-spacing:1px!important}
  .intel-theme-holo .intel-prefix-wrap input::placeholder{color:rgba(0,255,136,.15)!important;text-shadow:none!important}
  .intel-theme-holo .intel-select{width:100%!important;flex:none!important;background-color:rgba(0,255,136,.03)!important;border:1px solid rgba(0,255,136,.1)!important;border-radius:4px!important;color:#b0ffd8!important;text-shadow:none!important;font-family:'Rajdhani',sans-serif!important;font-size:14px!important;padding:12px 30px 12px 14px!important}
  .intel-theme-holo .intel-dual-wrap{width:100%!important;flex:none!important}
  .intel-theme-holo .intel-dual-wrap input{width:auto!important;flex:1!important;background:rgba(0,255,136,.03)!important;border:1px solid rgba(0,255,136,.1)!important;border-radius:4px!important;color:#b0ffd8!important;text-shadow:none!important;font-family:'Rajdhani',sans-serif!important;font-size:14px!important;padding:12px 14px!important}
  .intel-theme-holo .intel-dual-sep{color:rgba(0,255,136,.25)!important}
  .intel-theme-holo .intel-exp-clear{margin-left:10px;margin-right:6px;color:rgba(0,255,136,.2)!important position:absolute; right:12px;}
  .intel-theme-holo .intel-submit-btn{background:linear-gradient(180deg,rgba(0,255,136,.1),rgba(0,255,136,.04))!important;border:1px solid rgba(0,255,136,.25)!important;border-radius:4px!important;color:#00ff88!important;font-family:'Orbitron',sans-serif!important;font-size:9px!important;letter-spacing:4px!important;text-shadow:0 0 8px rgba(0,255,136,.3)!important;padding:13px 44px!important}
  .intel-theme-holo .intel-submit-btn:hover{background:rgba(0,255,136,.12)!important;border-color:rgba(0,255,136,.4)!important;box-shadow:0 0 20px rgba(0,255,136,.1)!important}
  .intel-theme-holo .intel-transmit-dock{background:linear-gradient(0deg,rgba(0,12,6,.95) 60%,transparent)!important;border-top:1px solid rgba(0,255,136,.08)!important}
  .intel-theme-holo .intel-crt-header{display:none!important}

  /* ══════ INTEL THEME: GREEN DOSSIER ══════ */
  .intel-theme-dossier .intel-scroll-area{background:#0e0f11!important;border-radius:2px!important;border:1px solid rgba(255,255,255,.06)!important;position:relative!important;overflow-x:hidden!important;box-shadow:none!important;padding:18px 22px 0!important}
  .intel-theme-dossier .intel-scroll-area::before{content:''!important;display:block!important;position:absolute!important;top:0!important;left:0!important;right:0!important;height:4px!important;background:linear-gradient(90deg,#00ff88,#00d4ff,#00ff88)!important;pointer-events:none!important;z-index:5!important;inset:auto!important;border:none!important;border-radius:0!important}
  .intel-theme-dossier .intel-scroll-area::after{content:'CLASSIFIED'!important;display:block!important;position:absolute!important;top:18px!important;right:16px!important;font-family:'Saira',sans-serif!important;font-size:8px!important;letter-spacing:3px!important;color:#00ff88!important;border:2px solid #00ff88!important;padding:4px 10px!important;transform:rotate(3deg)!important;opacity:.6!important;pointer-events:none!important;z-index:5!important;width:auto!important;height:auto!important;background:transparent!important;border-radius:0!important;inset:auto!important;top:18px!important;right:16px!important}
  .intel-theme-dossier .intel-exp-row{flex-direction:column!important;align-items:stretch!important;border:none!important;border-radius:0!important;background:transparent!important;padding:0!important;margin-bottom:18px!important;gap:0!important;overflow:visible!important;max-width:100%!important padding-right:28px;}
  .intel-theme-dossier .intel-exp-row::before{display:none!important}
  .intel-theme-dossier .intel-exp-row:hover{background:transparent!important;border-color:transparent!important;box-shadow:none!important}
  .intel-theme-dossier .intel-exp-row:hover .intel-exp-num{opacity:1!important;color:#00ff88!important}
  .intel-theme-dossier .intel-exp-num{font-family:'IBM Plex Mono',monospace!important;color:#00ff88!important;font-size:12px!important;font-weight:700!important;text-shadow:none!important;width:auto!important;display:inline!important;flex-shrink:0!important}
  .intel-theme-dossier .intel-exp-label{font-family:'IBM Plex Mono',monospace!important;font-size:11px!important;color:#b0b8c0!important;letter-spacing:2px!important;font-weight:600!important;text-transform:uppercase!important;width:auto!important;flex-shrink:initial!important;display:flex!important;align-items:center!important;gap:8px!important;margin-bottom:6px!important}
  .intel-theme-dossier .intel-exp-input{width:100%!important;flex:none!important;background:transparent!important;border:none!important;border-bottom:1px solid rgba(0,255,136,.12)!important;border-radius:0!important;font-family:'IBM Plex Mono',monospace!important;font-size:12px!important;color:#ddd!important;text-shadow:none!important;padding:10px 4px!important}
  .intel-theme-dossier .intel-exp-input:focus{border-color:transparent!important;border-bottom-color:rgba(0,255,136,.35)!important;box-shadow:none!important}
  .intel-theme-dossier .intel-exp-input::placeholder{color:rgba(255,255,255,.12)!important;text-shadow:none!important}
  .intel-theme-dossier .intel-prefix-wrap{width:100%!important;flex:none!important;background:transparent!important;border:none!important;border-bottom:1px solid rgba(0,255,136,.12)!important;border-radius:0!important}
  .intel-theme-dossier .intel-prefix-wrap:focus-within{border-bottom-color:rgba(0,255,136,.35)!important;box-shadow:none!important}
  .intel-theme-dossier .intel-prefix{color:#888!important;text-shadow:none!important;font-family:'IBM Plex Mono',monospace!important;opacity:1!important}
  .intel-theme-dossier .intel-prefix-wrap input{color:#ddd!important;text-shadow:none!important;font-family:'IBM Plex Mono',monospace!important;font-size:12px!important;padding:10px 4px!important}
  .intel-theme-dossier .intel-prefix-wrap input::placeholder{color:rgba(255,255,255,.12)!important;text-shadow:none!important}
  .intel-theme-dossier .intel-select{width:100%!important;flex:none!important;background-color:transparent!important;border:none!important;border-bottom:1px solid rgba(0,255,136,.12)!important;border-radius:0!important;color:#ddd!important;text-shadow:none!important;font-family:'IBM Plex Mono',monospace!important;font-size:12px!important;padding:10px 30px 10px 4px!important}
  .intel-theme-dossier .intel-dual-wrap{width:100%!important;flex:none!important}
  .intel-theme-dossier .intel-dual-wrap input{width:auto!important;flex:1!important;background:transparent!important;border:none!important;border-bottom:1px solid rgba(0,255,136,.12)!important;border-radius:0!important;color:#ddd!important;text-shadow:none!important;font-family:'IBM Plex Mono',monospace!important;font-size:12px!important;padding:10px 4px!important}
  .intel-theme-dossier .intel-dual-sep{color:#555!important}
  .intel-theme-dossier .intel-exp-clear{margin-left:10px;margin-right:6px;color:rgba(255,255,255,.15)!important position:absolute; right:12px;}
  .intel-theme-dossier .intel-submit-btn{background:#00ff88!important;border:none!important;border-radius:2px!important;color:#000!important;font-family:'Saira',sans-serif!important;font-size:10px!important;letter-spacing:4px!important;font-weight:700!important;text-shadow:none!important;padding:13px 44px!important}
  .intel-theme-dossier .intel-submit-btn:hover{background:#33ffaa!important;box-shadow:0 0 20px rgba(0,255,136,.2)!important;text-shadow:none!important}
  .intel-theme-dossier .intel-transmit-dock{background:linear-gradient(0deg,#0e0f11 60%,transparent)!important;border-top:1px solid rgba(255,255,255,.04)!important}
  .intel-theme-dossier .intel-crt-header{display:none!important}
  /* Transmit button — Neon Grid style */
  .intel-notice{font-family:'Chakra Petch',sans-serif;font-size:13px;color:#b0bcc8;line-height:1.8;text-align:center;padding:16px 22px;margin:4px 0 10px;border:1px solid rgba(0,255,136,.1);border-radius:6px;background:rgba(0,255,136,.03);letter-spacing:.3px;font-weight:500}
  .intel-notice strong{color:var(--green);font-weight:700;letter-spacing:.5px}
  .intel-notice-icon{font-size:14px;margin-right:6px}
  body.admin-mode:not(.player-preview) .intel-notice{display:none}
  .intel-saved-blip{min-width:44px;height:18px;display:flex;align-items:center;justify-content:center;font-size:8px;text-transform:uppercase;letter-spacing:1px;color:rgba(0,255,136,0);flex-shrink:0;transition:all .25s;pointer-events:none;opacity:0}
  .intel-saved-blip.show{color:var(--green);opacity:1;text-shadow:0 0 8px rgba(0,255,136,.35);animation:intelSavedPop .5s ease}
  @keyframes intelSavedPop{0%{transform:scale(1.4);opacity:.5}100%{transform:scale(1);opacity:1}}
  .intel-submit-wrap{margin-top:20px;display:flex;justify-content:center}
  .intel-submit-btn{padding:14px 48px;cursor:pointer;transition:all .15s;border-radius:4px;
    font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
    background:linear-gradient(180deg,rgba(20,60,35,.5) 0%,rgba(12,40,24,.6) 50%,rgba(8,30,18,.7) 100%);
    border:none;border-bottom:3px solid #0a1a10;border-right:2px solid #101014;
    color:var(--green);
    text-shadow:0 0 6px rgba(0,255,136,.2);
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06);
    position:relative;
  }
  .intel-submit-btn::before{content:'';position:absolute;inset:1px;border-radius:3px;border:1px solid rgba(0,255,136,.12);pointer-events:none}
  .intel-submit-btn::after{content:'';position:absolute;top:1px;left:15%;right:15%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);border-radius:50%;pointer-events:none}
  .intel-submit-btn:hover{
    background:linear-gradient(180deg,rgba(30,90,50,.6) 0%,rgba(20,65,35,.7) 50%,rgba(12,45,25,.8) 100%);
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06),0 0 25px rgba(0,255,136,.15),0 0 50px rgba(0,255,136,.08);
    text-shadow:0 0 12px rgba(0,255,136,.5),0 0 25px rgba(0,255,136,.2);
    border-bottom-color:rgba(0,255,136,.15);
  }
  .intel-submit-btn:active{transform:translateY(2px);border-bottom-width:1px;border-right-width:1px;box-shadow:0 0 2px rgba(0,0,0,.4)}
  .intel-submit-btn:disabled{opacity:.2;cursor:not-allowed;transform:none}
  .intel-submit-admin-test{
    background:linear-gradient(180deg,rgba(60,40,15,.5) 0%,rgba(40,26,10,.6) 50%,rgba(28,18,8,.7) 100%)!important;
    border-bottom-color:#1a1208!important;
    color:var(--amber)!important;
    text-shadow:0 0 6px rgba(255,170,51,.2)!important;
  }
  .intel-submit-admin-test::before{border-color:rgba(255,170,51,.12)!important}
  .intel-submit-admin-test:hover{
    background:linear-gradient(180deg,rgba(80,55,20,.6) 0%,rgba(60,40,16,.7) 50%,rgba(40,28,12,.8) 100%)!important;
    box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06),0 0 25px rgba(255,170,51,.15),0 0 50px rgba(255,170,51,.08)!important;
    text-shadow:0 0 12px rgba(255,170,51,.5),0 0 25px rgba(255,170,51,.2)!important;
  }

  /* ══════ ADMIN NAV BAR ══════ */
  #adminNavBar{
    position:fixed;bottom:0;left:50%;transform:translateX(-50%);
    z-index:900;
    display:none;
    gap:2px;
    background:rgba(8,10,18,.95);
    border:1px solid rgba(255,255,255,.06);
    border-bottom:none;
    border-radius:8px 8px 0 0;
    padding:6px 8px 4px;
    backdrop-filter:blur(12px);
    box-shadow:0 -4px 30px rgba(0,0,0,.6),0 -1px 0 rgba(255,255,255,.03);
    align-items:center;
  }
  #adminNavBar.visible{display:none}
  .anb-btn{
    display:flex;flex-direction:column;align-items:center;gap:2px;
    padding:6px 12px;border-radius:5px;cursor:pointer;
    border:1px solid transparent;
    transition:all .18s;
    min-width:64px;
    background:none;
  }
  .anb-btn:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.06)}
  .anb-btn.active{background:rgba(0,212,255,.07);border-color:rgba(0,212,255,.15)}
  .anb-icon{font-size:14px;line-height:1}
  .anb-label{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:1px;color:#555;text-transform:uppercase;white-space:nowrap}
  .anb-btn:hover .anb-label{color:#888}
  .anb-btn.active .anb-label{color:var(--cyan)}
  .anb-sep{width:1px;height:28px;background:rgba(255,255,255,.05);margin:0 2px;flex-shrink:0}


  /* ══════ ADMIN PAGE SCREENS ══════ */
  #settingsScreen{background:#0e1019;min-height:100vh;padding:0}
  #settingsScreen.active{z-index:850}
  .admin-page{display:flex;flex-direction:column;height:100vh;overflow:hidden}
  .admin-page-header{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 24px 0;background:linear-gradient(180deg,#161a26,#10131c);border-bottom:1px solid rgba(255,255,255,.07);flex-shrink:0}
  .admin-page-header-row{display:flex;align-items:center;justify-content:space-between;width:100%}
  .admin-page-title{font-family:'Staatliches',cursive;font-size:20px;letter-spacing:6px;color:#ffd699;text-transform:uppercase;flex:1;text-align:center;text-shadow:0 2px 10px rgba(255,214,153,.18)}
  .admin-page-close{margin-left:auto;border-radius:4px;cursor:pointer;transition:all .2s;
    background:rgba(255,50,50,.06);
    border:1px solid rgba(255,50,50,.2);border-bottom:2px solid rgba(255,50,50,.1);
    color:var(--red);font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;padding:7px 18px;font-weight:600;
    text-shadow:0 0 6px rgba(255,50,50,.2)}
  .admin-page-close:hover{border-color:rgba(255,50,50,.45);background:rgba(255,50,50,.12);text-shadow:0 0 12px rgba(255,50,50,.4);box-shadow:0 0 14px rgba(255,50,50,.1)}
  .admin-page-tabs{display:flex;gap:0;flex-wrap:wrap;justify-content:center}
  .admin-page-tab{padding:11px 20px;font-family:'Saira',sans-serif;font-size:12px;letter-spacing:1.5px;color:#8aa;cursor:pointer;border:none;background:transparent;border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;font-weight:700;white-space:nowrap}
  .admin-page-tab:hover{color:#aab;background:rgba(255,255,255,.02)}
  .admin-page-tab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:rgba(0,212,255,.03)}
  .admin-page-tab-sep{width:1px;height:20px;background:rgba(255,255,255,.06);margin:6px 8px;align-self:center;flex-shrink:0}
  .admin-page-body{flex:1;overflow-y:auto;display:flex;justify-content:center;padding:28px 24px 60px}
  .admin-page-section{display:none;width:100%;max-width:740px}
  .admin-page-section.active{display:block}

  /* Better section styling inside pages */
  .admin-page-section .ap-section,
  .admin-page-section .kc-section{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.06);border-radius:8px;margin-bottom:16px;padding:24px 28px}
  .admin-page-section .ap-section:last-child{border-bottom:1px solid rgba(255,255,255,.06)}
  .admin-page-section .bc-body{padding:20px}
  .admin-page-section .kc-body{padding:0}

  /* ══════ READABILITY — larger text in admin pages ══════ */
  .admin-page-section .ap-section h4{font-size:14px;letter-spacing:2.5px;margin-bottom:16px}
  .admin-page-section .ap-section p{font-size:12px;color:#b0b8c8;line-height:1.7;margin-bottom:14px}
  .admin-page-section .ap-field label{font-size:11px;letter-spacing:1.5px;color:#c0c8d8;margin-bottom:6px}
  .admin-page-section .ap-field input,
  .admin-page-section .ap-field select{font-size:13px;padding:10px 14px}
  .admin-page-section .ap-btn{font-size:11px;padding:8px 16px;letter-spacing:1.5px}
  .admin-page-section .kc-section-title{font-size:13px}
  .admin-page-section .kc-row{padding:10px 14px}
  .admin-page-section .kc-label{font-size:12px}
  .admin-page-section .kc-value{font-size:11px}
  .admin-page-section .session-btn .sb-title{font-size:11px}
  .admin-page-section .session-btn .sb-desc{font-size:10px;color:#999}
  .admin-page-section .lb-toolbar{padding:12px 16px}
  .admin-page-section .lb-search{font-size:12px;padding:10px 14px}
  .admin-page-section .bc-textarea{font-size:13px;min-height:120px;width:100%;box-sizing:border-box;padding:12px 14px;border-radius:8px}
  .admin-page-section .ap-team-row{padding:10px 14px}
  .admin-page-section .ap-status-pill{font-size:11px;padding:6px 12px}
  .admin-page-section .tut-step-list .tut-step{padding:10px 12px}

  @media(max-width:600px){
    .admin-page-header{padding:12px 16px 0;gap:4px}
    .admin-page-tabs{gap:0}
    .admin-page-tab{padding:9px 14px;font-size:10px;letter-spacing:1px}
    .admin-page-tab-sep{margin:4px 4px}
    .admin-page-body{padding:16px 12px 60px}
    .admin-page-close{padding:6px 14px;font-size:9px}
  }

  /* Panels as page sections — override overlay positioning */
  .admin-page-section #adminPanel,
  .admin-page-section #scoringPanel,
  .admin-page-section #registrationPanel,
  .admin-page-section #tutorialConfigPanel,
  .admin-page-section #keysCodesPanel,
  .admin-page-section #appearancePanel,
  .admin-page-section #portalUsersPanel,
  .admin-page-section #dashboardPanel,
  .admin-page-section #leaderboardModule,
  .admin-page-section #sessionMgmtPanel,
  .admin-page-section #broadcastPanel{
    position:static!important;inset:auto!important;z-index:auto!important;
    background:transparent!important;opacity:1!important;pointer-events:all!important;
    display:block!important;transition:none!important
  }
  .admin-page-section .ap-container,
  .admin-page-section .kc-container,
  .admin-page-section .bc-container,
  .admin-page-section .lb-container{
    width:100%!important;max-width:100%!important;max-height:none!important;height:auto!important;
    border:none!important;box-shadow:none!important;border-radius:0!important;background:transparent!important
  }
  .admin-page-section .ap-header,
  .admin-page-section .kc-header,
  .admin-page-section .bc-header,
  .admin-page-section .lb-header{display:none!important}
  .admin-page-section .setup-nav,
  .admin-page-section .dash-nav{display:none!important}
  .admin-page-section .lb-container{overflow:visible!important}

  /* ══════ PERSISTENT ADMIN ICONS ══════ */
  .admin-persistent-icons{position:fixed;bottom:calc(12px + env(safe-area-inset-bottom,0));right:12px;z-index:900;display:none;align-items:center;gap:8px}
  body.admin-mode .admin-persistent-icons{display:flex}
  body.player-preview .admin-persistent-icons .admin-icon-gear{display:flex!important}
  .admin-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;background:linear-gradient(180deg,rgba(30,32,40,.9),rgba(20,22,28,.95));border:1px solid rgba(100,110,130,.2);box-shadow:0 2px 10px rgba(0,0,0,.4)}
  .admin-icon svg{width:18px;height:18px;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:all .3s}
  .admin-icon:hover{border-color:rgba(150,160,180,.4);box-shadow:0 2px 16px rgba(0,0,0,.5)}
  .admin-icon-preview svg{stroke:rgba(100,180,220,.6)}
  .admin-icon-preview:hover svg{stroke:rgba(100,200,240,.8)}
  .admin-icon-preview.active{border-color:rgba(0,180,255,.3);box-shadow:0 0 16px rgba(0,180,255,.15)}
  .admin-icon-preview.active svg{stroke:rgba(0,200,255,1);filter:drop-shadow(0 0 4px rgba(0,200,255,.5))}
  .admin-icon-gear svg{stroke:rgba(140,150,170,.7)}
  .admin-icon-gear:hover svg{stroke:rgba(180,190,210,.9)}
  .admin-icon-gear.active{border-color:rgba(255,170,51,.3);box-shadow:0 0 16px rgba(255,170,51,.15)}
  .admin-icon-gear.active svg{stroke:rgba(255,170,51,1);filter:drop-shadow(0 0 4px rgba(255,170,51,.5))}

  /* ══════ GEAR DROPDOWN ══════ */
  .gear-dropdown{position:fixed;bottom:62px;right:12px;z-index:910;width:200px;border-radius:6px;
    background:linear-gradient(180deg,#1e2028,#161820);border:1px solid rgba(255,255,255,.08);
    box-shadow:0 8px 30px rgba(0,0,0,.6);opacity:0;pointer-events:none;
    transform:translateY(6px) scale(.97);transition:all .2s ease}
  .gear-dropdown.open{opacity:1;pointer-events:all;transform:translateY(0) scale(1)}
  .gear-dropdown-item{display:flex;align-items:center;gap:10px;padding:11px 16px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
  .gear-dropdown-item:hover{background:rgba(255,255,255,.04)}
  .gear-dropdown-item:first-child{border-radius:6px 6px 0 0}
  .gear-dropdown-item:last-child{border-radius:0 0 6px 6px}
  .gear-dropdown-item .gd-icon{font-size:14px;width:22px;text-align:center;flex-shrink:0}
  .gear-dropdown-item .gd-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;letter-spacing:.5px;font-weight:500}
  .gear-dropdown-item:hover .gd-label{color:#fff}

  /* ══════ CONFIRM MODAL ══════ */
  #confirmModal{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #confirmModal.active{opacity:1;pointer-events:all}
  .confirm-box{width:600px;max-height:80vh;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;overflow:visible;display:flex;flex-direction:column;box-shadow:0 20px 80px rgba(0,0,0,.6)}
  .confirm-header{padding:18px 22px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--bg-surface),var(--bg-panel))}
  .confirm-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--amber);text-transform:uppercase;margin-bottom:4px}
  .confirm-header p{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#aaa;font-weight:500;letter-spacing:1px}
  .confirm-body{flex:1;overflow-y:auto;padding:16px 22px}
  .confirm-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03)}
  .confirm-row:last-child{border-bottom:none}
  .confirm-label{font-family:'Saira',sans-serif;font-size:12px;color:#bbb;font-weight:600;letter-spacing:1px}
  .confirm-value{font-family:'Chakra Petch',sans-serif;font-size:13px;color:var(--green);letter-spacing:2px;text-align:right;max-width:300px;word-break:break-all;font-weight:600}
  .confirm-value.empty{color:#555;font-style:italic}
  .confirm-footer{padding:16px 22px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
  .btn-standard{font-family:'Saira',sans-serif;font-size:11px;letter-spacing:2px;padding:10px 26px;cursor:pointer;border-radius:4px;transition:all .08s;font-weight:700}
  .btn-standard:active{transform:translateY(1px);border-bottom-width:1px}
  .btn-ghost{background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(26,28,32,.7));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #0a0a0e;color:#aaa}
  .btn-ghost:hover{border-color:rgba(255,255,255,.12);color:#ccc}
  .btn-green{background:linear-gradient(180deg,rgba(20,60,35,.6),rgba(12,40,24,.7));border:1px solid rgba(0,255,136,.1);border-bottom:2px solid #0a1a10;color:var(--green)}
  .btn-green:hover{background:linear-gradient(180deg,rgba(25,70,40,.6),rgba(15,50,30,.7))}
  .btn-cyan{background:linear-gradient(180deg,rgba(20,35,60,.6),rgba(12,24,40,.7));border:1px solid rgba(0,212,255,.1);border-bottom:2px solid #0a101a;color:var(--cyan)}
  .btn-cyan:hover{background:linear-gradient(180deg,rgba(25,40,70,.6),rgba(15,30,50,.7))}
  .btn-red{background:linear-gradient(180deg,rgba(60,20,20,.5),rgba(40,12,12,.6));border:1px solid rgba(255,50,50,.1);border-bottom:2px solid #1a0a0a;color:var(--red)}
  .btn-red:hover{background:linear-gradient(180deg,rgba(70,25,25,.5),rgba(50,15,15,.6))}

  /* ══════ ADMIN ══════ */
  .admin-trigger{position:fixed;bottom:calc(10px + env(safe-area-inset-bottom,0));right:10px;z-index:800;width:40px;height:40px;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;
    background:linear-gradient(180deg,rgba(150,160,180,.12),rgba(120,130,150,.06));border:1px solid rgba(150,160,180,.3);box-shadow:0 0 10px rgba(150,160,180,.08)}
  .admin-trigger svg{width:19px;height:19px;fill:none;stroke:#8890a0;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;transition:stroke .3s}
  .admin-trigger:hover{border-color:rgba(150,160,180,.5);box-shadow:0 0 14px rgba(150,160,180,.15)}
  .admin-trigger:hover svg{stroke:#b0b8c8}
  .admin-trigger::after{display:none}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-trigger{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview #scoringPanel,
  body.player-preview #registrationPanel,
  body.player-preview #appearancePanel,
  body.player-preview #dashboardPanel{display:none!important}
  body.player-preview #adminNavBar{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview #logoutBtn{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-topbar-label{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-dropdown{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .console-team{display:inline-flex!important;color:var(--cyan)!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .team-chevron{display:inline!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .notepad-trigger.visible{display:flex!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-edit-btn{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-edit-inline{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-add-btn{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .admin-row-edit{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .drag-handle{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .feed-single-edit{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .vui-admin-hint{display:none!important}

  body.event-locked .console-tile{pointer-events:none;opacity:.5}
  body.event-locked .intel-exp-input{pointer-events:none;opacity:.4}
  body.event-locked .v-key{pointer-events:none;opacity:.4}
  body.event-locked .intel-submit-btn{pointer-events:none;opacity:.4}
  body.player-preview .landing-banner-upload{display:none!important}
  body.admin-mode .admin-trigger{display:none}

  body.admin-mode .admin-only-card-item{display:flex!important}

  body.admin-mode .console-grid{padding-bottom:clamp(56px,7vh,70px)}

  /* Admin dropdown menu */
  .admin-dropdown{position:fixed;bottom:52px;right:10px;z-index:810;width:220px;border-radius:6px;
    background:linear-gradient(180deg,#1e2028,#14161c 40%,#10121a);
    border:1px solid rgba(255,170,51,.15);
    box-shadow:0 8px 40px rgba(0,0,0,.7),0 0 1px rgba(255,170,51,.2),inset 0 1px 0 rgba(255,255,255,.03);
    opacity:0;pointer-events:none;transform:translateY(8px) scale(.96);transition:all .2s cubic-bezier(.25,.46,.45,.94);overflow:hidden}
  .admin-dropdown.open{opacity:0;pointer-events:none;transform:translateY(0) scale(1);display:none}
  .admin-dropdown-header{padding:12px 16px;border-bottom:1px solid rgba(255,170,51,.1);display:flex;align-items:center;gap:8px}
  .admin-dropdown-dot{width:6px;height:6px;border-radius:50%;background:var(--amber);box-shadow:0 0 4px rgba(255,170,51,.5);animation:ledPulse 2s ease-in-out infinite;flex-shrink:0}
  .admin-dropdown-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--amber);font-weight:600;text-transform:uppercase}
  .admin-dropdown-body{padding:6px 0}
  .admin-dropdown-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
  .admin-dropdown-item:hover{background:rgba(255,255,255,.04)}
  .admin-dropdown-item .adm-icon{font-size:13px;width:20px;text-align:center;flex-shrink:0}
  .admin-dropdown-item .adm-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;letter-spacing:.5px;font-weight:500}
  .admin-dropdown-item:hover .adm-label{color:#fff}
  .admin-dropdown-item.adm-danger .adm-label{color:#ff6655}
  .admin-dropdown-item.adm-danger:hover{background:rgba(255,50,50,.06)}
  .admin-dropdown-item.adm-danger:hover .adm-label{color:#ff4433}
  .adm-tier-label{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:3px;color:rgba(0,212,255,.4);text-transform:uppercase;padding:10px 16px 4px;font-weight:700;user-select:none}
  .adm-tier-label:not(:first-child){border-top:1px solid rgba(255,255,255,.04);margin-top:4px;padding-top:10px}
  .admin-dropdown-sep{height:1px;background:rgba(255,255,255,.04);margin:4px 12px}
  .admin-dropdown-toggle{display:flex;align-items:center;justify-content:space-between;padding:9px 16px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
  .admin-dropdown-toggle:hover{background:rgba(255,255,255,.04)}
  .admin-dropdown-toggle .adm-icon{font-size:13px;width:20px;text-align:center;flex-shrink:0}
  .admin-dropdown-toggle .adm-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;letter-spacing:.5px;font-weight:500;flex:1}
  .admin-dropdown-toggle .adm-toggle{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:2px 8px;border-radius:2px;font-weight:600}
  .admin-dropdown-toggle .adm-toggle.on{color:var(--green);background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.15)}
  .admin-dropdown-toggle .adm-toggle.on-cyan{color:var(--cyan);background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.15)}
  .admin-dropdown-toggle .adm-toggle.on-green{color:var(--green);background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.15)}
  .admin-dropdown-toggle .adm-toggle.off{color:#666;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}

  .logout-btn{position:fixed;bottom:12px;left:12px;z-index:600;display:none;align-items:center;gap:8px;padding:10px 18px;border-radius:5px;cursor:pointer;transition:all .3s;
    background:linear-gradient(180deg,rgba(255,50,50,.1),rgba(255,50,50,.05));border:1px solid rgba(255,50,50,.35);
    box-shadow:0 0 10px rgba(255,50,50,.06)}
  .logout-btn.visible{display:flex}
  .logout-btn:hover{background:linear-gradient(180deg,rgba(255,50,50,.18),rgba(255,50,50,.1));border-color:rgba(255,50,50,.5);box-shadow:0 0 18px rgba(255,50,50,.12)}
  .logout-btn:active{transform:translateY(0)}
  .logout-btn svg{width:16px;height:16px;fill:none;stroke:var(--red);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
  .logout-btn span{font-family:'Saira',sans-serif;font-size:12px;letter-spacing:3px;color:var(--red);font-weight:700;text-transform:uppercase}

  /* Notification bell */
  .admin-topbar-label{display:none;font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:2.5px;color:var(--amber);font-weight:600;text-transform:uppercase;padding:6px 14px;border:1px solid rgba(255,170,51,.25);border-radius:3px;background:rgba(255,170,51,.06);align-items:center;line-height:1;box-sizing:border-box;height:28px}
  body.admin-mode .admin-topbar-label{display:inline-flex}
  .notif-empty{padding:12px 8px;text-align:center;font-family:'Chakra Petch',sans-serif;font-size:10px;color:#555}

  /* Logout confirm modal */
  #logoutModal{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #logoutModal.active{opacity:1;pointer-events:all}
  .logout-box{width:380px;background:var(--bg-panel);border:1px solid rgba(255,50,50,.2);border-radius:8px;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .logout-box h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:var(--red);text-transform:uppercase;margin-bottom:10px}
  .logout-box p{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#bbb;line-height:1.7;font-weight:500;margin-bottom:20px}

  #adminLogin{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #adminLogin.active{opacity:1;pointer-events:all}
  .admin-login-box{width:340px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .admin-login-box h3{font-family:'Staatliches',cursive;font-size:12px;letter-spacing:4px;color:var(--cyan);text-transform:uppercase;margin-bottom:4px}
  .admin-login-box p{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#888;letter-spacing:1px;margin-bottom:20px;font-weight:500}
  .admin-disclaimer{font-family:'Chakra Petch',sans-serif;font-size:10px;color:var(--amber);letter-spacing:.5px;line-height:1.6;margin-bottom:18px;padding:10px 12px;border:1px solid rgba(255,170,51,.15);border-radius:4px;background:rgba(255,170,51,.04);font-weight:500}
  .admin-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
  .admin-field label{font-family:'Saira',sans-serif;font-size:10px;color:#888;letter-spacing:2px;text-transform:uppercase;font-weight:600}
  .admin-field input{background:#080a10;border:1px solid var(--border);border-radius:3px;padding:10px 12px;color:var(--cyan);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;transition:border-color .2s}
  .admin-field input:focus{border-color:rgba(0,212,255,.3)}
  .admin-err{font-family:'Chakra Petch',sans-serif;font-size:10px;color:var(--red);margin-bottom:10px;min-height:14px;font-weight:500}

  /* Admin bar — REMOVED, replaced by dropdown menu */

  /* Admin Profile Panel */
  #adminPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #adminPanel.active{opacity:1;pointer-events:all}
  #dashboardPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #dashboardPanel.active{opacity:1;pointer-events:all}
  #scoringPanel,#registrationPanel,#appearancePanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #scoringPanel.active,#registrationPanel.active,#appearancePanel.active{opacity:1;pointer-events:all}
  #portalUsersPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #portalUsersPanel.active{opacity:1;pointer-events:all}

  /* ══════ SETUP SUB-NAV ══════ */
  .setup-nav{display:flex;gap:1px;padding:4px 12px;background:rgba(0,0,0,.35);border-bottom:1px solid rgba(255,255,255,.04);flex-wrap:wrap}
  .setup-nav-btn{padding:8px 14px;font-family:'Saira',sans-serif;font-size:9px;letter-spacing:1.5px;color:#555;cursor:pointer;border:none;background:transparent;border-bottom:2px solid transparent;transition:all .12s;text-transform:uppercase;font-weight:600;white-space:nowrap}
  .setup-nav-btn:hover{color:#999}
  .setup-nav-btn.active{color:var(--cyan);border-bottom-color:var(--cyan)}
  @media(max-width:600px){.setup-nav-btn{padding:7px 10px;font-size:8px;letter-spacing:1px}}
  .ap-container{width:600px;max-width:92vw;max-height:85vh;overflow-y:auto;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .ap-header{padding:18px 28px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .ap-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#ffd699;text-transform:uppercase;margin:0}
  .ap-section{padding:22px 28px;border-bottom:1px solid var(--border)}
  .ap-section:last-child{border-bottom:none}
  .ap-section h4{font-family:'Saira',sans-serif;font-size:13px;letter-spacing:3px;color:#d0e8f0;text-transform:uppercase;margin:0 0 14px;font-weight:700}
  .ap-section p{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#aaa;letter-spacing:.3px;margin:0 0 12px;line-height:1.6;font-weight:500}
  .ap-field{margin-bottom:10px}
  .ap-field label{display:block;font-family:'Chakra Petch',sans-serif;font-size:10px;letter-spacing:2px;color:#bbb;text-transform:uppercase;margin-bottom:4px;font-weight:600}
  .ap-field input{background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:9px 12px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;box-sizing:border-box;max-width:100%}
  .ap-field input:focus{border-color:rgba(0,212,255,.2)}
  .ap-two-col-even .ap-field input,.ap-two-col-even .ap-field select{width:100%}
  .ap-row{display:flex;gap:10px;align-items:flex-end}
  .ap-row .ap-field{flex:1}
  .ap-two-col{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .ap-two-col .ap-field{min-width:140px}
  .ap-two-col-even{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .ap-two-col-even .ap-field{flex:1;min-width:140px}
  .ap-three-col{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .ap-three-col .ap-field{flex:1;min-width:100px}
  .ap-field select{background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:8px 10px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;box-sizing:border-box;width:auto;max-width:100%}
  .ap-field select:focus{border-color:rgba(0,212,255,.2)}
  .ap-btn{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;cursor:pointer;padding:8px 18px;border-radius:3px;transition:all .2s}
  .ap-btn-cyan{color:#c0e8f8;background:linear-gradient(180deg,rgba(15,30,40,.5),rgba(10,20,30,.6));border:1px solid rgba(0,212,255,.25);border-bottom:2px solid rgba(0,212,255,.12)}
  .ap-btn-cyan:hover{border-color:rgba(0,212,255,.4)}
  .ap-btn-green{color:#b8f0d0;background:linear-gradient(180deg,rgba(15,40,25,.5),rgba(10,25,15,.6));border:1px solid rgba(0,255,136,.25);border-bottom:2px solid rgba(0,255,136,.12)}
  .ap-btn-green:hover{border-color:rgba(0,255,136,.4)}
  .ap-btn-amber{color:#f0d8a0;background:linear-gradient(180deg,rgba(40,30,15,.5),rgba(25,18,10,.6));border:1px solid rgba(255,170,51,.25);border-bottom:2px solid rgba(255,170,51,.12)}
  .ap-btn-amber:hover{border-color:rgba(255,170,51,.4)}
  .ap-msg{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:1px;margin-top:6px;height:14px;font-weight:600}

  /* Console Background controls */
  .cbg-preset:hover{transform:scale(1.15);box-shadow:0 0 8px rgba(255,255,255,.15)}
  .cbg-preset{transition:all .15s}
  .cbg-tex{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px;border:1px solid var(--border);border-radius:5px;background:transparent;cursor:pointer;transition:all .15s}
  .cbg-tex:hover{border-color:rgba(0,212,255,.25)}
  .cbg-tex.active{border-color:var(--cyan);background:rgba(0,212,255,.06);box-shadow:0 0 8px rgba(0,212,255,.1)}
  .cbg-tex-preview{width:100%;height:32px;border-radius:3px;background:#080a10;border:1px solid rgba(255,255,255,.04)}
  .cbg-tex-label{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:1.5px;color:#888;text-transform:uppercase}
  .cbg-noise-preview{background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='256' height='256' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E") !important}
  .cbg-hex-preview{background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15z' fill='none' stroke='rgba(0,212,255,0.06)' stroke-width='0.5'/%3E%3Cpath d='M13.99 33.75l13 7.5v15l-13 7.5L1 56.25v-15z' fill='none' stroke='rgba(0,212,255,0.06)' stroke-width='0.5'/%3E%3Cpath d='M27.99 -8.25l13 7.5v15l-13 7.5L15 6.75v-15z' fill='none' stroke='rgba(0,212,255,0.06)' stroke-width='0.5'/%3E%3C/svg%3E") !important}

  /* Console texture overlay — applied to console screen */
  #consoleScreen{position:relative}
  #consoleBgOverlay{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0.4}
  .ap-msg.ok{color:#b8f0d0}.ap-msg.err{color:#ff9988}
  .ap-team-list{max-height:150px;overflow-y:auto;margin-top:10px}
  .ap-team-row{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:#ccc}
  .ap-team-id{color:#c0e8f8;font-weight:600;min-width:90px}
  .ap-team-name{flex:1;color:#aaa}
  .ap-team-del{color:#666;cursor:pointer;font-size:12px;transition:color .2s}
  .ap-team-del:hover{color:#ff8877}

  /* Team Monitor */
  .ap-status-pill{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;padding:5px 12px;border-radius:3px;display:flex;align-items:center;gap:6px;color:#999}
  .ap-status-pill.active{border:1px solid rgba(0,255,136,.12);background:rgba(0,255,136,.03);color:var(--green)}
  .ap-status-pill.inactive{border:1px solid rgba(255,170,51,.12);background:rgba(255,170,51,.03);color:var(--amber)}
  .ap-status-pill.total{border:1px solid var(--border);background:rgba(255,255,255,.02);color:#888}
  .ap-status-dot{width:6px;height:6px;border-radius:50%}
  .ap-status-dot.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}
  .ap-status-dot.off{background:var(--amber);opacity:.6}
  .ap-monitor-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;transition:border-color .3s}
  .ap-monitor-row.active{border-color:rgba(0,255,136,.1)}
  .ap-monitor-row.idle{border-color:rgba(240,200,120,.12);opacity:.75}
  .ap-monitor-row.ghost{border-color:rgba(255,51,51,.12);opacity:.55}
  .ap-monitor-ghost-tag{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:2px;color:#ff6666;padding:2px 6px;border:1px solid rgba(255,80,80,.4);border-radius:2px;flex-shrink:0;background:rgba(255,51,51,.12);text-shadow:0 0 6px rgba(255,80,80,.4)}
  .ap-monitor-remove{width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,51,51,.25);font-size:10px;border-radius:50%;transition:all .2s;flex-shrink:0;margin-left:2px}
  .ap-monitor-remove:hover{color:var(--red);background:rgba(255,51,51,.1)}
  .ap-lb-row.ghost{opacity:.55}
  .ap-lb-ghost-tag{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:1px;color:rgba(255,80,80,.5);padding:1px 5px;border:1px solid rgba(255,51,51,.15);border-radius:2px;margin-left:4px;vertical-align:middle}
  .ap-monitor-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
  .ap-monitor-dot.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}
  .ap-monitor-dot.idle{background:#f0c878;box-shadow:0 0 4px rgba(240,200,120,.3)}
  .ap-monitor-dot.off{background:#ff4444;opacity:.5}
  .ap-monitor-idle-tag{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:2px;color:#f0c878;padding:2px 6px;border:1px solid rgba(240,200,120,.3);border-radius:2px;flex-shrink:0;background:rgba(240,200,120,.08)}
  .ap-monitor-id{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--cyan);font-weight:600;min-width:90px}
  .ap-monitor-name{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#999;flex:1;min-width:0;overflow:visible;text-overflow:ellipsis;white-space:nowrap}
  .ap-monitor-time{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;letter-spacing:1px;flex-shrink:0}
  .ap-monitor-fields{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--green);letter-spacing:1px;flex-shrink:0;min-width:50px;text-align:right}

  /* Leaderboard */
  .ap-lb-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;transition:all .3s}
  .ap-lb-rank{font-family:'Staatliches',cursive;font-size:16px;min-width:28px;text-align:center}
  .ap-lb-rank.gold{color:#ffd700}.ap-lb-rank.silver{color:#c0c0c0}.ap-lb-rank.bronze{color:#cd7f32}.ap-lb-rank.std{color:#555}
  .ap-lb-info{flex:1;min-width:0}
  .ap-lb-name{font-family:'Saira',sans-serif;font-size:11px;color:#ccc;font-weight:600;letter-spacing:1px}
  .ap-lb-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#666;letter-spacing:1px;margin-top:2px}
  .ap-lb-score{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;min-width:60px;text-align:right}
  .ap-lb-score.gold{color:#ffd700}.ap-lb-score.silver{color:#c0c0c0}.ap-lb-score.bronze{color:#cd7f32}.ap-lb-score.std{color:#666}
  .ap-lb-bar{height:3px;border-radius:2px;margin-top:4px;transition:width .5s}
  .ap-lb-empty{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#555;padding:20px 0;text-align:center}

  /* ══════ FULL LEADERBOARD MODULE ══════ */
  #leaderboardModule{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.95);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #leaderboardModule.active{opacity:1;pointer-events:all}
  .lb-container{width:700px;max-width:96vw;height:85vh;display:flex;flex-direction:column;border-radius:8px;overflow:visible;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,215,0,.06);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .lb-header{padding:16px 24px;border-bottom:1px solid rgba(255,215,0,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .lb-title{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#ffd700;text-transform:uppercase;margin:0}
  .lb-header-right{display:flex;align-items:center;gap:14px}
  .lb-team-count{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#777;letter-spacing:1px}
  .lb-toolbar{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:rgba(255,255,255,.01)}
  .lb-search{background:#080a10;border:1px solid rgba(255,255,255,.06);border-radius:3px;padding:7px 12px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:10px;outline:none;width:160px;letter-spacing:1px}
  .lb-search:focus{border-color:rgba(255,215,0,.15)}
  .lb-search::placeholder{color:#444}
  .lb-filters{display:flex;gap:4px}
  .lb-filter{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:5px 10px;border-radius:3px;cursor:pointer;color:#666;border:1px solid var(--border);background:transparent;transition:all .2s}
  .lb-filter.active{color:#ffd700;border-color:rgba(255,215,0,.2);background:rgba(255,215,0,.04)}
  .lb-filter:hover{border-color:rgba(255,215,0,.12)}
  .lb-sort{display:flex;align-items:center;gap:6px;margin-left:auto}
  .lb-body{flex:1;overflow-y:auto;padding:12px 20px}
  .lb-pagination{display:flex;align-items:center;justify-content:center;gap:4px;padding:10px 20px;border-top:1px solid var(--border);flex-wrap:wrap}
  .lb-page-btn{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#888;letter-spacing:1px;padding:5px 10px;border:1px solid var(--border);border-radius:3px;background:rgba(255,255,255,.02);cursor:pointer;transition:all .2s}
  .lb-page-btn:hover{border-color:rgba(0,212,255,.3);color:var(--cyan)}
  .lb-page-btn.active{border-color:rgba(0,212,255,.4);color:var(--cyan);background:rgba(0,212,255,.06)}
  .lb-page-btn.disabled{opacity:.3;pointer-events:none}
  .lb-page-info{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:1px;padding:0 8px}
  .lb-msg-btn{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--cyan);letter-spacing:1px;cursor:pointer;padding:3px 8px;border:1px solid rgba(0,212,255,.2);border-radius:3px;background:rgba(0,212,255,.04);transition:all .2s;white-space:nowrap}
  .lb-msg-btn:hover{background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.4)}
  .lb-desub-btn{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--amber);letter-spacing:1px;cursor:pointer;padding:3px 8px;border:1px solid rgba(255,170,51,.2);border-radius:3px;background:rgba(255,170,51,.04);transition:all .2s;white-space:nowrap}
  .lb-desub-btn:hover{background:rgba(255,170,51,.1);border-color:rgba(255,170,51,.4)}
  .lb-desubmit-check{margin-right:6px;cursor:pointer}

  /* Leaderboard rows */
  .lb-row{border:1px solid var(--border);border-radius:5px;margin-bottom:6px;transition:border-color .2s;overflow:visible;cursor:pointer}
  .lb-row:hover{border-color:rgba(255,215,0,.1)}
  .lb-row.expanded{border-color:rgba(255,215,0,.15)}
  .lb-row-main{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .lb-rank{font-family:'Staatliches',cursive;font-size:18px;min-width:32px;text-align:center}
  .lb-rank.r1{color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,.3)}.lb-rank.r2{color:#c0c0c0;text-shadow:0 0 8px rgba(192,192,192,.2)}.lb-rank.r3{color:#cd7f32}.lb-rank.rn{color:#444}
  .lb-team-info{flex:1;min-width:0}
  .lb-team-name{font-family:'Saira',sans-serif;font-size:12px;color:#ddd;font-weight:600;letter-spacing:1px}
  .lb-team-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:#666;letter-spacing:1px;margin-top:2px;display:flex;gap:10px;flex-wrap:wrap}
  .lb-team-status{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:2px}
  .lb-team-status.on{background:var(--green);box-shadow:0 0 6px rgba(0,255,136,.4)}.lb-team-status.off{background:var(--amber);opacity:.5}
  .lb-score-block{text-align:right;min-width:70px}
  .lb-score-pct{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px}
  .lb-score-pct.r1{color:#ffd700}.lb-score-pct.r2{color:#c0c0c0}.lb-score-pct.r3{color:#cd7f32}.lb-score-pct.rn{color:#555}
  .lb-score-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:1px;margin-top:2px}
  .lb-progress{height:3px;border-radius:2px;margin:6px 16px 0;background:rgba(255,255,255,.03)}
  .lb-progress-fill{height:100%;border-radius:2px;transition:width .5s}

  /* Expanded team detail */
  .lb-detail{display:none;padding:0 16px 14px;border-top:1px solid var(--border);margin-top:0}
  .lb-row.expanded .lb-detail{display:block}
  .lb-detail-section{margin-top:12px}
  .lb-detail-title{font-family:'Saira',sans-serif;font-size:9px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:8px;font-weight:700}
  .lb-member-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(0,212,255,.02);border:1px solid rgba(0,212,255,.08);border-radius:4px;margin-bottom:4px}
  .lb-member-num{font-family:'Oxanium',sans-serif;font-size:10px;color:var(--cyan);font-weight:700;flex-shrink:0}
  .lb-member-name{font-family:'Chakra Petch',sans-serif;font-size:12px;color:#d2d2d2;font-weight:600;flex:1;line-height:1.2}
  .lb-member-meta{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#6a6a6a}
  .lb-field-row{display:flex;align-items:center;gap:8px;padding:4px 10px;border-bottom:1px solid rgba(255,255,255,.02)}
  .lb-field-label{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#888;flex:1}
  .lb-field-status{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:600;min-width:60px;text-align:right}
  .lb-field-status.correct{color:var(--green)}.lb-field-status.wrong{color:var(--red)}.lb-field-status.empty{color:#444}.lb-field-status.pending{color:var(--amber)}

  /* ══════ KEYS & CODES PANEL ══════ */
  #keysCodesPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #keysCodesPanel.active{opacity:1;pointer-events:all}
  .kc-container{width:600px;max-width:96vw;max-height:85vh;overflow-y:auto;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .kc-header{padding:18px 24px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .kc-header h3{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#d0f0e0;text-transform:uppercase;margin:0}
  .kc-body{padding:16px 24px}
  .kc-section{margin-bottom:20px}
  .kc-section-title{font-family:'Saira',sans-serif;font-size:12px;letter-spacing:3px;color:#d0e8f0;text-transform:uppercase;margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:8px}
  .kc-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;transition:border-color .2s}
  .kc-row:hover{border-color:rgba(0,255,136,.15)}
  .kc-icon{font-size:16px;flex-shrink:0}
  .kc-label{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#ccc;flex:1;min-width:0;letter-spacing:.3px;font-weight:500}
  .kc-value{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#d0f0d8;font-weight:700;letter-spacing:2px;padding:4px 10px;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);border-radius:3px;min-width:80px;text-align:center}
  .kc-edit{font-size:12px;cursor:pointer;color:#999;transition:color .2s;flex-shrink:0}
  .kc-edit:hover{color:#c0e8f8}
  .kc-empty{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#666;letter-spacing:1px;font-style:italic}

  /* Broadcast Panel */
  #broadcastPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #broadcastPanel.active{opacity:1;pointer-events:all}
  .bc-container{width:700px;max-width:96vw;border-radius:8px;
    background:linear-gradient(180deg,#14161e,#0e1018 40%,#0a0c12);
    border:1px solid rgba(255,255,255,.05);box-shadow:0 25px 80px rgba(0,0,0,.7)}
  .bc-header{padding:18px 24px;border-bottom:1px solid rgba(255,170,51,.08);background:linear-gradient(180deg,#1a1d28,#14161e);display:flex;align-items:center;justify-content:space-between}
  .bc-header h3{font-family:'Staatliches',cursive;font-size:13px;letter-spacing:4px;color:var(--amber);text-transform:uppercase;margin:0}
  .bc-body{padding:20px 24px}
  .bc-tabs{display:flex;gap:6px;margin-bottom:16px}
  .bc-tab{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;padding:6px 14px;border-radius:3px;cursor:pointer;color:#777;border:1px solid var(--border);transition:all .2s}
  .bc-tab.active{color:var(--amber);border-color:rgba(255,170,51,.2);background:rgba(255,170,51,.04)}
  .bc-textarea{width:100%;background:#080a10;border:1px solid rgba(255,255,255,.06);border-radius:3px;padding:12px;color:#ccc;font-family:'Chakra Petch',sans-serif;font-size:12px;line-height:1.6;outline:none;resize:none;height:80px;box-sizing:border-box}
  .bc-textarea:focus{border-color:rgba(255,170,51,.2)}
  .bc-voice{display:flex;flex-direction:column;align-items:center;gap:14px;padding:10px 0}
  .bc-rec-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;transition:all .2s;
    background:linear-gradient(180deg,rgba(60,20,20,.5),rgba(40,12,12,.6));border:2px solid rgba(255,50,50,.2)}
  .bc-rec-btn:hover{border-color:rgba(255,50,50,.4)}
  .bc-rec-btn.recording{border-color:rgba(255,50,50,.6);box-shadow:0 0 20px rgba(255,50,50,.2);animation:ledPulse 1s ease-in-out infinite}
  .bc-rec-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#777;letter-spacing:1px}
  .bc-preview{width:100%;margin-top:10px}
  .bc-preview audio{width:100%;height:36px}
  .bc-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}

  /* Player broadcast banner */
  #playerBanner{position:fixed;top:-80px;left:0;right:0;z-index:900;transition:top .5s cubic-bezier(.25,.46,.45,.94);pointer-events:none;visibility:hidden;opacity:0}
  #playerBanner.show{top:0;pointer-events:all;visibility:visible;opacity:1}
  .pb-inner{display:flex;align-items:center;justify-content:center;gap:14px;padding:16px 24px;position:relative;
    background:linear-gradient(180deg,rgba(255,170,51,.15),rgba(255,140,20,.08));
    border-bottom:1px solid rgba(255,170,51,.25);box-shadow:0 4px 20px rgba(0,0,0,.4);backdrop-filter:blur(8px)}
  .pb-icon{font-size:20px;flex-shrink:0}
  .pb-text{font-family:'Saira',sans-serif;font-size:15px;color:#fff;font-weight:600;line-height:1.5;text-align:center;letter-spacing:.5px;text-shadow:0 1px 3px rgba(0,0,0,.3)}
  .pb-audio{display:flex;align-items:center;gap:10px;justify-content:center}
  .pb-audio-play{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;
    background:rgba(255,170,51,.1);border:1px solid rgba(255,170,51,.2);color:var(--amber);flex-shrink:0;transition:all .2s}
  .pb-audio-play:hover{background:rgba(255,170,51,.2)}
  .pb-audio-label{font-family:'Saira',sans-serif;font-size:12px;color:var(--amber);letter-spacing:1px;font-weight:600}
  .pb-close{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:16px;cursor:pointer;color:#999;flex-shrink:0;padding:4px 8px;transition:color .2s;border-radius:3px}
  .pb-close:hover{color:#fff;background:rgba(255,255,255,.05)}
  .pb-progress{position:absolute;bottom:0;left:0;height:2px;background:var(--amber);transition:width .1s linear;box-shadow:0 0 6px rgba(255,170,51,.3)}
  /* Admin mode — no content offset (dropdown-based) */

  /* Admin timer controls — now in admin panel */
  .admin-timer-btn{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:3px 10px;cursor:pointer;border-radius:2px;transition:all .2s;background:none;border:1px solid rgba(0,212,255,.2);color:var(--cyan)}
  .admin-timer-btn:hover{background:rgba(0,212,255,.08);border-color:rgba(0,212,255,.4)}
  .admin-timer-input{width:70px;background:#080a10;border:1px solid var(--border);border-radius:2px;padding:3px 6px;color:var(--cyan);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;outline:none;text-align:center}

  .admin-edit-btn{display:none;position:absolute;top:6px;right:6px;width:24px;height:24px;background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.3);border-radius:3px;color:var(--cyan);font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:10;transition:all .15s}
  .admin-edit-btn:hover{background:rgba(0,212,255,.25)}
  /* Admin mode: hover-reveal edit controls */
  body.admin-mode:not(.player-preview) .admin-edit-btn{display:flex;opacity:0;pointer-events:none}
  body.admin-mode:not(.player-preview) .feed-card:hover .admin-edit-btn,
  body.admin-mode:not(.player-preview) .media-exp-item:hover .admin-edit-btn,
  body.admin-mode:not(.player-preview) .intel-exp-row:hover .admin-edit-btn,
  body.admin-mode:not(.player-preview) .crt-monitor:hover .admin-edit-btn{opacity:1;pointer-events:all}
  .admin-edit-inline{display:none;width:18px;height:18px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.25);border-radius:3px;color:var(--cyan);font-size:9px;cursor:pointer;align-items:center;justify-content:center;margin-left:8px;vertical-align:middle;transition:all .15s;flex-shrink:0}
  .admin-edit-inline:hover{background:rgba(0,212,255,.25)}
  body.admin-mode:not(.player-preview) .admin-edit-inline{display:inline-flex;opacity:0;pointer-events:none}
  body.admin-mode:not(.player-preview) *:hover>.admin-edit-inline{opacity:1;pointer-events:all}
  .admin-add-btn{display:none;background:var(--bg-surface);border:2px dashed rgba(0,212,255,.15);border-radius:5px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;color:#777;font-size:10px;letter-spacing:2px}
  .admin-add-btn:hover{border-color:var(--cyan);color:var(--cyan)}
  body.admin-mode:not(.player-preview) .admin-add-btn{display:block}
  /* Legacy admin-row-edit rules — now handled by .intel-admin-tools overlay */
  .admin-row-edit{display:none;width:18px;height:18px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:3px;color:var(--cyan);font-size:8px;cursor:pointer;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
  .admin-row-edit:hover{background:rgba(0,212,255,.2)}
  /* Only show via .intel-admin-tools now — disable old body.admin-mode rules */
  body.admin-mode:not(.player-preview) .intel-exp-row>.admin-row-edit{display:none}
  body.admin-mode:not(.player-preview) *:hover>.intel-exp-row>.admin-row-edit{display:none}
  /* Touch devices — always show edit controls since no hover */
  @media(hover:none){
    body.admin-mode:not(.player-preview) .admin-edit-btn,
    body.admin-mode:not(.player-preview) .admin-edit-inline,
    body.admin-mode:not(.player-preview) .admin-row-edit{opacity:1!important;pointer-events:all!important}
  }

  /* Team View mode — removed, replaced by admin-mode hover approach */
  .edit-field-row{display:flex;gap:10px}.edit-field-row .edit-field{flex:1}
  #em_ico_select{width:52px;overflow:visible;text-overflow:'';transition:width .15s}
  #em_ico_select.ico-expanded,#em_ico_select:focus{width:100%}
  .edit-box .edit-field input[type="file"]{padding:8px}
  .edit-font-row{display:flex;gap:10px;align-items:flex-end}
  .edit-font-row .edit-field:first-child{flex:1}
  .edit-font-row .edit-field:last-child{flex:0 0 160px}
  .edit-field select option{padding:4px 8px}

  #adminEditModal{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #adminEditModal.active{opacity:1;pointer-events:all}
  .edit-box{width:500px;max-width:92vw;max-height:85vh;overflow-y:auto;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.5);box-sizing:border-box}
  .edit-box h3{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:16px}
  .edit-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
  .edit-field label{font-size:9px;color:#888;letter-spacing:2px;text-transform:uppercase}
  .edit-field input,.edit-field textarea,.edit-field select{background:#080a10;border:1px solid var(--border);border-radius:3px;padding:10px 12px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;transition:border-color .2s;resize:vertical;box-sizing:border-box;width:100%;max-width:100%}
  .edit-field input:focus,.edit-field textarea:focus{border-color:rgba(0,212,255,.3)}
  .edit-field textarea{min-height:80px}
  .edit-field select{color:#ccc}
  .edit-tabs{display:flex;gap:4px;margin-bottom:8px}
  .edit-tab{padding:6px 14px;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;border:1px solid #444;border-radius:3px;background:none;color:#888;transition:all .2s}
  .edit-tab.active{color:var(--cyan);border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.05)}
  .edit-tab-content{display:none}
  .edit-tab-content.active{display:block}
  .upload-zone{border:2px dashed #444;border-radius:4px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;color:#888;font-size:9px;letter-spacing:1px}
  .upload-zone:hover{border-color:var(--cyan);color:var(--cyan)}
  .upload-zone.has-file{border-color:var(--green);color:var(--green);border-style:solid}
  .upload-preview{max-width:100%;max-height:120px;border-radius:3px;margin-top:8px}

  /* ══════ NOTEPAD ══════ */
  .notepad-trigger{position:fixed;bottom:12px;left:12px;z-index:600;display:none;align-items:center;gap:7px;background:linear-gradient(180deg,#1e2028,#161820);border:1px solid #3a3d44;border-radius:5px;padding:8px 18px 8px 14px;cursor:pointer;transition:all .3s;box-shadow:0 2px 10px rgba(0,0,0,.3)}
  .notepad-trigger.visible{display:flex}
  body.admin-mode .notepad-trigger{display:none!important}
  .notepad-trigger:hover{border-color:var(--green-dim);box-shadow:0 4px 16px rgba(0,0,0,.4),0 0 15px rgba(0,255,136,.05)}
  .notepad-trigger svg{width:15px;height:15px;fill:none;stroke:var(--green);stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  .notepad-trigger span{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:#bbb;font-weight:700;text-transform:uppercase}
  .notepad-dot{width:6px;height:6px;border-radius:50%;background:#444;margin-left:4px;transition:background .3s}
  .notepad-dot.has-notes{background:var(--green);box-shadow:0 0 4px var(--green)}

  #notepadPanel{position:fixed;bottom:0;left:12px;transform:translateY(100%);z-index:650;width:480px;max-height:60vh;border:1px solid rgba(255,255,255,.06);border-bottom:none;border-radius:8px 8px 0 0;display:flex;flex-direction:column;overflow:visible;transition:transform .35s cubic-bezier(.25,.46,.45,.94);
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(175deg,#141620,#0e1018 40%,#0a0c12);
    box-shadow:0 -8px 40px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.02)}
  #notepadPanel.open{transform:translateY(0)}
  .notepad-header{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(0,255,136,.08);background:linear-gradient(180deg,#1a1d28,#14161e);flex-shrink:0}
  .notepad-header-title{font-family:'Staatliches',cursive;font-size:15px;letter-spacing:3px;color:#d0f0e0;text-transform:uppercase}
  .notepad-header-icon{font-size:14px;margin-right:10px}
  .notepad-header-actions{margin-left:auto;display:flex;gap:8px}
  .notepad-hint{font-family:'Chakra Petch',sans-serif;padding:0 18px;font-size:11px;color:#777;letter-spacing:.5px;line-height:1.6;padding-top:12px;padding-bottom:4px;flex-shrink:0;font-style:italic;font-weight:500}
  .notepad-body{flex:1;padding:8px 18px 18px;overflow:visible;display:flex;min-height:200px}
  .notepad-textarea{width:100%;background:transparent;border:none;outline:none;color:#ccc;font-family:'Chakra Petch',sans-serif;font-size:13px;font-weight:500;line-height:1.8;letter-spacing:.5px;resize:none;flex:1}
  .notepad-textarea::placeholder{color:#333}
  .notepad-footer{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;border-top:1px solid var(--border);flex-shrink:0}
  .notepad-charcount{font-family:'Chakra Petch',sans-serif;font-size:9px;color:#666;letter-spacing:1px;font-weight:500}
  .notepad-clear{font-family:'Saira',sans-serif;font-size:9px;font-weight:600;letter-spacing:2px;color:#777;background:none;border:1px solid #333;padding:4px 12px;border-radius:3px;cursor:pointer;transition:all .2s;font-weight:bold}
  .notepad-clear:hover{color:var(--red);border-color:rgba(255,50,50,.3)}

  /* Allow text selection in inputs and textarea */
  input,textarea{-webkit-user-select:text;user-select:text}

  /* Overscroll rubber band */
  .overscroll-wrap{overscroll-behavior-y:none;position:relative}
  .overscroll-pull{position:absolute;top:-50px;left:0;right:0;height:50px;display:flex;align-items:flex-end;justify-content:center;pointer-events:none;opacity:0;transition:opacity .2s}
  .overscroll-pull span{font-size:8px;color:#555;letter-spacing:2px;padding-bottom:8px}

  /* ══════ MEDIA VIEWER ══════ */
  #mediaViewer{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.95);opacity:0;pointer-events:none;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
  #mediaViewer.active{opacity:1;pointer-events:all}
  .mv-container{width:92vw;height:90vh;display:flex;flex-direction:column;border-radius:6px;overflow:visible;
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.003) 1px,rgba(255,255,255,.003) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#0e1018,#0a0c12,#080a0e);
    border:1px solid rgba(255,255,255,.05);
    box-shadow:0 25px 100px rgba(0,0,0,.8)}
  .mv-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid rgba(0,255,136,.08);
    background:
      repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(255,255,255,.004) 1px,rgba(255,255,255,.004) 2px,transparent 2px,transparent 4px),
      linear-gradient(180deg,#1a1d28,#14161e);flex-shrink:0}
  .mv-header-info{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
  .mv-icon{font-size:20px;flex-shrink:0}
  .mv-header-text{display:flex;flex-direction:column;gap:2px;min-width:0}
  .mv-filename{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#ccc;font-weight:600;letter-spacing:1px;white-space:nowrap;overflow:visible;text-overflow:ellipsis}
  .mv-filedesc{font-family:'Chakra Petch',sans-serif;font-size:10px;color:#666;letter-spacing:.5px;font-weight:500;white-space:nowrap;overflow:visible;text-overflow:ellipsis}
  .mv-badge{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:2px;font-weight:600;padding:4px 12px;border-radius:3px;text-transform:uppercase;flex-shrink:0;margin-left:auto}
  .mv-badge.audio{color:var(--cyan);border:1px solid rgba(0,212,255,.15);background:rgba(0,212,255,.04)}
  .mv-badge.video{color:#c084fc;border:1px solid rgba(192,132,252,.15);background:rgba(192,132,252,.04)}
  .mv-badge.doc{color:var(--green);border:1px solid rgba(0,255,136,.1);background:rgba(0,255,136,.03)}
  .mv-badge.map{color:var(--amber);border:1px solid rgba(255,170,51,.15);background:rgba(255,170,51,.04)}
  .mv-badge.locked{color:#777;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02)}
  .mv-close{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:#999;cursor:pointer;padding:8px 18px;border-radius:4px;transition:all .2s;flex-shrink:0;margin-left:16px;
    background:linear-gradient(180deg,rgba(40,42,48,.5),rgba(22,24,30,.6));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #08080c}
  .mv-close:hover{color:#fff;border-color:rgba(255,255,255,.12)}
  .mv-close:active{transform:translateY(1px);border-bottom-width:1px}
  .mv-download{font-family:'Saira',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--green);cursor:pointer;padding:8px 16px;border-radius:4px;transition:all .2s;flex-shrink:0;
    background:linear-gradient(180deg,rgba(15,40,25,.4),rgba(10,25,15,.5));border:1px solid rgba(0,255,136,.12);border-bottom:2px solid rgba(0,255,136,.08)}
  .mv-download:hover{border-color:rgba(0,255,136,.25);background:rgba(0,255,136,.06)}

  .mv-body{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;position:relative}

  /* PDF / Doc viewer */
  .mv-pdf-frame{width:100%;height:100%;border:none;border-radius:4px;background:#111}
  .mv-image-viewer{max-width:100%;max-height:100%;object-fit:contain;border-radius:4px;cursor:pointer;transition:transform .3s;-webkit-user-drag:none;-webkit-user-select:none;user-select:none}
  .mv-image-viewer.zoomed{cursor:pointer;transform:scale(1.8)}
  .mv-body video,.mv-body img{-webkit-user-select:none;user-select:none}

  /* Cursor hard-reset (prevents stuck zoom/grab cursors after closing viewers on some mobile/desktop combos) */
  html.cursor-kill,body.cursor-kill{cursor:auto !important;}
  html.cursor-kill * , body.cursor-kill * {cursor:auto !important;}

  /* Audio player */
  .mv-audio-player{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;gap:20px;padding:40px}
  .mv-audio-icon{font-size:80px;opacity:.4;filter:grayscale(.5)}
  .mv-audio-title{font-family:'IBM Plex Mono',monospace;font-size:13px;color:#aaa;letter-spacing:2px;text-align:center}
  .mv-audio-controls{width:100%;display:flex;flex-direction:column;gap:12px}
  .mv-audio-bar-wrap{width:100%;height:6px;background:rgba(255,255,255,.06);border-radius:3px;cursor:pointer;position:relative;overflow:hidden}
  .mv-audio-bar{height:100%;background:linear-gradient(90deg,var(--cyan),var(--green));border-radius:3px;width:0%;transition:width .1s linear}
  .mv-audio-btns{display:flex;align-items:center;justify-content:center;gap:16px}
  .mv-audio-btn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:16px;
    background:linear-gradient(180deg,rgba(40,42,48,.6),rgba(22,24,30,.7));border:1px solid rgba(255,255,255,.08);color:#ccc}
  .mv-audio-btn:hover{border-color:rgba(0,255,136,.2);color:var(--green)}
  .mv-audio-btn.playing{border-color:rgba(0,255,136,.3);color:var(--green);box-shadow:0 0 12px rgba(0,255,136,.1)}
  .mv-audio-time{display:flex;justify-content:space-between;font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:1px}
  .mv-audio-vol{display:flex;align-items:center;gap:8px}
  .mv-audio-vol-bar{width:80px;height:4px;background:rgba(255,255,255,.06);border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
  .mv-audio-vol-fill{height:100%;background:var(--cyan);border-radius:2px;width:80%}
  .mv-audio-vol-icon{font-size:12px;color:#666;cursor:pointer}

  /* Video player */
  .mv-video-wrap{width:100%;max-width:900px;position:relative;border-radius:4px;overflow:visible;background:#000}
  .mv-video{width:100%;display:block;border-radius:4px}
  .mv-video-controls{position:absolute;bottom:0;left:0;right:0;padding:12px 16px;background:linear-gradient(transparent,rgba(0,0,0,.8));display:flex;align-items:center;gap:12px;opacity:0;transition:opacity .3s}
  .mv-video-wrap:hover .mv-video-controls{opacity:1}
  .mv-video-play{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:12px;flex-shrink:0}
  .mv-video-bar{flex:1;height:4px;background:rgba(255,255,255,.15);border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
  .mv-video-progress{height:100%;background:var(--green);border-radius:2px;width:0%}
  .mv-video-time{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#aaa;letter-spacing:1px;flex-shrink:0}
  .mv-video-full{cursor:pointer;color:#aaa;font-size:14px;flex-shrink:0}

  /* Locked file */
  .mv-locked{display:flex;flex-direction:column;align-items:center;gap:16px;padding:40px}
  .mv-locked-icon{font-size:80px;opacity:.3}
  .mv-locked-title{font-family:'Staatliches',cursive;font-size:14px;letter-spacing:4px;color:#555;text-transform:uppercase}
  .mv-locked-desc{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#444;letter-spacing:1px;text-align:center;max-width:400px;line-height:1.6}
  .mv-locked-input-wrap{display:flex;gap:8px;align-items:center}
  .mv-locked-input{background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:10px 14px;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;width:200px;text-align:center}
  .mv-locked-input:focus{border-color:rgba(0,255,136,.2)}
  .mv-locked-submit{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--green);cursor:pointer;padding:10px 20px;border-radius:3px;
    background:linear-gradient(180deg,rgba(15,40,25,.5),rgba(10,25,15,.6));border:1px solid rgba(0,255,136,.15);border-bottom:2px solid rgba(0,255,136,.1);transition:all .2s}
  .mv-locked-submit:hover{border-color:rgba(0,255,136,.3)}

  /* No file placeholder */
  .mv-no-file{display:flex;flex-direction:column;align-items:center;gap:12px;color:#444}
  .mv-no-file-icon{font-size:60px;opacity:.3}
  .mv-no-file-text{font-family:'Chakra Petch',sans-serif;font-size:11px;letter-spacing:1px}

  /* Navigation */
  .mv-nav{display:flex;align-items:center;justify-content:center;gap:20px;padding:12px 20px;border-top:1px solid rgba(255,255,255,.04);flex-shrink:0;
    background:linear-gradient(180deg,#0c0e14,#0a0c10)}
  .mv-nav-btn{font-family:'Saira',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:#888;cursor:pointer;padding:8px 20px;border-radius:3px;transition:all .2s;
    background:linear-gradient(180deg,rgba(40,42,48,.4),rgba(22,24,30,.5));border:1px solid rgba(255,255,255,.06);border-bottom:2px solid #08080c}
  .mv-nav-btn:hover{color:#ccc;border-color:rgba(255,255,255,.12)}
  .mv-nav-btn:active{transform:translateY(1px);border-bottom-width:1px}
  .mv-nav-counter{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#555;letter-spacing:2px}

  /* ══════ RESPONSIVE ══════ */

  /* Allow scrolling on mobile */
  @media(max-width:768px){
    body{overflow-y:auto;overflow-x:hidden}
  }

  /* Tablet */
  @media(max-width:1024px){
    .console-grid{gap:16px;padding:16px}
    .crt-monitor{padding:10px} .crt-screen{padding:30px 18px 24px}
    .tile-icon{font-size:40px;margin-bottom:14px}
    .tile-label{font-size:12px;letter-spacing:3px}
    .expanded-panel{width:96vw;height:92vh}
    .feed-expanded{max-width:100%}
    .intel-expanded{max-width:100%}
    .media-expanded{max-width:100%}
    .confirm-box{width:90vw;max-width:600px}
    .edit-box{width:90vw;max-width:500px}
    .logout-box{width:90vw;max-width:380px}
    #notepadPanel{width:90vw;max-width:480px}
  }

  /* Half-screen desktop / narrow window */
  @media(max-width:1100px){

    /* Topbar — keep horizontal, just tighter */
    .console-topbar{height:auto;min-height:48px;padding:8px 14px}
    .console-title{font-size:12px;letter-spacing:2px}
    .timer-block{position:relative;left:auto;transform:none}
    .timer-digits{font-size:18px;letter-spacing:3px}
    .timer-label{font-size:7px;letter-spacing:2px}
    .console-team{font-size:11px;letter-spacing:2px;padding:4px 10px}

    /* Grid — 2 columns, centered */
    .console-grid{gap:16px;padding:16px;align-content:start;padding-top:20px}
    .crt-monitor{padding:10px}
    .crt-screen{padding:28px 16px 22px}
    .tile-icon{font-size:38px;margin-bottom:12px}
    .tile-label{font-size:12px;letter-spacing:3px}
    .tile-sub{font-size:9px}

    /* Login */
    .login-container{gap:14px}
    .login-title{font-size:14px}
    .login-panel{width:380px;padding:22px 18px 16px}

    /* Registration */
    .reg-container{max-width:480px}
    .reg-panel{padding:22px 20px 18px}

    /* Landing */
    .landing-container{max-width:440px}

    /* Panels */
    .expanded-panel{width:96vw;height:92vh}
    .confirm-box{width:90vw;max-width:500px}
    .edit-box{width:90vw;max-width:460px}
  }

  /* Mobile */
  @media(max-width:768px){
    /* Login */
    .login-panel{width:92vw;max-width:420px;padding:20px 16px 14px}
    .login-field input{font-size:16px;letter-spacing:3px;padding:14px 14px}
    .login-title{font-size:11px;letter-spacing:2px}
    .vault-subtitle{font-size:8px;letter-spacing:3px}
    .v-display{min-height:74px;padding:10px 12px}
    #vDisp{font-size:18px;letter-spacing:6px}
    .kb-row{max-width:100%;gap:3px;margin-bottom:3px}
    .kb-key{height:38px}
    .kb-key span{font-size:12px}

    /* Console */
    #consoleScreen{height:auto;min-height:100vh;min-height:100dvh}
    .console-topbar{height:50px;padding:0 14px;padding-top:env(safe-area-inset-top,0)}
    .console-title{font-size:9px;letter-spacing:3px}
    .timer-digits{font-size:16px;letter-spacing:2px}
    .timer-label{font-size:7px}
    .console-team{font-size:10px}

    /* Grid — 2x2 on mobile so all 4 tiles visible without scrolling */
    .console-grid{grid-template-columns:1fr 1fr;gap:10px;padding:12px;align-content:center;padding-top:16px}

    /* Allow console to scroll on mobile */
    #consoleScreen{position:fixed;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .crt-monitor{padding:10px} .crt-screen{padding:24px 16px 20px}
    .tile-icon{font-size:36px;margin-bottom:12px}
    .tile-label{font-size:11px;letter-spacing:2px}
    .tile-sub{font-size:9px}
    .tile-badge{font-size:7px;letter-spacing:2px;padding:4px 12px}
    .tile-status span{font-size:7px}

    /* Expanded panels */
    .expanded-panel{width:100vw;height:100vh;border-radius:0;border:none}
    .exp-header{height:52px;padding:0 14px}
    .exp-title{font-size:11px;letter-spacing:2px}
    .exp-body{padding:12px}
    .exp-close{padding:10px 18px;font-size:10px;min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center}
    .feed-count-badge{font-size:10px;padding:3px 7px;letter-spacing:1px;margin-left:6px}

    /* Feed — keep 3 column grid on mobile, tight gaps like IG */
    .feed-expanded{grid-template-columns:repeat(3,1fr);gap:2px;max-width:100%}
    .feed-card-img{font-size:24px}
    .feed-card-cap p{font-size:9px}
    .feed-view-btn{padding:4px 7px;font-size:7px}
    .feed-single{max-width:100%;gap:12px}
    .feed-single-img{border-radius:0}
    .feed-single-caption{font-size:12px;max-width:100%;padding:0 8px}
    .feed-nav-btn,.feed-back-grid{padding:8px 16px;font-size:9px}

    /* Media */
    .media-expanded{max-width:100%}
    .media-exp-item{padding:12px 14px;gap:10px}
    .media-exp-name{font-size:11px}
    .media-exp-desc{font-size:8px}

    /* Intel */
    .intel-expanded{max-width:100%;gap:8px}
    .intel-exp-row{max-width:100%;flex-wrap:wrap;padding:12px;gap:8px;position:relative padding-right:28px;}
    .intel-exp-num{width:24px;font-size:10px}
    .intel-exp-label{width:100%;font-size:10px;margin-bottom:2px}
    .intel-exp-input{font-size:16px;padding:8px 10px;width:100%;flex:1}
    .intel-prefix-wrap{width:100%;flex:1}
    .intel-dual-wrap{width:100%;flex:1;flex-direction:column;gap:6px}
    .intel-dual-sep{display:none}
    .intel-submit-btn{padding:10px 30px;font-size:9px;letter-spacing:3px}

    /* Confirm modal */
    .confirm-box{width:94vw;max-height:85vh}
    .confirm-header{padding:14px 16px}
    .confirm-header h3{font-size:10px;letter-spacing:3px}
    .confirm-body{padding:12px 16px}
    .confirm-row{flex-direction:column;gap:4px;align-items:flex-start}
    .confirm-value{text-align:left;max-width:100%}
    .confirm-footer{padding:12px 16px;gap:8px}
    .btn-standard{padding:8px 18px;font-size:9px}

    /* Media Viewer */
    .mv-container{width:100vw;height:100vh;border-radius:0}
    .mv-header{padding:10px 14px}
    .mv-filename{font-size:10px}
    .mv-filedesc{font-size:8px}
    .mv-close{padding:6px 14px;font-size:9px}
    .mv-body{padding:12px}
    .mv-audio-player{padding:20px}
    .mv-nav-btn{padding:6px 14px;font-size:9px}
    .mv-video-controls{padding:8px 12px}

    /* Notepad */
    #notepadPanel{width:100vw;max-height:85vh;border-radius:12px 12px 0 0;left:0;transform:translateY(100%)}
    #notepadPanel.open{transform:translateY(0)}
    .notepad-header{padding:12px 16px}
    .notepad-header-title{font-size:10px;letter-spacing:2px}
    .notepad-hint{padding:8px 16px;font-size:9px}
    .notepad-body{min-height:40vh;padding:8px 16px 16px}
    .notepad-textarea{font-size:14px;line-height:1.9;-webkit-user-select:text;user-select:text}
    .notepad-footer{padding:10px 16px}
    .notepad-charcount{font-size:8px}
    .notepad-clear{padding:6px 14px;font-size:9px}
    .notepad-trigger{bottom:calc(10px + env(safe-area-inset-bottom,0));left:10px;padding:8px 16px 8px 12px}
    .notepad-trigger span{font-size:8px;letter-spacing:2px}

    /* Logout — safe area bottom */
    .logout-btn{bottom:calc(10px + env(safe-area-inset-bottom,0));left:10px;padding:8px 14px}
    .logout-btn span{font-size:10px;letter-spacing:2px}
    .logout-btn svg{width:14px;height:14px}

    /* Admin */
    .admin-login-box{width:90vw;max-width:340px;padding:22px 18px}
    .edit-box{width:94vw;max-width:500px;padding:18px}
    .ap-container{width:96vw;max-height:90vh}
    .ap-section{padding:16px 20px}
    .ap-row{flex-direction:column}
    .bc-container{width:96vw}
    .pb-inner{padding:10px 14px}
    .pb-text{font-size:11px}
    .admin-dropdown{width:200px;bottom:calc(48px + env(safe-area-inset-bottom,0));right:8px}
    .lb-container{width:100vw;height:100vh;border-radius:0}
    .lb-toolbar{flex-direction:column;align-items:stretch}
    .lb-search{width:100%}
    .lb-sort{margin-left:0}
    .lb-rank{font-size:14px;min-width:26px}
    .lb-score-pct{font-size:13px}
    .kc-container{width:96vw}

    /* Vault panel on mobile */
    .v-key-list{max-height:40vh;overflow-y:auto}
    .v-key-item{padding:10px 12px}
    .v-key-label{font-size:10px}
    .v-key-desc{font-size:8px}

    /* Event lock overlay & public leaderboard */
    #eventLockOverlay{padding:20px}
    #publicLeaderboard{padding:10px}

    /* Registration form on mobile — better touch targets + scrollable */
    #regScreen{overflow-y:auto;-webkit-overflow-scrolling:touch}
    .reg-field input,.reg-field select{font-size:16px}
    .reg-member-input{font-size:16px;padding:10px 12px}
    .reg-member-input::placeholder{font-size:12px}

    /* Team card on mobile */
    .team-card{width:92vw;max-width:340px}
    .team-card .tc-field{font-size:9px}

    /* Edit modal on mobile — ensure inputs aren't tiny */
    .edit-box input,.edit-box select,.edit-box textarea{font-size:16px}

    /* Media viewer — full bleed on mobile */
    .mv-container{border-radius:0}
    .mv-pdf-frame{min-height:60vh}

    /* Admin panels — prevent horizontal overflow + iOS input zoom prevention */
    .ap-field input,.ap-field select{font-size:16px}
    .ap-field label{font-size:9px}

    /* All remaining inputs — prevent iOS auto-zoom */
    #mediaSearchFilter{font-size:16px!important}
    .intel-exp-input{font-size:16px}

    /* Topbar timer — ensure visible */
    .timer-block{flex-shrink:0}

    /* Console grid tile adjustments for 2x2 layout */
    .tile-icon{font-size:32px;margin-bottom:8px}
    .tile-label{font-size:10px;letter-spacing:2px}
    .tile-sub{font-size:8px}
    .tile-badge{font-size:6px;letter-spacing:2px;padding:3px 8px}
    .tile-status span{font-size:6px}
    .crt-monitor{padding:6px}
    .crt-screen{padding:16px 10px 14px}

    /* Admin tab bar — safe area bottom */
    .admin-tab-bar{padding-bottom:env(safe-area-inset-bottom,0)!important}
  }

  /* Small phones */
  @media(max-width:380px){
    .login-panel{padding:16px 12px 12px}
    .kb-key{height:34px}
    .kb-key span{font-size:11px}
    .login-title{font-size:10px;letter-spacing:4px}
    .tile-label{font-size:9px}
    .tile-icon{font-size:24px}
    .tile-sub{font-size:7px}
    .crt-monitor{padding:5px} .crt-screen{padding:12px 8px 10px}
    .intel-exp-label{font-size:9px}
    .console-grid{gap:8px;padding:10px}
  }

  /* Mobile overrides for new features */
  @media(max-width:480px){
    .tut-tooltip{max-width:calc(100vw - 32px);padding:16px 18px}
    .tut-tooltip-title{font-size:13px;letter-spacing:1.5px}
    .tut-tooltip-body{font-size:12px}
    .tut-btn{padding:5px 12px;font-size:9px}
    .tut-step-card{padding:8px 10px;gap:8px}
    .tut-step-card .tut-text textarea{font-size:10px}
    .tut-step-card .tut-icon{font-size:14px}
    .session-btn{padding:10px 14px;gap:10px}
    .session-btn .sb-title{font-size:10px}
    .session-btn .sb-desc{font-size:8px}
    .briefing-container{width:96%}
    .briefing-title{font-size:13px;letter-spacing:2px}
    .briefing-continue{padding:8px 24px;font-size:10px}
    /* Vault mobile — fit keypad to screen */
    .vault-panel{width:100%;padding:20px 14px 16px}
    .vault-puzzle-layout{max-width:100%;padding:0 4px}
    .kb-key{height:36px}
    .kb-key span{font-size:11px}
    .kb-key.fn span{font-size:9px}
    .v-display{min-height:68px;padding:8px 10px;margin-bottom:14px}
    #vDisp{font-size:16px;letter-spacing:4px}
    .vault-unlock-section{width:100%;max-width:100%}
  }

  /* Touch devices — always show drag handles in admin mode */
  @media(hover:none){
    body.admin-mode:not(.player-preview) .intel-exp-row .drag-handle{opacity:.5!important}
  }

  /* Reduced motion — helps low-end devices and accessibility */
  @media(prefers-reduced-motion:reduce){
    *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}
    .landing-circuits{display:none}
    #grainCanvas{display:none}
    .dust{display:none}
  }

  @keyframes shake{0%,100%{transform:translateX(0)}10%{transform:translateX(-5px)}20%{transform:translateX(5px)}30%{transform:translateX(-4px)}40%{transform:translateX(4px)}50%{transform:translateX(-2px)}60%{transform:translateX(2px)}}
  .flash-green{position:fixed;inset:0;background:rgba(0,255,136,.06);z-index:8500;opacity:0;pointer-events:none;transition:opacity .3s}
  .flash-green.on{opacity:1}
  .flash-red{position:fixed;inset:0;background:rgba(255,30,30,.05);z-index:8500;opacity:0;pointer-events:none;transition:opacity .2s}
  .flash-red.on{opacity:1}
  .dust{position:fixed;width:1px;height:1px;background:rgba(255,255,255,.08);border-radius:50%;pointer-events:none;z-index:9998;animation:dustF linear infinite}
  @keyframes dustF{0%{transform:translateY(100vh) translateX(0);opacity:0}10%{opacity:.15}90%{opacity:.15}100%{transform:translateY(-20px) translateX(20px);opacity:0}}
  /* Drag-to-reorder */
  .drag-handle{display:none;cursor:grab;padding:2px 4px;color:#444;font-size:14px;letter-spacing:-2px;user-select:none;-webkit-user-select:none;touch-action:none;flex-shrink:0;align-self:center}
  .drag-handle:hover{color:#888}
  .drag-handle:active{cursor:grabbing}
  body.admin-mode:not(.player-preview) .intel-exp-row>.drag-handle{display:none}
  body.admin-mode:not(.player-preview) .feed-card:hover .drag-handle,
  body.admin-mode:not(.player-preview) .media-exp-item:hover .drag-handle,
  body.admin-mode:not(.player-preview) .intel-exp-row:hover .drag-handle{opacity:1}
  @media(hover:none){body.admin-mode.reorder-mode:not(.player-preview) .drag-handle{opacity:1!important}}
  .feed-card.drag-over{border-color:var(--cyan)!important;box-shadow:0 0 12px rgba(0,212,255,.2)!important}
  .feed-card.dragging{opacity:.35;pointer-events:none}
  .media-exp-item.drag-over{border-color:var(--cyan)!important;box-shadow:0 0 12px rgba(0,212,255,.2)!important}
  .intel-exp-row.drag-over{border-color:var(--cyan)!important;box-shadow:0 0 12px rgba(0,212,255,.2)!important;background:rgba(0,212,255,.04)!important}
  .media-exp-item.dragging{opacity:.35;pointer-events:none}
  .intel-exp-row.dragging{opacity:.35;pointer-events:none}
  .drag-ghost{position:fixed;pointer-events:none;z-index:9999;opacity:.85;transform:scale(.95);box-shadow:0 12px 40px rgba(0,0,0,.5);border-radius:4px;overflow:hidden}
  /* Landing Page Preview */
  #landingPreviewOverlay{position:fixed;top:0;left:0;right:0;z-index:9500;display:none;pointer-events:none}
  #landingPreviewOverlay.active{display:block}
  .lp-preview-bar{display:flex;align-items:center;justify-content:center;gap:16px;padding:12px 20px;background:linear-gradient(180deg,rgba(0,0,0,.9) 60%,transparent);pointer-events:all}
  .lp-preview-label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;opacity:.7}
  .lp-preview-close{font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;padding:6px 16px;border:1px solid rgba(0,212,255,.3);border-radius:3px;background:rgba(0,212,255,.08);color:var(--cyan);cursor:pointer;transition:all .2s}
  .lp-preview-close:hover{background:rgba(0,212,255,.15);border-color:rgba(0,212,255,.5)}
  .lp-preview-nav{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;padding:5px 12px;border:1px solid rgba(255,255,255,.12);border-radius:3px;background:rgba(255,255,255,.04);color:#888;cursor:pointer;transition:all .15s}
  .lp-preview-nav:hover{background:rgba(255,255,255,.08);color:#ccc;border-color:rgba(255,255,255,.2)}
  .lp-preview-nav.active{background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.3);color:var(--cyan)}
  body.landing-preview-mode .landing-banner-upload,
  body.landing-preview-mode .admin-edit-inline,
  body.landing-preview-mode .admin-trigger,
  body.landing-preview-mode #logoutBtn,
  body.landing-preview-mode #scoringPanel,
  body.landing-preview-mode #registrationPanel,
  body.landing-preview-mode #appearancePanel,
  body.landing-preview-mode #dashboardPanel{display:none!important}
  body.landing-preview-mode #adminNavBar{display:none!important}

  /* ══════ SESSION MANAGEMENT PANEL ══════ */
  #sessionMgmtPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #sessionMgmtPanel.active{opacity:1;pointer-events:all}
  .session-btn-group{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .session-btn{padding:12px 20px;border-radius:4px;font-family:'Saira',sans-serif;font-size:11px;letter-spacing:1.5px;font-weight:600;cursor:pointer;transition:all .15s;text-align:left;display:flex;align-items:center;gap:12px}
  .session-btn .sb-icon{font-size:18px;flex-shrink:0}
  .session-btn .sb-info{display:flex;flex-direction:column;gap:2px}
  .session-btn .sb-title{font-size:11px;letter-spacing:1.5px}
  .session-btn .sb-desc{font-size:9px;letter-spacing:.5px;opacity:.6;font-weight:400}
  .session-btn-danger{background:rgba(255,51,51,.08);border:1px solid rgba(255,51,51,.2);color:#ff6655}
  .session-btn-danger:hover{background:rgba(255,51,51,.15);border-color:rgba(255,51,51,.4)}
  .session-btn-warn{background:rgba(255,170,51,.08);border:1px solid rgba(255,170,51,.2);color:var(--amber)}
  .session-btn-warn:hover{background:rgba(255,170,51,.15);border-color:rgba(255,170,51,.4)}
  .session-btn-safe{background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);color:var(--green)}
  .session-btn-safe:hover{background:rgba(0,255,136,.15);border-color:rgba(0,255,136,.4)}

  /* ══════ TUTORIAL & BRIEFING CONFIG PANEL ══════ */
  #tutorialConfigPanel{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.94);opacity:0;pointer-events:none;transition:opacity .12s;display:flex;align-items:center;justify-content:center}
  #tutorialConfigPanel.active{opacity:1;pointer-events:all}
  .tut-step-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .tut-step-card{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:4px;transition:all .15s}
  .tut-step-card:hover{border-color:rgba(0,212,255,.2)}
  .tut-step-card .tut-drag{cursor:grab;font-size:14px;color:#444;padding:0 4px;user-select:none;touch-action:none}
  .tut-step-card .tut-drag:active{cursor:grabbing}
  .tut-step-card .tut-icon{font-size:16px;flex-shrink:0}
  .tut-step-card .tut-text{flex:1}
  .tut-step-card .tut-text textarea{width:100%;background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.08);color:#ddd;font-family:'Chakra Petch',sans-serif;font-size:11px;padding:4px 0;outline:none;letter-spacing:.3px;resize:none;overflow:visible;height:20px;transition:height .2s ease,border-color .2s,background .2s}
  .tut-step-card .tut-text textarea:focus{border-color:rgba(0,212,255,.3);height:72px;background:rgba(0,212,255,.03);border-radius:4px;padding:8px;border:1px solid rgba(0,212,255,.2)}
  .tut-step-toggle{width:36px;height:20px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);cursor:pointer;position:relative;transition:all .15s;flex-shrink:0}
  .tut-step-toggle.on{background:rgba(0,255,136,.15);border-color:rgba(0,255,136,.3)}
  .tut-step-toggle::after{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:#555;top:2px;left:2px;transition:all .15s}
  .tut-step-toggle.on::after{background:var(--green);left:18px}

  /* ══════ TUTORIAL SPOTLIGHT OVERLAY ══════ */
  #tutorialOverlay{position:fixed;inset:0;z-index:9500;pointer-events:none;opacity:0;transition:opacity .3s}
  #tutorialOverlay.active{opacity:1;pointer-events:all}
  .tut-spotlight{position:absolute;border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,.88),0 0 30px 8px rgba(0,212,255,.15);z-index:1;transition:left .3s ease,top .3s ease,width .3s ease,height .3s ease;border:2px solid rgba(0,212,255,.4);animation:tutSpotPulse 1.2s ease-in-out infinite}
  @keyframes tutSpotPulse{
    0%,100%{border-color:rgba(0,212,255,.4);box-shadow:0 0 0 9999px rgba(0,0,0,.88),0 0 20px 6px rgba(0,212,255,.1)}
    50%{border-color:rgba(0,212,255,.9);box-shadow:0 0 0 9999px rgba(0,0,0,.88),0 0 35px 12px rgba(0,212,255,.25)}
  }
  .tut-tooltip{position:absolute;z-index:2;max-width:360px;background:#0d1018;border:1px solid rgba(0,212,255,.3);border-radius:10px;padding:22px 26px;box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 20px rgba(0,212,255,.06)}
  .tut-tooltip-title{font-family:'Saira',sans-serif;font-size:15px;letter-spacing:2.5px;color:var(--cyan);font-weight:700;margin-bottom:8px}
  .tut-tooltip-body{font-family:'Chakra Petch',sans-serif;font-size:13px;color:#d0d0d0;line-height:1.7;margin-bottom:16px;letter-spacing:.2px}
  .tut-tooltip-nav{display:flex;align-items:center;justify-content:space-between}
  .tut-tooltip-dots{display:flex;gap:6px}
  .tut-tooltip-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.15)}
  .tut-tooltip-dot.active{background:var(--cyan)}
  .tut-tooltip-btns{display:flex;gap:8px}
  .tut-btn{padding:6px 16px;border-radius:3px;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:1.5px;font-weight:600;cursor:pointer;transition:all .15s}
  .tut-btn-skip{background:none;border:1px solid rgba(255,255,255,.1);color:#777}
  .tut-btn-skip:hover{border-color:rgba(255,255,255,.2);color:#aaa}
  .tut-btn-next{background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.3);color:var(--cyan)}
  .tut-btn-next:hover{background:rgba(0,212,255,.2)}
  .tut-btn-back{background:none;border:1px solid rgba(255,255,255,.1);color:#777}
  .tut-btn-back:hover{border-color:rgba(255,255,255,.2);color:#aaa}

  /* ══════ MISSION BRIEFING MODAL ══════ */
  #briefingModal{position:fixed;inset:0;z-index:9200;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
  #briefingModal.active{opacity:1;pointer-events:all}
  .briefing-container{max-width:640px;width:90%;background:#0a0c10;border:1px solid rgba(0,212,255,.15);border-radius:12px;overflow:visible;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .briefing-header{padding:20px 24px 12px;text-align:center}
  .briefing-title{font-family:'Saira',sans-serif;font-size:15px;letter-spacing:3px;color:var(--cyan);font-weight:700;text-transform:uppercase}
  .briefing-subtitle{font-family:'Chakra Petch',sans-serif;font-size:11px;color:#777;margin-top:4px}
  .briefing-video{position:relative;aspect-ratio:16/9;background:#000;border-radius:6px;overflow:visible;margin:0 16px}
  .briefing-video video,.briefing-video iframe{width:100%;height:100%;border:none;border-radius:6px}
  .briefing-footer{padding:16px 24px 20px;text-align:center}
  .briefing-continue{padding:10px 32px;background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.25);border-radius:4px;color:var(--green);font-family:'Saira',sans-serif;font-size:11px;letter-spacing:2px;font-weight:700;cursor:pointer;transition:all .15s}
  .briefing-continue:hover{background:rgba(0,255,136,.2);border-color:rgba(0,255,136,.4)}

/* ── Admin console polish + hydration (prevents settings flicker on refresh) ── */
:root{
  --admin-surface: rgba(10,14,22,.82);
  --admin-surface-2: rgba(6,9,15,.72);
  --admin-stroke: rgba(110,170,200,.18);
  --admin-stroke-2: rgba(255,255,255,.08);
  --admin-shadow: 0 18px 70px rgba(0,0,0,.55);
  --admin-radius: 18px;
}

/* Hide settings body while config is hydrating to avoid “flash then revert” values */
.is-hydrating-settings #settingsScreen .admin-page-body{
  visibility:hidden;
}
.is-hydrating-settings #settingsScreen .admin-page-header{
  /* header can remain visible */
}
.is-hydrating-settings #settingsScreen .admin-page{
  box-shadow: none;
}

/* Admin page shell */
#settingsScreen .admin-page{
  width:min(1220px, calc(100vw - 60px));
  margin: 0 auto;
  border-radius: var(--admin-radius);
  border: 1px solid var(--admin-stroke);
  background: linear-gradient(180deg, var(--admin-surface), rgba(8,12,18,.88));
  box-shadow: var(--admin-shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  overflow:visible;
}
#settingsScreen .admin-page-header{
  border-bottom: 1px solid var(--admin-stroke);
  background: linear-gradient(180deg, rgba(18,24,35,.85), rgba(10,14,22,.65));
}
#settingsScreen .admin-page-header-row{
  padding: 18px 18px 10px 18px;
}
#settingsScreen .admin-page-title{
  font-family:'Staatliches',cursive;
  font-size:17px;
  letter-spacing:3px;
  text-transform:uppercase;
  font-weight:600;
  opacity:.98;
}
#settingsScreen .admin-page-close{
  /* Match console panel close button */
}
#settingsScreen .admin-page-close:hover{ /* no positional shift */ }
#settingsScreen .admin-page-tabs{
  padding: 10px 12px 14px 12px;
  gap: 10px;
  overflow-x:auto;
}
#settingsScreen .admin-page-tab{
  border-radius: 999px;
  border: 1px solid var(--admin-stroke);
  background: rgba(8,10,16,.35);
  padding: 10px 14px;
  font-weight: 700;
  letter-spacing: .03em;
  transition: transform .12s ease, filter .12s ease, background .12s ease;
}
#settingsScreen .admin-page-tab:hover{transform: translateY(-1px);filter:brightness(1.08)}
#settingsScreen .admin-page-tab.active{
  background: linear-gradient(180deg, rgba(0,255,136,.14), rgba(0,255,136,.06));
  border-color: rgba(0,255,136,.22);
  box-shadow: 0 0 0 3px rgba(0,255,136,.08) inset;
}

#settingsScreen .admin-page-body{
  padding: 18px;
  background: radial-gradient(1200px 600px at 20% 0%, rgba(0,255,136,.06), transparent 60%),
              radial-gradient(900px 500px at 85% 15%, rgba(64,160,255,.07), transparent 60%),
              rgba(6,9,15,.35);
}
#settingsScreen .admin-page-section.active{
  display:block;
}
#settingsScreen .admin-page-section{
  display:none;
}

/* Panels that are moved into the settings page */
#settingsScreen .ap-container,
#settingsScreen .keys-container,
#settingsScreen .scoring-container,
#settingsScreen .portal-container,
#settingsScreen #dashboardPanel,
#settingsScreen #leaderboardModule,
#settingsScreen #sessionMgmtPanel,
#settingsScreen #broadcastPanel{
  border-radius: 16px;
  border: 1px solid var(--admin-stroke);
  background: linear-gradient(180deg, var(--admin-surface-2), rgba(6,9,15,.55));
  box-shadow: 0 14px 50px rgba(0,0,0,.45);
}

/* Standardize form controls inside admin panels (override inline where needed) */
#settingsScreen select,
#settingsScreen input[type="text"],
#settingsScreen input[type="number"],
#settingsScreen input[type="datetime-local"],
#settingsScreen textarea{
  border-radius: 12px !important;
  border: 1px solid var(--admin-stroke) !important;
  background: rgba(7,9,14,.70) !important;
  color: rgba(240,250,255,.92) !important;
  outline: none !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
}
#settingsScreen select:focus,
#settingsScreen input:focus,
#settingsScreen textarea:focus{
  box-shadow: 0 0 0 3px rgba(64,160,255,.16), 0 0 0 1px rgba(255,255,255,.06) inset !important;
  border-color: rgba(64,160,255,.28) !important;
}

/* Tidy “close” buttons embedded in panels now that the page has its own close */
#settingsScreen .mv-close{
  opacity:.6;
}
#settingsScreen .mv-close:hover{opacity:1}


  /* PDF.js mobile-friendly viewer */
  .mv-pdfjs-wrap{width:100%;height:100%;overflow:auto;border-radius:4px;background:#0b0c10;border:1px solid rgba(255,255,255,.04);padding:8px}
  .mv-pdfjs-toolbar{display:flex;gap:8px;align-items:center;justify-content:center;margin:6px 0 10px 0;flex-wrap:wrap}
  .mv-pdfjs-btn{padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:rgba(255,255,255,.02);color:#bbb;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer}
  .mv-pdfjs-btn:hover{border-color:rgba(0,212,255,.25);color:#e0f7ff}
  .mv-pdfjs-page{width:100%;display:flex;justify-content:center;margin:0 0 10px 0}
  .mv-pdfjs-page canvas{width:100%;height:auto;max-width:980px;border-radius:3px;background:#111;box-shadow:0 8px 30px rgba(0,0,0,.45)}
  .mv-pdfjs-status{font-family:'IBM Plex Mono',monospace;font-size:9px;color:#777;letter-spacing:1px;text-align:center;margin-top:6px}


/* Removed Intel Submissions clear icon per request */

</style>
<script>
// Pre-render theme injection — runs before body paints
// Reads cached theme from localStorage and injects a CSS class on consoleGrid
// via a MutationObserver that fires the moment the element exists in DOM.
(function(){
  try{
    var t=localStorage.getItem('cb_gridTheme');
    if(t&&t!=='crt'){
      var obs=new MutationObserver(function(m,o){
        var g=document.getElementById('consoleGrid');
        if(g){g.classList.add('grid-theme-'+t);o.disconnect()}
      });
      if(document.body){
        var g=document.getElementById('consoleGrid');
        if(g)g.classList.add('grid-theme-'+t);
      }else{
        document.addEventListener('DOMContentLoaded',function(){
          var g=document.getElementById('consoleGrid');
          if(g)g.classList.add('grid-theme-'+t);
        });
        obs.observe(document.documentElement,{childList:true,subtree:true});
      }
    }
    // Intel theme pre-render
    var it=localStorage.getItem('cb_intelTheme');
    if(it&&it!=='standard'){
      var obs2=new MutationObserver(function(m,o){
        var p=document.getElementById('expIntel');
        if(p){p.classList.add('intel-theme-'+it);o.disconnect()}
      });
      if(document.body){
        var p=document.getElementById('expIntel');
        if(p)p.classList.add('intel-theme-'+it);
      }else{
        document.addEventListener('DOMContentLoaded',function(){
          var p=document.getElementById('expIntel');
          if(p)p.classList.add('intel-theme-'+it);
        });
        obs2.observe(document.documentElement,{childList:true,subtree:true});
      }
    }
  }catch(e){}
})();
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script defer>
  // Configure PDF.js worker for in-app PDF rendering (used on mobile devices).
  window.addEventListener('DOMContentLoaded',()=>{
    try{
      if(window.pdfjsLib){
        pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    }catch(e){}
  });
</script>

</head>
<body class="config-hydrating">
<canvas id="grainCanvas"></canvas>
<div class="flash-green" id="flashG"></div>
<div class="flash-red" id="flashR"></div>


<!-- PERSISTENT ADMIN ICONS -->
<div class="admin-persistent-icons" id="adminPersistentIcons">
  <div class="admin-icon admin-icon-preview" id="adminPreviewIcon" onclick="togglePlayerPreview()" title="View as Player">
    <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
  </div>
  <div class="admin-icon admin-icon-gear" id="adminGearIcon" onclick="handleGearClick()" title="Admin Menu">
    <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53a7.76 7.76 0 0 0 0-1.94l2.11-1.65a.5.5 0 0 0 .12-.64l-2-3.46a.5.5 0 0 0-.61-.22l-2.49 1a7.2 7.2 0 0 0-1.69-.98l-.38-2.65A.49.49 0 0 0 14 2h-4a.49.49 0 0 0-.49.42l-.38 2.65a7.2 7.2 0 0 0-1.69.98l-2.49-1a.5.5 0 0 0-.61.22l-2 3.46a.49.49 0 0 0 .12.64l2.11 1.65a7.9 7.9 0 0 0 0 1.94l-2.11 1.65a.5.5 0 0 0-.12.64l2 3.46a.5.5 0 0 0 .61.22l2.49-1c.52.4 1.08.72 1.69.98l.38 2.65c.05.24.26.42.49.42h4c.24 0 .44-.18.49-.42l.38-2.65a7.2 7.2 0 0 0 1.69-.98l2.49 1a.5.5 0 0 0 .61-.22l2-3.46a.49.49 0 0 0-.12-.64z"/></svg>
  </div>
</div>

<!-- GEAR DROPDOWN -->
<div class="gear-dropdown" id="gearDropdown">
  <div class="gear-dropdown-item" onclick="closeGearDropdown();navigateToAdmin('settingsScreen')"><span class="gd-icon">⚙️</span><span class="gd-label">Settings</span></div>
  <div class="gear-dropdown-item" onclick="closeGearDropdown();navigateToAdmin('settingsScreen','dash-teams')"><span class="gd-icon">📊</span><span class="gd-label">Teams</span></div>
  <div class="gear-dropdown-item" onclick="closeGearDropdown();navigateToAdmin('settingsScreen','dash-broadcast')"><span class="gd-icon">📢</span><span class="gd-label">Broadcast</span></div>
</div>

<div class="admin-trigger" id="adminTrigger" onclick="handleAdminTrigger()" title="System"><svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53a7.76 7.76 0 0 0 0-1.94l2.11-1.65a.5.5 0 0 0 .12-.64l-2-3.46a.5.5 0 0 0-.61-.22l-2.49 1a7.2 7.2 0 0 0-1.69-.98l-.38-2.65A.49.49 0 0 0 14 2h-4a.49.49 0 0 0-.49.42l-.38 2.65a7.2 7.2 0 0 0-1.69.98l-2.49-1a.5.5 0 0 0-.61.22l-2 3.46a.49.49 0 0 0 .12.64l2.11 1.65a7.9 7.9 0 0 0 0 1.94l-2.11 1.65a.5.5 0 0 0-.12.64l2 3.46a.5.5 0 0 0 .61.22l2.49-1c.52.4 1.08.72 1.69.98l.38 2.65c.05.24.26.42.49.42h4c.24 0 .44-.18.49-.42l.38-2.65a7.2 7.2 0 0 0 1.69-.98l2.49 1a.5.5 0 0 0 .61-.22l2-3.46a.49.49 0 0 0-.12-.64z"/></svg></div>

<!-- Admin Dropdown Menu -->
<div class="admin-dropdown" id="adminDropdown">
  <div class="admin-dropdown-header">
    <div class="admin-dropdown-dot"></div>
    <span class="admin-dropdown-label">Admin Menu</span>
  </div>
  <div class="admin-dropdown-body">
    <div class="adm-tier-label">LIVE</div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openDashboard()"><span class="adm-icon">📊</span><span class="adm-label">Dashboard</span></div>
    <div class="adm-tier-label">SETUP</div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openSetup('adminPanel')"><span class="adm-icon">⚙️</span><span class="adm-label">Event</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openSetup('keysCodesPanel')"><span class="adm-icon">🎯</span><span class="adm-label">Intel & Scoring</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openSetup('appearancePanel')"><span class="adm-icon">🎨</span><span class="adm-label">Appearance</span></div>
    <div class="admin-dropdown-item" onclick="closeAdminDropdown();openSetup('portalUsersPanel')"><span class="adm-icon">👥</span><span class="adm-label">Users & Sessions</span></div>
    <div class="admin-dropdown-sep"></div>

    <div class="admin-dropdown-toggle pp-toggle" onclick="togglePlayerPreview()"><span class="adm-icon">👁</span><span class="adm-label">View as Player</span><span class="adm-toggle off" id="admPreviewToggle">OFF</span></div>
  </div>
</div>

<div class="notepad-trigger" id="notepadTrigger" onclick="toggleNotepad()"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Notepad</span><div class="notepad-dot" id="notepadDot"></div></div>

<div id="logoutModal"><div class="logout-box" id="logoutBoxContent"></div></div>

<div id="adminEditModal"><div class="edit-box" id="editBox"></div></div>

<div id="confirmModal"><div class="confirm-box"><div class="confirm-header"><h3>⚠ Confirm Transmission</h3><p>Review your intel before final submission. This action cannot be undone.</p></div><div class="confirm-body" id="confirmBody"></div><div class="confirm-footer"><button class="btn-standard btn-ghost" onclick="hideConfirm()">◂ Go Back</button><button class="intel-submit-btn" onclick="finalSubmit()">CONFIRM & SUBMIT</button></div></div></div>

<!-- ADMIN CHOICE MODAL (after auth from landing) -->
<div id="adminChoiceModal"><div class="admin-choice-box"><h3>◈ Navigation</h3><p>Where would you like to go?</p><div class="admin-choice-btns"><button class="btn-standard btn-cyan" onclick="adminGoVault()">Go to Vault</button><button class="btn-standard btn-green" onclick="adminGoConsole()">Go to Console</button></div></div></div>

<!-- LANDING PAGE -->
<div class="screen active" id="landingScreen">
  <div class="landing-circuits">
    <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="cGlow" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="rgba(0,255,136,.06)"/><stop offset="100%" stop-color="transparent"/></radialGradient>
      </defs>
      <rect fill="url(#cGlow)" width="1200" height="800"/>
      <!-- Horizontal traces -->
      <line x1="0" y1="120" x2="320" y2="120" stroke="rgba(0,255,136,.12)" stroke-width=".8"/>
      <line x1="380" y1="120" x2="600" y2="120" stroke="rgba(0,255,136,.08)" stroke-width=".5"/>
      <line x1="0" y1="280" x2="180" y2="280" stroke="rgba(0,212,255,.1)" stroke-width=".8"/>
      <line x1="240" y1="280" x2="440" y2="280" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="700" y1="200" x2="1200" y2="200" stroke="rgba(0,255,136,.1)" stroke-width=".8"/>
      <line x1="800" y1="350" x2="1200" y2="350" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="0" y1="500" x2="250" y2="500" stroke="rgba(0,255,136,.07)" stroke-width=".5"/>
      <line x1="900" y1="520" x2="1200" y2="520" stroke="rgba(0,255,136,.09)" stroke-width=".8"/>
      <line x1="0" y1="650" x2="350" y2="650" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="750" y1="680" x2="1200" y2="680" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <!-- Vertical traces -->
      <line x1="320" y1="0" x2="320" y2="180" stroke="rgba(0,255,136,.1)" stroke-width=".8"/>
      <line x1="320" y1="120" x2="320" y2="280" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <line x1="180" y1="280" x2="180" y2="500" stroke="rgba(0,212,255,.08)" stroke-width=".5"/>
      <line x1="900" y1="0" x2="900" y2="200" stroke="rgba(0,255,136,.08)" stroke-width=".5"/>
      <line x1="900" y1="200" x2="900" y2="520" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <line x1="440" y1="280" x2="440" y2="800" stroke="rgba(0,212,255,.05)" stroke-width=".5"/>
      <line x1="750" y1="350" x2="750" y2="680" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="1050" y1="0" x2="1050" y2="350" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <line x1="120" y1="500" x2="120" y2="800" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <!-- Angled traces -->
      <line x1="600" y1="120" x2="700" y2="200" stroke="rgba(0,255,136,.07)" stroke-width=".5"/>
      <line x1="250" y1="500" x2="350" y2="650" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <line x1="800" y1="350" x2="750" y2="520" stroke="rgba(0,255,136,.05)" stroke-width=".5"/>
      <!-- Junction nodes -->
      <circle cx="320" cy="120" r="3" fill="rgba(0,255,136,.2)"/><circle cx="320" cy="120" r="1.2" fill="rgba(0,255,136,.5)"/>
      <circle cx="180" cy="280" r="3" fill="rgba(0,212,255,.2)"/><circle cx="180" cy="280" r="1.2" fill="rgba(0,212,255,.5)"/>
      <circle cx="440" cy="280" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="440" cy="280" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="900" cy="200" r="3" fill="rgba(0,255,136,.2)"/><circle cx="900" cy="200" r="1.2" fill="rgba(0,255,136,.5)"/>
      <circle cx="900" cy="520" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="900" cy="520" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="700" cy="200" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="700" cy="200" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="600" cy="120" r="2" fill="rgba(0,255,136,.12)"/><circle cx="600" cy="120" r=".8" fill="rgba(0,255,136,.3)"/>
      <circle cx="250" cy="500" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="250" cy="500" r="1" fill="rgba(0,255,136,.4)"/>
      <circle cx="800" cy="350" r="3" fill="rgba(0,212,255,.18)"/><circle cx="800" cy="350" r="1.2" fill="rgba(0,212,255,.45)"/>
      <circle cx="750" cy="680" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="750" cy="680" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="350" cy="650" r="2.5" fill="rgba(0,212,255,.15)"/><circle cx="350" cy="650" r="1" fill="rgba(0,212,255,.4)"/>
      <circle cx="120" cy="500" r="2" fill="rgba(0,255,136,.12)"/><circle cx="120" cy="500" r=".8" fill="rgba(0,255,136,.3)"/>
      <circle cx="1050" cy="350" r="2.5" fill="rgba(0,255,136,.15)"/><circle cx="1050" cy="350" r="1" fill="rgba(0,255,136,.4)"/>
      <!-- IC chip shapes -->
      <rect x="295" y="95" width="50" height="50" rx="3" fill="none" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <rect x="875" y="175" width="50" height="50" rx="3" fill="none" stroke="rgba(0,255,136,.06)" stroke-width=".5"/>
      <rect x="775" y="325" width="50" height="50" rx="3" fill="none" stroke="rgba(0,212,255,.06)" stroke-width=".5"/>
      <!-- Pulsing nodes -->
      <circle cx="320" cy="120" r="6" fill="none" stroke="rgba(0,255,136,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="3s" repeatCount="indefinite"/></circle>
      <circle cx="900" cy="200" r="6" fill="none" stroke="rgba(0,255,136,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="4s" repeatCount="indefinite"/></circle>
      <circle cx="800" cy="350" r="6" fill="none" stroke="rgba(0,212,255,.1)" stroke-width=".3"><animate attributeName="r" values="3;8;3" dur="3.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="3.5s" repeatCount="indefinite"/></circle>
    </svg>
  </div>
  <div class="landing-container">
    <div class="landing-banner" id="landingBannerWrap">
      <span class="landing-banner-icon">🔐</span>
      <img class="landing-banner-img" id="landingBannerImg" alt="Code Breakers">
      <div class="landing-banner-upload" onclick="document.getElementById('landingBannerFile').click()" title="Upload banner">📷</div>
      <input type="file" id="landingBannerFile" accept="image/*" onchange="handleBannerUpload(this)">
    </div>
    <div class="landing-title" id="landingTitleEl">Code Breakers</div>
    <div class="landing-subtitle" id="landingSubEl">Rise to The Challenge</div>
    <div class="landing-actions">
      <div class="landing-login-btn" onclick="goToLogin()">READY</div>
    </div>
  </div>
  <div class="landing-footer"><span>© 2026 Sandals Employee Experience. All rights reserved.</span></div>
</div>

<!-- REGISTRATION -->
<div class="screen" id="regScreen">
  <div class="reg-container">
    <div class="reg-title" id="regScreenTitle">Operation Dead Drop</div>
    <div class="reg-subtitle" id="regScreenSubtitle">Team Registration Portal</div>
    <div class="reg-panel">
      <div class="login-led" id="regLed"></div>
      <div class="rv rv-1"></div><div class="rv rv-2"></div><div class="rv rv-3"></div><div class="rv rv-4"></div>
      <div class="reg-crt" id="regCrt">
        <div class="login-crt-scanlines"></div>
        <div class="reg-crt-inner" id="regForm">
          <!-- Hybrid mode type choice (hidden unless hybrid) -->
          <div class="reg-type-choice" id="regTypeChoice" style="display:none">
            <div class="reg-type-btn selected" data-type="team" onclick="selectRegType(this)">
              <div class="rtype-icon">👥</div>
              <div class="rtype-label">Team</div>
            </div>
            <div class="reg-type-btn" data-type="individual" onclick="selectRegType(this)">
              <div class="rtype-icon">👤</div>
              <div class="rtype-label">Individual</div>
            </div>
          </div>

          <div class="reg-section">
            <div class="reg-field full">
              <label class="reg-main-label">Team Name</label>
              <input type="text" id="regTeamName" placeholder="Enter your team name" maxlength="30">
            </div>
          </div>

          <div class="reg-section">
            <div id="regOperatives"></div>
          </div>

          <div class="reg-err" id="regErr" style="display:none"></div>
        </div>
        <div class="reg-crt-inner" id="regSuccess" style="display:none">
          <div class="reg-section-title" style="text-align:center;border-bottom:none;margin-bottom:8px">◈ Registration Complete</div>
          <div class="reg-id-display">
            <div class="reg-id-label">Your Team ID</div>
            <div class="reg-id-value" id="regTeamId">—</div>
          </div>
          <div class="reg-id-warn">⚠ Save this ID — you'll need it to resume your session</div>
          <div class="reg-id-note">Share this ID with your team members. Any member can access and continue the mission using this code on any device.</div>
          <button class="reg-proceed" onclick="proceedToLogin()">Proceed to Mission ▸</button>
        </div>
      </div>
      <div class="login-crt-divider" id="regCrtDivider" style="display:none;margin:0 18px"></div>
      <div class="login-crt-status" id="regCrtStatus" style="padding:0 18px 8px"></div>
      <div class="login-btn-row" id="regBtnRow">
        <div class="login-hw-btn esc-key" onclick="regBack()"><span>← ESC</span></div>
        <div class="login-hw-btn enter-key" id="regSubmitBtn" onclick="submitRegistration()"><span>REGISTER</span></div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div class="screen" id="loginScreen">
  <div class="login-container">
    <div style="display:flex;align-items:center;justify-content:center"><div class="login-title" id="loginTitle">Operation Dead Drop</div><button class="admin-edit-inline" onclick="event.stopPropagation();editOperationName()">✎</button></div>
    <div class="login-subtitle">Enter Your Credentials</div>
    <div class="login-panel">
      <div class="login-led" id="loginLed"></div>
      <div class="rv rv-1"></div><div class="rv rv-2"></div><div class="rv rv-3"></div><div class="rv rv-4"></div>
      <div class="login-crt-unified" id="loginCrt">
        <div class="login-crt-scanlines"></div>
        <div class="login-crt-inner">
          <div class="login-crt-input-zone">
            <label class="login-crt-label" id="loginCrtLabel">TEAM ID</label>
            <input type="text" class="login-crt-field" id="loginId" placeholder="e.g. ALPHA-1234" autocomplete="off" spellcheck="false">
          </div>
          <div class="login-crt-pw-zone" id="loginCrtPwZone" style="display:none">
            <div class="login-crt-divider"></div>
            <label class="login-crt-label">PASSWORD</label>
            <input type="password" class="login-crt-field" id="loginPw" placeholder="••••••••">
          </div>
          <div class="login-crt-divider" id="loginCrtDivider" style="display:none"></div>
          <div class="login-crt-status" id="loginCrtStatus"></div>
        </div>
      </div>
      <div class="login-err" id="loginErr" style="display:none"></div>
      <div class="login-btn-row">
        <div class="login-hw-btn esc-key" id="loginEscBtn" onclick="loginBack()"><span>← ESC</span></div>
        <div class="login-hw-btn enter-key" id="loginSubmitBtn" onclick="submitLogin()"><span>ENTER</span></div>
      </div>
    </div>
    <div class="login-register-link" id="loginRegLink" onclick="goToRegistration()"><span id="loginRegText">Don't have a Team ID?</span> <span class="lrl-action" id="loginRegAction">Register here</span></div>
  </div>
</div>

<div id="vaultOpenOverlay"><div class="vo-text" id="voText">ACCESS GRANTED</div><div class="vo-sub" id="voSub">Initializing operations console...</div><div class="vo-bar" id="voBar"><div class="vo-fill" id="voFill"></div></div><div class="vo-pct" id="voPct">0%</div></div>

<!-- ADMIN BAR (fixed, body-level) -->
<!-- CONSOLE -->
<div class="screen" id="consoleScreen">
<div id="consoleBgOverlay"></div>

<!-- CHANGE PASSWORD MODAL -->
<div id="changePwModal" style="display:none;position:fixed;inset:0;z-index:920;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);align-items:center;justify-content:center" onclick="if(event.target===this)closeChangePassword()">
  <div style="background:#0a0e18;border:1px solid var(--border);border-radius:6px;padding:24px;width:340px;max-width:90vw">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h4 style="font-family:Saira,sans-serif;font-size:13px;letter-spacing:3px;color:#d0e8f0;text-transform:uppercase;margin:0;font-weight:700">🔑 Change Password</h4>
      <button class="mv-close" onclick="closeChangePassword()" style="position:static;font-size:10px;padding:4px 10px">✕</button>
    </div>
    <div class="ap-field"><label>Current Password</label><input type="password" id="apCurPw"></div>
    <div class="ap-field"><label>New Password</label><input type="password" id="apNewPw"></div>
    <div class="ap-field"><label>Confirm New Password</label><input type="password" id="apConfPw"></div>
    <button class="ap-btn ap-btn-cyan" onclick="changeAdminPw()" style="width:100%;margin-top:4px">Update Password</button>
    <div class="ap-msg" id="apPwMsg"></div>
  </div>
</div>

<!-- PORTAL USERS PANEL -->
<div id="portalUsersPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>👥 Users & Sessions</h3><button class="mv-close" onclick="closePortalUsers()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>🔑 Administrators</h4>
      <p>Administrators can access the admin menu and all management tools.</p>
      <div class="ap-row">
        <div class="ap-field"><label>Username</label><input id="apAddUser"></div>
        <div class="ap-field"><label>Password</label><input id="apAddPw" type="password"></div>
        <button class="ap-btn ap-btn-green" onclick="addAdmin()" style="flex-shrink:0;margin-bottom:10px">+ Add</button>
      </div>
      <div class="ap-msg" id="apAdminMsg"></div>
    </div>
    <div class="ap-section"><h4>🏷️ Create ID</h4>
      <p id="apManualDesc">Manually create teams or individuals with custom or auto-generated IDs.</p>
      <div class="ap-row" id="apManualTypeRow" style="margin-bottom:10px">
        <div class="ap-field"><label>Entry Type</label><select id="apManualType" onchange="onManualTypeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none"><option value="team">Team</option><option value="individual">Individual</option></select></div>
      </div>
      <div class="ap-row">
        <div class="ap-field"><label id="apManualNameLabel">Team Name</label><input id="apTeamName" placeholder="e.g. Alpha Squad"></div>
        <div class="ap-field"><label id="apManualIdLabel">Team ID (leave blank to auto-generate)</label><input id="apTeamId" placeholder="Auto-generated"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="ap-btn ap-btn-green" id="apManualCreateBtn" onclick="createManualTeam()">Create Team</button>
        <button class="ap-btn ap-btn-cyan" onclick="autoGenTeamId()" style="font-size:8px">🎲 Generate ID</button>
      </div>
      <div class="ap-msg" id="apTeamMsg"></div>
    </div>
    <div class="ap-section"><h4>📋 Portal Users</h4>
      <p>All administrators and manually created entries.</p>
      <div id="puCombinedList"></div>
    </div>
  </div>
</div>

<!-- SESSION MANAGEMENT PANEL -->
<div id="sessionMgmtPanel">
  <div class="ap-container" style="width:700px">
    <div class="ap-header"><h3>🛡️ Session Management</h3><button class="mv-close" onclick="closeSessionMgmt()">✕ CLOSE</button></div>
    <div class="ap-section">
      <h4>Active Sessions</h4>
      <p>Invalidate active sessions. Affected users will be returned to the login screen on their next action.</p>
      <div class="session-btn-group">
        <div class="session-btn session-btn-safe" onclick="destroySessions('teams')">
          <span class="sb-icon">👥</span>
          <div class="sb-info"><span class="sb-title">DESTROY TEAM SESSIONS</span><span class="sb-desc">Kick all players — admins stay logged in</span></div>
        </div>
        <div class="session-btn session-btn-warn" onclick="destroySessions('exceptMe')">
          <span class="sb-icon">🔒</span>
          <div class="sb-info"><span class="sb-title">DESTROY ALL EXCEPT ME</span><span class="sb-desc">Kick everyone — your session is preserved</span></div>
        </div>
        <div class="session-btn session-btn-danger" onclick="destroySessions('all')">
          <span class="sb-icon">💥</span>
          <div class="sb-info"><span class="sb-title">DESTROY ALL SESSIONS</span><span class="sb-desc">Nuclear option — everyone including you gets kicked</span></div>
        </div>
      </div>
      <div class="ap-msg" id="sessionMgmtMsg" style="margin-top:12px"></div>
      <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
        <h4 style="color:#ff4444">☢ Nuke Teams</h4>
        <p>Permanently delete teams and ALL their data — submissions, drafts, vault progress, leaderboard entries. This cannot be undone.</p>
        <div class="session-btn-group">
          <div class="session-btn session-btn-danger" onclick="nukeAllTeams()">
            <span class="sb-icon">☢</span>
            <div class="sb-info"><span class="sb-title">NUKE ALL TEAMS</span><span class="sb-desc">Delete every team and their data — total wipe</span></div>
          </div>
        </div>
        <div class="ap-msg" id="nukeMgmtMsg" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL & BRIEFING CONFIG PANEL -->
<div id="tutorialConfigPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>📖 Tutorial & Briefing</h3><button class="mv-close" onclick="closeTutorialConfig()">✕ CLOSE</button></div>
    <div class="ap-section">
      <h4>📍 Navigation Tutorial</h4>
      <p>Step-by-step spotlight tour shown to players on first login. Drag to reorder, toggle to enable/disable each step, edit text to customize.</p>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-family:Saira,sans-serif;font-size:10px;letter-spacing:1.5px;color:#888">TUTORIAL</span>
        <div class="tut-step-toggle" id="tutGlobalToggle" onclick="toggleTutorialGlobal()"><span></span></div>
        <button class="ap-btn ap-btn-ghost" onclick="resetTutorialForAll()" style="font-size:8px;padding:5px 12px;margin-left:auto">↺ Reset for All Teams</button>
        <button class="ap-btn ap-btn-ghost" onclick="previewTutorial()" style="font-size:8px;padding:5px 12px">▶ Preview</button>
      </div>
      <div class="tut-step-list" id="tutStepList"></div>
    </div>
    <div class="ap-section">
      <h4>🎬 Mission Briefing</h4>
      <p>Video shown to players after first login (after the tutorial if both are enabled). Plays once per team.</p>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-family:Saira,sans-serif;font-size:10px;letter-spacing:1.5px;color:#888">BRIEFING</span>
        <div class="tut-step-toggle" id="briefingGlobalToggle" onclick="toggleBriefingGlobal()"><span></span></div>
        <button class="ap-btn ap-btn-ghost" onclick="resetBriefingForAll()" style="font-size:8px;padding:5px 12px;margin-left:auto">↺ Reset for All Teams</button>
        <button class="ap-btn ap-btn-ghost" onclick="previewBriefing()" style="font-size:8px;padding:5px 12px">▶ Preview</button>
      </div>
      <div class="ap-row" style="margin-bottom:10px">
        <div class="ap-field"><label>Source Type</label>
          <select id="briefingSourceType" onchange="onBriefingTypeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none">
            <option value="upload">Upload Video (R2)</option>
            <option value="youtube">YouTube / Vimeo Link</option>
            <option value="direct">Direct Video URL</option>
          </select>
        </div>
      </div>
      <div id="briefingUploadZone" class="ap-row" style="margin-bottom:10px">
        <div class="ap-field" style="flex:1"><label>Video File</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="briefingFileUrl" readonly placeholder="No video uploaded" style="flex:1;background:#060810;border:1px solid var(--border);border-radius:4px;padding:10px;color:#aaa;font-size:11px">
            <label style="cursor:pointer;padding:8px 14px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:4px;color:var(--cyan);font-family:Saira,sans-serif;font-size:9px;letter-spacing:1px;white-space:nowrap">
              📁 Upload<input type="file" accept="video/*" style="display:none" onchange="uploadBriefingVideo(this)">
            </label>
          </div>
        </div>
      </div>
      <div id="briefingUrlZone" class="ap-row" style="margin-bottom:10px;display:none">
        <div class="ap-field" style="flex:1"><label>Video URL</label>
          <input id="briefingVideoUrl" placeholder="https://youtube.com/watch?v=... or direct .mp4 URL" oninput="saveBriefingConfig()" style="background:#060810;border:1px solid var(--border);border-radius:4px;padding:10px;color:#ddd;font-size:11px;width:100%">
        </div>
      </div>
      <div class="ap-row" style="margin-bottom:10px">
        <div class="ap-field"><label>Title (optional)</label><input id="briefingTitle" placeholder="Mission Briefing" oninput="saveBriefingConfig()"></div>
        <div class="ap-field"><label>Subtitle (optional)</label><input id="briefingSubtitle" placeholder="Watch carefully, agent." oninput="saveBriefingConfig()"></div>
      </div>
      <div class="ap-msg" id="briefingMsg" style="margin-top:4px"></div>
    </div>
  </div>
</div>

<!-- TUTORIAL SPOTLIGHT OVERLAY -->
<div id="tutorialOverlay">
  <div class="tut-spotlight" id="tutSpotlight"></div>
  <div class="tut-tooltip" id="tutTooltip">
    <div class="tut-tooltip-title" id="tutTooltipTitle"></div>
    <div class="tut-tooltip-body" id="tutTooltipBody"></div>
    <div class="tut-tooltip-nav">
      <div class="tut-tooltip-dots" id="tutDots"></div>
      <div class="tut-tooltip-btns">
        <div class="tut-btn tut-btn-skip" id="tutBtnSkip" onclick="endTutorial()">EXIT</div>
        <div class="tut-btn tut-btn-back" id="tutBtnBack" onclick="tutorialStep(-1)">BACK</div>
        <div class="tut-btn tut-btn-next" id="tutBtnNext" onclick="tutorialStep(1)">NEXT</div>
      </div>
    </div>
  </div>
</div>

<!-- MISSION BRIEFING MODAL -->
<div id="briefingModal">
  <div class="briefing-container">
    <div class="briefing-header">
      <div class="briefing-title" id="briefingModalTitle">Mission Briefing</div>
      <div class="briefing-subtitle" id="briefingModalSubtitle"></div>
    </div>
    <div class="briefing-video" id="briefingVideoContainer"></div>
    <div class="briefing-footer">
      <button class="briefing-continue" onclick="dismissBriefing()">◈ CONTINUE TO MISSION ◈</button>
    </div>
  </div>
</div>

<!-- EVENT SETTINGS PANEL -->
<div id="adminPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>⚙️ Configuration</h3><button class="mv-close" onclick="closeEventSettings()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>🎮 Event Settings <span class="save-blip" id="blipEventSettings">✓ Saved</span></h4>
      <p>Configure participant mode, countdown timer, and leaderboard display.</p>
      <div style="margin-bottom:16px">
        <label style="font-family:Saira,sans-serif;font-size:10px;color:#d0e8f0;letter-spacing:2px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">⏱ Event Timer</label>
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:10px">
          <select id="timerMode" onchange="onTimerModeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:8px 12px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;width:200px">
            <option value="countdown">Manual Countdown</option>
            <option value="event">Event Schedule</option>
            <option value="none">No Timer (Open-Ended)</option>
          </select>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--red);letter-spacing:3px;font-weight:700;text-shadow:0 0 8px rgba(255,50,50,.3)" id="apTimerDisplay">—</span>
        </div>
        <div id="timerCountdownControls">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="admin-timer-btn" id="pauseBtn" onclick="togglePause()">⏸ PAUSE</button>
            <input class="admin-timer-input" id="timerInput" placeholder="HH:MM:SS" maxlength="8" style="width:120px">
            <button class="admin-timer-btn" onclick="setNewTime()">SET</button>
            <button class="admin-timer-btn" onclick="resetTimer()">RESET</button>
          </div>
        </div>
        <div id="timerEventControls" style="display:none">
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px">
            <div class="ap-field" style="flex:1;min-width:180px"><label>Event Start</label><input type="datetime-local" id="eventStartInput" onchange="onEventTimeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:8px 12px;color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:11px;width:100%;outline:none;color-scheme:dark"></div>
            <div class="ap-field" style="flex:1;min-width:180px"><label>Event End</label><input type="datetime-local" id="eventEndInput" onchange="onEventTimeChange()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:8px 12px;color:var(--red);font-family:'IBM Plex Mono',monospace;font-size:11px;width:100%;outline:none;color-scheme:dark"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 16px">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="eventAutoLock" checked onchange="eventSettings.autoLock=this.checked"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa">Auto-lock when timer expires</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="eventShowLeaderboard" checked onchange="eventSettings.showLeaderboardOnExpiry=this.checked"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa">Reveal leaderboard on expiry</span></label>
          </div>
          <div id="eventStatusMsg" style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:#666;letter-spacing:1px;margin-top:8px"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.05)">
            <button class="ap-btn ap-btn-amber" id="eventPauseBtn" onclick="toggleEventPause()" style="font-size:9px;padding:5px 8px;width:100%">⏸ Pause</button>
            <button class="ap-btn ap-btn-red" onclick="forceEndEvent()" style="font-size:9px;padding:5px 8px;width:100%">⛔ Force End</button>
            <button class="ap-btn ap-btn-cyan" onclick="exportResults()" style="font-size:9px;padding:5px 8px;width:100%">📊 Export</button>
            <button class="ap-btn ap-btn-red" onclick="clearAllData()" style="font-size:9px;padding:5px 8px;width:100%;opacity:.7">🗑 Clear</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px">
        <div class="ap-field"><label>Participant Mode</label><select id="apParticipantMode" onchange="onParticipantModeChange()" style="width:auto"><option value="team">Team Only</option><option value="individual">Individual Only</option><option value="hybrid">Open (Hybrid)</option></select></div>
        <div class="ap-field"><label>Leaderboard Style</label><select id="apLeaderboardStyle" onchange="updateRegSettings()" style="width:auto"><option value="mixed">Single Mixed</option><option value="split">Split by Type</option><option value="labeled">Single with Labels</option></select></div>
      </div>
      <div style="margin-bottom:12px">
        <label style="font-family:Saira,sans-serif;font-size:10px;color:#d0e8f0;letter-spacing:2px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">⬇ Content Downloads</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apAllowDownloads" onchange="toggleAllowDownloads(this.checked)"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa">Allow players to download files from Intelligence Feed and Evidence Locker</span></label>
      </div>
      <div style="margin-bottom:12px">
        <label style="font-family:Saira,sans-serif;font-size:10px;color:#d0e8f0;letter-spacing:2px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">🔒 Session Persistence</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apSessionPersist" onchange="regSettings.sessionPersist=this.checked;saveEventConfigToBackend()" checked><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa">Keep players logged in after browser close (uncheck to require re-login on each browser session)</span></label>
      </div>
      <div style="margin-top:12px">
        <label style="font-family:Saira,sans-serif;font-size:10px;color:#d0e8f0;letter-spacing:2px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">🟢 Activity Thresholds <span class="save-blip" id="blipThresholds">✓ Saved</span></label>
        <p style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#666;margin:0 0 8px;letter-spacing:.3px">Controls when console tile status changes from Active → Idle → Silent.</p>
        <div class="ap-two-col">
          <div class="ap-field"><label>Active → Idle (seconds)</label><input type="number" id="apThresholdIdle" value="60" min="10" max="600" onchange="updateThresholds()" style="width:90px"></div>
          <div class="ap-field"><label>Idle → Silent (seconds)</label><input type="number" id="apThresholdSilent" value="300" min="30" max="3600" onchange="updateThresholds()" style="width:90px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCORING PANEL -->
<div id="scoringPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>🎯 Scoring</h3><button class="mv-close" onclick="closeScoringPanel()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>🎯 Scoring Editor <span class="save-blip" id="blipScoring">✓ Saved</span></h4>
      <p>Configure point values and matching rules for each intel field. Changes auto-save and affect grading immediately.</p>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <div class="ap-field"><label>Default Points Per Field</label><input type="number" id="seDefaultPoints" value="10" min="1" max="1000" onchange="seApplyDefaultPoints()" style="width:80px"></div>
        <div class="ap-field"><label>Default Match Mode</label><select id="seDefaultMode" onchange="seApplyDefaultMode()" style="width:auto"><option value="exact">Exact</option><option value="contains">Contains</option><option value="fuzzy">Fuzzy</option></select></div>
        <div class="ap-field"><label>Time Bonus</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;margin-top:4px"><input type="checkbox" id="seTimeBonus" onchange="updateScoringConfig()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999">Award bonus points for early submission</span></label>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap" id="seTimeBonusConfig" style="display:none">
        <div class="ap-field"><label>Max Time Bonus</label><input type="number" id="seTimeBonusMax" value="50" min="0" max="500" onchange="updateScoringConfig()" style="width:80px"></div>
        <div class="ap-field"><label>Bonus Decay</label><select id="seTimeBonusDecay" onchange="updateScoringConfig()" style="width:auto"><option value="linear">Linear</option><option value="exponential">Exponential</option></select></div>
      </div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:visible;margin-bottom:12px">
        <div style="display:grid;grid-template-columns:2fr 80px 100px 80px;gap:0;font-family:Saira,sans-serif;font-size:9px;letter-spacing:1px;color:#888;font-weight:700;text-transform:uppercase;padding:8px 12px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)">
          <div>Field</div><div style="text-align:center">Points</div><div style="text-align:center">Match Mode</div><div style="text-align:center">Fuzzy %</div>
        </div>
        <div id="seFieldList" style="max-height:400px;overflow-y:auto"></div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div style="flex:1;font-family:IBM Plex Mono,monospace;font-size:11px;color:var(--green);letter-spacing:1px">Total Possible: <strong id="seTotalPossible">0</strong> pts</div>
        <button class="ap-btn ap-btn-cyan" onclick="seApplyDefaultPoints()" style="font-size:9px;padding:5px 12px">Apply Defaults to All</button>
      </div>
    </div>
  </div>
</div>

<!-- REGISTRATION PANEL -->
<div id="registrationPanel">
  <div class="ap-container">
    <div class="ap-header"><h3>📝 Registration</h3><button class="mv-close" onclick="closeRegistrationPanel()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>📝 Registration Settings</h4>
      <p>Configure team registration parameters. Changes apply immediately.</p>
      <div style="display:flex;gap:20px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap">
        <div class="ap-field"><label>Min Team Size</label><select id="apMinSize" onchange="updateRegSettings()" style="width:100px"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
        <div class="ap-field"><label>Max Team Size</label><select id="apMaxSize" onchange="updateRegSettings()" style="width:100px"><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option></select></div>
        <div class="ap-field"><label>Max Teams</label><input type="number" id="apMaxTeams" value="20" min="2" max="100" onchange="updateRegSettings()" style="width:80px"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqEmail" checked onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Email Address</span></label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqPhone" onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Phone Number</span></label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="apReqDept" onchange="updateRegSettings()"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#999;letter-spacing:.5px">Require Department</span></label>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid rgba(0,255,136,.1);border-radius:4px;background:rgba(0,255,136,.02)">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;flex:1"><input type="checkbox" id="apRegOpen" checked onchange="updateRegSettings()"><span style="font-family:Saira,sans-serif;font-size:10px;color:var(--green);letter-spacing:1px;font-weight:600">Registration Open</span></label>
        <span id="apRegStatus" style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--green);letter-spacing:1px;font-weight:700">● OPEN</span>
      </div>
    </div>
  </div>
</div>

<!-- APPEARANCE PANEL -->
<div id="appearancePanel">
  <div class="ap-container">
    <div class="ap-header"><h3>🎨 Appearance</h3><button class="mv-close" onclick="closeAppearancePanel()">✕ CLOSE</button></div>
    <div class="ap-section"><h4>🏠 Landing Page</h4>
      <p>Customize the landing page banner and text.</p>
      <div class="ap-field" style="margin-bottom:10px"><label>Banner Image</label>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="cursor:pointer;font-size:9px;color:var(--cyan);letter-spacing:1px;padding:8px 14px;border:1px solid rgba(0,212,255,.2);border-radius:3px;background:rgba(0,212,255,.05);white-space:nowrap;font-family:'IBM Plex Mono',monospace;flex-shrink:0">
            📁 Upload Image
            <input type="file" accept="image/*" onchange="handleAdminBannerUpload(this)" style="display:none">
          </label>
          <button class="ap-btn ap-btn-red" onclick="clearLandingBanner()" style="font-size:9px;padding:6px 10px;flex-shrink:0">✕ Clear</button>
        </div>
      </div>
      <div style="display:flex;gap:20px;align-items:center;margin-bottom:14px;padding:12px 16px;background:rgba(255,255,255,.015);border:1px solid rgba(255,255,255,.04);border-radius:6px">
        <div class="banner-preview" id="apBannerPreview"><span class="bp-emoji" id="apBannerFallbackPreview">🔐</span></div>
        <div style="flex:1;min-width:0">
          <div class="ap-field" style="margin-bottom:8px"><label>Fallback Icon</label>
            <div style="display:flex;align-items:center;gap:10px">
              <input id="apBannerFallback" value="🔐" onchange="updateBannerFallback()" style="width:54px;text-align:center;font-size:18px;background:#080a10;border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:6px;color:#ddd;outline:none" maxlength="4">
              <span style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555">Shown when no image is uploaded</span>
            </div>
          </div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:#555;letter-spacing:.5px" id="apBannerStatus">No image set</div>
        </div>
      </div>
      <div class="ap-two-col-even" style="margin-bottom:12px">
        <div class="ap-field"><label>Title <span class="save-blip" id="blipLandingTitle">✓ Saved</span></label><input id="apLandingTitle" value="Code Breakers" onchange="updateLandingTitle()"></div>
        <div class="ap-field"><label>Subtitle <span class="save-blip" id="blipLandingSub">✓ Saved</span></label><input id="apLandingSubtitle" value="Rise to The Challenge" onchange="updateLandingSubtitle()"></div>
      </div>
      <div style="text-align:center;padding-top:4px"><button class="ap-btn ap-btn-cyan" onclick="previewLandingPage()" style="font-size:10px;padding:8px 20px">👁 Preview Landing Page</button></div>
    </div>
    <div class="ap-section"><h4>🖥️ Console Theme <span class="save-blip" id="blipGridTheme">✓ Saved</span></h4>
      <p>Choose the visual style for the console grid tiles. Content, badges, and activity indicators remain unchanged — only the frame and aesthetic changes.</p>
      <div style="display:flex;align-items:center;gap:14px;margin-top:8px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green);letter-spacing:1px" id="currentThemeLabel">Current: CRT Monitor</div>
        <button class="ap-btn ap-btn-cyan" onclick="openThemePreview()" style="font-size:10px;padding:8px 20px">👁 Preview & Select Theme</button>
      </div>
    </div>
    <div class="ap-section"><h4>🌐 Console Background <span class="save-blip" id="blipConsoleBg">✓ Saved</span></h4>
      <p>Set the background color and overlay texture for the console screen. Affects all users in real-time.</p>
      <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:12px">
        <div style="flex:1;min-width:200px">
          <label style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#666;text-transform:uppercase;display:block;margin-bottom:8px">Background Color</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="color" id="consoleBgColor" value="#080a10" onchange="updateConsoleBg()" style="width:48px;height:36px;border:1px solid var(--border);border-radius:4px;background:transparent;cursor:pointer;padding:2px">
            <input id="consoleBgHex" value="#080a10" onchange="document.getElementById('consoleBgColor').value=this.value;updateConsoleBg()" style="width:90px;font-family:IBM Plex Mono,monospace;font-size:11px;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:6px 8px;color:#aaa;outline:none;letter-spacing:1px">
          </div>
          <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
            <button class="cbg-preset" onclick="setConsoleBgColor('#080a10')" title="Default Black" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#080a10;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#0a1628')" title="Dark Navy" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#0a1628;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#1a1f2e')" title="Dark Slate" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#1a1f2e;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#1e1e24')" title="Deep Charcoal" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#1e1e24;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#0d1a0d')" title="Dark Green" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#0d1a0d;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#1a0a0a')" title="Dark Red" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#1a0a0a;cursor:pointer"></button>
            <button class="cbg-preset" onclick="setConsoleBgColor('#12121a')" title="Dark Purple" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:#12121a;cursor:pointer"></button>
          </div>
        </div>
        <div style="flex:1;min-width:200px">
          <label style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#666;text-transform:uppercase;display:block;margin-bottom:8px">Texture Overlay</label>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px" id="consoleBgTextureGrid">
            <button class="cbg-tex active" data-tex="none" onclick="setConsoleTexture('none')"><span class="cbg-tex-preview" style="background:#080a10"></span><span class="cbg-tex-label">None</span></button>
            <button class="cbg-tex" data-tex="scanlines" onclick="setConsoleTexture('scanlines')"><span class="cbg-tex-preview" style="background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.03) 2px,rgba(255,255,255,.03) 4px)"></span><span class="cbg-tex-label">Scanlines</span></button>
            <button class="cbg-tex" data-tex="grid" onclick="setConsoleTexture('grid')"><span class="cbg-tex-preview" style="background:repeating-linear-gradient(0deg,transparent,transparent 11px,rgba(0,255,136,.04) 11px,rgba(0,255,136,.04) 12px),repeating-linear-gradient(90deg,transparent,transparent 11px,rgba(0,255,136,.04) 11px,rgba(0,255,136,.04) 12px)"></span><span class="cbg-tex-label">Grid</span></button>
            <button class="cbg-tex" data-tex="noise" onclick="setConsoleTexture('noise')"><span class="cbg-tex-preview cbg-noise-preview"></span><span class="cbg-tex-label">Noise</span></button>
            <button class="cbg-tex" data-tex="circuit" onclick="setConsoleTexture('circuit')"><span class="cbg-tex-preview" style="background:repeating-linear-gradient(90deg,transparent,transparent 20px,rgba(0,212,255,.03) 20px,rgba(0,212,255,.03) 21px),repeating-linear-gradient(0deg,transparent,transparent 30px,rgba(0,212,255,.03) 30px,rgba(0,212,255,.03) 31px),repeating-linear-gradient(45deg,transparent 0px,transparent 28px,rgba(0,212,255,.02) 28px,rgba(0,212,255,.02) 29px)"></span><span class="cbg-tex-label">Circuit</span></button>
            <button class="cbg-tex" data-tex="hex" onclick="setConsoleTexture('hex')"><span class="cbg-tex-preview cbg-hex-preview"></span><span class="cbg-tex-label">Hex</span></button>
          </div>
          <div style="margin-top:10px">
            <label style="font-family:Saira,sans-serif;font-size:8px;letter-spacing:2px;color:#555;text-transform:uppercase;display:block;margin-bottom:4px">Texture Opacity: <span id="texOpacityVal">40%</span></label>
            <input type="range" id="consoleBgTexOpacity" min="10" max="100" value="40" oninput="updateTexOpacity()" style="width:100%;accent-color:var(--cyan)">
          </div>
        </div>
      </div>
      <div style="margin-top:14px;text-align:center">
        <button class="ap-btn ap-btn-ghost" onclick="resetConsoleBg()" style="font-size:9px;padding:7px 20px">↺ Reset to Default</button>
      </div>
    </div>
    <div class="ap-section"><h4>🔍 Intel Theme <span class="save-blip" id="blipIntelTheme">✓ Saved</span></h4>
      <p>Visual style for the Intel Submissions screen. Standard is clean and minimal. CRT adds scanlines, phosphor glow, and vignette for an immersive terminal feel.</p>
      <div style="display:flex;align-items:center;gap:14px;margin-top:8px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green);letter-spacing:1px" id="currentIntelThemeLabel">Current: Standard</div>
        <button class="ap-btn ap-btn-cyan" onclick="openIntelThemePreview()" style="font-size:10px;padding:8px 20px">👁 Preview & Select</button>
      </div>
    </div>
    <div class="ap-section"><h4>🖋 Typography <span class="save-blip" id="blipTypography">✓ Saved</span></h4>
      <p>Global font overrides by content zone. Setting a font here overrides the theme default for that zone across the whole app. Leave as Default to inherit the theme font.</p>
      <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:14px">

        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#555;text-transform:uppercase;font-weight:600;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.04)">Intelligence Feed</div>
        <div class="ap-two-col-even" style="margin-bottom:0">
          <div class="ap-field">
            <label>Feed Captions</label>
            <div id="fc_feedCap_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">Caption text beneath each image or clip in the Intelligence Feed grid and focus view.</div>
          </div>
        </div>

        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#555;text-transform:uppercase;font-weight:600;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.04)">Evidence Locker</div>
        <div class="ap-two-col-even" style="margin-bottom:0">
          <div class="ap-field">
            <label>Item Titles</label>
            <div id="fc_mediaName_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">The bold title on each evidence card in the Evidence Locker panel.</div>
          </div>
          <div class="ap-field">
            <label>Item Descriptions</label>
            <div id="fc_mediaDesc_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">The secondary description line beneath each evidence item title.</div>
          </div>
        </div>

        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#555;text-transform:uppercase;font-weight:600;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.04)">The Vault</div>
        <div class="ap-two-col-even" style="margin-bottom:0">
          <div class="ap-field">
            <label>Keypad Display</label>
            <div id="fc_vaultDisplay_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">The large character display on The Vault keypad as teams type their code.</div>
          </div>
        </div>

        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:#555;text-transform:uppercase;font-weight:600;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.04)">Intel Submissions</div>
        <div class="ap-two-col-even" style="margin-bottom:0">
          <div class="ap-field">
            <label>Field Labels</label>
            <div id="fc_intelLabel_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">The question label to the left of each intel answer field.</div>
          </div>
          <div class="ap-field">
            <label>Answer Inputs</label>
            <div id="fc_intelInput_wrap"></div>
            <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;margin-top:4px;letter-spacing:.3px">The typed text inside answer input boxes across all intel field types.</div>
          </div>
        </div>

      </div>
      <div style="text-align:center;padding-top:4px"><button class="ap-btn ap-btn-ghost" onclick="resetFontConfig()" style="font-size:9px;padding:7px 20px">↺ Reset All to Default</button></div>
    </div>
  </div>
</div>

<!-- TEAM MONITOR PANEL -->
<div id="dashboardPanel">
  <div class="ap-container" style="width:700px">
    <div class="ap-header"><h3>📊 Dashboard</h3><button class="mv-close" onclick="closeDashboard()">✕ CLOSE</button></div>
    <div id="dashMonitorView">
    <div class="ap-section">
      <p>Real-time view of all registered teams and their activity status. Teams inactive for 5+ minutes are flagged.</p>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div class="ap-status-pill active"><span class="ap-status-dot on"></span> Active: <strong id="apActiveCount">0</strong></div>
        <div class="ap-status-pill idle" style="border:1px solid rgba(240,200,120,.15);background:rgba(240,200,120,.04);color:rgba(240,200,120,.7)"><span class="ap-status-dot" style="background:#f0c878"></span> Idle: <strong id="apInactiveCount">0</strong></div>
        <div class="ap-status-pill" style="border:1px solid rgba(255,51,51,.15);background:rgba(255,51,51,.04);color:rgba(255,100,100,.7);display:none"><span class="ap-status-dot" style="background:#ff4444"></span> Ghost: <strong id="apGhostCount">0</strong></div>
        <div class="ap-status-pill total">Total: <strong id="apTotalCount">0</strong></div>
      </div>
      <div class="ap-team-list" id="apTeamMonitor" style="max-height:none"></div>
      <div id="tmNukeBar" style="display:none;padding:8px 12px;margin:6px 0;background:rgba(255,51,51,.06);border:1px solid rgba(255,51,51,.2);border-radius:4px;display:none;align-items:center;gap:10px">
        <span style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#ff6666;letter-spacing:1px" id="tmNukeCount">0 selected</span>
        <button onclick="nukeSelectedTeams()" style="margin-left:auto;font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;color:#ff4444;background:rgba(255,51,51,.1);border:1px solid rgba(255,51,51,.3);border-radius:3px;padding:5px 12px;cursor:pointer">☢ NUKE SELECTED</button>
      </div>
      <div class="lb-pagination" id="tmPagination"></div>
      <div style="display:flex;gap:8px;align-items:center;padding:8px 0;border-top:1px solid var(--border);margin-top:8px">
        <span style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#666;font-size:10px">Per page:</span>
        <select id="tmPerPage" onchange="tmPerPage=parseInt(this.value);tmCurrentPage=0;renderTeamMonitor()" style="background:#080a10;border:1px solid var(--border);border-radius:3px;padding:3px 6px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:9px;outline:none">
          <option value="15" selected>15</option><option value="20">20</option><option value="25">25</option><option value="50">50</option>
        </select>
      </div>
    </div>
    </div>
  </div>
</div>

<!-- BROADCAST PANEL -->
<div id="broadcastPanel">
  <div class="bc-container">
    <div class="bc-header"><h3>📢 Broadcast</h3><button class="mv-close" onclick="closeBroadcast()">✕ CLOSE</button></div>
    <div class="bc-body">
      <div class="bc-tabs">
        <div class="bc-tab active" onclick="switchBcTab(this,'text')">💬 Text Message</div>
        <div class="bc-tab" onclick="switchBcTab(this,'voice')">🎙️ Voice Note</div>
      </div>
      <div id="bcTextTab">
        <textarea class="bc-textarea" id="bcMessage" placeholder="Type a message to broadcast to all players..."></textarea>
      </div>
      <div id="bcVoiceTab" style="display:none">
        <div class="bc-voice">
          <div class="bc-rec-btn" id="bcRecBtn" onclick="toggleRecording()">🎙️</div>
          <div class="bc-rec-label" id="bcRecLabel">Tap to record</div>
          <div class="bc-preview" id="bcPreview" style="display:none">
            <audio id="bcAudioPreview" controls style="width:100%"></audio>
          </div>
        </div>
      </div>
      <div class="bc-footer">
        <button class="ap-btn ap-btn-cyan" onclick="closeBroadcast()">Cancel</button>
        <button class="ap-btn ap-btn-amber" onclick="sendBroadcast()">📡 Broadcast Now</button>
      </div>
    </div>
  </div>
</div>

<!-- PLAYER BROADCAST BANNER -->
<div id="playerBanner">
  <div class="pb-inner">
    <span class="pb-icon" id="pbIcon">📢</span>
    <div id="pbContent"></div>
    <span class="pb-close" onclick="dismissBanner()">✕</span>
    <div class="pb-progress" id="pbProgress"></div>
  </div>
</div>

<!-- FULL LEADERBOARD MODULE -->
<div id="leaderboardModule">
  <div class="lb-container">
    <div class="lb-header">
      <h3 class="lb-title">🏆 Live Leaderboard</h3>
      <div class="lb-header-right">
        <span class="lb-team-count" id="lbTeamCount">0 teams</span>
        <button class="mv-close" onclick="closeLeaderboard()">✕ CLOSE</button>
      </div>
    </div>
    <div class="lb-toolbar">
      <input class="lb-search" id="lbSearch" placeholder="Search teams..." oninput="renderFullLeaderboard()">
      <div class="lb-filters">
        <button class="lb-filter active" data-f="all" onclick="setLbFilter(this,'all')">All</button>
        <button class="lb-filter" data-f="active" onclick="setLbFilter(this,'active')">Active</button>
        <button class="lb-filter" data-f="inactive" onclick="setLbFilter(this,'inactive')">Inactive</button>
        <button class="lb-filter" data-f="ghost" onclick="setLbFilter(this,'ghost')">Ghosts</button>
        <button class="lb-filter" data-f="submitted" onclick="setLbFilter(this,'submitted')">Submitted</button>
      </div>
      <div class="lb-sort">
        <span style="font-family:Chakra Petch,sans-serif;font-size:8px;color:#666;letter-spacing:1px">Sort:</span>
        <select id="lbSort" onchange="renderFullLeaderboard()" style="background:#080a10;border:1px solid var(--border);border-radius:3px;padding:6px 10px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:10px;outline:none">
          <option value="score">Score (High→Low)</option>
          <option value="fields">Fields Completed</option>
          <option value="recent">Most Recent</option>
          <option value="name">Team Name (A→Z)</option>
          <option value="registered">Registration Order</option>
        </select>
      </div>
    </div>
    <div class="lb-body" id="lbBody"></div>
    <div class="lb-pagination" id="lbPagination"></div>
    <div class="lb-admin-actions" id="lbAdminActions" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:12px 16px;border-top:1px solid var(--border)">
        <button class="ap-btn ap-btn-amber" onclick="desubmitSelected()" style="font-size:9px;padding:5px 12px">↩ De-submit Selected</button>
        <button class="ap-btn ap-btn-red" onclick="desubmitAll()" style="font-size:9px;padding:5px 12px">↩ De-submit All</button>
        <div style="flex:1"></div>
        <span style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#666;font-size:10px">Per page:</span>
        <select id="lbPerPage" onchange="lbPerPage=parseInt(this.value);lbCurrentPage=0;renderFullLeaderboard()" style="background:#080a10;border:1px solid var(--border);border-radius:3px;padding:5px 10px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:10px;outline:none">
          <option value="15" selected>15</option><option value="20">20</option><option value="25">25</option><option value="50">50</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- KEYS & CODES PANEL -->
<div id="keysCodesPanel">
  <div class="kc-container">
    <div class="kc-header"><h3>🎯 Intel & Scoring</h3><button class="mv-close" onclick="closeKeysCodes()">✕ CLOSE</button></div>
    <div class="kc-body" id="kcBody"></div>
  </div>
</div>
  <div class="console-topbar">
    <div style="display:flex;flex-direction:column;gap:2px">
      <div style="display:flex;align-items:center;gap:4px"><span class="console-title" id="consoleTitle">◈ Operation Dead Drop</span><button class="admin-edit-inline" onclick="event.stopPropagation();editOperationName()">✎</button></div>
      <span id="buildStamp" style="display:none;font-family:'IBM Plex Mono',monospace;font-size:8px;color:#333;letter-spacing:1px"></span>
    </div>
    <div style="display:flex;align-items:center">
      <div class="timer-block"><div class="timer-digits" id="cTimer">∞</div><div class="timer-label">Time Remaining</div></div>
    </div>
    <div class="topbar-identity" onclick="toggleTeamCard(event)">
      <span class="console-team">—</span>
      <span class="admin-topbar-label">ADMIN</span>
      <span class="team-chevron">▾</span>
      <span class="team-notif-badge" id="teamNotifBadge"></span>
      <div class="team-card" id="teamCard">
        <div class="team-card-header">
          <div class="team-card-name">—</div>
          <div class="team-card-id">ID: —</div>
        </div>
        <div class="team-card-body">
          <div class="team-card-section">
            <div class="team-card-label">Operatives</div>
          </div>
          <div class="team-card-section">
            <div class="team-card-label">Mission Status</div>
            <div class="team-card-stats">
              <div class="team-card-stat"><div class="team-card-stat-val" id="tcElapsed">00:00</div><div class="team-card-stat-lbl">Elapsed</div></div>
              <div class="team-card-stat"><div class="team-card-stat-val" id="tcIntel">0 / 10</div><div class="team-card-stat-lbl">Intel Entered</div></div>
            </div>
          </div>
          <div class="team-card-notifs" id="teamCardNotifs">
            <div class="team-card-label" style="display:flex;align-items:center;justify-content:space-between">Notifications <span class="notif-clear-link" onclick="event.stopPropagation();clearNotifications()">Clear all</span></div>
            <div class="team-card-notif-list" id="teamNotifList"><div class="notif-empty">No notifications yet</div></div>
          </div>
          <div style="padding:4px 16px 0;border-top:1px solid rgba(255,255,255,.04)">
            <div onclick="event.stopPropagation();toggleTeamCard();setTimeout(replayTutorial,200)" style="display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;opacity:.6;transition:opacity .15s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'">
              <span style="font-size:12px">📖</span><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa;letter-spacing:.5px">Replay Tutorial</span>
            </div>
          </div>
          <div onclick="event.stopPropagation();toggleTeamCard();openChangePassword()" style="display:none;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;opacity:.6;transition:opacity .15s;border-top:1px solid rgba(255,255,255,.04)" class="admin-only-card-item" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'">
            <span style="font-size:12px">🔑</span><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa;letter-spacing:.5px">Change Password</span>
          </div>
          <div class="team-card-logout" onclick="event.stopPropagation();showLogout()">
            <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:var(--red);stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><polyline points="15 18 9 12 15 6"/></svg>
            <span>Logout</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="console-grid" id="consoleGrid"></div>
  <div class="console-worldmap"></div>
</div>

<!-- Logout button — body level for z-index independence -->

<div id="notepadPanel">
  <div class="notepad-header">
    <span class="notepad-header-icon">📝</span>
    <span class="notepad-header-title">Notepad</span>
    <div class="notepad-header-actions">
      <button class="btn-standard btn-ghost" style="padding:5px 14px;font-size:9px" onclick="toggleNotepad()">✕ CLOSE</button>
    </div>
  </div>
  <div class="notepad-hint">Use this space to jot down observations, track theories, and coordinate with your team.</div>
  <div class="notepad-body">
    <textarea class="notepad-textarea" id="notepadText" placeholder="Start typing your notes..." oninput="onNoteInput()"></textarea>
  </div>
  <div class="notepad-footer">
    <span class="notepad-charcount" id="notepadCount">0 characters</span>
    <button class="notepad-clear" onclick="clearNotes()">Clear All Notes</button>
  </div>
</div>

<!-- EXPANDED -->
<div id="panelOverlay">
  <div class="expanded-panel" id="expFeed"><div class="exp-header"><span class="panel-icon">📡</span><span class="exp-title">Intelligence Feed</span><span id="feedCountIndicator" class="feed-count-badge"></span><div style="margin-left:auto"></div><div id="feedViewToggle" class="feed-view-toggle"><div class="feed-view-btn active" onclick="setFeedView('grid')" id="fvGrid">◫ Grid</div><div class="feed-view-btn" onclick="setFeedView('single')" id="fvSingle">◻ Focus</div></div><button class="exp-close" id="feedCloseBtn" onclick="feedClose()">✕ CLOSE</button></div><div class="exp-body" id="feedExpBody"><div id="feedGridView" class="feed-expanded"></div><div id="feedSingleView" class="feed-single"><div class="feed-single-img" id="singleImg"></div><div class="feed-single-controls"><div class="feed-single-nav-row"><button class="feed-nav-btn" onclick="navPost(-1)">◂ PREV</button><span class="feed-single-counter" id="singleCounter"></span><button class="feed-nav-btn" onclick="navPost(1)">NEXT ▸</button></div></div><div class="feed-single-cap-zone"><div class="feed-single-caption" id="singleCap"></div><div class="feed-single-caption-more" id="feedCapMore" onclick="toggleFeedCaption()">▾ more</div><div class="feed-single-cap-overlay" id="feedCapOverlay"><div class="feed-single-cap-overlay-text" id="feedCapOverlayText"></div><div class="feed-single-cap-overlay-close" onclick="closeFeedCapOverlay()">▴ less</div></div></div><div class="swipe-hint">← Swipe or use arrow keys →</div></div></div></div>
  <div class="expanded-panel" id="expMedia"><div class="exp-header"><span class="panel-icon">🗂️</span><span class="exp-title">Evidence Locker</span><span id="mediaCountIndicator" class="feed-count-badge" style="margin-left:10px"></span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div><div class="exp-body"><div style="margin-bottom:8px"><input id="mediaSearchFilter" placeholder="Search files..." oninput="renderMedia()" style="width:100%;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:8px 12px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:1px;outline:none"></div><div id="mediaSelectBar" style="display:none;padding:8px 12px;background:rgba(255,51,51,.06);border:1px solid rgba(255,51,51,.15);border-radius:5px;margin-bottom:10px;align-items:center;gap:10px"><span id="mediaSelectCount" style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:#aaa;flex:1">0 selected</span><button onclick="selectAllMedia()" style="font-family:'Saira',sans-serif;font-size:10px;letter-spacing:1px;background:none;border:1px solid #444;border-radius:3px;padding:4px 10px;color:#aaa;cursor:pointer">SELECT ALL</button><button onclick="deleteSelectedMedia()" style="font-family:'Saira',sans-serif;font-size:10px;letter-spacing:1px;background:rgba(255,51,51,.15);border:1px solid rgba(255,51,51,.3);border-radius:3px;padding:4px 12px;color:var(--red);cursor:pointer">🗑 DELETE SELECTED</button><button onclick="exitMediaSelectMode()" style="font-family:'Saira',sans-serif;font-size:10px;letter-spacing:1px;background:none;border:1px solid #333;border-radius:3px;padding:4px 10px;color:#666;cursor:pointer">CANCEL</button></div><div id="mediaList" class="media-expanded"></div></div></div>
  <div class="expanded-panel" id="expIntel"><div class="exp-header"><span class="panel-icon">🎯</span><span class="exp-title">Intel Submissions</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div><div class="exp-body intel-exp-body"><div class="intel-scroll-area"><div class="intel-crt-header" style="text-align:center;justify-content:center"><div class="intel-crt-dot"></div> INTEL SUBMISSIONS</div><div class="intel-notice" id="intelNotice"><span class="intel-notice-icon">💾</span> Your answers save automatically as you type — feel free to edit, revise, and change them as many times as you need. Once you press <strong>Submit Intel</strong>, your answers are locked in and cannot be changed.</div><div id="intelForm"></div></div><div class="intel-transmit-dock" id="intelTransmitDock"></div></div></div>
  <div class="expanded-panel" id="expVault">
    <div class="exp-header"><span class="panel-icon">🔐</span><span class="exp-title">The Vault</span><button class="exp-close" onclick="closePanel()">✕ CLOSE</button></div>
    <div class="exp-body">
      <div class="vault-puzzle-layout">
        <div class="vault-keypad-section">
          <div class="vault-panel" id="vaultPanel">
            <div class="v-rate-limit" id="vRateLimit"><span class="v-rate-limit-text" id="vRateLimitText">⚠ Security Lockout</span><span class="v-rate-limit-timer" id="vRateLimitTimer">30</span><div class="v-rate-limit-bar"><div class="v-rate-limit-fill" id="vRateLimitFill"></div></div><span class="v-rate-limit-sub" id="vRateLimitSub">Too many failed attempts</span></div>
            <div class="rv rv-1"></div><div class="rv rv-2"></div><div class="rv rv-3"></div><div class="rv rv-4"></div>
            <div class="v-display"><div class="v-disp-row"><span id="vDisp">ENTER CODE</span><span id="vCursor"></span></div><div class="v-tries" id="vkTries"></div></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('1')"><span>1</span></div><div class="kb-key" onclick="vkType('2')"><span>2</span></div><div class="kb-key" onclick="vkType('3')"><span>3</span></div><div class="kb-key" onclick="vkType('4')"><span>4</span></div><div class="kb-key" onclick="vkType('5')"><span>5</span></div><div class="kb-key" onclick="vkType('6')"><span>6</span></div><div class="kb-key" onclick="vkType('7')"><span>7</span></div><div class="kb-key" onclick="vkType('8')"><span>8</span></div><div class="kb-key" onclick="vkType('9')"><span>9</span></div><div class="kb-key" onclick="vkType('0')"><span>0</span></div></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('Q')"><span>Q</span></div><div class="kb-key" onclick="vkType('W')"><span>W</span></div><div class="kb-key" onclick="vkType('E')"><span>E</span></div><div class="kb-key" onclick="vkType('R')"><span>R</span></div><div class="kb-key" onclick="vkType('T')"><span>T</span></div><div class="kb-key" onclick="vkType('Y')"><span>Y</span></div><div class="kb-key" onclick="vkType('U')"><span>U</span></div><div class="kb-key" onclick="vkType('I')"><span>I</span></div><div class="kb-key" onclick="vkType('O')"><span>O</span></div><div class="kb-key" onclick="vkType('P')"><span>P</span></div></div>
            <div class="kb-row"><div class="kb-key" onclick="vkType('A')"><span>A</span></div><div class="kb-key" onclick="vkType('S')"><span>S</span></div><div class="kb-key" onclick="vkType('D')"><span>D</span></div><div class="kb-key" onclick="vkType('F')"><span>F</span></div><div class="kb-key" onclick="vkType('G')"><span>G</span></div><div class="kb-key" onclick="vkType('H')"><span>H</span></div><div class="kb-key" onclick="vkType('J')"><span>J</span></div><div class="kb-key" onclick="vkType('K')"><span>K</span></div><div class="kb-key" onclick="vkType('L')"><span>L</span></div></div>
            <div class="kb-row"><div class="kb-key fn clr-key" onclick="vkClear()"><span>CLR</span></div><div class="kb-key" onclick="vkType('Z')"><span>Z</span></div><div class="kb-key" onclick="vkType('X')"><span>X</span></div><div class="kb-key" onclick="vkType('C')"><span>C</span></div><div class="kb-key" onclick="vkType('V')"><span>V</span></div><div class="kb-key" onclick="vkType('B')"><span>B</span></div><div class="kb-key" onclick="vkType('N')"><span>N</span></div><div class="kb-key" onclick="vkType('M')"><span>M</span></div><div class="kb-key fn del-key" onclick="vkDel()"><span>⌫</span></div></div>
            <div class="kb-row"><div class="kb-key fn sym-key" onclick="vkToggleSymbols()"><span id="vkSymLabel">SYM</span></div><div class="kb-key enter-key" style="flex:3" onclick="vkSubmit()"><span>ENTER</span></div></div>
            <div class="v-status" id="vkStatus" style="display:none"><div class="v-dot" id="vkDot"></div><span class="v-lbl" id="vkLbl"></span></div>
          </div>
        </div>
        <div class="vault-unlock-section">
          <div class="vault-unlock-header">
            <span class="vault-unlock-title">🔓 Vault Log</span>
            <span class="vault-unlock-count" id="vaultUnlockCount">EMPTY</span>
          </div>
          <div class="vault-unlock-list" id="vaultUnlockList">
            <div class="vault-unlock-empty">No codes entered yet. Solve puzzles across the Intelligence Feed and Evidence Locker to discover vault codes.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MEDIA VIEWER -->
<div id="mediaViewer">
  <div class="mv-container">
    <div class="mv-header">
      <div class="mv-header-info">
        <span class="mv-icon" id="mvIcon"></span>
        <div class="mv-header-text">
          <span class="mv-filename" id="mvName"></span>
          <span class="mv-filedesc" id="mvDesc"></span>
        </div>
        <span class="mv-badge" id="mvBadge"></span>
      </div>
      <button class="mv-download" id="mvDownload" onclick="downloadCurrentMedia()" style="display:none">⬇ DOWNLOAD</button>
      <button class="mv-close" onclick="closeMediaViewer()">✕ CLOSE</button>
    </div>
    <div class="mv-body" id="mvBody">
      <!-- Dynamic content injected here -->
    </div>
    <div class="mv-nav">
      <button class="mv-nav-btn" onclick="navMedia(-1)">◂ PREV FILE</button>
      <span class="mv-nav-counter" id="mvCounter"></span>
      <button class="mv-nav-btn" onclick="navMedia(1)">NEXT FILE ▸</button>
    </div>
  </div>
</div>

<script>
// ══════ REGISTRATION ══════
function formatRegPhone(el){
  let v=el.value.replace(/\D/g,'').slice(0,10);
  if(v.length>6)v='('+v.slice(0,3)+') '+v.slice(3,6)+'-'+v.slice(6);
  else if(v.length>3)v='('+v.slice(0,3)+') '+v.slice(3);
  else if(v.length>0)v='('+v;
  el.value=v;
}
function generateTeamId(name){
  // First 4 uppercase letters of name, pad with X if needed
  const clean=(name||'TEAM').replace(/[^a-zA-Z]/g,'').toUpperCase();
  const prefix=(clean+'XXXX').substring(0,4);
  let id,attempts=0;
  do{
    const num=String(Math.floor(1000+Math.random()*9000));
    id=prefix+'-'+num;
    attempts++;
  }while(registeredTeams.some(t=>t.id===id)&&attempts<100);
  return id;
}
function submitRegistration(){
  // PREVIEW MODE INTERCEPTION
  if(document.body.classList.contains('landing-preview-mode')){
    const btn=document.getElementById('regSubmitBtn');
    const btnSpan=btn.querySelector('span');
    btn.style.opacity='.4';btn.style.pointerEvents='none';
    setRegLed('active');
    setRegStatus('<span class="login-crt-spinner"></span>VALIDATING...','authenticating');
    setTimeout(()=>{
      setRegStatus('<span class="login-crt-spinner"></span>REGISTERING...','authenticating');
    },600);
    setTimeout(()=>{
      setRegLed('granted');
      setRegStatus('REGISTRATION COMPLETE','granted');
      document.getElementById('regForm').style.display='none';
      document.getElementById('regSuccess').style.display='block';
      document.getElementById('regBtnRow').style.display='none';
      document.getElementById('regTeamId').textContent='PREVIEW-0000';
      playSuccess();
    },1200);
    setTimeout(()=>{
      document.getElementById('regForm').style.display='';
      document.getElementById('regSuccess').style.display='none';
      document.getElementById('regBtnRow').style.display='';
      btn.style.opacity='';btn.style.pointerEvents='';
      setRegLed('');setRegStatus('');
    },4000);
    return;
  }
  const mode=regSettings.participantMode||'team';
  let effectiveType=mode==='individual'?'individual':(mode==='team'?'team':currentRegType);

  function regValidationErr(msg){
    setRegLed('denied');
    setRegStatus(msg.toUpperCase(),'denied');
    setTimeout(()=>{setRegLed('');setRegStatus('')},3000);
  }

  if(!regSettings.registrationOpen){regValidationErr('Registration closed');return}

  let entityName='', members=[], email='', phone='', dept='';

  if(effectiveType==='team'){
    entityName=document.getElementById('regTeamName')?.value.trim()||'';
    if(!entityName){regValidationErr('Enter team name');return}
    if(entityName.length>30){regValidationErr('Name too long (max 30)');return}
    if(/[<>"'&]/.test(entityName)){regValidationErr('Invalid characters in name');return}
    const memberCount=parseInt(document.getElementById('regMemberCount')?.value||regSettings.teamSizeMax);
    for(let m=1;m<=memberCount;m++){
      const name=document.getElementById('reg'+m+'Name')?.value.trim();
      const mdept=document.getElementById('reg'+m+'Dept')?.value.trim()||'';
      const memail=document.getElementById('reg'+m+'Email')?.value.trim()||'';
      const mphone=document.getElementById('reg'+m+'Phone')?.value.trim()||'';
      if(!name){regValidationErr('Enter name — member '+m);return}
      if(regSettings.requireEmail&&!memail){regValidationErr('Enter email — member '+m);return}
      if(regSettings.requirePhone&&!mphone){regValidationErr('Enter phone — member '+m);return}
      if(regSettings.requireDept&&!mdept){regValidationErr('Enter dept — member '+m);return}
      members.push({name,dept:mdept,email:memail,phone:mphone});
    }
    email=members[0]?.email||'';phone=members[0]?.phone||'';dept=members[0]?.dept||'';
  }else{
    entityName=document.getElementById('regIndividualName')?.value.trim()||'';
    if(!entityName){regValidationErr('Enter your name');return}
    if(entityName.length>40){regValidationErr('Name too long (max 40)');return}
    if(/[<>"'&]/.test(entityName)){regValidationErr('Invalid characters');return}
    dept=document.getElementById('regIndDept')?.value.trim()||'';
    email=document.getElementById('regIndEmail')?.value.trim()||'';
    phone=document.getElementById('regIndPhone')?.value.trim()||'';
    if(regSettings.requireEmail&&!email){regValidationErr('Enter your email');return}
    if(regSettings.requirePhone&&!phone){regValidationErr('Enter your phone');return}
    if(regSettings.requireDept&&!dept){regValidationErr('Enter your department');return}
    members=[{name:entityName,dept,email,phone}];
  }

  const btn=document.getElementById('regSubmitBtn');
  btn.style.opacity='.4';btn.style.pointerEvents='none';
  setRegLed('active');
  setRegStatus('<span class="login-crt-spinner"></span>VALIDATING...','authenticating');

  // Check for duplicate team name first
  apiCall('checkTeamName',{teamName:entityName}).then(checkResult=>{
    if(checkResult.ok&&checkResult.exists){
      // Duplicate found
      setRegLed('denied');
      setRegStatus('NAME ALREADY EXISTS','denied');
      btn.style.opacity='';btn.style.pointerEvents='';
      playDenied();
      document.getElementById('flashR').classList.add('on');
      setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
      setTimeout(()=>{setRegLed('');setRegStatus('')},3000);
      return;
    }
    // Name available — proceed with registration
    setRegStatus('<span class="login-crt-spinner"></span>REGISTERING...','authenticating');
    apiCall('registerTeam',{
      teamName:entityName,
      type:effectiveType,
      members:members,
      email:email,
      phone:phone,
      dept:dept
    }).then(result=>{
      if(result.ok){
        const teamId=result.teamId;
        document.getElementById('regTeamId').textContent=teamId;

        registeredTeams.push({
          id:teamId,name:entityName,type:effectiveType,
          members:members.map(m=>m.name),memberDetails:members,
          lastActive:Date.now(),fieldsCompleted:0,submitTime:null,
          registeredAt:new Date().toISOString(),submissionResults:null
        });

        setRegLed('granted');
        setRegStatus('REGISTRATION COMPLETE','granted');
        document.getElementById('regForm').style.display='none';
        document.getElementById('regSuccess').style.display='block';
        document.getElementById('regBtnRow').style.display='none';
        playSuccess();
        document.getElementById('flashG').classList.add('on');
        setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
      }else{
        setRegLed('denied');
        const errMsg=result.error||'Registration failed';
        if(errMsg.toLowerCase().includes('exist')||errMsg.toLowerCase().includes('duplicate')){
          setRegStatus('NAME ALREADY EXISTS','denied');
        }else{
          setRegStatus('REGISTRATION FAILED','denied');
        }
        btn.style.opacity='';btn.style.pointerEvents='';
        playDenied();
        document.getElementById('flashR').classList.add('on');
        setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
        setTimeout(()=>{setRegLed('');setRegStatus('')},3000);
      }
    });
  }).catch(()=>{
    // If checkTeamName API doesn't exist, proceed with registration directly
    setRegStatus('<span class="login-crt-spinner"></span>REGISTERING...','authenticating');
    apiCall('registerTeam',{
      teamName:entityName,
      type:effectiveType,
      members:members,
      email:email,
      phone:phone,
      dept:dept
    }).then(result=>{
      if(result.ok){
        const teamId=result.teamId;
        document.getElementById('regTeamId').textContent=teamId;
        registeredTeams.push({
          id:teamId,name:entityName,type:effectiveType,
          members:members.map(m=>m.name),memberDetails:members,
          lastActive:Date.now(),fieldsCompleted:0,submitTime:null,
          registeredAt:new Date().toISOString(),submissionResults:null
        });
        setRegLed('granted');
        setRegStatus('REGISTRATION COMPLETE','granted');
        document.getElementById('regForm').style.display='none';
        document.getElementById('regSuccess').style.display='block';
        document.getElementById('regBtnRow').style.display='none';
        playSuccess();
        document.getElementById('flashG').classList.add('on');
        setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
      }else{
        setRegLed('denied');
        setRegStatus('REGISTRATION FAILED','denied');
        btn.style.opacity='';btn.style.pointerEvents='';
        playDenied();
        setTimeout(()=>{setRegLed('');setRegStatus('')},3000);
      }
    });
  });
}

function updateRegSettings(){
  regSettings.teamSizeMin=parseInt(document.getElementById('apMinSize')?.value||2);
  regSettings.teamSizeMax=parseInt(document.getElementById('apMaxSize')?.value||4);
  regSettings.maxTeams=parseInt(document.getElementById('apMaxTeams')?.value||20);
  regSettings.requireEmail=document.getElementById('apReqEmail')?.checked||false;
  regSettings.requirePhone=document.getElementById('apReqPhone')?.checked||false;
  regSettings.requireDept=document.getElementById('apReqDept')?.checked||false;
  regSettings.registrationOpen=document.getElementById('apRegOpen')?.checked||false;
  // Ensure min <= max
  if(regSettings.teamSizeMin>regSettings.teamSizeMax)regSettings.teamSizeMin=regSettings.teamSizeMax;
  // Update status indicator
  const status=document.getElementById('apRegStatus');
  if(status){
    status.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';
    status.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)';
  }
  // Rebuild registration form with new member count
  buildRegForm();
  saveEventConfigToBackend();
}

function buildRegForm(){
  const container=document.getElementById('regOperatives');
  if(!container)return;
  const mode=regSettings.participantMode||'team';
  let effectiveType=mode==='individual'?'individual':(mode==='team'?'team':currentRegType);

  // Update section title
  const teamNameField=document.getElementById('regTeamName');

  if(effectiveType==='individual'){
    // Hide team name, show individual name
    const nameSection=teamNameField?.closest('.reg-section');
    if(nameSection){
      nameSection.innerHTML=`<div class="reg-field full"><label class="reg-main-label">Full Name</label><input type="text" id="regIndividualName" placeholder="Enter your full name" maxlength="40"></div>`;
    }
    // Show individual-specific optional fields instead of member slots
    let html='';
    if(regSettings.requireDept||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Department${regSettings.requireDept?'':' (optional)'}</label><input type="text" id="regIndDept" placeholder="Department"></div>`}
    if(regSettings.requireEmail||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Email${regSettings.requireEmail?'':' (optional)'}</label><input type="email" id="regIndEmail" placeholder="email@company.com"></div>`}
    if(regSettings.requirePhone||true){html+=`<div class="reg-field full" style="margin-bottom:10px"><label>Cell #${regSettings.requirePhone?'':' (optional)'}</label><input type="tel" id="regIndPhone" placeholder="(XXX) XXX-XXXX" oninput="formatRegPhone(this)"></div>`}
    container.innerHTML=html;
  }else{
    // Team mode — restore standard team form
    const nameSection=document.getElementById('regTeamName')?.closest('.reg-section')||document.getElementById('regIndividualName')?.closest('.reg-section');
    if(nameSection&&!document.getElementById('regTeamName')){
      nameSection.innerHTML=`<div class="reg-field full"><label class="reg-main-label">Team Name</label><input type="text" id="regTeamName" placeholder="Enter your team name" maxlength="30"></div>`;
    }
    // Standard team member slots
    const max=regSettings.teamSizeMax;
    const min=regSettings.teamSizeMin;
    let html='';
    if(min<max){
      html+=`<div class="reg-field full" style="margin-bottom:12px"><label class="reg-main-label">Number of Team Members</label><select id="regMemberCount" onchange="rebuildMemberSlots()" style="background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px 14px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none">`;
      for(let n=min;n<=max;n++)html+=`<option value="${n}"${n===max?' selected':''}>${n} Members</option>`;
      html+=`</select></div>`;
    }else{
      html+=`<input type="hidden" id="regMemberCount" value="${max}">`;
    }
    html+=`<div id="regMemberSlots"></div>`;
    container.innerHTML=html;
    rebuildMemberSlots();
  }
}

function rebuildMemberSlots(){
  const count=parseInt(document.getElementById('regMemberCount')?.value||regSettings.teamSizeMax);
  const slots=document.getElementById('regMemberSlots');
  if(!slots)return;
  let html='';
  for(let m=1;m<=count;m++){
    html+=`<div class="reg-member-block">
      <div class="reg-member-label"><span class="reg-member-num">${m}</span> Team Member ${m}</div>
      <div class="reg-row">
        <div class="reg-field"><label>Full Name</label><input type="text" id="reg${m}Name" placeholder="First & Last Name"></div>
        ${regSettings.requireDept||true?`<div class="reg-field"><label>Department${regSettings.requireDept?'':' (optional)'}</label><input type="text" id="reg${m}Dept" placeholder="Department"></div>`:''}
      </div>
      <div class="reg-row">
        ${regSettings.requireEmail||true?`<div class="reg-field"><label>Email${regSettings.requireEmail?'':' (optional)'}</label><input type="email" id="reg${m}Email" placeholder="email@company.com"></div>`:''}
        ${regSettings.requirePhone||true?`<div class="reg-field"><label>Cell #${regSettings.requirePhone?'':' (optional)'}</label><input type="tel" id="reg${m}Phone" placeholder="(XXX) XXX-XXXX" oninput="formatRegPhone(this)"></div>`:''}
      </div>
    </div>`;
  }
  slots.innerHTML=html;
}
function proceedToLogin(){
  goToLogin();
  // Pre-fill the Team ID from registration
  const teamId=document.getElementById('regTeamId')?.textContent;
  if(teamId&&teamId!=='—'){
    document.getElementById('loginId').value=teamId;
  }
}

// ══════ AUDIO ══════
// ══════ TEAM CARD ══════
let teamCardOpen=false,elapsedSec=0,elapsedInterval=null;
function toggleTeamCard(e){
  if(e)e.stopPropagation();
  teamCardOpen=!teamCardOpen;
  document.getElementById('teamCard').classList.toggle('open',teamCardOpen);
  if(teamCardOpen){
    updateTeamCardStats();
    onTeamCardOpen();
  }
}
function updateTeamCardStats(){
  // Elapsed
  const m=String(Math.floor(elapsedSec/60)).padStart(2,'0');
  const s=String(elapsedSec%60).padStart(2,'0');
  document.getElementById('tcElapsed').textContent=m+':'+s;
  // Intel marked
  const inputs=document.querySelectorAll('.intel-exp-input');
  let n=0;inputs.forEach(inp=>{if(inp.value.trim())n++});
  document.getElementById('tcIntel').textContent=n+' / '+inputs.length+(isSubmitted?' ✓':'');
}
// Start elapsed timer when console opens
function startElapsedTimer(){
  if(elapsedInterval)return;
  // Set session start time if not restored from game state
  if(!_sessionStartTime)_sessionStartTime=Date.now()-elapsedSec*1000;
  elapsedInterval=setInterval(()=>{elapsedSec++;if(teamCardOpen)updateTeamCardStats()},1000);
}
// Close card when clicking outside
document.addEventListener('click',()=>{if(teamCardOpen){teamCardOpen=false;document.getElementById('teamCard').classList.remove('open')}});

// ══════ LOGOUT ══════
// ══════ NOTEPAD ══════
let notepadOpen=false;
function toggleNotepad(){
  notepadOpen=!notepadOpen;
  document.getElementById('notepadPanel').classList.toggle('open',notepadOpen);
  if(notepadOpen){
    playTileClick();
    // Load saved notes
    const saved=localStorage.getItem('dd_notes')||'';
    document.getElementById('notepadText').value=saved;
    updateNoteCount();
    updateNoteDot();
    setTimeout(()=>document.getElementById('notepadText').focus(),350);
  }
}
function onNoteInput(){
  const text=document.getElementById('notepadText').value;
  localStorage.setItem('dd_notes',text);
  updateNoteCount();
  updateNoteDot();
}
function updateNoteCount(){
  const len=document.getElementById('notepadText').value.length;
  document.getElementById('notepadCount').textContent=len+' character'+(len!==1?'s':'');
}
function updateNoteDot(){
  const has=document.getElementById('notepadText').value.trim().length>0;
  document.getElementById('notepadDot').classList.toggle('has-notes',has);
}
function clearNotes(){
  if(!confirm('Clear all notes? This cannot be undone.'))return;
  document.getElementById('notepadText').value='';
  localStorage.removeItem('dd_notes');
  updateNoteCount();
  updateNoteDot();
}
// Load dot state on init
document.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem('dd_notes'))document.getElementById('notepadDot').classList.add('has-notes');
  restoreConsoleBg();
  try{_installInteractionDelegates();}catch(e){}
});

function showLogout(){
  playConfirmPrompt();
  const box=document.getElementById('logoutBoxContent');
  if(isAdmin){
    box.innerHTML=`<h3>⚠ Confirm Logout</h3><p>You will be logged out of the admin console. Continue?</p><div style="display:flex;gap:12px;justify-content:center"><button class="btn-standard btn-ghost" onclick="hideLogout()">Cancel</button><button class="btn-standard btn-red" onclick="doLogout()">Logout</button></div>`;
  }else{
    const mode=regSettings.participantMode;
    const idLabel=mode==='individual'?'your ID':'your Team ID';
    const idValue=currentVaultTeam?currentVaultTeam.id:'';
    box.innerHTML=`<h3>⚠ Confirm Logout</h3><p>You'll need ${idLabel} to re-enter. Make sure you have it saved.</p>${idValue?`<div style="text-align:center;margin:12px 0;padding:10px;background:rgba(0,255,136,.04);border:1px solid rgba(0,255,136,.12);border-radius:4px"><div style="font-family:Saira,sans-serif;font-size:8px;color:#888;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px">${idLabel}</div><div style="font-family:Oxanium,sans-serif;font-size:18px;font-weight:700;color:var(--green);letter-spacing:3px">${idValue}</div></div>`:''}<div style="display:flex;gap:12px;justify-content:center"><button class="btn-standard btn-ghost" onclick="hideLogout()">Cancel</button><button class="btn-standard btn-red" onclick="doLogout()">Logout</button></div>`;
  }
  document.getElementById('logoutModal').classList.add('active');
}
function hideLogout(){document.getElementById('logoutModal').classList.remove('active')}
function doLogout(){
  hideLogout();
  // Clear session but preserve team-specific game state (isSubmitted, vault, drafts)
  try{localStorage.removeItem('cb_session');sessionStorage.removeItem('cb_session')}catch(e){}
  notepadOpen=false;document.getElementById('notepadPanel').classList.remove('open');
  document.getElementById('notepadTrigger').classList.remove('visible');
  if(elapsedInterval){clearInterval(elapsedInterval);elapsedInterval=null}
  elapsedSec=0;currentVaultTeam=null;
  isSubmitted=false;
  vkFailCount=0;vkTotalFails=0;vkRateLimited=false;vkCode='';
  _vaultLockoutEnd=null;_sessionStartTime=null;
  // Stop broadcast polling
  if(_broadcastPollInterval){clearInterval(_broadcastPollInterval);_broadcastPollInterval=null}
  // Clear admin state on logout
  if(isAdmin){isAdmin=false;document.body.classList.remove('admin-mode');closeAdminDropdown()}
  showScreen('landingScreen');
}

let audioCtx;
function getAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
// #7 Soft Beep Tap — vault keypad presses
function playClick(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=1400;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.06,t+.008);
  g.gain.exponentialRampToValueAtTime(.001,t+.08);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.08);
}
// #8 Snap Click — grid tile clicks
function playTileClick(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.value=3000;
  o.frequency.exponentialRampToValueAtTime(500,t+.02);
  g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.03);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.04);
}
// #36 Radar Blip — incoming updates / notifications
function playAlert(){
  const c=getAudio(),t=c.currentTime;
  const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=2600;
  o.frequency.exponentialRampToValueAtTime(2200,t+.08);
  g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);
  o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.25);
}
// #20 Hydraulic Slide — confirm prompts (submit intel, logout)
function playConfirmPrompt(){
  const c=getAudio(),t=c.currentTime;
  const buf=c.createBuffer(1,c.sampleRate*.25,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
  const s=c.createBufferSource(),hp=c.createBiquadFilter(),ng=c.createGain();
  s.buffer=buf;hp.type='highpass';hp.frequency.value=3000;
  ng.gain.setValueAtTime(.12,t);ng.gain.exponentialRampToValueAtTime(.001,t+.25);
  s.connect(hp);hp.connect(ng);ng.connect(c.destination);s.start(t);
  setTimeout(()=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=80;
  g.gain.setValueAtTime(.15,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.2);
  o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+.2)},150);
}
function playSuccess(){
  const c=getAudio(),now=c.currentTime;
  // Sub thud - felt more than heard
  const sub=c.createOscillator(),sg=c.createGain();
  sub.connect(sg);sg.connect(c.destination);sub.type='sine';
  sub.frequency.setValueAtTime(60,now);
  sg.gain.setValueAtTime(.15,now);sg.gain.exponentialRampToValueAtTime(.001,now+.3);
  sub.start(now);sub.stop(now+.3);
  // 3-tone ascending chord: C5 E5 G5
  [523,659,784].forEach((f,i)=>{
    const o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);o.type='sine';
    const t=now+i*.09;
    o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.07,t+.015);
    g.gain.setValueAtTime(.07,t+.15);g.gain.exponentialRampToValueAtTime(.001,t+.5);
    o.start(t);o.stop(t+.5);
  });
  // High shimmer - breathy top end
  const buf=c.createBuffer(1,c.sampleRate*.4,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*.02*Math.pow(1-t,2)}
  const sh=c.createBufferSource();sh.buffer=buf;
  const hp=c.createBiquadFilter();hp.type='highpass';hp.frequency.value=6000;
  const shg=c.createGain();shg.gain.setValueAtTime(.3,now);shg.gain.exponentialRampToValueAtTime(.001,now+.4);
  sh.connect(hp);hp.connect(shg);shg.connect(c.destination);sh.start(now+.05);
  // Final confirmation ping
  const ping=c.createOscillator(),pg=c.createGain();
  ping.connect(pg);pg.connect(c.destination);ping.type='sine';
  ping.frequency.setValueAtTime(1047,now+.3);
  pg.gain.setValueAtTime(0,now+.3);pg.gain.linearRampToValueAtTime(.06,now+.31);
  pg.gain.exponentialRampToValueAtTime(.001,now+.8);
  ping.start(now+.3);ping.stop(now+.8);
}
function playDenied(){const c=getAudio();[0,.15].forEach(off=>{const t=c.currentTime+off,buf=c.createBuffer(1,c.sampleRate*.1,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++){const s=i/c.sampleRate;d[i]=((Math.sin(s*100*Math.PI*2)>0?1:-1)*.12+(Math.random()*2-1)*.04)*(1-i/d.length)}const src=c.createBufferSource();src.buffer=buf;const lp=c.createBiquadFilter();lp.type='lowpass';lp.frequency.value=400;const g=c.createGain();g.gain.setValueAtTime(.5,t);src.connect(lp);lp.connect(g);g.connect(c.destination);src.start(t)})}
function playVaultUnlock(){
  const c=getAudio(),now=c.currentTime;
  // Deep mechanical "clunk" — bolt unlocking
  const clunk=c.createBuffer(1,c.sampleRate*.15,c.sampleRate),cd=clunk.getChannelData(0);
  for(let i=0;i<cd.length;i++){const t=i/cd.length;cd[i]=(Math.random()*2-1)*.6*Math.pow(1-t,3)*Math.sin(t*80)}
  const cs=c.createBufferSource();cs.buffer=clunk;
  const cf=c.createBiquadFilter();cf.type='lowpass';cf.frequency.value=300;
  const cg=c.createGain();cg.gain.setValueAtTime(.6,now);
  cs.connect(cf);cf.connect(cg);cg.connect(c.destination);cs.start(now);
  // Rising shimmer — vault opening
  const riseLen=c.sampleRate*.6,rise=c.createBuffer(1,riseLen,c.sampleRate),rd=rise.getChannelData(0);
  for(let i=0;i<riseLen;i++){const t=i/riseLen;rd[i]=(Math.sin(t*t*4000)+Math.sin(t*t*6000)*.5)*.03*Math.sin(t*Math.PI)}
  const rs=c.createBufferSource();rs.buffer=rise;
  const rg=c.createGain();rg.gain.setValueAtTime(.4,now+.1);
  rs.connect(rg);rg.connect(c.destination);rs.start(now+.1);
  // Satisfying chord: C4 E4 G4 C5 — major resolved
  [262,330,392,523].forEach((f,i)=>{
    const o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);o.type='sine';
    const t=now+.15+i*.06;
    o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.06,t+.02);
    g.gain.setValueAtTime(.06,t+.3);g.gain.exponentialRampToValueAtTime(.001,t+.8);
    o.start(t);o.stop(t+.8);
  });
  // High sparkle at the end
  const sp=c.createOscillator(),sg=c.createGain();
  sp.connect(sg);sg.connect(c.destination);sp.type='sine';
  sp.frequency.setValueAtTime(1568,now+.5);sp.frequency.exponentialRampToValueAtTime(2093,now+.7);
  sg.gain.setValueAtTime(0,now+.5);sg.gain.linearRampToValueAtTime(.04,now+.52);
  sg.gain.exponentialRampToValueAtTime(.001,now+1);
  sp.start(now+.5);sp.stop(now+1);
}
function playPanelOpen(){
  // Soft tactile thud + subtle hi freq air
  const c=getAudio();
  const buf=c.createBuffer(1,c.sampleRate*.04,c.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*.15*Math.pow(1-t,3)}
  const s=c.createBufferSource();s.buffer=buf;
  const lp=c.createBiquadFilter();lp.type='lowpass';lp.frequency.value=800;
  const g=c.createGain();g.gain.setValueAtTime(.5,c.currentTime);
  s.connect(lp);lp.connect(g);g.connect(c.destination);s.start(c.currentTime);
  // Tiny high click
  const o=c.createOscillator(),g2=c.createGain();
  o.connect(g2);g2.connect(c.destination);o.type='sine';
  o.frequency.setValueAtTime(2400,c.currentTime);
  g2.gain.setValueAtTime(.03,c.currentTime);g2.gain.exponentialRampToValueAtTime(.001,c.currentTime+.03);
  o.start(c.currentTime);o.stop(c.currentTime+.03);
}

// ══════ GRAIN + DUST ══════
const gc=document.getElementById('grainCanvas'),gx=gc.getContext('2d');
const GRAIN_SCALE=4; // render at 1/4 resolution
function rg(){gc.width=Math.ceil(innerWidth/GRAIN_SCALE);gc.height=Math.ceil(innerHeight/GRAIN_SCALE);gc.style.width=innerWidth+'px';gc.style.height=innerHeight+'px';gx.imageSmoothingEnabled=false}
let lastGrain=0;
function dg(t){requestAnimationFrame(dg);if(t-lastGrain<125)return;lastGrain=t;const w=gc.width,h=gc.height;if(!w||!h)return;const id=gx.createImageData(w,h),d=id.data;for(let i=0;i<d.length;i+=4){const v=Math.random()*255;d[i]=d[i+1]=d[i+2]=v;d[i+3]=8}gx.putImageData(id,0,0)}
rg();let resizeTimer;addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(rg,200)});requestAnimationFrame(dg);
for(let i=0;i<5;i++){const p=document.createElement('div');p.className='dust';p.style.left=Math.random()*100+'vw';p.style.animationDuration=(12+Math.random()*16)+'s';p.style.animationDelay=(Math.random()*12)+'s';const s=1+Math.random()*1.5;p.style.width=s+'px';p.style.height=s+'px';document.body.appendChild(p)}

// ══════ LOGIN SCREEN ══════
let manualVaultKeys=[];
let currentVaultTeam=null;

function setLoginLed(state){
  const led=document.getElementById('loginLed');
  if(!led)return;
  led.className='login-led'+(state?' '+state:'');
}
function setLoginStatus(text,cls){
  const el=document.getElementById('loginCrtStatus');
  if(!el)return;
  el.className='login-crt-status'+(cls?' '+cls:'');
  el.innerHTML=text;
  const div=document.getElementById('loginCrtDivider');
  if(div)div.style.display=text?'':'none';
}
function loginBack(){
  const pwZone=document.getElementById('loginCrtPwZone');
  // If password zone is visible, go back to ID-only state
  if(pwZone&&pwZone.style.display!=='none'){
    pwZone.style.display='none';
    document.getElementById('loginPw').value='';
    setLoginStatus('');
    setLoginLed(document.getElementById('loginId').value.trim()?'active':'');
    return;
  }
  // Otherwise go back to landing
  showScreen('landingScreen');
}
function submitLogin(){
  // Clear any stale admin session to prevent expired tokens from contaminating login
  adminSession=null;
  // PREVIEW MODE INTERCEPTION
  if(document.body.classList.contains('landing-preview-mode')){
    const btn=document.getElementById('loginSubmitBtn');
    setLoginLed('active');
    setLoginStatus('<span class="login-crt-spinner"></span>AUTHENTICATING...','authenticating');
    btn.style.opacity='.4';btn.style.pointerEvents='none';
    setTimeout(()=>{
      setLoginLed('granted');
      setLoginStatus('ACCESS GRANTED','granted');
      playSuccess();
    },1500);
    setTimeout(()=>{resetLoginScreen()},3500);
    return;
  }
  const idVal=document.getElementById('loginId').value.trim();
  if(!idVal){setLoginStatus(getLoginPrompt(),'denied');setTimeout(()=>setLoginStatus(getLoginPrompt(),''),2000);return}
  const pwZone=document.getElementById('loginCrtPwZone');
  const btn=document.getElementById('loginSubmitBtn');
  setLoginLed('active');
  setLoginStatus('<span class="login-crt-spinner"></span>AUTHENTICATING...','authenticating');
  btn.style.opacity='.4';btn.style.pointerEvents='none';
  // Admin password phase
  if(pwZone.style.display!=='none'){
    const pw=document.getElementById('loginPw').value;
    if(!pw){setLoginStatus('ENTER PASSWORD','denied');setTimeout(()=>setLoginStatus('ENTER PASSWORD',''),1500);btn.style.opacity='';btn.style.pointerEvents='';return}
    apiCall('login',{username:idVal,password:pw}).then(result=>{
      if(result.ok){
        adminSession={username:result.username,role:result.role,adminToken:result.adminToken};
        isAdmin=true;document.body.classList.add('admin-mode');
        currentVaultTeam={id:'ADMIN',name:'ADMIN',displayName:'ADMINISTRATOR',type:'admin',members:['Admin'],memberDetails:[]};
        updateConsoleForTeam(currentVaultTeam);syncAdminDropdownToggles();saveSession();
        loginSuccess();loadEventData();startTeamMonitor();document.dispatchEvent(new Event('adminReady'));
      }else{
        setLoginLed('denied');setLoginStatus('ACCESS DENIED — AUTH FAILED','denied');
        btn.style.opacity='';btn.style.pointerEvents='';
        playDenied();document.getElementById('flashR').classList.add('on');
        setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
        setTimeout(()=>{setLoginLed('active');setLoginStatus('ENTER PASSWORD','')},2000);
      }
    });
    return;
  }
  // First entry — try as Team ID
  apiCall('loginTeam',{teamId:idVal}).then(result=>{
    if(result.ok){
      const t=result;
      currentVaultTeam={id:t.teamId,name:t.teamName,type:t.type,
        members:(t.members||[]).map(m=>typeof m==='string'?m:m.name),
        memberDetails:t.members||[],lastActive:Date.now(),fieldsCompleted:0,
        submitTime:null,registeredAt:t.registeredAt,submissionResults:null};
      if(!registeredTeams.find(r=>r.id===t.teamId)){registeredTeams.push(currentVaultTeam)}
      updateConsoleForTeam(currentVaultTeam);saveSession();loginSuccess();startBroadcastPolling();startActivityTracker();
      apiCall('getEventConfig').then(cfg=>{
        if(cfg.ok&&cfg.config)applyEventConfig(cfg.config);
        // Load drafts from backend after intel fields are rendered
        loadDraftsFromBackend();
      });
    }else{
      apiCall('validateUsername',{username:idVal}).then(vResult=>{
        if(vResult.ok&&vResult.found){
          pwZone.style.display='';document.getElementById('loginPw').focus();
          setLoginStatus('ENTER PASSWORD','');setLoginLed('active');
          btn.style.opacity='';btn.style.pointerEvents='';
        }else{
          setLoginLed('denied');setLoginStatus('ACCESS DENIED — INVALID ID','denied');
          btn.style.opacity='';btn.style.pointerEvents='';
          playDenied();document.getElementById('flashR').classList.add('on');
          setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
          setTimeout(()=>{setLoginLed('');setLoginStatus('')},2000);
        }
      });
    }
  });
}
function loginSuccess(){
  playSuccess();if(isAdmin)unlockAdminConsole();
  setLoginLed('granted');setLoginStatus('ACCESS GRANTED','granted');
  document.getElementById('flashG').classList.add('on');
  setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
  const btn=document.getElementById('loginSubmitBtn');
  btn.style.opacity='.4';btn.style.pointerEvents='none';
  setTimeout(()=>openVault(),800);
}
function getLoginPrompt(){
  const mode=regSettings.participantMode||'team';
  return mode==='individual'?'ENTER YOUR PLAYER ID':mode==='hybrid'?'ENTER YOUR ID':'ENTER YOUR TEAM ID';
}
function resetLoginScreen(){
  document.getElementById('loginId').value='';document.getElementById('loginPw').value='';
  document.getElementById('loginCrtPwZone').style.display='none';
  const btn=document.getElementById('loginSubmitBtn');
  btn.style.opacity='';btn.style.pointerEvents='';
  setLoginLed('');
  // Dynamic prompt based on participant mode
  setLoginStatus(getLoginPrompt(),'');
}
// Enter key support on login fields
document.getElementById('loginId')?.addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin()});
document.getElementById('loginPw')?.addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin()});
// LED flashes on input activity
document.getElementById('loginId')?.addEventListener('input',function(){
  const pwZone=document.getElementById('loginCrtPwZone');
  if(pwZone&&pwZone.style.display!=='none'){
    pwZone.style.display='none';
    setLoginStatus('');
  }
  if(this.value.trim()){
    setLoginLed('active');setLoginStatus('');
  }else{
    setLoginLed('');
    setLoginStatus(getLoginPrompt(),'');
  }
});
document.getElementById('loginPw')?.addEventListener('input',function(){
  setLoginLed(this.value.trim()||document.getElementById('loginId').value.trim()?'active':'');
});

function updateConsoleForTeam(team){
  const teamEl=document.querySelector('.console-team');
  if(teamEl){
    const typeIcon=team.type==='individual'?'👤 ':'';
    teamEl.childNodes[0].textContent=typeIcon+team.name.toUpperCase()+' ';
  }
  const cardName=document.querySelector('.team-card-name');
  const cardId=document.querySelector('.team-card-id');
  if(cardName)cardName.textContent=team.displayName||team.name;
  if(cardId)cardId.textContent='ID: '+team.id;
  const membersHtml=team.members.map((m,i)=>`<div class="team-card-member"><div class="team-card-avatar">${i+1}</div><span class="team-card-mname">${m}</span></div>`).join('');
  const memberSection=document.querySelector('.team-card-section');
  if(memberSection){
    const label=memberSection.querySelector('.team-card-label');
    memberSection.innerHTML='';
    if(label)memberSection.appendChild(label);
    memberSection.insertAdjacentHTML('beforeend',membersHtml);
  }
}
function openVault(){const ov=document.getElementById('vaultOpenOverlay');ov.classList.add('active');setTimeout(()=>document.getElementById('voText').classList.add('show'),300);setTimeout(()=>document.getElementById('voSub').classList.add('show'),300);setTimeout(()=>{document.getElementById('voBar').classList.add('show');document.getElementById('voPct').classList.add('show')},300);setTimeout(()=>{document.getElementById('voFill').classList.add('go');let pct=0;const pctEl=document.getElementById('voPct');const pctInt=setInterval(()=>{pct=Math.min(100,pct+Math.ceil(Math.random()*4+1));pctEl.textContent=pct+'%';if(pct>=100)clearInterval(pctInt)},50)},1200);setTimeout(()=>{showScreen('consoleScreen');document.getElementById('notepadTrigger').classList.add('visible');startElapsedTimer();ov.classList.remove('active');document.getElementById('voText').classList.remove('show');document.getElementById('voSub').classList.remove('show');document.getElementById('voBar').classList.remove('show');document.getElementById('voFill').classList.remove('go');document.getElementById('voPct').classList.remove('show');document.getElementById('voPct').textContent='0%';setTimeout(()=>{if(shouldShowTutorial()){startTutorial()}else{checkShowBriefing()}},500)},3800)}

// ══════ VAULT PUZZLE (in-console keypad) ══════
let vaultCodes=[];
// vaultCodes is now synced FROM media items that have vaultLocked:true + vaultCode set.
// Call syncVaultCodesFromMedia() after any media change.
function syncVaultCodesFromMedia(){
  // Preserve unlock state by code
  const unlockedMap={};
  vaultCodes.forEach(c=>{if(c.unlocked)unlockedMap[c.code.toUpperCase()]=c.unlockedAt});
  vaultCodes.length=0;
  mediaItems.forEach((m,i)=>{
    if(m.vaultLocked&&m.vaultCode&&m.vaultCode.trim()){
      const codeUp=m.vaultCode.trim().toUpperCase();
      vaultCodes.push({
        code:codeUp,
        label:m.name||'Locked Item',
        desc:m.desc||'',
        codename:m.vaultCodename||m.name||'FILE-'+String(i+1).padStart(3,'0'),
        unlocked:unlockedMap[codeUp]?true:false,
        unlockedAt:unlockedMap[codeUp]||null,
        linkedMediaIdx:i
      });
    }
  });
}
let vkCode='';let vkFailCount=0;let vkTotalFails=0;let vkRateLimited=false;
let _vaultLockoutEnd=null;
let _sessionStartTime=null;
const vkDisp=document.getElementById('vDisp');
function vkUpdDisp(){if(vkDisp){vkDisp.textContent=vkCode.length?vkCode:'ENTER CODE';vkDisp.style.color='';vkDisp.style.fontSize='';vkDisp.style.letterSpacing=''}const triesEl=document.getElementById('vkTries');if(triesEl)triesEl.style.visibility=vkCode.length?'hidden':'visible'}
function vkType(ch){playClick();if(vkRateLimited)return;if(vkCode.length<20){vkCode+=ch;vkUpdDisp();vkGlitch()}}
function vkDel(){playClick();if(vkRateLimited)return;vkCode=vkCode.slice(0,-1);vkUpdDisp();vkGlitch()}
function vkClear(){playClick();if(vkRateLimited)return;vkCode='';vkUpdDisp();vkGlitch()}
function vkGlitch(){const d=document.querySelector('#expVault .v-display');if(!d)return;d.classList.remove('glitch');void d.offsetWidth;d.classList.add('glitch');setTimeout(()=>d.classList.remove('glitch'),150)}
function vkSubmit(){
  if(vkRateLimited||!vkCode.length)return;
  const entered=vkCode.trim().toUpperCase();
  const match=vaultCodes.find(c=>c.code.toUpperCase()===entered&&!c.unlocked);
  if(match){
    match.unlocked=true;match.unlockedAt=new Date().toISOString();
    let releasedName='Classified File';
    if(match.linkedMediaIdx!==null&&match.linkedMediaIdx!==undefined&&mediaItems[match.linkedMediaIdx]){
      mediaItems[match.linkedMediaIdx]._isNew=true;
      // NOTE: Do not mutate vaultLocked here; unlock visibility is team-scoped via vaultCodes + localStorage.
      releasedName=mediaItems[match.linkedMediaIdx].name||match.label;
    }
    playVaultUnlock();
    vkDisp.textContent='✓ UNLOCKED';vkDisp.style.color='#00ff88';vkDisp.style.fontSize='13px';vkDisp.style.letterSpacing='2px';
    document.getElementById('flashG').classList.add('on');
    setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
    vkFailCount=0;vkTotalFails=0;
    updateTriesDisplay();
    // Show unlock notification to player
    showVaultUnlockNotification(releasedName);
    setTimeout(()=>{vkCode='';vkUpdDisp();renderVaultPanel()},2000);
    renderGrid();renderMedia();
    saveGameState();
  }else if(vaultCodes.find(c=>c.code.toUpperCase()===entered&&c.unlocked)){
    vkDisp.textContent='⚡ ALREADY UNLOCKED';vkDisp.style.color='var(--amber)';vkDisp.style.fontSize='13px';
    playClick();
    setTimeout(()=>{vkCode='';vkUpdDisp()},1500);
  }else{
    vkFailCount++;vkTotalFails++;
    playDenied();vkDisp.textContent='✗ INVALID CODE';vkDisp.style.color='#ff3333';
    document.getElementById('flashR').classList.add('on');setTimeout(()=>document.getElementById('flashR').classList.remove('on'),300);
    const maxAttempts=regSettings.vaultMaxAttempts||5;
    const cooldown=regSettings.vaultCooldownSec||30;
    const unlimited=regSettings.vaultUnlimitedAttempts;
    updateTriesDisplay();
    saveGameState();
    if(unlimited){
      setTimeout(()=>{vkCode='';vkUpdDisp()},1200);
    }else{
      const remaining=maxAttempts-vkTotalFails;
      if(remaining<=0){
        triggerVaultLockout(cooldown,'SECURITY LOCKOUT','Maximum attempts reached · '+cooldown+'s cooldown');
      }else{
        setTimeout(()=>{vkCode='';vkUpdDisp()},1200);
      }
    }
  }
}
function showVaultUnlockNotification(fileName){
  // Create a toast notification for vault unlock
  let toast=document.getElementById('vaultUnlockToast');
  if(!toast){
    toast=document.createElement('div');
    toast.id='vaultUnlockToast';
    toast.style.cssText='position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(80px);z-index:999;padding:14px 24px;border-radius:6px;border:1px solid rgba(0,255,136,.3);background:linear-gradient(180deg,rgba(10,20,15,.95),rgba(5,15,10,.98));backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 20px rgba(0,255,136,.1);transition:transform .4s ease,opacity .4s ease;opacity:0;max-width:90vw;text-align:center';
    document.body.appendChild(toast);
  }
  toast.innerHTML=`<div style="font-family:'Saira',sans-serif;font-size:10px;letter-spacing:3px;color:var(--green);font-weight:700;margin-bottom:4px">🔓 CLASSIFIED FILE RELEASED</div><div style="font-family:'Exo 2',sans-serif;font-size:12px;color:#ccc"><strong>${fileName}</strong> is now available in the Evidence Locker</div>`;
  requestAnimationFrame(()=>{toast.style.opacity='1';toast.style.transform='translateX(-50%) translateY(0)'});
  setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateX(-50%) translateY(80px)'},4500);
}
function updateTriesDisplay(){
  const el=document.getElementById('vkTries');
  if(!el)return;
  const unlimited=regSettings.vaultUnlimitedAttempts;
  if(unlimited){el.textContent='';el.className='v-tries';return}
  const max=regSettings.vaultMaxAttempts||5;
  const remaining=Math.max(0,max-vkTotalFails);
  el.textContent=remaining+' OF '+max+' ATTEMPT'+(remaining!==1?'S':'')+' REMAINING';
  // Progressive colour: green → amber → red
  if(remaining<=1)el.className='v-tries critical';
  else if(remaining<=3)el.className='v-tries warning';
  else el.className='v-tries plenty';
}
function triggerVaultLockout(seconds,title,subtitle){
  vkRateLimited=true;
  // Store absolute end time so cooldown survives browser close
  if(!_vaultLockoutEnd||_vaultLockoutEnd<Date.now()){
    _vaultLockoutEnd=Date.now()+seconds*1000;
  }
  saveGameState();
  const limiter=document.getElementById('vRateLimit');
  const timerEl=document.getElementById('vRateLimitTimer');
  const textEl=document.getElementById('vRateLimitText');
  const subEl=document.getElementById('vRateLimitSub');
  const fillEl=document.getElementById('vRateLimitFill');
  textEl.textContent='⚠ '+title;
  subEl.textContent=subtitle;
  let countdown=seconds;
  const total=seconds;
  timerEl.textContent=formatLockoutTime(countdown);
  if(fillEl)fillEl.style.width='100%';
  limiter.classList.add('active');
  const interval=setInterval(()=>{
    countdown--;
    timerEl.textContent=formatLockoutTime(countdown);
    if(fillEl)fillEl.style.width=((countdown/total)*100)+'%';
    if(countdown<=0){
      clearInterval(interval);
      limiter.classList.remove('active');
      vkRateLimited=false;
      vkFailCount=0;vkTotalFails=0;
      vkCode='';vkUpdDisp();
      updateTriesDisplay();
      _vaultLockoutEnd=null;
      saveGameState();
    }
  },1000);
}

function formatLockoutTime(s){
  if(s>=60){const m=Math.floor(s/60);const sec=s%60;return m+':'+String(sec).padStart(2,'0')}
  return String(s);
}
function renderVaultPanel(){
  const list=document.getElementById('vaultUnlockList');
  const count=document.getElementById('vaultUnlockCount');
  if(!list)return;
  const unlocked=vaultCodes.filter(c=>c.unlocked).length;
  if(count){
    if(vaultCodes.length===0){count.textContent='EMPTY';}
    else if(unlocked===0){count.textContent=vaultCodes.length+' LOCKED ITEM'+(vaultCodes.length===1?'':'S');}
    else{count.textContent=unlocked+' OF '+vaultCodes.length+' ITEM'+(vaultCodes.length===1?'':'S')+' UNLOCKED';}
  }
  const dot=document.getElementById('vkDot');
  const lbl=document.getElementById('vkLbl');
  if(dot&&lbl){
    const statusEl=document.getElementById('vkStatus');
    if(unlocked===vaultCodes.length&&vaultCodes.length>0){if(statusEl)statusEl.style.display='';dot.classList.add('ok');lbl.classList.add('ok');lbl.textContent='ALL UNLOCKED'}
    else if(unlocked>0){if(statusEl)statusEl.style.display='';dot.className='v-dot';dot.style.background='radial-gradient(circle at 40% 35%,#ffcc44,#cc8811)';dot.style.boxShadow='0 0 6px rgba(255,170,51,.5)';lbl.textContent=unlocked+' UNLOCKED'}
    else{if(statusEl)statusEl.style.display='none'}
  }
  if(vaultCodes.length===0){
    list.innerHTML='<div class="vault-unlock-empty">No vault codes configured yet. The admin can add codes in the Keys & Codes panel.</div>';
    return;
  }
  const isAdmin=document.body.classList.contains('admin-mode');
  list.innerHTML=vaultCodes.map((c,i)=>{
    if(c.unlocked){
      let viewLink='';
      if(c.linkedMediaIdx!==null&&c.linkedMediaIdx!==undefined){
        viewLink=`<div class="vui-media-link" onclick="event.stopPropagation();closePanel();setTimeout(()=>{openPanel('media');setTimeout(()=>openMediaViewer(${c.linkedMediaIdx}),300)},350)">▸ View in Evidence Locker</div>`;
      }
      return `<div class="vault-unlock-item">
        <span class="vui-icon">🔓</span>
        <div class="vui-info"><div class="vui-label">${c.label}</div><div class="vui-desc">${c.desc||'Unlocked'}</div>${viewLink}</div>
        <span class="vui-status unlocked">UNLOCKED</span>
      </div>`;
    }else{
      const codename=c.codename||'FILE-'+String(i+1).padStart(3,'0');
      return `<div class="vault-unlock-item locked">
        <span class="vui-icon">🔒</span>
        <div class="vui-info"><div class="vui-label vui-classified">${codename}</div><div class="vui-desc vui-classified-sub">CLASSIFIED · Enter the correct code to unlock</div>${isAdmin?`<div class="vui-admin-hint">Admin: code = ${c.code}</div>`:''}</div>
        <span class="vui-status locked">LOCKED</span>
      </div>`;
    }
  }).join('');
  updateTriesDisplay();
}
let vkSymMode=false;
function vkToggleSymbols(){
  vkSymMode=!vkSymMode;
  document.getElementById('vkSymLabel').textContent=vkSymMode?'ABC':'SYM';
  const rows=vkSymMode?symRows:alphaRows;
  document.querySelectorAll('#expVault .kb-row').forEach((row,ri)=>{
    if(ri===0)return;
    if(ri>=1&&ri<=3){
      const chars=rows[ri-1];if(!chars)return;
      const keys=row.querySelectorAll('.kb-key:not(.fn)');
      keys.forEach((key,ki)=>{
        if(ki<chars.length){key.style.display='';key.querySelector('span').textContent=chars[ki];key.onclick=()=>vkType(chars[ki])}
        else key.style.display='none';
      });
    }
  });
  playClick();
}

// ══════ FONTS ══════
const availableFonts=[
  // Military / Industrial
  {name:'Russo One',family:"'Russo One',sans-serif"},
  {name:'Black Ops One',family:"'Black Ops One',sans-serif"},
  {name:'Quantico',family:"'Quantico',sans-serif"},
  {name:'Aldrich',family:"'Aldrich',sans-serif"},
  {name:'Staatliches',family:"'Staatliches',cursive"},
  // Sci-Fi / Tech
  {name:'Orbitron',family:"'Orbitron',sans-serif"},
  {name:'Oxanium',family:"'Oxanium',sans-serif"},
  {name:'Audiowide',family:"'Audiowide',sans-serif"},
  {name:'Electrolize',family:"'Electrolize',sans-serif"},
  {name:'Michroma',family:"'Michroma',sans-serif"},
  {name:'Chakra Petch',family:"'Chakra Petch',sans-serif"},
  // Clean / UI
  {name:'Saira',family:"'Saira',sans-serif"},
  {name:'Exo 2',family:"'Exo 2',sans-serif"},
  {name:'Play',family:"'Play',sans-serif"},
  {name:'Rajdhani',family:"'Rajdhani',sans-serif"},
  {name:'Teko',family:"'Teko',sans-serif"},
  // Monospace / Terminal
  {name:'IBM Plex Mono',family:"'IBM Plex Mono',monospace"},
  {name:'JetBrains Mono',family:"'JetBrains Mono',monospace"},
  {name:'Share Tech Mono',family:"'Share Tech Mono',monospace"},
  {name:'Nova Mono',family:"'Nova Mono',monospace"},
  {name:'Major Mono Display',family:"'Major Mono Display',monospace"},
  // Retro / Pixel
  {name:'Press Start 2P',family:"'Press Start 2P',monospace"},
  {name:'VT323',family:"'VT323',monospace"},
  {name:'Silkscreen',family:"'Silkscreen',sans-serif"},
];
function fontSelect(id,current){
  const groups=[
    {label:'— Military / Industrial —',fonts:['Russo One','Black Ops One','Quantico','Aldrich','Staatliches']},
    {label:'— Sci-Fi / Tech —',fonts:['Orbitron','Oxanium','Audiowide','Electrolize','Michroma','Chakra Petch']},
    {label:'— Clean / UI —',fonts:['Saira','Exo 2','Play','Rajdhani','Teko']},
    {label:'— Monospace / Terminal —',fonts:['IBM Plex Mono','JetBrains Mono','Share Tech Mono','Nova Mono','Major Mono Display']},
    {label:'— Retro / Pixel —',fonts:['Press Start 2P','VT323','Silkscreen']},
  ];
  let html=`<select id="${id}" style="font-size:11px"><option value=""${!current?' selected':''}>Default</option>`;
  groups.forEach(g=>{
    html+=`<optgroup label="${g.label}">`;
    g.fonts.forEach(fn=>{
      const f=availableFonts.find(x=>x.name===fn);
      if(f)html+=`<option value="${f.name}"${f.name===current?' selected':''} style="font-family:${f.family}">${f.name}</option>`;
    });
    html+=`</optgroup>`;
  });
  html+=`</select>`;
  return html;
}
function getFontFamily(name){const f=availableFonts.find(x=>x.name===name);return f?f.family:''}
function applyOperationFont(name){
  const fam=name?getFontFamily(name):'';
  const targets=['consoleTitle','loginTitle','landingTitleEl'];
  targets.forEach(id=>{const el=document.getElementById(id);if(el)el.style.fontFamily=fam});
  // Also update CSS variable so any future themed elements inherit it
  document.documentElement.style.setProperty('--op-font',fam||'inherit');
}
function fontStyle(name){return name?`font-family:${getFontFamily(name)}`:''}

// ══════ DATA ══════
let operationName='Operation Dead Drop';
let operationFont='Staatliches';

// ── Central Typography Config ──
// Global font overrides per content zone. Empty string = use default theme font.
let fontConfig={
  feedCap:'',        // Feed card captions + single post caption
  mediaName:'',      // Media item titles
  mediaDesc:'',      // Media item descriptions
  intelLabel:'',     // Intel field labels (overrides per-field font)
  intelInput:'',     // Intel field inputs (overrides per-field inputFont)
  vaultDisplay:''    // Vault keypad display + vault panel codenames
};

// Resolve: global fontConfig takes precedence over per-item font
function resolveFont(globalKey,perItemFont){
  const g=fontConfig[globalKey]||'';
  return g||perItemFont||'';
}
// vault subtitle removed — login screen uses loginTitle
let gridTiles=[
  {id:'feed',icon:'📡',label:'Intelligence Feed',labelFont:'',sub:'Surveillance imagery & intercepted visuals',subFont:'',badgeId:'feedBadge',dotClass:'silent',status:'SILENT'},
  {id:'media',icon:'🗂️',label:'Evidence Locker',labelFont:'',sub:'Collected assets, files & recovered media',subFont:'',badgeId:'mediaBadge',dotClass:'silent',status:'SILENT'},
  {id:'vault',icon:'🔐',label:'The Vault',labelFont:'',sub:'Enter solved codes to unlock items',subFont:'',badgeId:'vaultBadge',dotClass:'silent',status:'SILENT'},
  {id:'intel',icon:'🎯',label:'Intel Submissions',labelFont:'',sub:'Submit decoded intelligence',subFont:'',badgeId:'intelBadge',dotClass:'silent',status:'SILENT'}
];
// Activity tracking for tile pulse system
const tileActivity={feed:0,media:0,vault:0,intel:0};
const activityThresholds={activeToIdle:120,idleToSilent:600}; // seconds — active<2min, idle 2-10min, ghost>10min
const tileStateLabels={active:'ACTIVE',idle:'IDLE',silent:'SILENT'};
function getTileState(id){
  const last=tileActivity[id];
  if(!last)return'silent';
  const ago=(Date.now()-last)/1000;
  if(ago<activityThresholds.activeToIdle)return'active';
  if(ago<activityThresholds.idleToSilent)return'idle';
  return'silent';
}
function recordTileAccess(id){
  tileActivity[id]=Date.now();
  try{localStorage.setItem('cb_tile_activity',JSON.stringify(tileActivity));}catch(e){}
  updateTileStates();
}
// Restore persisted tile activity from localStorage on load
(function(){
  try{
    const saved=localStorage.getItem('cb_tile_activity');
    if(saved){const d=JSON.parse(saved);Object.keys(tileActivity).forEach(k=>{if(d[k])tileActivity[k]=d[k];});}
  }catch(e){}
  // Update dotClass immediately so renderGrid() below picks up correct states
  updateTileStates();
})();
function updateTileStates(){
  gridTiles.forEach(t=>{
    const state=getTileState(t.id);
    t.dotClass=state;
    t.status=tileStateLabels[state];
    // Update DOM directly if rendered
    const statusEl=document.querySelector(`[data-tile="${t.id}"] .tile-dot`);
    const labelEl=document.querySelector(`[data-tile="${t.id}"] .tile-status-label`);
    if(statusEl){statusEl.className='tile-dot '+state}
    if(labelEl){labelEl.className='tile-status-label '+state;labelEl.textContent=tileStateLabels[state]}
  });
}
// Periodic state decay check every 10 seconds
setInterval(updateTileStates,10000);
let intelFields=[
  {label:'Seller Codename',emoji:'🕵️',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Buyer Identity',emoji:'👤',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Staging Country',emoji:'🌍',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Comms Platform',emoji:'📱',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Smuggled Items',emoji:'📦',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Hideout Location',emoji:'📍',type:'text',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Payment Amount',emoji:'💰',type:'money',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Burner Phone #',emoji:'📞',type:'phone',font:'',answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}},
  {label:'Target Islands',emoji:'🏝️',type:'dual',font:'',placeholder1:'Island 1',placeholder2:'Island 2',answer:{expected:['',''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}}
];
const intelLabels=['Seller Codename','Buyer Identity','Staging Country','Comms Platform','Smuggled Items','Hideout Location','Payment Amount','Burner Phone #','Target Island 1','Target Island 2'];
let allowDownloads=false;
let feedMuted=true;
const postMuteState={}; // per-post mute memory: {postIndex: true/false}
function isPostMuted(idx){return postMuteState[idx]!==undefined?postMuteState[idx]:feedMuted}
let regSettings={
  teamSizeMin:2,
  teamSizeMax:4,
  maxTeams:20,
  requireEmail:true,
  requirePhone:false,
  requireDept:false,
  registrationOpen:true,
  participantMode:'team',
  leaderboardStyle:'mixed',
  landingBannerUrl:'',
  bannerFallback:'🔐',
  landingTitle:'Code Breakers',
  landingSubtitle:'Rise to The Challenge',
  vaultMaxAttempts:5,
  vaultCooldownSec:30,
  vaultUnlimitedAttempts:false,
  sessionPersist:true
};
let currentRegType='team'; // for hybrid mode tracking
let posts=[];
let mediaItems=[];

// ══════ RENDER ══════

function renderFeed(){
  if(posts.length)console.log('[FEED] renderFeed called. posts[last].mediaUrl:',posts[posts.length-1]?.mediaUrl?.substring(0,80),'trace:',new Error().stack?.split('\n')[2]?.trim());
  const grid=document.getElementById('feedGridView'),isA=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  if(!posts.length){
    grid.innerHTML=isA
      ?'<div style="grid-column:1/-1;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;opacity:.3">📡</div><div style="font-family:Chakra Petch,sans-serif;font-size:11px;color:#444;letter-spacing:1px;margin-bottom:16px">No intelligence feed items yet</div><div class="admin-add-btn" onclick="addFeedPost()">+ Add Post</div></div>'
      :'<div style="grid-column:1/-1;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;opacity:.3">📡</div><div style="font-family:Chakra Petch,sans-serif;font-size:11px;color:#333;letter-spacing:1px">No intelligence available yet</div></div>';
    document.getElementById('feedBadge').textContent=tileBadgeText('feed',isA);
    const fci=document.getElementById('feedCountIndicator');if(fci)fci.textContent='0 POSTS';
    return;
  }
  grid.innerHTML=posts.map((p,i)=>{
    const resolved=(p.mediaUrl&&(p.mediaType==='video'||isVideoUrl(p.mediaUrl)))?resolveVideoEmbed(p.mediaUrl):null;
    const isVid=resolved&&resolved.type==='direct';
    const isEmbeddable=resolved&&resolved.type!=='direct'&&resolved.type!=='external';
    const isExternal=resolved&&resolved.type==='external';
    const isImg=!resolved&&p.mediaUrl;
    let media='';
    if(isImg){
      const fp=`${p.focalX||50}% ${p.focalY||50}%`;
      media=`<div class="no-download-shield" oncontextmenu="return false"></div><img src="${p.mediaUrl}" style="width:100%;height:100%;object-fit:cover;object-position:${fp};pointer-events:none;-webkit-user-drag:none" draggable="false">`;
    } else if(isEmbeddable||isExternal){
      media=buildVideoThumbnail(resolved);
    } else if(isVid){
      media=`<video class="feed-card-thumb" src="${resolved.url}" muted preload="metadata" style="width:100%;height:100%;object-fit:cover;pointer-events:none"></video><div class="feed-video-play-icon" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">▶</div><div class="feed-video-badge">VIDEO</div>`;
    } else {
      media=`<span style="opacity:.5">${p.emoji}</span>`;
    }
    const bgStyle=!p.mediaUrl?`background:${p.bg};`:'';
    const _capFont=resolveFont('feedCap',p.capFont||'');
    return `<div class="feed-card" data-idx="${i}">${isA?`<div class="drag-handle" onpointerdown="startDrag(event,'feed',${i})" onclick="event.stopPropagation()">⋮⋮</div><div class="admin-edit-btn" onclick="event.stopPropagation();editFeedPost(${i})">✎</div>`:''}<div class="feed-card-img" style="${bgStyle}" oncontextmenu="return false">${media}</div><div class="feed-card-cap"><p style="${fontStyle(_capFont)}">${p.cap}</p></div></div>`;
  }).join('')+(isA?'<div class="admin-add-btn" onclick="addFeedPost()">+ Add Post</div>':'');
  document.getElementById('feedBadge').textContent=tileBadgeText('feed',isA);
  const fci=document.getElementById('feedCountIndicator');if(fci)fci.textContent=posts.length+(posts.length===1?' POST':' POSTS');
  // Seek video thumbnails to 1s to show a real frame instead of black
  setTimeout(()=>{grid.querySelectorAll('video.feed-card-thumb').forEach(v=>{v.currentTime=1})},100);
}
let _mediaSelectMode=false;
let _mediaSelected=new Set();
function enterMediaSelectMode(){_mediaSelectMode=true;_mediaSelected.clear();renderMedia();const bar=document.getElementById('mediaSelectBar');if(bar){bar.style.display='flex'}}
function exitMediaSelectMode(){_mediaSelectMode=false;_mediaSelected.clear();renderMedia();const bar=document.getElementById('mediaSelectBar');if(bar){bar.style.display='none'}}
function toggleMediaSelect(i){if(_mediaSelected.has(i))_mediaSelected.delete(i);else _mediaSelected.add(i);document.getElementById('mediaSelectCount').textContent=_mediaSelected.size+' selected';renderMedia()}
function selectAllMedia(){const isEdit=document.body.classList.contains('admin-mode');const showAll=isEdit;const visible=showAll?mediaItems:mediaItems.filter(m=>!m.vaultLocked);visible.forEach(m=>{const ri=mediaItems.indexOf(m);_mediaSelected.add(ri)});document.getElementById('mediaSelectCount').textContent=_mediaSelected.size+' selected';renderMedia()}
function deleteSelectedMedia(){if(!_mediaSelected.size)return;if(!confirm('Delete '+_mediaSelected.size+' selected item(s)?'))return;const idxs=Array.from(_mediaSelected).sort((a,b)=>b-a);idxs.forEach(i=>{const m=mediaItems[i];if(m&&m.fileUrl)deleteFromR2(m.fileUrl);mediaItems.splice(i,1)});exitMediaSelectMode();renderMedia();renderGrid();saveMediaItemsToBackend()}
function renderMedia(){
  const list=document.getElementById('mediaList');
  const isEdit=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  const isAdmin=document.body.classList.contains('admin-mode');
  const isPreview=document.body.classList.contains('player-preview');
  const showAll=isAdmin&&!isPreview;
  const visibleItems=showAll?mediaItems:mediaItems.filter(m=>!m.vaultLocked||vaultCodes.find(c=>c.linkedMediaIdx===mediaItems.indexOf(m)&&c.unlocked));
  // Search filter
  const searchVal=(document.getElementById('mediaSearchFilter')?.value||'').toLowerCase().trim();
  const filtered=searchVal?visibleItems.filter(m=>(m.name||'').toLowerCase().includes(searchVal)||(m.desc||'').toLowerCase().includes(searchVal)||(m.type||'').toLowerCase().includes(searchVal)):visibleItems;
  // Count indicator
  const mci=document.getElementById('mediaCountIndicator');
  if(mci){
    const base=filtered.length+(filtered.length===1?' ITEM':' ITEMS');
    if(searchVal){mci.textContent=filtered.length+' OF '+visibleItems.length+' ITEMS';}
    else{mci.textContent=base;}
  }
  const selectBtnHtml=isEdit&&!_mediaSelectMode&&filtered.length>0?`<div style="text-align:right;margin-bottom:8px"><button onclick="enterMediaSelectMode()" style="font-family:'Saira',sans-serif;font-size:10px;letter-spacing:1px;background:none;border:1px solid #333;border-radius:3px;padding:4px 12px;color:#666;cursor:pointer">☑ SELECT</button></div>`:'';
  list.innerHTML=selectBtnHtml+filtered.map((m,i)=>{
    const realIdx=mediaItems.indexOf(m);
    const isVL=m.vaultLocked&&showAll;
    const vlStyle=isVL?'position:relative;border-color:rgba(255,170,51,.2);':'';
    const lockedStyle=m.type==='locked'&&!m.unlocked?'opacity:.4;':'';
    const crosshatch=isVL?'<div class="media-vault-hatch"></div>':'';
    const badge=isVL?'🔐 vault-locked':m.type+(m.type==='locked'&&m.unlocked?' ✓':'');
    const isSelected=_mediaSelected.has(realIdx);
    const selStyle=_mediaSelectMode?(isSelected?'border-color:var(--red);background:rgba(255,51,51,.06);':''):'';
    const checkHtml=_mediaSelectMode?`<div onclick="event.stopPropagation();toggleMediaSelect(${realIdx})" style="position:absolute;top:8px;left:8px;width:18px;height:18px;border:2px solid ${isSelected?'var(--red)':'#444'};border-radius:3px;background:${isSelected?'rgba(255,51,51,.3)':'transparent'};display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;font-size:11px">${isSelected?'✓':''}</div>`:'';
    const clickHandler=_mediaSelectMode?`onclick="toggleMediaSelect(${realIdx})"`:(`onclick="openMediaViewer(${realIdx})"`);
    const _mNameFont=resolveFont('mediaName',m.nameFont||'');
    const _mDescFont=resolveFont('mediaDesc',m.descFont||'');
    // New item glow — items marked as _isNew
    const newGlow=m._isNew?'box-shadow:0 0 12px rgba(0,212,255,.25);border-color:rgba(0,212,255,.3);':'';
    const newBadge=m._isNew?'<span style="position:absolute;top:6px;right:40px;font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:1.5px;color:var(--cyan);background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.2);border-radius:2px;padding:1px 6px">NEW</span>':'';
    return `<div class="media-exp-item" data-idx="${realIdx}" style="${lockedStyle}${vlStyle}${selStyle}${newGlow}" ${clickHandler}>${isEdit&&!_mediaSelectMode?`<div class="drag-handle" onpointerdown="startDrag(event,'media',${realIdx})" onclick="event.stopPropagation()">⋮⋮</div><div class="admin-edit-btn" onclick="event.stopPropagation();editMediaItem(${realIdx})" style="position:absolute;top:8px;right:8px">✎</div>`:''}${checkHtml}${crosshatch}${newBadge}<span class="media-exp-icon">${m.icon}</span><div class="media-exp-info"><span class="media-exp-name" style="${fontStyle(_mNameFont)}">${m.name}</span><span class="media-exp-desc" style="${fontStyle(_mDescFont)}">${m.desc}</span></div><span class="media-exp-badge ${m.type}">${badge}</span></div>`;
  }).join('')+(isEdit&&!_mediaSelectMode?'<div class="admin-add-btn" onclick="addMediaItem()">+ Add Item</div>':'');
  const mbadge=document.getElementById('mediaBadge');if(mbadge)mbadge.textContent=tileBadgeText('media',isAdmin);
}


// ══════ INTERACTION RELIABILITY PATCHES ══════
// Some mobile/trackpad combos occasionally swallow 'click' on complex tiles (esp. when overlay divs exist).
// We add delegated pointer/click handling so grid + evidence items open reliably with a single tap/click.
function _installInteractionDelegates(){
  const fg=document.getElementById('feedGridView');
  if(fg && !fg.__ddBound){
    fg.__ddBound=true;
    let down=null;
    let _lastOpen=0;
    function _openPostOnce(idx){
      const now=Date.now();
      if(now-_lastOpen<300) return; // debounce double-fires
      _lastOpen=now;
      try{openPost(parseInt(idx,10));}catch(err){}
    }
    fg.addEventListener('pointerdown',e=>{
      const card=e.target.closest('.feed-card');
      if(!card) return;
      if(e.target.closest('.drag-handle')||e.target.closest('.admin-edit-btn')) return;
      if(e.button!==undefined && e.button!==0) return;
      down={x:e.clientX,y:e.clientY,idx:card.dataset.idx,pt:e.pointerType||'mouse',t:Date.now()};
    },{passive:true});
    fg.addEventListener('pointerup',e=>{
      if(!down) return;
      const card=e.target.closest('.feed-card');
      if(!card || card.dataset.idx!==down.idx){ down=null; return; }
      const dx=Math.abs(e.clientX-down.x), dy=Math.abs(e.clientY-down.y);
      if(dx<=10 && dy<=10){
        _openPostOnce(down.idx);
      }
      down=null;
    },{passive:true});
    fg.addEventListener('click',e=>{
      if(e.target.closest('.drag-handle')||e.target.closest('.admin-edit-btn')) return;
      const card=e.target.closest('.feed-card');
      if(!card) return;
      _openPostOnce(card.dataset.idx);
    });
  }

  const ml=document.getElementById('mediaList');
  if(ml && !ml.__ddBound){
    ml.__ddBound=true;
    let down=null;
    let _lastOpen=0;
    function _openMediaOnce(idx){
      const now=Date.now();
      if(now-_lastOpen<300) return;
      _lastOpen=now;
      try{openMediaViewer(parseInt(idx,10));}catch(err){}
    }
    ml.addEventListener('pointerdown',e=>{
      const item=e.target.closest('.media-exp-item');
      if(!item) return;
      if(e.button!==undefined && e.button!==0) return;
      down={x:e.clientX,y:e.clientY,idx:item.dataset.idx,pt:e.pointerType||'mouse'};
    },{passive:true});
    ml.addEventListener('pointerup',e=>{
      if(!down) return;
      const item=e.target.closest('.media-exp-item');
      if(!item || item.dataset.idx!==down.idx){ down=null; return; }
      const dx=Math.abs(e.clientX-down.x), dy=Math.abs(e.clientY-down.y);
      if(dx<=10 && dy<=10){
        _openMediaOnce(down.idx);
      }
      down=null;
    },{passive:true});
    ml.addEventListener('click',e=>{
      const item=e.target.closest('.media-exp-item');
      if(!item) return;
      _openMediaOnce(item.dataset.idx);
    });
  }
}

// ══════ PANELS ══════
const overlay=document.getElementById('panelOverlay');
let currentFeedView='grid';
function openPanel(t){playTileClick();recordTileAccess(t);adminPanelIds.forEach(id=>{const el=document.getElementById(id);if(el){el.classList.remove('active');el.style.cssText=''}});document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));document.getElementById({feed:'expFeed',media:'expMedia',intel:'expIntel',vault:'expVault'}[t]).classList.add('visible');_instantShow(overlay);if(window._histPush)window._histPush('panel');saveSession();if(!isAdmin&&currentVaultTeam)apiCall('heartbeat',{teamId:currentVaultTeam.id});
  if(t==='feed'){renderFeed();setFeedView('grid');_refreshPanelData('feed')}if(t==='media'){renderMedia();_refreshPanelData('media')}if(t==='intel'){renderIntelForm();restoreIntelDraft();_refreshPanelData('intel')}if(t==='vault'){renderVaultPanel();_refreshPanelData('vault')}}

// Fresh data fetch on panel open — ensures frontend matches backend
function _refreshPanelData(panel){
  if(_isTutorialRunning())return; // Don't refresh during tutorial — causes badge flicker
  if(panel==='feed'){
    if(_saveFeedTimer||_feedSaveInFlight||Date.now()<_feedSaveCooldown){console.log('[FEED] Refresh blocked — save pending/inflight/cooldown');return}
    apiCall('getFeedPosts').then(r=>{
      if(r.ok&&r.posts){
        // Smart merge: never overwrite local data that has mediaUrls if backend is missing them
        // (Cloudflare KV eventual consistency can return stale reads for up to 60s)
        const localHasMedia=posts.some(p=>p.mediaUrl);
        const backendMissingMedia=localHasMedia&&posts.length===r.posts.length&&r.posts.some((bp,i)=>!bp.mediaUrl&&posts[i]&&posts[i].mediaUrl);
        if(backendMissingMedia){console.log('[FEED] Refresh skipped — backend appears stale (missing mediaUrls local has)');return}
        const changed=JSON.stringify(r.posts)!==JSON.stringify(posts.map(p=>({emoji:p.emoji,bg:p.bg,cap:p.cap,capFont:p.capFont||'',mediaUrl:p.mediaUrl||'',mediaType:p.mediaType||'image',focalX:p.focalX||50,focalY:p.focalY||50})));
        if(changed){posts=r.posts;renderFeed();renderGrid();_cacheContent("cb_posts",posts)}
      }
    });
  }else if(panel==='media'){
    if(_saveMediaTimer||_mediaSaveInFlight||Date.now()<_mediaSaveCooldown){return} // Save pending/cooldown
    apiCall('getMediaItems').then(r=>{
      if(r.ok&&r.items){
        const changed=r.items.length!==mediaItems.length||JSON.stringify(r.items)!==JSON.stringify(mediaItems.map(m=>({name:m.name,desc:m.desc||'',url:m.url,type:m.type||'image',nameFont:m.nameFont||'',descFont:m.descFont||'',vaultLocked:m.vaultLocked||false})));
        if(changed){mediaItems=_normalizeMediaItems(r.items);syncVaultCodesFromMedia();restoreGameState();renderMedia();renderGrid();_cacheContent("cb_media",mediaItems)}
      }
    });
  }else if(panel==='intel'){
    apiCall('getIntelFields').then(r=>{
      if(r.ok&&r.fields){
        const changed=r.fields.length!==intelFields.length||JSON.stringify(r.fields)!==JSON.stringify(intelFields);
        if(changed){
          // Preserve current input values before re-render
          const curVals={};
          document.querySelectorAll('.intel-exp-input').forEach(inp=>{if(inp.dataset.idx&&inp.value.trim())curVals[inp.dataset.idx]=inp.value});
          intelFields=r.fields||[];
          // Normalize shapes (type vs fieldType) so money/phone/etc render correctly immediately
          intelFields.forEach(f=>{try{if(f&&typeof f==='object'){if(!f.type&&f.fieldType)f.type=f.fieldType;if(!f.fieldType&&f.type)f.fieldType=f.type}}catch(e){}});
          renderIntelForm();
          // Restore typed values
          document.querySelectorAll('.intel-exp-input').forEach(inp=>{if(curVals[inp.dataset.idx])inp.value=curVals[inp.dataset.idx]});
          renderGrid();_cacheContent("cb_intel",intelFields);
        }
      }
    });
  }else if(panel==='vault'){
    apiCall('getEventConfig').then(cfg=>{
      if(cfg.ok&&cfg.config)applyEventConfig(cfg.config);
      syncVaultCodesFromMedia();restoreGameState();renderVaultPanel();
    });
  }
}
function closePanel(){_stopAllFeedVideos();overlay.style.cssText='';overlay.classList.remove('active');saveGameState();setTimeout(()=>{document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));saveSession();renderGrid()},120)
  try{_forceCursorKill();}catch(e){}
}

// Feed view modes
function feedClose(){
  // In focus mode, go back to grid. In grid mode, close panel entirely.
  if(currentFeedView==='single'){
    setFeedView('grid');
  }else{
    closePanel();
  }
}
function toggleFeedCaption(){
  const overlay=document.getElementById('feedCapOverlay');
  const cap=document.getElementById('singleCap');
  const text=document.getElementById('feedCapOverlayText');
  text.textContent=cap.textContent;
  text.style.fontFamily=cap.style.fontFamily;
  overlay.classList.add('visible');
  document.getElementById('feedCapMore').classList.remove('visible');
}
function closeFeedCapOverlay(){
  document.getElementById('feedCapOverlay').classList.remove('visible');
  // Re-check if more button needed
  const cap=document.getElementById('singleCap');
  const more=document.getElementById('feedCapMore');
  if(more&&cap)more.classList.toggle('visible',cap.scrollHeight>cap.clientHeight+2);
}
function updateFeedCloseBtn(){
  const btn=document.getElementById('feedCloseBtn');
  if(!btn)return;
  if(currentFeedView==='single'){
    btn.textContent='← GRID';
  }else{
    btn.textContent='✕ CLOSE';
  }
}
function setFeedView(mode){
  currentFeedView=mode;
  document.querySelectorAll('.feed-view-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById({grid:'fvGrid',single:'fvSingle'}[mode])?.classList.add('active');
  const gridEl=document.getElementById('feedGridView');
  const singleEl=document.getElementById('feedSingleView');
  const toggleEl=document.getElementById('feedViewToggle');
  const body=document.getElementById('feedExpBody');
  if(mode==='grid'){
    gridEl.style.display='';
    singleEl.classList.remove('visible');toggleEl.style.display='';
    if(body)body.classList.remove('focus-active');
    // Stop all videos/audio when returning to grid
    _stopAllFeedVideos();
  } else {
    gridEl.style.display='none';singleEl.classList.add('visible');
    toggleEl.style.display='';renderSinglePost();
    if(body)body.classList.add('focus-active');
  }
  updateFeedCloseBtn();
  saveSession();
}
function _stopAllFeedVideos(){
  document.querySelectorAll('#expFeed video, #expFeed iframe').forEach(el=>{
    if(el.tagName==='VIDEO'){el.pause();el.muted=true;el.currentTime=0}
    else if(el.tagName==='IFRAME'){try{el.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}','*')}catch(e){}}
  });
}

let currentPost=0;
function openPost(i){currentPost=i;if(window._histPush)window._histPush('feedFocus');setFeedView('single')}
function renderSinglePost(){
  if(!posts.length){
    const img=document.getElementById('singleImg');
    if(img){img.style.background='';img.textContent='';img.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:Chakra Petch,sans-serif;font-size:11px;color:#333;letter-spacing:1px">No intelligence available</div>'}
    document.getElementById('singleCounter').textContent='0 / 0';
    const capEl=document.getElementById('singleCap');if(capEl)capEl.textContent='';
    return;
  }
  if(currentPost>=posts.length)currentPost=0;
  const p=posts[currentPost],img=document.getElementById('singleImg');
  const resolved=(p.mediaUrl&&(p.mediaType==='video'||isVideoUrl(p.mediaUrl)))?resolveVideoEmbed(p.mediaUrl):null;
  const editBtn=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview')?`<div class="feed-single-edit" onclick="event.stopPropagation();editFeedPost(${currentPost})" title="Edit this post">✎</div>`:'';
  const muted=isPostMuted(currentPost);

  if(resolved&&resolved.type==='direct'){
    img.style.background='#000';img.style.backgroundSize='';img.textContent='';
    img.innerHTML=`<video class="feed-single-video" id="feedSingleVid" src="${resolved.url}" loop playsinline preload="auto" ${muted?'muted':''} controls></video>${editBtn}`;
    setTimeout(()=>{const v=document.getElementById('feedSingleVid');if(v){v.muted=muted;v.play().catch(()=>{})}},50);
  }else if(resolved&&resolved.type==='external'){
    img.style.background='#000';img.style.backgroundSize='';img.textContent='';
    img.innerHTML=buildExternalLink(resolved,editBtn);
  }else if(resolved&&resolved.embed){
    img.style.background='#000';img.style.backgroundSize='';img.textContent='';
    img.innerHTML=buildEmbedIframe(resolved,true,muted)+editBtn;
  }else if(resolved&&resolved.type==='iframe-fallback'){
    img.style.background='#000';img.style.backgroundSize='';img.textContent='';
    img.innerHTML=`<iframe src="${resolved.url}" style="width:100%;height:100%;border:none" allow="autoplay;encrypted-media" allowfullscreen></iframe>${editBtn}`;
  }else if(p.mediaUrl){
    // Image — wrapped for zoom/pan
    img.style.background='';img.style.backgroundSize='';
    img.innerHTML=`<div class="feed-zoom-wrapper" id="feedZoomWrap"><div class="no-download-shield" oncontextmenu="return false"></div><img src="${p.mediaUrl}" draggable="false"></div>${editBtn}`;
    resetFeedZoom();
  }else{
    // Emoji placeholder
    img.style.background=p.bg;img.style.backgroundSize='';img.textContent=p.emoji;img.innerHTML=p.emoji+editBtn;
  }
  const capEl=document.getElementById('singleCap');
  capEl.textContent=p.cap;
  capEl.style.fontFamily=getFontFamily(resolveFont('feedCap',p.capFont||''));
  // Close any open overlay
  const overlay=document.getElementById('feedCapOverlay');
  if(overlay)overlay.classList.remove('visible');
  document.getElementById('singleCounter').textContent=(currentPost+1)+' / '+posts.length;
  // Check if caption overflows fixed zone
  requestAnimationFrame(()=>{
    const more=document.getElementById('feedCapMore');
    if(more&&capEl)more.classList.toggle('visible',capEl.scrollHeight>capEl.clientHeight+2);
  });
}
// ══════ VIDEO EMBED RESOLVER ══════
function resolveVideoEmbed(url){
  if(!url)return null;
  const u=url.trim();
  // 1. Direct video file
  if(/\.(mp4|webm|mov|ogg)(\?.*)?$/i.test(u))return{type:'direct',url:u};
  // 2. YouTube
  const yt=u.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/|live\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  if(yt)return{type:'youtube',id:yt[1],embed:`https://www.youtube-nocookie.com/embed/${yt[1]}`,thumb:`https://img.youtube.com/vi/${yt[1]}/hqdefault.jpg`};
  // 3. Vimeo
  const vm=u.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/);
  if(vm)return{type:'vimeo',id:vm[1],embed:`https://player.vimeo.com/video/${vm[1]}`,thumb:null};
  // 4. Google Drive
  const gd=u.match(/drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/);
  if(gd)return{type:'gdrive',id:gd[1],embed:`https://drive.google.com/file/d/${gd[1]}/preview`,thumb:`https://drive.google.com/thumbnail?id=${gd[1]}&sz=w400`};
  // 5. Dailymotion
  const dm=u.match(/(?:dailymotion\.com\/video\/|dai\.ly\/)([a-zA-Z0-9]+)/);
  if(dm)return{type:'dailymotion',id:dm[1],embed:`https://www.dailymotion.com/embed/video/${dm[1]}`,thumb:`https://www.dailymotion.com/thumbnail/video/${dm[1]}`};
  // 6. Streamable
  const st=u.match(/streamable\.com\/([a-zA-Z0-9]+)/);
  if(st)return{type:'streamable',id:st[1],embed:`https://streamable.com/e/${st[1]}`,thumb:null};
  // 7. Loom
  const lm=u.match(/loom\.com\/share\/([a-zA-Z0-9]+)/);
  if(lm)return{type:'loom',id:lm[1],embed:`https://www.loom.com/embed/${lm[1]}`,thumb:null};
  // 8. Facebook video (limited embed support)
  if(/facebook\.com\/.*\/videos\/|fb\.watch/i.test(u))return{type:'external',url:u,label:'Facebook Video'};
  // 9. TikTok (no iframe support)
  if(/tiktok\.com/i.test(u))return{type:'external',url:u,label:'TikTok'};
  // 10. Instagram (no iframe support)
  if(/instagram\.com\/(reel|p)\//i.test(u))return{type:'external',url:u,label:'Instagram'};
  // 11. Twitter/X video (no iframe support)
  if(/(twitter\.com|x\.com)\/.*\/status\//i.test(u))return{type:'external',url:u,label:'X (Twitter)'};
  // 12. Generic URL — try iframe as last resort
  return{type:'iframe-fallback',url:u,thumb:null};
}
function buildEmbedIframe(resolved,autoplay,muted){
  const mutedParam=muted?1:0;
  let src=resolved.embed||resolved.url;
  // Add autoplay/mute params per platform
  if(resolved.type==='youtube')src+=`?autoplay=${autoplay?1:0}&mute=${mutedParam}&loop=1&playlist=${resolved.id}&rel=0&modestbranding=1&iv_load_policy=3&disablekb=0&fs=1&controls=1`;
  else if(resolved.type==='vimeo')src+=`?autoplay=${autoplay?1:0}&muted=${mutedParam}&loop=1`;
  else if(resolved.type==='dailymotion')src+=`?autoplay=${autoplay?1:0}&mute=${mutedParam}`;
  else if(resolved.type==='loom')src+=`?autoplay=${autoplay?1:0}`;
  return `<iframe src="${src}" style="width:100%;height:100%;border:none" allow="autoplay;encrypted-media;fullscreen" allowfullscreen></iframe>`;
}
function buildVideoThumbnail(resolved){
  if(resolved.thumb)return `<img src="${resolved.thumb}" style="width:100%;height:100%;object-fit:cover"><div class="feed-video-badge">▶ VIDEO</div>`;
  // For platforms without thumbnails, show a styled placeholder
  const label=resolved.type==='external'?resolved.label:resolved.type.toUpperCase();
  return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0a0c12;gap:6px"><span style="font-size:32px;opacity:.5">▶</span><span style="font-family:IBM Plex Mono,monospace;font-size:8px;color:#555;letter-spacing:2px">${label}</span></div><div class="feed-video-badge">▶ VIDEO</div>`;
}
function buildExternalLink(resolved,editBtn){
  const label=resolved.label||'Video';
  return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0a0c12;gap:12px">
    <span style="font-size:40px;opacity:.4">▶</span>
    <span style="font-family:Chakra Petch,sans-serif;font-size:12px;color:#888;letter-spacing:1px">${label}</span>
    <a href="${resolved.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--cyan);letter-spacing:1px;padding:8px 16px;border:1px solid rgba(0,212,255,.3);border-radius:4px;background:rgba(0,212,255,.06);text-decoration:none;transition:all .2s">Open in ${label} ↗</a>
    <span style="font-family:IBM Plex Mono,monospace;font-size:8px;color:#444;letter-spacing:1px">This platform does not support inline playback</span>
  </div>${editBtn||''}`; 
}
function toggleFeedMute(){
  const muted=isPostMuted(currentPost);
  const newMuted=!muted;
  postMuteState[currentPost]=newMuted;
  feedMuted=newMuted; // Also update global default for new videos
  const vid=document.getElementById('feedSingleVid');
  if(vid)vid.muted=newMuted;
  const btn=document.querySelector('.feed-mute-btn');
  if(btn)btn.textContent=newMuted?'🔇':'🔊';
  // For iframes, need to re-render to apply mute change
  const iframe=document.querySelector('#singleImg iframe');
  if(iframe)renderSinglePost();
}
function navPost(d){currentPost=(currentPost+d+posts.length)%posts.length;resetFeedZoom();renderSinglePost();saveSession()}

// ══════ FEED ZOOM + SWIPE (Unified Interaction Engine) ══════
const feedZoom = {scale:1, x:0, y:0, minScale:1, maxScale:5};

function getFeedZoomWrap(){return document.getElementById('feedZoomWrap')}
function getFeedContainer(){return document.getElementById('singleImg')}
function isZoomablePost(){return !!getFeedZoomWrap()}

function applyFeedZoom(){
  const w=getFeedZoomWrap();if(!w)return;
  w.style.transform=`translate(${feedZoom.x}px,${feedZoom.y}px) scale(${feedZoom.scale})`;
  const c=getFeedContainer();
  if(c){
    if(feedZoom.scale>1.01){c.classList.add('zoomed')}
    else{c.classList.remove('zoomed','dragging')}
  }
}

function clampFeedPan(){
  const c=getFeedContainer();if(!c)return;
  const cw=c.clientWidth, ch=c.clientHeight;
  const sw=cw*feedZoom.scale, sh=ch*feedZoom.scale;
  if(sw<=cw){feedZoom.x=(cw-sw)/2}else{feedZoom.x=Math.min(0,Math.max(cw-sw,feedZoom.x))}
  if(sh<=ch){feedZoom.y=(ch-sh)/2}else{feedZoom.y=Math.min(0,Math.max(ch-sh,feedZoom.y))}
}

function feedZoomTo(cx, cy, newScale){
  const c=getFeedContainer();if(!c)return;
  const rect=c.getBoundingClientRect();
  const px=cx-rect.left, py=cy-rect.top;
  const old=feedZoom.scale;
  feedZoom.scale=Math.min(feedZoom.maxScale,Math.max(feedZoom.minScale,newScale));
  feedZoom.x=px-(px-feedZoom.x)*(feedZoom.scale/old);
  feedZoom.y=py-(py-feedZoom.y)*(feedZoom.scale/old);
  clampFeedPan();applyFeedZoom();
}

function resetFeedZoom(){
  feedZoom.scale=1;feedZoom.x=0;feedZoom.y=0;
  const c=getFeedContainer();if(c){c.classList.remove('zoomed','dragging')}
  const w=getFeedZoomWrap();if(w)w.style.transform='';
}

// ── Unified mouse handler ──
(function(){
  const el=document.getElementById('singleImg');if(!el)return;
  let mDown=false, mMoved=false, mStartX=0, mStartY=0, mPanStartX=0, mPanStartY=0, mSwipeDx=0;

  el.addEventListener('mousedown',function(e){
    if(e.target.closest('.feed-mute-btn')||e.target.closest('.feed-single-edit')||e.target.tagName==='VIDEO'||e.target.tagName==='IFRAME')return;
    mDown=true; mMoved=false; mStartX=e.clientX; mStartY=e.clientY; mSwipeDx=0;
    mPanStartX=feedZoom.x; mPanStartY=feedZoom.y;
    if(feedZoom.scale>1.01) el.classList.add('dragging');
    e.preventDefault();
  });

  window.addEventListener('mousemove',function(e){
    if(!mDown)return;
    const dx=e.clientX-mStartX, dy=e.clientY-mStartY;
    if(Math.abs(dx)>3||Math.abs(dy)>3) mMoved=true;
    if(!mMoved)return;

    if(feedZoom.scale>1.01){
      // Panning zoomed image
      feedZoom.x=mPanStartX+dx;
      feedZoom.y=mPanStartY+dy;
      clampFeedPan();applyFeedZoom();
    } else {
      // Swiping between posts
      mSwipeDx=dx;
      el.style.transform=`translateX(${dx*.4}px)`;
      el.style.opacity=1-Math.abs(dx)/600;
    }
  });

  window.addEventListener('mouseup',function(){
    if(!mDown)return; mDown=false;
    el.classList.remove('dragging');

    if(!mMoved && isZoomablePost()){
      // Click — toggle zoom
      if(feedZoom.scale>1.01){
        resetFeedZoom();
      }else{
        // Zoom to 2.5x centered on click
        feedZoom.scale=2.5;
        const c=getFeedContainer();
        if(c){feedZoom.x=(c.clientWidth*(1-2.5))/2;feedZoom.y=(c.clientHeight*(1-2.5))/2}
        clampFeedPan();applyFeedZoom();
      }
    } else if(feedZoom.scale<=1.01 && Math.abs(mSwipeDx)>50){
      // Swipe navigation
      const dir=mSwipeDx>0?-1:1;
      el.style.transition='transform .2s,opacity .2s';
      el.style.transform=`translateX(${mSwipeDx>0?'100px':'-100px'})`;el.style.opacity='0';
      setTimeout(()=>{
        navPost(dir);
        el.style.transition='none';el.style.transform=`translateX(${dir>0?'60px':'-60px'})`;el.style.opacity='0';
        requestAnimationFrame(()=>{
          el.style.transition='transform .25s ease-out,opacity .25s ease-out';
          el.style.transform='translateX(0)';el.style.opacity='1';
        });
      },200);
      setTimeout(()=>{el.style.transition=''},450);
      return;
    }
    // Reset swipe transform if didn't navigate
    if(feedZoom.scale<=1.01){
      el.style.transition='transform .2s,opacity .2s';
      el.style.transform='';el.style.opacity='';
      setTimeout(()=>{el.style.transition=''},250);
    }
  });

  // Scroll wheel zoom
  el.addEventListener('wheel',function(e){
    if(!isZoomablePost())return;
    e.preventDefault();
    const factor=e.deltaY>0?0.82:1.22;
    feedZoomTo(e.clientX,e.clientY,feedZoom.scale*factor);
  },{passive:false});

  // ── Unified touch handler ──
  let tStartX=0, tStartY=0, tMoved=false, tSwipeDx=0, tPanStartX=0, tPanStartY=0;
  let pinching=false, pinchDist0=0, pinchScale0=1, pinchMidX=0, pinchMidY=0;

  function touchDist(t){return Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY)}
  function touchMid(t){return{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2}}

  el.addEventListener('touchstart',function(e){
    if(e.target.closest('.feed-mute-btn')||e.target.closest('.feed-single-edit')||e.target.tagName==='VIDEO'||e.target.tagName==='IFRAME')return;
    tMoved=false; tSwipeDx=0;

    if(e.touches.length===2 && isZoomablePost()){
      // Pinch start
      pinching=true;
      pinchDist0=touchDist(e.touches);
      pinchScale0=feedZoom.scale;
      const mid=touchMid(e.touches);
      pinchMidX=mid.x; pinchMidY=mid.y;
      tPanStartX=feedZoom.x; tPanStartY=feedZoom.y;
      e.preventDefault();
    } else if(e.touches.length===1){
      tStartX=e.touches[0].clientX; tStartY=e.touches[0].clientY;
      tPanStartX=feedZoom.x; tPanStartY=feedZoom.y;
      if(feedZoom.scale>1.01) e.preventDefault();
    }
  },{passive:false});

  el.addEventListener('touchmove',function(e){
    if(pinching && e.touches.length===2){
      // Pinch zoom + pan
      e.preventDefault(); tMoved=true;
      const dist=touchDist(e.touches);
      const mid=touchMid(e.touches);
      feedZoomTo(mid.x, mid.y, pinchScale0*(dist/pinchDist0));
    } else if(e.touches.length===1 && !pinching){
      const dx=e.touches[0].clientX-tStartX;
      const dy=e.touches[0].clientY-tStartY;
      if(Math.abs(dx)>5||Math.abs(dy)>5) tMoved=true;
      if(!tMoved)return;

      if(feedZoom.scale>1.01){
        // Pan zoomed image
        e.preventDefault();
        feedZoom.x=tPanStartX+dx;
        feedZoom.y=tPanStartY+dy;
        clampFeedPan();applyFeedZoom();
      } else {
        // Swipe between posts
        if(Math.abs(dy)>Math.abs(dx))return; // vertical scroll, ignore
        tSwipeDx=dx;
        el.style.transform=`translateX(${dx*.4}px)`;
        el.style.opacity=1-Math.abs(dx)/600;
      }
    }
  },{passive:false});

  el.addEventListener('touchend',function(e){
    if(pinching && e.touches.length<2){
      pinching=false;
      if(feedZoom.scale<1.05) resetFeedZoom();
      return;
    }
    if(e.touches.length>0)return; // still touching

    if(!tMoved && isZoomablePost()){
      // Tap — toggle zoom
      if(feedZoom.scale>1.01){
        resetFeedZoom();
      } else {
        feedZoom.scale=2.5;
        const c=getFeedContainer();
        if(c){feedZoom.x=(c.clientWidth*(1-2.5))/2;feedZoom.y=(c.clientHeight*(1-2.5))/2}
        clampFeedPan();applyFeedZoom();
      }
    } else if(feedZoom.scale<=1.01 && Math.abs(tSwipeDx)>50){
      // Swipe navigation
      const dir=tSwipeDx>0?-1:1;
      el.style.transition='transform .2s,opacity .2s';
      el.style.transform=`translateX(${tSwipeDx>0?'100px':'-100px'})`;el.style.opacity='0';
      setTimeout(()=>{
        navPost(dir);
        el.style.transition='none';el.style.transform=`translateX(${dir>0?'60px':'-60px'})`;el.style.opacity='0';
        requestAnimationFrame(()=>{
          el.style.transition='transform .25s ease-out,opacity .25s ease-out';
          el.style.transform='translateX(0)';el.style.opacity='1';
        });
      },200);
      setTimeout(()=>{el.style.transition=''},450);
      return;
    }

    // Reset swipe transform
    if(feedZoom.scale<=1.01){
      el.style.transition='transform .2s,opacity .2s';
      el.style.transform='';el.style.opacity='';
      setTimeout(()=>{el.style.transition=''},250);
    }
  });
})();

// ══════ OVERSCROLL RUBBER BAND ══════
(function(){
  document.querySelectorAll('.exp-body, #consoleScreen').forEach(el=>{
    let startY=0,pulling=false;
    el.addEventListener('touchstart',e=>{startY=e.touches[0].clientY},{passive:true});
    el.addEventListener('touchmove',e=>{
      const dy=e.touches[0].clientY-startY;
      const atTop=el.scrollTop<=0;
      const atBottom=el.scrollTop+el.clientHeight>=el.scrollHeight-1;
      if((atTop&&dy>0)||(atBottom&&dy<0)){
        const pull=Math.min(Math.abs(dy)*.3,60);
        const dir=dy>0?1:-1;
        el.style.transform=`translateY(${pull*dir}px)`;
        el.style.transition='none';
        pulling=true;
      }
    },{passive:true});
    el.addEventListener('touchend',()=>{
      if(pulling){
        el.style.transition='transform .4s cubic-bezier(.25,.46,.45,.94)';
        el.style.transform='translateY(0)';
        pulling=false;
      }
    });
  });
})();

// ══════ INTEL ══════
let isSubmitted=false;
let submissionResults=null; // Stores grading results after submit

function formatPhone(el){
  let v=el.value.replace(/\D/g,'').slice(0,10);
  if(v.length>6)v='('+v.slice(0,3)+') '+v.slice(3,6)+'-'+v.slice(6);
  else if(v.length>3)v='('+v.slice(0,3)+') '+v.slice(3);
  else if(v.length>0)v='('+v;
  el.value=v;
}
function formatMoney(el){
  // Preserve cursor intent: strip everything non-digit
  const raw=el.value.replace(/[^0-9]/g,'');
  if(!raw){el.value='';return;}
  // Format with commas
  el.value=parseInt(raw,10).toLocaleString('en-US');
}
function formatDate(el){
  let v=el.value.replace(/\D/g,'').slice(0,8);
  if(v.length>4)v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
  else if(v.length>2)v=v.slice(0,2)+'/'+v.slice(2);
  el.value=v;
}

// ── Levenshtein Distance (fuzzy matching) ──
function levenshtein(a,b){
  const m=a.length,n=b.length;
  const d=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++)d[i][0]=i;
  for(let j=0;j<=n;j++)d[0][j]=j;
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){
    const cost=a[i-1]===b[j-1]?0:1;
    d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+cost);
  }
  return d[m][n];
}
function similarity(a,b){
  if(!a&&!b)return 1;if(!a||!b)return 0;
  const maxLen=Math.max(a.length,b.length);
  if(maxLen===0)return 1;
  return((maxLen-levenshtein(a,b))/maxLen)*100;
}

// ── Answer Checking ──
function normalizeAnswer(str,caseSensitive){
  let s=str.trim();
  // Strip common noise: extra spaces, trailing periods
  s=s.replace(/\s+/g,' ').replace(/\.$/,'');
  // Strip currency symbols and commas so $2,000,000 == 2000000
  s=s.replace(/[$,]/g,'');
  if(!caseSensitive)s=s.toLowerCase();
  return s;
}

function checkSingleAnswer(submitted,answerConfig){
  if(!submitted.trim())return{correct:false,score:0,match:'empty'};
  const cfg=answerConfig||{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85};
  const cs=cfg.caseSensitive;
  const sub=normalizeAnswer(submitted,cs);

  // Build list of all acceptable answers
  const acceptables=[...cfg.expected.filter(e=>e.trim()),...(cfg.alts||[]).filter(a=>a.trim())];
  if(!acceptables.length)return{correct:false,score:0,match:'no-answer-key'};

  for(const ans of acceptables){
    const norm=normalizeAnswer(ans,cs);
    // Exact match
    if(sub===norm)return{correct:true,score:cfg.points||10,match:'exact'};
  }

  // Contains match
  if(cfg.matchMode==='contains'){
    for(const ans of acceptables){
      const norm=normalizeAnswer(ans,cs);
      if(sub.includes(norm)||norm.includes(sub))return{correct:true,score:cfg.points||10,match:'contains'};
    }
  }

  // Fuzzy match — only when explicitly set to fuzzy mode
  if(cfg.matchMode==='fuzzy'){
    for(const ans of acceptables){
      const norm=normalizeAnswer(ans,cs);
      const sim=similarity(sub,norm);
      if(sim>=cfg.fuzzyThreshold)return{correct:true,score:cfg.points||10,match:'fuzzy',similarity:Math.round(sim)};
    }
  }

  // Find closest match for feedback
  let bestSim=0;
  for(const ans of acceptables){
    const norm=normalizeAnswer(ans,cs);
    const sim=similarity(sub,norm);
    if(sim>bestSim)bestSim=sim;
  }
  return{correct:false,score:0,match:'wrong',closestSimilarity:Math.round(bestSim)};
}

function gradeAllSubmissions(){
  const results=[];
  let totalScore=0,totalPossible=0,correctCount=0;

  intelFields.forEach((f,i)=>{
    const pts=f.answer?.points||10;
    totalPossible+=pts;

    if(f.type==='dual'){
      // Dual fields: check both values
      const inp1=document.querySelector(`.intel-exp-input[data-idx="${i}"]`);
      const inp2=document.querySelector(`.intel-exp-input[data-idx="${i}b"]`);
      const v1=inp1?inp1.value:'';
      const v2=inp2?inp2.value:'';
      const exp=f.answer?.expected||['',''];

      // Try both orderings (teams might swap the two values)
      const r1a=checkSingleAnswer(v1,{...f.answer,expected:[exp[0]||'']});
      const r1b=checkSingleAnswer(v2,{...f.answer,expected:[exp[1]||'']});
      const r2a=checkSingleAnswer(v1,{...f.answer,expected:[exp[1]||'']});
      const r2b=checkSingleAnswer(v2,{...f.answer,expected:[exp[0]||'']});

      const score1=(r1a.correct?1:0)+(r1b.correct?1:0);
      const score2=(r2a.correct?1:0)+(r2b.correct?1:0);

      if(score1>=score2){
        const bothCorrect=r1a.correct&&r1b.correct;
        results.push({field:f.label,type:'dual',correct:bothCorrect,partialCorrect:score1===1,submitted:[v1,v2],results:[r1a,r1b],score:bothCorrect?pts:(score1===1?Math.round(pts/2):0)});
        if(bothCorrect)correctCount++;
        totalScore+=bothCorrect?pts:(score1===1?Math.round(pts/2):0);
      }else{
        const bothCorrect=r2a.correct&&r2b.correct;
        results.push({field:f.label,type:'dual',correct:bothCorrect,partialCorrect:score2===1,submitted:[v1,v2],results:[r2a,r2b],score:bothCorrect?pts:(score2===1?Math.round(pts/2):0)});
        if(bothCorrect)correctCount++;
        totalScore+=bothCorrect?pts:(score2===1?Math.round(pts/2):0);
      }
    }else{
      const inp=document.querySelector(`.intel-exp-input[data-idx="${i}"]`);
      const v=inp?inp.value:'';
      const r=checkSingleAnswer(v,f.answer);
      results.push({field:f.label,type:'single',correct:r.correct,submitted:v,result:r,score:r.score});
      if(r.correct)correctCount++;
      totalScore+=r.score;
    }
  });

  return{results,totalScore,totalPossible,correctCount,totalFields:intelFields.length,percentage:totalPossible?Math.round((totalScore/totalPossible)*100):0};
}
function updateIntelBadge(){const filled=document.querySelectorAll('.intel-exp-input');let n=0;filled.forEach(inp=>{if(inp.value.trim())n++});const badge=document.getElementById('intelBadge');if(badge)badge.textContent=n+' / '+filled.length+' ENTERED'}
document.addEventListener('input',e=>{if(e.target.classList.contains('intel-exp-input'))updateIntelBadge()});
function showConfirm(){
  if(isSubmitted)return;
  // Player preview dry-run — show confirm then simulate
  playConfirmPrompt();const inputs=document.querySelectorAll('.intel-exp-input'),body=document.getElementById('confirmBody');body.innerHTML='';
  syncIntelLabels();let li=0;
  inputs.forEach((inp)=>{let v=inp.value.trim();const idx=inp.dataset.idx;
    const fi=parseInt(idx);if(!isNaN(fi)&&intelFields[fi]&&intelFields[fi].type==='money'&&v)v='$'+v;
    const label=intelLabels[li]||'Field '+(li+1);li++;
    body.innerHTML+=`<div class="confirm-row"><span class="confirm-label">${label}</span><span class="confirm-value ${v?'':'empty'}">${v||'— empty —'}</span></div>`});
  document.getElementById('confirmModal').classList.add('active')}
function hideConfirm(){document.getElementById('confirmModal').classList.remove('active')}
function finalSubmit(){
  // Player preview dry-run — full visual feedback, then reset
  if(document.body.classList.contains('player-preview')){
    document.getElementById('confirmModal').classList.remove('active');
    document.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=true});
    const btn=document.getElementById('intelSubmitBtn');if(btn){btn.textContent='SUBMITTED';btn.disabled=true}
    document.getElementById('intelBadge').textContent='SUBMITTED';
    playSuccess();
    document.getElementById('flashG').classList.add('on');
    setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);
    // Reset after 3 seconds
    setTimeout(()=>{
      document.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=false;inp.value=''});
      if(btn){btn.textContent='SUBMIT INTEL';btn.disabled=false}
      updateIntelBadge();
    },3000);
    return;
  }

  isSubmitted=true;
  // Grade all answers locally — results stored for admin/leaderboard
  submissionResults=gradeAllSubmissions();
  submissionResults.submittedAt=new Date().toISOString();
  saveGameState();

  document.getElementById('confirmModal').classList.remove('active');
  document.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=true});
  // Show neutral checkmarks — NO indication of right/wrong
    document.getElementById('intelSubmitBtn').disabled=true;
  const _sl=document.getElementById('intelSubmitBtn');if(_sl){_sl.textContent='SUBMITTED';_sl.disabled=true;}
  document.getElementById('intelBadge').textContent=tileBadgeText('intel',false);
  document.getElementById('intelBadge').classList.remove('amber');
  playSuccess();
  document.getElementById('flashG').classList.add('on');
  setTimeout(()=>document.getElementById('flashG').classList.remove('on'),400);

  // Send to backend
  if(currentVaultTeam&&currentVaultTeam.id!=='ADMIN'){
    const answers={};
    document.querySelectorAll('.intel-exp-input').forEach(inp=>{
      const idx=inp.dataset.idx;
      const fi=parseInt(idx);
      if(!isNaN(fi)&&intelFields[fi]){
        const key=intelFields[fi].label;
        if(idx.endsWith('b')){answers[key+'_2']=inp.value.trim()}
        else{answers[key]=inp.value.trim()}
      }
    });
    apiCall('submitAnswers',{teamId:currentVaultTeam.id,answers:answers}).then(r=>{
      if(r.ok){/* submission saved */}
      else{/* submission save failed */}
    });
  }
}

// ══════ MEDIA VIEWER ══════
let currentMediaIdx=0;
let mvAudio=null;
let mvAudioInterval=null;

function openMediaViewer(i){
  const m=mediaItems[i];
  // Block vault-locked items for non-admin users
  const isAdmin=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  if(!isAdmin&&m.vaultLocked&&!_isMediaVisibleToPlayer(i)) return;
  if(m._isNew){m._isNew=false;renderMedia()}
  if(m.type==='locked'&&!m.unlocked){renderLockedView(i);showViewer(i);return}
  currentMediaIdx=i;
  showViewer(i);
  renderMediaContent(m);
}

function showViewer(i){
  currentMediaIdx=i;
  const m=mediaItems[i];
  document.getElementById('mvIcon').textContent=m.icon;
  document.getElementById('mvName').textContent=m.name;
  document.getElementById('mvDesc').textContent=m.desc;
  const badge=document.getElementById('mvBadge');
  badge.textContent=m.type;badge.className='mv-badge '+m.type;
  document.getElementById('mvCounter').textContent=((function(){const v=_getVisibleMediaIndices();const p=v.indexOf(i);return p===-1?(i+1)+' / '+mediaItems.length:(p+1)+' / '+v.length})());
  // Download button: only show if admin enabled downloads and file exists
  const dlBtn=document.getElementById('mvDownload');
  dlBtn.style.display=(allowDownloads&&m.fileUrl)?'':'none';
  document.getElementById('mediaViewer').classList.add('active');
  if(window._histPush)window._histPush('mediaViewer');
}

function downloadCurrentMedia(){
  const m=mediaItems[currentMediaIdx];
  if(!m.fileUrl||!allowDownloads)return;
  const eu=convertDriveUrl(m.fileUrl);
  const a=document.createElement('a');
  a.href=eu.direct;a.download=m.name;a.target='_blank';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function _resetZoomCursor(){
  try{
    document.body.style.cursor='default';
    // Clear any stuck zoom classes/cursors in viewers
    document.querySelectorAll('.mv-image-viewer.zoomed').forEach(el=>el.classList.remove('zoomed'));
    document.querySelectorAll('.feed-single-img.zoomed').forEach(el=>{el.classList.remove('zoomed'); el.classList.remove('dragging');});
    // Remove any inline cursor styles that may have been applied
    document.querySelectorAll('[style*="cursor"]').forEach(el=>{
      if(el && el.style && el.style.cursor && (el.style.cursor.includes('zoom')||el.style.cursor==='grab'||el.style.cursor==='grabbing'||el.style.cursor==='pointer')) el.style.cursor='';
    });
    // Next tick: fully release cursor to stylesheet defaults
    setTimeout(()=>{try{document.body.style.cursor='';}catch(e){}},0);
  }catch(e){}
}

function _forceCursorKill(){
  try{
    const de=document.documentElement, b=document.body;
    if(de)de.classList.add('cursor-kill');
    if(b)b.classList.add('cursor-kill');
    // Clear any inline cursor too
    if(de)de.style.cursor='auto';
    if(b)b.style.cursor='auto';
    // Remove after a generous delay to ensure browser flushes cursor cache
    setTimeout(()=>{
      try{ if(de){de.classList.remove('cursor-kill');de.style.cursor='';} }catch(e){}
      try{ if(b){b.classList.remove('cursor-kill');b.style.cursor='';} }catch(e){}
    },80);
  }catch(e){}
}



function closeMediaViewer(){
  document.getElementById('mediaViewer').classList.remove('active');
  stopMvAudio();
  // Stop any video
  const vid=document.querySelector('.mv-video');
  if(vid)vid.pause();
  // Clear body content so cursor:pointer elements don't leak into DOM after close
  const mvBody=document.getElementById('mvBody');
  if(mvBody)mvBody.innerHTML='';
  _resetZoomCursor();
  _forceCursorKill();
}

// Cursor watchdog — if any zoom/grab cursor leaks outside the viewer, force reset.
// Uses COMPUTED cursor (not just inline styles) because the stuck cursor symptom is often coming
// from computed :hover state caching in some browsers.
(function(){
  let lastKill=0;
  function shouldKill(cur){
    return !!cur && (cur.indexOf('zoom')>-1 || cur==='grab' || cur==='grabbing');
  }
  document.addEventListener('mousemove',function(e){
    try{
      const mv=document.getElementById('mediaViewer');
      if(mv && mv.classList.contains('active')) return;

      const t=e && e.target ? e.target : document.elementFromPoint(e.clientX,e.clientY);
      if(!t) return;

      const cur=getComputedStyle(t).cursor || '';
      if(shouldKill(cur)){
        const now=Date.now();
        if(now-lastKill>120){ // throttle
          lastKill=now;
          _resetZoomCursor();
          _forceCursorKill();
        }
      }
    }catch(err){}
  },{passive:true});

  // Also run once on pointer up (touch end) to clear any cached cursor state after taps
  document.addEventListener('pointerup',function(){
    try{
      const mv=document.getElementById('mediaViewer');
      if(mv && mv.classList.contains('active')) return;
      _forceCursorKill();
    }catch(e){}
  },{passive:true});
})();


function _isMediaVisibleToPlayer(idx){
  const m=mediaItems[idx];
  if(!m) return false;
  if(!m.vaultLocked) return true;
  // Vault-locked items are visible only if their vault code has been unlocked
  return !!vaultCodes.find(c=>c.linkedMediaIdx===idx&&c.unlocked);
}
function _getVisibleMediaIndices(){
  const isAdmin=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  if(isAdmin) return mediaItems.map((_,i)=>i);
  return mediaItems.map((_,i)=>i).filter(i=>_isMediaVisibleToPlayer(i));
}
function navMedia(d){
  stopMvAudio();
  const vid=document.querySelector('.mv-video');if(vid)vid.pause();
  const visible=_getVisibleMediaIndices();
  if(!visible.length) return;
  const curPos=visible.indexOf(currentMediaIdx);
  // If current item isn't in visible list (edge case), jump to first visible
  const nextPos=curPos===-1?0:(curPos+d+visible.length)%visible.length;
  currentMediaIdx=visible[nextPos];
  const m=mediaItems[currentMediaIdx];
  showViewer(currentMediaIdx);
  if(m.type==='locked'&&!m.unlocked)renderLockedView(currentMediaIdx);
  else renderMediaContent(m);
}

function renderMediaContent(m){
  const body=document.getElementById('mvBody');
  const url=m.fileUrl||'';

  if(!url){
    body.innerHTML=`<div class="mv-no-file"><div class="mv-no-file-icon">${m.icon}</div><div class="mv-no-file-text">No file attached — add a URL via admin edit</div></div>`;
    return;
  }

  // Base64 or blob URLs can't be embedded in iframes — offer download/open
  if(url.startsWith('data:')||url.startsWith('blob:')){
    const isImage=url.startsWith('data:image')||isImageUrl(url);
    if(isImage){
      body.innerHTML=`<img class="mv-image-viewer" src="${url}" alt="${m.name}" onclick="this.classList.toggle('zoomed')">`;
    }else{
      body.innerHTML=`<div class="mv-no-file"><div class="mv-no-file-icon">${m.icon}</div><div class="mv-no-file-text">File uploaded locally — cannot preview in viewer.${allowDownloads?`<br><br><a href="${url}" download="${m.name||'file'}" style="color:var(--cyan);text-decoration:underline;font-size:11px;letter-spacing:1px">⬇ DOWNLOAD FILE</a>`:''}<br><br><span style="font-size:9px;color:#555">For persistent hosting, upload to Google Drive and paste the share link.</span></div></div>`;
    }
    return;
  }

  // Google Drive URL conversion for embedding
  const embedUrl=convertDriveUrl(url);

  switch(m.type){
    case 'audio':
      renderAudioPlayer(body,m,embedUrl.direct||url);break;
    case 'video':
      renderVideoPlayer(body,m,embedUrl);break;
    case 'doc':
    case 'map':
      renderDocViewer(body,m,url,embedUrl);break;
    case 'locked':
      if(m.unlocked)renderDocViewer(body,m,url,embedUrl);
      else renderLockedView(currentMediaIdx);break;
    default:
      renderDocViewer(body,m,url,embedUrl);
  }
}

// Resolve file URL — all media hosted on Netlify, pass through directly
function convertDriveUrl(url){
  if(!url)return{preview:url,direct:url,id:null};
  // Extract Google Drive file ID from any Drive URL format
  let id=null;
  const patterns=[
    /\/file\/d\/([a-zA-Z0-9_-]+)/,
    /[?&]id=([a-zA-Z0-9_-]+)/,
    /\/d\/([a-zA-Z0-9_-]+)/,
    /drive\.google\.com\/uc\?.*id=([a-zA-Z0-9_-]+)/,
    /drive\.google\.com\/thumbnail\?.*id=([a-zA-Z0-9_-]+)/
  ];
  for(const p of patterns){const m=url.match(p);if(m){id=m[1];break}}
  if(!id)return{preview:url,direct:url,id:null};
  return{
    id:id,
    direct:'https://drive.google.com/uc?export=view&id='+id,
    preview:'https://drive.google.com/file/d/'+id+'/preview',
    thumbnail:'https://drive.google.com/thumbnail?id='+id+'&sz=w400',
    download:'https://drive.google.com/uc?export=download&id='+id
  };
}

function isDriveUrl(url){return url&&/drive\.google\.com/i.test(url)}
function isImageUrl(url){return/\.(jpg|jpeg|png|gif|webp|svg|bmp)(\?|$)/i.test(url)||/drive\.google\.com\/(uc|thumbnail)/i.test(url)}
function isPdfUrl(url){return/\.pdf(\?|$)/i.test(url)||url.includes('/preview')}

function isMobileDevice(){
  try{
    const ua=navigator.userAgent||'';
    const touch=(('ontouchstart' in window) || (navigator.maxTouchPoints||0)>0);
    const small=(window.matchMedia && window.matchMedia('(max-width: 900px)').matches);
    return (small && (touch || /Mobi|Android|iPhone|iPad|iPod/i.test(ua)));
  }catch(e){
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent||'');
  }
}

let _mvPdfScale=1.25;
async function renderPdfJsViewer(body,pdfUrl,opts={}){
  const downloadUrl=opts.downloadUrl||pdfUrl;
  body.innerHTML=`
    <div class="mv-pdfjs-wrap">
      <div class="mv-pdfjs-toolbar">
        <button class="mv-pdfjs-btn" id="mvPdfZoomOut">ZOOM -</button>
        <button class="mv-pdfjs-btn" id="mvPdfZoomIn">ZOOM +</button>
        <a class="mv-pdfjs-btn" href="${downloadUrl}" target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">OPEN</a>
        ${allowDownloads?`<a class="mv-pdfjs-btn" href="${downloadUrl}" download target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">DOWNLOAD</a>`:''}
      </div>
      <div id="mvPdfPages"></div>
      <div class="mv-pdfjs-status" id="mvPdfStatus">Loading PDF…</div>
    </div>`;
  const pagesEl=document.getElementById('mvPdfPages');
  const statusEl=document.getElementById('mvPdfStatus');

  if(!window.pdfjsLib){
    statusEl.textContent='PDF preview unavailable (PDF.js not loaded). Use OPEN to view.';
    return;
  }

  const renderAll=async(scale)=>{
    pagesEl.innerHTML='';
    statusEl.textContent='Rendering…';
    const loadingTask=pdfjsLib.getDocument({url: pdfUrl, withCredentials:false});
    const pdf=await loadingTask.promise;
    const num=pdf.numPages;

    for(let i=1;i<=num;i++){
      const page=await pdf.getPage(i);
      const viewport=page.getViewport({scale});
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d',{alpha:false});
      canvas.width=Math.floor(viewport.width);
      canvas.height=Math.floor(viewport.height);
      const wrap=document.createElement('div');
      wrap.className='mv-pdfjs-page';
      wrap.appendChild(canvas);
      pagesEl.appendChild(wrap);
      await page.render({canvasContext:ctx,viewport}).promise;
    }
    statusEl.textContent=`${num} page${num===1?'':'s'} loaded.`;
  };

  let scale=_mvPdfScale;
  const safeRender=async()=>{
    try{ await renderAll(scale); }
    catch(err){
      console.warn('PDF.js render failed',err);
      statusEl.textContent='Could not render PDF in-app (likely CORS or browser restrictions). Use OPEN to view.';
    }
  };

  const zin=document.getElementById('mvPdfZoomIn');
  const zout=document.getElementById('mvPdfZoomOut');
  if(zin) zin.onclick=()=>{scale=Math.min(3,scale+0.25); safeRender();};
  if(zout) zout.onclick=()=>{scale=Math.max(0.75,scale-0.25); safeRender();};

  await safeRender();
}


// ── Audio Player ──
function renderAudioPlayer(body,m,url){
  body.innerHTML=`
    <div class="mv-audio-player">
      <div class="mv-audio-icon">🎧</div>
      <div class="mv-audio-title">${m.name}</div>
      <div class="mv-audio-controls">
        <div class="mv-audio-bar-wrap" id="mvAudioBarWrap" onclick="seekAudio(event)">
          <div class="mv-audio-bar" id="mvAudioBar"></div>
        </div>
        <div class="mv-audio-time"><span id="mvAudioCur">0:00</span><span id="mvAudioDur">0:00</span></div>
        <div class="mv-audio-btns">
          <div class="mv-audio-btn" onclick="skipAudio(-10)" title="Back 10s">⏪</div>
          <div class="mv-audio-btn" id="mvPlayBtn" onclick="toggleMvAudio()" title="Play/Pause">▶</div>
          <div class="mv-audio-btn" onclick="skipAudio(10)" title="Forward 10s">⏩</div>
        </div>
        <div class="mv-audio-vol">
          <span class="mv-audio-vol-icon" onclick="toggleMvMute()">🔊</span>
          <div class="mv-audio-vol-bar" onclick="setMvVolume(event)"><div class="mv-audio-vol-fill" id="mvVolFill"></div></div>
        </div>
      </div>
    </div>`;
  mvAudio=new Audio(url);
  mvAudio.addEventListener('loadedmetadata',()=>{document.getElementById('mvAudioDur').textContent=fmtTime(mvAudio.duration)});
  mvAudio.addEventListener('ended',()=>{
    document.getElementById('mvPlayBtn').textContent='▶';
    document.getElementById('mvPlayBtn').classList.remove('playing');
    clearInterval(mvAudioInterval);
  });
}

function toggleMvAudio(){
  if(!mvAudio)return;
  const btn=document.getElementById('mvPlayBtn');
  if(mvAudio.paused){
    mvAudio.play();btn.textContent='⏸';btn.classList.add('playing');
    mvAudioInterval=setInterval(updateAudioProgress,100);
  }else{
    mvAudio.pause();btn.textContent='▶';btn.classList.remove('playing');
    clearInterval(mvAudioInterval);
  }
}

function updateAudioProgress(){
  if(!mvAudio)return;
  const pct=(mvAudio.currentTime/mvAudio.duration)*100;
  const bar=document.getElementById('mvAudioBar');if(bar)bar.style.width=pct+'%';
  const cur=document.getElementById('mvAudioCur');if(cur)cur.textContent=fmtTime(mvAudio.currentTime);
}

function seekAudio(e){
  if(!mvAudio||!mvAudio.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  mvAudio.currentTime=pct*mvAudio.duration;
  updateAudioProgress();
}

function skipAudio(s){if(mvAudio)mvAudio.currentTime=Math.max(0,Math.min(mvAudio.duration,mvAudio.currentTime+s));updateAudioProgress()}

function setMvVolume(e){
  if(!mvAudio)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  mvAudio.volume=pct;
  document.getElementById('mvVolFill').style.width=(pct*100)+'%';
}

function toggleMvMute(){
  if(!mvAudio)return;
  mvAudio.muted=!mvAudio.muted;
  document.querySelector('.mv-audio-vol-icon').textContent=mvAudio.muted?'🔇':'🔊';
}

function stopMvAudio(){
  if(mvAudio){mvAudio.pause();mvAudio.currentTime=0;mvAudio=null}
  if(mvAudioInterval){clearInterval(mvAudioInterval);mvAudioInterval=null}
}

function fmtTime(s){if(!s||isNaN(s))return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+String(sec).padStart(2,'0')}

// ── Video Player ──
function renderVideoPlayer(body,m,eu){
  const url=m.fileUrl||'';
  const resolved=resolveVideoEmbed(url);
  
  if(resolved&&resolved.type==='direct'){
    // Direct video file — use custom player
    const src=eu.direct||eu.preview||resolved.url;
    body.innerHTML=`
      <div class="mv-video-wrap">
        <video class="mv-video" id="mvVideo" src="${src}" preload="metadata"></video>
        <div class="mv-video-controls">
          <div class="mv-video-play" id="mvVidPlay" onclick="toggleMvVideo()">▶</div>
          <div class="mv-video-bar" onclick="seekVideo(event)"><div class="mv-video-progress" id="mvVidProgress"></div></div>
          <span class="mv-video-time" id="mvVidTime">0:00</span>
          <span class="mv-video-full" onclick="fullscreenVideo()" title="Fullscreen">⛶</span>
        </div>
      </div>`;
    const vid=document.getElementById('mvVideo');
    vid.addEventListener('timeupdate',()=>{
      const pct=(vid.currentTime/vid.duration)*100;
      document.getElementById('mvVidProgress').style.width=pct+'%';
      document.getElementById('mvVidTime').textContent=fmtTime(vid.currentTime)+' / '+fmtTime(vid.duration);
    });
    vid.addEventListener('ended',()=>{document.getElementById('mvVidPlay').textContent='▶'});
    vid.addEventListener('click',toggleMvVideo);
  }else if(resolved&&resolved.type==='external'){
    // Non-embeddable platform
    body.innerHTML=`<div class="mv-video-wrap" style="display:flex;align-items:center;justify-content:center">${buildExternalLink(resolved)}</div>`;
  }else if(resolved&&(resolved.embed||resolved.type==='iframe-fallback')){
    // Embeddable platform — iframe
    body.innerHTML=`<div class="mv-video-wrap">${buildEmbedIframe(resolved,false,false)}</div>`;
  }else{
    // Fallback: try Google Drive preview (legacy behavior)
    const src=eu.direct||eu.preview;
    body.innerHTML=`
      <div class="mv-video-wrap">
        <video class="mv-video" id="mvVideo" src="${src}" preload="metadata"></video>
        <div class="mv-video-controls">
          <div class="mv-video-play" id="mvVidPlay" onclick="toggleMvVideo()">▶</div>
          <div class="mv-video-bar" onclick="seekVideo(event)"><div class="mv-video-progress" id="mvVidProgress"></div></div>
          <span class="mv-video-time" id="mvVidTime">0:00</span>
          <span class="mv-video-full" onclick="fullscreenVideo()" title="Fullscreen">⛶</span>
        </div>
      </div>`;
    const vid=document.getElementById('mvVideo');
    if(vid){
      vid.addEventListener('timeupdate',()=>{
        const pct=(vid.currentTime/vid.duration)*100;
        document.getElementById('mvVidProgress').style.width=pct+'%';
        document.getElementById('mvVidTime').textContent=fmtTime(vid.currentTime)+' / '+fmtTime(vid.duration);
      });
      vid.addEventListener('ended',()=>{document.getElementById('mvVidPlay').textContent='▶'});
      vid.addEventListener('click',toggleMvVideo);
    }
  }
}

function toggleMvVideo(){
  const vid=document.getElementById('mvVideo');if(!vid)return;
  const btn=document.getElementById('mvVidPlay');
  if(vid.paused){vid.play();btn.textContent='⏸'}else{vid.pause();btn.textContent='▶'}
}

function seekVideo(e){
  const vid=document.getElementById('mvVideo');if(!vid||!vid.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  vid.currentTime=(e.clientX-rect.left)/rect.width*vid.duration;
}

function fullscreenVideo(){
  const vid=document.getElementById('mvVideo');if(!vid)return;
  if(vid.requestFullscreen)vid.requestFullscreen();
  else if(vid.webkitRequestFullscreen)vid.webkitRequestFullscreen();
}

// ── Document / Map / PDF Viewer ──
function isOfficeDoc(url){return/\.(docx?|xlsx?|pptx?|csv)(\?|$)/i.test(url)}
function renderDocViewer(body,m,url,eu){
  const isDrive=!!eu.id;
  const isR2=url.includes('.workers.dev/file/');
  // Images
  if(isImageUrl(url)||(m.type==='map'&&(isImageUrl(url)||isDrive))){
    const src=isDrive?eu.direct:url;
    body.innerHTML=`<img class="mv-image-viewer" src="${src}" alt="${m.name}" onclick="this.classList.toggle('zoomed')" onerror="this.onerror=null;this.src='${isDrive?eu.thumbnail:url}'">`;
    return;
  }
  // Google Drive files: use /preview
  if(isDrive){
    body.innerHTML=`<iframe class="mv-pdf-frame" src="${eu.preview}" allow="autoplay" allowfullscreen></iframe>${allowDownloads?`<div style="text-align:center;margin-top:8px"><a href="${eu.download}" target="_blank" style="color:var(--cyan);font-family:\'Saira\',sans-serif;font-size:10px;letter-spacing:1.5px;text-decoration:none;opacity:.7">DOWNLOAD ORIGINAL</a></div>`:''}`;
    return;
  }
  // R2 files: serve directly in iframe (PDFs render natively, images via img)
  if(isR2){
    // On mobile, render PDFs in-app via PDF.js (iframes are unreliable on iOS Safari).
    if(isMobileDevice() && isPdfUrl(url)){
      renderPdfJsViewer(body,url,{downloadUrl:url});
      return;
    }
    const pdfBlock=(!allowDownloads&&url.match(/\.pdf/i))?'#toolbar=0&navpanes=0':'';
    body.innerHTML=`<iframe class="mv-pdf-frame" src="${url}${pdfBlock}" allowfullscreen></iframe>${allowDownloads?`<div style="text-align:center;margin-top:8px"><a href="${url}" download target="_blank" style="color:var(--cyan);font-family:\'Saira\',sans-serif;font-size:10px;letter-spacing:1.5px;text-decoration:none;opacity:.7">DOWNLOAD ORIGINAL</a></div>`:''}`;
    return;
  }
  // Office docs (non-Drive, non-R2)
  if(isOfficeDoc(url)){
    const officeUrl='https://view.officeapps.live.com/op/embed.aspx?src='+encodeURIComponent(url);
    body.innerHTML=`<iframe class="mv-pdf-frame" src="${officeUrl}" allowfullscreen></iframe>`;
    return;
  }
  // PDFs (non-Drive, non-R2)
  if(isPdfUrl(url)){
    // On mobile, render PDFs in-app via PDF.js (iframes are unreliable on iOS Safari).
    if(isMobileDevice()){
      renderPdfJsViewer(body,url,{downloadUrl:url});
      return;
    }
    const pdfBlock2=(!allowDownloads)?'#toolbar=0&navpanes=0':'';
    body.innerHTML=`<iframe class="mv-pdf-frame" src="${url}${pdfBlock2}" allowfullscreen></iframe>`;
    return;
  }
  // Fallback
  body.innerHTML=`<iframe class="mv-pdf-frame" src="${url}" allowfullscreen></iframe>${allowDownloads?`<div style="text-align:center;margin-top:8px"><a href="${url}" target="_blank" style="color:var(--cyan);font-family:\'Saira\',sans-serif;font-size:10px;letter-spacing:1.5px;text-decoration:none;opacity:.7">OPEN IN NEW TAB</a></div>`:''}`;
}
function renderLockedView(i){
  const m=mediaItems[i];
  const body=document.getElementById('mvBody');
  body.innerHTML=`
    <div class="mv-locked">
      <div class="mv-locked-icon">🔒</div>
      <div class="mv-locked-title">Encrypted File</div>
      <div class="mv-locked-desc">${m.desc}<br><br>Enter the decryption key to access this file.</div>
      <div class="mv-locked-input-wrap">
        <input class="mv-locked-input" id="mvLockKey" placeholder="ENTER KEY" autocomplete="off" spellcheck="false" onkeydown="if(event.key==='Enter')tryUnlock(${i})">
        <button class="mv-locked-submit" onclick="tryUnlock(${i})">DECRYPT</button>
      </div>
      <div id="mvLockErr" style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--red);letter-spacing:1px;height:16px"></div>
    </div>`;
}

function tryUnlock(i){
  const m=mediaItems[i];
  const key=document.getElementById('mvLockKey').value.trim();
  // Admin can set an unlock key on each locked item (default: any non-empty input unlocks for demo)
  if(!key){document.getElementById('mvLockErr').textContent='Enter a decryption key';return}
  if(m.unlockKey&&key.toUpperCase()!==m.unlockKey.toUpperCase()){
    document.getElementById('mvLockErr').textContent='✗ INVALID KEY — ACCESS DENIED';
    playDenied();return;
  }
  m.unlocked=true;
  playSuccess();
  if(m.fileUrl)renderMediaContent(m);
  else document.getElementById('mvBody').innerHTML=`<div class="mv-no-file"><div class="mv-no-file-icon">🔓</div><div class="mv-no-file-text">File decrypted — no file attached yet</div></div>`;
  renderMedia();
}

// ══════ ADMIN ══════
let isAdmin=false;
// ═══════ BACKEND API ═══════
// ══════ API CONFIGURATION ══════
// Cloudflare Worker backend (replaces Google Apps Script)
const API_URL='https://cb-api.sriempex.workers.dev';
const R2_URL='https://cb-media.sriempex.workers.dev';
let adminSession=null; // {username, role, adminToken}
let adminUsers=[]; // populated from backend on admin list fetch
let manualTeams=[];

// Security: Rate limiter for API calls
const _apiRateLimit={lastCall:0,minInterval:100,burst:0,maxBurst:30};
function _checkRateLimit(){
  const now=Date.now();
  if(now-_apiRateLimit.lastCall<_apiRateLimit.minInterval){
    _apiRateLimit.burst++;
    if(_apiRateLimit.burst>_apiRateLimit.maxBurst){console.warn('API rate limit hit');return false}
  }else{_apiRateLimit.burst=Math.max(0,_apiRateLimit.burst-1)}
  _apiRateLimit.lastCall=now;
  return true;
}
async function apiCall(action,data={}){
  if(!_checkRateLimit()&&!['loginTeam','login','getEventConfig'].includes(action)){
    console.warn('Rate limited:',action);
    return{ok:false,error:'Too many requests. Please slow down.'};
  }
  try{
    // Build JSON POST body — clean format for Cloudflare Worker
    const body={action,...data};
    if(adminSession&&!['login','loginTeam','validateUsername'].includes(action))body.adminToken=adminSession.adminToken;
    const resp=await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const text=await resp.text();
    try{const result=JSON.parse(text);
      // Detect session invalidation — force re-login
      if(!result.ok&&result.error&&(result.error.includes('expired')||result.error.includes('Invalid or expired'))){
        if(isAdmin){
          alert('Admin session expired. Please log in again.');
          clearSession();location.reload();
          return result;
        }
      }
      return result}
    catch(e){console.error('Parse error:',text.substring(0,200));return {ok:false,error:'Invalid response from server'}}
  }catch(err){
    console.error('API error:',err);
    return {ok:false,error:'Network error — check connection'};
  }
}

// ── Local content cache — instant restore on refresh ──
// Saves posts/media/intel to localStorage so page refreshes don't wait for backend
function _cacheContent(key,data){
  try{localStorage.setItem(key,JSON.stringify(data))}catch(e){}
}

// ── Media item normalization (Evidence Locker) ──
// Backend storage historically used {title,url,filename}. UI expects {name,fileUrl,icon}.
// Normalize aggressively so items never render as "undefined" after refresh or re-fetch.
function _normalizeMediaItem(m){
  if(!m||typeof m!=='object')return {name:'',desc:'',fileUrl:'',type:'image'};
  const name = (m.name!=null?m.name:m.title)!=null ? String(m.name!=null?m.name:m.title) : '';
  const desc = (m.desc!=null?m.desc:m.description)!=null ? String(m.desc!=null?m.desc:m.description) : '';
  const fileUrl = (m.fileUrl!=null?m.fileUrl:m.url)!=null ? String(m.fileUrl!=null?m.fileUrl:m.url) : '';
  const icon = (m.icon!=null?m.icon:m.filename)!=null ? String(m.icon!=null?m.icon:m.filename) : '';
  const out = Object.assign({}, m);
  out.name = name;
  out.title = name;           // legacy mirror
  out.desc = desc;
  out.fileUrl = fileUrl;
  out.url = fileUrl;          // legacy mirror
  out.icon = icon;
  out.filename = icon;        // legacy mirror
  out.type = out.type || (fileUrl && /\.(mp3|wav|ogg|aac|flac)(\?|#|$)/i.test(fileUrl) ? 'audio'
                     : fileUrl && /\.(mp4|webm|mov|m4v)(\?|#|$)/i.test(fileUrl) ? 'video'
                     : 'image');
  return out;
}
function _normalizeMediaItems(arr){
  if(!Array.isArray(arr))return [];
  return arr.map(_normalizeMediaItem);
}

function _restoreContentCache(){
  let restored=false;
  try{
    const cv=localStorage.getItem('cb_contentVersion');
    if(!cv){
      localStorage.removeItem('cb_posts');
      localStorage.removeItem('cb_media');
      localStorage.removeItem('cb_intel');
      return false;
    }
  }catch(e){}
  try{
    const cp=localStorage.getItem('cb_posts');
    if(cp){const arr=JSON.parse(cp);posts.length=0;arr.forEach(p=>posts.push(p));restored=true;}
  }catch(e){}
  try{
    const cm=localStorage.getItem('cb_media');
    if(cm){const arr=_normalizeMediaItems(JSON.parse(cm));mediaItems.length=0;arr.forEach(m=>mediaItems.push(m));syncVaultCodesFromMedia();restored=true;}
  }catch(e){}
  try{
    const ci=localStorage.getItem('cb_intel');
    if(ci){
      const arr=JSON.parse(ci);
      intelFields.length=0;
      arr.forEach(f=>{
        // Normalize legacy shapes so money/phone/etc render correctly on first open (pre-refresh)
        if(f && typeof f==='object'){
          if(!f.type && f.fieldType) f.type=f.fieldType;
          if(!f.fieldType && f.type) f.fieldType=f.type;
        }
        intelFields.push(f);
      });
      restored=true;
    }
  }catch(e){}
  // Restore grid theme immediately so first paint uses the correct theme
  try{
    const cachedTheme=localStorage.getItem('cb_gridTheme');
    if(cachedTheme){_currentGridTheme=cachedTheme;applyGridTheme(cachedTheme);updateThemeLabel()}
  }catch(e){}
  // Restore operation name/font so console title doesn't flash
  try{
    const cachedOp=localStorage.getItem('cb_opName');
    if(cachedOp){operationName=cachedOp;const ct=document.getElementById('consoleTitle');if(ct)ct.textContent='◈ '+operationName;document.title=operationName+' — Console'}
    const cachedOpFont=localStorage.getItem('cb_opFont');
    if(cachedOpFont){operationFont=cachedOpFont;applyOperationFont(operationFont)}
  }catch(e){}
  return restored;
}

async function loadEventData(){
  // Parallel fetch — Cloudflare Workers handle concurrent requests efficiently
  const [config, feedResult, mediaResult, intelResult, teamsResult, subResult] = await Promise.all([
    apiCall('getEventConfig'),
    apiCall('getFeedPosts'),
    apiCall('getMediaItems'),
    apiCall('getIntelFields'),
    isAdmin ? apiCall('getTeams') : Promise.resolve({ok:false}),
    isAdmin ? apiCall('getSubmissions') : Promise.resolve({ok:false})
  ]);

  // Apply config first (affects rendering of everything else)
  if(config.ok&&config.config)applyEventConfig(config.config);

  if(feedResult.ok&&Array.isArray(feedResult.posts)){
    if(_saveFeedTimer||_feedSaveInFlight||Date.now()<_feedSaveCooldown){
      console.log('[FEED] loadEventData skipped — save cooldown active');
    }else{
      posts.length=0;
      feedResult.posts.forEach(p=>posts.push(p));
      _cacheContent('cb_posts',posts);
      renderFeed();renderGrid();
      if(currentFeedView==='single')renderSinglePost();
    }
  }

  if(mediaResult.ok&&Array.isArray(mediaResult.items)){
    if(_saveMediaTimer||_mediaSaveInFlight||Date.now()<_mediaSaveCooldown){
      console.log('[MEDIA] loadEventData skipped — save cooldown active');
    }else{
    mediaItems.length=0;
    mediaResult.items.forEach(m=>mediaItems.push({
      icon:m.filename||'📄',name:m.title||'',nameFont:m.titleFont||'',
      desc:m.desc||'',descFont:m.descFont||'',
      type:m.type||'doc',fileUrl:m.url||'',
      vaultLocked:m.vaultLocked||false,
      unlockKey:m.unlockKey||'',
      unlocked:m.unlocked||false,
      vaultCode:m.vaultCode||'',
      vaultCodename:m.vaultCodename||''
    }));
    syncVaultCodesFromMedia();
    _cacheContent('cb_media',mediaItems);
    renderMedia();renderGrid();
    }
  }

  if(intelResult.ok&&Array.isArray(intelResult.fields)){
    intelFields.length=0;
    intelResult.fields.forEach(f=>intelFields.push({
      label:f.label||'',emoji:f.emoji||'',type:f.fieldType||'text',
      font:f.font||'',inputFont:f.inputFont||'',answer:f.answer||{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}
    }));
    _cacheContent('cb_intel',intelFields);
    renderIntelForm();renderGrid();
  }

  if(teamsResult.ok&&teamsResult.teams){
    registeredTeams.length=0;manualTeams.length=0;
    teamsResult.teams.forEach(t=>{
      const team={id:t.teamId,name:t.teamName,type:t.type,members:t.members.map(m=>typeof m==='string'?m:m.name),memberDetails:t.members,lastActive:new Date(t.lastActive).getTime(),fieldsCompleted:0,submitTime:null,registeredAt:t.registeredAt,submissionResults:null};
      if(t.manual)manualTeams.push(team);
      registeredTeams.push(team);
    });
    renderPortalUsersList();
  }

  renderVaultPanel();renderKeysCodes();

  if(subResult.ok&&subResult.submissions){
    subResult.submissions.forEach(s=>{
      const team=registeredTeams.find(t=>t.id===s.teamId);
      if(team){
        team.submitTime=s.submittedAt;
        team.submissionResults={totalScore:s.score,totalPossible:s.totalPossible||0,correctCount:s.correct,totalFields:s.total};
      }
    });
  }

  refreshAdminList();
  startGlobalEventTimer();
}

function applyEventConfig(cfg){
  // Content version check — nuke stale cache if version mismatch or missing
  try{
    const cachedVer=localStorage.getItem('cb_contentVersion')||'';
    const serverVer=cfg.contentVersion?String(cfg.contentVersion):'';
    if(!serverVer){
      localStorage.removeItem('cb_posts');
      localStorage.removeItem('cb_media');
      localStorage.removeItem('cb_intel');
      localStorage.removeItem('cb_contentVersion');
    }else if(cachedVer!==serverVer){
      if(cachedVer && parseInt(cachedVer) > parseInt(serverVer)){
      }else{
        localStorage.removeItem('cb_posts');
        localStorage.removeItem('cb_media');
        localStorage.removeItem('cb_intel');
        // Do NOT clear the in-memory arrays here — loadEventData will overwrite them
        // momentarily. Clearing them causes a flash of "0 ITEMS" on the grid.
        localStorage.setItem('cb_contentVersion',serverVer);
      }
    }else{
    }
  }catch(e){}
  if(cfg.operationName){operationName=cfg.operationName;const ct=document.getElementById('consoleTitle');if(ct)ct.textContent='◈ '+operationName;document.title=operationName+' — Console';try{localStorage.setItem('cb_opName',cfg.operationName)}catch(e){}}
  if(cfg.operationFont){operationFont=cfg.operationFont;applyOperationFont(operationFont);try{localStorage.setItem('cb_opFont',cfg.operationFont)}catch(e){}}
  if(cfg.gridTheme){_currentGridTheme=cfg.gridTheme;applyGridTheme(cfg.gridTheme);updateThemeLabel();try{localStorage.setItem('cb_gridTheme',cfg.gridTheme)}catch(e){}}
  if(cfg.intelTheme){applyIntelTheme(cfg.intelTheme)}
  if(cfg.participantMode){regSettings.participantMode=cfg.participantMode;const sel=document.getElementById('apParticipantMode');if(sel)sel.value=cfg.participantMode;
    // Refresh login prompt if on login screen and nothing typed yet
    const lid=document.getElementById('loginId');if(lid&&!lid.value.trim()){setLoginStatus(getLoginPrompt(),'')}
  }
  if(cfg.leaderboardStyle){regSettings.leaderboardStyle=cfg.leaderboardStyle;const sel=document.getElementById('apLeaderboardStyle');if(sel)sel.value=cfg.leaderboardStyle}
  if(cfg.landingTitle){regSettings.landingTitle=cfg.landingTitle;const el=document.getElementById('landingTitleEl');if(el)el.textContent=cfg.landingTitle;const inp=document.getElementById('apLandingTitle');if(inp)inp.value=cfg.landingTitle}
  if(cfg.landingSubtitle){regSettings.landingSubtitle=cfg.landingSubtitle;const el=document.getElementById('landingSubEl');if(el)el.textContent=cfg.landingSubtitle;const inp=document.getElementById('apLandingSubtitle');if(inp)inp.value=cfg.landingSubtitle}
  if(cfg.teamSizeMin){regSettings.teamSizeMin=parseInt(cfg.teamSizeMin);const sel=document.getElementById('apMinSize');if(sel)sel.value=cfg.teamSizeMin}
  if(cfg.teamSizeMax){regSettings.teamSizeMax=parseInt(cfg.teamSizeMax);const sel=document.getElementById('apMaxSize');if(sel)sel.value=cfg.teamSizeMax}
  if(cfg.maxTeams){regSettings.maxTeams=parseInt(cfg.maxTeams);const inp=document.getElementById('apMaxTeams');if(inp)inp.value=cfg.maxTeams}
  if(cfg.bannerFallback)regSettings.bannerFallback=cfg.bannerFallback;
  if(cfg.activeToIdle)activityThresholds.activeToIdle=parseInt(cfg.activeToIdle);
  if(cfg.idleToSilent)activityThresholds.idleToSilent=parseInt(cfg.idleToSilent);
  // Console background
  if(cfg.consoleBgColor||cfg.consoleBgTexture)syncConsoleBgFromConfig(cfg);
  // Landing banner
  if(cfg.landingBannerUrl!==undefined){regSettings.landingBannerUrl=cfg.landingBannerUrl;applyBannerImage(cfg.landingBannerUrl);syncBannerPreview()}
  // Registration settings
  if(cfg.requireEmail!==undefined){regSettings.requireEmail=cfg.requireEmail==='true'||cfg.requireEmail===true;const cb=document.getElementById('apReqEmail');if(cb)cb.checked=regSettings.requireEmail}
  if(cfg.requirePhone!==undefined){regSettings.requirePhone=cfg.requirePhone==='true'||cfg.requirePhone===true;const cb=document.getElementById('apReqPhone');if(cb)cb.checked=regSettings.requirePhone}
  if(cfg.requireDept!==undefined){regSettings.requireDept=cfg.requireDept==='true'||cfg.requireDept===true;const cb=document.getElementById('apReqDept');if(cb)cb.checked=regSettings.requireDept}
  if(cfg.registrationOpen!==undefined){
    regSettings.registrationOpen=cfg.registrationOpen==='true'||cfg.registrationOpen===true;
    const cb=document.getElementById('apRegOpen');if(cb)cb.checked=regSettings.registrationOpen;
    const status=document.getElementById('apRegStatus');
    if(status){status.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';status.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)'}
  }
  // Vault settings
  if(cfg.vaultMaxAttempts!==undefined){regSettings.vaultMaxAttempts=parseInt(cfg.vaultMaxAttempts)}
  if(cfg.vaultCooldownSec!==undefined){regSettings.vaultCooldownSec=parseInt(cfg.vaultCooldownSec)}
  if(cfg.vaultUnlimitedAttempts!==undefined){regSettings.vaultUnlimitedAttempts=cfg.vaultUnlimitedAttempts==='true'||cfg.vaultUnlimitedAttempts===true}
  if(cfg.sessionPersist!==undefined){regSettings.sessionPersist=cfg.sessionPersist==='true'||cfg.sessionPersist===true;const cb=document.getElementById('apSessionPersist');if(cb)cb.checked=regSettings.sessionPersist;try{localStorage.setItem('cb_sessionPersist',String(regSettings.sessionPersist))}catch(e){}}
  // Event timer
  if(cfg.eventStartTime){eventSettings.startTime=cfg.eventStartTime;const inp=document.getElementById('eventStartInput');if(inp)inp.value=cfg.eventStartTime.substring(0,16)}
  if(cfg.eventEndTime){eventSettings.endTime=cfg.eventEndTime;const inp=document.getElementById('eventEndInput');if(inp)inp.value=cfg.eventEndTime.substring(0,16)}
  if(cfg.eventAutoLock!==undefined){eventSettings.autoLock=cfg.eventAutoLock==='true'||cfg.eventAutoLock===true;const cb=document.getElementById('eventAutoLock');if(cb)cb.checked=eventSettings.autoLock}
  if(cfg.eventShowLeaderboardOnExpiry!==undefined){eventSettings.showLeaderboardOnExpiry=cfg.eventShowLeaderboardOnExpiry==='true'||cfg.eventShowLeaderboardOnExpiry===true;const cb=document.getElementById('eventShowLeaderboard');if(cb)cb.checked=eventSettings.showLeaderboardOnExpiry}
  if(cfg.allowDownloads!==undefined){allowDownloads=cfg.allowDownloads==='true'||cfg.allowDownloads===true}
  if(cfg.timerMode){
    timerMode=cfg.timerMode;
    if(cfg.timerSec!==undefined){timerSec=parseInt(cfg.timerSec)||0;}
    if(cfg.timerOriginal!==undefined){timerOriginal=parseInt(cfg.timerOriginal)||timerSec;}
    if(cfg.timerPaused!==undefined){timerPaused=(cfg.timerPaused==='true'||cfg.timerPaused===true);}
    if(cfg.timerStarted!==undefined){timerStarted=(cfg.timerStarted==='true'||cfg.timerStarted===true);}
    if(cfg.eventStartTime!==undefined){eventSettings.startTime=cfg.eventStartTime||null;}
    if(cfg.eventEndTime!==undefined){eventSettings.endTime=cfg.eventEndTime||null;}
    if(cfg.eventExpired!==undefined){eventSettings.expired=(cfg.eventExpired==='true'||cfg.eventExpired===true);}
    const sel=document.getElementById('timerMode');
    if(sel){sel.value=timerMode;}
    // Apply mode UI without overwriting restored values
    window.__applyingCfg=true;
    onTimerModeChange();
    window.__applyingCfg=false;
    updateAdminTimerDisplay();
    renderTimer();
  }
  // Scoring config
  if(cfg.scoringConfig){try{Object.assign(scoringConfig,JSON.parse(cfg.scoringConfig))}catch(e){}}
  // Typography fontConfig
  if(cfg.fontConfig&&typeof cfg.fontConfig==='object'){
    Object.assign(fontConfig,cfg.fontConfig);
    applyFontConfig();
  }
  // Grid tile customisations (label, icon, sub, fonts)
  let _gridTilesChanged=false;
  if(cfg.gridTiles&&Array.isArray(cfg.gridTiles)){
    cfg.gridTiles.forEach(saved=>{
      const tile=gridTiles.find(t=>t.id===saved.id);
      if(tile){
        if(saved.icon&&tile.icon!==saved.icon){tile.icon=saved.icon;_gridTilesChanged=true}
        if(saved.label&&tile.label!==saved.label){tile.label=saved.label;_gridTilesChanged=true}
        if(saved.sub!==undefined&&tile.sub!==saved.sub){tile.sub=saved.sub;_gridTilesChanged=true}
        if((saved.labelFont||'')!==tile.labelFont){tile.labelFont=saved.labelFont||'';_gridTilesChanged=true}
        if((saved.subFont||'')!==tile.subFont){tile.subFont=saved.subFont||'';_gridTilesChanged=true}
      }
    });
  }
  if(_gridTilesChanged)renderGrid();
  // Sync threshold UI
  const idleInp=document.getElementById('apThresholdIdle');if(idleInp)idleInp.value=activityThresholds.activeToIdle;
  const silentInp=document.getElementById('apThresholdSilent');if(silentInp)silentInp.value=activityThresholds.idleToSilent;
  // Update landing page labels based on participant mode
  updateLandingForMode();
  updateEventStatus();
  startGlobalEventTimer();
  // Tutorial & briefing config
  applyTutorialBriefingConfig(cfg);

  // Mark config hydration complete — prevents settings values flashing then reverting on refresh
  if(!window.__configHydrated){
    window.__configHydrated=true;
    _eventCfgHydrated=true;
    try{document.body.classList.remove('config-hydrating')}catch(e){}
    try{renderTimer()}catch(e){}
    document.documentElement.classList.remove('is-hydrating-settings');
    try{document.dispatchEvent(new Event('cb:configHydrated'))}catch(e){}
  }

}

// Admin auth now handled via login screen (submitLogin)
function adminGoVault(){document.getElementById('adminChoiceModal').classList.remove('active');goToLogin()}
function adminGoConsole(){document.getElementById('adminChoiceModal').classList.remove('active');goToConsole()}

// ── Admin dropdown ──
function handleAdminTrigger(){
  const dd=document.getElementById('adminDropdown');
  if(dd.classList.contains('open')){closeAdminDropdown()}else{openAdminDropdown()}
}
function openAdminDropdown(){
  syncAdminDropdownToggles();
  document.getElementById('adminDropdown').classList.add('open');
}
function closeAdminDropdown(){document.getElementById('adminDropdown').classList.remove('open')}
function syncAdminDropdownToggles(){
  const ppEl=document.getElementById('admPreviewToggle');
  const isPreview=document.body.classList.contains('player-preview');
  if(ppEl){ppEl.textContent=isPreview?'ON':'OFF';ppEl.className='adm-toggle '+(isPreview?'on-green':'off')}
}
function toggleAllowDownloads(val){
  allowDownloads=typeof val==='boolean'?val:!allowDownloads;
  const cb=document.getElementById('apAllowDownloads');
  if(cb)cb.checked=allowDownloads;
  saveEventConfigToBackend();
}
// Close dropdown when clicking outside
document.addEventListener('click',e=>{
  const dd=document.getElementById('adminDropdown');
  const trigger=document.getElementById('adminTrigger');
  if(dd.classList.contains('open')&&!dd.contains(e.target)&&!trigger.contains(e.target)){closeAdminDropdown()}
});

function toggleEditMode(){
  // Edit mode removed — admin always has edit power via hover-reveal
  // Kept for backward compatibility
}
function togglePlayerPreview(){
  const isPreview=document.body.classList.contains('player-preview');
  if(!isPreview){
    document.body.classList.add('player-preview');
    // Set a placeholder team name for preview
    const teamEl=document.querySelector('.console-team');
    if(teamEl&&teamEl.childNodes[0])teamEl.childNodes[0].textContent='TEAM PREVIEW ';
    // Show exit button where gear icon sits (bottom-right, same size/shape)
    let pill=document.getElementById('previewExitPill');
    if(!pill){
      pill=document.createElement('div');
      pill.id='previewExitPill';
      pill.style.cssText='display:none';
      pill.innerHTML='<span style="font-size:16px;line-height:1">👁</span>';
      pill.title='Exit Player Preview';
      pill.onclick=togglePlayerPreview;
      document.body.appendChild(pill);
    }
    pill.style.display='flex';
  }else{
    document.body.classList.remove('player-preview');
    // Restore admin display
    const teamEl=document.querySelector('.console-team');
    if(teamEl&&teamEl.childNodes[0])teamEl.childNodes[0].textContent='ADMINISTRATOR ';
    // Hide exit pill
    const pill=document.getElementById('previewExitPill');
    if(pill)pill.style.display='none';
  }
  renderGrid();renderFeed();renderMedia();renderIntelForm();renderVaultPanel();
  if(document.getElementById('fvSingle')?.classList.contains('active'))renderSinglePost();
  syncAdminDropdownToggles();
  closeAdminDropdown();
}
// Global keyboard shortcuts
document.addEventListener('keydown',e=>{
  // Media viewer
  if(document.getElementById('mediaViewer').classList.contains('active')){
    if(e.key==='Escape')closeMediaViewer();
    if(e.key==='ArrowLeft')navMedia(-1);
    if(e.key==='ArrowRight')navMedia(1);
    if(e.key===' '&&mvAudio){e.preventDefault();toggleMvAudio()}
    if(e.key===' '&&document.getElementById('mvVideo')){e.preventDefault();toggleMvVideo()}
    return;
  }
  // Feed focus mode — arrow keys navigate posts
  const feedOpen=document.getElementById('expFeed')?.classList.contains('visible');
  if(feedOpen&&currentFeedView==='single'){
    if(e.key==='ArrowLeft'){e.preventDefault();navPost(-1)}
    if(e.key==='ArrowRight'){e.preventDefault();navPost(1)}
    if(e.key==='Escape'){e.preventDefault();setFeedView('grid')}
    return;
  }
  // Vault keypad — type with physical keyboard
  const vaultOpen=document.getElementById('expVault')?.classList.contains('visible');
  if(vaultOpen&&!e.target.closest('input,textarea,select')){
    const key=e.key;
    if(key==='Enter'){e.preventDefault();vkSubmit();return}
    if(key==='Backspace'){e.preventDefault();vkDel();return}
    if(key==='Escape'){e.preventDefault();vkClear();return}
    if(key==='Delete'){e.preventDefault();vkClear();return}
    if(/^[a-zA-Z0-9]$/.test(key)){e.preventDefault();vkType(key.toUpperCase());return}
    if(vkSymMode&&/^[!@#$%^&*()\-_=+\[\]{};:'",.<>/?\\|`~]$/.test(key)){e.preventDefault();vkType(key);return}
  }
  // Escape closes expanded panel
  if(overlay.classList.contains('active')&&e.key==='Escape'){
    e.preventDefault();closePanel();return;
  }
  // Escape closes landing preview
  if(document.getElementById('landingPreviewOverlay').classList.contains('active')&&e.key==='Escape'){
    e.preventDefault();closeLandingPreview();return;
  }
  // Escape closes theme preview
  if(document.getElementById('themePreviewOverlay').style.display==='flex'&&e.key==='Escape'){
    e.preventDefault();closeThemePreview();return;
  }
  // Arrow keys cycle themes in preview
  if(document.getElementById('themePreviewOverlay').style.display==='flex'){
    if(e.key==='ArrowLeft'){e.preventDefault();cycleThemePreview(-1);return}
    if(e.key==='ArrowRight'){e.preventDefault();cycleThemePreview(1);return}
    if(e.key==='Enter'){e.preventDefault();applyThemeFromPreview();return}
  }
  // Escape closes intel theme preview
  if(document.getElementById('intelThemePreviewOverlay').style.display==='flex'&&e.key==='Escape'){
    e.preventDefault();closeIntelThemePreview();return;
  }
  // Arrow keys cycle intel themes in preview
  if(document.getElementById('intelThemePreviewOverlay').style.display==='flex'){
    if(e.key==='ArrowLeft'){e.preventDefault();cycleIntelThemePreview(-1);return}
    if(e.key==='ArrowRight'){e.preventDefault();cycleIntelThemePreview(1);return}
    if(e.key==='Enter'){e.preventDefault();applyIntelThemeFromPreview();return}
  }
  // Escape closes active admin panels or returns from admin pages
  if(e.key==='Escape'){
    // Admin pages — return to console
    if(_currentAdminPage){e.preventDefault();returnFromAdminPage();return}
    // Broadcast overlay
    const bcEl=document.getElementById('broadcastPanel');
    if(bcEl&&bcEl.classList.contains('active')){e.preventDefault();closeBroadcast();return}
    // Gear dropdown
    const gdd=document.getElementById('gearDropdown');
    if(gdd&&gdd.classList.contains('open')){e.preventDefault();closeGearDropdown();return}
    // Login screen — contextual back
    const curScreen=document.querySelector('.screen.active')?.id||'';
    if(curScreen==='loginScreen'){e.preventDefault();loginBack();return}
    if(curScreen==='regScreen'){e.preventDefault();regBack();return}
    const adminIds=['adminPanel','broadcastPanel','leaderboardModule','keysCodesPanel','dashboardPanel','portalUsersPanel','scoringPanel','registrationPanel','appearancePanel','sessionMgmtPanel','tutorialConfigPanel'];
    for(const id of adminIds){
      const el=document.getElementById(id);
      if(el&&el.classList.contains('active')){
        e.preventDefault();
        if(id==='adminPanel')closeEventSettings();
        else if(id==='broadcastPanel')closeBroadcast();
        else if(id==='leaderboardModule')closeLeaderboard();
        else if(id==='keysCodesPanel')closeKeysCodes();
        else if(id==='dashboardPanel')closeDashboard();
        else if(id==='portalUsersPanel')closePortalUsers();
        else if(id==='scoringPanel')closeScoringPanel();
        else if(id==='registrationPanel')closeRegistrationPanel();
        else if(id==='appearancePanel')closeAppearancePanel();
        else if(id==='sessionMgmtPanel')closeSessionMgmt();
        else if(id==='tutorialConfigPanel')closeTutorialConfig();
        return;
      }
    }
  }
});
document.addEventListener('contextmenu',e=>{
  if(e.target.closest('.feed-card-img')||e.target.closest('.feed-single-img')||e.target.closest('.mv-body')||e.target.closest('.no-download-shield'))e.preventDefault();
});
function exitAdmin(){isAdmin=false;document.body.classList.remove('admin-mode');closeAdminDropdown();closeAdminPanel();closeBroadcast();closeLeaderboard();closeKeysCodes();renderGrid();renderIntelForm()}

// ══════ SCREEN NAVIGATION ══════
// Config hydration flag (prevents settings value flicker on refresh)
if(window.__configHydrated===undefined)window.__configHydrated=false;

let _currentScreen='landingScreen';
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');_currentScreen=id;const lb=document.getElementById('logoutBtn');if(lb)lb.classList.toggle('visible',id==='consoleScreen');if(id!=='settingsScreen'){_currentAdminPage=null;updateGearIcon()}if(currentVaultTeam)saveSession()
  // Preload hidden panels so Intelligence Feed / Evidence Locker are populated immediately after login.
  // (Previously they only rendered on first open via openPanel(), which made them appear empty until clicked.)
  if(id==='consoleScreen'){
    setTimeout(()=>{
      try{renderGrid();}catch(e){}
      try{renderFeed();}catch(e){}
      try{renderMedia();}catch(e){}
      try{renderIntelForm();}catch(e){}
      try{restoreIntelDraft&&restoreIntelDraft();}catch(e){}
      try{updateIntelBadge&&updateIntelBadge();}catch(e){}
      try{syncVaultCodesFromMedia&&syncVaultCodesFromMedia();}catch(e){}
      // Pull fresh backend state in the background (no panel open required)
      try{_refreshPanelData&&_refreshPanelData('feed');}catch(e){}
      try{_refreshPanelData&&_refreshPanelData('media');}catch(e){}
      try{_refreshPanelData&&_refreshPanelData('intel');}catch(e){}
    },0);
  }
  try{_forceCursorKill();}catch(e){}
}
function goToRegistration(){
  const mode=regSettings.participantMode||'team';
  // Update registration screen text based on mode
  const title=document.getElementById('regScreenTitle');
  const sub=document.getElementById('regScreenSubtitle');
  const typeChoice=document.getElementById('regTypeChoice');
  if(mode==='individual'){
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Individual Registration';
    if(typeChoice)typeChoice.style.display='none';
  }else if(mode==='hybrid'){
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Registration Portal';
    if(typeChoice)typeChoice.style.display='flex';
  }else{
    if(title)title.textContent=operationName;
    if(sub)sub.textContent='Team Registration Portal';
    if(typeChoice)typeChoice.style.display='none';
  }
  buildRegForm();
  if(window._histPush)window._histPush('register');
  showScreen('regScreen');
}
function goToLogin(){
  resetLoginScreen();
  if(window._histPush)window._histPush('login');
  showScreen('loginScreen');
  setTimeout(()=>document.getElementById('loginId').focus(),300);
}
function setRegLed(state){
  const led=document.getElementById('regLed');
  if(!led)return;
  led.className='login-led'+(state?' '+state:'');
}
function setRegStatus(text,cls){
  const el=document.getElementById('regCrtStatus');
  if(!el)return;
  el.className='login-crt-status'+(cls?' '+cls:'');
  el.innerHTML=text;
  const div=document.getElementById('regCrtDivider');
  if(div)div.style.display=text?'':'none';
}
function regBack(){
  // ESC on registration goes back to login screen
  setRegLed('');setRegStatus('');
  showScreen('loginScreen');
  setTimeout(()=>document.getElementById('loginId').focus(),300);
}
function goToConsole(){
  if(window._histPush)window._histPush('console');
  showScreen('consoleScreen');document.getElementById('notepadTrigger').classList.add('visible');startElapsedTimer();
  renderGrid(); // Ensure grid renders even if config hasn't loaded yet
  // If no team loaded (admin direct entry), show admin identity
  if(!currentVaultTeam&&isAdmin){
    currentVaultTeam={id:'ADMIN',name:'ADMIN',displayName:'ADMINISTRATOR',type:'admin',members:['Admin'],memberDetails:[]};
    updateConsoleForTeam(currentVaultTeam);
  }
}
function selectRegType(el){
  document.querySelectorAll('.reg-type-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  currentRegType=el.dataset.type;
  buildRegForm();
}

// ══════ LANDING PAGE ══════
function updateLandingForMode(){
  const mode=regSettings.participantMode||'team';
  const regText=document.getElementById('loginRegText');
  const regAction=document.getElementById('loginRegAction');
  const regLink=document.getElementById('loginRegLink');
  
  if(!regText)return;
  if(regLink)regLink.style.display=regSettings.registrationOpen===false?'none':'';
  const crtLabel=document.getElementById('loginCrtLabel');
  if(mode==='team'){
    regText.textContent="Don't have a Team ID?";
    regAction.textContent='Register your team';
    if(crtLabel)crtLabel.textContent='TEAM ID';
  }else if(mode==='individual'){
    regText.textContent="Need to register?";
    regAction.textContent='Sign up here';
    if(crtLabel)crtLabel.textContent='USER ID';
  }else{
    regText.textContent="Need to register?";
    regAction.textContent='Sign up here';
    if(crtLabel)crtLabel.textContent='TEAM / USER ID';
  }
}
function updateLandingBanner(){
  const url=regSettings.landingBannerUrl||'';
  applyBannerImage(url);
  syncBannerPreview();
  showSaveBlip('blipLandingBanner');
}
function applyBannerImage(url){
  const img=document.getElementById('landingBannerImg');
  const icon=document.querySelector('.landing-banner-icon');
  if(url&&img&&icon){img.src=url;img.style.display='block';icon.style.display='none'}
  else if(img&&icon){img.style.display='none';icon.style.display='block';icon.textContent=regSettings.bannerFallback||'🔐'}
}
function clearLandingBanner(){
  regSettings.landingBannerUrl='';
  applyBannerImage('');
  syncBannerPreview();
}
function syncBannerPreview(){
  const prev=document.getElementById('apBannerPreview');
  const status=document.getElementById('apBannerStatus');
  const url=regSettings.landingBannerUrl||'';
  const fallback=regSettings.bannerFallback||'🔐';
  if(url){
    prev.innerHTML=`<img src="${url}" alt="Preview">`;
    if(status)status.textContent='✓ Image set';status.style.color='var(--green)';
  }else{
    prev.innerHTML=`<span class="bp-emoji">${fallback}</span>`;
    if(status){status.textContent='No image set — showing fallback icon';status.style.color='#555'}
  }
}
function updateBannerFallback(){
  const val=document.getElementById('apBannerFallback')?.value||'🔐';
  regSettings.bannerFallback=val;
  const icon=document.querySelector('.landing-banner-icon');
  if(icon)icon.textContent=val;
  syncBannerPreview();
  saveEventConfigToBackend();
}
function handleBannerUpload(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  uploadFileToDrive(file,'branding').then(r=>{
    const url=r.directUrl;
    regSettings.landingBannerUrl=url;
    applyBannerImage(url);
    syncBannerPreview();
    saveEventConfigToBackend();
  }).catch(err=>{
    console.error('Banner upload failed:',err);
    // Fallback to local-only if upload fails
    const reader=new FileReader();
    reader.onload=function(e){
      const url=e.target.result;
      regSettings.landingBannerUrl=url;
      applyBannerImage(url);
      syncBannerPreview();
      saveEventConfigToBackend();
    };
    reader.readAsDataURL(file);
  });
}
function handleAdminBannerUpload(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  // Upload first so we never store giant data URLs in config.
  uploadFileToDrive(file,'branding').then(r=>{
    showBannerPreviewModal(r.directUrl,input);
  }).catch(err=>{
    console.error('Admin banner upload failed:',err);
    const reader=new FileReader();
    reader.onload=function(e){showBannerPreviewModal(e.target.result,input);};
    reader.readAsDataURL(file);
  });
  input.value=''; // reset so same file can be re-selected
}

let _pendingBannerUrl='';
function showBannerPreviewModal(url,inputEl){
  _pendingBannerUrl=url;
  showEditModal(`<h3>📷 Banner Preview</h3>
    <p style="font-family:'Chakra Petch',sans-serif;font-size:10px;color:#888;margin-bottom:16px">How your banner will appear on the landing page.</p>
    <div style="display:flex;justify-content:center;margin-bottom:20px">
      <div style="width:180px;height:180px;border-radius:50%;overflow:visible;border:2px solid rgba(0,212,255,.3);box-shadow:0 0 30px rgba(0,212,255,.08);background:#080a10;display:flex;align-items:center;justify-content:center">
        <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn-standard btn-ghost" onclick="cancelBannerPreview()">✕ Cancel</button>
      <button class="btn-standard btn-cyan" onclick="acceptBannerPreview()">✓ Use This Image</button>
    </div>`);
}
function acceptBannerPreview(){
  regSettings.landingBannerUrl=_pendingBannerUrl;
  applyBannerImage(_pendingBannerUrl);
  syncBannerPreview();
  saveEventConfigToBackend();
  hideEditModal();
  _pendingBannerUrl='';
}
function cancelBannerPreview(){
  _pendingBannerUrl='';
  hideEditModal();
}
function updateLandingTitle(){
  regSettings.landingTitle=document.getElementById('apLandingTitle')?.value||'Code Breakers';
  document.getElementById('landingTitleEl').textContent=regSettings.landingTitle;
  showSaveBlip('blipLandingTitle');
  saveEventConfigToBackend();
}
function updateLandingSubtitle(){
  regSettings.landingSubtitle=document.getElementById('apLandingSubtitle')?.value||'Operations Console';
  document.getElementById('landingSubEl').textContent=regSettings.landingSubtitle;
  showSaveBlip('blipLandingSub');
  saveEventConfigToBackend();
}

// ══════ SAVE BLIP MICRO-FEEDBACK ══════
function showSaveBlip(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.classList.add('show');
  clearTimeout(el._blipTimer);
  el._blipTimer=setTimeout(()=>el.classList.remove('show'),1800);
}
function updateThresholds(){
  activityThresholds.activeToIdle=parseInt(document.getElementById('apThresholdIdle')?.value)||60;
  activityThresholds.idleToSilent=parseInt(document.getElementById('apThresholdSilent')?.value)||300;
  updateTileStates();
  showSaveBlip('blipThresholds');
  saveEventConfigToBackend();
}

// ══════ BACKEND SAVE (debounced) ══════
let _saveConfigTimer=null;
function saveEventConfigToBackend(){
  if(!adminSession)return;
  clearTimeout(_saveConfigTimer);
  _saveConfigTimer=setTimeout(()=>{
    // Cache visual settings to localStorage for instant restore
    try{localStorage.setItem('cb_gridTheme',_currentGridTheme);localStorage.setItem('cb_opName',operationName);if(operationFont)localStorage.setItem('cb_opFont',operationFont)}catch(e){}
    apiCall('saveEventConfig',{config:{
      operationName,operationFont,
      gridTheme:_currentGridTheme,
      fontConfig:fontConfig,
      gridTiles:gridTiles.map(t=>({id:t.id,icon:t.icon,label:t.label,sub:t.sub,labelFont:t.labelFont,subFont:t.subFont})),
      participantMode:regSettings.participantMode,
      leaderboardStyle:regSettings.leaderboardStyle,
      scoringConfig:JSON.stringify(scoringConfig),
      landingTitle:regSettings.landingTitle,
      landingSubtitle:regSettings.landingSubtitle,
      landingBannerUrl:regSettings.landingBannerUrl,
      bannerFallback:regSettings.bannerFallback,
      teamSizeMin:regSettings.teamSizeMin,
      teamSizeMax:regSettings.teamSizeMax,
      maxTeams:regSettings.maxTeams,
      requireEmail:regSettings.requireEmail,
      requirePhone:regSettings.requirePhone,
      requireDept:regSettings.requireDept,
      registrationOpen:regSettings.registrationOpen,
      activeToIdle:activityThresholds.activeToIdle,
      idleToSilent:activityThresholds.idleToSilent,
      vaultMaxAttempts:regSettings.vaultMaxAttempts,
      vaultCooldownSec:regSettings.vaultCooldownSec,
      vaultUnlimitedAttempts:regSettings.vaultUnlimitedAttempts,
      eventStartTime:eventSettings.startTime,
      eventEndTime:eventSettings.endTime,
      eventAutoLock:eventSettings.autoLock,
      eventShowLeaderboardOnExpiry:eventSettings.showLeaderboardOnExpiry,
      allowDownloads:allowDownloads,
      sessionPersist:regSettings.sessionPersist,
      timerMode:timerMode,
      timerSec:timerSec,
      timerOriginal:timerOriginal,
      timerPaused:timerPaused,
      timerStarted:timerStarted,
      eventStartTime:eventSettings.startTime,
      eventEndTime:eventSettings.endTime,
      eventExpired:eventSettings.expired
    }}).then(r=>{});
  },1000); // 1 second debounce
}

let _saveFeedTimer=null;
let _feedSaveInFlight=false;
let _feedSaveCooldown=0; // timestamp — block refreshes until this time (KV eventual consistency guard)
// ── Centralized content version bump ──
// All save functions share a single version stamp to prevent mismatches.
// localStorage is written IMMEDIATELY (so cache restore works on refresh).
// Server call is debounced to avoid duplicate saveEventConfig calls.
let _pendingContentVersion = null;
let _contentVersionTimer = null;
function bumpContentVersion() {
  if (!_pendingContentVersion) _pendingContentVersion = Date.now().toString();
  // Write to localStorage IMMEDIATELY — cache restore depends on this
  try { localStorage.setItem('cb_contentVersion', _pendingContentVersion); } catch(e) {}
  // Debounce the server call so concurrent saves only trigger one saveEventConfig
  clearTimeout(_contentVersionTimer);
  _contentVersionTimer = setTimeout(() => {
    const ver = _pendingContentVersion;
    _pendingContentVersion = null;
    apiCall('saveEventConfig', { config: { contentVersion: ver } });
  }, 2000);
  return _pendingContentVersion;
}

function saveFeedPostsToBackend(){
  if(!adminSession)return;
  clearTimeout(_saveFeedTimer);
  _feedSaveInFlight=true;
  _saveFeedTimer=setTimeout(async()=>{
    _saveFeedTimer=null;
    bumpContentVersion();
    // Retry R2 upload for any local-only media before saving
    for(let i=0;i<posts.length;i++){
      const p=posts[i];
      if(p.mediaUrl&&(p.mediaUrl.startsWith('data:')||p.mediaUrl.startsWith('blob:'))){
        console.log('[FEED] Post',i,'has local-only media, attempting R2 re-upload...');
        try{
          const blob=await(await fetch(p.mediaUrl)).blob();
          const ext=(blob.type.split('/')[1]||'jpg').replace('jpeg','jpg');
          const file=new File([blob],'feed_'+Date.now()+'_'+i+'.'+ext,{type:blob.type});
          const result=await uploadFileToDrive(file,'feed');
          if(result&&result.directUrl){
            console.log('[FEED] R2 re-upload SUCCESS for post',i,':',result.directUrl.substring(0,80));
            posts[i].mediaUrl=result.directUrl;
            renderFeed();renderGrid();
          }
        }catch(e){
          console.warn('[FEED] R2 re-upload FAILED for post',i,':',e.message);
        }
      }
    }
    const mapped=posts.map(p=>{
      const url=(p.mediaUrl&&(p.mediaUrl.startsWith('data:')||p.mediaUrl.startsWith('blob:')))?'':p.mediaUrl||'';
      return{emoji:p.emoji,bg:p.bg,cap:p.cap,capFont:p.capFont,
        mediaUrl:url,mediaType:p.mediaType,
        focalX:p.focalX||50,focalY:p.focalY||50};
    });
    console.log('[FEED] saveFeedPostsToBackend SENDING',mapped.length,'posts. mediaUrls:',mapped.map(p=>p.mediaUrl?.substring(0,60)));
    apiCall('saveFeedPosts',{posts:mapped}).then(r=>{console.log('[FEED] saveFeedPosts response:',r);if(!r.ok)console.warn('Feed save failed:',r.error)}).finally(()=>{_feedSaveInFlight=false;_feedSaveCooldown=Date.now()+60000});
    _cacheContent('cb_posts',posts);
  },1500);
}

let _saveMediaTimer=null;
let _mediaSaveInFlight=false;
let _mediaSaveCooldown=0;
function saveMediaItemsToBackend(){
  if(!adminSession)return;
  clearTimeout(_saveMediaTimer);
  _mediaSaveInFlight=true;
  _saveMediaTimer=setTimeout(()=>{
    bumpContentVersion();
    apiCall('saveMediaItems',{items:mediaItems.map(_normalizeMediaItem).map(m=>{
      const rawUrl = m.fileUrl || m.url || '';
      const url = (rawUrl&&(rawUrl.startsWith('data:')||rawUrl.startsWith('blob:')))?'':rawUrl;
      // Save both canonical (name/fileUrl/icon) and legacy (title/url/filename) keys for compatibility.
      return{
        type:m.type||'',
        name:m.name||'', fileUrl:url, icon:m.icon||'',
        title:m.name||'', url:url, filename:m.icon||'',
        titleFont:m.nameFont||'',
        nameFont:m.nameFont||'',
        desc:m.desc||'', descFont:m.descFont||'',
        vaultLocked:!!m.vaultLocked,
        unlockKey:m.unlockKey||'',
        unlocked:!!m.unlocked,
        vaultCode:m.vaultCode||'',
        vaultCodename:m.vaultCodename||''
      };
    })}).then(r=>{if(!r.ok)console.warn('Media save failed:',r.error)}).finally(()=>{_mediaSaveInFlight=false;_mediaSaveCooldown=Date.now()+60000});
    _cacheContent('cb_media',mediaItems);
  },1500);
}

let _saveIntelTimer=null;
function saveIntelFieldsToBackend(){
  if(!adminSession)return;
  clearTimeout(_saveIntelTimer);
  _saveIntelTimer=setTimeout(()=>{
    bumpContentVersion();
    apiCall('saveIntelFields',{fields:intelFields.map(f=>({
      label:f.label||'',emoji:f.emoji||'',fieldType:f.type||'text',
      font:f.font||'',inputFont:f.inputFont||'',answer:f.answer||{}
    }))}).then(r=>{});
    _cacheContent('cb_intel',intelFields);
  },1500);
}

// saveVaultCodesToBackend is deprecated — vault codes are now properties of media items
// and persist via saveMediaItemsToBackend(). syncVaultCodesFromMedia() rebuilds the
// runtime vaultCodes array from mediaItems on load and after any edit.

function onParticipantModeChange(){
  regSettings.participantMode=document.getElementById('apParticipantMode')?.value||'team';
  updateLandingForMode();
  buildRegForm();
  showSaveBlip('blipEventSettings');
  saveEventConfigToBackend();
}
function onLeaderboardStyleChange(){
  regSettings.leaderboardStyle=document.getElementById('apLeaderboardStyle')?.value||'mixed';
  showSaveBlip('blipEventSettings');
  saveEventConfigToBackend();
}

// ── Admin Panel ──
const adminPanelIds=['adminPanel','broadcastPanel','leaderboardModule','keysCodesPanel','dashboardPanel','portalUsersPanel','scoringPanel','registrationPanel','appearancePanel','sessionMgmtPanel','tutorialConfigPanel'];

// ══════ LIVE GROUP — Dashboard internal tabs ══════
const dashGroupIds=['dashboardPanel','leaderboardModule','sessionMgmtPanel'];

// ══════ SETUP GROUP — sub-nav between related panels ══════
const setupGroupTabs=[
  {id:'adminPanel',label:'Event',icon:'⚙️',subs:[
    {id:'registrationPanel',label:'Registration'},
    {id:'tutorialConfigPanel',label:'Tutorial & Briefing'}
  ]},
  {id:'keysCodesPanel',label:'Intel & Scoring',icon:'🎯',subs:[
    {id:'scoringPanel',label:'Scoring'}
  ]},
  {id:'appearancePanel',label:'Appearance',icon:'🎨'},
  {id:'portalUsersPanel',label:'Users & Sessions',icon:'👥'}
];
const setupGroupIds=[];
const setupAllIds={};
setupGroupTabs.forEach(t=>{setupGroupIds.push(t.id);setupAllIds[t.id]=t.id;if(t.subs)t.subs.forEach(s=>{setupGroupIds.push(s.id);setupAllIds[s.id]=t.id})});

function injectSetupNav(activePanelId){
  document.querySelectorAll('.setup-nav').forEach(n=>n.remove());
  const panel=document.getElementById(activePanelId);
  if(!panel)return;
  const header=panel.querySelector('.ap-header,.kc-header,.bc-header,.lb-header');
  if(!header)return;
  let html='';
  setupGroupTabs.forEach(t=>{
    const isParentActive=(t.id===activePanelId)||(t.subs&&t.subs.some(s=>s.id===activePanelId));
    // Main tab
    html+='<button class="setup-nav-btn'+(t.id===activePanelId?' active':'')+'" onclick="switchSetupTab(\''+t.id+'\')">'+t.icon+' '+t.label+'</button>';
    // Sub-tabs (show only if this parent group is active)
    if(t.subs&&isParentActive){
      t.subs.forEach(s=>{
        html+='<button class="setup-nav-btn'+(s.id===activePanelId?' active':'')+'" onclick="switchSetupTab(\''+s.id+'\')" style="font-size:8px;opacity:.7;padding-left:6px">· '+s.label+'</button>';
      });
    }
  });
  const nav=document.createElement('div');
  nav.className='setup-nav';
  nav.innerHTML=html;
  header.after(nav);
}

function injectDashNav(activePanelId){
  document.querySelectorAll('.dash-nav').forEach(n=>n.remove());
  const panel=document.getElementById(activePanelId);
  if(!panel)return;
  const header=panel.querySelector('.ap-header,.kc-header,.bc-header,.lb-header');
  if(!header)return;
  const tabs=[
    {id:'dashboardPanel',label:'Teams',icon:'📡'},
    {id:'leaderboardModule',label:'Leaderboard',icon:'🏆'},
    {id:'sessionMgmtPanel',label:'Sessions',icon:'🛡️'},
    {id:'broadcastPanel',label:'Broadcast',icon:'📢'}
  ];
  let html='';
  tabs.forEach(t=>{
    html+='<button class="setup-nav-btn'+(t.id===activePanelId?' active':'')+'" onclick="switchDashNavTab(\''+t.id+'\')">'+t.icon+' '+t.label+'</button>';
  });
  const nav=document.createElement('div');
  nav.className='dash-nav setup-nav';
  nav.innerHTML=html;
  header.after(nav);
}

function switchDashNavTab(panelId){
  switchAdminTab(panelId);
}

function switchSetupTab(panelId){
  switchAdminTab(panelId);
}

function openSetup(subTab){
  switchAdminTab(subTab||'adminPanel');
}
function closeAllAdminPanels(){
  adminPanelIds.forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.remove('active');el.style.cssText=''}
  });
  // Also instant-close content panels
  const ov=document.getElementById('panelOverlay');
  ov.classList.remove('active');
  ov.style.cssText='';
  document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording')bcMediaRecorder.stop();
  lbExpandedTeam=null;
  hideAdminTabs();
}
function showAdminTabs(activeId){
  const bar=document.getElementById('adminNavBar');
  if(!bar)return;
  bar.classList.add('visible');
  bar.querySelectorAll('.anb-btn').forEach(btn=>{
    // For setup group panels, highlight the Setup button (anb-adminPanel)
    let isActive=btn.id==='anb-'+activeId;
    if(!isActive&&btn.id==='anb-adminPanel'&&setupGroupIds.includes(activeId))isActive=true;
    // For live group panels (broadcast, sessionMgmt), highlight the Live/Dashboard button
    if(!isActive&&btn.id==='anb-dashboardPanel'&&dashGroupIds.includes(activeId))isActive=true;
    btn.classList.toggle('active',isActive);
  });
}
function hideAdminTabs(){
  const bar=document.getElementById('adminNavBar');
  if(bar)bar.classList.remove('visible');
  document.querySelectorAll('.anb-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.setup-nav').forEach(n=>n.remove());
  document.querySelectorAll('.dash-nav').forEach(n=>n.remove());
}
function switchAdminTab(panelId){
  // Determine which group the target panel belongs to
  const _findGroup=function(pid){
    if(dashGroupIds.includes(pid))return 'live';
    if(setupGroupIds.includes(pid))return 'setup';
    return null;
  };
  // Find the currently active admin panel
  const currentPanel=adminPanelIds.find(id=>{const el=document.getElementById(id);return el&&el.classList.contains('active')});
  const currentGroup=currentPanel?_findGroup(currentPanel):null;
  const targetGroup=_findGroup(panelId);
  // If switching within the SAME group, do a smooth content crossfade
  const isSameGroup=currentPanel&&currentPanel!==panelId&&currentGroup&&currentGroup===targetGroup;

  // Common init function for after the panel is visible
  const _initPanel=function(){
    if(panelId==='adminPanel'){syncAdminPanelSettings()}
    if(panelId==='leaderboardModule'){renderFullLeaderboard()}
    if(panelId==='dashboardPanel'){renderTeamMonitor();startTeamMonitor()}
    if(panelId==='keysCodesPanel'){renderKeysCodes()}
    if(panelId==='portalUsersPanel'){renderPortalUsersList()}
    if(panelId==='scoringPanel'){renderScoringEditor()}
    if(panelId==='registrationPanel'){syncRegistrationSettings()}
    if(panelId==='appearancePanel'){updateThemeLabel();initTypographyPanel()}
    if(panelId==='tutorialConfigPanel'){renderTutorialStepList();const tg=document.getElementById('tutGlobalToggle');if(tg)tg.classList.toggle('on',tutorialEnabled)}
    document.querySelectorAll('.setup-nav').forEach(n=>n.remove());
    if(setupGroupIds.includes(panelId)){injectSetupNav(panelId)}
    document.querySelectorAll('.dash-nav').forEach(n=>n.remove());
    if(dashGroupIds.includes(panelId)){injectDashNav(panelId)}
  };

  if(isSameGroup){
    const outEl=document.getElementById(currentPanel);
    const inEl=document.getElementById(panelId);
    const outContainer=outEl.querySelector('.ap-container,.kc-container,.bc-container,.lb-container');
    const inContainer=inEl.querySelector('.ap-container,.kc-container,.bc-container,.lb-container');
    // Fade out current container content
    if(outContainer){outContainer.style.transition='opacity .1s ease';outContainer.style.opacity='0'}
    setTimeout(function(){
      // Hide old panel instantly
      adminPanelIds.forEach(id=>{
        const el=document.getElementById(id);
        if(el){el.style.cssText='opacity:0;pointer-events:none;transition:none';el.classList.remove('active')}
      });
      // Prep incoming — start container invisible
      if(inContainer){inContainer.style.opacity='0';inContainer.style.transition='none'}
      _instantShow(inEl);
      // Init & inject nav while invisible
      _initPanel();
      // Force reflow then fade in
      if(inContainer)inContainer.offsetHeight;
      if(inContainer){inContainer.style.transition='opacity .1s ease';inContainer.style.opacity='1'}
      // Clean up inline styles after animation
      setTimeout(function(){
        if(outContainer)outContainer.style.cssText='';
        if(inContainer)inContainer.style.cssText='';
      },130);
    },100);
  } else {
    // Normal panel switch (different group or first open)
    adminPanelIds.forEach(id=>{
      const el=document.getElementById(id);
      if(el){el.style.cssText='opacity:0;pointer-events:none;transition:none';el.classList.remove('active')}
    });
    _instantShow(document.getElementById(panelId));
    _initPanel();
  }

  showAdminTabs(panelId);
  saveSession();
}
function syncAdminPanelSettings(){
  renderScoringEditor();
  const minEl=document.getElementById('apMinSize');
  const maxEl=document.getElementById('apMaxSize');
  const maxTEl=document.getElementById('apMaxTeams');
  if(minEl)minEl.value=regSettings.teamSizeMin;
  if(maxEl)maxEl.value=regSettings.teamSizeMax;
  if(maxTEl)maxTEl.value=regSettings.maxTeams;
  const reqE=document.getElementById('apReqEmail');if(reqE)reqE.checked=regSettings.requireEmail;
  const reqP=document.getElementById('apReqPhone');if(reqP)reqP.checked=regSettings.requirePhone;
  const reqD=document.getElementById('apReqDept');if(reqD)reqD.checked=regSettings.requireDept;
  const regO=document.getElementById('apRegOpen');if(regO)regO.checked=regSettings.registrationOpen;
  const status=document.getElementById('apRegStatus');
  if(status){status.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';status.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)'}
  const apTimer=document.getElementById('apTimerDisplay');
  if(apTimer)apTimer.textContent=document.getElementById('cTimer').textContent;
  // Sync activity thresholds
  const thIdle=document.getElementById('apThresholdIdle');if(thIdle)thIdle.value=activityThresholds.activeToIdle;
  const thSilent=document.getElementById('apThresholdSilent');if(thSilent)thSilent.value=activityThresholds.idleToSilent;
  // Sync banner preview
  syncBannerPreview();
  // Sync banner fallback
  const fbInput=document.getElementById('apBannerFallback');if(fbInput)fbInput.value=regSettings.bannerFallback||'🔐';
  syncManualCreationUI();
  // Sync downloads checkbox
  const dlCb=document.getElementById('apAllowDownloads');if(dlCb)dlCb.checked=allowDownloads;
}
function _instantShow(el){
  el.style.cssText='opacity:1;pointer-events:all;transition:none';
  el.classList.add('active');
}
let apTimerInterval=null;
// ══════ CHANGE PASSWORD MODAL ══════
function openChangePassword(){
  document.getElementById('changePwModal').style.display='flex';
  document.getElementById('apCurPw').value='';
  document.getElementById('apNewPw').value='';
  document.getElementById('apConfPw').value='';
  document.getElementById('apPwMsg').textContent='';
}
function closeChangePassword(){
  document.getElementById('changePwModal').style.display='none';
}

// ══════ PORTAL USERS PANEL ══════
function openPortalUsers(){
  switchAdminTab('portalUsersPanel');
  refreshAdminList();
  onManualTypeChange();
}
function closePortalUsers(){
  const el=document.getElementById('portalUsersPanel');
  el.style.cssText='';el.classList.remove('active');hideAdminTabs();
}
function renderPortalUsersList(){
  const el=document.getElementById('puCombinedList');
  if(!el)return;
  let html='';
  // Admins first
  adminUsers.forEach((a)=>{
    const isSelf=adminSession&&a.user.toLowerCase()===adminSession.username.toLowerCase();
    const isSuperAdmin=a.role==='superadmin';
    const roleBadge=isSuperAdmin?'SUPER ADMIN':'ADMIN';
    html+=`<div class="ap-team-row">
      <span style="font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:2px 8px;border-radius:2px;color:var(--amber);background:rgba(255,170,51,.08);border:1px solid rgba(255,170,51,.15);margin-right:8px;font-weight:600">${roleBadge}</span>
      <span class="ap-team-id">${a.user}</span>
      <span class="ap-team-name" style="color:#555">${isSelf?'(you)':'••••••••'}</span>
      ${!isSuperAdmin&&adminUsers.length>1?`<span class="ap-team-del" onclick="removeAdmin('${a.user}')">✕</span>`:''}
    </div>`;
  });
  // Manual entries
  manualTeams.forEach((t,i)=>{
    const isIndiv=t.type==='individual';
    const badge=isIndiv?'PLAYER':'TEAM';
    const badgeColor=isIndiv?'var(--cyan)':'var(--green)';
    const badgeBg=isIndiv?'rgba(0,212,255,.08)':'rgba(0,255,136,.08)';
    const badgeBorder=isIndiv?'rgba(0,212,255,.15)':'rgba(0,255,136,.15)';
    html+=`<div class="ap-team-row">
      <span style="font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1px;padding:2px 8px;border-radius:2px;color:${badgeColor};background:${badgeBg};border:1px solid ${badgeBorder};margin-right:8px;font-weight:600">${badge}</span>
      <span class="ap-team-id">${t.id}</span>
      <span class="ap-team-name">${t.name}</span>
      <span class="ap-team-del" onclick="removeTeam(${i})">✕</span>
    </div>`;
  });
  if(!html) html='<div style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#555;padding:12px 0;letter-spacing:.5px">No portal users created yet.</div>';
  el.innerHTML=html;
}
function removeManualTeam(i){removeTeam(i)}

// ══════ EVENT CONTROL PANEL ══════
function openEventControl(){
  switchAdminTab('adminPanel');
  syncAdminPanelSettings();
  initTypographyPanel();
  if(apTimerInterval)clearInterval(apTimerInterval);
  apTimerInterval=setInterval(()=>{const el=document.getElementById('apTimerDisplay');if(el)el.textContent=document.getElementById('cTimer').textContent},250);
}
function openAdminPanel(){openEventControl()} // backward compat alias
function closeEventControl(){
  const el=document.getElementById('adminPanel');
  el.style.cssText='';el.classList.remove('active');hideAdminTabs();
  if(apTimerInterval){clearInterval(apTimerInterval);apTimerInterval=null}
}
function closeAdminPanel(){closeEventControl()} // backward compat alias

// ══════ REORGANIZED ADMIN PANEL FUNCTIONS (BUILD 20260223-0600) ══════
let _previewReturnPanel=null;

function openDashboard(){switchAdminTab('dashboardPanel');renderTeamMonitor();startTeamMonitor()}
function closeDashboard(){const el=document.getElementById('dashboardPanel');if(el){el.classList.remove('active');el.style.cssText=''}hideAdminTabs()}

function switchDashTab(tab){
  // Legacy compatibility — redirect to new dash-nav panels
  if(tab==='leaderboard'){switchAdminTab('leaderboardModule')}
  else{switchAdminTab('dashboardPanel');renderTeamMonitor();startTeamMonitor()}
}

function openEventSettings(){switchAdminTab('adminPanel')}
function closeEventSettings(){closeEventControl()}

function openScoringPanel(){switchAdminTab('scoringPanel')}
function closeScoringPanel(){const el=document.getElementById('scoringPanel');if(el){el.classList.remove('active');el.style.cssText=''}hideAdminTabs()}

function openRegistrationPanel(){switchAdminTab('registrationPanel')}
function closeRegistrationPanel(){const el=document.getElementById('registrationPanel');if(el){el.classList.remove('active');el.style.cssText=''}hideAdminTabs()}
function syncRegistrationSettings(){
  const minEl=document.getElementById('apMinSize');const maxEl=document.getElementById('apMaxSize');const maxTEl=document.getElementById('apMaxTeams');
  if(minEl)minEl.value=regSettings.teamSizeMin;if(maxEl)maxEl.value=regSettings.teamSizeMax;if(maxTEl)maxTEl.value=regSettings.maxTeams;
  const reqE=document.getElementById('apReqEmail');if(reqE)reqE.checked=regSettings.requireEmail;
  const reqP=document.getElementById('apReqPhone');if(reqP)reqP.checked=regSettings.requirePhone;
  const reqD=document.getElementById('apReqDept');if(reqD)reqD.checked=regSettings.requireDept;
  const regO=document.getElementById('apRegOpen');if(regO)regO.checked=regSettings.registrationOpen;
  const st=document.getElementById('apRegStatus');
  if(st){st.textContent=regSettings.registrationOpen?'● OPEN':'● CLOSED';st.style.color=regSettings.registrationOpen?'var(--green)':'var(--red)'}
}

function openAppearancePanel(){switchAdminTab('appearancePanel')}
function closeAppearancePanel(){const el=document.getElementById('appearancePanel');if(el){el.classList.remove('active');el.style.cssText=''}hideAdminTabs()}
function openTeamMonitor(){openDashboard()}
function closeTeamMonitor(){closeDashboard()}

function changeAdminPw(){
  const cur=document.getElementById('apCurPw').value;
  const nw=document.getElementById('apNewPw').value;
  const conf=document.getElementById('apConfPw').value;
  const msg=document.getElementById('apPwMsg');
  if(!cur){msg.className='ap-msg err';msg.textContent='✗ Enter current password';return}
  if(nw.length<8){msg.className='ap-msg err';msg.textContent='✗ New password must be at least 8 characters';return}
  if(nw!==conf){msg.className='ap-msg err';msg.textContent='✗ Passwords do not match';return}
  msg.className='ap-msg';msg.textContent='Updating...';
  apiCall('changePassword',{username:adminSession.username,currentPassword:cur,newPassword:nw}).then(r=>{
    if(r.ok){
      msg.className='ap-msg ok';msg.textContent='✓ Password updated successfully';
      document.getElementById('apCurPw').value='';document.getElementById('apNewPw').value='';document.getElementById('apConfPw').value='';
    }else{
      msg.className='ap-msg err';msg.textContent='✗ '+r.error;
    }
  });
}

function addAdmin(){
  const u=document.getElementById('apAddUser').value.trim();
  const p=document.getElementById('apAddPw').value.trim();
  const msg=document.getElementById('apAdminMsg');
  if(!u||!p){msg.className='ap-msg err';msg.textContent='✗ Username and password required';return}
  msg.className='ap-msg';msg.textContent='Adding...';
  apiCall('addAdmin',{newUsername:u,newPassword:p}).then(r=>{
    if(r.ok){
      msg.className='ap-msg ok';msg.textContent='✓ Admin "'+u+'" added';
      document.getElementById('apAddUser').value='';document.getElementById('apAddPw').value='';
      refreshAdminList();
    }else{
      msg.className='ap-msg err';msg.textContent='✗ '+r.error;
    }
  });
}
function removeAdmin(username){
  if(!confirm('Remove admin "'+username+'"?'))return;
  apiCall('removeAdmin',{targetUsername:username}).then(r=>{
    if(r.ok)refreshAdminList();
    else alert(r.error);
  });
}
function refreshAdminList(){
  apiCall('listAdmins').then(r=>{
    if(r.ok){
      adminUsers=r.admins.map(a=>({user:a.username,role:a.role,createdAt:a.createdAt}));
      renderPortalUsersList();
    }
  });
}
function renderAdminList(){renderPortalUsersList()} // backward compat

function createManualTeam(){
  const effectiveType=document.getElementById('apManualType')?.value||'team';
  const name=document.getElementById('apTeamName').value.trim();
  const id=document.getElementById('apTeamId').value.trim()||'';
  const msg=document.getElementById('apTeamMsg');
  if(!name){msg.className='ap-msg err';msg.textContent='✗ Name required';return}
  msg.className='ap-msg';msg.textContent='Creating...';
  apiCall('createManualTeam',{teamName:name,teamId:id,type:effectiveType}).then(r=>{
    if(r.ok){
      msg.className='ap-msg ok';msg.textContent=`✓ ${effectiveType==='individual'?'Participant':'Team'} "${name}" created with ID: ${r.teamId}`;
      document.getElementById('apTeamName').value='';document.getElementById('apTeamId').value='';
      // Add to local cache
      const team={id:r.teamId,name:r.teamName||name,type:effectiveType,members:[],memberDetails:[],lastActive:Date.now(),fieldsCompleted:0,submitTime:null,registeredAt:new Date().toISOString(),submissionResults:null};
      manualTeams.push(team);
      registeredTeams.push(team);
      renderPortalUsersList();
    }else{
      msg.className='ap-msg err';msg.textContent='✗ '+r.error;
    }
  });
}
function onManualTypeChange(){
  const t=document.getElementById('apManualType')?.value||'team';
  const isInd=t==='individual';
  document.getElementById('apManualNameLabel').textContent=isInd?'Participant Name':'Team Name';
  document.getElementById('apManualIdLabel').textContent=isInd?'Participant ID (leave blank to auto-generate)':'Team ID (leave blank to auto-generate)';
  document.getElementById('apTeamName').placeholder=isInd?'e.g. Jane Doe':'e.g. Alpha Squad';
  document.getElementById('apManualCreateBtn').textContent=isInd?'Create Participant':'Create Team';
}
function syncManualCreationUI(){
  // Type dropdown is always visible in Portal Users — just sync labels to current selection
  onManualTypeChange();
}
function autoGenTeamId(){const name=document.getElementById('apTeamName').value.trim()||'TEAM';document.getElementById('apTeamId').value=generateTeamId(name)}
function removeTeam(i){
  const team=manualTeams[i];
  if(!team)return;
  if(!confirm('Remove "'+team.name+'" ('+team.id+')?'))return;
  apiCall('removeTeam',{teamId:team.id}).then(r=>{
    if(r.ok){
      manualTeams.splice(i,1);
      const ri=registeredTeams.findIndex(t=>t.id===team.id);
      if(ri>=0)registeredTeams.splice(ri,1);
      renderPortalUsersList();
    }else{
      alert(r.error||'Failed to remove team');
    }
  });
}
function renderTeamList(){renderPortalUsersList()} // backward compat

// ── Team Monitor (Activity Tracking) ──
const INACTIVE_THRESHOLD=5*60*1000; // fallback
let registeredTeams=[]; // Will be populated from backend; for now demo data
let teamMonitorInterval=null;

function initDemoTeams(){
  // Teams now loaded from backend via loadEventData()
  // This function kept for backward compatibility
  if(registeredTeams.length===0){
    registeredTeams=[];
  }
}
initDemoTeams();

function isTeamActive(t){
  const threshold=(activityThresholds.activeToIdle||120)*1000;
  return(Date.now()-t.lastActive)<threshold;
}
function isTeamIdle(t){
  const activeThreshold=(activityThresholds.activeToIdle||120)*1000;
  const ghostThreshold=(activityThresholds.idleToSilent||600)*1000;
  const elapsed=Date.now()-t.lastActive;
  return elapsed>=activeThreshold&&elapsed<ghostThreshold;
}
function isTeamGhost(t){
  const ghostThreshold=(activityThresholds.idleToSilent||600)*1000;
  return(Date.now()-t.lastActive)>=ghostThreshold;
}
function removeGhostTeam(teamId){
  const idx=registeredTeams.findIndex(t=>t.id===teamId);
  if(idx===-1)return;
  if(!confirm('Remove ghost team "'+registeredTeams[idx].name+'"? This only removes them from the local view — use Clear Data in settings to fully purge from the backend.'))return;
  registeredTeams.splice(idx,1);
  renderTeamMonitor();renderFullLeaderboard();renderLeaderboard();
}
function timeSince(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60)return s+'s ago';
  if(s<3600)return Math.floor(s/60)+'m ago';
  return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m ago';
}

function renderTeamMonitor(){
  var el=document.getElementById('apTeamMonitor');
  if(!el)return;
  var active=registeredTeams.filter(function(t){return isTeamActive(t)});
  var idle=registeredTeams.filter(function(t){return isTeamIdle(t)});
  var ghosts=registeredTeams.filter(function(t){return isTeamGhost(t)});
  document.getElementById('apActiveCount').textContent=active.length;
  document.getElementById('apInactiveCount').textContent=idle.length;
  document.getElementById('apTotalCount').textContent=registeredTeams.length;
  var ghostEl=document.getElementById('apGhostCount');
  if(ghostEl){ghostEl.closest('.ap-status-pill').style.display=ghosts.length?'':'none';ghostEl.textContent=ghosts.length}
  var sorted=[].concat(
    active.sort(function(a,b){return b.lastActive-a.lastActive}),
    idle.sort(function(a,b){return b.lastActive-a.lastActive}),
    ghosts.sort(function(a,b){return b.lastActive-a.lastActive})
  );
  var totalPages=Math.max(1,Math.ceil(sorted.length/tmPerPage));
  if(tmCurrentPage>=totalPages)tmCurrentPage=totalPages-1;
  var startIdx=tmCurrentPage*tmPerPage;
  var pageTeams=sorted.slice(startIdx,startIdx+tmPerPage);
  var headerRow='<div class="ap-monitor-row" style="border-bottom:1px solid var(--border);padding-bottom:4px;margin-bottom:4px;opacity:.5"><input type="checkbox" onchange="tmToggleAll(this.checked)" style="margin-right:4px;accent-color:#ff4444"><div class="ap-monitor-dot" style="visibility:hidden"></div><span class="ap-monitor-id" style="font-size:8px;letter-spacing:2px">ID</span><span class="ap-monitor-name" style="font-size:8px;letter-spacing:2px;flex:1">TEAM</span></div>';
  el.innerHTML=pageTeams.length?headerRow+pageTeams.map(function(t){
    var ghost=isTeamGhost(t);
    var on=isTeamActive(t);
    var idleState=isTeamIdle(t);
    var dotClass=on?'on':idleState?'idle':'off';
    var rowClass=ghost?'ghost':on?'active':'idle';
    var statusTag=ghost?'<span class="ap-monitor-ghost-tag">GHOST</span>':idleState?'<span class="ap-monitor-idle-tag">IDLE</span>':'';
    var removeBtn=ghost?'<span class="ap-monitor-remove" onclick="event.stopPropagation();removeGhostTeam(\''+t.id+'\')" title="Remove ghost">\u2715</span>':'';
    var msgBtn='<span class="lb-msg-btn" onclick="event.stopPropagation();sendTeamMessage(\''+t.id+'\',\''+t.name.replace(/'/g,"\\'")+'\')" style="margin-left:auto">\uD83D\uDCAC</span>';
    return '<div class="ap-monitor-row '+rowClass+'"><input type="checkbox" class="tm-nuke-check" data-team="'+t.id+'" onchange="tmUpdateNukeBar()" onclick="event.stopPropagation()" style="margin-right:4px;accent-color:#ff4444"><div class="ap-monitor-dot '+dotClass+'"></div><span class="ap-monitor-id">'+t.id+'</span><span class="ap-monitor-name">'+t.name+'</span>'+statusTag+msgBtn+removeBtn+'</div>';
  }).join(''):'<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:12px 0;text-align:center">No teams registered yet</div>';
  renderPagination('tmPagination',sorted.length,tmPerPage,tmCurrentPage,function(p){tmCurrentPage=p;renderTeamMonitor()});
  tmUpdateNukeBar();
}
function tmToggleAll(checked){
  document.querySelectorAll('.tm-nuke-check').forEach(function(cb){cb.checked=checked});
  tmUpdateNukeBar();
}
function tmUpdateNukeBar(){
  var checked=document.querySelectorAll('.tm-nuke-check:checked');
  var bar=document.getElementById('tmNukeBar');
  var count=document.getElementById('tmNukeCount');
  if(checked.length>0){bar.style.display='flex';count.textContent=checked.length+' selected'}
  else{bar.style.display='none'}
}
function renderLeaderboard(){
  const el=document.getElementById('apLeaderboard');
  if(!el)return;
  if(!registeredTeams.length){el.innerHTML='<div class="ap-lb-empty">No teams registered yet</div>';return}

  const maxFields=intelFields.length||1;
  const sorted=[...registeredTeams].sort((a,b)=>{
    const aScore=a.submissionResults?a.submissionResults.totalScore:0;
    const bScore=b.submissionResults?b.submissionResults.totalScore:0;
    if(bScore!==aScore)return bScore-aScore;
    if(a.submitTime&&b.submitTime)return a.submitTime.localeCompare(b.submitTime);
    if(a.submitTime)return -1;if(b.submitTime)return 1;
    return b.lastActive-a.lastActive;
  });

  el.innerHTML=sorted.slice(0,5).map((t,i)=>{
    const rank=i+1;
    const rc=rank===1?'gold':rank===2?'silver':rank===3?'bronze':'std';
    const score=t.submissionResults?t.submissionResults.totalScore:0;
    const possible=t.submissionResults?t.submissionResults.totalPossible:(maxFields*10);
    const pct=possible?Math.round((score/possible)*100):0;
    const correct=t.submissionResults?t.submissionResults.correctCount:0;
    const barColor=rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#444';
    return `<div class="ap-lb-row">
      <div class="ap-lb-rank ${rc}">#${rank}</div>
      <div class="ap-lb-info">
        <div class="ap-lb-name">${t.name}</div>
        <div class="ap-lb-meta">${t.id} · ${t.submitTime?correct+'/'+maxFields+' correct · '+score+' pts':'Not submitted'}</div>
        <div class="ap-lb-bar" style="width:${pct}%;background:${barColor}"></div>
      </div>
      <div class="ap-lb-score ${rc}">${t.submitTime?pct+'%':'—'}</div>
    </div>`;
  }).join('');
}

// Team monitor — hash-checked refresh + live backend data fetch
let _tmLastHash='',_lbLastHash='';
function startTeamMonitor(){
  if(teamMonitorInterval)clearInterval(teamMonitorInterval);
  teamMonitorInterval=setInterval(async()=>{
    // Fetch teams and submissions from backend every tick
    const [teamsResult, subResult] = await Promise.all([
      apiCall('getTeams'),
      apiCall('getSubmissions')
    ]);
    if(teamsResult.ok&&teamsResult.teams){
      registeredTeams.length=0;manualTeams.length=0;
      teamsResult.teams.forEach(t=>{
        const team={id:t.teamId,name:t.teamName,type:t.type,members:t.members.map(m=>typeof m==='string'?m:m.name),memberDetails:t.members,lastActive:new Date(t.lastActive).getTime(),fieldsCompleted:0,submitTime:null,registeredAt:t.registeredAt,submissionResults:null};
        if(t.manual)manualTeams.push(team);
        registeredTeams.push(team);
      });
    }
    if(subResult.ok&&subResult.submissions){
      subResult.submissions.forEach(s=>{
        const team=registeredTeams.find(t=>t.id===s.teamId);
        if(team){
          team.submitTime=s.submittedAt;
          team.submissionResults={totalScore:s.score,totalPossible:s.totalPossible||0,correctCount:s.correct,totalFields:s.total};
          team.fieldsCompleted=s.correct||0;
        }
      });
    }
    // Only re-render if data actually changed (prevents flicker)
    const tmHash=_teamDataHash();
    if(document.getElementById('dashboardPanel').classList.contains('active')&&tmHash!==_tmLastHash){
      _tmLastHash=tmHash;
      renderTeamMonitor();
    }
    if(document.getElementById('leaderboardModule').classList.contains('active')&&tmHash!==_lbLastHash&&(Date.now()-_lbUserInteractedAt)>5000){
      _lbLastHash=tmHash;
      renderFullLeaderboard();
    }
  },3000);
}
function _teamDataHash(){
  let h=registeredTeams.length;
  for(let i=0;i<registeredTeams.length;i++){
    const t=registeredTeams[i];
    h=((h<<5)-h+(t.fieldsCompleted||0))|0;
    h=((h<<5)-h+(t.submitTime?1:0))|0;
    h=((h<<5)-h+(t.submissionResults?t.submissionResults.totalScore:0))|0;
    // Include activity status so ghost→active triggers re-render
    const status=isTeamActive(t)?2:isTeamIdle(t)?1:0;
    h=((h<<5)-h+status)|0;
    for(let j=0;j<t.name.length;j++)h=((h<<5)-h+t.name.charCodeAt(j))|0;
  }
  // Include expanded team so user interaction doesn't get stomped
  if(lbExpandedTeam)for(let j=0;j<lbExpandedTeam.length;j++)h=((h<<5)-h+lbExpandedTeam.charCodeAt(j))|0;
  return String(h);
}

// ── Full Leaderboard Module ──
let lbFilter='all';
let lbExpandedTeam=null;

function openLeaderboard(){
  switchAdminTab('leaderboardModule');
  renderFullLeaderboard();
}
function closeLeaderboard(){
  const el=document.getElementById('leaderboardModule');
  el.style.cssText='';el.classList.remove('active');
  lbExpandedTeam=null;hideAdminTabs();
}
function setLbFilter(btn,f){
  document.querySelectorAll('.lb-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');lbFilter=f;
  renderFullLeaderboard();
}

function getSortedTeams(){
  const sort=document.getElementById('lbSort')?.value||'score';
  const search=(document.getElementById('lbSearch')?.value||'').toLowerCase();
  const maxFields=intelFields.length||1;

  let teams=[...registeredTeams];

  // Filter
  if(lbFilter==='active')teams=teams.filter(isTeamActive);
  else if(lbFilter==='inactive')teams=teams.filter(t=>!isTeamActive(t)&&!isTeamGhost(t));
  else if(lbFilter==='ghost')teams=teams.filter(isTeamGhost);
  else if(lbFilter==='submitted')teams=teams.filter(t=>t.submitTime);

  // Search
  if(search)teams=teams.filter(t=>t.name.toLowerCase().includes(search)||t.id.toLowerCase().includes(search));

  // Sort
  teams.sort((a,b)=>{
    switch(sort){
      case 'score':{
        const aScore=a.submissionResults?a.submissionResults.totalScore:0;
        const bScore=b.submissionResults?b.submissionResults.totalScore:0;
        if(bScore!==aScore)return bScore-aScore;
        if(a.submitTime&&b.submitTime)return a.submitTime.localeCompare(b.submitTime);
        if(a.submitTime)return -1;if(b.submitTime)return 1;
        return b.lastActive-a.lastActive;
      }
      case 'fields':return b.fieldsCompleted-a.fieldsCompleted;
      case 'recent':return b.lastActive-a.lastActive;
      case 'name':return a.name.localeCompare(b.name);
      case 'registered':return(a.registeredAt||'').localeCompare(b.registeredAt||'');
      default:return 0;
    }
  });
  return teams;
}

let lbPerPage=15,lbCurrentPage=0;
let tmPerPage=15,tmCurrentPage=0;

function renderFullLeaderboard(){
  var body=document.getElementById('lbBody');
  if(!body)return;
  var teams=getSortedTeams();
  var maxFields=intelFields.length||1;
  var totalPossiblePts=intelFields.reduce(function(s,f){return s+((f.answer&&f.answer.points)||10)},0);
  var totalPages=Math.max(1,Math.ceil(teams.length/lbPerPage));
  if(lbCurrentPage>=totalPages)lbCurrentPage=totalPages-1;
  var startIdx=lbCurrentPage*lbPerPage;
  var pageTeams=teams.slice(startIdx,startIdx+lbPerPage);
  document.getElementById('lbTeamCount').textContent=teams.length+' team'+(teams.length!==1?'s':'');
  var adminActions=document.getElementById('lbAdminActions');
  if(adminActions)adminActions.style.display=isAdmin?'':'none';
  if(!teams.length){
    body.innerHTML='<div style="text-align:center;padding:40px 0"><div style="font-size:40px;opacity:.3;margin-bottom:12px">🏆</div><div style="font-family:Chakra Petch,sans-serif;font-size:11px;color:#555">No teams match your filters</div></div>';
    renderPagination('lbPagination',teams.length,lbPerPage,lbCurrentPage,function(p){lbCurrentPage=p;renderFullLeaderboard()});
    return;
  }
  body.innerHTML=pageTeams.map(function(t,idx){
    var rank=startIdx+idx+1;
    var rc=rank===1?'r1':rank===2?'r2':rank===3?'r3':'rn';
    var on=isTeamActive(t);
    var ghost=isTeamGhost(t);
    var expanded=lbExpandedTeam===t.id;
    var actualScore=t.submissionResults?t.submissionResults.totalScore:0;
    var correctCount=t.submissionResults?t.submissionResults.correctCount:0;
    var scorePct=totalPossiblePts?Math.round((actualScore/totalPossiblePts)*100):0;
    var barColor=rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#333';
    // Meta line: score + submission status
    var metaParts=[t.id];
    if(t.submitTime){
      metaParts.push(correctCount+'/'+maxFields+' correct');
      metaParts.push(actualScore+' pts');
      metaParts.push('✓ Submitted');
    }else{
      metaParts.push(actualScore>0?actualScore+' pts':'Awaiting submission');
    }
    var metaHtml=metaParts.map(function(p){
      if(p.indexOf('✓')===0)return '<span style="color:var(--green)">'+p+'</span>';
      return '<span>'+p+'</span>';
    }).join('');
    // Expanded detail
    var detailHtml='';
    if(expanded){
      var members=t.memberDetails||t.members||[];
      var membersHtml=members.map(function(m,mi){
        var name=typeof m==='string'?m:m.name;
        var dept=m.dept||'';var email=m.email||'';
        return '<div class="lb-member-row"><div class="lb-member-num">'+(mi+1)+'</div><span class="lb-member-name">'+name+'</span><span class="lb-member-meta">'+(dept?dept:'')+(dept&&email?' · ':'')+(email?email:'')+'</span></div>';
      }).join('');
      var fieldsHtml='';
      if(t.submissionResults){
        var sr=t.submissionResults;
        fieldsHtml='<div style="display:flex;flex-direction:column;gap:6px;padding:4px 0"><div class="lb-field-row"><span class="lb-field-label">Correct Answers</span><span class="lb-field-status correct">'+(sr.correctCount||0)+' / '+(sr.totalFields||maxFields)+'</span></div><div class="lb-field-row"><span class="lb-field-label">Score</span><span class="lb-field-status '+(sr.totalScore>0?'correct':'empty')+'">'+(sr.totalScore||0)+' / '+totalPossiblePts+' pts</span></div></div>';
      }else{
        fieldsHtml='<div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:#555;padding:8px 0">'+(t.submitTime?'Submitted — awaiting scoring':'Awaiting submission')+'</div>';
      }
      var msgBtn2=isAdmin?'<button class="lb-msg-btn" onclick="event.stopPropagation();sendTeamMessage(\''+t.id+'\',\''+t.name.replace(/'/g,"\\'")+'\')">💬 Message Team</button>':'';
      var desubBtn=isAdmin&&t.submitTime?'<button class="lb-desub-btn" onclick="event.stopPropagation();desubmitTeam(\''+t.id+'\')">↩ De-submit</button>':'';
      detailHtml='<div class="lb-detail"><div class="lb-detail-section"><div class="lb-detail-title">👥 Team Members</div>'+membersHtml+'</div><div class="lb-detail-section"><div class="lb-detail-title">📋 Field Status</div>'+fieldsHtml+'</div><div class="lb-detail-section"><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">'+msgBtn2+desubBtn+'</div></div><div class="lb-detail-section"><div style="display:flex;gap:16px;flex-wrap:wrap;font-family:IBM Plex Mono,monospace;font-size:8px;color:#666;letter-spacing:1px"><span>Registered: '+(t.registeredAt?new Date(t.registeredAt).toLocaleTimeString():'-')+'</span>'+(t.submitTime?'<span>Submitted: '+new Date(t.submitTime).toLocaleTimeString()+'</span>':'')+'</div></div></div>';
    }
    var checkbox=isAdmin&&t.submitTime?'<input type="checkbox" class="lb-desubmit-check" data-team="'+t.id+'" onclick="event.stopPropagation()">':'';
    return '<div class="lb-row'+(expanded?' expanded':'')+(ghost?' ghost':'')+'" onclick="toggleLbTeam(\''+t.id+'\')"><div class="lb-row-main">'+checkbox+'<div class="lb-rank '+rc+'">#'+rank+'</div><div class="lb-team-status '+(on?'on':'off')+'"></div><div class="lb-team-info"><div class="lb-team-name">'+t.name+'</div><div class="lb-team-meta">'+metaHtml+'</div></div><div class="lb-score-block"><div class="lb-score-pct '+rc+'">'+(t.submitTime?scorePct:0)+'%</div><div class="lb-score-label">'+(t.submitTime?actualScore+' PTS':'—')+'</div></div></div><div class="lb-progress"><div class="lb-progress-fill" style="width:'+(t.submitTime?scorePct:0)+'%;background:'+barColor+'"></div></div>'+detailHtml+'</div>';
  }).join('');
  renderPagination('lbPagination',teams.length,lbPerPage,lbCurrentPage,function(p){lbCurrentPage=p;renderFullLeaderboard()});
}

let _lbUserInteractedAt=0;
function toggleLbTeam(id){
  lbExpandedTeam=lbExpandedTeam===id?null:id;
  _lbLastHash='';
  _lbUserInteractedAt=Date.now();
  renderFullLeaderboard();
}

// ── Shared Pagination Renderer ──
function renderPagination(containerId,total,perPage,currentPage,onPageChange){
  const el=document.getElementById(containerId);
  if(!el)return;
  const totalPages=Math.ceil(total/perPage);
  if(totalPages<=1){el.innerHTML='';return}
  let html='';
  html+=`<button class="lb-page-btn${currentPage===0?' disabled':''}" onclick="event.stopPropagation()">◂ Prev</button>`;
  // Show max 7 page buttons with ellipsis
  const maxBtns=7;
  let startP=Math.max(0,currentPage-3);
  let endP=Math.min(totalPages-1,startP+maxBtns-1);
  if(endP-startP<maxBtns-1)startP=Math.max(0,endP-maxBtns+1);
  if(startP>0)html+=`<button class="lb-page-btn" data-p="0">1</button><span class="lb-page-info">…</span>`;
  for(let p=startP;p<=endP;p++){
    html+=`<button class="lb-page-btn${p===currentPage?' active':''}" data-p="${p}">${p+1}</button>`;
  }
  if(endP<totalPages-1)html+=`<span class="lb-page-info">…</span><button class="lb-page-btn" data-p="${totalPages-1}">${totalPages}</button>`;
  html+=`<button class="lb-page-btn${currentPage>=totalPages-1?' disabled':''}" data-p="${currentPage+1}">Next ▸</button>`;
  html+=`<span class="lb-page-info">${currentPage*perPage+1}–${Math.min(total,(currentPage+1)*perPage)} of ${total}</span>`;
  el.innerHTML=html;
  el.querySelectorAll('.lb-page-btn:not(.disabled)').forEach(btn=>{
    btn.addEventListener('click',e=>{
      e.stopPropagation();
      const txt=btn.textContent;
      if(txt.includes('Prev'))onPageChange(Math.max(0,currentPage-1));
      else if(txt.includes('Next'))onPageChange(Math.min(totalPages-1,currentPage+1));
      else if(btn.dataset.p!==undefined)onPageChange(parseInt(btn.dataset.p));
    });
  });
}

// ── Direct Team Messaging ──
function sendTeamMessage(teamId,teamName){
  showEditModal(`<h3>💬 Message: ${teamName}</h3>
    <div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:#666;letter-spacing:1px;margin-bottom:10px">Team ID: ${teamId} · Message will display as a banner on their screen</div>
    <div class="edit-field"><label>Message</label><textarea id="tmMsgText" rows="3" placeholder="Type a message to this team..." style="width:100%;background:#080a10;border:1px solid var(--border);border-radius:4px;padding:10px;color:var(--green);font-family:Chakra Petch,sans-serif;font-size:12px;outline:none;resize:vertical"></textarea></div>
    <div style="display:flex;gap:10px;margin-top:12px"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><span style="flex:1"></span><button class="btn-standard btn-cyan" onclick="dispatchTeamMessage('${teamId}')">📡 Send Message</button></div>`);
}
function dispatchTeamMessage(teamId){
  const msg=document.getElementById('tmMsgText')?.value.trim();
  if(!msg)return;
  // Send as targeted broadcast via backend — [TO:TEAMID] prefix tells player poll to filter
  const targetMsg='[TO:'+teamId+'] '+msg;
  apiCall('sendBroadcast',{message:targetMsg,type:'text'}).then(r=>{
    if(r.ok){
      hideEditModal();
      const flash=document.createElement('div');
      flash.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.3);border-radius:6px;padding:10px 20px;font-family:IBM Plex Mono,monospace;font-size:11px;color:var(--cyan);letter-spacing:1px;animation:fadeIn .3s ease';
      flash.textContent='✓ Message sent to '+teamId;
      document.body.appendChild(flash);
      setTimeout(()=>flash.remove(),2500);
    }else{
      alert('Failed to send message: '+(r.error||'Unknown error'));
    }
  });
}

// ── De-submit Mechanism ──
function desubmitTeam(teamId){
  const team=registeredTeams.find(t=>t.id===teamId);
  if(!team)return;
  team.submitTime=null;
  team.submissionResults=null;
  team.isSubmitted=false;
  // Clear on backend
  apiCall('desubmitTeam',{teamId:teamId}).then(r=>{});
  // Notification
  if(!window.teamMessages)window.teamMessages={};
  if(!window.teamMessages[teamId])window.teamMessages[teamId]=[];
  window.teamMessages[teamId].push({text:'Your submission has been reopened for revision by the administrator.',time:new Date().toISOString(),read:false,type:'system'});
  if(currentTeam&&currentTeam.id===teamId){
    isSubmitted=false;
    renderIntelForm();
    showPlayerBanner('text','Your submission has been reopened for revision. You may update your answers and re-submit.');
  }
  renderFullLeaderboard();
  renderLeaderboard();
}
function desubmitSelected(){
  const checks=document.querySelectorAll('.lb-desubmit-check:checked');
  if(!checks.length){
    alert('No teams selected. Expand a submitted team\'s row to use individual de-submit, or check the boxes next to submitted teams.');
    return;
  }
  if(!confirm(`De-submit ${checks.length} team(s)? Their submissions will be unlocked for revision.`))return;
  checks.forEach(cb=>{
    const teamId=cb.dataset.team;
    if(teamId)desubmitTeam(teamId);
  });
}
function desubmitAll(){
  const submitted=registeredTeams.filter(t=>t.submitTime);
  if(!submitted.length){alert('No teams have submitted yet.');return}
  if(!confirm(`De-submit ALL ${submitted.length} team(s)? Every submission will be unlocked for revision.`))return;
  submitted.forEach(t=>desubmitTeam(t.id));
}

// ── Keys & Codes Panel ──
function openKeysCodes(){
  switchAdminTab('keysCodesPanel');
  renderKeysCodes();
}
function closeKeysCodes(){const el=document.getElementById('keysCodesPanel');el.style.cssText='';el.classList.remove('active');hideAdminTabs()}

function renderKeysCodes(){
  const body=document.getElementById('kcBody');
  let html='';

  // Vault Locked Items (driven by media items with vaultLocked + vaultCode)
  const vaultLockedMedia=mediaItems.filter(m=>m.vaultLocked);
  html+=`<div class="kc-section">
    <div class="kc-section-title" style="margin-bottom:4px">🔐 Vault Locked Items (${vaultLockedMedia.length})</div>
    <div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#666;margin-bottom:8px">Items marked as Vault-Locked in the Evidence Locker. Edit any item there to set or change its Vault Code.</div>
    <button class="ap-btn ap-btn-amber" onclick="openVaultLockPicker()" style="font-size:9px;padding:5px 12px;margin-bottom:10px">＋ Vault Lock Item</button>`;
  if(vaultLockedMedia.length){
    vaultLockedMedia.forEach(m=>{
      const idx=mediaItems.indexOf(m);
      const vaultEntry=vaultCodes.find(c=>c.linkedMediaIdx===idx);
      html+=`<div class="kc-row" style="border-color:${m.vaultCode?'rgba(255,170,51,.15)':'rgba(255,51,51,.1)'}">
        <span class="kc-icon">${m.icon}</span>
        <span class="kc-label">${m.name}<br><span style="font-size:8px;color:#555">${m.desc||''}</span></span>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
          <input value="${m.vaultCode||''}" placeholder="Set vault code…" style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;background:#080a10;border:1px solid ${m.vaultCode?'rgba(255,170,51,.3)':'var(--border)'};border-radius:3px;padding:4px 10px;color:var(--amber);width:140px;outline:none;text-align:center" oninput="this.value=this.value.toUpperCase()" onchange="updateMediaVaultCode(${idx},this.value)">
          <span style="font-family:'Chakra Petch',sans-serif;font-size:8px;color:#555">${vaultEntry&&vaultEntry.unlocked?'✓ UNLOCKED':m.vaultCode?'Active':'No code set'}</span>
        </div>
        <span class="kc-edit" onclick="editMediaItem(${idx})">✎</span>
      </div>`;
    });
  }else{
    html+=`<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:4px 0">No vault-locked items. Edit an Evidence Locker item and enable the Vault-Locked toggle to add one.</div>`;
  }
  // Vault attempt settings
  html+=`<div style="margin-top:12px;padding:10px 14px;border:1px solid var(--border);border-radius:4px;background:rgba(255,255,255,.01)">
    <div style="font-family:Saira,sans-serif;font-size:9px;color:#888;letter-spacing:2px;font-weight:600;text-transform:uppercase;margin-bottom:8px">Vault Security Settings</div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="kcVaultUnlimited" ${regSettings.vaultUnlimitedAttempts?'checked':''} onchange="regSettings.vaultUnlimitedAttempts=this.checked"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#aaa">Unlimited attempts</span></label>
      <div style="display:flex;align-items:center;gap:6px"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#888">Max tries:</span><input type="number" id="kcVaultMaxAttempts" value="${regSettings.vaultMaxAttempts}" min="1" max="50" style="width:50px;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 8px;color:var(--green);font-family:IBM Plex Mono,monospace;font-size:11px;text-align:center;outline:none" onchange="regSettings.vaultMaxAttempts=parseInt(this.value)||5"></div>
      <div style="display:flex;align-items:center;gap:6px"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#888">Cooldown:</span><input type="number" id="kcVaultCooldown" value="${regSettings.vaultCooldownSec}" min="5" max="600" style="width:60px;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 8px;color:var(--green);font-family:IBM Plex Mono,monospace;font-size:11px;text-align:center;outline:none" onchange="regSettings.vaultCooldownSec=parseInt(this.value)||30"><span style="font-family:Chakra Petch,sans-serif;font-size:10px;color:#555">sec</span></div>
    </div>
  </div>`;
  html+=`</div>`;

  // Locked Media Keys
  const lockedItems=mediaItems.filter(m=>m.type==='locked');
  html+=`<div class="kc-section">
    <div class="kc-section-title">🔒 Locked File Decryption Keys (${lockedItems.length})</div>`;
  if(lockedItems.length){
    lockedItems.forEach((m,li)=>{
      const idx=mediaItems.indexOf(m);
      html+=`<div class="kc-row">
        <span class="kc-icon">${m.icon}</span>
        <span class="kc-label">${m.name}<br><span style="font-size:8px;color:#555">${m.desc}</span></span>
        <span class="kc-value">${m.unlockKey||'<span class="kc-empty">any key</span>'}</span>
        <span class="kc-edit" onclick="editMediaItem(${idx})">✎</span>
      </div>`;
    });
  }else{
    html+=`<div style="font-family:Chakra Petch,sans-serif;font-size:9px;color:#555;padding:8px 0">No locked files configured</div>`;
  }
  html+=`</div>`;

  // Answer Keys Summary
  html+=`<div class="kc-section">
    <div class="kc-section-title">🎯 Intel Answer Keys (${intelFields.length})</div>`;
  intelFields.forEach((f,i)=>{
    const a=f.answer||{};
    const exp=a.expected?.filter(e=>e.trim())||[];
    const alts=a.alts||[];
    const allAnswers=[...exp,...alts].filter(Boolean);
    html+=`<div class="kc-row">
      <span class="kc-icon">${f.emoji}</span>
      <span class="kc-label">${f.label}<br><span style="font-size:8px;color:#555">${a.matchMode||'exact'} · ${a.caseSensitive?'Case Sensitive':'Case Insensitive'} · Fuzzy: ${a.fuzzyThreshold||85}% · ${a.points||10}pts</span></span>
      <span class="kc-value" style="min-width:auto;font-size:10px">${allAnswers.length?allAnswers.join(', '):'<span class="kc-empty">not set</span>'}</span>
      <span class="kc-edit" onclick="editIntelField(${i})">✎</span>
    </div>`;
  });
  html+=`</div>`;

  body.innerHTML=html;
}

// Update vault code directly from the Keys & Codes panel inline input
function updateMediaVaultCode(mediaIdx,newCode){
  if(!mediaItems[mediaIdx])return;
  mediaItems[mediaIdx].vaultCode=newCode.trim().toUpperCase();
  syncVaultCodesFromMedia();
  renderVaultPanel();
  saveMediaItemsToBackend();
}

// Vault code management functions (addVaultCode, editVaultCode, etc.) removed.
// Vault codes are now set directly on media items via editMediaItem() and
// syncVaultCodesFromMedia() rebuilds the runtime vaultCodes lookup array.

// ── Broadcast System ──
let bcMode='text';
let bcMediaRecorder=null;
let bcAudioChunks=[];
let bcRecordedBlob=null;
let bcBannerAudio=null;

function openBroadcast(){
  // Navigate to settings broadcast tab
  navigateToAdmin('settingsScreen','dash-broadcast');
}
function closeBroadcast(){
  const el=document.getElementById('broadcastPanel');
  el.style.cssText='';el.classList.remove('active');
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording')bcMediaRecorder.stop();
}
function switchBcTab(btn,tab){
  document.querySelectorAll('.bc-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');
  document.getElementById('bcTextTab').style.display=tab==='text'?'':'none';
  document.getElementById('bcVoiceTab').style.display=tab==='voice'?'':'none';
  bcMode=tab;
}

function toggleRecording(){
  const btn=document.getElementById('bcRecBtn');
  const label=document.getElementById('bcRecLabel');
  if(bcMediaRecorder&&bcMediaRecorder.state==='recording'){
    bcMediaRecorder.stop();btn.classList.remove('recording');label.textContent='Processing...';
    return;
  }
  bcAudioChunks=[];bcRecordedBlob=null;
  document.getElementById('bcPreview').style.display='none';
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    bcMediaRecorder=new MediaRecorder(stream);
    bcMediaRecorder.ondataavailable=e=>{if(e.data.size>0)bcAudioChunks.push(e.data)};
    bcMediaRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      bcRecordedBlob=new Blob(bcAudioChunks,{type:'audio/webm'});
      const url=URL.createObjectURL(bcRecordedBlob);
      document.getElementById('bcAudioPreview').src=url;
      document.getElementById('bcPreview').style.display='block';
      label.textContent='Recording ready — preview above';
    };
    bcMediaRecorder.start();btn.classList.add('recording');label.textContent='🔴 Recording... tap to stop';
  }).catch(()=>{label.innerHTML='<span style="color:var(--amber)">⚠ Microphone access denied — check browser permissions</span>'});
}

function sendBroadcast(){
  if(bcMode==='text'){
    const msg=document.getElementById('bcMessage').value.trim();
    if(!msg)return;
    apiCall('sendBroadcast',{message:msg,type:'text'}).then(r=>{
      if(r.ok){
        document.getElementById('bcMessage').value='';
        closeBroadcast();
        const flash=document.createElement('div');
        flash.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.3);border-radius:6px;padding:10px 20px;font-family:IBM Plex Mono,monospace;font-size:11px;color:var(--green);letter-spacing:1px';
        flash.textContent='✓ Broadcast sent to all teams';
        document.body.appendChild(flash);
        setTimeout(()=>flash.remove(),3000);
      }else{
        alert('Broadcast failed: '+(r.error||'Unknown error')+'\nYou may need to re-login as admin.');
      }
    });
  } else {
    if(!bcRecordedBlob){return}
    uploadFileToDrive(new File([bcRecordedBlob],'broadcast_'+Date.now()+'.webm',{type:bcRecordedBlob.type}),'broadcasts').then(result=>{
      apiCall('sendBroadcast',{message:result.directUrl,type:'voice'}).then(r=>{
        if(r.ok){
          bcRecordedBlob=null;
          document.getElementById('bcPreview').style.display='none';
          document.getElementById('bcRecLabel').textContent='Tap to record';
          closeBroadcast();
        }
      });
    }).catch(err=>{
      bcRecordedBlob=null;
      document.getElementById('bcPreview').style.display='none';
      closeBroadcast();
    });
  }
}

// ── Broadcast Polling (players check for new messages) ──
let _lastBroadcastTime='';
let _broadcastPollInterval=null;

// ── Player Activity Tracker ──
// Tracks clicks, scrolls, keypresses, touches — debounced to avoid spam.
// The broadcast poll reads _lastPlayerActivity to include in heartbeat.
let _lastPlayerActivity=0;
let _activityListenersAttached=false;
function startActivityTracker(){
  if(_activityListenersAttached||isAdmin)return;
  _activityListenersAttached=true;
  function markActive(){_lastPlayerActivity=Date.now()}
  ['click','scroll','keydown','touchstart','pointerdown'].forEach(function(evt){
    document.addEventListener(evt,markActive,{passive:true,capture:true});
  });
  // Mark active immediately on start
  markActive();
}

function startBroadcastPolling(){
  if(_broadcastPollInterval)clearInterval(_broadcastPollInterval);
  if(isAdmin)return;
  _lastBroadcastTime=new Date().toISOString();
  _broadcastPollInterval=setInterval(async()=>{
    if(!currentVaultTeam)return;
    // Parallel fetch — broadcasts + config session check
    const [r, cfg] = await Promise.all([
      apiCall('getBroadcasts',{since:_lastBroadcastTime,teamId:(_lastPlayerActivity&&(Date.now()-_lastPlayerActivity)<(activityThresholds.activeToIdle||120)*1000)?currentVaultTeam?.id:undefined}),
      apiCall('getEventConfig')
    ]);
    if(r.ok&&r.broadcasts&&r.broadcasts.length>0){
      r.broadcasts.forEach(b=>{
        _lastBroadcastTime=b.sentAt;
        // Filter targeted messages: [TO:TEAMID] prefix
        const targetMatch=b.message.match(/^\[TO:([^\]]+)\]\s*/);
        if(targetMatch){
          if(currentVaultTeam&&targetMatch[1]===currentVaultTeam.id){
            showPlayerBanner(b.type,b.message.replace(/^\[TO:[^\]]+\]\s*/,''));
          }
        }else{
          showPlayerBanner(b.type,b.message);
        }
      });
    }
    // Lightweight session generation check (cfg already fetched in parallel above)
    if(cfg.ok&&cfg.config){
      const serverGen=String(cfg.config.sessionGenTeam||'0');
      const localGen=localStorage.getItem('cb_sessionGen')||'0';
      if(localGen!=='0'&&serverGen!=='0'&&localGen!==serverGen){
        clearSession();location.reload();return;
      }
      try{localStorage.setItem('cb_sessionGen',serverGen)}catch(e){}
      // Sync appearance settings pushed by admin
      if(cfg.config.consoleBgColor||cfg.config.consoleBgTexture)syncConsoleBgFromConfig(cfg.config);
      if(cfg.config.intelTheme)applyIntelTheme(cfg.config.intelTheme);
    }
  },5000);
}

let bannerDismissTimer=null;
let bannerProgressInterval=null;
let notifications=[];

function showPlayerBanner(type,content){
  const banner=document.getElementById('playerBanner');
  const icon=document.getElementById('pbIcon');
  const body=document.getElementById('pbContent');
  const progress=document.getElementById('pbProgress');
  playNotification();

  // Store notification and update badge (players only)
  if(!isAdmin){
    notifications.unshift({type,content,time:new Date().toLocaleTimeString(),read:false});
    updateNotificationBadge();
  }

  if(type==='text'){
    icon.textContent='📢';
    body.innerHTML=`<span class="pb-text">${content}</span>`;
  } else {
    icon.textContent='🎙️';
    body.innerHTML=`<div class="pb-audio"><span class="pb-audio-label">Incoming audio from Administrator</span><div class="pb-audio-play" id="pbAudioPlay" onclick="event.stopPropagation();toggleBannerAudio()">▶</div></div>`;
    bcBannerAudio=new Audio(content);
    bcBannerAudio.addEventListener('ended',()=>{document.getElementById('pbAudioPlay').textContent='▶'});
  }

  // Auto-dismiss after 10 seconds with progress bar
  if(bannerDismissTimer)clearTimeout(bannerDismissTimer);
  if(bannerProgressInterval)clearInterval(bannerProgressInterval);
  if(progress)progress.style.width='100%';
  const duration=10000;
  const start=Date.now();
  bannerProgressInterval=setInterval(()=>{
    const elapsed=Date.now()-start;
    const remaining=Math.max(0,1-elapsed/duration);
    if(progress)progress.style.width=(remaining*100)+'%';
    if(remaining<=0)clearInterval(bannerProgressInterval);
  },50);
  bannerDismissTimer=setTimeout(()=>dismissBanner(),duration);

  banner.classList.add('show');
}
function toggleBannerAudio(){
  if(!bcBannerAudio)return;
  const btn=document.getElementById('pbAudioPlay');
  if(bcBannerAudio.paused){bcBannerAudio.play();btn.textContent='⏸'}
  else{bcBannerAudio.pause();btn.textContent='▶'}
}
function dismissBanner(){
  document.getElementById('playerBanner').classList.remove('show');
  if(bcBannerAudio){bcBannerAudio.pause();bcBannerAudio=null}
  if(bannerDismissTimer){clearTimeout(bannerDismissTimer);bannerDismissTimer=null}
  if(bannerProgressInterval){clearInterval(bannerProgressInterval);bannerProgressInterval=null}
  const progress=document.getElementById('pbProgress');if(progress)progress.style.width='0';
}
function playNotification(){
  const c=getAudio();if(!c)return;
  const t=c.currentTime;
  [0,.12,.24].forEach((off,i)=>{
    const freq=[800,1000,1200][i];
    const o=c.createOscillator();o.type='sine';o.frequency.value=freq;
    const g=c.createGain();g.gain.setValueAtTime(.06,t+off);g.gain.exponentialRampToValueAtTime(.001,t+off+.15);
    o.connect(g);g.connect(c.destination);o.start(t+off);o.stop(t+off+.15);
  });
}

function updateNotificationBadge(){
  const badge=document.getElementById('teamNotifBadge');
  const unread=notifications.filter(n=>!n.read).length;
  if(badge){
    badge.textContent=unread;
    badge.classList.toggle('has-notifs',unread>0);
  }
}
function renderNotifications(){
  const list=document.getElementById('teamNotifList');
  if(!list)return;
  if(!notifications.length){list.innerHTML='<div class="notif-empty">No notifications yet</div>';return}
  list.innerHTML=notifications.map((n,i)=>{
    if(n.type==='voice'){
      return `<div class="team-card-notif-item"><span class="notif-time">${n.time}</span><span class="notif-voice-row">🎙️ Voice message <span class="notif-play-btn" onclick="event.stopPropagation();playNotifAudio(${i})" id="notifPlay${i}">▶</span></span></div>`;
    }
    return `<div class="team-card-notif-item"><span class="notif-time">${n.time}</span>${n.content}</div>`;
  }).join('');
}

let _notifAudio=null;
function playNotifAudio(idx){
  const n=notifications[idx];
  if(!n||n.type!=='voice')return;
  const btn=document.getElementById('notifPlay'+idx);
  if(_notifAudio){
    _notifAudio.pause();
    // Reset all play buttons
    document.querySelectorAll('.notif-play-btn').forEach(b=>b.textContent='▶');
    if(_notifAudio._notifIdx===idx){_notifAudio=null;return}
  }
  _notifAudio=new Audio(n.content);
  _notifAudio._notifIdx=idx;
  _notifAudio.play();
  if(btn)btn.textContent='⏸';
  _notifAudio.addEventListener('ended',()=>{if(btn)btn.textContent='▶';_notifAudio=null});
}
function clearNotifications(){
  notifications=[];
  updateNotificationBadge();
  renderNotifications();
}
// Mark notifications as read when team card is opened
function onTeamCardOpen(){
  notifications.forEach(n=>n.read=true);
  updateNotificationBadge();
  renderNotifications();
}

// ── Vault Keypad Symbol Toggle ──
let symMode=false;
const symRows=[
  ['!','@','#','$','%','^','&','*','(',')'],
  ['-','_','=','+','[',']','{','}','|'],
  [';',':','"','<','>','/','.']
];
const alphaRows=[
  ['Q','W','E','R','T','Y','U','I','O','P'],
  ['A','S','D','F','G','H','J','K','L'],
  ['Z','X','C','V','B','N','M']
];
// Symbol toggle (legacy) — vault puzzle uses vkToggleSymbols

// ══════ ADMIN EDIT MODALS ══════
function showEditModal(html){document.getElementById('editBox').innerHTML=html;document.getElementById('adminEditModal').classList.add('active')}
function hideEditModal(){document.getElementById('adminEditModal').classList.remove('active');_resetZoomCursor()}

// ── File type auto-detection ──
const typeMap={wav:'audio',mp3:'audio',ogg:'audio',flac:'audio',aac:'audio',m4a:'audio',wma:'audio',pdf:'document',doc:'document',docx:'document',txt:'document',csv:'document',xlsx:'document',xls:'document',rtf:'document',png:'image',jpg:'image',jpeg:'image',gif:'image',webp:'image',svg:'image',bmp:'image',mp4:'video',mov:'video',avi:'video',mkv:'video',webm:'video',zip:'document',rar:'document'};
const iconMap={document:'📄',image:'🖼️',audio:'🎵',video:'🎬',dossier:'📋',doc:'📄',map:'🗺️',locked:'🔒'};
function detectType(name){const ext=(name.split('.').pop()||'').toLowerCase();return typeMap[ext]||'document'}
function detectIcon(type){return iconMap[type]||'📄'}

// ── Upload storage ──
let pendingUpload='';
function handleUpload(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{pendingUpload=e.target.result;const zone=document.getElementById('uploadZone');zone.classList.add('has-file');zone.innerHTML=`<img src="${pendingUpload}" class="upload-preview"><br>✓ ${file.name}`};
  reader.readAsDataURL(file);
}
let pendingMediaFileUrl='';
let _uploadingIndicator=null;

async function uploadFileToDrive(file,subfolder){
  // Step 1: Get an upload ticket from cb-api (secret stays server-side)
  const ticketResult=await apiCall('getUploadUrl',{subfolder:subfolder||''});
  if(!ticketResult.ok)throw new Error(ticketResult.error||'Failed to get upload authorization');
  
  // Step 2: Upload directly to R2 Worker with the one-time ticket
  const formData=new FormData();
  formData.append('file',file);
  formData.append('fileName',file.name||'upload_'+Date.now());
  formData.append('mimeType',file.type||'application/octet-stream');
  formData.append('subfolder',subfolder||'');
  
  const resp=await fetch(ticketResult.uploadUrl,{
    method:'POST',
    headers:{'X-Upload-Ticket':ticketResult.ticket},
    body:formData
  });
  
  const result=await resp.json();
  if(!result.ok)throw new Error(result.error||'Upload failed');
  
  return{
    ok:true,
    directUrl:result.url,
    previewUrl:result.url,
    fileId:result.key,
    fileName:result.fileName,
    mimeType:result.mimeType
  };
}

function showUploadProgress(zone,msg){
  if(zone)zone.innerHTML=`<div style="text-align:center;padding:10px"><div class="upload-spinner"></div><div style="font-size:9px;color:var(--amber);margin-top:6px;letter-spacing:1px">${msg||'UPLOADING TO DRIVE...'}</div></div>`;
}

function handleMediaUpload(input){
  const file=input.files[0];if(!file)return;
  const nameEl=document.getElementById('em_name');
  const typeEl=document.getElementById('em_type');
  const iconEl=document.getElementById('em_ico');
  if(!nameEl.value.trim())nameEl.value=file.name;
  const t=detectType(file.name);
  typeEl.value=t;
  iconEl.value=detectIcon(t);
  
  // Show upload progress
  input.insertAdjacentHTML('afterend','<div id="em_upload_status" style="font-size:9px;color:var(--cyan);margin-top:4px">Uploading...</div>');
  
  uploadFileToDrive(file,'media').then(result=>{
    pendingMediaFileUrl=result.directUrl;
    const status=document.getElementById('em_upload_status');
    if(status){status.textContent='✓ Uploaded successfully';status.style.color='var(--green)'}
  }).catch(err=>{
    console.error('Upload error:',err);
    const status=document.getElementById('em_upload_status');
    if(status){status.textContent='✗ Upload failed — try again';status.style.color='var(--red)'}
  }).finally(()=>{try{document.activeElement&&document.activeElement.blur&&document.activeElement.blur()}catch(e){} _resetZoomCursor();});
}
function switchTab(btn,tab){btn.parentElement.querySelectorAll('.edit-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');btn.parentElement.parentElement.querySelectorAll('.edit-tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active')}

// ── Operation Name ──
function editOperationName(){
  showEditModal(`<h3>Edit Operation Details</h3>
    <div class="edit-font-row"><div class="edit-field"><label>Operation Title</label><input id="eo_name" value="${operationName}"></div><div class="edit-field"><label>Font</label>${fontSelect('eo_name_font',operationFont)}</div></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveOperationName()">Save</button></div>`);
}
function saveOperationName(){
  operationName=document.getElementById('eo_name').value.trim()||'Operation Dead Drop';
  operationFont=document.getElementById('eo_name_font').value;
  const ct=document.getElementById('consoleTitle');
  if(ct)ct.textContent='◈ '+operationName;
  applyOperationFont(operationFont);
  // Update page title and registration screen
  document.title=operationName+' — Console';
  const regTitle=document.getElementById('regScreenTitle');
  if(regTitle)regTitle.textContent=operationName;
  const loginTitle=document.getElementById('loginTitle');
  if(loginTitle)loginTitle.textContent=operationName;
  hideEditModal();
  saveEventConfigToBackend();
}

// ── Grid Tiles ──
function vaultBadgeText(){
  const u=vaultCodes.filter(c=>c.unlocked).length,t=vaultCodes.length;
  if(t===0)return 'EMPTY';
  return u+' OF '+t+' UNLOCKED';
}
function updateVaultBadgeColor(){
  const badge=document.getElementById('vaultBadge');
  if(!badge)return;
  const u=vaultCodes.filter(c=>c.unlocked).length,t=vaultCodes.length;
  badge.textContent=vaultBadgeText();
  if(t===0){badge.style.color='';return}
  const pct=u/t;
  if(pct>=1){badge.style.color='#00ff88';badge.style.textShadow='0 0 8px rgba(0,255,136,.5)'}
  else if(pct>=0.75){badge.style.color='#66ff88';badge.style.textShadow='0 0 4px rgba(0,255,136,.3)'}
  else if(pct>=0.5){badge.style.color='#aadd66';badge.style.textShadow=''}
  else if(pct>0){badge.style.color='#ccbb44';badge.style.textShadow=''}
  else{badge.style.color='';badge.style.textShadow=''}
}
function tileBadgeText(id,isAdmin){
  if(id==='feed')return posts.length?posts.length+(posts.length===1?' POST':' POSTS'):'NO INTEL';
  if(id==='media'){
    const count=isAdmin?mediaItems.length:mediaItems.filter(m=>!m.vaultLocked||vaultCodes.find(c=>c.linkedMediaIdx===mediaItems.indexOf(m)&&c.unlocked)).length;
    return count?count+' ITEMS':'0 ITEMS';
  }
  if(id==='vault')return vaultBadgeText();
  // intel — count filled fields from best available source
  let filled=0;
  // 1. Try DOM inputs (most current when panel is open)
  const inputs=document.querySelectorAll('.intel-exp-input');
  if(inputs.length>0){
    inputs.forEach(inp=>{if(inp.value&&inp.value.trim())filled++});
  }else{
    // 2. Fall back to localStorage drafts (reliable when panel is closed)
    try{
      const tid=currentVaultTeam?.id||'UNKNOWN';
      const raw=localStorage.getItem('cb_gs_'+tid+'_intelDraft');
      if(raw){const d=JSON.parse(raw);filled=Object.keys(d).filter(k=>d[k]&&String(d[k]).trim()).length}
    }catch(e){}
  }
  if(isSubmitted) return filled+' OF '+intelFields.length+' SUBMITTED';
  return filled+' OF '+intelFields.length+' ENTERED';
}
function renderGrid(){
  updateTileStates(); // Always recalculate orb states before rendering
  const isA=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  const g=document.getElementById('consoleGrid');
  g.innerHTML=gridTiles.map((t,i)=>{
    const isIntel=t.id==='intel';
    const isVault=t.id==='vault';
    const badgeCls=isVault?' crimson':isIntel?' violet':'';
    return `<div class="crt-monitor" data-tile="${t.id}" onclick="openPanel('${t.id}')">
      ${isA?`<div class="admin-edit-btn" onclick="event.stopPropagation();editGridTile(${i})">✎</div>`:''}
      <div class="crt-screw s1"></div><div class="crt-screw s2"></div><div class="crt-screw s3"></div><div class="crt-screw s4"></div>
      <div class="crt-led"></div>
      <div class="crt-screen">
        <div class="tile-glow"></div>
        <div class="tile-icon">${t.icon.startsWith('http')||t.icon.startsWith('data:')?`<img src="${t.icon}" style="width:48px;height:48px;object-fit:contain">`:t.icon}</div>
        <div class="tile-label" style="${fontStyle(t.labelFont)}">${t.label}</div>
        <div class="tile-sub" style="${fontStyle(t.subFont)}">${t.sub}</div>
        <div class="tile-badge${badgeCls}" id="${t.badgeId}">${tileBadgeText(t.id,isA)}</div>
        <div class="tile-status" title="${t.dotClass==='active'?'Activity detected recently':t.dotClass==='idle'?'No recent activity':'No activity recorded yet'}"><div class="tile-dot ${t.dotClass}"></div><span class="tile-status-label ${t.dotClass}">${t.status}</span></div>
      </div>
    </div>`;
  }).join('');
  updateVaultBadgeColor();
}
function editGridTile(i){
  const t=gridTiles[i];
  const isImgIcon=t.icon.startsWith('http')||t.icon.startsWith('data:');
  showEditModal(`<h3>Edit Grid Tile: ${t.label}</h3>
    <div class="edit-field"><label>Icon</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="eg_icon" value="${isImgIcon?'':t.icon}" placeholder="Type emoji (e.g. 📡)" style="flex:1;${isImgIcon?'display:none':''}">
        <label style="cursor:pointer;font-size:9px;color:var(--cyan);letter-spacing:1px;padding:8px 12px;border:1px solid rgba(0,212,255,.2);border-radius:3px;background:rgba(0,212,255,.05);white-space:nowrap">
          📁 Upload Image
          <input type="file" accept="image/*" onchange="handleGridIconUpload(this)" style="display:none">
        </label>
      </div>
      ${isImgIcon?`<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><img src="${t.icon}" style="width:36px;height:36px;object-fit:contain;border-radius:4px;border:1px solid var(--border)"><span style="font-size:8px;color:#666">Current icon</span><button onclick="document.getElementById('eg_icon').style.display='';document.getElementById('eg_icon').value='📡';this.parentElement.remove()" style="font-size:8px;color:var(--red);background:none;border:1px solid rgba(255,50,50,.2);border-radius:3px;padding:2px 8px;cursor:pointer">Remove</button></div>`:''}
      <div id="eg_icon_preview"></div>
    </div>
    <div class="edit-field-row">
      <div class="edit-field"><label>Label</label><input id="eg_label" value="${t.label}"></div>
    </div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="eg_label_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply label font to all grid tiles</span></label>
    <div class="edit-font-row"><div class="edit-field"><label>Description</label><input id="eg_sub" value="${t.sub}"></div><div class="edit-field"><label>Desc Font</label>${fontSelect('eg_sub_font',t.subFont)}</div></div>
    <label style="display:flex;align-items:center;gap:6px;margin:-8px 0 10px;cursor:pointer"><input type="checkbox" id="eg_sub_all"><span style="font-size:9px;color:#888;letter-spacing:1px">Apply description font to all grid tiles</span></label>
    <div style="font-size:9px;color:#555;letter-spacing:.5px;padding:6px 0;border-top:1px solid var(--border);margin-top:4px">🟢 Status orb is auto-managed by activity thresholds (configurable in Mission Control)</div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveGridTile(${i})">Save</button></div>`);
  // If image icon, store URL in hidden state
  if(isImgIcon)document.getElementById('eg_icon').value=t.icon;
}
function handleGridIconUpload(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  const prev=document.getElementById('eg_icon_preview');
  if(prev){prev.innerHTML=`<div style="margin-top:6px;font-size:9px;color:var(--cyan);letter-spacing:1px">Uploading...</div>`;}
  uploadFileToDrive(file,'icons').then(r=>{
    document.getElementById('eg_icon').value=r.directUrl;
    if(prev){prev.innerHTML=`<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><img src="${r.directUrl}" style="width:36px;height:36px;object-fit:contain;border-radius:4px;border:1px solid var(--border)"><span style="font-size:8px;color:var(--green)">✓ Uploaded</span></div>`;}
  }).catch(err=>{
    console.error('Grid icon upload failed:',err);
    const reader=new FileReader();
    reader.onload=function(e){
      document.getElementById('eg_icon').value=e.target.result;
      if(prev){prev.innerHTML=`<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><img src="${e.target.result}" style="width:36px;height:36px;object-fit:contain;border-radius:4px;border:1px solid var(--border)"><span style="font-size:8px;color:var(--amber)">⚠ Local only (upload failed)</span></div>`;}
    };
    reader.readAsDataURL(file);
  }).finally(()=>{try{document.activeElement&&document.activeElement.blur&&document.activeElement.blur()}catch(e){} _resetZoomCursor();});
}
function saveGridTile(i){
  gridTiles[i].icon=document.getElementById('eg_icon').value.trim()||'📡';
  gridTiles[i].label=document.getElementById('eg_label').value.trim();
  gridTiles[i].sub=document.getElementById('eg_sub').value.trim();
  const lf=document.getElementById('eg_label_font').value;
  const sf=document.getElementById('eg_sub_font').value;
  gridTiles[i].labelFont=lf;
  gridTiles[i].subFont=sf;
  if(document.getElementById('eg_label_all').checked)gridTiles.forEach(t=>t.labelFont=lf);
  if(document.getElementById('eg_sub_all').checked)gridTiles.forEach(t=>t.subFont=sf);
  hideEditModal();renderGrid();saveEventConfigToBackend();
}

// ── Intel Fields ──
function renderIntelForm(){
  const isA=document.body.classList.contains('admin-mode')&&!document.body.classList.contains('player-preview');
  const form=document.getElementById('intelForm');
  // Preserve existing input values
  const prevVals={};
  form.querySelectorAll('.intel-exp-input').forEach(inp=>{prevVals[inp.dataset.idx]=inp.value});
  let html='';
  intelFields.forEach((f,i)=>{
    const num=String(i+1).padStart(2,'0');
    // Admin tools are positioned absolutely — they don't affect row layout
    const adminTools=isA?`<div class="intel-admin-tools"><div class="drag-handle" onpointerdown="startIntelDrag(event,${i})" onclick="event.stopPropagation()">⋮⋮</div><div class="admin-row-edit" onclick="event.stopPropagation();editIntelField(${i})">✎</div></div>`:'';
    const _lFont=resolveFont('intelLabel',f.font||'');
    const _iFont=resolveFont('intelInput',f.inputFont||'');
    const lStyle=_lFont?` style="${fontStyle(_lFont)}"`:'';
    const iStyle=_iFont?` style="${fontStyle(_iFont)}"`:'';
    const clearBtn=`<div class="intel-saved-blip" data-save-idx="${i}">saved</div><div class="intel-exp-clear" onclick="clearIntelSlot(this)" title="Clear field">X</div>`;
    const keyHandler='onkeydown="if(event.key===\'Enter\'){this.blur()}"';
    const ph=f.placeholder||'···';
    if((f.type||f.fieldType)==='money'){
      const _moneyIStyle=_iFont?`border:none;background:transparent;box-shadow:none;${fontStyle(_iFont)}`:'border:none;background:transparent;box-shadow:none';
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><div class="intel-prefix-wrap"><span class="intel-prefix">$</span><input class="intel-exp-input" style="${_moneyIStyle}" placeholder="${ph}" data-idx="${i}" oninput="formatMoney(this)" ${keyHandler}></div>${clearBtn}</div>`;
    }else if(f.type==='phone'){
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input"${iStyle} placeholder="${f.placeholder||'(XXX) XXX-XXXX'}" data-idx="${i}" oninput="formatPhone(this)" ${keyHandler}>${clearBtn}</div>`;
    }else if(f.type==='number'){
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input"${iStyle} placeholder="${ph}" data-idx="${i}" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9.\\-]/g,'')" ${keyHandler}>${clearBtn}</div>`;
    }else if(f.type==='date'){
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input"${iStyle} placeholder="${f.placeholder||'MM/DD/YYYY'}" data-idx="${i}" oninput="formatDate(this)" maxlength="10" ${keyHandler}>${clearBtn}</div>`;
    }else if(f.type==='email'){
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input"${iStyle} placeholder="${f.placeholder||'name@domain.com'}" data-idx="${i}" inputmode="email" ${keyHandler}>${clearBtn}</div>`;
    }else if(f.type==='plate'){
      const _plateIStyle=`text-transform:uppercase;letter-spacing:2px${_iFont?';'+fontStyle(_iFont):''}`;
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input" placeholder="${f.placeholder||'ABC-1234'}" data-idx="${i}" style="${_plateIStyle}" oninput="this.value=this.value.toUpperCase()" maxlength="12" ${keyHandler}>${clearBtn}</div>`;
    }else if(f.type==='select'){
      const opts=(f.options||[]).map(o=>`<option value="${o}">${o}</option>`).join('');
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><select class="intel-exp-input intel-select"${iStyle} data-idx="${i}"><option value="">— Select —</option>${opts}</select>${clearBtn}</div>`;
    }else if(f.type==='dual'){
      const ph1=f.placeholder1||'Value 1';
      const ph2=f.placeholder2||'Value 2';
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><div class="intel-dual-wrap"><input class="intel-exp-input"${iStyle} placeholder="${ph1}" data-idx="${i}" ${keyHandler}><span class="intel-dual-sep">&</span><input class="intel-exp-input"${iStyle} placeholder="${ph2}" data-idx="${i}b" ${keyHandler}></div>${clearBtn}</div>`;
    }else{
      html+=`<div class="intel-exp-row" data-idx="${i}">${adminTools}<span class="intel-exp-num">${num}</span><span class="intel-exp-label"${lStyle}>${f.label} ${f.emoji}</span><input class="intel-exp-input"${iStyle} placeholder="${ph}" data-idx="${i}" ${keyHandler}>${clearBtn}</div>`;
    }
  });
  if(isA)html+=`<div class="admin-add-btn" style="margin-top:10px;padding:14px;max-width:600px;width:100%" onclick="addIntelField()">+ Add Intel Field</div>`;
  form.innerHTML=html;
  // Render transmit button into sticky dock
  const dock=document.getElementById('intelTransmitDock');
  const isAdminUser=document.body.classList.contains('admin-mode');
  const isPreview=document.body.classList.contains('player-preview');
  if(dock){
    if(isAdminUser&&!isPreview){
      dock.innerHTML=`<button class="intel-submit-btn intel-submit-admin-test" id="intelSubmitBtn" onclick="showConfirm()">SUBMIT INTEL</button>`;
    }else{
      dock.innerHTML=`<button class="intel-submit-btn" id="intelSubmitBtn" onclick="showConfirm()">SUBMIT INTEL</button>`;
    }
  }
  // Restore values
  form.querySelectorAll('.intel-exp-input').forEach(inp=>{if(prevVals[inp.dataset.idx])inp.value=prevVals[inp.dataset.idx]});
  if(isSubmitted){form.querySelectorAll('.intel-exp-input').forEach(inp=>{inp.disabled=true});const btn=document.getElementById('intelSubmitBtn');if(btn){btn.disabled=true;btn.textContent='INTEL SUBMITTED'};const ntc=document.getElementById('intelNotice');if(ntc)ntc.style.display='none';form.querySelectorAll('.intel-saved-blip,.intel-exp-clear').forEach(el=>el.style.display='none')}
  // Sync intelLabels array
  syncIntelLabels();
}
// Delegated listener: auto-save intel draft as user types
let _draftSaveTimer=null;
function saveDraftsToBackend(){
  if(!currentVaultTeam||isAdmin)return;
  const drafts={};
  document.querySelectorAll('.intel-exp-input').forEach(inp=>{
    const idx=inp.dataset.idx;
    if(idx!==undefined&&inp.value.trim())drafts[idx]=inp.value;
  });
  apiCall('saveDrafts',{teamId:currentVaultTeam.id,drafts:drafts}).then(r=>{
    if(!r||!r.ok)console.warn('Draft save failed:',r);
  });
}
function loadDraftsFromBackend(){
  if(!currentVaultTeam||isAdmin)return;
  apiCall('getDrafts',{teamId:currentVaultTeam.id}).then(r=>{
    if(!r||!r.ok)return;
    // Restore submission state from backend
    if(r.submitted&&!isSubmitted){
      isSubmitted=true;
      try{localStorage.setItem(_gsKey('isSubmitted'),'1')}catch(e){}
      // Store submitted answers as draft so restoreIntelDraft can populate them
      if(r.answers&&typeof r.answers==='object'&&Object.keys(r.answers).length>0){
        const indexedAnswers={};
        intelFields.forEach((f,i)=>{if(r.answers[f.label])indexedAnswers[String(i)]=r.answers[f.label]});
        try{localStorage.setItem(_gsKey('intelDraft'),JSON.stringify(indexedAnswers))}catch(e){}
      }
      // Lock form if intel panel is already rendered
      const intelInputs=document.querySelectorAll('.intel-exp-input');
      if(intelInputs.length>0){
        intelFields.forEach((f,i)=>{const inp=intelInputs[i];if(inp&&r.answers&&r.answers[f.label])inp.value=r.answers[f.label]});
        intelInputs.forEach(inp=>inp.disabled=true);
        const btn=document.getElementById('intelSubmitBtn');
        if(btn){btn.disabled=true;btn.textContent='INTEL SUBMITTED'}
      }
      renderGrid(); // Update tile badge
      return;
    }
    // Not submitted — restore drafts
    if(!r.drafts)return;
    const drafts=typeof r.drafts==='string'?JSON.parse(r.drafts):r.drafts;
    if(!drafts||typeof drafts!=='object')return;
    try{localStorage.setItem(_gsKey('intelDraft'),JSON.stringify(drafts))}catch(e){}
    document.querySelectorAll('.intel-exp-input').forEach(inp=>{
      const idx=inp.dataset.idx;
      if(idx!==undefined&&drafts[idx]&&!inp.value.trim()){inp.value=drafts[idx]}
    });
  });
}
(function(){
  const form=document.getElementById('intelForm');
  if(form){
    form.addEventListener('focusin',function(e){
      if(e.target.classList.contains('intel-exp-input')){
        e.target._lastVal=e.target.value;
      }
    });
    form.addEventListener('input',function(e){
      if(e.target.classList.contains('intel-exp-input')){
        clearTimeout(_draftSaveTimer);
        _draftSaveTimer=setTimeout(()=>{
          saveGameState();
          saveDraftsToBackend();
        },1500);
      }
    });
    form.addEventListener('focusout',function(e){
      if(e.target.classList.contains('intel-exp-input')){
        const inp=e.target;
        const idx=inp.dataset.idx;
        const prev=(inp._lastVal??'');
        const now=inp.value||'';
        // Show "saved" instantly after the user finishes entering data (but not when clearing)
        if(now.trim() && now!==prev && !inp.dataset.suppressSaved){
          const blip=document.querySelector('.intel-saved-blip[data-save-idx="'+idx+'"]');
          if(blip){
            blip.classList.add('show');
            clearTimeout(blip._hideTimer);
            blip._hideTimer=setTimeout(()=>blip.classList.remove('show'),1200);
          }
        }
        // Save immediately on blur (and keep input debounce for continuous typing)
        clearTimeout(_draftSaveTimer);
        _draftSaveTimer=setTimeout(()=>{
          saveGameState();
          saveDraftsToBackend();
        },0);
        // Cleanup
        inp._lastVal=now;
        if(inp.dataset.suppressSaved)delete inp.dataset.suppressSaved;
      }
    });
  }
})();
function syncIntelLabels(){
  const labels=[];
  intelFields.forEach(f=>{
    if(f.type==='dual'){labels.push(f.label+' 1');labels.push(f.label+' 2')}
    else labels.push(f.label);
  });
  while(intelLabels.length)intelLabels.pop();
  labels.forEach(l=>intelLabels.push(l));
}
function clearIntelSlot(btn){
  const row=btn.closest('.intel-exp-row');
  if(!row)return;
  row.querySelectorAll('.intel-exp-input').forEach(inp=>{
    // Suppress the "SAVED" blip for clears
    inp.dataset.suppressSaved='1';
    inp.value='';
    inp.focus();
    // Allow suppression to expire shortly after clear
    clearTimeout(inp._suppressTimer);
    inp._suppressTimer=setTimeout(()=>{
      if(inp.dataset.suppressSaved) delete inp.dataset.suppressSaved;
    },500);
  });
}
function editIntelField(i){
  const f=intelFields[i];
  const a=f.answer||{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10};
  const isDual=f.type==='dual';
  const expInputs=isDual?
    `<div class="edit-font-row"><div class="edit-field"><label>Expected Answer 1</label><input id="ei_exp1" value="${(a.expected[0]||'')}" placeholder="Primary answer"></div><div class="edit-field"><label>Expected Answer 2</label><input id="ei_exp2" value="${(a.expected[1]||'')}" placeholder="Second value"></div></div>`:
    `<div class="edit-field"><label>Expected Answer</label><input id="ei_exp1" value="${(a.expected[0]||'')}" placeholder="The correct answer"></div>`;

  showEditModal(`<h3>Edit Intel Field #${i+1}</h3>
    <div class="edit-tabs" style="margin-bottom:14px"><button class="edit-tab active" onclick="switchTab(this,'field')">Field Settings</button><button class="edit-tab" onclick="switchTab(this,'answer')">🔑 Answer Key</button></div>
    <div class="edit-tab-content active" id="tab-field">
      <div class="edit-field-row">
        <div class="edit-field"><label>Label</label><input id="ei_label" value="${f.label}"></div>
        <div class="edit-field" style="flex:.3"><label>Emoji</label><input id="ei_emoji" value="${f.emoji}"></div>
      </div>
      <div class="edit-font-row"><div class="edit-field"><label>Input Type</label><select id="ei_type"><option${f.type==='text'?' selected':''} value="text">Text (general)</option><option${f.type==='number'?' selected':''} value="number">Number</option><option${f.type==='money'?' selected':''} value="money">Money ($)</option><option${f.type==='phone'?' selected':''} value="phone">Phone #</option><option${f.type==='date'?' selected':''} value="date">Date</option><option${f.type==='email'?' selected':''} value="email">Email</option><option${f.type==='plate'?' selected':''} value="plate">License Plate</option><option${f.type==='dual'?' selected':''} value="dual">Dual Field</option><option${f.type==='select'?' selected':''} value="select">Multiple Choice</option></select></div></div>
      ${isDual?`<div class="edit-field-row"><div class="edit-field"><label>Placeholder 1</label><input id="ei_ph1" value="${f.placeholder1||''}" placeholder="e.g. Island 1"></div><div class="edit-field"><label>Placeholder 2</label><input id="ei_ph2" value="${f.placeholder2||''}" placeholder="e.g. Island 2"></div></div>`:f.type==='select'?`<div class="edit-field"><label>Dropdown Options (comma-separated)</label><input id="ei_options" value="${(f.options||[]).join(', ')}" placeholder="e.g. Option A, Option B, Option C"></div>`:`<div class="edit-field"><label>Placeholder Text</label><input id="ei_ph" value="${f.placeholder||''}" placeholder="e.g. Enter answer here"></div>`}

    </div>
    <div class="edit-tab-content" id="tab-answer">
      ${expInputs}
      <div class="edit-field"><label>Accepted Alternatives (comma-separated)</label><input id="ei_alts" value="${(a.alts||[]).join(', ')}" placeholder="e.g. NY, New York City, NYC"></div>
      <div class="edit-field-row">
        <div class="edit-field"><label>Match Mode</label><select id="ei_match"><option value="exact"${a.matchMode==='exact'?' selected':''}>Exact Match</option><option value="contains"${a.matchMode==='contains'?' selected':''}>Contains</option><option value="fuzzy"${a.matchMode==='fuzzy'?' selected':''}>Fuzzy Match</option></select></div>
        <div class="edit-field"><label>Fuzzy Tolerance (%)</label><input type="number" id="ei_fuzzy" value="${a.fuzzyThreshold||85}" min="50" max="100" step="5"></div>
      </div>
      <div class="edit-field-row">
        <div class="edit-field"><label>Points</label><input type="number" id="ei_pts" value="${a.points||10}" min="1" max="100"></div>
        <div class="edit-field"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="ei_case" ${a.caseSensitive?'checked':''}> Case Sensitive</label></div>
      </div>
      <div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:4px;background:rgba(0,255,136,.02)">
        <div style="font-family:Saira,sans-serif;font-size:9px;letter-spacing:2px;color:var(--green);margin-bottom:8px;font-weight:600">TEST ANSWER</div>
        <div class="edit-font-row"><div class="edit-field"><input id="ei_test" placeholder="Type a test submission..."></div><button class="ap-btn ap-btn-green" onclick="testIntelAnswer(${i})" style="flex-shrink:0;margin-bottom:10px">Test</button></div>
        <div id="ei_testResult" style="font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;min-height:16px"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteIntelField(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveIntelField(${i})">Save</button></div>`);
}
function testIntelAnswer(i){
  const testVal=document.getElementById('ei_test').value;
  const cfg={
    expected:[document.getElementById('ei_exp1').value.trim()],
    alts:(document.getElementById('ei_alts').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    caseSensitive:document.getElementById('ei_case').checked,
    matchMode:document.getElementById('ei_match').value,
    fuzzyThreshold:parseInt(document.getElementById('ei_fuzzy').value)||85,
    points:parseInt(document.getElementById('ei_pts').value)||10
  };
  const exp2=document.getElementById('ei_exp2');
  if(exp2)cfg.expected.push(exp2.value.trim());

  const r=checkSingleAnswer(testVal,cfg);
  const el=document.getElementById('ei_testResult');
  if(r.correct){
    el.style.color='var(--green)';
    el.textContent='✓ ACCEPTED — '+r.match+(r.similarity?' ('+r.similarity+'% match)':'');
  }else if(r.match==='empty'){
    el.style.color='var(--amber)';el.textContent='— No input to test';
  }else if(r.match==='no-answer-key'){
    el.style.color='var(--amber)';el.textContent='— No expected answer configured';
  }else{
    el.style.color='var(--red)';
    el.textContent='✗ REJECTED — closest match: '+r.closestSimilarity+'%';
  }
}
function saveIntelField(i){
  intelFields[i].label=document.getElementById('ei_label').value.trim();
  intelFields[i].emoji=document.getElementById('ei_emoji').value.trim();
  intelFields[i].type=document.getElementById('ei_type').value;
  // font/inputFont managed centrally via Typography panel — not edited per-field
  // Save placeholders / options
  if(intelFields[i].type==='dual'){
    intelFields[i].placeholder1=document.getElementById('ei_ph1')?.value.trim()||'';
    intelFields[i].placeholder2=document.getElementById('ei_ph2')?.value.trim()||'';
  }else if(intelFields[i].type==='select'){
    intelFields[i].options=(document.getElementById('ei_options')?.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  }else{
    intelFields[i].placeholder=document.getElementById('ei_ph')?.value.trim()||'';
  }
  // Save answer config
  const exp1=document.getElementById('ei_exp1')?.value.trim()||'';
  const exp2=document.getElementById('ei_exp2')?.value.trim()||'';
  intelFields[i].answer={
    expected:exp2?[exp1,exp2]:[exp1],
    alts:(document.getElementById('ei_alts')?.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    caseSensitive:document.getElementById('ei_case')?.checked||false,
    matchMode:document.getElementById('ei_match')?.value||'exact',
    fuzzyThreshold:parseInt(document.getElementById('ei_fuzzy')?.value)||85,
    points:parseInt(document.getElementById('ei_pts')?.value)||10
  };
  hideEditModal();renderIntelForm();renderGrid();saveIntelFieldsToBackend();
}
// Two-step delete: first click shows confirm, second click executes
function confirmDelete(btn,fn){
  if(btn.dataset.armed){fn();return}
  btn.dataset.armed='1';btn.textContent='⚠ Confirm?';btn.style.background='rgba(255,50,50,.25)';
  setTimeout(()=>{if(btn){btn.dataset.armed='';btn.textContent='Delete';btn.style.background=''}},3000);
}
function deleteIntelField(i){intelFields.splice(i,1);hideEditModal();renderIntelForm();renderGrid();saveIntelFieldsToBackend()}
function addIntelField(){
  showEditModal(`<h3>Add Intel Field</h3>
    <div class="edit-field-row">
      <div class="edit-field"><label>Label</label><input id="ei_label" value=""></div>
      <div class="edit-field" style="flex:.3"><label>Emoji</label><input id="ei_emoji" value="📋"></div>
    </div>
    <div class="edit-field"><label>Input Type</label><select id="ei_type"><option value="text" selected>Text (general)</option><option value="number">Number</option><option value="money">Money ($)</option><option value="phone">Phone #</option><option value="date">Date</option><option value="email">Email</option><option value="plate">License Plate</option><option value="dual">Dual Field</option><option value="select">Multiple Choice</option></select></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewIntelField()">Add Field</button></div>`);
}
function saveNewIntelField(){
  intelFields.push({
    label:document.getElementById('ei_label').value.trim()||'New Field',
    emoji:document.getElementById('ei_emoji').value.trim()||'📋',
    type:document.getElementById('ei_type').value,
    font:'',
    inputFont:'',
    answer:{expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10}
  });
  hideEditModal();renderIntelForm();renderGrid();saveIntelFieldsToBackend();
}

// ── Feed Posts ──
let pendingFeedUpload='';
let pendingFeedUploadType='';
function handleFeedUpload(input){
  const file=input.files[0];if(!file)return;
  const zone=document.getElementById('feedUploadZone');
  const isVideo=file.type.startsWith('video/');
  
  showUploadProgress(zone,'UPLOADING '+(isVideo?'VIDEO':'IMAGE')+' TO DRIVE...');
  
  uploadFileToDrive(file,'feed').then(result=>{
    if(isVideo){
      pendingFeedUpload=result.directUrl;
      pendingFeedUploadType='video';
      zone.innerHTML=`<div style="text-align:center"><div style="font-size:24px;margin-bottom:4px">🎬</div><span style="font-size:9px;color:var(--green)">✓ ${file.name} uploaded to Drive</span></div>`;
      zone.classList.add('has-file');
      showFocalPointForUpload(null);
    }else{
      pendingFeedUpload=result.directUrl;
      pendingFeedUploadType='image';
      console.log('[FEED UPLOAD] R2 success, URL:',result.directUrl);
      zone.innerHTML=`<img src="${result.directUrl}" class="upload-preview"><br><span style="font-size:9px;color:var(--green)">✓ ${file.name} uploaded to Drive</span>`;
      zone.classList.add('has-file');
      showFocalPointForUpload(result.directUrl);
    }
    const vidField=document.getElementById('ef_video');
    if(vidField)vidField.value='';
  }).catch(err=>{
    console.error('[FEED UPLOAD] FAILED, falling back to local:',err);
    // Fallback to local
    if(isVideo){
      const blobUrl=URL.createObjectURL(file);
      pendingFeedUpload=blobUrl;
      pendingFeedUploadType='video';
      zone.innerHTML=`<video src="${blobUrl}" style="max-width:100%;max-height:120px;border-radius:4px" muted autoplay loop playsinline></video><br><span style="font-size:9px;color:var(--amber)">⚠ ${file.name} (local only - Drive failed)</span>`;
      zone.classList.add('has-file');
      showFocalPointForUpload(null);
    }else{
      const reader=new FileReader();
      reader.onload=e=>{
        pendingFeedUpload=e.target.result;
        pendingFeedUploadType='image';
        zone.innerHTML=`<img src="${pendingFeedUpload}" class="upload-preview"><br><span style="font-size:9px;color:var(--amber)">⚠ ${file.name} (local only - Drive failed)</span>`;
        zone.classList.add('has-file');
        showFocalPointForUpload(pendingFeedUpload);
      };
      reader.readAsDataURL(file);
    }
    const vidField=document.getElementById('ef_video');
    if(vidField)vidField.value='';
  });
}
function editFeedPost(i){
  const p=posts[i];pendingFeedUpload='';pendingFeedUploadType='';
  pendingFocalX=p.focalX||50;pendingFocalY=p.focalY||50;
  const hasMedia=!!p.mediaUrl;
  const isVid=hasMedia&&(p.mediaType==='video'||isVideoUrl(p.mediaUrl));
  const previewHtml=hasMedia?(isVid?`<video src="${p.mediaUrl}" style="max-width:100%;max-height:120px;border-radius:4px" muted autoplay loop playsinline></video><br><span style="font-size:9px;color:var(--green)">✓ Current video</span>`:`<img src="${p.mediaUrl}" class="upload-preview"><br><span style="font-size:9px;color:var(--green)">✓ Current image</span>`):'Click to upload image or video';
  showEditModal(`<h3>Edit Feed Post #${i+1}</h3>
    <div class="edit-field"><label>📷 Media</label>
      <div class="upload-zone ${hasMedia?'has-file':''}" id="feedUploadZone" onclick="document.getElementById('feedFileInput').click()">${hasMedia?previewHtml:'Click to upload image or video'}</div>
      <input type="file" id="feedFileInput" accept="image/*,video/*" style="display:none" onchange="handleFeedUpload(this)">
    </div>
    <div class="edit-field" id="focalPointField" style="${hasMedia&&!isVid?'':'display:none'}"><label>📌 Grid Crop Position <span style="font-size:8px;color:#555">Click to set focal point</span></label>
      <div class="focal-point-container" id="focalPointContainer" onmousedown="startFocalDrag(event)" ontouchstart="startFocalDrag(event)">
        <img src="${hasMedia&&!isVid?p.mediaUrl:''}" id="focalImg">
        <div class="focal-point-crosshair"></div>
        <div class="focal-point-marker" id="focalMarker" style="left:${p.focalX||50}%;top:${p.focalY||50}%"></div>
      </div>
      <div style="font-size:8px;color:#555;letter-spacing:.5px;margin-top:4px">Position: <span id="focalDisplay">${p.focalX||50}%, ${p.focalY||50}%</span></div>
    </div>
    <div class="edit-field"><label>Caption</label><textarea id="ef_cap">${p.cap}</textarea></div>
    <div style="display:flex;gap:10px;margin-top:6px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteFeedPost(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveFeedPost(${i})">Save</button></div>`);
}
// ── Focal Point Selector ──
let pendingFocalX=50,pendingFocalY=50,focalDragging=false;
function startFocalDrag(e){
  e.preventDefault();focalDragging=true;
  updateFocalFromEvent(e);
  const onMove=ev=>{if(focalDragging)updateFocalFromEvent(ev)};
  const onEnd=()=>{focalDragging=false;window.removeEventListener('mousemove',onMove);window.removeEventListener('mouseup',onEnd);window.removeEventListener('touchmove',onMove);window.removeEventListener('touchend',onEnd)};
  window.addEventListener('mousemove',onMove);window.addEventListener('mouseup',onEnd);
  window.addEventListener('touchmove',onMove,{passive:false});window.addEventListener('touchend',onEnd);
}
function updateFocalFromEvent(e){
  const c=document.getElementById('focalPointContainer');if(!c)return;
  const rect=c.getBoundingClientRect();
  const clientX=e.touches?e.touches[0].clientX:e.clientX;
  const clientY=e.touches?e.touches[0].clientY:e.clientY;
  const x=Math.max(0,Math.min(100,((clientX-rect.left)/rect.width)*100));
  const y=Math.max(0,Math.min(100,((clientY-rect.top)/rect.height)*100));
  pendingFocalX=Math.round(x);pendingFocalY=Math.round(y);
  const marker=document.getElementById('focalMarker');
  if(marker){marker.style.left=pendingFocalX+'%';marker.style.top=pendingFocalY+'%'}
  const display=document.getElementById('focalDisplay');
  if(display)display.textContent=pendingFocalX+'%, '+pendingFocalY+'%';
}
function showFocalPointForUpload(imgSrc){
  const field=document.getElementById('focalPointField');
  const img=document.getElementById('focalImg');
  if(field&&img&&imgSrc){field.style.display='';img.src=imgSrc;pendingFocalX=50;pendingFocalY=50;
    const marker=document.getElementById('focalMarker');if(marker){marker.style.left='50%';marker.style.top='50%'}
    const display=document.getElementById('focalDisplay');if(display)display.textContent='50%, 50%';
  } else if(field){field.style.display='none'}
}

function isVideoUrl(url){
  if(!url)return false;
  return /youtube|youtu\.be|vimeo|drive\.google|dailymotion|streamable|loom\.com/i.test(url)||/\.(mp4|webm|mov|ogg)(\?|$)/i.test(url);
}
function saveFeedPost(i){
  if(pendingFeedUpload){
    posts[i].mediaUrl=pendingFeedUpload;
    posts[i].mediaType=pendingFeedUploadType||'image';
  }
  posts[i].focalX=pendingFocalX;
  posts[i].focalY=pendingFocalY;
  posts[i].cap=document.getElementById('ef_cap').value.trim();
  pendingFeedUpload='';pendingFeedUploadType='';hideEditModal();renderFeed();renderGrid();
  if(document.getElementById('fvSingle')?.classList.contains('active'))renderSinglePost();
  saveFeedPostsToBackend();
}

// ── R2 Cleanup — delete file from R2 via backend proxy ──
function deleteFromR2(url){
  if(!url||!url.includes('.workers.dev/file/'))return;
  const key=url.split('/file/')[1];
  if(!key)return;
  apiCall('proxyDeleteFile',{fileKey:key}).catch(e=>{});
}

function deleteFeedPost(i){const delPost=posts[i];if(delPost&&delPost.imageUrl)deleteFromR2(delPost.imageUrl);posts.splice(i,1);if(currentPost>=posts.length)currentPost=Math.max(0,posts.length-1);hideEditModal();renderFeed();renderGrid();
  if(document.getElementById('fvSingle')?.classList.contains('active'))renderSinglePost();
  saveFeedPostsToBackend();
}
function addFeedPost(){pendingFeedUpload='';pendingFeedUploadType='';showEditModal(`<h3>Add Feed Post</h3>
    <div class="edit-field"><label>📷 Media</label>
      <div class="upload-zone" id="feedUploadZone" onclick="document.getElementById('feedFileInput').click()">Click to upload image or video</div>
      <input type="file" id="feedFileInput" accept="image/*,video/*" style="display:none" onchange="handleFeedUpload(this)">
    </div>
    <div class="edit-field"><label>Caption</label><textarea id="ef_cap"></textarea></div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewFeedPost()">Add Post</button></div>`)}
function saveNewFeedPost(){
  const p={emoji:'📷',bg:'#1a1a2a',cap:document.getElementById('ef_cap').value.trim(),capFont:'',mediaType:'image',mediaUrl:''};
  if(pendingFeedUpload){
    p.mediaUrl=pendingFeedUpload;
    p.mediaType=pendingFeedUploadType||'image';
  }
  console.log('[FEED] saveNewFeedPost mediaUrl:',p.mediaUrl?.substring(0,80));
  posts.push(p);pendingFeedUpload='';hideEditModal();renderFeed();renderGrid();
  if(document.getElementById('fvSingle')?.classList.contains('active'))renderSinglePost();
  saveFeedPostsToBackend();
}

// ── Media Items (enhanced with file upload + auto-detect) ──
// ── Media Icon Picker (dropdown + custom upload) ──
const mediaIconPresets=[
  {v:'📄',l:'Document'},{v:'🖼️',l:'Image'},{v:'🎵',l:'Audio'},{v:'🎬',l:'Video'},
  {v:'📋',l:'Dossier'},{v:'🔒',l:'Locked'},{v:'📁',l:'File'},{v:'📊',l:'Data'},
  {v:'🗺️',l:'Map'},{v:'📎',l:'Attachment'},{v:'📷',l:'Photo'},{v:'🎤',l:'Recording'},
  {v:'💾',l:'Disk'},{v:'🔑',l:'Key'},{v:'📡',l:'Signal'},{v:'⚠️',l:'Warning'}
];
function buildIconPicker(currentIcon){
  const isCustom=currentIcon&&(currentIcon.startsWith('http')||currentIcon.startsWith('data:'));
  const opts=mediaIconPresets.map(p=>`<option value="${p.v}"${!isCustom&&currentIcon===p.v?' selected':''}>${p.v} ${p.l}</option>`).join('');
  return `<div style="display:flex;gap:4px;align-items:center">
    <select id="em_ico_select" onchange="if(this.value!=='__custom__')document.getElementById('em_ico').value=this.value" style="flex:1;font-size:13px" onfocus="this.classList.add('ico-expanded')" onblur="this.classList.remove('ico-expanded')">
      ${opts}
      <option value="__custom__"${isCustom?' selected':''}>⊕ Custom...</option>
    </select>
    <input id="em_ico" type="hidden" value="${currentIcon||'📄'}">
    <label style="cursor:pointer;font-size:8px;color:var(--cyan);padding:6px 8px;border:1px solid rgba(0,212,255,.2);border-radius:3px;white-space:nowrap" title="Upload custom icon">
      📁<input type="file" accept="image/*" onchange="handleIconUpload(this)" style="display:none">
    </label>
  </div>`;
}
function handleIconUpload(input){
  const file=input.files[0];if(!file)return;
  uploadFileToDrive(file,'icon').then(r=>{
    document.getElementById('em_ico').value=r.directUrl;
    const sel=document.getElementById('em_ico_select');if(sel)sel.value='__custom__';
  }).catch(()=>{
    const reader=new FileReader();
    reader.onload=e=>{document.getElementById('em_ico').value=e.target.result;const sel=document.getElementById('em_ico_select');if(sel)sel.value='__custom__'};
    reader.readAsDataURL(file);
  });
}

function editMediaItem(i){
  pendingMediaFileUrl='';
  const m=mediaItems[i];
  const typeOpts=['document','image','audio','video','dossier'].map(t=>`<option${m.type===t?' selected':''}>${t}</option>`).join('');
  const hasFile=m.fileUrl&&!m.fileUrl.startsWith('data:')&&!m.fileUrl.startsWith('blob:');
  const fileInfo=hasFile?`<div style="font-size:9px;color:var(--green);margin-bottom:6px">✓ File uploaded · <span style="color:#666;cursor:pointer" onclick="if(confirm('Remove uploaded file?')){document.getElementById('em_url_cleared').value='1';this.parentElement.style.display='none'}">remove</span></div>`:'';
  showEditModal(`<h3>Edit Item #${i+1}</h3>
    ${fileInfo}
    <div class="edit-field"><label>Upload File${hasFile?' (replace existing)':''}</label><input type="file" id="em_file" onchange="handleMediaUpload(this)"></div>
    <input type="hidden" id="em_url_cleared" value="0">
    <div class="edit-field"><label>File Name</label><input id="em_name" value="${m.name}"></div>
    <div class="edit-field-row">
      <div class="edit-field" style="flex:.4"><label>Icon</label>${buildIconPicker(m.icon)}</div>
    </div>
    <div class="edit-field"><label>Description</label><textarea id="em_desc">${m.desc}</textarea></div>
    <div class="edit-field-row">
      <div class="edit-field"><label>Category</label><select id="em_type">${typeOpts}</select></div>
      <div class="edit-field"><label>File Password <span style="color:#666;font-weight:400">(to open/view)</span></label><input id="em_key" value="${m.unlockKey||''}" placeholder="Leave blank = no password"></div>
    </div>
    <div style="margin:10px 0;padding:12px 14px;border:1px solid ${m.vaultLocked?'rgba(255,170,51,.25)':'var(--border)'};border-radius:5px;background:${m.vaultLocked?'rgba(255,170,51,.04)':'rgba(255,255,255,.01)'}" id="em_vault_box">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="em_vaultlock" ${m.vaultLocked?'checked':''} onchange="toggleVaultLockUI()"><span style="font-family:'Saira',sans-serif;font-size:11px;color:${m.vaultLocked?'var(--amber)':'#888'};letter-spacing:1px;font-weight:600">🔐 Vault-Locked</span></label>
      <div id="em_vault_fields" style="margin-top:10px;${m.vaultLocked?'':'display:none'}">
        <div class="edit-field-row" style="margin-top:4px">
          <div class="edit-field"><label>Vault Code <span style="color:#666;font-weight:400">(players enter this on the Vault keypad)</span></label><input id="em_vaultcode" value="${m.vaultCode||''}" placeholder="e.g. SHADOW42" style="font-size:13px;letter-spacing:3px;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"></div>
          <div class="edit-field" style="flex:.6"><label>Codename <span style="color:#666;font-weight:400">(shown when locked)</span></label><input id="em_vaultcodename" value="${m.vaultCodename||''}" placeholder="e.g. FILE-001" style="letter-spacing:2px;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"></div>
        </div>
        <div style="font-family:'Chakra Petch',sans-serif;font-size:9px;color:#666;margin-top:4px">This item will be hidden from players until they crack the vault code. Once unlocked, it appears in the Evidence Locker.</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px"><button class="btn-standard btn-red" onclick="confirmDelete(this,()=>deleteMediaItem(${i}))">Delete</button><span style="flex:1"></span><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveMediaItem(${i})">Save</button></div>`);
}
function toggleVaultLockUI(){
  const cb=document.getElementById('em_vaultlock');
  const fields=document.getElementById('em_vault_fields');
  const box=document.getElementById('em_vault_box');
  const lbl=box.querySelector('span[style]');
  if(cb.checked){
    fields.style.display='';
    box.style.borderColor='rgba(255,170,51,.25)';
    box.style.background='rgba(255,170,51,.04)';
    if(lbl)lbl.style.color='var(--amber)';
  }else{
    fields.style.display='none';
    box.style.borderColor='var(--border)';
    box.style.background='rgba(255,255,255,.01)';
    if(lbl)lbl.style.color='#888';
  }
}
function saveMediaItem(i){mediaItems[i].icon=document.getElementById('em_ico').value.trim();mediaItems[i].name=document.getElementById('em_name').value.trim();mediaItems[i].desc=document.getElementById('em_desc').value.trim();mediaItems[i].type=document.getElementById('em_type').value;const cleared=document.getElementById('em_url_cleared')?.value==='1';if(pendingMediaFileUrl){mediaItems[i].fileUrl=pendingMediaFileUrl}else if(cleared){if(mediaItems[i].fileUrl)deleteFromR2(mediaItems[i].fileUrl);mediaItems[i].fileUrl=''}mediaItems[i].unlockKey=document.getElementById('em_key').value.trim();const vl=document.getElementById('em_vaultlock');if(vl){mediaItems[i].vaultLocked=vl.checked;if(vl.checked){mediaItems[i].vaultCode=(document.getElementById('em_vaultcode')?.value.trim().toUpperCase()||'');mediaItems[i].vaultCodename=(document.getElementById('em_vaultcodename')?.value.trim().toUpperCase()||'')}else{mediaItems[i].vaultCode='';mediaItems[i].vaultCodename=''}}pendingMediaFileUrl='';hideEditModal();syncVaultCodesFromMedia();renderMedia();renderGrid();renderKeysCodes();renderVaultPanel();saveMediaItemsToBackend()}
function deleteMediaItem(i){const delMedia=mediaItems[i];if(delMedia&&delMedia.fileUrl)deleteFromR2(delMedia.fileUrl);mediaItems.splice(i,1);hideEditModal();syncVaultCodesFromMedia();renderMedia();renderGrid();renderVaultPanel();renderKeysCodes();saveMediaItemsToBackend()}
function addMediaItem(){
  pendingMediaFileUrl='';
  showEditModal(`<h3>Add Item</h3>
    <div class="edit-field"><label>Upload File</label><input type="file" id="em_file" onchange="handleMediaUpload(this)"></div>
    <div class="edit-field"><label>File Name</label><input id="em_name" value=""></div>
    <div class="edit-field-row">
      <div class="edit-field" style="flex:.4"><label>Icon</label>${buildIconPicker('📄')}</div>
    </div>
    <div class="edit-field"><label>Description</label><textarea id="em_desc"></textarea></div>
    <div class="edit-field-row">
      <div class="edit-field"><label>Category</label><select id="em_type"><option>document</option><option>image</option><option>audio</option><option>video</option><option>dossier</option></select></div>
      <div class="edit-field"><label>File Password <span style="color:#666;font-weight:400">(to open/view)</span></label><input id="em_key" value="" placeholder="Leave blank = no password"></div>
    </div>
    <div style="margin:10px 0;padding:12px 14px;border:1px solid var(--border);border-radius:5px;background:rgba(255,255,255,.01)" id="em_vault_box">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="em_vaultlock" onchange="toggleVaultLockUI()"><span style="font-family:'Saira',sans-serif;font-size:11px;color:#888;letter-spacing:1px;font-weight:600">🔐 Vault-Locked</span></label>
      <div id="em_vault_fields" style="margin-top:10px;display:none">
        <div class="edit-field-row" style="margin-top:4px">
          <div class="edit-field"><label>Vault Code</label><input id="em_vaultcode" value="" placeholder="e.g. SHADOW42" style="font-size:13px;letter-spacing:3px;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"></div>
          <div class="edit-field" style="flex:.6"><label>Codename</label><input id="em_vaultcodename" value="" placeholder="e.g. FILE-001" style="letter-spacing:2px;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"></div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px;justify-content:flex-end"><button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button><button class="btn-standard btn-cyan" onclick="saveNewMediaItem()">Add Item</button></div>`);
}
function saveNewMediaItem(){const vl=document.getElementById('em_vaultlock');const isVL=vl&&vl.checked;mediaItems.push({icon:document.getElementById('em_ico').value.trim()||'📄',name:document.getElementById('em_name').value.trim(),desc:document.getElementById('em_desc').value.trim(),type:document.getElementById('em_type').value,fileUrl:pendingMediaFileUrl||'',unlockKey:document.getElementById('em_key').value.trim(),nameFont:'',descFont:'',vaultLocked:isVL,vaultCode:isVL?(document.getElementById('em_vaultcode')?.value.trim().toUpperCase()||''):'',vaultCodename:isVL?(document.getElementById('em_vaultcodename')?.value.trim().toUpperCase()||''):''});pendingMediaFileUrl='';hideEditModal();syncVaultCodesFromMedia();renderMedia();renderGrid();renderVaultPanel();renderKeysCodes();saveMediaItemsToBackend()}

// ══════ LANDING PAGE PREVIEW ══════
function previewLandingPage(){
  _previewReturnPanel='appearancePanel';
  closeAppearancePanel();
  // Use proper screen switching
  showScreen('landingScreen');
  // Show preview banner
  document.getElementById('landingPreviewOverlay').classList.add('active');
  // Set landing tab as active
  document.querySelectorAll('.lp-preview-nav').forEach((b,i)=>b.classList.toggle('active',i===0));
  // Add preview mode class to hide admin controls
  document.body.classList.add('landing-preview-mode');
  // Hide logout btn during preview
  const lb=document.getElementById('logoutBtn');if(lb)lb.classList.remove('visible');
}
function closeLandingPreview(){
  document.getElementById('landingPreviewOverlay').classList.remove('active');
  document.body.classList.remove('landing-preview-mode');
  showScreen('consoleScreen');
  document.getElementById('notepadTrigger').classList.add('visible');
  // Reset login screen
  resetLoginScreen();
  // Reset reg form
  const regForm=document.getElementById('regForm');if(regForm)regForm.style.display='';
  const regSuccess=document.getElementById('regSuccess');if(regSuccess)regSuccess.style.display='none';
  const regBtnRow=document.getElementById('regBtnRow');if(regBtnRow)regBtnRow.style.display='';
  const regBtn=document.getElementById('regSubmitBtn');
  if(regBtn){const s=regBtn.querySelector('span');if(s)s.textContent='REGISTER';regBtn.style.opacity='';regBtn.style.pointerEvents=''}
  // Return to the panel that launched preview
  if(_previewReturnPanel){setTimeout(()=>openAppearancePanel(),120);_previewReturnPanel=null}
}
function previewNav(screenId,btn){
  showScreen(screenId);
  document.querySelectorAll('.lp-preview-nav').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}

// ══════ DRAG-TO-REORDER ══════
let _drag={active:false,type:null,fromIdx:null,ghost:null,overIdx:null};

function startDrag(e,type,idx){
  e.preventDefault();e.stopPropagation();
  const target=e.target.closest(type==='feed'?'.feed-card':'.media-exp-item');
  if(!target)return;

  _drag={active:true,type,fromIdx:idx,ghost:null,overIdx:null};

  // Create ghost
  const rect=target.getBoundingClientRect();
  const ghost=target.cloneNode(true);
  ghost.className='drag-ghost';
  ghost.style.width=rect.width+'px';
  ghost.style.height=rect.height+'px';
  ghost.style.left=rect.left+'px';
  ghost.style.top=rect.top+'px';
  document.body.appendChild(ghost);
  _drag.ghost=ghost;

  // Mark source as dragging
  target.classList.add('dragging');

  const offsetX=e.clientX-rect.left;
  const offsetY=e.clientY-rect.top;

  function onMove(ev){
    const cx=ev.clientX||ev.touches?.[0]?.clientX||0;
    const cy=ev.clientY||ev.touches?.[0]?.clientY||0;
    ghost.style.left=(cx-offsetX)+'px';
    ghost.style.top=(cy-offsetY)+'px';

    // Find drop target
    ghost.style.display='none';
    const el=document.elementFromPoint(cx,cy);
    ghost.style.display='';

    const selector=type==='feed'?'.feed-card[data-idx]':'.media-exp-item[data-idx]';
    const items=document.querySelectorAll(selector);
    items.forEach(it=>it.classList.remove('drag-over'));

    if(el){
      const dropTarget=el.closest(selector);
      if(dropTarget){
        const dropIdx=parseInt(dropTarget.dataset.idx);
        if(!isNaN(dropIdx)&&dropIdx!==idx){
          dropTarget.classList.add('drag-over');
          _drag.overIdx=dropIdx;
        }
      }
    }
  }

  function onEnd(){
    window.removeEventListener('pointermove',onMove);
    window.removeEventListener('pointerup',onEnd);
    window.removeEventListener('pointercancel',onEnd);

    if(ghost)ghost.remove();

    // Clear all visual states
    const selector=_drag.type==='feed'?'.feed-card':'.media-exp-item';
    document.querySelectorAll(selector).forEach(el=>{
      el.classList.remove('dragging','drag-over');
    });

    // Perform reorder
    if(_drag.overIdx!==null&&_drag.overIdx!==_drag.fromIdx){
      const arr=_drag.type==='feed'?posts:mediaItems;
      const from=_drag.fromIdx;
      const to=_drag.overIdx;
      const item=arr.splice(from,1)[0];
      arr.splice(to,0,item);

      if(_drag.type==='feed'){
        renderFeed();renderGrid();saveFeedPostsToBackend();
      }else{
        syncVaultCodesFromMedia();renderMedia();renderGrid();renderVaultPanel();renderKeysCodes();saveMediaItemsToBackend();
      }
    }

    _drag={active:false,type:null,fromIdx:null,ghost:null,overIdx:null};
  }

  window.addEventListener('pointermove',onMove);
  window.addEventListener('pointerup',onEnd);
  window.addEventListener('pointercancel',onEnd);
}

// ══════ TIMER ══════
let timerSec=0,timerPaused=true,timerOriginal=0,timerStarted=false;
let timerMode='none'; // 'countdown' or 'event'
let _eventCfgHydrated=false;
let eventSettings={
  startTime:null, // ISO string
  endTime:null,   // ISO string
  autoLock:true,
  showLeaderboardOnExpiry:true,
  expired:false
};

function onTimerModeChange(){
  timerMode=document.getElementById('timerMode').value;
  // Stop schedule interval when leaving Event Schedule
  if(timerMode!=='event' && _globalTimerInterval){clearInterval(_globalTimerInterval);_globalTimerInterval=null;}
  document.getElementById('timerCountdownControls').style.display=timerMode==='countdown'?'':'none';
  document.getElementById('timerEventControls').style.display=timerMode==='event'?'':'none';
  if(timerMode==='event')updateEventStatus();
  if(timerMode==='countdown'){
    if(!window.__applyingCfg){ timerPaused=true; timerStarted=false; }
    const pb=document.getElementById('pauseBtn');
    if(pb){
      pb.textContent = (!timerStarted) ? '▶ START' : (timerPaused ? '▶ RESUME' : '⏸ PAUSE');
    }
    const ct=document.getElementById('cTimer');
    if(ct)ct.classList.toggle('paused', !timerStarted || timerPaused);
    renderTimerLabel('Manual Countdown');
    renderTimer();
    updateAdminTimerDisplay();
    if(!window.__applyingCfg) saveEventConfigToBackend();
  }
  if(timerMode==='event'){
    if(!window.__applyingCfg) eventSettings.expired=false;
    // Reflect current config in inputs
    try{
      const si=document.getElementById('eventStartInput');
      const ei=document.getElementById('eventEndInput');
      const toLocal=(iso)=>{ if(!iso) return ''; const d=new Date(iso); const pad=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); };
      if(si) si.value = toLocal(eventSettings.startTime);
      if(ei) ei.value = toLocal(eventSettings.endTime);
    }catch(e){}
    startGlobalEventTimer(true);
    updateAdminTimerDisplay();
    if(!window.__applyingCfg) saveEventConfigToBackend();
  }
  // No timer mode — show infinity symbol, stop any running timer updates
  if(timerMode==='none'){
    var timerBlock=document.querySelector('.timer-block');
    if(timerBlock)timerBlock.style.display='';
    if(_globalTimerInterval){clearInterval(_globalTimerInterval);_globalTimerInterval=null}
    timerPaused=true;
    var el=document.getElementById('cTimer');
    if(el){el.textContent='∞';el.classList.add('is-infinity');}
    renderTimerLabel('No Timer');
    var ap=document.getElementById('apTimerDisplay');
    if(ap)ap.textContent='∞';
    saveEventConfigToBackend();
  }else{
    var timerBlock2=document.querySelector('.timer-block');
    if(timerBlock2)timerBlock2.style.display='';
  }
}

function updateAdminTimerDisplay(){
  const ap=document.getElementById('apTimerDisplay');
  if(!ap)return;
  if(timerMode==='none'){
    ap.textContent='∞';
    return;
  }
  if(timerMode==='event'){
    const s=eventSettings.startTime?new Date(eventSettings.startTime):null;
    const e=eventSettings.endTime?new Date(eventSettings.endTime):null;
    const fmt=(d)=> d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '—';
    ap.textContent = (s||e) ? (fmt(s)+(e?('–'+fmt(e)):'') ) : '—';
    return;
  }
  // manual countdown
  const h=Math.floor(timerSec/3600),m=Math.floor((timerSec%3600)/60),s=timerSec%60;
  ap.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function onEventTimeChange(){
  const startVal=document.getElementById('eventStartInput').value;
  const endVal=document.getElementById('eventEndInput').value;
  eventSettings.startTime=startVal?new Date(startVal).toISOString():null;
  eventSettings.endTime=endVal?new Date(endVal).toISOString():null;
  eventSettings.expired=false;
  updateEventStatus();
  startGlobalEventTimer(true);
  updateAdminTimerDisplay();
  saveEventConfigToBackend();
}

let _globalTimerInterval=null;
function startGlobalEventTimer(runOnce=false){
  if(_globalTimerInterval)clearInterval(_globalTimerInterval);
  if(timerMode!=='event' && timerMode!=='none'){
    return;
  }
  // No timer mode — show infinity symbol and stop
  if(timerMode==='none'){
    var tb=document.querySelector('.timer-block');
    if(tb)tb.style.display='';
    var el=document.getElementById('cTimer');
    if(el){el.textContent='∞';el.classList.add('is-infinity');}
    renderTimerLabel('No Timer');
    return;
  }
  // Show timer block if it was hidden
  var tb2=document.querySelector('.timer-block');
  if(tb2)tb2.style.display='';
  if(!eventSettings.startTime||!eventSettings.endTime)return;
  
  const _tick=()=>{
    const timerEl=document.getElementById('cTimer');
    
    // Paused — show frozen time
    if(eventPaused&&_pausedTimeRemaining!==null){
      const diff=_pausedTimeRemaining;
      const h=Math.floor(diff/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      if(timerEl){
        timerEl.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
        timerEl.style.color='var(--amber)';
      }
      return;
    }
    
    const now=Date.now();
    const start=new Date(eventSettings.startTime).getTime();
    const end=new Date(eventSettings.endTime).getTime();
    
    if(now<start){
      const diff=start-now;
      const h=Math.floor(diff/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      if(timerEl)timerEl.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }else if(now>=start&&now<end){
      const diff=end-now;
      const h=Math.floor(diff/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      if(timerEl){
        timerEl.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
        timerEl.style.color=(diff<300000)?'var(--red)':'';
      }
    }else if(!eventSettings.expired){
      eventSettings.expired=true;
      if(timerEl){timerEl.textContent='00:00:00';timerEl.style.color='var(--red)'}
      onTimerExpired();
    }
    updateEventStatus();
  };
  if(typeof _globalTimerInterval!=='undefined' && _globalTimerInterval){
    clearInterval(_globalTimerInterval);
    _globalTimerInterval=null;
  }
  if(runOnce){ _tick(); return; }
  _tick();
  _globalTimerInterval=setInterval(_tick,1000);
}

// handleEventExpiry — now handled by onTimerExpired + showEventLockOverlay

function showPublicLeaderboard(){
  // Build and show a player-facing leaderboard
  const teams=getSortedTeams();
  const maxFields=intelFields.length||1;
  
  let html='<div style="width:90%;max-width:600px;max-height:80vh;overflow-y:auto">';
  html+='<div style="text-align:center;margin-bottom:24px"><div style="font-family:Russo One,sans-serif;font-size:22px;color:var(--green);letter-spacing:4px">FINAL STANDINGS</div><div style="font-family:Saira,sans-serif;font-size:10px;color:#666;letter-spacing:2px;margin-top:4px">'+teams.length+' teams competed</div></div>';
  
  teams.slice(0,20).forEach((t,i)=>{
    const rank=i+1;
    const medal=rank===1?'🥇':rank===2?'🥈':rank===3?'🥉':'';
    const score=t.submissionResults?t.submissionResults.totalScore:0;
    const possible=t.submissionResults?t.submissionResults.totalPossible:(maxFields*10);
    const pct=possible?Math.round((score/possible)*100):0;
    const barColor=rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#333';
    const submitted=t.submitTime?'Submitted':'Not submitted';
    
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.05);${rank<=3?'background:rgba(255,255,255,.02)':''}">
      <div style="font-family:Russo One,sans-serif;font-size:${rank<=3?'18':'14'}px;color:${rank===1?'#ffd700':rank===2?'#c0c0c0':rank===3?'#cd7f32':'#555'};min-width:36px;text-align:center">${medal||'#'+rank}</div>
      <div style="flex:1">
        <div style="font-family:Saira,sans-serif;font-size:13px;color:#ddd;font-weight:600">${t.name}</div>
        <div style="height:3px;background:#111;border-radius:2px;margin-top:4px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${barColor};border-radius:2px"></div></div>
      </div>
      <div style="text-align:right">
        <div style="font-family:Oxanium,sans-serif;font-size:16px;font-weight:700;color:${rank<=3?'#fff':'#aaa'}">${pct}%</div>
        <div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:#555">${submitted}</div>
      </div>
    </div>`;
  });
  
  html+='<div style="text-align:center;margin-top:20px"><button onclick="closePublicLeaderboard()" style="padding:10px 24px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:#888;font-family:Saira,sans-serif;font-size:10px;letter-spacing:2px;cursor:pointer;border-radius:4px;text-transform:uppercase">Close</button></div>';
  html+='</div>';
  
  const overlay=document.createElement('div');
  overlay.id='publicLeaderboard';
  overlay.style.cssText='position:fixed;inset:0;z-index:950;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center';
  overlay.innerHTML=html;
  document.body.appendChild(overlay);
}
function closePublicLeaderboard(){
  const el=document.getElementById('publicLeaderboard');
  if(el)el.remove();
}

// ═══════════════════════════════════════════════════════════════
// ADMIN EVENT ACTIONS
// ═══════════════════════════════════════════════════════════════

let eventPaused=false;
let _pausedTimeRemaining=null;

function toggleEventPause(){
  if(!eventSettings.startTime||!eventSettings.endTime)return;
  const btn=document.getElementById('eventPauseBtn');
  if(!eventPaused){
    // Pause — save remaining time, stop countdown
    const now=Date.now();
    const end=new Date(eventSettings.endTime).getTime();
    _pausedTimeRemaining=Math.max(0,end-now);
    eventPaused=true;
    if(btn)btn.innerHTML='▶ Resume Timer';
    // Broadcast pause to players
    apiCall('sendBroadcast',{message:'⏸ Event timer has been paused by the administrator.',type:'text'});
  }else{
    // Resume — set new end time based on remaining time
    const newEnd=new Date(Date.now()+_pausedTimeRemaining);
    eventSettings.endTime=newEnd.toISOString();
    const inp=document.getElementById('eventEndInput');
    if(inp)inp.value=eventSettings.endTime.substring(0,16);
    eventSettings.expired=false;
    eventPaused=false;
    _pausedTimeRemaining=null;
    if(btn)btn.innerHTML='⏸ Pause Timer';
    startGlobalEventTimer();
    saveEventConfigToBackend();
    apiCall('sendBroadcast',{message:'▶ Event timer has been resumed.',type:'text'});
  }
}

function forceEndEvent(){
  if(!confirm('Force end the event NOW? This will lock all players and reveal the leaderboard immediately.'))return;
  // Set end time to now
  eventSettings.endTime=new Date().toISOString();
  eventSettings.expired=false;
  const inp=document.getElementById('eventEndInput');
  if(inp)inp.value=eventSettings.endTime.substring(0,16);
  eventPaused=false;
  _pausedTimeRemaining=null;
  startGlobalEventTimer();
  saveEventConfigToBackend();
  apiCall('sendBroadcast',{message:'⛔ The event has been ended by the administrator.',type:'text'});
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function exportResults(){
  const teams=getSortedTeams();
  const maxFields=intelFields.length||1;
  const totalPossible=intelFields.reduce((s,f)=>(s+(f.answer?.points||10)),0);
  const eventName=operationName||'Code Breakers';
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});

  let rows='';
  teams.forEach((t,i)=>{
    const rank=i+1;
    const sr=t.submissionResults;
    const score=sr?sr.totalScore:0;
    const correct=sr?sr.correctCount:0;
    const pct=totalPossible?Math.round((score/totalPossible)*100):0;
    const members=(t.members||[]).join(', ');
    const submitted=t.submitTime?new Date(t.submitTime).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}):'—';
    const medal=rank===1?'🥇':rank===2?'🥈':rank===3?'🥉':'';
    const rowBg=rank<=3?'background:#f8f9fa':'';
    const rankColor=rank===1?'#d4a017':rank===2?'#757575':rank===3?'#a0522d':'#333';
    rows+=`<tr style="${rowBg}">
      <td style="padding:10px 12px;text-align:center;font-weight:700;color:${rankColor};font-size:${rank<=3?'16':'13'}px">${medal||'#'+rank}</td>
      <td style="padding:10px 12px"><div style="font-weight:600;font-size:13px;color:#1a1a1a">${esc(t.name)}</div><div style="font-size:10px;color:#888;margin-top:2px">${esc(members)}</div></td>
      <td style="padding:10px 12px;text-align:center;font-weight:700;font-size:15px;color:#1a1a1a">${score}<span style="font-size:10px;color:#999;font-weight:400">/${totalPossible}</span></td>
      <td style="padding:10px 12px;text-align:center"><div style="background:#eee;border-radius:10px;height:8px;overflow:visible;min-width:80px"><div style="height:100%;width:${pct}%;background:${rank===1?'#d4a017':rank===2?'#757575':rank===3?'#a0522d':'#4CAF50'};border-radius:10px"></div></div><div style="font-size:10px;color:#888;margin-top:3px">${pct}%</div></td>
      <td style="padding:10px 12px;text-align:center;color:#666;font-size:11px">${correct}/${maxFields}</td>
      <td style="padding:10px 12px;text-align:center;color:#666;font-size:11px">${submitted}</td>
    </tr>`;
  });

  let fieldRows='';
  intelFields.forEach((f,i)=>{
    const pts=f.answer?.points||10;
    const hasKey=f.answer?.expected?.filter(e=>e.trim()).length>0;
    fieldRows+=`<tr>
      <td style="padding:6px 12px;font-size:11px;color:#555">${i+1}</td>
      <td style="padding:6px 12px;font-size:11px">${esc(f.label)}</td>
      <td style="padding:6px 12px;text-align:center;font-size:11px">${f.type}</td>
      <td style="padding:6px 12px;text-align:center;font-weight:600">${pts}</td>
      <td style="padding:6px 12px;text-align:center;font-size:11px">${f.answer?.matchMode||'exact'}</td>
      <td style="padding:6px 12px;text-align:center">${hasKey?'<span style="color:#4CAF50">✓</span>':'<span style="color:#999">—</span>'}</td>
    </tr>`;
  });

  const report=`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>${esc(eventName)} — Results Report</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#333;background:#fff;padding:40px}
@media print{body{padding:20px}.toolbar{display:none!important}.page-break{page-break-before:always}}
.header{text-align:center;margin-bottom:40px;padding-bottom:20px;border-bottom:3px solid #1a1a1a}
.header h1{font-size:28px;font-weight:800;letter-spacing:1px;margin-bottom:4px}
.header .sub{font-size:12px;color:#888;letter-spacing:2px;text-transform:uppercase}
.header .meta{font-size:11px;color:#aaa;margin-top:8px}
.section{margin-bottom:32px}
.section h2{font-size:16px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#1a1a1a;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #eee}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:#1a1a1a;color:#fff;padding:10px 12px;text-align:left;font-size:10px;letter-spacing:1px;text-transform:uppercase}

tbody td{padding:10px 12px;vertical-align:middle}

tbody tr{border-bottom:1px solid #eee}
tbody tr:hover{background:#f5f5f5}
.stats{display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap}
.stat{flex:1;min-width:120px;padding:16px;background:#f8f9fa;border-radius:8px;text-align:center}
.stat .val{font-size:28px;font-weight:800;color:#1a1a1a}
.stat .lbl{font-size:10px;color:#888;letter-spacing:1px;text-transform:uppercase;margin-top:4px}
.footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;font-size:10px;color:#ccc}
.toolbar{position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:100}
.toolbar button{padding:8px 16px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;font-size:11px}
.toolbar button:hover{background:#f5f5f5}
</style></head><body class=\"config-hydrating\">
<div class="toolbar">
  <button onclick="window.print()">🖨 Print / Save as PDF</button>
</div>
<div class="header">
  <h1>${esc(eventName)}</h1>
  <div class="sub">Final Results Report</div>
  <div class="meta">Generated ${dateStr} at ${timeStr}</div>
</div>
<div class="stats">
  <div class="stat"><div class="val">${teams.length}</div><div class="lbl">Teams</div></div>
  <div class="stat"><div class="val">${teams.filter(t=>t.submitTime).length}</div><div class="lbl">Submitted</div></div>
  <div class="stat"><div class="val">${maxFields}</div><div class="lbl">Intel Fields</div></div>
  <div class="stat"><div class="val">${totalPossible}</div><div class="lbl">Max Score</div></div>
  <div class="stat"><div class="val">${teams.length>0&&teams[0].submissionResults?teams[0].submissionResults.totalScore:0}</div><div class="lbl">Top Score</div></div>
</div>
<div class="section">
  <h2>🏆 Final Standings</h2>
  <table><thead><tr><th style="width:60px;text-align:center">Rank</th><th>Team</th><th style="text-align:center;width:100px">Score</th><th style="text-align:center;width:120px">Progress</th><th style="text-align:center;width:80px">Correct</th><th style="text-align:center;width:100px">Submitted</th></tr></thead>
  <tbody>${rows}</tbody></table>
</div>
<div class="section page-break">
  <h2>📋 Scoring Configuration</h2>
  <table><thead><tr><th style="width:40px">#</th><th>Field</th><th style="text-align:center;width:80px">Type</th><th style="text-align:center;width:60px">Points</th><th style="text-align:center;width:80px">Match</th><th style="text-align:center;width:60px">Key Set</th></tr></thead>
  <tbody>${fieldRows}</tbody></table>
</div>
<div class="footer">
  <p>${esc(eventName)} — Code Breakers Platform</p>
  <p style="margin-top:4px">Confidential — For internal use only</p>
</div>
</body></html>`;

  const blob=new Blob([report],{type:'text/html;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  window.open(url,'_blank');
  setTimeout(()=>URL.revokeObjectURL(url),10000);
}

// ══════ SCORING EDITOR ══════
let scoringConfig={timeBonus:false,timeBonusMax:50,timeBonusDecay:'linear'};

function renderScoringEditor(){
  const list=document.getElementById('seFieldList');
  if(!list)return;
  let html='',totalPts=0;
  intelFields.forEach((f,i)=>{
    const pts=f.answer?.points||10;
    totalPts+=pts;
    const mode=f.answer?.matchMode||'exact';
    const fuzzy=f.answer?.fuzzyThreshold||85;
    html+=`<div style="display:grid;grid-template-columns:2fr 80px 100px 80px;gap:0;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.04);align-items:center">
      <div style="font-family:Chakra Petch,sans-serif;font-size:11px;color:#ddd">${f.emoji||''} ${esc(f.label)}<span style="font-size:9px;color:#555;margin-left:6px">(${f.type})</span></div>
      <div style="text-align:center"><input type="number" value="${pts}" min="1" max="1000" onchange="seUpdateField(${i},'points',parseInt(this.value))" style="width:54px;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 6px;color:var(--green);font-family:Oxanium,sans-serif;font-size:11px;text-align:center;outline:none"></div>
      <div style="text-align:center"><select onchange="seUpdateField(${i},'matchMode',this.value)" style="background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 6px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:9px;outline:none">
        <option value="exact"${mode==='exact'?' selected':''}>Exact</option>
        <option value="contains"${mode==='contains'?' selected':''}>Contains</option>
        <option value="fuzzy"${mode==='fuzzy'?' selected':''}>Fuzzy</option>
      </select></div>
      <div style="text-align:center"><input type="number" value="${fuzzy}" min="50" max="100" onchange="seUpdateField(${i},'fuzzyThreshold',parseInt(this.value))" style="width:48px;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:4px 6px;color:#aaa;font-family:IBM Plex Mono,monospace;font-size:9px;text-align:center;outline:none" ${mode!=='fuzzy'?'disabled':''}></div>
    </div>`;
  });
  list.innerHTML=html||'<div style="padding:16px;text-align:center;font-size:10px;color:#555">No intel fields configured yet.</div>';
  const total=document.getElementById('seTotalPossible');
  if(total)total.textContent=totalPts;
}

function seUpdateField(idx,prop,val){
  if(!intelFields[idx])return;
  if(!intelFields[idx].answer)intelFields[idx].answer={expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10};
  intelFields[idx].answer[prop]=val;
  renderScoringEditor();
  saveIntelFieldsToBackend();
  showSaveBlip('blipScoring');
}

function seApplyDefaultPoints(){
  const pts=parseInt(document.getElementById('seDefaultPoints')?.value||10);
  const mode=document.getElementById('seDefaultMode')?.value||'exact';
  intelFields.forEach(f=>{
    if(!f.answer)f.answer={expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10};
    f.answer.points=pts;
    f.answer.matchMode=mode;
  });
  renderScoringEditor();
  saveIntelFieldsToBackend();
  showSaveBlip('blipScoring');
}

function seApplyDefaultMode(){
  const mode=document.getElementById('seDefaultMode')?.value||'exact';
  intelFields.forEach(f=>{
    if(!f.answer)f.answer={expected:[''],alts:[],caseSensitive:false,matchMode:'exact',fuzzyThreshold:85,points:10};
    f.answer.matchMode=mode;
  });
  renderScoringEditor();
  saveIntelFieldsToBackend();
  showSaveBlip('blipScoring');
}

function updateScoringConfig(){
  scoringConfig.timeBonus=document.getElementById('seTimeBonus')?.checked||false;
  scoringConfig.timeBonusMax=parseInt(document.getElementById('seTimeBonusMax')?.value||50);
  scoringConfig.timeBonusDecay=document.getElementById('seTimeBonusDecay')?.value||'linear';
  const cfg=document.getElementById('seTimeBonusConfig');
  if(cfg)cfg.style.display=scoringConfig.timeBonus?'flex':'none';
  saveEventConfigToBackend();
}

function clearAllData(){
  if(!confirm('⚠ NUCLEAR RESET\n\nThis will permanently delete:\n• All registered teams\n• All submissions & scores\n• All broadcast messages\n\nFeed posts, media items, intel fields, and vault codes will NOT be affected.\n\nThis cannot be undone. Continue?'))return;
  if(!confirm('Are you absolutely sure? Type thinking...'))return;
  
  apiCall('clearAllData',{scope:'all'}).then(r=>{
    if(r.ok){
      // Clear local state
      registeredTeams.length=0;
      manualTeams.length=0;
      eventSettings.expired=false;
      renderLeaderboard();
      renderFullLeaderboard();
      renderTeamMonitor();
      showPlayerBanner('text','All event data has been cleared.');
    }
  });
}

function updateEventStatus(){
  const msg=document.getElementById('eventStatusMsg');
  if(!msg)return;
  if(!eventSettings.startTime||!eventSettings.endTime){
    msg.textContent='Set both start and end times to activate event timer';msg.style.color='#666';return;
  }
  if(eventPaused){msg.textContent='⏸ Event is PAUSED';msg.style.color='var(--amber)';return}
  const now=Date.now();
  const start=new Date(eventSettings.startTime).getTime();
  const end=new Date(eventSettings.endTime).getTime();
  if(now<start){msg.textContent='⏳ Event has not started yet';msg.style.color='var(--amber)'}
  else if(now>=start&&now<end){msg.textContent='🟢 Event is LIVE';msg.style.color='var(--green)'}
  else{msg.textContent='🔴 Event has ended';msg.style.color='var(--red)'}
}

// Countdown mode functions
function togglePause(){
  // Manual countdown start/pause/resume
  const pb=document.getElementById('pauseBtn');
  const timerEl=document.getElementById('cTimer');
  if(timerMode!=='countdown')return;
  if(!timerStarted){
    if(timerSec<=0)return;
    timerStarted=true;
    timerPaused=false;
    if(pb)pb.textContent='⏸ PAUSE';
    timerEl?.classList.remove('paused');
  }else{
    timerPaused=!timerPaused;
    if(pb)pb.textContent=timerPaused?'▶ RESUME':'⏸ PAUSE';
    timerEl?.classList.toggle('paused',timerPaused);
  }
  updateAdminTimerDisplay();
  saveEventConfigToBackend();
}
function setNewTime(){const v=document.getElementById('timerInput').value.trim();const parts=v.split(':');if(parts.length===3){timerSec=parseInt(parts[0])*3600+parseInt(parts[1])*60+parseInt(parts[2]);timerOriginal=timerSec;renderTimer()
  timerPaused=true; timerStarted=false;
  const pb=document.getElementById('pauseBtn'); if(pb)pb.textContent='▶ START';
  document.getElementById('cTimer')?.classList.add('paused');
  updateAdminTimerDisplay();
  saveEventConfigToBackend();
}else if(parts.length===2){timerSec=parseInt(parts[0])*60+parseInt(parts[1]);timerOriginal=timerSec;renderTimer()}}
function resetTimer(){
  timerSec=timerOriginal;
  timerPaused=true;
  timerStarted=false;
  const pb=document.getElementById('pauseBtn');
  if(pb)pb.textContent='▶ START';
  const ct=document.getElementById('cTimer');
  ct?.classList.add('paused');
  renderTimer();
  updateAdminTimerDisplay();
  saveEventConfigToBackend();
}
function renderTimer(){
  const el=document.getElementById('cTimer');
  if(!el)return;
  if(!_eventCfgHydrated)return;
  if(timerMode==='event'){
    // schedule mode renders via startGlobalEventTimer
    return;
  }
  if(timerMode==='none'){
    el.textContent='∞';
    el.classList.add('is-infinity');
    return;
  }
  el.classList.remove('is-infinity');
  const h=Math.floor(timerSec/3600),m=Math.floor((timerSec%3600)/60),s=timerSec%60;
  el.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function renderTimerLabel(label){
  const labelEl=document.querySelector('.timer-label');
  if(labelEl)labelEl.textContent=label;
}

function tickTimer(){
  if(!_eventCfgHydrated)return;
  if(timerMode==='none')return; // Open-ended, no timer
  if(timerMode==='countdown'){
    if(timerPaused||timerSec<=0)return;
    timerSec--;renderTimer();
    if(timerSec<=0)onTimerExpired();
  }
}
function onTimerExpired(){
  eventSettings.expired=true;
  updateEventStatus();
  if(eventSettings.autoLock&&!isAdmin){
    showEventLockOverlay();
  }
  if(eventSettings.showLeaderboardOnExpiry&&!isAdmin){
    // Auto-show leaderboard after short delay
    setTimeout(()=>openLeaderboard(),2000);
  }
}
function showEventLockOverlay(){
  let overlay=document.getElementById('eventLockOverlay');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='eventLockOverlay';
    overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;animation:fadeIn .5s ease';
    overlay.innerHTML=`
      <div style="font-family:Staatliches,cursive;font-size:32px;color:var(--red);letter-spacing:6px;text-transform:uppercase">⏱ Time's Up</div>
      <div style="font-family:Chakra Petch,sans-serif;font-size:14px;color:#888;letter-spacing:1px">The event has ended. All submissions are now locked.</div>
      <div style="font-family:IBM Plex Mono,monospace;font-size:11px;color:#555;letter-spacing:2px;margin-top:8px">Final results are being compiled...</div>
      <button onclick="removeEventLockShowResults()" style="margin-top:20px;padding:10px 24px;background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);color:var(--green);font-family:Saira,sans-serif;font-size:11px;letter-spacing:3px;cursor:pointer;border-radius:4px;text-transform:uppercase;font-weight:700">View Results</button>
    `;
    document.body.appendChild(overlay);
    // Lock all interactive elements for players
    document.querySelectorAll('.intel-exp-input,.v-key,.login-hw-btn,.intel-submit-btn').forEach(el=>{el.disabled=true;el.style.pointerEvents='none';el.style.opacity='.4'});
    document.body.classList.add('event-locked');
  }
}
function removeEventLockShowResults(){
  const ov=document.getElementById('eventLockOverlay');
  if(ov)ov.remove();
  showPublicLeaderboard();
}
function getEventState(){
  if(!eventSettings.startTime||!eventSettings.endTime)return'setup';
  const now=Date.now();
  const start=new Date(eventSettings.startTime).getTime();
  const end=new Date(eventSettings.endTime).getTime();
  if(eventPaused)return'paused';
  if(now<start)return'pre-event';
  if(now>=start&&now<end)return'live';
  return'ended';
}


// ══════ SESSION MANAGEMENT ══════
function openSessionMgmt(){switchAdminTab('sessionMgmtPanel')}
function closeSessionMgmt(){const el=document.getElementById('sessionMgmtPanel');el.classList.remove('active');el.style.cssText='';hideAdminTabs()}
function destroySessions(mode){
  const labels={all:'DESTROY ALL SESSIONS (including yours)',teams:'DESTROY ALL TEAM SESSIONS',exceptMe:'DESTROY ALL SESSIONS EXCEPT YOURS'};
  if(!confirm(labels[mode]+'?\n\nAffected users will be kicked to the login screen immediately.')){return}
  const msg=document.getElementById('sessionMgmtMsg');
  msg.className='ap-msg';msg.textContent='Destroying sessions...';
  apiCall('destroySessions',{mode}).then(r=>{
    console.log('destroySessions response:',JSON.stringify(r));
    if(r.ok){
      msg.className='ap-msg ok';msg.textContent='✓ '+r.message;
      if(mode==='exceptMe'&&r.newToken){
        adminSession.adminToken=r.newToken;
        saveSession();
        msg.textContent+=' — Your token has been refreshed.';
      }else if(mode==='all'){
        msg.textContent+=' — Reloading in 2s...';
        setTimeout(()=>{localStorage.removeItem('cb_session');sessionStorage.removeItem('cb_session');location.reload()},2000);
      }
    }else{
      msg.className='ap-msg err';msg.textContent='✗ '+(r.error||'Failed');
    }
  });
}

function nukeAllTeams(){
  if(!confirm('☢ NUKE ALL TEAMS?\n\nThis permanently deletes ALL teams, their submissions, drafts, vault progress, and leaderboard entries.\n\nThis CANNOT be undone.'))return;
  if(!confirm('Are you absolutely sure? Type YES in the next prompt to confirm.'))return;
  var answer=prompt('Type YES to confirm total team wipe:');
  if(answer!=='YES'){alert('Cancelled.');return}
  var msg=document.getElementById('nukeMgmtMsg');
  msg.className='ap-msg';msg.textContent='Nuking all teams...';
  Promise.all([
    apiCall('clearAllData',{scope:'teams'}),
    apiCall('clearAllData',{scope:'submissions'})
  ]).then(function(results){
    var r=results[0]||{ok:false};

    if(r.ok){
      msg.className='ap-msg ok';msg.textContent='☢ '+r.message;
      registeredTeams.length=0;manualTeams.length=0;
      renderTeamMonitor();renderLeaderboard();renderFullLeaderboard();
    }else{
      msg.className='ap-msg err';msg.textContent='✗ '+(r.error||'Failed');
    }
  });
}

function nukeSelectedTeams(){
  var checks=document.querySelectorAll('.tm-nuke-check:checked');
  if(!checks.length){alert('No teams selected.');return}
  var ids=[];checks.forEach(function(cb){ids.push(cb.dataset.team)});
  if(!confirm('☢ NUKE '+ids.length+' TEAM'+(ids.length>1?'S':'')+'?\n\nIDs: '+ids.join(', ')+'\n\nThis permanently deletes their data. Cannot be undone.'))return;
  var msg=document.getElementById('tmNukeBar');
  (async function(){
    // Remove team submissions (if any) and team records
    var draftResp = await apiCall('getDrafts',{});
    var draftsObj = (draftResp&&draftResp.ok&&draftResp.drafts)?draftResp.drafts:null;
    for(var i=0;i<ids.length;i++){
      var tid=ids[i];
      try{await apiCall('desubmitTeam',{teamId:tid})}catch(e){}
      try{await apiCall('removeTeam',{teamId:tid})}catch(e){}
      if(draftsObj && draftsObj[tid]){delete draftsObj[tid]}
    }
    if(draftsObj){
      try{await apiCall('saveDrafts',{drafts:draftsObj})}catch(e){}
    }
    return {ok:true,message:'Selected teams removed'};
  })().then(function(r){
    if(r.ok){
      ids.forEach(function(id){
        var idx=registeredTeams.findIndex(function(t){return t.id===id});
        if(idx>=0)registeredTeams.splice(idx,1);
        var mi=manualTeams.findIndex(function(t){return t.id===id});
        if(mi>=0)manualTeams.splice(mi,1);
      });
      renderTeamMonitor();renderLeaderboard();renderFullLeaderboard();
      alert('☢ '+r.message);
    }else{
      alert('Failed: '+(r.error||'Unknown error'));
    }
  });
}

// ══════ TUTORIAL SYSTEM ══════
const TUTORIAL_STEPS_DEFAULT=[
  {id:'grid',selector:'.console-grid',icon:'🖥️',title:'Mission Console',body:'These are your mission panels. Each one contains different intelligence and tools. Tap any panel to open it.',enabled:true},
  {id:'feed',selector:'.crt-monitor[data-tile="feed"]',icon:'📡',title:'Intelligence Feed',body:'Surveillance imagery and intercepted visuals from the field. Check here for visual clues.',enabled:true},
  {id:'media',selector:'.crt-monitor[data-tile="media"]',icon:'📁',title:'Evidence Locker',body:'Classified files and documents. Some may be vault-locked and require a code to access.',enabled:true},
  {id:'intel',selector:'.crt-monitor[data-tile="intel"]',icon:'🔍',title:'Intel Submissions',body:'Enter your answers here. Fill in each field with the intelligence you\'ve gathered, Your progress saves automatically — press Submit Intel only when you\'re ready to lock in your final answers.',enabled:true},
  {id:'vault',selector:'.crt-monitor[data-tile="vault"]',icon:'🔐',title:'Vault',body:'Enter secret codes to unlock classified evidence. Codes can be found hidden throughout the mission.',enabled:true},
  {id:'timer',selector:'.timer-block',icon:'⏱️',title:'Mission Timer',body:'Keep an eye on the clock. When time runs out, the mission is over.',enabled:true},
  {id:'identity',selector:'.topbar-identity',icon:'🪪',title:'Your Identity',body:'Your team name and details. Tap to see your team card with member info and notifications.',enabled:true},
  {id:'notepad',selector:'#notepadTrigger',icon:'📝',title:'Notepad',body:'Your personal scratchpad. Jot down clues, codes, or anything you need to remember.',enabled:true}
];
let tutorialSteps=JSON.parse(JSON.stringify(TUTORIAL_STEPS_DEFAULT));
let tutorialEnabled=true;
let _tutCurrentStep=0;
function _isTutorialRunning(){return document.getElementById('tutorialOverlay')?.classList.contains('active')}
let _tutIsPreview=false;

function openTutorialConfig(){
  switchAdminTab('tutorialConfigPanel');
  renderTutorialStepList();
  const tg=document.getElementById('tutGlobalToggle');
  tg.classList.toggle('on',tutorialEnabled);
  const bg=document.getElementById('briefingGlobalToggle');
  bg.classList.toggle('on',!!briefingConfig.enabled);
  const st=document.getElementById('briefingSourceType');
  st.value=briefingConfig.sourceType||'upload';
  onBriefingTypeChange();
  document.getElementById('briefingTitle').value=briefingConfig.title||'';
  document.getElementById('briefingSubtitle').value=briefingConfig.subtitle||'';
  if(briefingConfig.sourceType==='upload'){document.getElementById('briefingFileUrl').value=briefingConfig.videoUrl||''}
  else{document.getElementById('briefingVideoUrl').value=briefingConfig.videoUrl||''}
}
function closeTutorialConfig(){const el=document.getElementById('tutorialConfigPanel');el.classList.remove('active');el.style.cssText='';hideAdminTabs()}

function renderTutorialStepList(){
  const list=document.getElementById('tutStepList');
  list.innerHTML=tutorialSteps.map((s,i)=>{
    const escaped=s.body.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return `<div class="tut-step-card" data-tut-idx="${i}">
    <div class="tut-drag" onpointerdown="startTutDrag(event,${i})">⋮⋮</div>
    <span class="tut-icon">${s.icon}</span>
    <div class="tut-text"><textarea onchange="updateTutStep(${i},this.value)" onblur="updateTutStep(${i},this.value)">${escaped}</textarea></div>
    <div class="tut-step-toggle${s.enabled?' on':''}" onclick="toggleTutStep(${i})"></div>
  </div>`}).join('');
}

function toggleTutorialGlobal(){tutorialEnabled=!tutorialEnabled;document.getElementById('tutGlobalToggle').classList.toggle('on',tutorialEnabled);saveTutorialConfig()}
function toggleTutStep(i){tutorialSteps[i].enabled=!tutorialSteps[i].enabled;renderTutorialStepList();saveTutorialConfig()}
function updateTutStep(i,text){tutorialSteps[i].body=text;saveTutorialConfig()}

// Tutorial step drag reorder
let _tutDrag={active:false,fromIdx:null,ghost:null,overIdx:null};
function startTutDrag(e,idx){
  e.preventDefault();e.stopPropagation();
  const target=e.target.closest('.tut-step-card');
  if(!target)return;
  _tutDrag={active:true,fromIdx:idx,ghost:null,overIdx:null};
  const rect=target.getBoundingClientRect();
  const ghost=target.cloneNode(true);ghost.className='drag-ghost';
  ghost.style.width=rect.width+'px';ghost.style.height=rect.height+'px';
  ghost.style.left=rect.left+'px';ghost.style.top=rect.top+'px';
  document.body.appendChild(ghost);_tutDrag.ghost=ghost;
  target.classList.add('dragging');
  const ox=e.clientX-rect.left,oy=e.clientY-rect.top;
  function onMove(ev){
    const cx=ev.clientX||0,cy=ev.clientY||0;
    ghost.style.left=(cx-ox)+'px';ghost.style.top=(cy-oy)+'px';
    ghost.style.display='none';const el=document.elementFromPoint(cx,cy);ghost.style.display='';
    document.querySelectorAll('.tut-step-card').forEach(c=>c.classList.remove('drag-over'));
    if(el){const dt=el.closest('.tut-step-card');if(dt){const di=parseInt(dt.dataset.tutIdx);if(!isNaN(di)&&di!==idx){dt.classList.add('drag-over');_tutDrag.overIdx=di}}}
  }
  function onEnd(){
    window.removeEventListener('pointermove',onMove);window.removeEventListener('pointerup',onEnd);
    if(ghost)ghost.remove();
    document.querySelectorAll('.tut-step-card').forEach(c=>c.classList.remove('dragging','drag-over'));
    if(_tutDrag.overIdx!==null&&_tutDrag.overIdx!==_tutDrag.fromIdx){
      const item=tutorialSteps.splice(_tutDrag.fromIdx,1)[0];
      tutorialSteps.splice(_tutDrag.overIdx,0,item);
      renderTutorialStepList();saveTutorialConfig();
    }
    _tutDrag={active:false,fromIdx:null,ghost:null,overIdx:null};
  }
  window.addEventListener('pointermove',onMove);window.addEventListener('pointerup',onEnd);
}

function saveTutorialConfig(){
  apiCall('saveEventConfig',{config:{
    tutorialEnabled:tutorialEnabled,
    tutorialSteps:JSON.stringify(tutorialSteps),
    briefingConfig:JSON.stringify(briefingConfig)
  }}).then(r=>{
    if(!r||!r.ok)console.error('Tutorial config save failed:',r);
  });
}

function resetTutorialForAll(){
  if(!confirm('Reset tutorial for all teams? Everyone will see the tutorial again on their next login.'))return;
  apiCall('saveEventConfig',{config:{tutorialGen:String(Date.now())}}).then(r=>{
    if(r.ok){const msg=document.getElementById('briefingMsg');if(msg){msg.className='ap-msg ok';msg.textContent='✓ Tutorial reset for all teams';setTimeout(()=>msg.textContent='',3000)}}
  });
}

let _tutFromConfig=false;
function previewTutorial(){
  closeTutorialConfig();
  _tutFromConfig=true;
  _tutIsPreview=true;
  if(isAdmin&&!document.body.classList.contains('player-preview')){
    _tutWasAdmin=true;
    togglePlayerPreview();
    setTimeout(()=>startTutorial(),300);
  }else{
    startTutorial();
  }
}

// Tutorial spotlight engine
function startTutorial(){
  const enabled=tutorialSteps.filter(s=>s.enabled);
  if(!enabled.length)return;
  // Re-render grid to ensure badges/labels reflect current state
  renderGrid();
  // Ensure notepad is collapsed so the trigger spotlight is correct
  if(typeof notepadOpen!=='undefined'&&notepadOpen){notepadOpen=false;document.getElementById('notepadPanel').classList.remove('open')}
  _tutCurrentStep=0;
  document.getElementById('tutorialOverlay').classList.add('active');
  showTutorialStep();
}

function showTutorialStep(){
  const enabled=tutorialSteps.filter(s=>s.enabled);
  if(_tutCurrentStep<0||_tutCurrentStep>=enabled.length){endTutorial();return}
  const step=enabled[_tutCurrentStep];
  const el=document.querySelector(step.selector);
  const spotlight=document.getElementById('tutSpotlight');
  const tooltip=document.getElementById('tutTooltip');
  const title=document.getElementById('tutTooltipTitle');
  const body=document.getElementById('tutTooltipBody');
  const dots=document.getElementById('tutDots');
  const backBtn=document.getElementById('tutBtnBack');
  const nextBtn=document.getElementById('tutBtnNext');

  title.textContent=step.title;
  body.textContent=step.body;
  dots.innerHTML=enabled.map((_,i)=>`<div class="tut-tooltip-dot${i===_tutCurrentStep?' active':''}"></div>`).join('');
  backBtn.style.display=_tutCurrentStep===0?'none':'';
  nextBtn.textContent=_tutCurrentStep===enabled.length-1?'DONE':'NEXT';

  // Reset tooltip transform in case it was centered previously
  tooltip.style.transform='';

  const isVisible=el&&(el.offsetParent!==null||getComputedStyle(el).position==='fixed')&&getComputedStyle(el).display!=='none'&&el.getBoundingClientRect().width>0;
  if(isVisible){
    // Scroll into view if needed
    el.scrollIntoView({behavior:'smooth',block:'nearest'});
    // Wait for scroll to settle then position
    setTimeout(()=>{
      let rect=el.getBoundingClientRect();
      // For flex/grid containers with centered content, measure tight child bounds
      // to avoid highlighting empty buffer space
      const cs=getComputedStyle(el);
      const isCentered=cs.alignContent==='center'||cs.justifyContent==='center';
      const isFlexGrid=cs.display.includes('flex')||cs.display.includes('grid');
      if(isFlexGrid&&isCentered&&el.children.length>0){
        let cTop=Infinity,cLeft=Infinity,cBottom=-Infinity,cRight=-Infinity;
        for(const child of el.children){
          const cr=child.getBoundingClientRect();
          if(cr.width===0||cr.height===0)continue;
          cTop=Math.min(cTop,cr.top);cLeft=Math.min(cLeft,cr.left);
          cBottom=Math.max(cBottom,cr.bottom);cRight=Math.max(cRight,cr.right);
        }
        if(cTop!==Infinity){
          rect={top:cTop,left:cLeft,bottom:cBottom,right:cRight,width:cRight-cLeft,height:cBottom-cTop};
        }
      }
      const pad=8;
      // Clamp spotlight within viewport
      const top=Math.max(4,rect.top-pad);
      const left=Math.max(4,rect.left-pad);
      const w=Math.min(rect.width+pad*2,window.innerWidth-left-4);
      const h=Math.min(rect.height+pad*2,window.innerHeight-top-4);
      spotlight.style.left=left+'px';
      spotlight.style.top=top+'px';
      spotlight.style.width=w+'px';
      spotlight.style.height=h+'px';
      spotlight.style.display='block';

      // Position tooltip relative to spotlight
      const tipH=180;
      const tipW=360;
      if(top+h+tipH+20<window.innerHeight){
        // Below element
        tooltip.style.top=(top+h+12)+'px';
        tooltip.style.bottom='auto';
      }else if(top-tipH-12>0){
        // Above element
        tooltip.style.top=(top-tipH-12)+'px';
        tooltip.style.bottom='auto';
      }else if(h>window.innerHeight*0.5){
        // Element fills most of screen (grid) — inside at top
        tooltip.style.top=(top+12)+'px';
        tooltip.style.bottom='auto';
      }else{
        tooltip.style.top='auto';
        tooltip.style.bottom='20px';
      }
      // Center tooltip over the element, clamped to viewport edges
      const elCenter=rect.left+rect.width/2;
      const tipLeft=Math.max(16,Math.min(elCenter-tipW/2,window.innerWidth-tipW-16));
      tooltip.style.left=tipLeft+'px';
    },150);
  }else{
    // Element not visible or not found — show tooltip centered
    spotlight.style.display='none';
    tooltip.style.top='50%';tooltip.style.left='50%';
    tooltip.style.transform='translate(-50%,-50%)';
  }
}

function tutorialStep(dir){
  const enabled=tutorialSteps.filter(s=>s.enabled);
  _tutCurrentStep+=dir;
  if(_tutCurrentStep>=enabled.length){endTutorial();return}
  if(_tutCurrentStep<0)_tutCurrentStep=0;
  showTutorialStep();
}

let _tutWasAdmin=false;
function replayTutorial(){
  _tutWasAdmin=false;
  if(isAdmin&&!document.body.classList.contains('player-preview')){
    _tutWasAdmin=true;
    togglePlayerPreview();
    setTimeout(()=>{_tutIsPreview=true;startTutorial()},300);
  }else{
    _tutIsPreview=true;
    startTutorial();
  }
}

function endTutorial(){
  document.getElementById('tutorialOverlay').classList.remove('active');
  document.getElementById('tutSpotlight').style.display='none';
  renderGrid(); // Sync grid with latest data after tutorial
  if(!_tutIsPreview){
    const teamId=currentVaultTeam?.id||'unknown';
    try{localStorage.setItem('cb_tutSeen_'+teamId,localStorage.getItem('cb_tutorialGen')||'1')}catch(e){}
    checkShowBriefing();
  }
  if(_tutWasAdmin){
    _tutWasAdmin=false;
    togglePlayerPreview();
  }
  const wasFromConfig=_tutFromConfig;
  _tutIsPreview=false;
  _tutFromConfig=false;
  if(wasFromConfig){setTimeout(()=>openTutorialConfig(),200)}
}

function shouldShowTutorial(){
  if(!tutorialEnabled)return false;
  if(isAdmin&&!document.body.classList.contains('player-preview'))return false;
  const teamId=currentVaultTeam?.id;
  if(!teamId)return false;
  const seen=localStorage.getItem('cb_tutSeen_'+teamId)||'';
  const gen=localStorage.getItem('cb_tutorialGen')||'1';
  return seen!==gen;
}

// ══════ MISSION BRIEFING ══════
let briefingConfig={enabled:false,sourceType:'upload',videoUrl:'',title:'',subtitle:''};

function toggleBriefingGlobal(){briefingConfig.enabled=!briefingConfig.enabled;document.getElementById('briefingGlobalToggle').classList.toggle('on',briefingConfig.enabled);saveTutorialConfig()}

function onBriefingTypeChange(){
  const type=document.getElementById('briefingSourceType').value;
  briefingConfig.sourceType=type;
  document.getElementById('briefingUploadZone').style.display=type==='upload'?'':'none';
  document.getElementById('briefingUrlZone').style.display=type!=='upload'?'':'none';
  saveTutorialConfig();
}

function saveBriefingConfig(){
  const type=document.getElementById('briefingSourceType').value;
  briefingConfig.sourceType=type;
  briefingConfig.title=document.getElementById('briefingTitle').value.trim();
  briefingConfig.subtitle=document.getElementById('briefingSubtitle').value.trim();
  if(type==='upload'){briefingConfig.videoUrl=document.getElementById('briefingFileUrl').value.trim()}
  else{briefingConfig.videoUrl=document.getElementById('briefingVideoUrl').value.trim()}
  saveTutorialConfig();
}

function uploadBriefingVideo(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  const msg=document.getElementById('briefingMsg');
  msg.className='ap-msg';msg.textContent='Uploading video...';
  // Use the same upload ticket system as media
  apiCall('getUploadUrl',{filename:file.name,contentType:file.type}).then(r=>{
    if(!r.ok){msg.className='ap-msg err';msg.textContent='✗ '+r.error;return}
    const formData=new FormData();formData.append('file',file);
    fetch(r.uploadUrl,{method:'POST',headers:{'X-Upload-Ticket':r.ticket},body:formData}).then(resp=>resp.json()).then(u=>{
      if(u.ok){
        briefingConfig.videoUrl=u.url;
        document.getElementById('briefingFileUrl').value=u.url;
        msg.className='ap-msg ok';msg.textContent='✓ Video uploaded';
        saveBriefingConfig();
      }else{msg.className='ap-msg err';msg.textContent='✗ Upload failed'}
    }).catch(()=>{msg.className='ap-msg err';msg.textContent='✗ Upload error'});
  });
}

function resetBriefingForAll(){
  if(!confirm('Reset briefing for all teams? Everyone will see the briefing again on their next login.'))return;
  apiCall('saveEventConfig',{config:{briefingGen:String(Date.now())}}).then(r=>{
    if(r.ok){const msg=document.getElementById('briefingMsg');if(msg){msg.className='ap-msg ok';msg.textContent='✓ Briefing reset for all teams';setTimeout(()=>msg.textContent='',3000)}}
  });
}

function previewBriefing(){
  closeTutorialConfig();
  showBriefingModal();
}

function checkShowBriefing(){
  if(!briefingConfig.enabled||!briefingConfig.videoUrl)return;
  if(isAdmin&&!document.body.classList.contains('player-preview'))return;
  const teamId=currentVaultTeam?.id;
  if(!teamId)return;
  const seen=localStorage.getItem('cb_briefSeen_'+teamId)||'';
  const gen=localStorage.getItem('cb_briefingGen')||'1';
  if(seen===gen)return;
  showBriefingModal();
}

function showBriefingModal(){
  const modal=document.getElementById('briefingModal');
  const container=document.getElementById('briefingVideoContainer');
  const titleEl=document.getElementById('briefingModalTitle');
  const subEl=document.getElementById('briefingModalSubtitle');
  titleEl.textContent=briefingConfig.title||'Mission Briefing';
  subEl.textContent=briefingConfig.subtitle||'';
  // Render video based on source type
  const url=briefingConfig.videoUrl||'';
  if(briefingConfig.sourceType==='youtube'||url.includes('youtube.com')||url.includes('youtu.be')||url.includes('vimeo.com')){
    let embedUrl=url;
    const ytMatch=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
    if(ytMatch)embedUrl='https://www.youtube.com/embed/'+ytMatch[1]+'?autoplay=1';
    const vimeoMatch=url.match(/vimeo\.com\/(\d+)/);
    if(vimeoMatch)embedUrl='https://player.vimeo.com/video/'+vimeoMatch[1]+'?autoplay=1';
    container.innerHTML=`<iframe src="${embedUrl}" allow="autoplay;fullscreen" allowfullscreen></iframe>`;
  }else{
    container.innerHTML=`<video src="${url}" controls autoplay playsinline></video>`;
  }
  modal.classList.add('active');
}

function dismissBriefing(){
  const modal=document.getElementById('briefingModal');
  modal.classList.remove('active');
  // Stop video
  const container=document.getElementById('briefingVideoContainer');
  container.innerHTML='';
  // Mark seen
  const teamId=currentVaultTeam?.id;
  if(teamId){
    try{localStorage.setItem('cb_briefSeen_'+teamId,localStorage.getItem('cb_briefingGen')||'1')}catch(e){}
  }
}

// ══════ INTEL DRAG REORDER ══════
// Extend the existing drag system to support intel fields
function startIntelDrag(e,idx){
  e.preventDefault();e.stopPropagation();
  const target=e.target.closest('.intel-exp-row');
  if(!target)return;
  _drag={active:true,type:'intel',fromIdx:idx,ghost:null,overIdx:null};
  const rect=target.getBoundingClientRect();
  const ghost=target.cloneNode(true);ghost.className='drag-ghost';
  ghost.style.width=rect.width+'px';ghost.style.height=rect.height+'px';
  ghost.style.left=rect.left+'px';ghost.style.top=rect.top+'px';
  document.body.appendChild(ghost);_drag.ghost=ghost;
  target.classList.add('dragging');
  const ox=e.clientX-rect.left,oy=e.clientY-rect.top;
  function onMove(ev){
    const cx=ev.clientX||0,cy=ev.clientY||0;
    ghost.style.left=(cx-ox)+'px';ghost.style.top=(cy-oy)+'px';
    ghost.style.display='none';const el=document.elementFromPoint(cx,cy);ghost.style.display='';
    document.querySelectorAll('.intel-exp-row[data-idx]').forEach(c=>c.classList.remove('drag-over'));
    if(el){const dt=el.closest('.intel-exp-row[data-idx]');if(dt){const di=parseInt(dt.dataset.idx);if(!isNaN(di)&&di!==idx){dt.classList.add('drag-over');_drag.overIdx=di}}}
  }
  function onEnd(){
    window.removeEventListener('pointermove',onMove);window.removeEventListener('pointerup',onEnd);
    if(ghost)ghost.remove();
    document.querySelectorAll('.intel-exp-row').forEach(c=>c.classList.remove('dragging','drag-over'));
    if(_drag.overIdx!==null&&_drag.overIdx!==_drag.fromIdx){
      const item=intelFields.splice(_drag.fromIdx,1)[0];
      intelFields.splice(_drag.overIdx,0,item);
      renderIntelForm();renderGrid();saveIntelFieldsToBackend();
    }
    _drag={active:false,type:null,fromIdx:null,ghost:null,overIdx:null};
  }
  window.addEventListener('pointermove',onMove);window.addEventListener('pointerup',onEnd);
}

// ══════ APPLY TUTORIAL/BRIEFING CONFIG FROM BACKEND ══════
function applyTutorialBriefingConfig(cfg){
  if(cfg.tutorialEnabled!==undefined)tutorialEnabled=(cfg.tutorialEnabled==='true'||cfg.tutorialEnabled===true);
  if(cfg.tutorialSteps){
    if(typeof cfg.tutorialSteps==="string"){try{tutorialSteps=JSON.parse(cfg.tutorialSteps)}catch(e){}}
    else if(Array.isArray(cfg.tutorialSteps)){tutorialSteps=cfg.tutorialSteps}
  }
  if(cfg.tutorialGen){try{localStorage.setItem('cb_tutorialGen',String(cfg.tutorialGen))}catch(e){}}
  if(cfg.briefingGen){try{localStorage.setItem('cb_briefingGen',String(cfg.briefingGen))}catch(e){}}
  if(cfg.briefingConfig){
    if(typeof cfg.briefingConfig==="string"){try{briefingConfig=JSON.parse(cfg.briefingConfig)}catch(e){}}
    else if(typeof cfg.briefingConfig==="object"){briefingConfig=cfg.briefingConfig}
  }
}

// ══════ FUTURE UPGRADES (NOTED) ══════
// TODO: Pre-event Lobby — Holding screen with countdown for teams before event starts
// TODO: Hint System — Timed or purchasable hints per puzzle, configurable in admin
// TODO: Analytics Dashboard — Team activity heatmaps, completion rates, time-per-puzzle
// TODO: Puzzle Builder — Multi-stage puzzle flow with progression gating
// ══════ END FUTURE NOTES ══════
setInterval(tickTimer,1000);
// Initial dynamic renders — defer renderGrid to after restoreSession
// so cached posts/media/intel are in memory when the grid first paints.
// renderGrid() will be called by restoreSession → applyScreenAndPanel,
// or by loadEventData if no session exists.
renderIntelForm();
buildRegForm();
updateLandingForMode();

// ═══════════════════════════════════════════════════════════════
// SESSION PERSISTENCE
// ═══════════════════════════════════════════════════════════════

function _sessionStore(){return regSettings.sessionPersist?localStorage:sessionStorage}
function saveSession(){
  try{
    // Only save when user is authenticated on the console screen
    if(_currentScreen!=='consoleScreen'&&_currentScreen!=='settingsScreen')return;
    if(!currentVaultTeam)return;
    const data={type:isAdmin?'admin':'team',team:currentVaultTeam,savedAt:Date.now()};
    if(isAdmin){
      data.adminSession=adminSession;
      // Save which admin page is open
      if(_currentAdminPage||_currentScreen==='settingsScreen')data.adminPage='settingsScreen';
      // Save active tab within settings page
      var activeTab=document.querySelector('#settingsScreen .admin-page-section.active');
      if(activeTab)data.adminTab=activeTab.id;
    }
    // Save which player panel is open so refresh restores exactly where the user was
    const openPanelEl=document.querySelector('.expanded-panel.visible');
    if(openPanelEl)data.panel=openPanelEl.id;
    // Save feed view state so focus mode + post index survive refresh
    data.feedView=currentFeedView;
    data.feedPost=currentPost;// Persist session in the active storage mode only.
// This prevents "stale admin token" loops caused by old sessions lingering in localStorage.
const json=JSON.stringify(data);
const store=_sessionStore(); // localStorage if persist mode, else sessionStorage
store.setItem('cb_session',json);
// Clear the other store to avoid resurrecting an expired session later
(store===localStorage?sessionStorage:localStorage).removeItem('cb_session');
}catch(e){}
}

// ── Game State Persistence ──
// Persists vault progress, intel answers, cooldown, and elapsed timer
// so browser close / refresh doesn't lose gameplay progress.
// Keyed per team to prevent cross-team bleed.

function _gsKey(suffix){
  const tid=currentVaultTeam?.id||'UNKNOWN';
  return 'cb_gs_'+tid+'_'+suffix;
}

function saveGameState(){
  try{
    if(!currentVaultTeam)return;

    // 1. Vault unlock progress — which codes have been cracked
    const unlocks={};
    vaultCodes.forEach(c=>{if(c.unlocked)unlocks[c.code]={at:c.unlockedAt}});
    localStorage.setItem(_gsKey('vaultUnlocks'),JSON.stringify(unlocks));

    // 2. Vault fail counters
    localStorage.setItem(_gsKey('vaultFails'),JSON.stringify({
      failCount:vkFailCount,
      totalFails:vkTotalFails
    }));

    // 3. Vault cooldown — store absolute end time so it survives browser close
    // _vaultLockoutEnd is set by triggerVaultLockout()
    if(_vaultLockoutEnd){
      localStorage.setItem(_gsKey('vaultLockout'),JSON.stringify({endTime:_vaultLockoutEnd}));
    }else{
      localStorage.removeItem(_gsKey('vaultLockout'));
    }

    // 4. Intel form answers (typed but not yet submitted)
    const intelAnswers={};
    document.querySelectorAll('.intel-exp-input').forEach(inp=>{
      const idx=inp.dataset.idx;
      if(idx!==undefined&&inp.value.trim())intelAnswers[idx]=inp.value;
    });
    localStorage.setItem(_gsKey('intelDraft'),JSON.stringify(intelAnswers));

    // 5. Submission status
    localStorage.setItem(_gsKey('isSubmitted'),isSubmitted?'1':'0');

    // 6. Elapsed timer — store session start time (absolute) so we can compute elapsed on restore
    if(!_sessionStartTime)_sessionStartTime=Date.now()-elapsedSec*1000;
    localStorage.setItem(_gsKey('sessionStart'),String(_sessionStartTime));

  }catch(e){console.warn('saveGameState error:',e)}
}

function restoreGameState(){
  try{
    if(!currentVaultTeam)return;

    // 1. Vault unlock progress
    const unlockRaw=localStorage.getItem(_gsKey('vaultUnlocks'));
    if(unlockRaw){
      const unlocks=JSON.parse(unlockRaw);
      vaultCodes.forEach(c=>{
        const u=unlocks[c.code];
        if(u){c.unlocked=true;c.unlockedAt=u.at||new Date().toISOString();
          // Also unlock the linked media item
          if(typeof c.linkedMediaIdx==='number'&&mediaItems[c.linkedMediaIdx]){
            // NOTE: Do not mutate vaultLocked here; unlock visibility is team-scoped via vaultCodes + localStorage.
          }
        }
      });
    }

    // 2. Vault fail counters
    const failRaw=localStorage.getItem(_gsKey('vaultFails'));
    if(failRaw){
      const f=JSON.parse(failRaw);
      vkFailCount=f.failCount||0;
      vkTotalFails=f.totalFails||0;
    }

    // 3. Vault cooldown — check if lockout is still active
    const lockoutRaw=localStorage.getItem(_gsKey('vaultLockout'));
    if(lockoutRaw){
      const l=JSON.parse(lockoutRaw);
      const remaining=Math.ceil((l.endTime-Date.now())/1000);
      if(remaining>0){
        // Cooldown still active — resume it
        _vaultLockoutEnd=l.endTime;
        triggerVaultLockout(remaining,'SECURITY LOCKOUT','Cooldown in progress · '+remaining+'s remaining');
      }else{
        // Cooldown expired while browser was closed — clear it
        localStorage.removeItem(_gsKey('vaultLockout'));
        _vaultLockoutEnd=null;
        vkFailCount=0;vkTotalFails=0;
        localStorage.setItem(_gsKey('vaultFails'),JSON.stringify({failCount:0,totalFails:0}));
      }
    }

    // 4. Submission status
    const subRaw=localStorage.getItem(_gsKey('isSubmitted'));
    if(subRaw==='1')isSubmitted=true;

    // 5. Elapsed timer — compute from stored start time
    const startRaw=localStorage.getItem(_gsKey('sessionStart'));
    if(startRaw){
      _sessionStartTime=parseInt(startRaw);
      elapsedSec=Math.floor((Date.now()-_sessionStartTime)/1000);
    }

  }catch(e){console.warn('restoreGameState error:',e)}
}

function restoreIntelDraft(){
  // Called after renderIntelForm to restore typed answers
  try{
    if(!currentVaultTeam)return;
    const raw=localStorage.getItem(_gsKey('intelDraft'));
    if(!raw)return;
    const answers=JSON.parse(raw);
    document.querySelectorAll('.intel-exp-input').forEach(inp=>{
      const idx=inp.dataset.idx;
      if(idx!==undefined&&answers[idx]){inp.value=answers[idx]}
    });
  }catch(e){}
}

function clearGameState(){
  try{
    if(!currentVaultTeam)return;
    const prefixes=['vaultUnlocks','vaultFails','vaultLockout','intelDraft','isSubmitted','sessionStart'];
    prefixes.forEach(p=>localStorage.removeItem(_gsKey(p)));
  }catch(e){}
}

// Auto-save game state periodically and on visibility change
setInterval(()=>{if(currentVaultTeam&&(_currentScreen==='consoleScreen'||_currentScreen==='settingsScreen')){saveGameState();saveSession()}},5000);
function _saveAll(){if(currentVaultTeam&&(_currentScreen==='consoleScreen'||_currentScreen==='settingsScreen')){saveGameState();saveSession()}}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden')_saveAll()});
window.addEventListener('beforeunload',_saveAll);
window.addEventListener('pagehide',_saveAll);

function clearSession(){
  try{
    clearGameState();
    localStorage.removeItem('cb_session');
    sessionStorage.removeItem('cb_session');
    localStorage.removeItem('cb_posts');
    localStorage.removeItem('cb_media');
    localStorage.removeItem('cb_intel');
    _vaultLockoutEnd=null;
    _sessionStartTime=null;
  }catch(e){}
}

function restoreSession(){
  try{
    // Try sessionStorage first (always valid if tab is still open),
    // then localStorage with 2-minute grace window for team sessions
    let raw=sessionStorage.getItem('cb_session');
    let fromLocalStorage=false;
    if(!raw){
      raw=localStorage.getItem('cb_session');
      fromLocalStorage=true;
    }
    if(!raw)return false;
    const data=JSON.parse(raw);
    if(!data||!data.team)return false;

    // For team sessions restored from localStorage (browser was closed):
    // enforce 2-minute grace window — if closed longer, require re-login
    if(fromLocalStorage&&data.type==='team'&&data.savedAt){
      const elapsed=Date.now()-data.savedAt;
      const graceMs=2*60*1000; // 2 minutes
      if(elapsed>graceMs){
        localStorage.removeItem('cb_session');
        return false;
      }
    }

// For admin sessions restored from localStorage:
// Do NOT restore — admin tokens are typically short-lived. Restoring from a previous browser session
// can cause an immediate "Admin session expired" loop.
if(fromLocalStorage&&data.type==='admin'){
  localStorage.removeItem('cb_session');
  return false;
}

    const targetScreen='consoleScreen';
    const panelMap={expFeed:'feed',expMedia:'media',expIntel:'intel',expVault:'vault'};

    // Restore cached content (posts/media/intel) from localStorage BEFORE rendering
    // This makes images appear instantly instead of waiting 3-5s for backend API
    _restoreContentCache();

    // Detect mobile for conditional panel restore
    const _isMobileRestore=window.innerWidth<=768; // (kept for other responsive logic)

    function applyScreenAndPanel(){
      // Set up screen first (hidden — opacity:0 via .screen default)
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(targetScreen).classList.add('active');
      _currentScreen=targetScreen;
      const lb=document.getElementById('logoutBtn');if(lb)lb.classList.toggle('visible',true);
      document.getElementById('notepadTrigger').classList.add('visible');

      // Open panel SYNCHRONOUSLY before any paint if one was saved
      // On mobile: skip panel restore — land on console grid so user has context
      // On desktop: restore exactly where they were (prevents flash)
      if(data.panel&&panelMap[data.panel]){
        const panelEl=document.getElementById(data.panel);
        if(panelEl){
          document.querySelectorAll('.expanded-panel').forEach(p=>p.classList.remove('visible'));
          panelEl.classList.add('visible');
          // Show overlay immediately, no transition
          overlay.style.cssText='opacity:1;pointer-events:all;transition:none';
          overlay.classList.add('active');
          // Render panel content immediately with whatever is in memory
          // Backend refresh will update it in the background
          const t=panelMap[data.panel];
          if(t==='feed'){
            renderFeed();
            // Restore exact feed view state — grid or focus mode + post index
            if(data.feedView==='single'&&typeof data.feedPost==='number'){
              currentPost=data.feedPost;
              setFeedView('single');
            }else{
              setFeedView('grid');
            }
          }
          if(t==='media')renderMedia();
          if(t==='intel'){renderIntelForm();restoreIntelDraft()}
          if(t==='vault')renderVaultPanel();
        }
      }
    }

    if(data.type==='admin'&&data.adminSession){
      adminSession=data.adminSession;
      isAdmin=true;
      document.body.classList.add('admin-mode');
      currentVaultTeam=data.team;
      updateConsoleForTeam(currentVaultTeam);
      syncAdminDropdownToggles();
      restoreGameState();
      applyScreenAndPanel();
      // Apply cached theme + operation name BEFORE first renderGrid
      // NOTE: _currentGridTheme is declared later with let, so we defer theme assignment
      // to avoid TDZ. We use applyGridTheme() which is already declared, and defer the
      // variable assignment to the post-declaration block below.
      try{
        const ct=localStorage.getItem('cb_gridTheme');
        if(ct){applyGridTheme(ct);window._deferredGridTheme=ct}
        const cn=localStorage.getItem('cb_opName');
        if(cn){operationName=cn;const el=document.getElementById('consoleTitle');if(el)el.textContent='◈ '+cn;document.title=cn+' — Console'}
        const cf=localStorage.getItem('cb_opFont');
        if(cf){operationFont=cf;applyOperationFont(cf)}
      }catch(e){}
      renderGrid(); // Render grid with cached data + theme immediately
      // Restore admin panel — DEFERRED to avoid TDZ with let declarations
      // navigateToAdmin() accesses _panelsMounted, _currentAdminPage, _currentGridTheme etc.
      // which are declared with let/const AFTER this point in the file
      if(data.adminPage){
        window._deferredAdminRestore={page:data.adminPage||'settingsScreen',tab:data.adminTab||null};
      }
      startElapsedTimer();
      startTeamMonitor();
      loadEventData().then(function(){
        if(_currentAdminPage==='settingsScreen'){
          var as=document.querySelector('#settingsScreen .admin-page-section.active');
          if(as)_switchToTab('settingsScreen',as.id);
        }
      });
      return true;
    }else if(data.type==='team'&&data.team.id){
      currentVaultTeam=data.team;
      if(!registeredTeams.find(r=>r.id===data.team.id))registeredTeams.push(currentVaultTeam);
      updateConsoleForTeam(currentVaultTeam);
      restoreGameState();
      applyScreenAndPanel();
      // Apply cached theme + operation name BEFORE first renderGrid
      try{
        const ct=localStorage.getItem('cb_gridTheme');
        if(ct){applyGridTheme(ct);window._deferredGridTheme=ct}
        const cn=localStorage.getItem('cb_opName');
        if(cn){operationName=cn;const el=document.getElementById('consoleTitle');if(el)el.textContent='◈ '+cn;document.title=cn+' — Console'}
        const cf=localStorage.getItem('cb_opFont');
        if(cf){operationFont=cf;applyOperationFont(cf)}
      }catch(e){}
      renderGrid(); // Render grid with cached data + theme immediately
      startElapsedTimer();
      // Load config and fresh content in background — UI already showing
      apiCall('getEventConfig').then(cfg=>{
        if(cfg.ok&&cfg.config)applyEventConfig(cfg.config);
        // Re-sync vault codes after fresh data arrives, then re-apply unlock state
        syncVaultCodesFromMedia();
        restoreGameState();
        // Re-render panel with fresh backend data once it arrives
        if(data.panel&&panelMap[data.panel]){
          const t=panelMap[data.panel];
          if(t==='feed'){
            renderFeed();
            if(data.feedView==='single'&&typeof data.feedPost==='number'){
              currentPost=data.feedPost;
              setFeedView('single');
            }else{
              setFeedView(currentFeedView);
            }
          }
          if(t==='media')renderMedia();
          if(t==='intel'){renderIntelForm();restoreIntelDraft()}
          if(t==='vault')renderVaultPanel();
        }
        // Also update grid badges after vault state is restored
        renderGrid();
        loadDraftsFromBackend();
      });
      startBroadcastPolling();
      startActivityTracker();
      return true;
    }
  }catch(e){console.error('restoreSession error:',e);}
  return false;
}

// Auto-restore on page load
if(!restoreSession()){
  renderGrid(); // No session — render default grid
}

// ═══════════════════════════════════════════════════════════════
// BROWSER HISTORY — Back button / gesture support (Fix #3)
// ═══════════════════════════════════════════════════════════════
// Push history states when navigating so Android back gesture / iOS
// swipe-back and browser back button work instead of leaving the site.
(function(){
  let _navDepth=0; // track how deep we are to avoid over-popping
  const _historyEnabled=true;

  // Push a state when navigating deeper
  window._histPush=function(stateType){
    if(!_historyEnabled)return;
    _navDepth++;
    history.pushState({type:stateType,depth:_navDepth},'');
  };

  // Pop handler — reverse the last navigation
  window.addEventListener('popstate',function(e){
    if(!_historyEnabled)return;
    const state=e.state;
    _navDepth=Math.max(0,_navDepth-1);

    // Determine what to close based on current UI state
    // Priority: media viewer > feed focus > expanded panel > admin panel > screen nav

    // 1. Media viewer open?
    const mv=document.getElementById('mediaViewer');
    if(mv&&mv.classList.contains('active')){
      closeMediaViewer();return;
    }

    // 2. Feed in focus/single mode?
    const feedPanel=document.getElementById('expFeed');
    if(feedPanel&&feedPanel.classList.contains('visible')&&currentFeedView==='single'){
      setFeedView('grid');return;
    }

    // 3. Any expanded panel open?
    const openExpPanel=document.querySelector('.expanded-panel.visible');
    if(openExpPanel){
      closePanel();return;
    }

    // 4. Any admin panel open?
    const adminIds=['adminPanel','broadcastPanel','leaderboardModule','keysCodesPanel','dashboardPanel','portalUsersPanel','scoringPanel','registrationPanel','appearancePanel','sessionMgmtPanel','tutorialConfigPanel'];
    for(const id of adminIds){
      const el=document.getElementById(id);
      if(el&&el.classList.contains('active')){
        if(id==='adminPanel')closeEventSettings();
        else if(id==='broadcastPanel')closeBroadcast();
        else if(id==='leaderboardModule')closeLeaderboard();
        else if(id==='keysCodesPanel')closeKeysCodes();
        else if(id==='dashboardPanel')closeDashboard();
        else if(id==='portalUsersPanel')closePortalUsers();
        else if(id==='scoringPanel')closeScoringPanel();
        else if(id==='registrationPanel')closeRegistrationPanel();
        else if(id==='appearancePanel')closeAppearancePanel();
        else if(id==='sessionMgmtPanel')closeSessionMgmt();
        else if(id==='tutorialConfigPanel')closeTutorialConfig();
        return;
      }
    }

    // 5. On console screen — go back to landing
    const curScreen=document.querySelector('.screen.active')?.id||'';
    if(curScreen==='consoleScreen'&&!isAdmin){
      // Don't actually log out — just show landing. User can log back in easily.
      showScreen('landingScreen');return;
    }
    if(curScreen==='loginScreen'){loginBack();return}
    if(curScreen==='regScreen'){regBack();return}

    // 6. Nothing to go back to — push a state so we don't leave the site
    if(_navDepth<=0){
      history.pushState({type:'root'},'');
      _navDepth=1;
    }
  });

  // Seed initial state so first back press doesn't leave the site
  if(!history.state){
    history.replaceState({type:'root',depth:0},'');
  }
})();

// ── Build stamp & cache staleness check (admin only) ──
const _BUILD_ID = '20260225-DEBUG';
// Security: HTML sanitizer to prevent XSS
function sanitizeHTML(str){return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#x27;')}
(function(){
  function showBuildStamp(dateStr,status,hint){
    if(!document.body.classList.contains('admin-mode'))return;
    const el=document.getElementById('buildStamp');
    if(!el)return;
    el.style.display='block';
    el.textContent=(dateStr?'Updated '+dateStr+' - ':'')+status;
    el.style.color=status.startsWith('✓')?'#2a6a3a':status.startsWith('⚠')?'#8a6a10':'#333';
    if(hint)el.title=hint;
  }
  function formatLastMod(header){
    if(!header)return '';
    try{
      var d=new Date(header);
      if(isNaN(d))return '';
      var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var h=d.getHours(),m=d.getMinutes();
      var ampm=h>=12?'PM':'AM';
      var h12=h%12||12;
      return months[d.getMonth()]+' '+d.getDate()+', '+h12+':'+String(m).padStart(2,'0')+ampm;
    }catch(e){return ''}
  }

  function checkCache(){
    if(!document.body.classList.contains('admin-mode'))return;
    fetch(window.location.pathname+'?_v='+Date.now(),{method:'HEAD',cache:'no-store'})
      .then(r=>{
        var lastMod=formatLastMod(r.headers.get('last-modified'));
        var etag=r.headers.get('etag')||r.headers.get('cf-cache-status')||'';
        var lastEtag=localStorage.getItem('cb_last_etag');
        if(!lastEtag){
          localStorage.setItem('cb_last_etag',etag);
          showBuildStamp(lastMod,'✓ Cache OK','ETag stored. Future refreshes will detect stale cache.');
        } else if(etag && etag!==lastEtag){
          localStorage.setItem('cb_last_etag',etag);
          showBuildStamp(lastMod,'✓ Fresh deploy','Server returned a new ETag. You are running the latest version.');
        } else {
          var cfStatus=r.headers.get('cf-cache-status')||'';
          if(cfStatus==='HIT'){
            showBuildStamp(lastMod,'⚠ CF cache HIT','Cloudflare serving cached version. Purge cache then hard-refresh.');
          } else {
            showBuildStamp(lastMod,'✓ Cache OK'+(cfStatus?' - CF: '+cfStatus:''),'File appears current.');
          }
        }
      })
      .catch(function(){showBuildStamp('','Build '+_BUILD_ID,'Could not verify cache status.')});
  }

  setTimeout(function(){checkCache()},1200);
  document.addEventListener('adminReady',function(){setTimeout(checkCache,800)});
})();

// Apply stored operation font via centralized helper
if(operationFont)applyOperationFont(operationFont);

// ═══════════════════════════════════════════════════════════════
// SECURITY HARDENING
// ═══════════════════════════════════════════════════════════════

// Block right-click context menu (non-admin)
document.addEventListener('contextmenu',e=>{
  if(!isAdmin){e.preventDefault();return false}
});

// Block keyboard shortcuts for dev tools & view source (non-admin)
document.addEventListener('keydown',e=>{
  if(isAdmin)return; // Admins bypass all restrictions
  // F12
  if(e.key==='F12'){e.preventDefault();return false}
  // Ctrl+Shift+I (Dev tools)
  if(e.ctrlKey&&e.shiftKey&&e.key==='I'){e.preventDefault();return false}
  // Ctrl+Shift+J (Console)
  if(e.ctrlKey&&e.shiftKey&&e.key==='J'){e.preventDefault();return false}
  // Ctrl+Shift+C (Element inspector)
  if(e.ctrlKey&&e.shiftKey&&e.key==='C'){e.preventDefault();return false}
  // Ctrl+U (View source)
  if(e.ctrlKey&&e.key==='u'){e.preventDefault();return false}
  // Ctrl+S (Save page)
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();return false}
  // Ctrl+P (Print)
  if(e.ctrlKey&&e.key==='p'){e.preventDefault();return false}
});

// Block drag on images (prevents drag-to-desktop saving)
document.addEventListener('dragstart',e=>{
  if(!isAdmin&&(e.target.tagName==='IMG'||e.target.tagName==='VIDEO')){e.preventDefault()}
});

// Disable text selection on feed & media content (non-admin)
document.addEventListener('selectstart',e=>{
  if(!isAdmin&&(e.target.closest('.feed-grid')||e.target.closest('#mvBody'))){e.preventDefault()}
});

// Clear console periodically to discourage snooping
if(!isAdmin){
  const _cc=()=>{try{console.clear()}catch(e){}};
  setInterval(_cc,3000);
  // Override console methods for non-admin
  const _noop=()=>{};
  if(!window._adminConsole){
    window._adminConsole={log:console.log,warn:console.warn,error:console.error};
  }
}

// Detect dev tools open (debugger pause — non-admin only)
// Softened: shows overlay warning instead of destroying the page
let _devtoolsWarned=false;
setInterval(()=>{
  if(isAdmin||_devtoolsWarned)return;
  const t=performance.now();
  debugger;
  if(performance.now()-t>100){
    _devtoolsWarned=true;
    const overlay=document.createElement('div');
    overlay.id='devtoolsOverlay';
    overlay.style.cssText='position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;font-family:monospace';
    overlay.innerHTML='<div style="color:#ff3333;font-size:18px;letter-spacing:3px">⚠ DEVELOPER TOOLS DETECTED</div><div style="color:#888;font-size:13px;max-width:400px;text-align:center;line-height:1.6">Please close developer tools to continue the experience.</div><button onclick="this.parentElement.remove();_devtoolsWarned=false" style="margin-top:12px;padding:10px 28px;background:none;border:1px solid #555;color:#aaa;cursor:pointer;font-family:monospace;letter-spacing:2px;border-radius:4px">DISMISS</button>';
    document.body.appendChild(overlay);
  }
},4000);

// Restore console for admin after login
function unlockAdminConsole(){
  if(window._adminConsole){
    console.log=window._adminConsole.log;
    console.warn=window._adminConsole.warn;
    console.error=window._adminConsole.error;
  }
}


// ═══════════════════════════════════════════════════════════════
// CONSOLE GRID THEMES
// ═══════════════════════════════════════════════════════════════

const _gridThemes=[
  {id:'crt',       name:'CRT Monitor'},
  {id:'glass',     name:'Glass Morphism'},
  {id:'cyberpunk', name:'Neon Cyberpunk'},
  {id:'military',  name:'Military Ops'},
  {id:'holo',      name:'Holographic'},
  {id:'brutalist', name:'Brutalist Tech'},
  {id:'minimal',   name:'Sleek Minimal'},
  {id:'hud',       name:'HUD Overlay'},
  {id:'cards',     name:'Card Stack'},
  {id:'terminal',  name:'Terminal'}
];
let _currentGridTheme='crt';
let _previewThemeIdx=0;
let _previewOriginalTheme='crt';

// ── Console Background Color & Texture ──
let _consoleBg='#080a10';
let _consoleTex='none';
let _consoleTexOpacity=40;

const _textureCSS={
  none:'',
  scanlines:'repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.03) 2px,rgba(255,255,255,.03) 4px)',
  grid:'repeating-linear-gradient(0deg,transparent,transparent 11px,rgba(0,255,136,.04) 11px,rgba(0,255,136,.04) 12px),repeating-linear-gradient(90deg,transparent,transparent 11px,rgba(0,255,136,.04) 11px,rgba(0,255,136,.04) 12px)',
  noise:'url("data:image/svg+xml,%3Csvg viewBox=\'0 0 512 512\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'n\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.8\' numOctaves=\'4\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'512\' height=\'512\' filter=\'url(%23n)\' opacity=\'0.08\'/%3E%3C/svg%3E")',
  circuit:'repeating-linear-gradient(90deg,transparent,transparent 20px,rgba(0,212,255,.04) 20px,rgba(0,212,255,.04) 21px),repeating-linear-gradient(0deg,transparent,transparent 30px,rgba(0,212,255,.04) 30px,rgba(0,212,255,.04) 31px),repeating-linear-gradient(45deg,transparent 0px,transparent 28px,rgba(0,212,255,.025) 28px,rgba(0,212,255,.025) 29px)',
  hex:'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'28\' height=\'49\' viewBox=\'0 0 28 49\'%3E%3Cpath d=\'M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15z\' fill=\'none\' stroke=\'rgba(0,212,255,0.06)\' stroke-width=\'0.5\'/%3E%3Cpath d=\'M13.99 33.75l13 7.5v15l-13 7.5L1 56.25v-15z\' fill=\'none\' stroke=\'rgba(0,212,255,0.06)\' stroke-width=\'0.5\'/%3E%3Cpath d=\'M27.99 -8.25l13 7.5v15l-13 7.5L15 6.75v-15z\' fill=\'none\' stroke=\'rgba(0,212,255,0.06)\' stroke-width=\'0.5\'/%3E%3C/svg%3E")'
};

function applyConsoleBg(){
  const screen=document.getElementById('consoleScreen');
  const overlay=document.getElementById('consoleBgOverlay');
  // Set CSS variable so body and all panels inherit the background
  document.documentElement.style.setProperty('--bg-deep',_consoleBg);
  document.documentElement.style.setProperty('--console-bg',_consoleBg);
  if(screen)screen.style.background=_consoleBg;
  if(overlay){
    if(_consoleTex==='none'){
      overlay.style.background='';
      overlay.style.opacity='0';
    }else{
      overlay.style.background=_textureCSS[_consoleTex]||'';
      overlay.style.opacity=String(_consoleTexOpacity/100);
    }
  }
}

function setConsoleBgColor(color){
  _consoleBg=color;
  const picker=document.getElementById('consoleBgColor');
  const hex=document.getElementById('consoleBgHex');
  if(picker)picker.value=color;
  if(hex)hex.value=color;
  applyConsoleBg();
  saveConsoleBgConfig();
}

function updateConsoleBg(){
  const picker=document.getElementById('consoleBgColor');
  const hex=document.getElementById('consoleBgHex');
  if(picker){_consoleBg=picker.value;if(hex)hex.value=picker.value}
  applyConsoleBg();
  saveConsoleBgConfig();
}

function setConsoleTexture(tex){
  _consoleTex=tex;
  document.querySelectorAll('.cbg-tex').forEach(b=>{
    b.classList.toggle('active',b.dataset.tex===tex);
  });
  applyConsoleBg();
  saveConsoleBgConfig();
}

function updateTexOpacity(){
  const slider=document.getElementById('consoleBgTexOpacity');
  const label=document.getElementById('texOpacityVal');
  if(slider){_consoleTexOpacity=parseInt(slider.value);if(label)label.textContent=slider.value+'%'}
  applyConsoleBg();
  saveConsoleBgConfig();
}

function resetConsoleBg(){
  setConsoleBgColor('#080a10');
  setConsoleTexture('none');
  _consoleTexOpacity=40;
  const slider=document.getElementById('consoleBgTexOpacity');
  const label=document.getElementById('texOpacityVal');
  if(slider)slider.value='40';
  if(label)label.textContent='40%';
  applyConsoleBg();
  saveConsoleBgConfig();
}

function saveConsoleBgConfig(){
  const blip=document.getElementById('blipConsoleBg');
  if(blip){blip.style.opacity='1';setTimeout(()=>blip.style.opacity='0',1500)}
  // Save locally for instant restore
  try{
    localStorage.setItem('cb_consoleBg',JSON.stringify({color:_consoleBg,texture:_consoleTex,texOpacity:_consoleTexOpacity}));
  }catch(e){}
  // Save to backend config
  apiCall('saveEventConfig',{config:{consoleBgColor:_consoleBg,consoleBgTexture:_consoleTex,consoleBgTexOpacity:String(_consoleTexOpacity)}});
}

function restoreConsoleBg(){
  // Try localStorage first for instant display
  try{
    const raw=localStorage.getItem('cb_consoleBg');
    if(raw){
      const cfg=JSON.parse(raw);
      if(cfg.color)_consoleBg=cfg.color;
      if(cfg.texture)_consoleTex=cfg.texture;
      if(cfg.texOpacity!==undefined)_consoleTexOpacity=cfg.texOpacity;
    }
  }catch(e){}
  applyConsoleBg();
}

function syncConsoleBgFromConfig(cfg){
  if(cfg.consoleBgColor)_consoleBg=cfg.consoleBgColor;
  if(cfg.consoleBgTexture)_consoleTex=cfg.consoleBgTexture;
  if(cfg.consoleBgTexOpacity!==undefined)_consoleTexOpacity=parseInt(cfg.consoleBgTexOpacity);
  // Update UI controls if visible
  const picker=document.getElementById('consoleBgColor');
  const hex=document.getElementById('consoleBgHex');
  const slider=document.getElementById('consoleBgTexOpacity');
  const label=document.getElementById('texOpacityVal');
  if(picker)picker.value=_consoleBg;
  if(hex)hex.value=_consoleBg;
  if(slider)slider.value=String(_consoleTexOpacity);
  if(label)label.textContent=_consoleTexOpacity+'%';
  document.querySelectorAll('.cbg-tex').forEach(b=>{
    b.classList.toggle('active',b.dataset.tex===_consoleTex);
  });
  // Save locally for next load
  try{localStorage.setItem('cb_consoleBg',JSON.stringify({color:_consoleBg,texture:_consoleTex,texOpacity:_consoleTexOpacity}))}catch(e){}
  applyConsoleBg();
}

function updateThemeLabel(){
  const el=document.getElementById('currentThemeLabel');
  const t=_gridThemes.find(t=>t.id===_currentGridTheme);
  if(el&&t)el.textContent='Current: '+t.name;
}

function openThemePreview(){
  _previewOriginalTheme=_currentGridTheme;
  _previewThemeIdx=_gridThemes.findIndex(t=>t.id===_currentGridTheme);
  if(_previewThemeIdx<0)_previewThemeIdx=0;
  closeAppearancePanel();
  const overlay=document.getElementById('themePreviewOverlay');
  overlay.style.display='flex';
  renderThemePreviewGrid();
  applyThemeToPreviewGrid(_gridThemes[_previewThemeIdx].id);
  updateThemePreviewUI();
}

function closeThemePreview(){
  document.getElementById('themePreviewOverlay').style.display='none';
  // Restore original theme (user cancelled)
  applyGridTheme(_previewOriginalTheme);
  _currentGridTheme=_previewOriginalTheme;
  // Return to appearance panel
  setTimeout(()=>openAppearancePanel(),120);
}

function cycleThemePreview(dir){
  _previewThemeIdx=(_previewThemeIdx+dir+_gridThemes.length)%_gridThemes.length;
  applyThemeToPreviewGrid(_gridThemes[_previewThemeIdx].id);
  // Also apply to real grid behind the overlay so it updates live
  applyGridTheme(_gridThemes[_previewThemeIdx].id);
  updateThemePreviewUI();
}

function applyThemeFromPreview(){
  _currentGridTheme=_gridThemes[_previewThemeIdx].id;
  applyGridTheme(_currentGridTheme);
  try{localStorage.setItem('cb_gridTheme',_currentGridTheme)}catch(e){}
  document.getElementById('themePreviewOverlay').style.display='none';
  updateThemeLabel();
  const blip=document.getElementById('blipGridTheme');
  if(blip){blip.style.opacity='1';setTimeout(()=>blip.style.opacity='',1500)}
  saveEventConfigToBackend();
  // Return to appearance panel
  setTimeout(()=>openAppearancePanel(),120);
}

function updateThemePreviewUI(){
  const t=_gridThemes[_previewThemeIdx];
  document.getElementById('themePreviewName').textContent=t.name;
  document.getElementById('themePreviewCounter').textContent=(_previewThemeIdx+1)+' / '+_gridThemes.length;
}

function renderThemePreviewGrid(){
  // Render a copy of the current grid tiles into the preview
  const pg=document.getElementById('themePreviewGrid');
  pg.innerHTML=gridTiles.map(t=>{
    const isIntel=t.id==='intel';
    const isVault=t.id==='vault';
    const badgeCls=isVault?' crimson':isIntel?' violet':'';
    return `<div class="crt-monitor">
      <div class="crt-screw s1"></div><div class="crt-screw s2"></div><div class="crt-screw s3"></div><div class="crt-screw s4"></div>
      <div class="crt-led"></div>
      <div class="crt-screen">
        <div class="tile-glow"></div>
        <div class="tile-icon">${t.icon.startsWith('http')||t.icon.startsWith('data:')?`<img src="${t.icon}" style="width:48px;height:48px;object-fit:contain">`:t.icon}</div>
        <div class="tile-label" style="${fontStyle(t.labelFont)}">${t.label}</div>
        <div class="tile-sub" style="${fontStyle(t.subFont)}">${t.sub}</div>
        <div class="tile-badge${badgeCls}">SAMPLE DATA</div>
        <div class="tile-status"><div class="tile-dot active"></div><span class="tile-status-label active">ACTIVE</span></div>
      </div>
    </div>`;
  }).join('');
}

function applyThemeToPreviewGrid(id){
  const pg=document.getElementById('themePreviewGrid');
  _gridThemes.forEach(t=>pg.classList.remove('grid-theme-'+t.id));
  if(id&&id!=='crt')pg.classList.add('grid-theme-'+id);
}

function selectGridTheme(id){
  _currentGridTheme=id;
  applyGridTheme(id);
  updateThemeLabel();
  const blip=document.getElementById('blipGridTheme');
  if(blip){blip.style.opacity='1';setTimeout(()=>blip.style.opacity='',1500)}
  saveEventConfigToBackend();
}

function applyGridTheme(id){
  const grid=document.getElementById('consoleGrid');
  if(!grid)return;
  // Remove all existing theme classes
  _gridThemes.forEach(t=>grid.classList.remove('grid-theme-'+t.id));
  // Apply new one (crt = default, no class needed)
  if(id&&id!=='crt'){
    grid.classList.add('grid-theme-'+id);
  }
}

// ══════ INTEL DISPLAY THEME ══════
let _currentIntelTheme='standard';
function setIntelTheme(id){
  _currentIntelTheme=id;
  applyIntelTheme(id);
  // Save to backend
  apiCall('saveEventConfig',{config:{intelTheme:id}});
  // Flash save blip
  const blip=document.getElementById('blipIntelTheme');
  if(blip){blip.classList.add('show');setTimeout(()=>blip.classList.remove('show'),1500)}
}
function applyIntelTheme(id){
  _currentIntelTheme=id||'standard';
  const panel=document.getElementById('expIntel');
  if(!panel)return;
  panel.classList.remove('intel-theme-minimal','intel-theme-holo','intel-theme-dossier');
  if(id&&id!=='standard')panel.classList.add('intel-theme-'+id);
  try{localStorage.setItem('cb_intelTheme',_currentIntelTheme)}catch(e){}
  // Update appearance panel UI
  const names={standard:'Standard',minimal:'Sleek Minimal',holo:'Holo HUD Green',dossier:'Green Dossier'};
  const lbl=document.getElementById('currentIntelThemeLabel');
  if(lbl)lbl.textContent='Current: '+(names[_currentIntelTheme]||'Standard');
}

// ══════ INTEL THEME PREVIEW ══════
const _intelThemes=[{id:'standard',name:'Standard'},{id:'minimal',name:'Sleek Minimal'},{id:'holo',name:'Holo HUD Green'},{id:'dossier',name:'Green Dossier'}];
let _intelPreviewIdx=0;
let _intelPreviewOriginal='standard';

function openIntelThemePreview(){
  _intelPreviewOriginal=_currentIntelTheme;
  _intelPreviewIdx=_intelThemes.findIndex(t=>t.id===_currentIntelTheme);
  if(_intelPreviewIdx<0)_intelPreviewIdx=0;
  closeAppearancePanel();
  document.getElementById('intelThemePreviewOverlay').style.display='flex';
  renderIntelThemePreview();
  updateIntelThemePreviewUI();
}

function closeIntelThemePreview(){
  document.getElementById('intelThemePreviewOverlay').style.display='none';
  applyIntelTheme(_intelPreviewOriginal);
  setTimeout(()=>openAppearancePanel(),120);
}

function cycleIntelThemePreview(dir){
  _intelPreviewIdx=(_intelPreviewIdx+dir+_intelThemes.length)%_intelThemes.length;
  renderIntelThemePreview();
  updateIntelThemePreviewUI();
}

function applyIntelThemeFromPreview(){
  setIntelTheme(_intelThemes[_intelPreviewIdx].id);
  document.getElementById('intelThemePreviewOverlay').style.display='none';
  setTimeout(()=>openAppearancePanel(),120);
}

function updateIntelThemePreviewUI(){
  document.getElementById('intelThemePreviewName').textContent=_intelThemes[_intelPreviewIdx].name;
  document.getElementById('intelThemePreviewCounter').textContent=(_intelPreviewIdx+1)+' / '+_intelThemes.length;
}

function renderIntelThemePreview(){
  const themeId=_intelThemes[_intelPreviewIdx].id;
  const container=document.getElementById('intelThemePreviewContent');
  const themeClass=themeId!=='standard'?' intel-theme-'+themeId:'';
  var rows='';
  var fields=intelFields.length?intelFields:[{label:'Sample Field',emoji:'🔍',type:'text'}];
  fields.forEach(function(f,i){
    var num=String(i+1).padStart(2,'0');
    var ph=f.placeholder||'···';
    var inputHtml='';
    if(f.type==='money'){
      inputHtml='<div class="intel-prefix-wrap"><span class="intel-prefix">$</span><input class="intel-exp-input" style="border:none;background:transparent;box-shadow:none" placeholder="'+ph+'"></div>';
    }else if(f.type==='phone'){
      inputHtml='<input class="intel-exp-input" placeholder="'+(f.placeholder||'(XXX) XXX-XXXX')+'">';
    }else if(f.type==='select'){
      var opts=(f.options||[]).map(function(o){return '<option>'+o+'</option>'}).join('');
      inputHtml='<select class="intel-exp-input intel-select"><option>— Select —</option>'+opts+'</select>';
    }else if(f.type==='dual'){
      inputHtml='<div class="intel-dual-wrap"><input class="intel-exp-input" placeholder="'+(f.placeholder1||'Value 1')+'"><span class="intel-dual-sep">&amp;</span><input class="intel-exp-input" placeholder="'+(f.placeholder2||'Value 2')+'"></div>';
    }else{
      inputHtml='<input class="intel-exp-input" placeholder="'+ph+'">';
    }
    rows+='<div class="intel-exp-row" style="max-width:600px;width:100%"><span class="intel-exp-num">'+num+'</span><span class="intel-exp-label">'+f.label+' '+(f.emoji||'')+'</span>'+inputHtml+'</div>';
  });
  container.innerHTML='<div class="expanded-panel'+themeClass+'" style="position:relative;display:flex;flex-direction:column;opacity:1;pointer-events:auto;border-radius:12px;overflow:visible;border:1px solid rgba(255,255,255,.06);background:var(--bg-panel);max-width:560px;margin:0 auto;max-height:70vh"><div class="exp-header" style="pointer-events:none;display:flex;align-items:center;gap:10px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0"><span class="panel-icon" style="font-size:18px">🎯</span><span class="exp-title" style="font-family:Saira,sans-serif;font-size:13px;letter-spacing:2px;color:#fff;font-weight:700">Intel Submissions</span></div><div class="exp-body intel-exp-body" style="display:flex;flex-direction:column;overflow:visible;flex:1;padding:0"><div class="intel-scroll-area" style="flex:1;overflow-y:auto;padding:20px 20px 0;display:flex;flex-direction:column;gap:8px;align-items:center"><div style="display:flex;flex-direction:column;align-items:center;gap:8px;width:100%">'+rows+'</div></div><div class="intel-transmit-dock" style="flex-shrink:0;padding:14px 20px;display:flex;justify-content:center;align-items:center"><button class="intel-submit-btn" disabled style="pointer-events:none">SUBMIT INTEL</button></div></div></div>';
}

// ═══════════════════════════════════════════════════════════════
// TYPOGRAPHY — Central font management
// ═══════════════════════════════════════════════════════════════

function initTypographyPanel(){
  const zones=[
    {key:'feedCap',   id:'fc_feedCap_wrap'},
    {key:'mediaName', id:'fc_mediaName_wrap'},
    {key:'mediaDesc', id:'fc_mediaDesc_wrap'},
    {key:'intelLabel',id:'fc_intelLabel_wrap'},
    {key:'intelInput',id:'fc_intelInput_wrap'},
    {key:'vaultDisplay',id:'fc_vaultDisplay_wrap'}
  ];
  zones.forEach(({key,id})=>{
    const wrap=document.getElementById(id);
    if(!wrap){return;}
    // Build styled select inline
    const groups=[
      {label:'Default',fonts:[]},
      {label:'Military / Industrial',fonts:['Russo One','Black Ops One','Quantico','Aldrich','Staatliches']},
      {label:'Sci-Fi / Tech',fonts:['Orbitron','Oxanium','Audiowide','Electrolize','Michroma','Chakra Petch']},
      {label:'Clean / UI',fonts:['Saira','Exo 2','Play','Rajdhani','Teko']},
      {label:'Monospace / Terminal',fonts:['IBM Plex Mono','JetBrains Mono','Share Tech Mono','Nova Mono','Major Mono Display']},
      {label:'Retro / Pixel',fonts:['Press Start 2P','VT323','Silkscreen']},
    ];
    let selHtml=`<select id="${id}_sel" style="width:100%;background:#080a10;border:1px solid var(--border);border-radius:3px;padding:6px 10px;color:#ddd;font-family:'IBM Plex Mono',monospace;font-size:10px;outline:none">`;
    selHtml+=`<option value=""${!fontConfig[key]?' selected':''}>— Default —</option>`;
    groups.slice(1).forEach(g=>{
      selHtml+=`<optgroup label="${g.label}">`;
      g.fonts.forEach(fn=>{
        const f=availableFonts.find(x=>x.name===fn);
        if(f)selHtml+=`<option value="${f.name}"${f.name===fontConfig[key]?' selected':''}>${f.name}</option>`;
      });
      selHtml+=`</optgroup>`;
    });
    selHtml+=`</select>`;
    wrap.innerHTML=selHtml;
    const sel=wrap.querySelector('select');
    // Add live font preview below the dropdown
    const preview=document.createElement('div');
    preview.id=id+'_preview';
    preview.style.cssText='margin-top:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.04);border-radius:3px;background:rgba(255,255,255,.015);font-size:13px;color:#aaa;letter-spacing:.5px;min-height:20px;transition:font-family .15s';
    preview.textContent='The quick brown fox jumps over the lazy dog';
    wrap.appendChild(preview);
    function updatePreview(){
      const fontName=sel.value;
      if(fontName){
        preview.style.fontFamily="'"+fontName+"',sans-serif";
        preview.style.color='#ccc';
      }else{
        preview.style.fontFamily='inherit';
        preview.style.color='#666';
      }
    }
    updatePreview();
    if(sel){
      sel.onchange=function(){
        fontConfig[key]=this.value;
        updatePreview();
        applyFontConfig();
        saveEventConfigToBackend();
        blip('blipTypography');
      };
    }
  });
}

function applyFontConfig(){
  // Vault keypad display
  const vDisp=document.getElementById('vDisp');
  if(vDisp){const fam=getFontFamily(fontConfig.vaultDisplay||'');vDisp.style.fontFamily=fam||'';}
  // Set CSS custom properties — panels pick these up on next natural render
  document.documentElement.style.setProperty('--fc-vault',getFontFamily(fontConfig.vaultDisplay||'')||'inherit');
  document.documentElement.style.setProperty('--fc-feed-cap',getFontFamily(fontConfig.feedCap||'')||'inherit');
  document.documentElement.style.setProperty('--fc-media-name',getFontFamily(fontConfig.mediaName||'')||'inherit');
  document.documentElement.style.setProperty('--fc-media-desc',getFontFamily(fontConfig.mediaDesc||'')||'inherit');
}

function resetFontConfig(){
  Object.keys(fontConfig).forEach(k=>fontConfig[k]='');
  initTypographyPanel();
  applyFontConfig();
  saveEventConfigToBackend();
  blip('blipTypography');
}

function blip(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.opacity='1';
  setTimeout(()=>el.style.opacity='',2000);
}

// ═══════════════════════════════════════════════════════════════
// VAULT LOCK PICKER — add existing media file to vault from KC panel
// ═══════════════════════════════════════════════════════════════

function openVaultLockPicker(){
  // Get unlocked media items (not already vault-locked, must have a file/name)
  const available=mediaItems.map((m,i)=>({m,i})).filter(({m})=>!m.vaultLocked&&m.name);
  let gridHtml='';
  if(available.length){
    gridHtml=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:240px;overflow-y:auto;margin-bottom:16px">`;
    available.forEach(({m,i})=>{
      const typeLabel={image:'IMG',audio:'AUD',video:'VID',document:'DOC',dossier:'DOS'}[m.type]||m.type.toUpperCase().slice(0,3);
      gridHtml+=`<div class="vlp-item" onclick="selectVlpItem(this,${i})" data-idx="${i}" style="border:1px solid var(--border);border-radius:4px;padding:10px 8px;cursor:pointer;text-align:center;transition:all .15s;background:rgba(255,255,255,.01)">
        <div style="font-size:22px;margin-bottom:4px">${m.icon}</div>
        <div style="font-family:'Chakra Petch',sans-serif;font-size:9px;color:#ddd;letter-spacing:.5px;margin-bottom:3px;overflow:visible;text-overflow:ellipsis;white-space:nowrap">${m.name}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:7px;color:#555;letter-spacing:1px">${typeLabel}</div>
      </div>`;
    });
    gridHtml+=`</div>`;
  }else{
    gridHtml=`<div style="font-family:'Chakra Petch',sans-serif;font-size:10px;color:#555;padding:20px 0;text-align:center">All items are already vault-locked, or no items exist in the Evidence Locker yet.</div>`;
  }

  showEditModal(`<h3>🔐 Vault Lock an Existing File</h3>
    <p style="font-family:'Chakra Petch',sans-serif;font-size:10px;color:#888;margin-bottom:14px;line-height:1.6">Select an Evidence Locker item to vault-lock. Players will see it as classified until they crack the code.</p>
    <div style="font-family:'Saira',sans-serif;font-size:9px;letter-spacing:2px;color:var(--amber);text-transform:uppercase;margin-bottom:8px;font-weight:700">Select File</div>
    ${gridHtml}
    <div id="vlpCodeFields" style="display:none">
      <div style="border-top:1px solid var(--border);padding-top:14px;margin-top:4px">
        <div style="font-family:'Saira',sans-serif;font-size:9px;letter-spacing:2px;color:var(--amber);text-transform:uppercase;margin-bottom:10px;font-weight:700">Set Vault Code</div>
        <div class="edit-field-row" style="gap:10px">
          <div class="edit-field"><label>Vault Code</label><input id="vlpCode" placeholder="e.g. DEADROP7" style="text-transform:uppercase;letter-spacing:2px;font-family:'IBM Plex Mono',monospace" oninput="this.value=this.value.toUpperCase()"></div>
          <div class="edit-field"><label>Codename (shown to players)</label><input id="vlpCodename" placeholder="e.g. OPERATION BLACKOUT" style="text-transform:uppercase;letter-spacing:1px;font-family:'IBM Plex Mono',monospace" oninput="this.value=this.value.toUpperCase()"></div>
        </div>
        <div style="font-family:'Chakra Petch',sans-serif;font-size:9px;color:#555;margin-top:6px">Players see the codename but not the file — it appears as a locked entry in the Vault panel.</div>
      </div>
    </div>
    <input type="hidden" id="vlpSelectedIdx" value="">
    <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end">
      <button class="btn-standard btn-ghost" onclick="hideEditModal()">Cancel</button>
      <button class="btn-standard btn-amber" onclick="confirmVaultLock()">🔐 Lock to Vault</button>
    </div>`);

  // Add hover styles dynamically
  document.querySelectorAll('.vlp-item').forEach(el=>{
    el.addEventListener('mouseenter',()=>{if(!el.classList.contains('selected'))el.style.borderColor='rgba(255,170,51,.3)'});
    el.addEventListener('mouseleave',()=>{if(!el.classList.contains('selected'))el.style.borderColor='var(--border)'});
  });
}

function selectVlpItem(el,idx){
  document.querySelectorAll('.vlp-item').forEach(x=>{
    x.classList.remove('selected');
    x.style.borderColor='var(--border)';
    x.style.background='rgba(255,255,255,.01)';
  });
  el.classList.add('selected');
  el.style.borderColor='rgba(255,170,51,.5)';
  el.style.background='rgba(255,170,51,.05)';
  document.getElementById('vlpSelectedIdx').value=idx;
  document.getElementById('vlpCodeFields').style.display='block';
  // Pre-fill codename from file name
  const codenameInp=document.getElementById('vlpCodename');
  if(codenameInp&&!codenameInp.value&&mediaItems[idx]){
    codenameInp.value=mediaItems[idx].name.toUpperCase().replace(/[^A-Z0-9 ]/g,'');
  }
  document.getElementById('vlpCode').focus();
}

function confirmVaultLock(){
  const idxStr=document.getElementById('vlpSelectedIdx').value;
  if(idxStr===''){alert('Please select a file first.');return;}
  const idx=parseInt(idxStr);
  const code=(document.getElementById('vlpCode').value||'').trim().toUpperCase();
  const codename=(document.getElementById('vlpCodename').value||'').trim().toUpperCase();
  if(!code){alert('Please set a vault code.');document.getElementById('vlpCode').focus();return;}
  if(!mediaItems[idx]){alert('File not found.');return;}
  // Check for duplicate code
  const duplicate=mediaItems.some((m,i)=>i!==idx&&m.vaultLocked&&m.vaultCode===code);
  if(duplicate){alert('That code is already in use by another vault item. Please choose a different code.');return;}
  mediaItems[idx].vaultLocked=true;
  mediaItems[idx].vaultCode=code;
  mediaItems[idx].vaultCodename=codename||code;
  hideEditModal();
  syncVaultCodesFromMedia();
  renderMedia();renderGrid();renderVaultPanel();renderKeysCodes();
  saveMediaItemsToBackend();
}



// ══════ PAGE-BASED ADMIN NAVIGATION ══════
let _gearReturnScreen='consoleScreen';
let _gearReturnPanel=null;
let _currentAdminPage=null; // 'settingsScreen' when on admin page, null otherwise

function handleGearClick(){
  const dd=document.getElementById('gearDropdown');
  if(dd.classList.contains('open')){
    closeGearDropdown();
    // If on an admin page, return to where we came from
    if(_currentAdminPage){returnFromAdminPage()}
  }else{
    // If already on an admin page, just show dropdown to switch
    if(_currentAdminPage){
      openGearDropdown();
    }else{
      openGearDropdown();
    }
  }
}

function openGearDropdown(){
  document.getElementById('gearDropdown').classList.add('open');
}
function closeGearDropdown(){
  document.getElementById('gearDropdown').classList.remove('open');
}

// Close gear dropdown when clicking outside
document.addEventListener('click',function(e){
  const dd=document.getElementById('gearDropdown');
  const gear=document.getElementById('adminGearIcon');
  if(dd&&dd.classList.contains('open')&&!dd.contains(e.target)&&gear&&!gear.contains(e.target)){closeGearDropdown()}
});

function navigateToAdmin(screenId,tabId){
  // Remember where we came from (only if coming from non-admin screen)
  if(!_currentAdminPage){
    _gearReturnScreen=_currentScreen;
    // Remember open panel
    const openPanelEl=document.querySelector('.expanded-panel.visible');
    _gearReturnPanel=openPanelEl?openPanelEl.id:null;
  }
  _currentAdminPage='settingsScreen';
  // Move panels into page sections if not already done
  mountAdminPanels();
  showScreen('settingsScreen');
  initSettingsPage();
  // If a specific tab was requested, switch to it
  if(tabId){
    _switchToTab('settingsScreen',tabId);
  }
  // Refresh data then re-render the active tab with fresh data
  loadEventData().then(function(){
    var as=document.querySelector('#settingsScreen .admin-page-section.active');
    if(as)_switchToTab('settingsScreen',as.id);
  });
  updateGearIcon();
  updatePreviewIcon();
}

// Helper: switch to a tab and auto-find its button
function _switchToTab(screenId,tabId){
  var tabBtn=null;
  var screen=document.getElementById(screenId);
  if(screen){
    screen.querySelectorAll('.admin-page-tab').forEach(function(t){
      var onc=t.getAttribute('onclick')||'';
      if(onc.indexOf("'"+tabId+"'")>-1){tabBtn=t}
    });
  }
  switchPageTab(screenId,tabId,tabBtn);
}

function returnFromAdminPage(){
  // Unmount panels back to body so overlays still work for backward compat
  _currentAdminPage=null;
  showScreen(_gearReturnScreen);
  // Restore open panel if any
  if(_gearReturnPanel){
    const panelMap={expFeed:'feed',expMedia:'media',expIntel:'intel',expVault:'vault'};
    const tileId=panelMap[_gearReturnPanel];
    if(tileId)setTimeout(function(){openPanel(tileId)},100);
    _gearReturnPanel=null;
  }
  updateGearIcon();
  updatePreviewIcon();
}

function updateGearIcon(){
  const gear=document.getElementById('adminGearIcon');
  if(gear)gear.classList.toggle('active',!!_currentAdminPage);
}

function updatePreviewIcon(){
  const icon=document.getElementById('adminPreviewIcon');
  if(!icon)return;
  // Hide preview icon on admin settings page
  if(_currentAdminPage){
    icon.style.display='none';
  }else{
    icon.style.display='';
    icon.classList.toggle('active',document.body.classList.contains('player-preview'));
  }
}

let _panelsMounted=false;
function mountAdminPanels(){
  if(_panelsMounted)return;
  _panelsMounted=true;
  // Settings sections
  var setEvent=document.getElementById('set-event');
  var setIntel=document.getElementById('set-intel');
  var setAppearance=document.getElementById('set-appearance');
  var setUsers=document.getElementById('set-users');
  // Event tab: config + registration + tutorial
  if(setEvent){
    setEvent.appendChild(document.getElementById('adminPanel'));
    setEvent.appendChild(document.getElementById('registrationPanel'));
    setEvent.appendChild(document.getElementById('tutorialConfigPanel'));
  }
  // Intel & Scoring tab: keys/codes + scoring
  if(setIntel){
    setIntel.appendChild(document.getElementById('keysCodesPanel'));
    setIntel.appendChild(document.getElementById('scoringPanel'));
  }
  // Appearance tab
  if(setAppearance)setAppearance.appendChild(document.getElementById('appearancePanel'));
  // Users tab
  if(setUsers)setUsers.appendChild(document.getElementById('portalUsersPanel'));
  // Dashboard sections (now inside settings)
  var dashTeams=document.getElementById('dash-teams');
  var dashLb=document.getElementById('dash-leaderboard');
  var dashSessions=document.getElementById('dash-sessions');
  var dashBroadcast=document.getElementById('dash-broadcast');
  if(dashTeams)dashTeams.appendChild(document.getElementById('dashboardPanel'));
  if(dashLb)dashLb.appendChild(document.getElementById('leaderboardModule'));
  if(dashSessions)dashSessions.appendChild(document.getElementById('sessionMgmtPanel'));
  if(dashBroadcast)dashBroadcast.appendChild(document.getElementById('broadcastPanel'));
}

function initSettingsPage(){
  var allPanels=['adminPanel','scoringPanel','registrationPanel','tutorialConfigPanel','keysCodesPanel','appearancePanel','portalUsersPanel','dashboardPanel','leaderboardModule','sessionMgmtPanel','broadcastPanel'];
  allPanels.forEach(function(id){
    var el=document.getElementById(id);
    if(el){el.style.cssText='';el.classList.add('active')}
  });
  // Init the active tab's content (after config hydration to avoid value flicker)
  if(!window.__configHydrated){
    document.documentElement.classList.add('is-hydrating-settings');
    // Run once config lands
    document.addEventListener('cb:configHydrated', function _once(){
      // Re-run init now that config is in place
      try{initSettingsPage()}catch(e){}
    }, {once:true});
    return;
  }
  var activeSection=document.querySelector('#settingsScreen .admin-page-section.active');
  if(activeSection){
    var sid=activeSection.id;
    if(sid==='set-event'){syncAdminPanelSettings();syncRegistrationSettings();renderTutorialStepList();var tg=document.getElementById('tutGlobalToggle');if(tg)tg.classList.toggle('on',tutorialEnabled)}
    if(sid==='set-intel'){renderKeysCodes();renderScoringEditor()}
    if(sid==='set-appearance'){updateThemeLabel();initTypographyPanel()}
    if(sid==='set-users'){renderPortalUsersList();refreshAdminList()}
    if(sid==='dash-teams'){renderTeamMonitor();startTeamMonitor()}
    if(sid==='dash-leaderboard'){renderFullLeaderboard()}
  }
}

function switchPageTab(screenId,sectionId,btn){
  // Switch active tab button
  const screen=document.getElementById(screenId);
  if(!screen)return;
  screen.querySelectorAll('.admin-page-tab').forEach(function(t){t.classList.remove('active')});
  if(btn)btn.classList.add('active');
  // Switch active section
  screen.querySelectorAll('.admin-page-section').forEach(function(s){s.classList.remove('active')});
  var section=document.getElementById(sectionId);
  if(section)section.classList.add('active');
  // Init content for the activated section (after config hydration to avoid value flicker)
  if(!window.__configHydrated){
    document.documentElement.classList.add('is-hydrating-settings');
    // Remember desired tab and hydrate later
    window.__pendingSettingsTab=sectionId;
    document.addEventListener('cb:configHydrated', function _once(){
      try{
        var target=window.__pendingSettingsTab||'set-event';
        window.__pendingSettingsTab=null;
        // Re-run tab activation now that config is ready
        switchPageTab(screenId,target,screen.querySelector('.admin-page-tab.active'));
      }catch(e){}
    }, {once:true});
    saveSession();
    return;
  }
  if(sectionId==='set-event'){syncAdminPanelSettings();syncRegistrationSettings();renderTutorialStepList();var tg=document.getElementById('tutGlobalToggle');if(tg)tg.classList.toggle('on',tutorialEnabled)}
  if(sectionId==='set-intel'){renderKeysCodes();renderScoringEditor()}
  if(sectionId==='set-appearance'){updateThemeLabel();initTypographyPanel()}
  if(sectionId==='set-users'){renderPortalUsersList();refreshAdminList()}
  if(sectionId==='dash-teams'){renderTeamMonitor();startTeamMonitor()}
  if(sectionId==='dash-leaderboard'){renderFullLeaderboard()}
  if(sectionId==='dash-sessions'){renderSessionMgmt&&renderSessionMgmt()}
  if(sectionId==='dash-broadcast'){initBroadcastPanel&&initBroadcastPanel()}
  // Persist current tab state
  saveSession();
}

// Override togglePlayerPreview to update icon
var _origTogglePlayerPreview=togglePlayerPreview;
togglePlayerPreview=function(){
  _origTogglePlayerPreview();
  updatePreviewIcon();
};

// ═══════════════════════════════════════════════════════════════
// DEFERRED RESTORE — runs AFTER all let/const declarations
// to avoid Temporal Dead Zone errors from restoreSession()
// ═══════════════════════════════════════════════════════════════
(function(){
  // Apply deferred grid theme variable (declared above as let)
  if(window._deferredGridTheme){
    _currentGridTheme=window._deferredGridTheme;
    delete window._deferredGridTheme;
  }
  // Execute deferred admin navigation (after DOM is ready)
  function _runDeferredAdminRestore(){
    if(!window._deferredAdminRestore) return;
    var page=window._deferredAdminRestore.page||'settingsScreen';
    var tab=window._deferredAdminRestore.tab||null;

    _gearReturnScreen='consoleScreen';

    // Ensure the target screen exists before navigating.
    // IMPORTANT: do NOT delete the deferred object until we successfully navigate,
    // otherwise the DOMContentLoaded retry will have nothing to restore.
    var el=document.getElementById(page);
    if(!el){
      document.addEventListener('DOMContentLoaded',function(){_runDeferredAdminRestore();},{once:true});
      return;
    }

    delete window._deferredAdminRestore;
    navigateToAdmin(page,tab);
  }
  _runDeferredAdminRestore()
})();

</script>


<!-- DASHBOARD SCREEN (full page) -->
<!-- SETTINGS SCREEN (full page — unified admin) -->
<div class="screen" id="settingsScreen">
  <div class="admin-page">
    <div class="admin-page-header">
      <div class="admin-page-header-row">
        <span class="admin-page-title">Admin Console</span>
        <button class="admin-page-close" onclick="returnFromAdminPage()" title="Return to console">✕ CLOSE</button>
      </div>
      <div class="admin-page-tabs">
        <button class="admin-page-tab active" onclick="switchPageTab('settingsScreen','set-event',this)">⚙️ Event</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','set-intel',this)">🎯 Intel & Scoring</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','set-appearance',this)">🎨 Appearance</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','set-users',this)">👥 Users</button>
        <span class="admin-page-tab-sep"></span>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','dash-teams',this)">📡 Teams</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','dash-leaderboard',this)">🏆 Leaderboard</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','dash-sessions',this)">🛡️ Sessions</button>
        <button class="admin-page-tab" onclick="switchPageTab('settingsScreen','dash-broadcast',this)">📢 Broadcast</button>
      </div>
    </div>
    <div class="admin-page-body">
      <div class="admin-page-section active" id="set-event"></div>
      <div class="admin-page-section" id="set-intel"></div>
      <div class="admin-page-section" id="set-appearance"></div>
      <div class="admin-page-section" id="set-users"></div>
      <div class="admin-page-section" id="dash-teams"></div>
      <div class="admin-page-section" id="dash-leaderboard"></div>
      <div class="admin-page-section" id="dash-sessions"></div>
      <div class="admin-page-section" id="dash-broadcast"></div>
    </div>
  </div>
</div>

<div id="adminNavBar">
  <div class="anb-btn" id="anb-dashboardPanel" onclick="switchAdminTab('dashboardPanel')" title="Dashboard">
    <span class="anb-icon">📊</span><span class="anb-label">Live</span>
  </div>
  <div class="anb-sep"></div>
  <div class="anb-btn" id="anb-adminPanel" onclick="openSetup()" title="Setup">
    <span class="anb-icon">⚙️</span><span class="anb-label">Setup</span>
  </div>
</div>

<div id="landingPreviewOverlay">
  <div class="lp-preview-bar">
    <span class="lp-preview-label">👁 Player View Preview</span>
    <button class="lp-preview-nav" onclick="previewNav('landingScreen',this)">Landing</button>
    <button class="lp-preview-nav" onclick="previewNav('regScreen',this)">Register</button>
    <button class="lp-preview-nav" onclick="previewNav('loginScreen',this)">Login</button>
    <button class="lp-preview-close" onclick="closeLandingPreview()">✕ Close</button>
  </div>
</div>

<!-- THEME PREVIEW OVERLAY -->
<div id="themePreviewOverlay" style="position:fixed;inset:0;z-index:9600;background:rgba(0,0,0,.96);display:none;flex-direction:column">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(0,0,0,.8);border-bottom:1px solid rgba(0,255,136,.1);flex-shrink:0">
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-family:'Saira',sans-serif;font-size:11px;letter-spacing:3px;color:var(--green);font-weight:700">CONSOLE THEME PREVIEW</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:#666" id="themePreviewName">CRT Monitor</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button onclick="cycleThemePreview(-1)" style="padding:6px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(0,212,255,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">◀ Prev</button>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:#555;min-width:40px;text-align:center" id="themePreviewCounter">1 / 10</span>
      <button onclick="cycleThemePreview(1)" style="padding:6px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(0,212,255,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">Next ▶</button>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button onclick="applyThemeFromPreview()" style="padding:7px 18px;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.25);border-radius:4px;color:var(--green);font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;font-weight:700;cursor:pointer;transition:all .15s" onmouseenter="this.style.background='rgba(0,255,136,.15)'" onmouseleave="this.style.background='rgba(0,255,136,.08)'">✓ SELECT</button>
      <button onclick="closeThemePreview()" style="padding:7px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#999;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(255,50,50,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">✕ CANCEL</button>
    </div>
  </div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;overflow:visible;padding:20px">
    <div style="width:100%;max-width:800px">
      <div class="console-grid" id="themePreviewGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:clamp(14px,2.5vh,28px);padding:clamp(14px,2.5vh,28px);align-content:center"></div>
    </div>
  </div>
  <div style="padding:8px 20px;text-align:center;flex-shrink:0;border-top:1px solid rgba(255,255,255,.04)">
    <span style="font-family:'Chakra Petch',sans-serif;font-size:9px;color:#444;letter-spacing:1px">Use ◀ ▶ to cycle through themes · Press SELECT to apply · ESC to cancel</span>
  </div>
</div>

<!-- Intel Theme Preview Overlay -->
<div id="intelThemePreviewOverlay" style="position:fixed;inset:0;z-index:9600;background:rgba(0,0,0,.96);display:none;flex-direction:column">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(0,0,0,.8);border-bottom:1px solid rgba(0,255,136,.1);flex-shrink:0;flex-wrap:wrap;gap:8px">
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-family:'Saira',sans-serif;font-size:11px;letter-spacing:3px;color:var(--green);font-weight:700">INTEL THEME PREVIEW</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:#666" id="intelThemePreviewName">Standard</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button onclick="cycleIntelThemePreview(-1)" style="padding:6px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(0,212,255,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">◀ Prev</button>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:#555;min-width:40px;text-align:center" id="intelThemePreviewCounter">1 / 4</span>
      <button onclick="cycleIntelThemePreview(1)" style="padding:6px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#ccc;font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(0,212,255,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">Next ▶</button>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button onclick="applyIntelThemeFromPreview()" style="padding:7px 18px;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.25);border-radius:4px;color:var(--green);font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;font-weight:700;cursor:pointer;transition:all .15s" onmouseenter="this.style.background='rgba(0,255,136,.15)'" onmouseleave="this.style.background='rgba(0,255,136,.08)'">✓ SELECT</button>
      <button onclick="closeIntelThemePreview()" style="padding:7px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:#999;font-family:'Saira',sans-serif;font-size:10px;letter-spacing:2px;cursor:pointer;transition:all .15s" onmouseenter="this.style.borderColor='rgba(255,50,50,.3)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)'">✕ CANCEL</button>
    </div>
  </div>
  <div style="flex:1;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:20px">
    <div id="intelThemePreviewContent" style="width:100%;max-width:700px"></div>
  </div>
  <div style="padding:8px 20px;text-align:center;flex-shrink:0;border-top:1px solid rgba(255,255,255,.04)">
    <span style="font-family:'Chakra Petch',sans-serif;font-size:9px;color:#444;letter-spacing:1px">Use ◀ ▶ to browse styles · Press SELECT to apply · ESC to cancel</span>
  </div>
</div>

</body>
</html>
